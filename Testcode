<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.54-Beta</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
/* --- Core Layout & Scrollbar --- */
        body { font-family: 'Inter', sans-serif; padding-bottom: 50px; background-color: #f3f4f6; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* --- 1. Interaction Protocols (Drag and drop behavior) --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

/* --- 2. Atomic UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }

/* --- 3. Roadmap Visualization --- */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

/* --- 4. Intelligence Suite Visuals --- */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

/* --- 5. Support Interface --- */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

/* --- 6. Print Media Protocols --- */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        #bmac-btn-container, #bmc-wbtn { display: none !important; }

/* --- 7. Production Stage Visuals --- */
        #stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
        #stagesCarousel::-webkit-scrollbar { display: none; }
        .stage-card { transition: transform 0.2s; }
        .stage-drop-zone { min-height: 100px; }
        .stage-draggable { transition: all 0.2s; touch-action: none; }
        .stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

/* --- 8. Mobile Platform Support --- */
        @media (max-width: 768px) {
            .mobile-desc-truncate { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 100%; display: block; }
            .mobile-desc-truncate:focus { white-space: normal; overflow: visible; position: relative; z-index: 50; background: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; padding: 8px; height: auto; }
        }

/* --- 9. Navigation Elements --- */
        .sticky-section-header { position: sticky; top: 0; z-index: 30; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .sticky-th { position: sticky; top: 43px; z-index: 20; background-color: #ffffff; }

/* --- 10. Document Studio Canvas --- */
        .grid-stack { background-color: #f3f4f6; min-height: 80vh; padding: 10px !important; }
        .grid-stack-item-content { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; overflow: hidden !important; display: flex; flex-direction: column; cursor: grab; }
   
/* --- 11. Form Utilities (Spinner Removal) --- */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinner { -moz-appearance: textfield; appearance: none; }

/* --- 12. Crew Contact Popups (Adapted Legacy Logic) --- */
        .crew-wrapper { 
            position: relative; 
            z-index: 20; 
            display: inline-block;
        }
        
        /* Main Avatar Button */
        .crew-avatar {
            /* Adapted size: 28px -> 32px for better touch, shrinks to 28px on tiny screens via HTML classes */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* Legacy "Pop" effect */
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20; /* Always above the pill */
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar:active { transform: scale(0.95); }

        /* The Floating Pill (Hidden State) */
        .crew-popup {
            position: absolute;
            left: 50%; /* Start centered behind avatar */
            top: 50%;
            transform: translate(-50%, -50%) scale(0.5); /* Start small and centered */
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 6px 4px 28px; /* Left padding creates the visual gap for the avatar */
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 10; /* Behind avatar */
            white-space: nowrap;
        }

        /* The "Hit Buffer" (Invisible bridge so mouse doesn't lose focus) */
        .crew-popup::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px; /* Covers the gap between avatar and buttons */
            background: transparent;
            z-index: -1;
        }

        /* Active State (Hover OR Mobile Class) */
        @media (hover: hover) {
            .crew-wrapper:hover .crew-popup {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transform: translate(20px, -50%) scale(1); /* Slide out to the right */
            }
        }
        
        /* Mobile Toggle State */
        .crew-wrapper.mobile-active .crew-popup {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate(20px, -50%) scale(1);
        }

        /* Action Buttons inside the Pill */
        .contact-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease;
            flex-shrink: 0;
            text-decoration: none;
        }
        .contact-action-btn:hover { transform: scale(1.2); }
        .contact-action-btn svg { width: 14px; height: 14px; }

        /* Legacy Colors adapted for Tailwind Palette */
        .action-call { background-color: #10b981; } /* Emerald-500 */
        .action-wa { background-color: #25D366; }   /* WhatsApp Brand Color */
        .action-email { background-color: #3b82f6; } /* Blue-500 */
        .action-profile { background-color: #64748b; } /* Slate-500 */

</style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
	<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
	<script data-name="BMC-Widget" ... src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" ...></script>
</head>

<body class="bg-gray-100 pb-24">
    <div id="app" class="max-w-7xl mx-auto px-4 py-8"></div>
    <div id="global-modal-container"></div>

    <footer class="fixed bottom-0 left-0 right-0 z-[100] p-4 pointer-events-none">
        <div class="max-w-xl mx-auto bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-[32px] shadow-2xl p-2 px-6 flex justify-between items-center pointer-events-auto">
            
            <button id="stagesFooterBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-emerald-400" id="icon-stages"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-emerald-400">Stages</span>
            </button>

            <button id="docsFooterBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-blue-400" id="icon-docs"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-blue-400">Documents</span>
            </button>

            <button id="mainActionBtn" class="w-14 h-14 bg-blue-600 rounded-[22px] shadow-xl shadow-blue-500/20 flex items-center justify-center text-white border-2 border-white/20 transition-all hover:bg-blue-500 active:scale-90">
                <div id="icon-main-action"></div>
            </button>

            <button id="secondaryActionBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-indigo-400" id="icon-secondary-action"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-indigo-400">Publish</span>
            </button>

            <button id="footerCoffeeBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-amber-400" id="icon-coffee"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-amber-400">Support</span>
            </button>
        </div>
    </footer>
</body>

<script>
/* ================= v19.55 TIER 1: Environment Configuration v19.55 ================= */

/* --- 1. Global System Identity --- */
    const APP_VERSION = "19.54";
    const storageKeyPrefix = 'prodBudget_v5_';
    const trashKey = `${storageKeyPrefix}trash`;
    const globalItemsKey = `${storageKeyPrefix}globalItems`;
    const templatesKey = `${storageKeyPrefix}templates`;
    const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
    const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;
    
    // Core physics and hydration state
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 7;

/* --- 2. Dynamic Multi-Currency Logic --- */
    let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
    
    // Base Rates (Defaults for offline endurance)
    let exchangeRates = JSON.parse(localStorage.getItem(`${storageKeyPrefix}rates`)) || {
        'USD': 1.0, 'JMD': 157.50, 'GBP': 0.79, 'CAD': 1.36, 'EUR': 0.92,
        'AUD': 1.52, 'NZD': 1.63, 'ZAR': 18.50, 'INR': 83.00, 'JPY': 150.00, 'CNY': 7.20
    };

    const FILM_CURRENCIES = [
        { code: 'JMD', label: 'JMD' }, { code: 'USD', label: 'USD' },
        { code: 'GBP', label: 'GBP' }, { code: 'CAD', label: 'CAD' },
        { code: 'EUR', label: 'EUR' }, { code: 'AUD', label: 'AUD' },
        { code: 'NZD', label: 'NZD' }, { code: 'ZAR', label: 'ZAR' },
        { code: 'INR', label: 'INR' }, { code: 'CNY', label: 'CNY' },
        { code: 'JPY', label: 'JPY' }
    ];

/* --- 3. Master Asset Registry (Consolidated SVG Library) --- */
    const mBTAssets = {
appLogo: `<svg viewBox="0 0 502.17 507.14" fill="none"><circle cx="251.1" cy="253.6" r="251" fill="#fdba35"/><ellipse cx="251.08" cy="254.6" rx="219.09" ry="222.65" fill="#e68b2e"/><rect x="203.17" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><rect x="287.89" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><path fill="#ffffff" d="M435.26 218.85c-9.37 8.14-49.07 32.97-49.8 15.81 11.55-127.5-229.22-149.43-231.01-24.74 6.07 54.05 43.35 54.26 87.82 52.06 146.67-19.16 207.1 157.09 46.91 189.89-58.04 11.48-128.93-19.18-142.75-80.18 46.88 38.84 113.67 68.1 171.96 37.26 26.86-13.77 47.21-49.89 26.52-76.85-38.48-58.02-113.62-26.74-169.36-43.4-33.76-8.68-39.32-44.89-49.26-40.21-40.71 11.77-74.81-18.1-93.73-51.57-11.64-17.99 23.01-37.67 23.01-37.67 78.34-46.2 83.04-2.52 100.98-30.11 13.01-12.52 28.91-19.88 45.88-25.26 14.39-.81-2.14-26.45 12.52-30.74 8.55-3.29 22.55-1.35 21.53 10.41v7.96q0 5.96 6.03 5.19c15.31-1.13 30.59-.73 45.84 1.04 4.51 1.52 6.39.14 5.88-4.8.18-6.63-2.41-16.54 5.48-19.48 39.51-10.45 11.06 33.02 28.69 33.36 24.13 8.69 46.04 20.74 62.06 41.52 1.37 1.77 2.67 1.3 4.34.83 21.56-6.19 44.45 3.51 61.99 15.88 16.53 11.27-10.05 43.62-21.53 53.81Zm-303.07-60.53c-15.13-3.64-31.31 1.65-45.48 7.89-10.48 5.14-25.95 13.17-31.69 19.68-7.43 4.29 10.4 20.59 13.85 25.15 12.7 13.47 31.71 23.14 50.39 17.73 2.48-.4 3.49-1.51 3.13-3.82-2.68-22.93-.15-45.14 9.8-66.63m311.98 17.39c-2.49-5.29-32.19-13.69-45.6-11.24 3.21 8.51 7.77 19.74 8.85 29.37 2.12 18.88 1.07 24.71.92 25.13 14.31-5.74 40.59-33.14 35.83-43.26m-244.14 12.41c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Zm-6.08 168.77c-1.38-2.31-16.01-18.07-16.01-18.07-3.59-3.64-6.21-13.1-14.02-8.77-3.6 2.84-5.79 3.83-.54 12.88 7.81 11.59 24.83 28.14 30.57 13.96m-87.43-126.66c.73.03 1.47.03 2.21.02-.74.01-1.48 0-2.21-.02m-37.65-19.19c.27.27.53.54.8.81-.27-.27-.53-.54-.8-.81m258.53-22.92c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Z"/></svg>`,

       // --- Core UI & Actions ---
    plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
    trash: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
    search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
    close: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
    drag: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
    
    // --- Status & Access ---
    lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    unlock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
    
    // --- Intelligence & Tools ---
    sparkle: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
    doctor: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    chat: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    target: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
    zap: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
    
    // --- Contact & Personnel ---
    user: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
    phone: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
    mail: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
    wa: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`,
    
    // --- File System ---
    file: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`,
    folder: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    cloud: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19A5.5 5.5 0 0 0 18 8.02a9 9 0 0 0-17.53 1.98 7 7 0 0 0 .03 14h12.5a5.5 5.5 0 0 0 4.5-9z"/></svg>`,
    clip: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`,
    
    // --- Editor Controls ---
    money: `<svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>`,
    wand: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21 2-2 2m-7.61 7.61a2 2 0 1 1-2.83 2.83l9.99-9.99a2 2 0 0 1 2.83 2.83l-9.99 9.99"/><path d="M18 16v.01M7 8V8.01M7 16V16.01M3 12V12.01M10 20V20.01M15 5V5.01M12 9V9.01"/></svg>`,
    undo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
    redo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>`,
    copy: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
    list: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    grid: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
    save: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
    print: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>`,

    // --- Footer New Assets ---
gear: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>`,
coffee: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
paperPlane: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`,
};

/* --- 4. Master Link Map (Backwards Compatibility) --- */
    const uiIcons = mBTAssets, tplIcons = mBTAssets, docIcons = mBTAssets, dashIcons = mBTAssets;
    const stageModIcons = mBTAssets, analyticsIcons = mBTAssets, contactIcons = mBTAssets;
    const fileIcons = mBTAssets, opsIcons = mBTAssets, studioIcons = mBTAssets, trashIcons = mBTAssets;

/* --- 5. Production Presets (Industry standard stage ratios) --- */
    const STAGE_PRESETS = {
        'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
        'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
        'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
        'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
    };
    
    console.log("Script parsing started");





/* ========= v19.54 TIER 2: State Proxy & Storage Engine ========= */

/* --- 1. mBT STATE GOVERNOR (Reactivity and data observation) --- */
    // Logic Resolution: Monitors budget object changes and triggers auto-reconciliation.
    const mBTState = {
        _timer: null,
        _isInitialLoad: true,
        _subscribers: [], 
        subscribe: function(callback) { this._subscribers.push(callback); },
        handler: {
            set(target, prop, value) {
                if (target[prop] === value) return true; 
                target[prop] = value;
                if (!mBTState._isInitialLoad) mBTState.requestReconciliation();
                return true;
            }
        },
        requestReconciliation() {
            clearTimeout(this._timer);
            this._timer = setTimeout(() => {
                // --- Brain Handshake: Synchronize logic engines ---
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                if (typeof render === 'function') render();
                
                this._subscribers.forEach(cb => { try { cb(budget); } catch(e) {} });
                if (typeof saveBudget === 'function') saveBudget();
                
                const statusMsg = document.getElementById('statusBarMessage');
                if (statusMsg) statusMsg.textContent = "Production state synchronized.";
            }, 150);
        },
        wrap: function(data) {
            this._isInitialLoad = true;
            const proxied = new Proxy(data, this.handler);
            this._isInitialLoad = false;
            return proxied;
        }
    };

    /* --- 2. mBT STORAGE ENGINE (Heavy data persistence and hydration) --- */
    // Logic Resolution: Splits budget into "Light" (localStorage) and "Heavy" (IndexedDB) streams.
    const mBTStorage = {
        heavyKeys: ['attachments', 'previews', 'scripts', 'photos'],
        dehydrate: async function(budgetData) {
            if (typeof window.localforage === 'undefined') return { light: budgetData, heavy: {} };
            const light = { ...budgetData };
            const heavy = {};
            this.heavyKeys.forEach(key => { 
                if (light[key]) { 
                    heavy[key] = light[key]; 
                    delete light[key]; 
                } 
            });
            return { light, heavy };
        },
        hydrate: async function(lightData) {
            const budgetObj = { ...lightData };
            if (typeof window.localforage === 'undefined') {
                console.warn("mBTStorage: localforage not ready for hydration.");
                return budgetObj;
            }
            for (const key of this.heavyKeys) {
                try {
                    const storageKey = `${budgetObj.projectName}_${key}`;
                    const data = await window.localforage.getItem(storageKey);
                    if (data) budgetObj[key] = data;
                } catch (e) { console.warn(`mBTStorage: Hydration resolution failure for ${key}`); }
            }
            return budgetObj;
        }
    };

    /* --- 3. Persistence Helpers (Keys and local storage access) --- */
    // Logic Resolution: Standardized accessors for project-specific metadata.
    const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
    const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
    const getProjectNameSeparator = () => localStorage.getItem(projectNameSeparatorKey) || '-';
    const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

    function saveBudget() {
        try {
            if (!budget || !budget.projectName) return;
            // Split-save: Light data to LocalStorage for speed, Blobs to IndexedDB for capacity.
            mBTStorage.dehydrate(budget).then(({ light, heavy }) => {
                localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(light));
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                
                for (const [key, value] of Object.entries(heavy)) {
                    localforage.setItem(`${budget.projectName}_${key}`, value);
                }
                currentProjectName = budget.projectName;
            });
        } catch (e) { console.error("mBTStorage: Logic execution failure during save", e); }
    }

    /* --- 4. Global State Registry --- */
    // Logic Resolution: Central variables holding the active application state.
    // Note: exchangeRates and history buffers inherited from Tier 1 declarations.
    let budget;
    let currentProjectName;
    let editingGlobalItemIndex = -1;
    let editingTemplateId = null; 
    let tempTemplateData = null;
    
    // Initializing currency from persistent storage.
    displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';




/* ================= v19.54 TIER 3: Core Logic Engines v19.55 ================= */

/* --- 0. Rate Intelligence (Live Resolution Protocol) --- */
    // Logic Resolution: Centralized math for cross-currency reconciliation and live rate sync.
    async function fetchExchangeRates() {
        if (!navigator.onLine) return;
        try {
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            if (response.ok) {
                const data = await response.json();
                if (data && data.rates) {
                    // Filter logic to only capture industry-standard currencies
                    const validCodes = ['JMD', 'USD', 'GBP', 'CAD', 'EUR', 'AUD', 'NZD', 'ZAR', 'INR', 'CNY', 'JPY'];
                    validCodes.forEach(code => {
                        if (data.rates[code]) exchangeRates[code] = data.rates[code];
                    });
                    localStorage.setItem(`${storageKeyPrefix}rates`, JSON.stringify(exchangeRates));
                    if(typeof render === 'function') render(); 
                }
            }
        } catch (e) {
            console.warn("mBTLE: Currency synchronization failed. Reverting to local cache.");
        }
    }

    /* --- 1. Mathematical Utilities (Reconciliation & formatting helpers) --- */
    // Logic Resolution: Centralizes math to prevent rounding errors across different currencies.
    // MERGED: These utilities are now declared exactly once.
    const getRate = (code) => exchangeRates[code] || 1;
    
    const convertFromBase = (amountInJMD, targetCurrency) => {
        const jmdRate = getRate('JMD');
        const targetRate = getRate(targetCurrency);
        return (amountInJMD / jmdRate) * targetRate;
    };

    const convertToBase = (amountInTarget, sourceCurrency) => {
        const jmdRate = getRate('JMD');
        const sourceRate = getRate(sourceCurrency);
        return (amountInTarget / sourceRate) * jmdRate;
    };

    const toDisp = (val) => convertFromBase(val, displayCurrency);

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: displayCurrency,
            maximumFractionDigits: 0 
        }).format(amount);
    };

    function formatAbbreviated(num, currency) {
        const val = Math.abs(num);
        const symbol = (0).toLocaleString('en-US', { style: 'currency', currency: currency }).replace(/0.00|0/g, '').trim();
        const sign = num < 0 ? "-" : "";
        
        if (val >= 1e9) return `${sign}${symbol}${(val / 1e9).toFixed(1)}B`;
        if (val >= 1e6) return `${sign}${symbol}${(val / 1e6).toFixed(1)}M`;
        if (val >= 1e3) return `${sign}${symbol}${(val / 1e3).toFixed(1)}K`;
        return formatCurrency(num);
    }

    function calculateItem(item) {
        const qty = parseFloat(item.quantity) || 0;
        const rate = parseFloat(item.rate) || 0;
        const multiplier = parseFloat(item.multiplier) || 1;
        const estimated = qty * rate * multiplier;
        const actual = parseFloat(item.actual) || 0;
        return { estimated: estimated, variance: actual - estimated };
    }

    /* ========= mBTLE: THE FINANCIAL PROCESSOR (Mathematical reconciliation) ========= */
    const mBTLE = {
        config: {
            currencies: {
                'JMD': { locale: 'en-JM', symbol: 'JMD$', rate: 1 },
                'USD': { locale: 'en-US', symbol: '$', rate: 1 },
                'GBP': { locale: 'en-GB', symbol: 'Â£', rate: 1 },
                'CAD': { locale: 'en-CA', symbol: 'CA$', rate: 1 },
                'EUR': { locale: 'de-DE', symbol: 'â‚¬', rate: 1 }
            }
        },
        format: {
            currency: function(value, code) {
                const currencyCode = code || displayCurrency || 'JMD';
                const cfg = mBTLE.config.currencies[currencyCode] || mBTLE.config.currencies['USD'];
                return new Intl.NumberFormat(cfg.locale, {
                    style: 'currency', currency: currencyCode, currencyDisplay: 'narrowSymbol'
                }).format(value);
            }
        },
        validate: {
            item: function(item) {
                item.quantity = Math.max(0, parseFloat(item.quantity) || 0);
                item.rate = Math.max(0, parseFloat(item.rate) || 0);
                item.multiplier = Math.max(1, parseFloat(item.multiplier) || 1);
                return item;
            }
        },
        reconcile: function() {
            if (!budget || !budget.sections) return;
            let subtotal = 0; let grandActual = 0;
            const isMobile = window.innerWidth < 768;

            Object.keys(budget.sections).forEach(sectionKey => {
                let sectionEstTotal = 0;
                const section = budget.sections[sectionKey];
                section.items.forEach(item => {
                    this.validate.item(item);
                    const calc = calculateItem(item);
                    item.total = calc.estimated;
                    sectionEstTotal += item.total;
                    const actVal = parseFloat(item.actual) || 0;
                    grandActual += actVal;
                    
                    const estCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                    if (estCell) estCell.textContent = isMobile ? formatAbbreviated(item.total, displayCurrency) : this.format.currency(item.total);
                    
                    const varCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                    if (varCell) {
                        const variance = actVal - item.total;
                        varCell.textContent = isMobile ? formatAbbreviated(variance, displayCurrency) : this.format.currency(variance);
                        varCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                    }
                });
                section.total = sectionEstTotal;
                subtotal += sectionEstTotal;
                const sectionTotalEl = document.querySelector(`[data-section-total="${sectionKey}"]`);
                if (sectionTotalEl) sectionTotalEl.textContent = this.format.currency(sectionEstTotal);
            });

            const contingency = subtotal * ((budget.contingencyPercentage || 0) / 100);
            const tax = subtotal * ((budget.salesTaxPercentage || 0) / 100);
            const preDiscount = subtotal + contingency + tax;
            const discount = preDiscount * ((budget.discountPercentage || 0) / 100);
            const grandTotal = preDiscount - discount;

            this.updateUI('summarySubtotal', subtotal);
            this.updateUI('summaryContingency', contingency);
            this.updateUI('summaryTax', tax);
            this.updateUI('summaryDiscount', -discount);
            this.updateUI('summaryGrandTotal', grandTotal);
            this.updateUI('summaryActualTotal', grandActual);
            
            budget.subtotal = subtotal;
            budget.grandTotal = grandTotal;
            budget.actualTotal = grandActual;
        },
        updateUI: function(id, val) {
            const el = document.getElementById(id);
            if (el) el.textContent = this.format.currency(val);
        }
    };

    /* ========= mBTOG: OPEN GATE ENGINE (The Industry Brain) ========= */
    const mBTOG = {
        settings: {
            optInSharing: JSON.parse(localStorage.getItem('moo_og_share') || 'false'),
            location: localStorage.getItem('moo_og_loc') || 'Jamaica'
        },
        rates: [], contacts: [], templates: [], 

        init() {
            this.loadRates();
            this.loadContacts();
            this.loadTemplates();
            console.log(`Open Gate Initialized: ${this.rates.length} rates.`);
        },

        loadRates() {
            const stored = JSON.parse(localStorage.getItem('prodBudget_v5_globalItems') || '[]');
            this.rates = (stored.length === 0) ? this._getJamaicaDatabase() : stored;
            if (stored.length === 0) this.saveRates();
        },

        loadContacts() { this.contacts = JSON.parse(localStorage.getItem('moo_contacts') || '[]'); },

        // --- NON-TRUNCATABLE TEMPLATE REGISTRY ---
        loadTemplates() {
            this.templates = [
                { id: 'script', cat: 'Pre-Prod', label: 'Script', icon: 'ðŸ“', default: true },
                { id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: 'ðŸ“–', default: false },
                { id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: 'ðŸ”', default: true },
                { id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: 'ðŸŽ¬', default: true },
                { id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: 'ðŸŽ¨', default: false },
                { id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: 'âœ…', default: true },
                { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: 'ðŸ‘¤', default: false },
                { id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: 'ðŸŽ­', default: false },
                { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: 'ðŸ“…', default: false },
                { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: 'ðŸ—“ï¸', default: false },
                { id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: 'ðŸ“', default: false },
                { id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget/Cost Report', icon: 'ðŸ’°', default: true },
                { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: 'âš–ï¸', default: false },
                { id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: 'ðŸš€', default: false },
                { id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: 'ðŸ“¢', default: true },
                { id: 'prodReport', cat: 'Production', label: 'Production Report', icon: 'ðŸ“Š', default: true },
                { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: 'ðŸŽ¬', default: false },
                { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: 'ðŸ’„', default: false },
                { id: 'propList', cat: 'Production', label: 'Prop List', icon: 'ðŸ”«', default: false },
                { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'ðŸ“ž', default: true },
                { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: 'ðŸš—', default: false },
                { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: 'ðŸ±', default: false },
                { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: 'ðŸ’µ', default: false },
                { id: 'po', cat: 'Production', label: 'Purchase Order', icon: 'ðŸ§¾', default: false },
                { id: 'timecard', cat: 'Production', label: 'Timecards', icon: 'â±ï¸', default: false },
                { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: 'ðŸ¤–', default: false },
                { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: 'ðŸŒ±', default: false },
                { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: 'ðŸ‘¾', default: false },
                { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: 'ðŸ“…', default: true },
                { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: 'ðŸ“¦', default: false },
                { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: 'ðŸ†', default: false },
                { id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: 'ðŸ¤', default: true },
                { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: 'ðŸ ', default: true },
                { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: 'ðŸŽ¥', default: false },
                { id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: 'ðŸ“„', default: false },
                { id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: 'ðŸ›¡ï¸', default: false },
                { id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: 'âœï¸', default: false },
                { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: 'ðŸ˜·', default: false },
                { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: 'â­', default: false }
            ];
        },

        saveRates() { localStorage.setItem('prodBudget_v5_globalItems', JSON.stringify(this.rates)); },
        ingest(items, type = 'rate') {
            let added = 0;
            if (type === 'rate') {
                const existing = new Set(this.rates.map(i => i.description.toLowerCase()));
                items.forEach(i => {
                    if (!existing.has(i.description.toLowerCase())) {
                        this.rates.push({ description: i.description, unit: i.unit || 'Day', rate: parseFloat(i.rate) || 0 });
                        added++;
                    }
                });
                if (added > 0) this.saveRates();
            } 
            return added;
        },

        // --- NON-TRUNCATABLE JAMAICA 2025 DATABASE ---
        _getJamaicaDatabase() {
            return [
                { description: 'Storyboard Artist', unit: 'Day', rate: 45000 },
                { description: 'Copywriter (Pitch/Treatment)', unit: 'Flat', rate: 75000 },
                { description: 'Script Consultant / Doctor', unit: 'Flat', rate: 150000 },
                { description: 'Pitch Deck Designer', unit: 'Flat', rate: 120000 },
                { description: 'Researcher', unit: 'Day', rate: 25000 },
                { description: 'Concept Artist', unit: 'Day', rate: 40000 },
                { description: 'Legal - Rights & Clearances', unit: 'Flat', rate: 250000 },
                { description: 'Director', unit: 'Day', rate: 85000 },
                { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
                { description: 'Producer', unit: 'Day', rate: 75000 },
                { description: 'Line Producer', unit: 'Day', rate: 65000 },
                { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
                { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
                { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
                { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },
                { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
                { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
                { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
                { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
                { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
                { description: 'Key PA', unit: 'Day', rate: 20000 },
                { description: 'Set PA', unit: 'Day', rate: 15000 },
                { description: 'Office PA', unit: 'Day', rate: 15000 },
                { description: 'Truck PA', unit: 'Day', rate: 18000 },
                { description: 'Location Manager', unit: 'Day', rate: 50000 },
                { description: 'Location Scout', unit: 'Day', rate: 35000 },
                { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
                { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
                { description: 'Security Guard', unit: 'Day', rate: 12000 },
                { description: 'Craft Service', unit: 'Day', rate: 25000 },
                { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },
                { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
                { description: 'Camera Operator', unit: 'Day', rate: 60000 },
                { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
                { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
                { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
                { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
                { description: 'Drone Operator', unit: 'Day', rate: 55000 },
                { description: 'Camera Utility', unit: 'Day', rate: 25000 },
                { description: 'Gaffer', unit: 'Day', rate: 55000 },
                { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
                { description: 'Electrician', unit: 'Day', rate: 30000 },
                { description: 'Key Grip', unit: 'Day', rate: 50000 },
                { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
                { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
                { description: 'Grip', unit: 'Day', rate: 30000 },
                { description: 'Generator Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
                { description: 'Boom Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Utility', unit: 'Day', rate: 25000 },
                { description: 'Production Designer', unit: 'Day', rate: 65000 },
                { description: 'Art Director', unit: 'Day', rate: 50000 },
                { description: 'Set Decorator', unit: 'Day', rate: 45000 },
                { description: 'Set Dresser', unit: 'Day', rate: 30000 },
                { description: 'Props Master', unit: 'Day', rate: 45000 },
                { description: 'Assistant Props', unit: 'Day', rate: 30000 },
                { description: 'Costume Designer', unit: 'Day', rate: 55000 },
                { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
                { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
                { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },
                { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
                { description: 'Editor', unit: 'Day', rate: 50000 },
                { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
                { description: 'Colorist', unit: 'Hour', rate: 15000 },
                { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
                { description: 'VFX Artist', unit: 'Day', rate: 55000 },
                { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
                { description: 'Composer', unit: 'Flat', rate: 200000 },
                { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
            ];
        },
    };
    mBTOG.init();

    /* ========= mBTStagesEngine: Production Phase Metrics ========= */
    const mBTStagesEngine = {
        getMetrics: function() {
            const tl = budget.targetLock || { totalCap: 0, stages: {} };
            const result = {
                grandTotal: 0, stageTotals: { dev: 0, pre: 0, prod: 0, post: 0, dist: 0 },
                totalCap: tl.totalCap || 0
            };

            Object.values(budget.sections).forEach(sec => {
                sec.items.forEach(item => {
                    if (item.stageData) {
                        Object.entries(item.stageData).forEach(([key, data]) => {
                            const k = key.toLowerCase();
                            if (result.stageTotals[k] !== undefined) {
                                const cost = (parseFloat(data.days) || 0) * (parseFloat(data.rate) || 0);
                                result.stageTotals[k] += cost;
                                result.grandTotal += cost;
                            }
                        });
                    }
                });
            });
            return result;
        },
        getBurnStatus: function(current, cap) {
            const pct = cap > 0 ? (current / cap) * 100 : 0;
            if (pct > 100) return { color: 'text-red-600', bg: 'bg-red-500', ring: 'border-red-200', pct };
            if (pct > 85) return { color: 'text-blue-600', bg: 'bg-blue-600', ring: 'border-blue-200', pct }; 
            return { color: 'text-green-600', bg: 'bg-green-500', ring: 'border-green-200', pct };
        }
    };

    /* --- 2. Logic Bridges & Data Normalization --- */
    function recalculateTemplateQuantities(data) {
        if (!data.days) return;
        const { principal, scouting, preprod } = data.days;
        const totalDays = (parseFloat(principal) || 0) + (parseFloat(scouting) || 0) + (parseFloat(preprod) || 0);
        Object.values(data.sections).forEach(section => {
            section.items.forEach(item => { if (item.unit === 'Day') item.quantity = totalDays; });
        });
    }

    function balanceStageSliders(changedKey, newValue) {
        const stages = budget.targetLock.stages;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        newValue = Math.max(0, Math.min(100, parseFloat(newValue) || 0));
        const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
        const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
        const lockedTotal = lockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
        stages[changedKey].ratio = Math.min(newValue, 100 - lockedTotal);
        const remaining = Math.max(0, 100 - stages[changedKey].ratio - lockedTotal);
        if (unlockedKeys.length > 0) {
            const currentUnlockedTotal = unlockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
            unlockedKeys.forEach(k => {
                stages[k].ratio = (currentUnlockedTotal <= 0.01) ? remaining / unlockedKeys.length : remaining * (stages[k].ratio / currentUnlockedTotal);
            });
        }
    }

    const mBTAssign = {
        assignFromContacts() {
            const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG.contacts || []));
            if (!contacts.length) return { assigned: 0, message: 'No records found' };
            let assigned = 0;
            Object.values(budget.sections).forEach(s => s.items.forEach(i => {
                if (i.crew?.name) return;
                const match = contacts.find(c => c.role && i.description.toLowerCase().includes(c.role.toLowerCase()));
                if (match) { 
                    i.crew = { name: match.name, phone: match.contact?.includes('@') ? '' : match.contact, email: match.contact?.includes('@') ? match.contact : '' }; 
                    assigned++; 
                }
            }));
            if (assigned > 0) mBTLE.reconcile();
            return { assigned, message: `${assigned} personnel synchronized` };
        }
    };

/* --- 3a. Template & Database Logic Manager --- */
const mBTDBM = {
    // --- Template Logic ---
    getTemplates: function() {
        const defaults = {
            'Commercial': { items: [{ description: 'Director', rate: 1500, unit: 'Day' }, { description: 'DOP', rate: 1200, unit: 'Day' }] },
            'Music Video': { items: [{ description: 'Director', rate: 800, unit: 'Day' }, { description: 'Editor', rate: 600, unit: 'Flat' }] }
        };
        const stored = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
        return { ...defaults, ...stored };
    },
    saveTemplate: function(name, items) {
        const current = this.getTemplates();
        // Remove from defaults if overriding, or just save to custom
        const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
        custom[name] = { items: items };
        localStorage.setItem('mBT_templates', JSON.stringify(custom));
    },
    deleteTemplate: function(name) {
        if(['Commercial', 'Music Video'].includes(name)) return alert('Cannot delete default templates.');
        const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
        delete custom[name];
        localStorage.setItem('mBT_templates', JSON.stringify(custom));
        return true;
    },
    // --- Helper for UI ---
    renderTemplateOptions: function(selected) {
        return Object.keys(this.getTemplates()).map(k => 
            `<option value="${k}" ${k === selected ? 'selected' : ''}>${k}</option>`
        ).join('');
    }
};


/* ========= v19.55 CONNECTIVE TISSUE: Logic Resolution Utilities ========= */

    /* --- 1. Project Inventory Resolution --- */
    // Logic: Filters localStorage for keys belonging strictly to this application.
    const getProjectList = () => Object.keys(localStorage)
        .filter(k => k.startsWith(storageKeyPrefix) && 
            !['lastLoaded', 'currency', 'trash', 'globalItems', 'templates'].some(x => k.includes(x)) &&
            !k.includes('ApiKey'))
        .map(k => k.substring(storageKeyPrefix.length))
        .sort();

    /* --- 2. Data Hydration Sequence --- */
    // Logic: Fetches, hydrates, and proxies the budget data.
    async function loadBudget(projectName) {
        try {
            const data = localStorage.getItem(storageKeyPrefix + projectName);
            if (!data) return handleNewProject(false);

            const lightData = JSON.parse(data);
            currentProjectName = projectName;

            // Step A: Immediate Proxy for UI responsiveness
            budget = mBTState.wrap(lightData);
            
            // Step B: Heavy Stream Hydration (IndexedDB Blobs)
            const fullData = await mBTStorage.hydrate(lightData);
            budget = mBTState.wrap(fullData);
            
            // Step C: History Reset
            historyStack = [{ budget: JSON.parse(JSON.stringify(fullData)), description: 'Environment Initialized' }];
            historyIndex = 0;

            if (typeof render === 'function') render();
            localStorage.setItem(`${storageKeyPrefix}lastLoaded`, currentProjectName);
        } catch (e) { console.error("mBTStorage: Data hydration resolution failure.", e); }
    }

    /* --- 3. Environmental Persistence Triggers --- */
    function pushToHistory(description) {
        if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
        historyStack.push({ budget: JSON.parse(JSON.stringify(budget)), description });
        if (historyStack.length > MAX_HISTORY) historyStack.shift();
        historyIndex = historyStack.length - 1;
        saveBudget();
    }

    /* --- 4. Neural Link Bridge (AI API Utilities) --- */
    const getStoredApiKey = (p) => localStorage.getItem(`${storageKeyPrefix}${p}ApiKey`) || '';
    const saveStoredApiKey = (p, k) => localStorage.setItem(`${storageKeyPrefix}${p}ApiKey`, k);
    const getSelectedProvider = () => localStorage.getItem(`${storageKeyPrefix}selectedAiProvider`) || 'gemini';

    async function callUnifiedAI(provider, apiKey, prompt) {
        const systemPrompt = "You are a Film Production Budgeting Expert. Prioritize analyzing budget data.";
        // Logic Resolution: Simplified Fetch pattern for PWA endurance
        const baseUrl = provider === 'gemini' 
            ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`
            : 'https://api.openai.com/v1/chat/completions';
        
        // ... (Fetch logic implementation from 8k version here)
        return "Neural Response: Analysis pending resolution.";
    }

// Logic Resolution: Handles renaming projects.
    function handleProjectNameChange(e) {
        const newName = e.target.value.trim();
        if(!newName) return;
        const oldKey = storageKeyPrefix + budget.projectName;
        const newKey = storageKeyPrefix + newName;
        if(localStorage.getItem(newKey)) {
            alert("Project name already exists.");
            e.target.value = budget.projectName;
            return;
        }
        localStorage.removeItem(oldKey);
        budget.projectName = newName;
        saveBudget();
        currentProjectName = newName;
    }
// Logic Resolution: Handles Project Duplication.
function handleDuplicateProject() {
    if(!budget) return;
    const copy = JSON.parse(JSON.stringify(budget));
    copy.projectName = copy.projectName + " (Copy)";
    budget = mBTState.wrap(copy);
    saveBudget();
    render();
}
console.log("TIER 3 complete");




/* ========= v19.54 TIER 4: Atomic Render Pipeline v19.55 ========= */
/* --- 2. String Utilities (Presentation layer metadata) --- */
// Logic Resolution: Prevents long filenames from breaking Studio layout containers.
function getAbbreviatedName(name, maxLen = 25) {
    if (name.length <= maxLen) return name;
    const ext = name.split('.').pop();
    const base = name.substring(0, name.lastIndexOf('.'));
    const keep = maxLen - ext.length - 4;
    return base.substring(0, keep) + '...' + ext;
}
    const RenderEngine = {
        // --- XSS Neutralization: Standardized string escaping ---
        // Logic Resolution: Protects the DOM from injection by sanitizing all user-generated strings.
        esc(str) { 
            return !str ? '' : String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;'); 
        },

        // --- Layout Shell: Section container generation ---
        // Logic Resolution: Constructs the collapsible department headers and their item containers.
        section({ name, total = '', isOpen = true, content = '' }) {
            const safeName = this.esc(name);
            return `
                <div class="mb-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="sticky-section-header relative min-h-[48px] px-4 py-3 flex justify-between items-center cursor-pointer bg-slate-50 select-none group" data-section-toggle="${safeName}">
                        <div class="flex items-center gap-3">
                            <span class="section-arrow text-blue-500 transition-transform ${isOpen ? 'rotate-0' : '-rotate-90'}">${mBTAssets.plus}</span>
                            <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-widest leading-none">${safeName}</h2>
                        </div>
                        <span data-section-total="${safeName}" class="text-sm font-black text-blue-600 font-mono flex-shrink-0">${total}</span>
                    </div>
                    <div class="section-content ${isOpen ? '' : 'hidden'} animate-in fade-in slide-in-from-top-1 duration-200">
                        ${content}
                    </div>
                </div>`;
        },

        // --- Data Row Blueprint: Itemized line generation ---
// Logic Resolution: Mobile-optimized widths, font-scaling, and "touch-friendly" inputs.
lineItem(item, sectionName) {
            const safeId = this.esc(item.id); 
            const safeSection = this.esc(sectionName);
            const isMobile = window.innerWidth < 768;
            const { estimated, variance } = calculateItem(item); 
            const crew = item.crew || {};
            const isLocked = item.rateType === 'fixed';
            const initials = crew.name ? crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            
            // Logic: Clean phone for links
            const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
            const waLink = `https://wa.me/${(cleanPhone.length === 10 && (cleanPhone.startsWith('876') || cleanPhone.startsWith('658'))) ? '1'+cleanPhone : cleanPhone}`;

            return `
                <tr class="group border-b border-slate-50 hover:bg-blue-50/30 transition-all draggable-row" data-item-id="${safeId}" data-section="${safeSection}">
                    <td class="p-2 text-center relative w-[40px] md:w-12 overflow-visible">
                        <div class="crew-wrapper inline-block">
                            <button onclick="toggleCrewPopup(this, event)" class="crew-avatar w-7 h-7 md:w-8 md:h-8 rounded-full border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300 hover:border-blue-400 hover:text-blue-500 transition-all ${crew.name ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white'} relative z-20">
                                <span class="text-[8px] md:text-[10px] font-black">${initials}</span>
                            </button>

                            <div class="crew-popup">
                                ${crew.name ? `
                                    ${cleanPhone.length > 6 ? `
                                        <a href="tel:${cleanPhone}" class="contact-action-btn action-call" title="Call">${mBTAssets.phone}</a>
                                        <a href="${waLink}" target="_blank" class="contact-action-btn action-wa" title="WhatsApp">${mBTAssets.wa}</a>
                                    ` : ''}
                                    ${crew.email && crew.email.includes('@') ? `
                                        <a href="mailto:${crew.email}" class="contact-action-btn action-email" title="Email">${mBTAssets.mail}</a>
                                    ` : ''}
                                    <button onclick="openCrewProfile(this, event, '${safeId}', '${safeSection}')" class="contact-action-btn action-profile" title="Profile">${mBTAssets.user}</button>
                                ` : `
                                    <button onclick="openCrewProfile(this, event, '${safeId}', '${safeSection}')" class="flex items-center gap-1 text-[9px] font-black uppercase text-slate-400 hover:text-white transition-colors">
                                        <span>Assign</span> ${mBTAssets.plus}
                                    </button>
                                `}
                            </div>
                        </div>
                    </td>
                    
                    <td class="p-2 w-[30px] md:w-8 drag-handle text-slate-200 hover:text-slate-400 cursor-grab active:cursor-grabbing text-center">${mBTAssets.drag}</td>
                    
                    <td class="p-2 text-left">
                        <input type="text" data-id="${safeId}" data-section="${safeSection}" data-field="description" value="${this.esc(item.description)}" 
                               class="w-full bg-transparent border-none font-bold text-xs md:text-sm text-slate-700 focus:ring-0 truncate mobile-desc-truncate" placeholder="Item...">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[35px] md:w-16">
                        <input type="number" data-id="${safeId}" data-section="${safeSection}" data-field="quantity" value="${item.quantity}" 
                               class="w-full bg-transparent border-none text-center font-black text-[10px] md:text-xs text-blue-600 focus:ring-0 no-spinner p-0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[40px] md:w-20">
                        <select data-id="${safeId}" data-section="${safeSection}" data-field="unit" 
                                class="w-full bg-transparent border-none text-[8px] md:text-[10px] font-black uppercase tracking-tighter text-slate-400 focus:ring-0 cursor-pointer p-0 text-center">
                            ${['Day','Week','Flat','Policy','Hour'].map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u.substring(0,3)}</option>`).join('')}
                        </select>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-32">
                        <div class="flex items-center gap-1 justify-end md:justify-start">
                            <button onclick="toggleRateType('${safeId}', '${safeSection}')" class="hidden md:flex w-6 h-6 rounded-lg transition-all flex-shrink-0 items-center justify-center ${isLocked ? 'text-rose-500 bg-rose-50' : 'text-emerald-600 bg-emerald-50'}">
                                <span class="scale-75">${isLocked ? mBTAssets.lock : mBTAssets.zap}</span>
                            </button>
                            <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="rate" value="${toDisp(item.rate).toFixed(2)}" 
                                   class="w-full bg-transparent border-none font-mono font-bold text-[10px] md:text-xs text-slate-500 focus:ring-0 no-spinner text-right md:text-left p-0">
                        </div>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28 font-mono font-bold text-[10px] md:text-xs text-slate-800 text-right" data-estimated-id="${safeId}">
                        ${isMobile ? formatAbbreviated(estimated, displayCurrency) : mBTLE.format.currency(estimated)}
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28">
                        <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="actual" value="${toDisp(item.actual || 0).toFixed(2)}" 
                               class="w-full bg-blue-50/50 rounded-md border-none font-mono font-bold text-[10px] md:text-xs text-emerald-600 focus:ring-0 no-spinner text-right p-1" placeholder="0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-28 text-right font-mono font-black text-[10px] md:text-xs" data-variance-id="${safeId}">
                        ${isMobile ? formatAbbreviated(variance, displayCurrency) : mBTLE.format.currency(variance)}
                    </td>
                    
                    <td class="p-1 md:p-2 text-center w-[30px] md:w-10">
                        <button onclick="handleRemoveItem('${safeSection}', '${safeId}')" class="text-slate-200 hover:text-rose-500 transition-colors scale-75 md:scale-100">
                            ${mBTAssets.trash}
                        </button>
                    </td>
                </tr>`;
        },

        // --- Stage Visualization: Production phase card generation ---
        // Logic Resolution: Renders specialized cards for the Production Stages view with burn-rate telemetry.
        stageCard(item, stageKey) {
            const cost = (item._sDays || 0) * (item._sRate || 0);
            return `
                <div class="stage-card-item p-3 bg-white border border-slate-100 rounded-xl shadow-sm space-y-2 group relative" data-item-id="${item.id}" data-stage-key="${stageKey}">
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 pr-6">
                            <p class="text-[10px] font-black text-slate-800 uppercase truncate">${this.esc(item.description)}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">${this.esc(item._sec)}</p>
                        </div>
                        <button onclick="removeStageItem('${item.id}', '${item._sec}', '${stageKey}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">
                            ${mBTAssets.close}
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Days</label>
                            <input type="number" value="${item._sDays}" onchange="updateStageItem('${item.id}', '${item._sec}', '${stageKey}', 'days', this.value)" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-bold text-blue-600 no-spinner">
                        </div>
                        <div class="flex-[2]">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Rate</label>
                            <input type="number" value="${item._sRate}" onchange="updateStageItem('${item.id}', '${item._sec}', '${stageKey}', 'rate', this.value)" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-mono font-bold text-slate-600 no-spinner">
                        </div>
                    </div>
                    <div class="pt-1 flex justify-between items-center border-t border-slate-50">
                        <span class="text-[8px] font-black text-slate-300 uppercase">Allocated Cost</span>
                        <span id="cost-${item.id}-${stageKey}" class="text-[10px] font-black text-slate-900 font-mono">${formatAbbreviated(cost, displayCurrency)}</span>
                    </div>
                </div>`;
        }
    };

/* --- 4. Render Orchestration: Global UI drawing logic --- */
    function renderBudgetSections() {
        if (!budget || !budget.sections) return '';
        return Object.entries(budget.sections).map(([name, section]) => {
            // Logic Resolution: Responsive Table Headers
            // Note the dual width classes (e.g., w-[50px] md:w-28) to handle the mobile shift
            const bodyContent = `
                <div class="table-container overflow-x-auto no-scrollbar">
                    <table class="w-full border-collapse min-w-full table-fixed md:table-auto">
                        <thead class="sticky-th bg-white text-slate-400 font-black uppercase tracking-tighter border-b border-slate-100 text-[8px] md:text-[10px]">
                            <tr>
                                <th class="p-2 text-center w-[40px] md:w-12">Crew</th>
                                <th class="p-2 w-[30px] md:w-8"></th> 
                                <th class="p-2 text-left">Description</th>
                                <th class="p-2 text-center w-[35px] md:w-16">Qty</th>
                                <th class="p-2 text-center w-[40px] md:w-20">Unit</th>
                                <th class="p-2 text-right md:text-left w-[50px] md:w-32">Rate</th>
                                <th class="p-2 text-right md:text-left w-[55px] md:w-28 font-black">Est</th>
                                <th class="p-2 text-right md:text-left w-[55px] md:w-28">Act</th>
                                <th class="p-2 text-right w-[50px] md:w-28">Var</th>
                                <th class="p-2 w-[30px] md:w-10"></th>
                            </tr>
                        </thead>
                        <tbody data-section-body="${name}">
                            ${section.items.map(item => RenderEngine.lineItem(item, name)).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="p-1 bg-slate-50/50 border-t border-slate-100 rounded-b-2xl">
                    <button data-add-item="${name}" class="w-full py-2.5 text-center text-blue-600 font-black text-[10px] uppercase tracking-widest hover:bg-blue-50 transition-all">
                        ${mBTAssets.plus} Add Line Item
                    </button>
                </div>`;

            return RenderEngine.section({
                name: name,
                total: mBTLE.format.currency(section.total),
                isOpen: section.isOpen,
                content: bodyContent
            });
        }).join('');
    }

    function render() {
        const app = document.getElementById('app');
        if (!budget || !app) return;
        const active = document.activeElement;
        const activeId = active?.id;
        const activeData = { id: active?.dataset.id, field: active?.dataset.field };
        
        // --- Synchronization: Reconcile math logic before drawing frame ---
        mBTLE.reconcile();

        app.innerHTML = `
        <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto flex-grow">
                <input type="text" id="projectName" value="${budget.projectName}" class="text-2xl sm:text-4xl font-black uppercase text-slate-900 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-3 rounded-2xl transition-all tracking-tighter" />
                <button id="loginBtn" class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all shadow-xl flex-shrink-0 active:scale-90"></button>
            </div>
            <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
        </header>

        <div class="flex gap-2 items-center mb-6">
            <button id="openAiToolsBtn" class="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg transition-all hover:bg-indigo-700 active:scale-95 flex items-center justify-center">
    ${mBTAssets.wand}
</button>
            <div id="statusBar" class="flex-grow p-3.5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex justify-between items-center shadow-2xl"></div>
        </div>

        <div id="summary" class="mb-10 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-blue-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 transition-transform group-hover:scale-110 duration-700">${mBTAssets.money}</div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-blue-200 mb-1">Estimated Grand Total</p>
                    <p id="summaryGrandTotal" class="text-4xl font-black tracking-tighter">${mBTLE.format.currency(budget.grandTotal)}</p>
                </div>
                <div class="bg-emerald-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-200 mb-1">Actual Expenditure</p>
                    <p id="summaryActualTotal" class="text-4xl font-black tracking-tighter">${mBTLE.format.currency(budget.actualTotal)}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Discount</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryDiscount" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.grandTotal * (budget.discountPercentage/100))}</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Contingency</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryContingency" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.subtotal * (budget.contingencyPercentage/100))}</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sales Tax</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryTax" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.subtotal * (budget.salesTaxPercentage/100))}</p>
                </div>

                <div class="p-4 bg-slate-900 rounded-2xl shadow-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Project Subtotal</p>
                    <p id="summarySubtotal" class="text-lg font-black text-white">${mBTLE.format.currency(budget.subtotal)}</p>
                </div>
            </div>
        </div>

        <main id="budget-sections" class="space-y-4">${renderBudgetSections()}</main>

        <div class="mt-12 p-5 bg-slate-900 rounded-[32px] text-[10px] text-slate-400 font-bold uppercase tracking-widest border border-black shadow-2xl">
            <span class="opacity-50">Intelligence:</span> Industrial personnel rates based on 2025 verified logic. Regional data resolution applied.
            <button id="compareRatesBtn" class="ml-3 text-blue-400 hover:text-white transition-colors underline decoration-blue-500/30 underline-offset-4">Open Matrix</button>
        </div>`;
        
        if (typeof renderProjectManagement === 'function') renderProjectManagement();
        if (typeof renderStatusBar === 'function') renderStatusBar();
        if (typeof initializeInteractiveInputs === 'function') initializeInteractiveInputs();
        if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
        if (typeof updateOnlineStatus === 'function') updateOnlineStatus(); 

        // --- View Resolution: Focus restoration ---
        if (activeId) {
            const el = document.getElementById(activeId);
            if (el) el.focus();
        } else if (activeData.id && activeData.field) {
            const selector = `[data-id="${activeData.id}"][data-field="${activeData.field}"]`;
            const elToFocus = document.querySelector(selector);
            if (elToFocus) elToFocus.focus();
        }
    }
// Logic Resolution: Handles the creation of the default project structure.
function handleNewProject(force = false, type = 'Commercial') {
    if (force && !confirm("Overwrite current project environment?")) return;
    const defaultSections = {
        'Above The Line': { id: 'atl', isOpen: true, items: [] },
        'Production': { id: 'prod', isOpen: true, items: [] },
        'Post-Production': { id: 'post', isOpen: true, items: [] },
        'Other': { id: 'other', isOpen: true, items: [] }
    };
    const newBudget = {
        projectName: "New Project " + Date.now().toString().slice(-4),
        company: "Independent",
        startDate: new Date().toISOString().split('T')[0],
        sections: defaultSections,
        grandTotal: 0,
        subtotal: 0,
        actualTotal: 0,
        contingencyPercentage: 10,
        salesTaxPercentage: 0,
        discountPercentage: 0,
        documents: [],
        attachments: [],
        aiContext: { chat: [], analysis: "" }
    };
    budget = mBTState.wrap(newBudget);
    currentProjectName = budget.projectName;
    saveBudget();
    if(typeof render === 'function') render();
}

// Logic Resolution: Removes items from the budget object.
function handleRemoveItem(sectionName, itemId) {
    if(!confirm("Remove this line item permanently?")) return;
    const sec = budget.sections[sectionName];
    if(sec) {
        sec.items = sec.items.filter(i => i.id !== itemId);
        mBTLE.reconcile();
        render();
    }
}

// Logic Resolution: Modal for adding new line items from Open Gate.
function showItemSelectorModal(sectionName) {
    // Define the commit handler globally for HTML access
    window._commitAddItem = (desc, rate, unit) => {
        const section = budget.sections[sectionName];
        if (!section) return;
        const newItem = {
            id: 'item_' + Date.now(),
            description: desc || 'New Item',
            quantity: 1,
            unit: unit || 'Day',
            rate: parseFloat(rate) || 0,
            multiplier: 1,
            actual: 0,
            crew: { name: '', phone: '', email: '' },
            rateType: 'negotiable'
        };
        section.items.push(newItem);
        mBTME.close('itemSelectorModal');
        mBTLE.reconcile();
        render();
    };

    const rates = mBTOG.rates || [];
    
    // Custom filter logic to preserve the 'Create Custom' button dynamically
    window._filterItemSelector = (val) => {
        const container = document.getElementById('ogItemList');
        if(!container) return;
        const term = val.toLowerCase();
        const filtered = rates.filter(r => r.description.toLowerCase().includes(term));
        
        const customBtn = `
            <button onclick="window._commitAddItem('${RenderEngine.esc(val)}', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-indigo-200 text-indigo-600 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                <span class="text-[10px] font-black uppercase tracking-widest">+ Create "${RenderEngine.esc(val) || 'New Item'}"</span>
            </button>`;

        const listHtml = filtered.map(r => `
            <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
            </button>
        `).join('');
        
        container.innerHTML = customBtn + listHtml;
    };

    const content = `
        <div class="flex flex-col h-[500px]">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <input type="text" oninput="window._filterItemSelector(this.value)" placeholder="SEARCH OPEN GATE..." class="w-full p-3 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-500 transition-all" autofocus>
            </div>
            <div id="ogItemList" class="flex-grow overflow-y-auto p-2 bg-white no-scrollbar">
                <button onclick="window._commitAddItem('New Item', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                    <span class="text-[10px] font-black uppercase tracking-widest">+ Create Custom</span>
                </button>
                ${rates.map(r => `
                    <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                        <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                        <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;

    mBTME.open('itemSelector', `Add to ${sectionName}`, content, 'max-w-md');
    // Auto-focus logic for better UX
    setTimeout(() => document.querySelector('#itemSelectorModal input')?.focus(), 50);
}

// Logic Resolution: Placeholders for event listeners handled by Tier 6.
function initializeInteractiveInputs() {}

// Logic Resolution: Drag and drop initialization.
function initializeDragAndDrop() {
    document.querySelectorAll('tbody').forEach(el => {
        if(typeof Sortable !== 'undefined') {
            new Sortable(el, { 
                handle: '.drag-handle', 
                animation: 150
            });
        }
    });
}

// Logic Resolution: Stage Drag and Drop initialization.
function initializeStageDragAndDrop() {
    const draggables = document.querySelectorAll('.stage-draggable');
    draggables.forEach(d => {
        d.addEventListener('dragstart', () => d.classList.add('dragging'));
        d.addEventListener('dragend', () => d.classList.remove('dragging'));
    });
}

// Logic Resolution: Updates UI based on connectivity.
function updateOnlineStatus() {
    if(typeof resolveConnectivityStatus === 'function') resolveConnectivityStatus();
}
console.log("TIER 4 render defined", typeof render);



/* ================= TIER 5: MODULE CONTROLLERS & SMART FEATURES ================= */
    /* ========= v19.55 mBTME: MODAL ENGINE (Window orchestration) ========= */
    const mBTME = {
        containerId: 'global-modal-container',
        // --- Registry Resolution: Pointing to Tier 1 Asset Registry ---
        icons: { close: mBTAssets.close },
      
        // --- Portal Generation: Dynamic injection of overlay layers ---
        open: function(id, title, contentHtml, maxWidth = 'max-w-2xl', options = {}) {
            const container = document.getElementById(this.containerId);
            if (!container) return;
            
            // Logic Resolution: Prevent background scrolling while modal is active
            document.body.style.overflow = 'hidden';

            const modalId = `${id}Modal`;
            this.close(modalId, true);
            // UPDATED HEADER: Uses grid to perfectly center the title while keeping the close button right-aligned
            const headerHtml = options.hideHeader ? '' : `
                <div class="p-4 border-b border-slate-100 bg-white rounded-t-2xl relative grid grid-cols-[1fr_auto_1fr] items-center shrink-0">
                    <div></div> <h2 class="text-xs font-black uppercase tracking-widest text-slate-800 text-center">${title}</h2>
                    <div class="text-right">
                        <button onclick="mBTME.close('${modalId}')" class="text-slate-400 hover:text-red-500 transition-all p-1 rounded-md hover:bg-slate-50">${this.icons.close}</button>
                    </div>
                </div>`;
            const fullHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[999] transition-opacity duration-300 opacity-0 hidden" tabindex="-1">
                    <div id="${modalId}Content" class="bg-white rounded-2xl shadow-2xl w-full ${maxWidth} mx-auto max-h-[95vh] flex flex-col transition-all duration-300 transform scale-95 border border-white/20 overflow-hidden">
                        ${headerHtml}
                        <div class="flex-grow overflow-hidden ${options.noPadding ? 'p-0' : 'p-0'}" id="${modalId}Body">${contentHtml}</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', fullHtml);
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.remove('scale-95');
            }, 10);
          
            modal.addEventListener('click', (e) => { if (e.target === modal) this.close(modalId); });
            if (options.onOpen && typeof options.onOpen === 'function') setTimeout(options.onOpen, 50);
            return modal;
        },
        // --- Portal Dissolution: Synchronized removal of UI layers ---
        close: function(modalId, instant = false) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Logic Resolution: Release body scroll if no other modals are open
            if(document.querySelectorAll('[id$="Modal"]').length <= 1) document.body.style.overflow = '';

            if (instant) { modal.remove(); } else {
                modal.classList.add('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
                // --- Handshake: Reconcile logic on environment exit ---
                setTimeout(() => { modal.remove(); if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); }, 300);
            }
        },
        // --- Search Integration: Filtering logic for modal lists ---
        attachSearch: function(inputId, listContainerId, dataItems, renderRowFn) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listContainerId);
            if (!input || !list) return;
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = dataItems.filter(item => (item.description || item.name || item.label || '').toLowerCase().includes(term));
                list.innerHTML = filtered.length > 0 ? filtered.map(renderRowFn).join('') : `<div class="p-12 text-center text-slate-300 text-[10px] font-black uppercase tracking-widest">No Matches</div>`;
            });
        }
    };
    /* ========= v19.54 mBTPublisher: DOCUMENT ENGINE ========= */
    const mBTPublisher = {
        defaultPdfOptions: { margin: 0.3, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } },
      
        // --- Structural Blueprints: HTML fragments for document construction ---
        fragments: {
            header: (meta) => `<div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; font-family: Arial, sans-serif;"><div style="width: 65%;"><h1 style="margin:0; font-size: 24px; text-transform: uppercase; font-weight: 900;">${meta.productionTitle || 'PROJECT'}</h1><div style="font-size: 12px; font-weight: bold;">${meta.productionCompany || ''}</div></div><div style="width: 30%; text-align: right; font-size: 11px;"><div><strong>DATE:</strong> ${meta.shootDate || 'TBD'}</div><div style="background: #000; color: #fff; padding: 4px 8px; display: inline-block; margin-top: 5px; font-size: 12px;"><strong>CALL:</strong> ${meta.crewCallTime || '00:00'}</div></div></div>`,
            table: (title, headers, rows) => `<div style="margin-bottom: 15px; font-family: Arial, sans-serif; page-break-inside: avoid;"><div style="background: #333; color: white; padding: 4px 8px; font-size: 10px; font-weight: 900; text-transform: uppercase;">${title}</div><table style="width: 100%; border-collapse: collapse; font-size: 10px; border: 1px solid black;"><thead><tr style="background: #eee; border-bottom: 1px solid black;">${headers.map(h => `<th style="text-align: left; padding: 6px; border-right: 1px solid #ccc;">${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row => `<tr style="border-bottom: 1px solid #eee;">${Object.values(row).filter(v => typeof v !== 'object').map(val => `<td style="padding: 4px 6px; border-right: 1px solid #eee;">${val || ''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`,
            note: (title, content) => `<div style="border: 1px solid black; margin-bottom: 15px; font-family: Arial, sans-serif; page-break-inside: avoid;"><div style="background: #eee; padding: 4px 8px; font-size: 10px; font-weight: 900; border-bottom: 1px solid black; text-transform: uppercase;">${title}</div><div style="padding: 8px; font-size: 11px; white-space: pre-wrap;">${content || 'N/A'}</div></div>`
        },
        // --- Template UI: Rendering of interactive form fields ---
        renderEditor: function(doc) {
            if (!doc?.content?.data) return '<div class="p-8 text-center text-slate-400 font-bold uppercase text-xs tracking-widest">Initialization Resolution Required</div>';
            const data = doc.content.data;
            const docId = doc.id;
            const common = "w-full p-2.5 border border-slate-200 rounded-xl text-xs font-bold bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-50 transition-all outline-none";
          
            const renderInput = (sec, key, spec) => `<div class="mb-4"><label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">${spec.label}</label>${spec.type === 'textarea' ? `<textarea class="${common}" rows="3" onchange="updateMtempField('${docId}', '${sec}', '${key}', this.value)">${data[sec]?.[key] || ''}</textarea>` : `<input type="${spec.type}" value="${data[sec]?.[key] || ''}" class="${common}" onchange="updateMtempField('${docId}', '${sec}', '${key}', this.value)">`}</div>`;
          
            const renderTable = (key, spec) => {
                const rows = data.tables?.[key] || spec.rows || [];
                let tbl = `<div class="mb-6 overflow-hidden border border-slate-100 rounded-2xl shadow-sm"><div class="bg-slate-50 p-3 border-b border-slate-100 flex justify-between items-center"><h4 class="font-black text-[10px] text-slate-500 uppercase tracking-widest">${spec.label}</h4></div><table class="w-full text-[11px]"><thead><tr class="bg-white text-slate-400 font-black uppercase tracking-tighter">${spec.columns.map(c => `<th class="p-2 text-left">${c}</th>`).join('')}<th class="w-8"></th></tr></thead><tbody>`;
                rows.forEach((r, rIdx) => {
                    tbl += `<tr class="group border-t border-slate-50">${r.map((c, cIdx) => `<td class="p-0"><input value="${RenderEngine.esc(c)}" class="w-full p-2 bg-transparent border-none outline-none focus:bg-blue-50/50 transition-all" onchange="updateMtempTable('${docId}', '${key}', ${rIdx}, ${cIdx}, this.value)"></td>`).join('')}<td class="p-1 text-center"><button class="text-slate-200 hover:text-red-500 font-black text-lg" onclick="removeMtempRow('${docId}', '${key}', ${rIdx})">Ã—</button></td></tr>`;
                });
                return tbl + `</tbody></table><button onclick="addMtempRow('${docId}', '${key}')" class="w-full p-2 bg-slate-50 text-[9px] font-black uppercase text-blue-600 hover:bg-blue-50 transition-all">${mBTAssets.plus} Add Entry</button></div>`;
            };
            let left = "", right = "";
            Object.keys(doc.content.fields || {}).forEach(sec => {
                if (sec !== 'tables') {
                    left += `<div class="bg-white p-5 rounded-2xl border border-slate-100 mb-6 shadow-sm"><h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest border-b border-slate-50 pb-3 mb-4">${sec.replace('_', ' ')}</h3>${Object.keys(doc.content.fields[sec]).map(f => renderInput(sec, f, doc.content.fields[sec][f])).join('')}</div>`;
                }
            });
            if (doc.content.fields?.tables) Object.keys(doc.content.fields.tables).forEach(t => right += renderTable(t, doc.content.fields.tables[t]));
            return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">${left}<div>${right}</div></div>`;
        },
        // --- Data Interpretation: Resolving template tags with live data ---
        interpret: function(doc) {
            const data = doc.content.data || {};
            const regex = /{{([^}]+)}}/g;
            return (doc.content.htmlTemplate || '').replace(regex, (match, p1) => {
                const pts = p1.split('.');
                if (pts[0] === 'table') {
                    const spec = doc.content.fields.tables[pts[1]];
                    const rows = data.tables?.[pts[1]] || spec.rows || [];
                    return `<table><thead><tr>${spec.columns.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                }
                return data[pts[0]]?.[pts[1]] || '';
            });
        },
        // --- Information Synchronization: Automated budget-to-doc mapping ---
        processAutofill: function(doc, budgetData) {
            const fields = doc.content.fields; const data = doc.content.data;
            if (!data.tables) data.tables = {};
            Object.keys(fields).forEach(sec => {
                if (sec === 'tables') return;
                Object.keys(fields[sec]).forEach(f => {
                    const spec = fields[sec][f];
                    if (!data[sec]) data[sec] = {};
                    if (spec.autofill === 'projectName') data[sec][f] = budgetData.projectName || '';
                    else if (spec.autofill?.startsWith('role:')) {
                        const target = spec.autofill.split(':')[1].toLowerCase();
                        for (const s of Object.values(budgetData.sections)) {
                            const m = s.items.find(i => i.description.toLowerCase().includes(target) && i.crew?.name);
                            if (m) { data[sec][f] = `${m.crew.name} ${m.crew.phone ? '| '+m.crew.phone : ''}`; break; }
                        }
                    }
                });
            });
            if (fields.tables?.crew?.autofillSource === 'budget_sections') {
                const rows = [];
                Object.entries(budgetData.sections).forEach(([sec, sObj]) => { sObj.items.forEach(i => { if (i.crew?.name) rows.push([sec, i.description, i.crew.name, "07:00", i.crew.phone || '-']); }); });
                data.tables.crew = rows;
            }
            // --- Brain Handshake: Sync math before finishing autofill ---
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
            return doc;
        },
        // --- Export Protocols: File generation sequences ---
        toXLSX: function(data, sheet, file) {
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), sheet);
            XLSX.writeFile(wb, `${file.replace(/\s+/g, '_')}.xlsx`);
        },
        toMoo: function() {
            const blob = new Blob([JSON.stringify(budget, null, 2)], { type: 'application/json' });
            this.forceDownload(blob, `${(budget.projectName || 'untitled').toLowerCase()}.moo`);
        },
        forceDownload: function(blob, filename) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    };
/* ========= v19.54 mBTDB: STUDIO BUILDER ENGINE ========= */
window.mBTDB = {
    state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1 },
    // --- 1. Registry Resolution: Tier 1 Asset Map ---
    icons: {
        trash: mBTAssets.trash, plus: mBTAssets.plus, user: mBTAssets.user,
        cloud: mBTAssets.cloud, save: mBTAssets.save, undo: mBTAssets.undo,
        redo: mBTAssets.redo, copy: mBTAssets.copy, print: mBTAssets.print,
        close: mBTAssets.close, wand: mBTAssets.wand, grid: mBTAssets.grid,
        list: mBTAssets.list
    },
  
    templates: {
        'default': { label: "Blank Document", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] },
        'callSheet': {
            label: "Daily Call Sheet",
            widgets: [
                { id: 'contacts', x: 0, y: 0, w: 12, h: 4, type: 'contacts', label: "Key Contacts" },
                { id: 'logistics', x: 0, y: 4, w: 12, h: 6, type: 'logistics', label: "Logistics" },
                { id: 'schedule', x: 0, y: 10, w: 12, h: 8, type: 'schedule', label: "Schedule" },
                { id: 'cast', x: 0, y: 18, w: 6, h: 8, type: 'cast', label: "Cast List" },
                { id: 'crew', x: 6, y: 18, w: 6, h: 8, type: 'crew', label: "Crew List" },
                { id: 'notes', x: 0, y: 26, w: 12, h: 4, type: 'richText', label: "General Notes" }
            ]
        }
    },
    // --- 2. Portal Orchestration ---
    open: function(docId) {
        this.state.currentDocId = docId;
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;
        if (!doc.content) doc.content = { data: {}, widgets: [] };
        if (!doc.content.widgets || doc.content.widgets.length === 0) {
            const tKey = this.templates[doc.type] ? doc.type : 'default';
            doc.content.widgets = JSON.parse(JSON.stringify(this.templates[tKey].widgets));
            if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
        }
        if(typeof mBTME !== 'undefined') {
            mBTME.open('documentViewerModal', 'Document Studio', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
            this.renderFrame();
        }
    },
    close: function() {
        if (this.state.isEditing) {
            this._saveLayoutState();
            this.state.isEditing = false;
        }
        if (typeof mBTME !== 'undefined') mBTME.close('documentViewerModal');
        document.body.classList.remove('print-mode');
        this.state.currentDocId = null;
        if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if (typeof render === 'function') render();
    },
    toggleEditMode: function() {
        if (this.state.isEditing && this.state.grid) this._saveLayoutState();
        this.state.isEditing = !this.state.isEditing;
        const container = document.getElementById('mBTDB_Workspace');
        const grid = this.state.grid;
        if (container && grid) {
            if (this.state.isEditing) {
                container.classList.add('editing-mode');
                grid.setStatic(false);
                grid.enable();
            } else {
                container.classList.remove('editing-mode');
                grid.setStatic(true);
                grid.disable();
            }
            this._updateHeaderButtons();
        }
    },
    _saveLayoutState: function() {
        if (!this.state.grid) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        this.state.grid.engine.nodes.forEach(node => {
            const widget = doc.content.widgets.find(w => w.id === node.id);
            if (widget) { widget.x = node.x; widget.y = node.y; widget.w = node.w; widget.h = node.h; }
        });
        this._triggerSave();
    },
    // --- 3. Publishing & Intelligence Hub ---
    previewDoc: function(mode) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        if (!doc || typeof mBTPublisher === 'undefined') return;
        if(mBTME.showLoader) mBTME.showLoader("Generating Professional Preview...");
        mBTPublisher.generateFastPreview(mode, doc.content.data, (jpegURL) => {
            if(mBTME.hideLoader) mBTME.hideLoader();
            mBTME.open('previewModal', `Industry View: ${mode.toUpperCase()}`,
                `<div class="flex flex-col items-center bg-slate-900 h-full p-8 overflow-auto no-scrollbar"><img src="${jpegURL}" id="finalPreviewImage" class="shadow-2xl border border-black max-w-full h-auto mb-24 bg-white rounded-sm"><div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[10001]"><button onclick="mBTPublisher.downloadJPEG('${jpegURL}', '${doc.label}')" class="flex items-center gap-3 bg-blue-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-blue-500 transition-all active:scale-95">Download JPEG</button><button onclick="mBTDB.sendToDistribution('${jpegURL}')" class="flex items-center gap-3 bg-emerald-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-emerald-500 transition-all active:scale-95">Send to Crew</button><button onclick="mBTME.close('previewModal')" class="bg-white text-slate-900 px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-slate-100 transition-all">Close</button></div></div>`, 'w-full h-full');
        });
    },
    sendToDistribution: function(jpegURL) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        this.close();
        if(window.openDocumentShareSelector) openDocumentShareSelector(doc.id);
    },
    autoFillWidget: function(type, docId) {
        if(!confirm(`Auto-fill ${type}? Current items will be preserved.`)) return;
        if(type === 'contacts') {
            const roles = ['director', 'producer', '1st ad'];
            roles.forEach(r => {
                const c = mBTOG.contacts.find(x => x.role && x.role.toLowerCase().includes(r));
                if(c) this.updateData(docId, `contacts.${r === '1st ad' ? 'ad' : r}`, `${c.name} ${c.contact||''}`);
            });
        } else if(type === 'crew') {
            Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                if(i.crew && i.crew.name) this.addRow(docId, 'crew', 'person', { department: i.description, name: i.crew.name, contact: i.crew.phone });
            }));
        }
        this.renderFrame();
    },
    autoFillWeather: async function(docId, index, name) {
        const btn = document.getElementById(`w-btn-${index}`);
        if(btn) btn.innerHTML = `<span class="animate-spin inline-block">...</span>`;
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
            const geo = await geoRes.json();
            if(!geo.results) throw new Error("Location not found");
            const { latitude, longitude } = geo.results[0];
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const wData = await wRes.json();
            const today = wData.daily;
            const code = today.weather_code[0];
            let summary = "Clear Skies"; if(code > 3) summary = "Cloudy"; if(code > 50) summary = "Rainy";
            const str = `${summary} | Max: ${today.temperature_2m_max[0]}Â°C / Min: ${today.temperature_2m_min[0]}Â°C\nSunrise: ${today.sunrise[0].split('T')[1]} / Sunset: ${today.sunset[0].split('T')[1]}`;
            this.updateRow(docId, 'locations', index, 'weather', str);
            this.renderFrame();
        } catch(e) { alert("Weather Synchronization Failure"); if(btn) btn.innerHTML = this.icons.cloud; }
    },
    // --- 4. Render Engine Handshake ---
    renderFrame: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const container = document.getElementById('mBTDB_Container');
        if(!container) return;
        const toolbarHTML = `<div id="mBTDB_Header" class="bg-slate-900 text-white p-3 flex justify-between items-center sticky top-0 z-50 shadow-xl border-b border-black print:hidden"><div class="flex items-center gap-4"><h2 class="font-black text-xs uppercase tracking-widest text-slate-400 flex items-center gap-2"><span class="text-blue-500">${this.icons.list}</span> Studio: ${RenderEngine.esc(doc.label)}</h2><div class="flex bg-slate-800 rounded-lg overflow-hidden border border-slate-700"><button onclick="mBTDB.syncFromBudget()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 border-r border-slate-700 transition-colors">Sync Budget</button><button onclick="mBTDB.syncFromPrevious()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 transition-colors">Sync Prev</button></div></div><div class="flex gap-2 items-center" id="mBTDB_Buttons"></div></div>`;
        const workspaceHTML = `<div id="mBTDB_Workspace" class="bg-slate-100 min-h-screen p-6 overflow-y-auto no-scrollbar ${this.state.isEditing ? 'editing-mode' : ''}"><div id="mBTDB_MetaArea" class="mb-6 bg-white p-6 shadow-2xl rounded-2xl border border-slate-200 animate-in fade-in duration-500"></div><div class="grid-stack no-scrollbar"></div></div>`;
        container.innerHTML = toolbarHTML + workspaceHTML;
        this._renderMetaHeader(doc);
        setTimeout(() => {
            if(typeof GridStack === 'undefined') return console.error("GridStack resolution failure.");
            this.state.grid = GridStack.init({ column: 12, cellHeight: 65, minRow: 1, margin: 8, animate: true, float: true, staticGrid: !this.state.isEditing }, container.querySelector('.grid-stack'));
            this._loadWidgetsToGrid(doc);
            this._updateHeaderButtons();
            this.state.grid.on('change', () => this._triggerSave());
        }, 50);
    },
    _loadWidgetsToGrid: function(doc) {
        const grid = this.state.grid; grid.removeAll(); grid.batchUpdate();
        doc.content.widgets.forEach(w => { if(w.type === 'header') return; grid.addWidget({ x: w.x, y: w.y, w: w.w, h: w.h, content: this._generateWidgetHTML(w, doc), id: w.id }); });
        grid.commit();
    },
    _generateWidgetHTML: function(widget, doc) {
        const data = doc.content.data; const cleanTitle = widget.label || (widget.type.charAt(0).toUpperCase() + widget.type.slice(1));
        let tools = ''; if(widget.type === 'contacts') tools += `<button onclick="mBTDB.toggleVertical('${widget.id}')" class="p-1.5 hover:bg-slate-100 rounded-md transition-colors">${widget.vertical ? this.icons.grid : this.icons.list}</button>`;
        tools += `<button onclick="mBTDB.autoFillWidget('${widget.type}', '${doc.id}')" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded-md transition-all">${this.icons.wand}</button>`;
        return `<div class="grid-stack-item-content group"><div class="widget-header flex justify-between items-center p-2 bg-white border-b border-slate-50"><input value="${cleanTitle}" onchange="mBTDB.updateWidgetLabel('${doc.id}', '${widget.id}', this.value)" class="bg-transparent border-none font-black text-[10px] uppercase tracking-widest text-slate-500 w-32 outline-none focus:text-blue-600 transition-colors"><div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">${tools}<button onclick="mBTDB.deleteWidget('${widget.id}')" class="p-1.5 hover:text-red-600 transition-colors">${this.icons.trash}</button></div></div><div class="widget-body flex-grow overflow-y-auto no-scrollbar relative text-slate-800 h-full bg-white">${this._getContentForWidget(widget, doc)}</div></div>`;
    },
    _getContentForWidget: function(widget, doc) {
        const data = doc.content.data;
        if (widget.type === 'contacts') return this._renderContacts(doc.id, data, widget);
        if (['logistics', 'locations'].includes(widget.type)) return this._renderLogistics(doc.id, data);
        if (widget.type === 'schedule') return this._renderSchedule(doc.id, data);
        if (widget.type === 'crew') return this._renderCrew(doc.id, data);
        if (widget.type === 'cast') return this._renderTalent(doc.id, data);
        if (widget.type === 'richText') return this._renderRichText(doc.id, widget.id, data);
        return '';
    },
    _renderMetaHeader: function(doc) {
        const d = doc.content.data;
        const html = `<div class="flex flex-wrap gap-4 items-end justify-between px-2"><div class="w-full sm:w-auto flex-grow"><input value="${d.meta.productionTitle || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-3xl font-black uppercase w-full outline-none text-slate-900 bg-transparent mb-1 tracking-tighter" placeholder="PRODUCTION TITLE"><div class="flex gap-4"><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Date</span><input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="mbt-input w-auto font-bold border-none bg-slate-50 px-2 rounded-md"></div><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Call</span><input type="text" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input w-16 bg-yellow-300 font-black border-none text-center rounded-md" placeholder="00:00"></div><div class="flex items-center gap-1.5 bg-slate-100 px-2.5 py-0.5 rounded-md"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Day</span><span class="text-xs font-black text-slate-800">${this.calcShootDay(d.meta.shootDate)}</span></div></div></div><div class="w-48 text-right"><input value="${d.meta.productionCompany || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionCompany', this.value)" class="mbt-input text-right font-bold border-none text-slate-500 italic" placeholder="Production Company"></div></div>`;
        const container = document.getElementById('mBTDB_MetaArea'); if(container) container.innerHTML = html;
    },
    _renderContacts: function(docId, d, widget) {
        const gridClass = widget.vertical ? "grid-cols-1" : "grid-cols-1 sm:grid-cols-3";
        const renderField = (path, val, label, role) => `<div class="relative group"><div class="flex justify-between items-center mb-1"><div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${label}</div><div class="cursor-pointer text-slate-300 hover:text-blue-500 transition-colors" onclick="mBTDB.pullFromOpenGate('${docId}', '${path}', '${role}')">${this.icons.user}</div></div><input value="${val||''}" onchange="mBTDB.updateData('${docId}', '${path}', this.value)" class="mbt-input font-bold border-slate-100 hover:border-slate-300 focus:bg-white transition-all"></div>`;
        return `<div class="grid ${gridClass} gap-4 p-4 h-full overflow-y-auto no-scrollbar">${renderField('contacts.director', d.contacts.director, 'Director', 'director')}${renderField('contacts.producer', d.contacts.producer, 'Producer', 'producer')}${renderField('contacts.ad', d.contacts.ad, '1st AD', 'ad')}</div>`;
    },
    _renderLogistics: function(docId, d) {
        return `<div class="flex flex-col h-full"><div class="px-4 py-2 border-b border-slate-100 bg-slate-50/50 flex gap-2 items-center justify-between"><div class="flex items-center gap-2"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sun Cycles:</span><input value="${d.meta.sunriseSunset||''}" onchange="mBTDB.updateData('${docId}','meta.sunriseSunset',this.value)" class="bg-transparent text-[10px] font-bold w-32 outline-none" placeholder="06:00 / 18:00"></div></div><div class="flex-grow overflow-y-auto p-4 space-y-4 no-scrollbar">${(d.locations||[]).map((l,i) => `<div class="flex flex-wrap gap-4 items-start border-b border-slate-50 pb-4 mb-2"><div class="w-full sm:w-1/3 space-y-2"><input value="${l.name}" onchange="mBTDB.updateRow('${docId}','locations',${i},'name',this.value)" class="mbt-input font-black uppercase text-xs" placeholder="LOCATION NAME"><input type="text" value="${l.timeOnLocation||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'timeOnLocation',this.value)" class="mbt-input text-[10px]" placeholder="Time at Location"></div><div class="w-full sm:w-1/3"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'address',this.value)" class="mbt-input h-20 resize-none text-[10px] leading-relaxed" placeholder="Full Address...">${l.address}</textarea></div><div class="w-full sm:w-1/4 flex-grow"><div class="relative"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'weather',this.value)" class="mbt-input h-20 resize-none text-[10px] bg-blue-50/30 border-blue-100" placeholder="Weather Forecast...">${l.weather}</textarea><button id="w-btn-${i}" onclick="mBTDB.autoFillWeather('${docId}', ${i}, '${l.name}')" class="absolute bottom-2 right-2 bg-white text-blue-600 p-1.5 rounded-lg shadow-sm border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">${this.icons.cloud}</button></div></div></div>`).join('')}<button onclick="mBTDB.addRow('${docId}','locations','loc')" class="w-full py-2 bg-white text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 hover:border-blue-200 rounded-xl border border-dashed border-slate-200 transition-all flex items-center justify-center gap-2">${this.icons.plus} Add Location</button></div></div>`;
    },
    _renderSchedule: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[700px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-tighter"><th class="p-2 w-16 text-center">Time</th><th class="p-2 w-12 text-center">Scn</th><th class="p-2 text-left">Description / Scene Note</th><th class="p-2 w-32 text-left">Cast</th><th class="p-2 w-12 text-center">I/E</th><th class="p-2 w-32 text-left">Location</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${d.schedule.map((row, i) => `<tr class="${row.type==='meal'?'bg-amber-50/50':''}"><td><input value="${row.time}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'time',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black text-slate-900 bg-transparent border-0 outline-none"></td>${row.type==='meal'? `<td colspan="4"><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full text-center font-black uppercase text-amber-700 bg-transparent border-0 outline-none tracking-widest"></td>`: `<td><input value="${row.scene}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'scene',this.value)" class="w-full text-center font-bold bg-transparent border-0 outline-none"></td><td><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full bg-transparent border-0 outline-none font-medium px-2"></td><td><input value="${row.cast}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'cast',this.value)" class="w-full bg-transparent border-0 outline-none italic"></td><td><input value="${row.ie}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'ie',this.value)" class="w-full text-center text-[9px] font-black uppercase bg-transparent border-0 outline-none"></td>`}<td><input value="${row.loc}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'loc',this.value)" class="w-full bg-transparent border-0 outline-none text-slate-500"></td><td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','schedule',${i}, 'schedule')" class="text-slate-200 hover:text-red-500 transition-colors">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="flex gap-2 p-2 bg-slate-50/50 border-t border-slate-100 widget-controls"><button onclick="mBTDB.addRow('${docId}','schedule','shot')" class="flex-1 bg-white border border-slate-200 text-emerald-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Shot</button><button onclick="mBTDB.addRow('${docId}','schedule','meal')" class="flex-1 bg-white border border-slate-200 text-amber-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Meal</button></div></div>`;
    },
    _renderCrew: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Department</th><th class="p-2 text-left">Position</th><th class="p-2 text-left">Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-20 text-center">Call</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.crew||[]).map((c,i) => `<tr class="hover:bg-slate-50/30 transition-colors"><td class="p-1"><input value="${c.department||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'department',this.value)" class="w-full font-black uppercase text-[9px] text-slate-400 bg-transparent border-0 outline-none"></td><td class="p-1"><input value="${c.position||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'position',this.value)" class="w-full font-bold text-slate-700 bg-transparent border-0 outline-none"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'name',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','crew.${i}.name','${c.position||'crew'}')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'contact',this.value)" class="w-full text-[9px] text-slate-500 bg-transparent border-0 outline-none font-mono"></td><td class="p-1"><input type="text" value="${c.callTime||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'callTime',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-transparent border-0 outline-none text-blue-600"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','crew',${i}, 'crew')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','crew','person')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl transition-all hover:text-blue-600">+ Add Crew Member</button></div></div>`;
    },
    _renderTalent: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[500px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Character</th><th class="p-2 text-left">Actor Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-10 text-center">Status</th><th class="p-2 w-16 text-center">PU</th><th class="p-2 w-16 text-center">HMU</th><th class="p-2 w-16 text-center text-blue-600">SET</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.cast||[]).map((c,i) => `<tr><td class="p-1"><input value="${c.character||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'character',this.value)" class="w-full font-bold text-slate-500 bg-transparent border-0 outline-none px-2"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.actor||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'actor',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','cast.${i}.actor','actor')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'contact',this.value)" class="w-full text-[9px] font-mono bg-transparent border-0 outline-none text-slate-400"></td><td class="p-1"><input value="${c.status||'W'}" onchange="mBTDB.updateRow('${docId}','cast',${i},'status',this.value)" class="w-full text-center font-black uppercase bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.pickup||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'pickup',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.hmu||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'hmu',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.setCall||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'setCall',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-yellow-100 rounded border-0 outline-none text-slate-900"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','cast',${i}, 'cast')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','cast','talent')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:text-purple-600 transition-all">+ Add Talent</button></div></div>`;
    },
    _renderRichText: function(docId, widgetId, data) {
        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        return `<div class="h-full flex flex-col p-2"><div class="flex-grow relative"><textarea onchange="mBTDB.updateData('${docId}', 'additional.${widgetId}', this.value)" class="w-full h-full p-2 text-xs text-slate-800 bg-transparent border-0 outline-none resize-none font-medium leading-relaxed" placeholder="Type notes...">${val||''}</textarea></div></div>`;
    },
    // --- 5. Navigation & Logic Controllers ---
    toggleVertical: function(wid) { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === wid); if(w) { w.vertical = !w.vertical; this.renderFrame(); } },
    updateWidgetLabel: function(docId, widgetId, newLabel) { const doc = budget.documents.find(d => d.id === docId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w) { w.label = newLabel; this._triggerSave(); } },
    updateData: function(docId, path, value) { const doc = budget.documents.find(d => d.id === docId); const parts = path.split('.'); let target = doc.content.data; for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; } target[parts[parts.length-1]] = value; this._triggerSave(); },
    updateRow: function(docId, section, index, key, value) { const doc = budget.documents.find(d => d.id === docId); if(doc.content.data[section][index]) { doc.content.data[section][index][key] = value; this._triggerSave(); const type = (section === 'locations') ? 'logistics' : section; const widget = doc.content.widgets.find(w => w.type === type); if(widget) this._autoResizeWidget(widget.id); } },
    addRow: function(docId, section, type, presetData) { const doc = budget.documents.find(d => d.id === docId); if(!doc.content.data[section]) doc.content.data[section] = []; let newRow = presetData || { id: Date.now() }; if(!presetData) { if(section==='schedule') newRow = { ...newRow, type, time:"", scene:"", description: type==='meal'?"LUNCH":"New Shot", cast:"", ie:"", loc:"", note:"" }; else if(section==='cast') newRow = { ...newRow, character:"", actor:"", status:"W", pickup:"", hmu:"", setCall:"", contact:"" }; else if(section==='crew') newRow = { ...newRow, department:"", position:"", name:"", contact:"", callTime:"" }; else if(section==='locations') newRow = { ...newRow, name:"", address:"", weather:"", hospital:"", mapLink:"", timeOnLocation:"" }; } doc.content.data[section].push(newRow); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (section === 'locations' ? 'logistics' : section)); if(widget) this._autoResizeWidget(widget.id); },
    deleteRow: function(docId, section, index, widgetType) { const doc = budget.documents.find(d => d.id === docId); doc.content.data[section].splice(index, 1); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (widgetType || section)); if(widget) this._autoResizeWidget(widget.id); },
    deleteWidget: function(id) { if(!confirm("Delete widget?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const el = document.querySelector(`.grid-stack-item[gs-id="${id}"]`); if(el) this.state.grid.removeWidget(el); doc.content.widgets = doc.content.widgets.filter(w => w.id !== id); this._triggerSave(); },
    addWidget: function() {
        const select = document.getElementById('mBTDB_WidgetSelect');
        if(!select) return;
        const type = select.value;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const w = { id: type+'_'+Date.now(), type, w: 6, h: 4, autoPosition: true, label: type.toUpperCase() };
        const html = this._generateWidgetHTML(w, doc);
        const node = this.state.grid.addWidget({ w: 6, h: 4, content: html, id: w.id, autoPosition: true });
        w.x = node.gridstackNode.x; w.y = node.gridstackNode.y;
        doc.content.widgets.push(w);
        this._triggerSave();
    },
    _autoResizeWidget: function(widgetId) { const el = document.querySelector(`.grid-stack-item[gs-id="${widgetId}"]`); if(!el) return; const body = el.querySelector('.widget-body'); if(!body) return; const currentHeight = body.style.height; body.style.height = 'auto'; const contentHeight = body.scrollHeight + 45; body.style.height = currentHeight; let newH = Math.ceil(contentHeight / 60); if(newH < 3) newH = 3; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w && w.h !== newH) { w.h = newH; this.state.grid.update(el, { h: newH }); this._triggerSave(); } },
    formatTime: function(el) { let val = el.value.replace(/[^0-9]/g, ''); if(val.length === 4) { el.value = val.substring(0,2) + ':' + val.substring(2,4); el.dispatchEvent(new Event('change')); } },
    saveTemplate: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const name = prompt("Template Name:", doc.label + " Preset"); if(!name) return; const tmpl = { id: 'tmpl_' + Date.now(), label: name, widgets: JSON.parse(JSON.stringify(doc.content.widgets)) }; if(!budget.templates) budget.templates = []; budget.templates.push(tmpl); alert(`Template "${name}" saved.`); },
    calcShootDay: function(dateStr) { if(!budget.startDate) return "Day 1"; const start = new Date(budget.startDate); const current = new Date(dateStr); if(isNaN(start) || isNaN(current)) return "Day 1"; const diffDays = Math.ceil((current - start) / (1000 * 60 * 60 * 24)) + 1; return `Day ${diffDays}`; },
    syncFromBudget: function() { if(!confirm("Synchronization with Budget details?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const defaults = this._generateDefaultData(); doc.content.data.crew = defaults.crew; doc.content.data.contacts = defaults.contacts; mBTLE.reconcile(); this.renderFrame(); },
    syncFromPrevious: function() { alert("Environmental cache resolution pending..."); },
    snapshotDoc: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const newDoc = JSON.parse(JSON.stringify(doc)); newDoc.id = 'doc_' + Date.now(); newDoc.label = doc.label + " (Copy)"; budget.documents.push(newDoc); mBTDB.open(newDoc.id); },
    pullFromOpenGate: function(docId, path, roleQuery) { if (typeof mBTOG === 'undefined') return alert("Database Resolution Failure."); const matches = mBTOG.contacts.filter(c => c.role?.toLowerCase().includes(roleQuery.toLowerCase())); if (matches.length === 0) return alert(`No ${roleQuery} found.`); const apply = (c) => { const parts = path.split('.'); if(parts.length === 3 && (parts[0] === 'crew' || parts[0] === 'cast')) { this.updateRow(docId, parts[0], parseInt(parts[1]), parts[2], c.name); if(c.contact) this.updateRow(docId, parts[0], parseInt(parts[1]), 'contact', c.contact); } else { this.updateData(docId, path, `${c.name} ${c.contact ? '('+c.contact+')' : ''}`); } this.renderFrame(); }; if (matches.length === 1) apply(matches[0]); else { const choice = prompt(matches.map((c,i)=>`${i+1}. ${c.name}`).join('\n')); const idx = parseInt(choice)-1; if(matches[idx]) apply(matches[idx]); } },
    printToPDF: function(mode) { if (typeof mBTPublisher === 'undefined') return alert("Publisher Resolution Failure."); const original = document.getElementById('mBTDB_Workspace'); const clone = original.cloneNode(true); clone.id = "mBTDB_Print_Container"; clone.classList.remove('editing-mode'); clone.classList.add('print-container', mode === 'standard' ? 'print-standard' : 'print-graphic'); const originalInputs = original.querySelectorAll('input, textarea'); const cloneInputs = clone.querySelectorAll('input, textarea'); originalInputs.forEach((input, i) => { if(cloneInputs[i]) cloneInputs[i].value = input.value; }); document.body.appendChild(clone); mBTPublisher.exportToPDF('mBTDB_Print_Container', `${budget.projectName}_CallSheet`); setTimeout(() => { document.body.removeChild(clone); }, 2000); },
    // --- 6. Switchboard Integration ---
    _updateHeaderButtons: function() {
        const btnContainer = document.getElementById('mBTDB_Buttons'); if(!btnContainer) return; const isEd = this.state.isEditing;
        const previewMenu = `<div class="relative inline-block"><button onclick="this.nextElementSibling.classList.toggle('hidden');" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 flex items-center gap-2 transition-all outline-none"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>Preview</button><div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl border border-slate-100 z-[9999] overflow-hidden"><button onclick="mBTDB.previewDoc('standard'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest border-b border-slate-50 transition-colors">Standard Layout</button><button onclick="mBTDB.previewDoc('graphic'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest transition-colors">Graphic View</button></div></div>`;
        btnContainer.innerHTML = `<div class="flex gap-1 mr-4 border-r border-slate-700 pr-4"><button onclick="mBTDB.undo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Undo">${this.icons.undo}</button><button onclick="mBTDB.redo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Redo">${this.icons.redo}</button><button onclick="mBTDB.snapshotDoc()" class="p-2 hover:bg-blue-900/50 rounded-lg text-blue-400 transition-colors" title="Clone">${this.icons.copy}</button><button onclick="mBTDB.saveTemplate()" class="p-2 hover:bg-emerald-900/50 rounded-lg text-emerald-400 transition-colors" title="Save Template">${this.icons.save}</button></div>${isEd ? `<div class="flex items-center bg-slate-800 rounded-lg px-2 mr-2"><select id="mBTDB_WidgetSelect" class="bg-transparent text-[9px] font-black uppercase tracking-widest text-white h-8 outline-none cursor-pointer"><option value="richText">Note Block</option><option value="schedule">Schedule</option><option value="cast">Cast List</option><option value="crew">Crew List</option><option value="logistics">Logistics</option><option value="contacts">Contacts</option></select><button onclick="mBTDB.addWidget()" class="text-emerald-400 p-2 hover:scale-110 transition-transform">${this.icons.plus}</button></div>` : ''}<button onclick="mBTDB.toggleEditMode()" class="px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg transition-all ${isEd ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}">${isEd ? 'Save Layout' : 'Modify Layout'}</button>${previewMenu}<button onclick="mBTDB.close()" class="bg-red-900/80 text-red-200 p-2 rounded-lg hover:bg-red-600 hover:text-white transition-all ml-2">${this.icons.close}</button>`;
    },
    _triggerSave: function() {
        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if(typeof saveBudget === 'function') saveBudget();
    },
    _generateDefaultData: function() {
        return { meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" }, contacts: { director: "", producer: "", ad: "" }, schedule: [], crew: [], cast: [], locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}], additional: {} };
    }
};

/* ======= TIER 5: Part 2: Module Controllers & Intelligence ======== */
    /* ========= mBTTrash: RECYCLE BIN ENGINE (State Normalization) ========= */
    // Logic Resolution: Manages the temporary deletion and restoration of production assets.
    window.mBTTrash = {
        state: { activeTab: 'documents' },
        // --- Registry Resolution: Pulling from consolidated Tier 1 assets ---
        trashIcons: {
            folder: mBTAssets.folder,
            file: mBTAssets.file,
            trash: mBTAssets.trash
        },
      
        open: function(tab = 'documents') {
            this.state.activeTab = tab;
            const type = this.state.activeTab;
            const docTrash = budget.documentTrash || [];
            const projectTrash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            const renderDocumentRow = (doc) => `
                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm group">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="text-2xl opacity-60">${mBTAssets.file}</div>
                        <div class="overflow-hidden">
                            <div class="text-[10px] font-black uppercase text-slate-700 truncate">${RenderEngine.esc(doc.label)}</div>
                            <div class="text-[9px] text-slate-400 font-bold">Type: ${doc.type || 'Custom'}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="mBTTrash.restoreDocument('${doc.id}')" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-emerald-200 transition-all">Restore</button>
                        <button onclick="mBTTrash.permanentDeleteDocument('${doc.id}')" class="px-3 py-1.5 bg-rose-100 text-rose-700 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-rose-200 transition-all">Delete</button>
                    </div>
                </div>`;
            const documentsHTML = docTrash.length === 0 ?
                '<div class="h-full flex flex-col items-center justify-center opacity-20">'+this.trashIcons.trash+'<p class="font-black uppercase text-[10px] mt-2">Bin is Empty</p></div>' :
                '<div class="space-y-2">'+docTrash.map(renderDocumentRow).join('')+'</div>';
            const projectsHTML = projectTrash.length === 0 ?
                '<div class="h-full flex flex-col items-center justify-center opacity-20">'+this.trashIcons.folder+'<p class="font-black uppercase text-[10px] mt-2">No Projects</p></div>' :
                '<div class="space-y-2">Project restoration protocol pending...</div>';
            const content = `
                <div class="flex flex-col max-h-[90vh]">
                    <div class="flex border-b bg-gray-50">
                        <button onclick="mBTTrash.open('documents')" class="flex-1 py-3 text-xs font-black uppercase ${type==='documents'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Documents (${docTrash.length})</button>
                        <button onclick="mBTTrash.open('projects')" class="flex-1 py-3 text-xs font-black uppercase ${type==='projects'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Projects (${projectTrash.length})</button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 bg-slate-50 no-scrollbar">
                        ${type === 'documents' ? documentsHTML : projectsHTML}
                    </div>
                </div>`;
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        },
        restoreDocument: function(docId) {
            const idx = budget.documentTrash.findIndex(d => d.id === docId);
            if (idx > -1) {
                const doc = budget.documentTrash.splice(idx, 1)[0];
                if (!budget.documents) budget.documents = [];
                budget.documents.push(doc);
                saveBudget();
                render();
                this.open('documents'); // Refresh view
            }
        },
        permanentDeleteDocument: function(docId) {
            if (!confirm("Permanently delete this document? This cannot be undone.")) return;
            const idx = budget.documentTrash.findIndex(d => d.id === docId);
            if (idx > -1) {
                budget.documentTrash.splice(idx, 1);
                saveBudget();
                this.open('documents'); // Refresh view
            }
        }
    };
    /* --- 1. Interaction Handlers (UI-to-Logic Bridge) --- */
    window.toggleRateType = function(itemId, sectionName) {
        const item = budget.sections[sectionName].items.find(i => i.id === itemId);
        if (!item) return;
        item.rateType = (item.rateType === 'negotiable') ? 'fixed' : 'negotiable';
        if(typeof pushToHistory === 'function') pushToHistory(`Resolution: Synchronized ${item.description} to ${item.rateType}`);
        render();
    };
    function handleUpdate(sectionName, itemId, field, value, description) {
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        if (!item) return;
      
        let val = value;
        if (['rate', 'actual'].includes(field)) {
            const parsed = parseFloat(value) || 0;
            val = (displayCurrency === 'USD') ? convertToBase(parsed, 'USD') : parsed;
        } else if (field === 'quantity' || field === 'multiplier') {
            val = parseFloat(value) || (field === 'multiplier' ? 1 : 0);
        }
      
        if (field === 'unit') {
            if (value === 'Flat' && item.unit !== 'Flat') {
                item._storedQuantity = item.quantity;
                item.quantity = 1;
            } else if (item.unit === 'Flat' && value !== 'Flat') {
                if (item._storedQuantity !== undefined) item.quantity = item._storedQuantity;
            }
        }
        item[field] = val;
        if(typeof pushToHistory === 'function') pushToHistory(description);
      
        if (field === 'unit') render();
        else if (field !== 'description') if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
    }
    /* --- 2. Intelligence Suite (AI Tools & Consultant Interface) --- */
    function showAIToolsModal() {
        const provider = getSelectedProvider();
        const key = getStoredApiKey(provider);
        const isOnline = navigator.onLine;
        const aiContext = budget.aiContext || { saveHistory: true, analysis: "", chat: [] };
      
        const trayHTML = (budget.attachments || []).length > 0 ?
            `<div class="mb-4 p-3 bg-slate-50 rounded-2xl border border-slate-100">
                <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Attached Context</div>
                <div class="flex flex-col gap-1.5 max-h-32 overflow-y-auto no-scrollbar">
                    ${budget.attachments.map(f => `
                        <div class="flex items-center justify-between bg-white p-2 rounded-xl border border-slate-100 shadow-sm group">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="w-7 h-7 flex-shrink-0 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center text-[9px] font-black border border-blue-100 uppercase">${f.name.split('.').pop().toUpperCase()}</div>
                                <span class="text-[11px] text-slate-700 truncate font-black uppercase tracking-tighter">${RenderEngine.esc(f.name)}</span>
                            </div>
                            <button onclick="removeAttachment('${f.id}')" class="text-slate-300 hover:text-red-500 p-1 transition-colors text-lg font-bold">Ã—</button>
                        </div>`).join('')}
                </div>
            </div>` : `<div class="mb-4 p-5 border-2 border-dashed border-slate-100 rounded-2xl text-center text-slate-300 text-[10px] font-black uppercase tracking-widest">No Context Files Linked</div>`;
        const savedChat = aiContext.chat.length > 0 ?
            aiContext.chat.map(msg => `<div class="ai-message ${msg.role === 'user' ? 'user' : 'assistant'}">${msg.content}</div>`).join('') :
            `<div class="text-[10px] font-black uppercase tracking-widest text-slate-300 text-center mt-20 italic">Initialize Consultation Protocol...</div>`;
        const content = !key ?
            `<div class="text-center py-12 flex flex-col items-center">
                <div class="text-slate-200 mb-6 scale-[1.5]">${mBTAssets.money}</div>
                <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-2">Neural Link Required</h3>
                <p class="text-xs text-slate-400 mb-8 max-w-[200px] font-bold uppercase leading-relaxed">Configure your API key in Settings to activate the AI Consultant.</p>
                <button onclick="mBTME.close('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl active:scale-95 transition-all">Link AI Provider</button>
            </div>` :
            `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col">
                    <h4 class="font-black text-slate-800 mb-4 flex items-center gap-3 text-xs uppercase tracking-widest">${mBTAssets.doctor} Budget Doctor</h4>
                    <button id="analyzeBudgetBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl hover:bg-emerald-700 transition-all ${!isOnline ? 'opacity-30 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}>${isOnline ? 'Analyze Production' : 'Analysis Cache Offline'}</button>
                    <div id="aiAnalysisOutput" class="mt-6 text-xs text-slate-600 flex-grow overflow-y-auto no-scrollbar border-t border-slate-200 pt-4 leading-relaxed">${aiContext.analysis || ''}</div>
                </div>
                <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col">
                    <h4 class="font-black text-slate-800 mb-4 flex items-center gap-3 text-xs uppercase tracking-widest">${mBTAssets.chat} Consultant</h4>
                    ${trayHTML}
                    <div id="aiChatHistory" class="flex-grow overflow-y-auto no-scrollbar bg-white rounded-2xl p-4 mb-4 border border-slate-100 shadow-inner">${savedChat}</div>
                    <form id="aiChatForm" class="flex gap-2">
                        <input type="text" id="aiChatInput" placeholder="ASK ANYTHING..." class="flex-grow text-[10px] font-black uppercase tracking-widest p-4 bg-white border-none rounded-2xl shadow-lg outline-none focus:ring-4 focus:ring-blue-50 transition-all" ${!isOnline ? 'disabled' : ''}>
                        <button type="submit" class="bg-blue-600 text-white px-6 rounded-2xl shadow-xl hover:bg-blue-700 transition-all active:scale-90 ${!isOnline ? 'opacity-30' : ''}">${mBTAssets.sparkle}</button>
                    </form>
                </div>
            </div>`;
        mBTME.open('aiTools', 'Intelligence Suite', content, 'max-w-5xl');
        if (key && isOnline) {
            document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
            document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
        }
    }
/* --- 3. Settings Engine: Flicker-Free & Stable-Size Resolution v19.60 --- */
    // Helper: Renders the sub-content for the Database tab
function renderDatabaseSubView(subTab) {
if (subTab === 'contacts') {
    // Calculate merged contacts once for initial render
    const globalContacts = mBTOG.contacts || [];
    const assignedContacts = [];
    Object.values(budget.sections || {}).forEach(sec => {
        sec.items.forEach(item => {
            if (item.crew && item.crew.name) {
                assignedContacts.push({
                    id: 'assigned_' + item.id,
                    name: item.crew.name,
                    role: item.description || 'Crew',
                    phone: item.crew.phone || '',
                    email: item.crew.email || '',
                    assigned: true
                });
            }
        });
    });
    const allContacts = [...globalContacts];
    assignedContacts.forEach(ac => {
        if (!allContacts.some(gc => gc.name.toLowerCase() === ac.name.toLowerCase())) {
            allContacts.push(ac);
        }
    });

    return `
        <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
            <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex flex-col gap-3 shrink-0 z-10">
                <div class="flex justify-center gap-3 flex-wrap">
                    <button onclick="openAddContactModal()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                        ${mBTAssets.plus} Add
                    </button>
                    <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importContactsCSV(this)">
                    <button onclick="document.getElementById('csvImportInput').click()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                        ${mBTAssets.plus} Import CSV
                    </button>
                    <button onclick="mBTAssign.assignFromContacts()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest shadow-sm active:scale-95 transition-all">
                        Auto-Assign
                    </button>
                </div>
                <div class="relative">
                    <input type="text" id="contactsSearchInput" placeholder="SEARCH PERSONNEL..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                </div>
            </div>
            
            <div id="contactsListBody" class="flex-grow overflow-y-auto no-scrollbar relative bg-white">
                ${allContacts.length > 0 ? allContacts.map(c => `
                    <div class="flex items-center justify-between p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-black text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">${c.name ? c.name.charAt(0).toUpperCase() : '?'}</div>
                            <div>
                                <div class="text-[10px] font-black uppercase text-slate-700">${c.name}</div>
                                <div class="text-[9px] font-bold text-slate-400">${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}</div>
                            </div>
                        </div>
                        ${c.assigned ? '' : `<button onclick="deleteGlobalContact('${c.id}')" class="text-slate-300 hover:text-rose-500 transition-colors">${mBTAssets.trash}</button>`}
                    </div>
                `).join('') : `<div class="p-8 text-center text-slate-300 text-[9px] font-black uppercase tracking-widest">No Contacts Found</div>`}
            </div>
        </div>`;
}
    if (subTab === 'lineItems') {
        return `
            <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                <div class="p-3 bg-slate-50 border-b border-slate-100 shrink-0 z-10">
                    <div class="relative">
                        <input type="text" id="dbSearchInput" placeholder="SEARCH GLOBAL RATES..." class="w-full p-2.5 pr-10 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto no-scrollbar relative min-h-0 bg-white">
                    <table class="w-full text-[10px]">
                        <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest sticky top-0 z-10">
                            <tr><th class="p-2 text-left bg-slate-50 shadow-sm">Role</th><th class="p-2 text-right bg-slate-50 shadow-sm">Base Rate</th></tr>
                        </thead>
                        <tbody id="dbListBody" class="divide-y divide-slate-50 bg-white">
                            ${mBTOG.rates.map(r => `<tr><td class="p-2 font-bold text-slate-700">${r.description}</td><td class="p-2 text-right font-mono text-slate-500">${mBTLE.format.currency(r.rate)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
    }
    if (subTab === 'templates') {
        const templates = Array.isArray(mBTOG.templates) ? mBTOG.templates : [];
        return `
            <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                <div class="p-3 bg-indigo-50 border-b border-indigo-100 shrink-0 z-10">
                     <div class="relative">
                        <input type="text" id="templateSearchInput" placeholder="SEARCH TEMPLATES..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                    </div>
                </div>
                <div id="templatesListBody" class="flex-grow overflow-y-auto no-scrollbar p-4 space-y-3 bg-white">
                    ${templates.length > 0 ? templates.map(t => `
                        <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-blue-200 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl">${t.icon || 'ðŸ“„'}</div>
                                <div>
                                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">${t.label}</h4>
                                    <p class="text-[9px] text-slate-400 font-bold mt-1">${t.cat || 'General'}</p>
                                </div>
                            </div>
                            <button onclick="createNewDocumentFromTemplate('${t.id}')" class="px-3 py-1.5 bg-slate-50 text-[9px] font-black uppercase tracking-widest text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                                Use
                            </button>
                        </div>
                    `).join('') : '<div class="p-8 text-center text-slate-300 text-[9px] font-black uppercase tracking-widest">No Templates Available</div>'}
                </div>
            </div>`;
    }
    return '';
}
  
function getSettingsTabContent(tabName, subTab = 'lineItems') {
    // --- Tab: General ---
    if (tabName === 'general') {
        const currentDateFormat = getProjectDateFormat();
        const currentSeparator = getProjectNameSeparator();
        const isCompact = budget.settings?.compactMode || false;
        const syncAoD = budget.settings?.syncAoD || false;
      
        window.hardResetApp = function() {
            if(confirm('Clear cache to fix display bugs? Data is SAFE.')) {
                if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(reg => reg.unregister()));
                caches.keys().then(n => n.forEach(name => caches.delete(name)));
                setTimeout(() => window.location.reload(true), 500);
            }
        };
        // Update: Added h-full and overflow-y-auto wrapper
        return `
            <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center gap-3">
                    <div class="w-16 h-16 rounded-2xl shadow-lg border-2 border-slate-50 overflow-hidden bg-[#fdba35]">${mBTAssets.appLogo}</div>
                    <div>
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-800">MooBudget Studio</h3>
                        <p class="text-[9px] text-slate-400 font-bold mt-1">Build v${APP_VERSION} â€¢ ${navigator.onLine ? '<span class="text-emerald-500">Online</span>' : '<span class="text-rose-500">Offline</span>'}</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Date Format</label>
                            <select id="dateFormatSelect" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold outline-none cursor-pointer">
                                <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD</option>
                                <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Separator</label>
                            <input type="text" id="separatorInput" maxlength="1" value="${currentSeparator}" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold text-center outline-none">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Compact View</h4>
                                <p class="text-[9px] text-slate-400 font-bold mt-0.5">Denser layout for small screens</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="compactModeToggle" ${isCompact ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.compactMode = this.checked; saveBudget(); render();" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Connect to AoD Database</h4>
                                <p class="text-[9px] text-slate-400 font-bold mt-0.5">Pull crew by location, availability and role</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="aodSyncToggle" ${syncAoD ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.syncAoD = this.checked; saveBudget();" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                     <a href="https://raw.githubusercontent.com/jaysonmy/moobudget/refs/heads/main/index.html" target="_blank" download="moobudget-beta.html" class="flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-200 transition-colors">${mBTAssets.cloud} Get Beta</a>
                     <button onclick="hardResetApp()" class="flex items-center justify-center gap-2 px-4 py-3 bg-rose-50 text-rose-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-rose-100 transition-colors">${mBTAssets.zap} Fix Bugs</button>
                </div>
                <div class="flex justify-center">
                     <button onclick="mBTME.close('settingsModal'); showCoffeeWidget();" class="flex items-center gap-2 px-8 py-4 bg-[#FFDD00] text-black rounded-xl font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-transform shadow-lg">${mBTAssets.coffee} Support Development</button>
                </div>
            </div>`;
    }
    // --- Tab: AI Configuration ---
    if (tabName === 'ai') {
        const provider = getSelectedProvider();
        const saveHistory = budget.aiContext?.saveHistory ?? true;
        // Update: Added h-full and overflow-y-auto wrapper
        return `
            <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                <div class="p-5 bg-slate-900 rounded-2xl border border-black shadow-lg text-white">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Neural Link</h3>
                            <p class="text-[9px] text-slate-500 font-bold mt-0.5">Configure Provider Access</p>
                        </div>
                        <div class="text-slate-700">${mBTAssets.sparkle}</div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">Active Provider</label>
                            <select id="aiProviderSelect" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-bold outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                                <option value="gemini" ${provider === 'gemini' ? 'selected' : ''}>Google Gemini 1.5</option>
                                <option value="openai" ${provider === 'openai' ? 'selected' : ''}>OpenAI GPT-4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">API Credentials</label>
                            <input type="password" id="apiKeyInput" value="${getStoredApiKey(provider)}" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-mono outline-none focus:ring-1 focus:ring-blue-500" placeholder="sk-...">
                        </div>
                        <div class="flex items-center gap-3 py-1">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="aiContextToggle" ${saveHistory ? 'checked' : ''} onchange="if(!budget.aiContext) budget.aiContext={chat:[], analysis:''}; budget.aiContext.saveHistory = this.checked; saveBudget();" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </div>
                            <label for="aiContextToggle" class="text-[9px] font-bold text-slate-400 uppercase tracking-wide cursor-pointer select-none">Save Conversation Context</label>
                        </div>
                        <button id="saveApiKeyBtn" onclick="const p=document.getElementById('aiProviderSelect').value; const k=document.getElementById('apiKeyInput').value; saveStoredApiKey(p,k); localStorage.setItem('${storageKeyPrefix}selectedAiProvider', p); alert('Neural Link Established');" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-[9px] shadow-lg hover:bg-blue-500 transition-all mt-2">Synchronize Link</button>
                    </div>
                </div>
            </div>`;
    }
    // --- Tab: Database (with sub-tabs) ---
    if (tabName === 'database') {
        const nav = `
            <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-100 shadow-sm shrink-0">
                <button onclick="showSettingsModal('database', 'lineItems')" class="flex-1 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all ${subTab==='lineItems'?'bg-slate-100 text-slate-800':'text-slate-400 hover:text-slate-600'}">Line Items</button>
                <button onclick="showSettingsModal('database', 'contacts')" class="flex-1 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all ${subTab==='contacts'?'bg-slate-100 text-slate-800':'text-slate-400 hover:text-slate-600'}">Contacts</button>
                <button onclick="showSettingsModal('database', 'templates')" class="flex-1 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all ${subTab==='templates'?'bg-slate-100 text-slate-800':'text-slate-400 hover:text-slate-600'}">Templates</button>
            </div>`;
        // Update: Changed to flex col container without parent scroll
        return `<div class="flex flex-col h-full p-6 pb-0 overflow-hidden space-y-4">
            ${nav}
            <div class="flex-grow flex flex-col relative overflow-hidden min-h-0">
                ${renderDatabaseSubView(subTab)}
            </div>
        </div>`;
    }
    return `<div class="p-8 text-center text-slate-300 font-bold uppercase tracking-widest">Logic Stream Not Found</div>`;
}

window.openAddContactModal = function() {
    const dummyItem = { id: 'dummy_new_contact', crew: { name: '', phone: '', email: '' } };
    const dummySection = 'general'; // arbitrary section name, not used in add flow
    openCrewProfile(null, null, dummyItem.id, dummySection);
};

window.addGlobalContact = function(e) {
    if(e) e.preventDefault();
    const nameInput = document.getElementById('newCNameModal') || document.getElementById('newCName');
    const roleInput = document.getElementById('newCRoleModal') || document.getElementById('newCRole');
    const name = nameInput.value.trim();
    const role = roleInput.value.trim();
 
    if (!name || !role) return alert("Name and Role are required.");
 
    const exists = mBTOG.contacts.some(c => c.name.toLowerCase() === name.toLowerCase() && c.role.toLowerCase() === role.toLowerCase());
    if(exists) return alert("Contact already exists in database.");
 
    const newContact = {
        id: 'c_' + Date.now(),
        name,
        role,
        contact: ''
    };
 
    mBTOG.contacts.push(newContact);
    localStorage.setItem('moo_contacts', JSON.stringify(mBTOG.contacts));
 
    showSettingsModal('database', 'contacts');
 
    nameInput.value = '';
    roleInput.value = '';
};

window.showSettingsModal = function(tab = 'general', subTab = 'lineItems') {
    const domId = 'settingsModal';
    const contentHTML = getSettingsTabContent(tab, subTab);
    const tabs = [
        { id: 'general', label: 'General', icon: mBTAssets.gear },
        { id: 'database', label: 'Database', icon: mBTAssets.list },
        { id: 'ai', label: 'AI', icon: mBTAssets.sparkle }
    ];
    const tabNavHTML = tabs.map(t =>
        `<button onclick="showSettingsModal('${t.id}', '${t.id === 'database' ? 'lineItems' : ''}')" class="flex-1 flex items-center justify-center gap-2 h-9 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all ${tab === t.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-600'}">
            <span class="scale-75">${t.icon}</span> <span>${t.label}</span>
        </button>`
    ).join('');
    const existingModal = document.getElementById(domId);
    if (existingModal) {
        const contentArea = document.getElementById('settingsContentArea');
        const navArea = document.getElementById('settingsTabNav');
        if (contentArea) contentArea.innerHTML = contentHTML;
        if (navArea) navArea.innerHTML = tabNavHTML;

        // Attach listeners for Line Items search
        if (tab === 'database' && subTab === 'lineItems') {
            mBTME.attachSearch('dbSearchInput', 'dbListBody', mBTOG.rates, (r) => `<tr><td class="p-2 font-bold text-slate-700 border-b border-slate-50">${r.description}</td><td class="p-2 text-right font-mono text-slate-500 border-b border-slate-50">${mBTLE.format.currency(r.rate)}</td></tr>`);
        }

        // Attach listeners for Contacts search
        if (tab === 'database' && subTab === 'contacts') {
            const globalContacts = mBTOG.contacts || [];
            const assignedContacts = [];
            Object.values(budget.sections || {}).forEach(sec => {
                sec.items.forEach(item => {
                    if (item.crew && item.crew.name) {
                        assignedContacts.push({
                            id: 'assigned_' + item.id,
                            name: item.crew.name,
                            role: item.description || 'Crew',
                            phone: item.crew.phone || '',
                            email: item.crew.email || '',
                            assigned: true
                        });
                    }
                });
            });
            const allContacts = [...globalContacts];
            assignedContacts.forEach(ac => {
                if (!allContacts.some(gc => gc.name.toLowerCase() === ac.name.toLowerCase())) {
                    allContacts.push(ac);
                }
            });
            mBTME.attachSearch('contactsSearchInput', 'contactsListBody', allContacts, (c) => `
                <div class="flex items-center justify-between p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-black text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">${c.name ? c.name.charAt(0).toUpperCase() : '?'}</div>
                        <div>
                            <div class="text-[10px] font-black uppercase text-slate-700">${c.name}</div>
                            <div class="text-[9px] font-bold text-slate-400">${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}</div>
                        </div>
                    </div>
                    ${c.assigned ? '' : `<button onclick="deleteGlobalContact('${c.id}')" class="text-slate-300 hover:text-rose-500 transition-colors">${mBTAssets.trash}</button>`}
                </div>`);
        }

        // Attach listeners for Template search
        if (tab === 'database' && subTab === 'templates') {
            const templates = mBTOG.templates || [];
            mBTME.attachSearch('templateSearchInput', 'templatesListBody', templates, (t) => `
                <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-blue-200 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="text-2xl">${t.icon || 'ðŸ“„'}</div>
                        <div>
                            <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">${t.label}</h4>
                            <p class="text-[9px] text-slate-400 font-bold mt-1">${t.cat || 'General'}</p>
                        </div>
                    </div>
                    <button onclick="createNewDocumentFromTemplate('${t.id}')" class="px-3 py-1.5 bg-slate-50 text-[9px] font-black uppercase tracking-widest text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                        Use
                    </button>
                </div>`);
        }
        return;
    }

    // Update: Removed 'overflow-y-auto' and 'p-6' to let children handle it
    const fullContent = `
        <div class="flex flex-col min-h-[600px] max-h-[90vh] bg-slate-50/50">
            <div id="settingsTabNav" class="flex gap-2 p-3 border-b border-slate-100 bg-white shrink-0">
                ${tabNavHTML}
            </div>
            <div id="settingsContentArea" class="flex-grow flex flex-col relative overflow-hidden">
                ${contentHTML}
            </div>
        </div>`;
    mBTME.open('settings', 'Settings', fullContent, 'max-w-2xl', { noPadding: true });

    // Initial attachment on open (duplicated logic for first render)
    if (tab === 'database' && subTab === 'lineItems') {
        mBTME.attachSearch('dbSearchInput', 'dbListBody', mBTOG.rates, (r) => `<tr><td class="p-2 font-bold text-slate-700 border-b border-slate-50">${r.description}</td><td class="p-2 text-right font-mono text-slate-500 border-b border-slate-50">${mBTLE.format.currency(r.rate)}</td></tr>`);
    }

    if (tab === 'database' && subTab === 'contacts') {
        const globalContacts = mBTOG.contacts || [];
        const assignedContacts = [];
        Object.values(budget.sections || {}).forEach(sec => {
            sec.items.forEach(item => {
                if (item.crew && item.crew.name) {
                    assignedContacts.push({ id: 'assigned_' + item.id, name: item.crew.name, role: item.description || 'Crew', phone: item.crew.phone || '', email: item.crew.email || '', assigned: true });
                }
            });
        });
        const allContacts = [...globalContacts];
        assignedContacts.forEach(ac => {
            if (!allContacts.some(gc => gc.name.toLowerCase() === ac.name.toLowerCase())) {
                allContacts.push(ac);
            }
        });
        mBTME.attachSearch('contactsSearchInput', 'contactsListBody', allContacts, (c) => `
            <div class="flex items-center justify-between p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-black text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">${c.name ? c.name.charAt(0).toUpperCase() : '?'}</div>
                    <div>
                        <div class="text-[10px] font-black uppercase text-slate-700">${c.name}</div>
                        <div class="text-[9px] font-bold text-slate-400">${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}</div>
                    </div>
                </div>
                ${c.assigned ? '' : `<button onclick="deleteGlobalContact('${c.id}')" class="text-slate-300 hover:text-rose-500 transition-colors">${mBTAssets.trash}</button>`}
            </div>`);
    }

    if (tab === 'database' && subTab === 'templates') {
        const templates = mBTOG.templates || [];
        mBTME.attachSearch('templateSearchInput', 'templatesListBody', templates, (t) => `
            <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-blue-200 transition-all">
                <div class="flex items-center gap-4">
                    <div class="text-2xl">${t.icon || 'ðŸ“„'}</div>
                    <div>
                        <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">${t.label}</h4>
                        <p class="text-[9px] text-slate-400 font-bold mt-1">${t.cat || 'General'}</p>
                    </div>
                </div>
                <button onclick="createNewDocumentFromTemplate('${t.id}')" class="px-3 py-1.5 bg-slate-50 text-[9px] font-black uppercase tracking-widest text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                    Use
                </button>
            </div>`);
    }
};

/* ======= Studio Orchestration & Switchboard ======== */
    /* --- 1. Personnel Hub Intelligence (Interaction behavior) --- */
    // Logic Resolution: Manages the floating contact cards and profile resolution.
    window.toggleCrewPopup = function(el, event) {
        if(event) event.stopPropagation();
        const wrapper = el.parentElement;
        document.querySelectorAll('.crew-wrapper').forEach(div => { if (div !== wrapper) div.classList.remove('mobile-active'); });
        wrapper.classList.toggle('mobile-active');
    };
window.openCrewProfile = function(el, event, itemId, sectionName) {
    if(event) event.stopPropagation();

    // Safe fallback for dummy add from Settings
    let section = { items: [] };
    let item = null;
    if (itemId && sectionName && budget.sections && budget.sections[sectionName]) {
        section = budget.sections[sectionName];
        item = section.items.find(i => i.id === itemId);
    }
    // If no valid item found (dummy case), create temporary item
    if (!item) {
        item = { id: itemId || 'temp', crew: { name: '', phone: '', email: '' }, description: 'New Contact' };
    }
    const crew = item.crew || { name: '', phone: '', email: '' };

    // Actions logic
    const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
    const hasPhone = cleanPhone.length > 6;
    const hasEmail = crew.email && crew.email.includes('@');

    const actionsBar = `
        <div class="flex justify-center gap-3 mb-6 mt-2">
            ${hasPhone ? `
                <a href="tel:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 border border-green-200 flex items-center justify-center shadow-sm group-hover:bg-green-600 group-hover:text-white transition-colors">${mBTAssets.phone}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Call</span>
                </a>
                <a href="https://wa.me/${cleanPhone}" target="_blank" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200 flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors">${mBTAssets.wa}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">WA</span>
                </a>` : ''}
            ${hasEmail ? `
                <a href="mailto:${crew.email}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors">${mBTAssets.mail}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Email</span>
                </a>` : ''}
        </div>`;

    const content = `
        <form id="crewProfileForm" class="space-y-6">
            <div class="text-center relative">
                <div class="w-24 h-24 mx-auto rounded-[32px] bg-slate-900 flex items-center justify-center text-white font-black text-4xl shadow-2xl border-4 border-white rotate-3">
                    ${crew.name ? RenderEngine.esc(crew.name.substring(0,1).toUpperCase()) : '?'}
                </div>
                <h3 class="text-xl font-black text-slate-900 mt-4 uppercase tracking-tighter">${RenderEngine.esc(crew.name || 'Unknown')}</h3>
                <p class="text-[10px] text-blue-600 font-black uppercase tracking-widest bg-blue-50 inline-block px-3 py-1 rounded-full mt-1">${RenderEngine.esc(item.description || 'New Contact')}</p>
            </div>
            ${actionsBar}
            <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Profile</h4>
                    <button type="button" id="importContactBtn" class="text-[10px] font-black uppercase tracking-widest text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-2">${mBTAssets.plus} Import</button>
                </div>
                <div class="space-y-3">
                    <input type="text" id="crewName" value="${RenderEngine.esc(crew.name || '')}" placeholder="FULL NAME" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-black uppercase tracking-tighter outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="crewPhone" value="${RenderEngine.esc(crew.phone || '')}" placeholder="PHONE" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                        <input type="email" id="crewEmail" value="${RenderEngine.esc(crew.email || '')}" placeholder="EMAIL" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    </div>
                </div>
            </div>
            <div class="pt-4 flex justify-between items-center gap-4">
                <button type="button" class="text-rose-500 text-[10px] font-black uppercase tracking-widest hover:bg-rose-50 px-4 py-3 rounded-2xl transition-all" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Remove</button>
                <button type="submit" class="flex-grow py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95">Save</button>
            </div>
        </form>`;

    mBTME.open('crewProfile', '', content, 'max-w-sm', { hideHeader: true });

    setTimeout(() => {
        const importBtn = document.getElementById('importContactBtn');
        if(importBtn) {
            importBtn.addEventListener('click', async () => {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    try {
                        const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                        if (contacts.length) {
                            const c = contacts[0];
                            if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                            if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                            if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                        }
                    } catch (ex) { console.log('Import failed/cancelled', ex); }
                } else {
                    alert("Contact import not supported on this browser.");
                }
            });
        }

        const form = document.getElementById('crewProfileForm');
        if(form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('crewName').value.trim();
                const phone = document.getElementById('crewPhone').value.trim();
                const email = document.getElementById('crewEmail').value.trim();

                if (itemId && itemId.startsWith('dummy_new_contact')) {
                    // Global add from Settings
                    if (!name) return alert("Name is required.");
                    const exists = mBTOG.contacts.some(c => c.name.toLowerCase() === name.toLowerCase());
                    if (exists) return alert("Contact already exists in database.");

                    const newContact = {
                        id: 'c_' + Date.now(),
                        name,
                        role: 'Crew',
                        phone,
                        email
                    };
                    mBTOG.contacts.push(newContact);
                    localStorage.setItem('moo_contacts', JSON.stringify(mBTOG.contacts));
                    mBTME.close('crewProfileModal');
                    showSettingsModal('database', 'contacts');
                } else {
                    // Normal project assignment
                    item.crew = { name, phone, email };
                    mBTME.close('crewProfileModal');
                    render();
                    if(document.getElementById('stagesViewModal')) showStagesModal();
                }
            });
        }
    }, 50);
};
    window.clearCrewAssignment = function(itemId, sectionName) {
        if(confirm('Remove assignment?')) {
            const item = budget.sections[sectionName].items.find(i => i.id === itemId);
            if(item) {
                delete item.crew;
                mBTME.close('crewProfileModal');
                render();
            }
        }
    };
    /* --- 2. Studio Builder Logic Expansion --- */
    // Logic Resolution: High-speed bi-directional data flow for the Studio environment.
    window.mBTDB = {
        ...window.mBTDB, // Preserve parts 1 & 2
        updateData: function(docId, path, value) {
            const doc = budget.documents.find(d => d.id === docId);
            const parts = path.split('.');
            let target = doc.content.data;
            for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; }
            target[parts[parts.length-1]] = value;
            this._triggerSave();
        },
        updateRow: function(docId, section, index, key, value) {
            const doc = budget.documents.find(d => d.id === docId);
            if(doc.content.data[section][index]) {
                doc.content.data[section][index][key] = value;
                this._triggerSave();
            }
        },
        addRow: function(docId, section, type, presetData) {
            const doc = budget.documents.find(d => d.id === docId);
            if(!doc.content.data[section]) doc.content.data[section] = [];
            let newRow = presetData || { id: Date.now() };
            doc.content.data[section].push(newRow);
            this._triggerSave();
            this.renderFrame();
        },
        deleteRow: function(docId, section, index) {
            const doc = budget.documents.find(d => d.id === docId);
            doc.content.data[section].splice(index, 1);
            this._triggerSave();
            this.renderFrame();
        },
        _triggerSave: function() { if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); },
        _generateDefaultData: function() {
            return {
                meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" },
                contacts: { director: "", producer: "", ad: "" },
                schedule: [], crew: [], cast: [],
                locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}],
                additional: {}
            };
        }
    };
    /* --- 3. Stage & Analytics Interface (Orchestration) --- */
    // Logic Resolution: Renders the Production Stages and provides neural analysis of cost drivers.
    function showStagesModal() {
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });
       
        const content = `<div class="p-8 text-center text-slate-300 font-black uppercase tracking-widest animate-pulse">Synchronizing Production Ratios...</div>`;
        mBTME.open('stagesView', 'Production Ratios', content, 'max-w-6xl w-full', { noPadding: true, hideHeader: true, onOpen: () => {
            if(typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
        }});
    }
    window.openAnalyticsHub = function() {
        let allItems = []; let total = 0;
        Object.entries(budget.sections).forEach(([secName, section]) => {
            section.items.forEach(item => {
                const cost = item.quantity * item.rate;
                if (cost > 0) { total += cost; allItems.push({ name: item.description, total: cost }); }
            });
        });
        const content = `<div class="p-12 text-center text-slate-300 font-black uppercase tracking-widest">${mBTAssets.money} Neural Matrix Resolving...</div>`;
        mBTME.open('analyticsHub', 'Budget Intelligence', content, 'max-w-2xl');
    };
    /* --- 4. Switchboard Bridge Hooks --- */
    window.autofillMtemp = function(docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if (doc && typeof mBTPublisher !== 'undefined') {
            mBTPublisher.processAutofill(doc, budget);
            if (typeof openDocumentViewer === 'function') openDocumentViewer(docId);
        }
    };

/* ========= v19.54 CONNECTIVE UI & Interaction Handlers ========= */
    /* --- 1. UI Module: Project & Status Bar Resolution --- */
  function renderProjectManagement() {
    const container = document.getElementById('project-management-container');
    if (!container) return;
    const btnBase = "p-2.5 bg-white text-slate-400 hover:text-blue-600 rounded-xl border border-slate-100 shadow-sm transition-all active:scale-90 flex items-center justify-center";
   
    // Logic Resolution: Using indigo for Publish to match industry standard 'Finalization'
    const publishBase = "px-4 py-2 bg-indigo-600 text-white text-[9px] font-black uppercase tracking-widest rounded-xl shadow-lg hover:bg-indigo-700 transition-all active:scale-95 flex items-center gap-2";
    container.innerHTML = `
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center bg-white p-1 rounded-xl border border-slate-100 shadow-sm">
                <span class="px-2 text-[9px] font-black text-slate-400 uppercase tracking-tighter">FX</span>
                <select id="currencySelector" class="text-[10px] font-black bg-transparent border-none outline-none cursor-pointer pr-2 text-blue-600">
                    ${FILM_CURRENCIES.map(c => `<option value="${c.code}" ${c.code === displayCurrency ? 'selected' : ''}>${c.label}</option>`).join('')}
                </select>
            </div>
            <div class="flex items-center bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
                <select id="projectLoader" class="text-[10px] font-black uppercase tracking-widest bg-transparent border-none outline-none cursor-pointer px-2">
                    ${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}
                </select>
                <select id="newProjectSelector" class="bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-xl shadow-lg cursor-pointer outline-none border-none">
                    <option value="" disabled selected>FILE</option>
                    <option value="Commercial">NEW COMMERCIAL</option>
                    <option value="Documentary">NEW DOCUMENTARY</option>
                    <option value="Duplicate">DUPLICATE PROJECT</option>
                </select>
            </div>
            <div class="flex items-center gap-1.5">
                <button id="exportMooBtn" title="Backup Environment" class="${btnBase}">${mBTAssets.cloud}</button>
                <button id="exportPdfBtn" title="Print PDF" class="${btnBase}">${mBTAssets.print}</button>
                <button id="exportXlsxBtn" title="Export Excel" class="${btnBase}">${mBTAssets.file}</button>
               
                <button id="publishBtn" class="${publishBase}">
                    ${mBTAssets.zap} PUBLISH
                </button>
                <button id="deleteProjectBtn" title="Archive" class="p-2.5 bg-white text-slate-300 hover:text-rose-500 rounded-xl border border-slate-100 shadow-sm transition-all active:scale-90 ml-2">
                    ${mBTAssets.trash}
                </button>
            </div>
        </div>`;
}
    function renderStatusBar() {
        const container = document.getElementById('statusBar');
        if (!container) return;
        const lastAction = historyStack[historyIndex]?.description || "ENVIRONMENT READY";
        container.innerHTML = `
            <span id="statusBarMessage" class="truncate pr-4">${lastAction}</span>
            <div class="flex gap-2 flex-shrink-0 border-l border-white/20 pl-4">
                <button id="undoBtn" class="hover:text-blue-400 transition-colors" ${historyIndex <= 0 ? 'disabled style="opacity:0.3"' : ''}>UNDO</button>
                <button id="redoBtn" class="hover:text-blue-400 transition-colors" ${historyIndex >= historyStack.length - 1 ? 'disabled style="opacity:0.3"' : ''}>REDO</button>
            </div>`;
    }
    /* --- 2. History & State Resolution --- */
    function handleUndo() {
        if (historyIndex > 0) {
            historyIndex--;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    function handleRedo() {
        if (historyIndex < historyStack.length - 1) {
            historyIndex++;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    /* --- 3. Telemetry: Exchange Rate Resolution --- */
    async function fetchExchangeRates() {
        if (!navigator.onLine) return;
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            if (data?.rates) {
                exchangeRates = data.rates;
                localStorage.setItem(`${storageKeyPrefix}rates`, JSON.stringify(exchangeRates));
            }
        } catch (e) { console.warn("Currency synchronization failure."); }
    }
    /* --- 4. Interactive Routing Logic --- */
    function handleNewProjectSelection(e) {
        const val = e.target.value;
        if (val === 'Duplicate') handleDuplicateProject();
        else if (val) handleNewProject(true, val);
        e.target.value = "";
    }
    function deleteProject(name) {
        if (confirm(`Move "${name}" to Bin?`)) {
            localStorage.removeItem(storageKeyPrefix + name);
            const list = getProjectList();
            if (list.length) loadBudget(list[0]); else handleNewProject();
        }
    }
/* --- Feature: Production Stages Carousel --- */
window.showStagesModal = function() {
    const metrics = mBTStagesEngine.getMetrics();
    const stages = ['dev', 'pre', 'prod', 'post', 'dist'];
    const stageLabels = { dev: 'Development', pre: 'Pre-Prod', prod: 'Production', post: 'Post-Prod', dist: 'Distribution' };
    const content = `
        <div class="flex flex-col max-h-[90vh]">
            <div class="p-6 bg-slate-900 text-white rounded-t-[32px] flex justify-between items-end">
                <div>
                    <p class="text-[9px] font-black uppercase tracking-widest text-slate-400">Total Allocation</p>
                    <h2 class="text-3xl font-black tracking-tighter">${mBTLE.format.currency(metrics.grandTotal)}</h2>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-black uppercase tracking-widest text-slate-400">Burn Rate</p>
                    <p class="text-xl font-black text-emerald-400">${((metrics.grandTotal / (budget.grandTotal || 1)) * 100).toFixed(1)}%</p>
                </div>
            </div>
            <div id="stagesCarousel" class="flex-grow overflow-x-auto flex gap-6 p-6 no-scrollbar snap-x snap-mandatory bg-slate-100">
                ${stages.map(s => {
                    const status = mBTStagesEngine.getBurnStatus(metrics.stageTotals[s], (budget.targetLock?.totalCap * (budget.targetLock?.stages[s]?.ratio / 100)));
                    return `
                        <div class="snap-center shrink-0 w-[300px] flex flex-col gap-4">
                            <div class="flex justify-between items-center px-2">
                                <h3 class="font-black uppercase text-xs tracking-widest text-slate-800">${stageLabels[s]}</h3>
                                <span class="text-[10px] font-mono font-bold text-slate-500">${mBTLE.format.currency(metrics.stageTotals[s])}</span>
                            </div>
                           
                            <div id="stage-zone-${s}" data-stage="${s}" class="stage-drop-zone flex-grow bg-white/50 border-2 border-dashed border-slate-200 rounded-[24px] p-4 overflow-y-auto no-scrollbar transition-colors hover:bg-white hover:border-blue-300">
                                ${renderStageItems(s)}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
           
            <div class="p-4 bg-white border-t border-slate-200 flex justify-center gap-2">
                ${stages.map(s => `<div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>`).join('')}
            </div>
        </div>`;
    mBTME.open('stagesView', 'Production Pipeline', content, 'max-w-7xl', {
        noPadding: true,
        hideHeader: true,
        onOpen: () => {
            if (typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
        }
    });
};
function renderStageItems(stageKey) {
    let html = '';
    Object.values(budget.sections).forEach(sec => {
        sec.items.forEach(item => {
            if (item.stageData && item.stageData[stageKey]) {
                html += RenderEngine.stageCard({
                    ...item,
                    _sDays: item.stageData[stageKey].days,
                    _sRate: item.stageData[stageKey].rate,
                    _sec: sec.name
                }, stageKey);
            }
        });
    });
    return html || '<p class="text-[8px] text-center mt-10 font-black text-slate-300 uppercase">Drop Items Here</p>';
}
/* --- Feature: Advanced Documents Hub --- */
window.showDocumentsModal = function() {
    const docs = budget.documents || [];
    const templates = mBTOG.templates;
    const content = `
        <div class="flex flex-col max-h-[90vh]">
            <div class="p-6 bg-white border-b border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-slate-900 text-xs uppercase tracking-widest">Studio Vault</h3>
                    <div class="flex gap-2">
                        <button onclick="mBTTrash.open('documents')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-rose-500 transition-all">
                            ${mBTAssets.trash}
                        </button>
                    </div>
                </div>
                <input type="text" id="docSearch" placeholder="SEARCH VAULT..."
                       class="w-full p-3 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
            </div>
            <div class="flex-grow overflow-y-auto p-6 space-y-4 no-scrollbar bg-slate-50/50">
                <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Active Production Files</div>
                <div id="activeDocsList" class="grid grid-cols-1 gap-3">
                    ${docs.length ? docs.map(doc => `
                        <div class="group bg-white p-4 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex items-center justify-between">
                            <div class="flex items-center gap-4 cursor-pointer flex-grow" onclick="mBTDB.open('${doc.id}')">
                                <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-100">
                                    ${mBTAssets.file}
                                </div>
                                <div>
                                    <h4 class="font-black text-slate-900 text-xs uppercase tracking-tighter">${RenderEngine.esc(doc.label)}</h4>
                                    <p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest">${doc.type}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="mBTDB.snapshotDoc('${doc.id}')" title="Duplicate" class="p-2 text-slate-300 hover:text-blue-600">${mBTAssets.copy}</button>
                                <button onclick="window.handleDocTrash('${doc.id}')" title="Archive" class="p-2 text-slate-300 hover:text-rose-500">${mBTAssets.trash}</button>
                            </div>
                        </div>
                    `).join('') : '<div class="py-12 text-center text-slate-300 font-black uppercase text-[10px] tracking-widest">No Active Files</div>'}
                </div>
            </div>
            <div class="p-6 bg-white border-t border-slate-100">
                <button onclick="showNewDocumentSelector()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-3">
                    ${mBTAssets.plus} New Production Template
                </button>
            </div>
        </div>`;
    mBTME.open('documents', 'Production Studio', content, 'max-w-2xl', { noPadding: true, hideHeader: true });
   
    mBTME.attachSearch('docSearch', 'activeDocsList', docs, (doc) => `
        <div class="group bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between">
            <div class="flex items-center gap-4 cursor-pointer flex-grow" onclick="mBTDB.open('${doc.id}')">
                <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center">${mBTAssets.file}</div>
                <h4 class="font-black text-slate-900 text-xs uppercase">${RenderEngine.esc(doc.label)}</h4>
            </div>
        </div>
    `);
};
window.showNewDocumentSelector = function() {
    const templates = mBTOG.templates;
    const content = `
        <div class="space-y-6">
            <div class="text-center">
                <h3 class="font-black text-slate-900 text-sm uppercase tracking-widest">Select Template</h3>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Choose a blueprint to start your document</p>
            </div>
           
            <div class="grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto no-scrollbar p-1">
                ${templates.map(tmpl => `
                    <button onclick="createNewDocumentFromTemplate('${tmpl.id}')"
                            class="flex flex-col items-center gap-3 p-5 bg-slate-50 border border-slate-100 rounded-[24px] hover:bg-blue-50 hover:border-blue-200 transition-all group">
                        <span class="text-2xl transition-transform group-hover:scale-110">${tmpl.icon}</span>
                        <div class="text-center">
                            <span class="block font-black text-[9px] text-slate-900 uppercase tracking-tighter">${tmpl.label}</span>
                            <span class="block text-[7px] text-slate-400 font-bold uppercase mt-0.5">${tmpl.cat}</span>
                        </div>
                    </button>
                `).join('')}
            </div>
        </div>`;
    mBTME.open('newDocSelector', 'Studio Blueprints', content, 'max-w-md');
};
// Logic Resolution: Publish Window (Export Options)
window.showPublishModal = function() {
    const content = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
            <button onclick="mBTPublisher.toMoo()" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-blue-50 hover:border-blue-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-blue-600 group-hover:scale-110 transition-all">${mBTAssets.cloud}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Backup Environment</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Save .moo file</p>
                </div>
            </button>
            <button onclick="window.print()" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-indigo-50 hover:border-indigo-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-indigo-600 group-hover:scale-110 transition-all">${mBTAssets.print}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Print Budget</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Standard PDF Layout</p>
                </div>
            </button>
            <button onclick="alert('Excel export requires pro license')" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-emerald-50 hover:border-emerald-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-emerald-600 group-hover:scale-110 transition-all">${mBTAssets.file}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Export Data</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Convert to .XLSX</p>
                </div>
            </button>
        </div>
        <div class="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100 flex items-start gap-3">
            <div class="text-yellow-600 mt-0.5">${mBTAssets.sparkle}</div>
            <div>
                <h4 class="font-black text-[10px] uppercase tracking-widest text-yellow-800">Finalization Check</h4>
                <p class="text-[10px] text-yellow-700 leading-relaxed mt-1">Ensure all "To Be Determined" (TBD) fields in the Studio are resolved before generating final contracts.</p>
            </div>
        </div>`;
    mBTME.open('publishModal', 'Production Output', content, 'max-w-2xl');
};
// Logic Resolution: Coffee Widget (In-App Support)
// Coffee Widget (Support)
window.showCoffeeWidget = function() {
    const widgetUrl = "https://www.buymeacoffee.com/widget/page/jaysonmy?description=Support%20mooBudget%20development!&color=%23FFDD00";
   
    const content = `
        <div class="flex flex-col h-[650px] w-full bg-white rounded-2xl overflow-hidden">
            <div class="p-6 text-center bg-[#FFDD00] text-black relative overflow-hidden">
                <div class="absolute top-[-20px] right-[-20px] opacity-10 rotate-12 transform scale-150">
                    ${mBTAssets.coffee}
                </div>
                <h3 class="text-xl font-black uppercase tracking-tighter mb-1 relative z-10">Fuel the Code</h3>
            </div>
            <div class="flex-grow relative bg-slate-50">
                <iframe
                    src="${widgetUrl}"
                    style="width: 100%; height: 100%; border: none;"
                    title="Buy Me A Coffee"
                    loading="lazy">
                </iframe>
            </div>
        </div>`;
    mBTME.open('coffeeModal', 'Support', content, 'max-w-md', { hideHeader: true, noPadding: true });
};
console.log("TIER 5 complete");




/* ================= v19.54 TIER 6: System Ignition v19.55 ================= */
    /* --- 1. OFFLINE ENDURANCE SERVICE (Service Worker Registration) --- */
    // Logic Resolution: Forcing validation of script assets while bypassing browser cache.
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // --- Synchronization Policy: Force validation of script, bypassing browser cache ---
            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(reg => {
                    console.log('SW Synchronization active:', reg.scope);
                   
                    // --- Logic Change Detection: Monitoring repository for environmental changes ---
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // --- Conflict Resolution: Prompt for manual environment refresh ---
                                    console.log('Logic synchronization detected; prompting for resolution.');
                                    if(confirm("New production logic available! Synchronize environment now?")) {
                                        window.location.reload();
                                    }
                                } else {
                                    console.log('Content successfully cached for offline endurance.');
                                }
                            }
                        };
                    };
                })
                .catch(err => console.log('Service Worker initialization failure:', err));
        });
    }
    /* --- 2. GLOBAL EVENT ORCHESTRATION (mBTLE Handshake Hub) --- */
    // Logic Resolution: Centralized delegation for all interface triggers to prevent listener fragmentation.
    function bindAppEventListeners() {
        const appContainer = document.getElementById('app');
        const footer = document.querySelector('footer');
        if (!appContainer || appContainer.dataset.listenersBound) return;
        appContainer.dataset.listenersBound = 'true';
        // --- Master Change Listener: Environmental synchronization ---
        appContainer.addEventListener('change', (e) => {
            const id = e.target.id;
            if (id === 'projectName') {
                if (typeof handleProjectNameChange === 'function') handleProjectNameChange(e);
            } else if (['contingencyPercentage', 'salesTaxPercentage', 'discountPercentage'].includes(id)) {
                budget[id] = parseFloat(e.target.value) || 0;
                // --- Brain Handshake: High-speed mathematical reconciliation ---
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
            } else if (id === 'projectLoader') {
                loadBudget(e.target.value);
                render();
            } else if (id === 'newProjectSelector') {
                if (typeof handleNewProjectSelection === 'function') handleNewProjectSelection(e);
            } else if (e.target.dataset.field === 'unit') {
                handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Unit synchronization`);
            } else if (id === 'currencySelector') {
                displayCurrency = e.target.value;
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                if(typeof render === 'function') render();
            }
        });
        // --- Master Click Listener: Interface orchestration ---
        appContainer.addEventListener('click', (e) => {
            const target = e.target;
           
            if (target.id === 'undoBtn') { if (typeof handleUndo === 'function') handleUndo(); }
            else if (target.id === 'redoBtn') { if (typeof handleRedo === 'function') handleRedo(); }
            else if (target.id === 'loginBtn') { if (typeof handleLogin === 'function') handleLogin(); }
            else if (target.closest('#openAiToolsBtn')) { if (typeof showAIToolsModal === 'function') showAIToolsModal(); }
            else if (target.closest('#deleteProjectBtn')) { if (typeof deleteProject === 'function') deleteProject(currentProjectName); }
            else if (target.closest('#exportPdfBtn')) { if (typeof exportToPdf === 'function') exportToPdf(); }
            else if (target.closest('#exportXlsxBtn')) { if (typeof exportToXlsx === 'function') exportToXlsx(); }
            else if (target.id === 'exportMooBtn') { if (typeof mBTPublisher !== 'undefined') mBTPublisher.toMoo(); }
            else if (target.id === 'publishBtn') { if (typeof showPublishModal === 'function') showPublishModal(); }
            else if (target.closest('[data-section-toggle]')) {
                handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
            } else if (target.closest('[data-add-item]')) {
                showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
            } else if (target.closest('[data-remove-item]')) {
                const btnData = target.closest('[data-remove-item]').dataset;
                handleRemoveItem(btnData.section, btnData.removeItem);
            }
        });
        // --- Master Input Listener: Real-time mathematical handshake ---
        appContainer.addEventListener('input', (e) => {
            const input = e.target;
            if (input.dataset.field) {
                handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Live synchronization`);
            } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                budget[input.id] = parseFloat(input.value) || 0;
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
            }
        });
        // --- Footer Navigation: Module activation resolution ---
       if (footer) {
            footer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
               
                // 1. Stages
                if (btn.id === 'stagesFooterBtn') {
                    if (typeof showStagesModal === 'function') showStagesModal();
                }
                // 2. Documents
                else if (btn.id === 'docsFooterBtn') {
                    if (typeof showDocumentsModal === 'function') showDocumentsModal();
                }
                // 3. Settings (Center)
                else if (btn.id === 'mainActionBtn') {
                    if (typeof showSettingsModal === 'function') showSettingsModal();
                }
                // 4. Publish (Right)
                else if (btn.id === 'secondaryActionBtn') {
                    if (typeof showPublishModal === 'function') showPublishModal();
                }
                // 5. Coffee (Right Edge)
                else if (btn.id === 'footerCoffeeBtn') {
                    if (typeof showCoffeeWidget === 'function') showCoffeeWidget();
                }
            });
        }
        window.addEventListener('online', resolveConnectivityStatus);
        window.addEventListener('offline', resolveConnectivityStatus);
    }
    /* --- 3. INFRASTRUCTURE TELEMETRY (Connectivity resolution) --- */
    function resolveConnectivityStatus() {
        const isOnline = navigator.onLine;
        const btn = document.getElementById('loginBtn');
        if(btn) {
            btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'border-emerald-400 bg-emerald-50 text-emerald-600' : 'border-rose-400 bg-rose-50 text-rose-600'}`;
            btn.title = isOnline ? "Studio Online" : "Studio Offline";
            btn.innerHTML = mBTAssets.user;
        }
        const aiBtn = document.getElementById('openAiToolsBtn');
        if(aiBtn) {
            aiBtn.className = `p-2.5 border rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100 shadow-sm' : 'bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed opacity-75'}`;
            if(!isOnline) aiBtn.title = "AI Consultant Offline";
        }
    }
    function handleLogin() {
        if (navigator.onLine && confirm("Establish secure connection to Moo Studio Cloud infrastructure?")) {
            alert("Environment Authenticated.");
        }
    }
console.log("TIER 6 init starting", typeof render);
    /* --- 4. GLOBAL BOOT SEQUENCE (Environment resolution) --- */
    function init() {
        // --- Document Identity: Branding resolution ---
        document.title = `mooBudgetTool v${APP_VERSION}`;
       
        // --- State Hydration: Restoring currency and mathematical preferences ---
        displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
       
        // --- Brain Handshake: Coordinate initial exchange logic ---
        if (typeof fetchExchangeRates === 'function') fetchExchangeRates();
// --- Asset Injection: Populating footer with Tier 1 SVG assets ---
if (typeof injectFooterIcons === 'function') injectFooterIcons();
        // --- Persistence Recovery: Locating last active project environment ---
        let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
        if (!projectToLoad || !getProjectList().includes(projectToLoad)) {
            projectToLoad = getProjectList()[0];
        }
       
        // --- Structural Resolution: Initializing project state ---
        if (!projectToLoad) {
            if (typeof handleNewProject === 'function') handleNewProject(false);
        } else {
            if (typeof loadBudget === 'function') loadBudget(projectToLoad);
        }
       
        // --- UI Ignition: Triggering primary render and connectivity telemetry ---
        if (typeof render === 'function') {
            render();
            bindAppEventListeners();
            resolveConnectivityStatus();

            // --- UI Reinforcement: Ensure project management and status bar are always rendered ---
            if (typeof renderProjectManagement === 'function') renderProjectManagement();
            if (typeof renderStatusBar === 'function') renderStatusBar();

            console.log(`Studio Core v${APP_VERSION} Synchronized.`);
        } else {
            console.error("Critical Resolution Failure: RenderEngine not found.");
        }
    }
function injectFooterIcons() {
        const mapping = {
            'icon-stages': mBTAssets.grid, // Grid Icon
            'icon-docs': mBTAssets.file, // File Icon
            'icon-main-action': mBTAssets.gear, // Gear
'icon-secondary-action': mBTAssets.paperPlane, // Publish
            'icon-coffee': mBTAssets.coffee // Coffee Cup
        };
        Object.entries(mapping).forEach(([id, svg]) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = svg;
        });
    }
    /* --- 5. GLOBAL BRIDGE HOOKS & LIFECYCLE TRIGGER --- */
    window.showBinModal = () => { if (typeof mBTTrash !== 'undefined') mBTTrash.open('documents'); };
    window.handleDocTrash = (id) => { if (typeof mBTTrash !== 'undefined') mBTTrash.trashDocument(id); };
    // --- Master Lifecycle Trigger: DOM Synchronization ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof init === 'function') init();
    });
/* ======= END OF mBT ========== */
</script>
</body>
</html>
