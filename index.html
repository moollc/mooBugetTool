<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.44</title>
    
    <!-- PWA Manifest -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2933/2933116.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263/lucide.min.js">
    <!-- Marked.js for rendering Markdown from AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- Base & Typography --- */
        /* FIX: @import must be at the very top */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        /* FIX: Add text-size-adjust compatibility */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- Layout & Responsiveness --- */
        @media (min-width: 768px) {
            .sticky-header { position: sticky; top: 1rem; z-index: 10; }
        }
        
        /* --- Form Elements --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            appearance: none; /* FIX: Added standard appearance */
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }

        /* --- Modals & Transitions --- */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 0.2s ease-in-out; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #settingsModalContent, #aiToolsModalContent { transition: all 0.3s ease-in-out; }

        /* --- Tables --- */
        @media (max-width: 768px) {
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 600px; }
            th, td { white-space: nowrap; padding: 0.5rem 0.25rem; font-size: 0.75rem; }
            th:nth-child(1), td:nth-child(1) { width: 50px; } /* Crew */
            th:nth-child(2), td:nth-child(2) { min-width: 150px; } /* Description */
            th:nth-child(3), td:nth-child(3) { width: 50px; } /* Qty */
            th:nth-child(4), td:nth-child(4) { width: 60px; } /* Unit */
            th:nth-child(5), td:nth-child(5) { width: 80px; } /* Rate */
            th:nth-child(6), td:nth-child(6) { width: 80px; } /* Estimated */
            th:nth-child(7), td:nth-child(7) { width: 80px; } /* Actual */
            th:nth-child(8), td:nth-child(8) { width: 80px; } /* Variance */
            th:nth-child(9), td:nth-child(9) { width: 40px; } /* Actions */
        }

        /* --- Status Bar Scrolling (v19.34 Update: Manual Scrolling) --- */
        .scrolling-text-wrapper {
            flex: 1; 
            min-width: 0; 
            overflow-x: auto; 
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .scrolling-text-wrapper::-webkit-scrollbar { 
            display: none; 
        }

        /* --- Drag and Drop --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

        /* --- UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }
        
        /* Roadmap Styles */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

        /* AI Chat Styles */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

        /* Coffee Button (Internal - Backup) */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Print Hiding */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        
        /* v19.32: Hide Floating BMC Widget on Mobile */
        @media (max-width: 640px) {
            #bmac-btn-container, #bmc-wbtn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8"></div>
    
    <!-- Unified Modal Container -->
    <div id="global-modal-container"></div>

    <footer class="relative max-w-7xl mx-auto p-4 mt-8 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4 text-sm text-gray-500">
        <!-- Left: Info -->
        <div class="flex items-center gap-4 z-10 w-full sm:w-auto justify-center sm:justify-start">
            <p>Budget Tool by moo v19.48</p>
            <a href="mailto:moo@moo.llc" class="text-blue-600 hover:underline">moo@moo.llc</a>
        </div>
        
        <!-- Center: Settings & Coffee (Mobile Optimized) -->
        <div class="order-first sm:order-none sm:absolute sm:left-1/2 sm:-translate-x-1/2 z-10 flex items-center gap-3">
            <button id="settingsBtn" aria-label="Settings" class="p-3 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button id="footerCoffeeBtn" aria-label="Buy me a coffee" class="p-3 text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 rounded-full transition-colors sm:hidden" title="Buy me a coffee">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
            </button>
        </div>

        <!-- Right: Spacer (Keeps left content pushed left on Flexbox) -->
        <div class="hidden sm:block w-10"></div>
    </footer>

    <!-- Buy Me A Coffee Widget (Floating Bottom Right) -->
    <script 
        data-name="BMC-Widget" 
        data-cfasync="false" 
        src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
        data-id="jaysonmy" 
        data-description="Support me on Buy me a coffee!" 
        data-message="Thanks for the coffee!" 
        data-color="#5F7FFF" 
        data-position="Right" 
        data-x_margin="18" 
        data-y_margin="18">
    </script>
	
    <script>
        // --- CONSTANTS ---
        const APP_VERSION = "19.48";
        
        // Add your roadmap items here. The top item is the newest.
        const ROADMAP_LOG = [
            "Templates: Added Production Days calculator (v19.44)",
            "PWA: Accessibility fixes for buttons & labels (v19.42)",
            "Recovery: Added Bulk Restore & Delete All options (v19.41)",
            "Settings: Restored full defaults & protected them (v19.38)",
            "Settings: Fixed Template Manager render error (v19.37)",
            "Settings: Fixed AI Assistant layout for long keys (v19.35)"
        ];

        const UPDATE_SOURCE_URL = 'https://gist.githubusercontent.com/moollc/b31c0e4d1fb8b3f6de11beffb4b353a9/raw/gistfile1.txt';
        const storageKeyPrefix = 'prodBudget_v5_';
        const trashKey = `${storageKeyPrefix}trash`;
        const globalItemsKey = `${storageKeyPrefix}globalItems`; 
        const templatesKey = `${storageKeyPrefix}templates`; 
        
        let budget;
        let currentProjectName;
        let displayCurrency = 'JMD';
        let exchangeRate = 157.50;
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 7;
        let editingGlobalItemIndex = -1;
        
        // v19.36: Template Editor State
        let editingTemplateId = null; 
        let tempTemplateData = null;

        const initialLineItem = { description: 'New Item', quantity: 1, unit: 'Day', multiplier: 1, rate: 0, actual: 0 };

        // ---------------------------------------------------------
        // State & Persistence
        // ---------------------------------------------------------

        const getGlobalItems = () => JSON.parse(localStorage.getItem(globalItemsKey) || '[]');
        const saveGlobalItems = (items) => localStorage.setItem(globalItemsKey, JSON.stringify(items));

        const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
        const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;

        const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
        const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
        
        const getProjectNameSeparator = () => {
            const val = localStorage.getItem(projectNameSeparatorKey);
            return val !== null ? val : '-'; 
        };
        const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

        function saveBudget() {
            try {
                if (!budget || !budget.projectName) return;
                localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(budget));
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                currentProjectName = budget.projectName;
            } catch (e) { console.error("Could not save budget", e); }
        }

        function loadBudget(projectName) {
            try {
                const data = localStorage.getItem(storageKeyPrefix + projectName);
                if (data) { 
                    budget = JSON.parse(data); 
                    // Sanitize Data
                    Object.values(budget.sections).forEach(section => {
                        section.items.forEach(item => {
                            if (item.multiplier === undefined) item.multiplier = 1;
                        });
                    });
                    historyStack = [{ budget: JSON.parse(JSON.stringify(budget)), description: 'Project Loaded', timestamp: new Date().toISOString()}];
                    historyIndex = 0;
                } 
                else { handleNewProject(false); return; }
                currentProjectName = budget.projectName;
                 localStorage.setItem(`${storageKeyPrefix}lastLoaded`, currentProjectName);
            } catch (e) { console.error("Could not load budget", e); handleNewProject(false); }
        }

        const deleteProject = (projectName) => { 
            if (confirm(`Move project "${projectName}" to Recently Deleted?`)) {
                const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
                const projectData = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName));
                projectData.deletedTimestamp = new Date().toISOString();
                trash.push(projectData);
                localStorage.setItem(trashKey, JSON.stringify(trash));
                localStorage.removeItem(storageKeyPrefix + projectName); 
                init(); 
            } 
        };

        const getProjectList = () => Object.keys(localStorage)
            .filter(k => k.startsWith(storageKeyPrefix) && k !== `${storageKeyPrefix}lastLoaded` && k !== `${storageKeyPrefix}currency` && k !== trashKey && k !== globalItemsKey && k !== templatesKey && !k.includes('ApiKey') && !k.includes('selectedAiProvider') && !k.includes('projectDateFormat') && !k.includes('projectNameSeparator'))
            .map(k => k.substring(storageKeyPrefix.length))
            .sort();

        function pushToHistory(description) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            const snapshot = {
                budget: JSON.parse(JSON.stringify(budget)),
                description: description,
                timestamp: new Date().toISOString()
            };
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            saveBudget();
            renderStatusBar();
        }

        // ---------------------------------------------------------
        // AI Logic & Integration
        // ---------------------------------------------------------
        const geminiApiKeyStorage = `${storageKeyPrefix}geminiApiKey`;
        const openaiApiKeyStorage = `${storageKeyPrefix}openaiApiKey`;
        const xaiApiKeyStorage = `${storageKeyPrefix}xaiApiKey`;
        const deepseekApiKeyStorage = `${storageKeyPrefix}deepseekApiKey`;
        const aiProviderStorage = `${storageKeyPrefix}selectedAiProvider`;

        const getStoredApiKey = (provider) => {
            if (provider === 'gemini') return localStorage.getItem(geminiApiKeyStorage) || '';
            if (provider === 'openai') return localStorage.getItem(openaiApiKeyStorage) || '';
            if (provider === 'xai') return localStorage.getItem(xaiApiKeyStorage) || '';
            if (provider === 'deepseek') return localStorage.getItem(deepseekApiKeyStorage) || '';
            return '';
        };

        const saveStoredApiKey = (provider, key) => {
            if (provider === 'gemini') localStorage.setItem(geminiApiKeyStorage, key);
            if (provider === 'openai') localStorage.setItem(openaiApiKeyStorage, key);
            if (provider === 'xai') localStorage.setItem(xaiApiKeyStorage, key);
            if (provider === 'deepseek') localStorage.setItem(deepseekApiKeyStorage, key);
        };

        const getSelectedProvider = () => localStorage.getItem(aiProviderStorage) || 'gemini';
        const setSelectedProvider = (provider) => localStorage.setItem(aiProviderStorage, provider);

        async function callUnifiedAI(provider, apiKey, prompt) {
            if (provider === 'gemini') {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || 'Gemini API Error');
                return (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } 
            else if (['openai', 'xai', 'deepseek'].includes(provider)) {
                let baseUrl = 'https://api.openai.com/v1/chat/completions';
                let model = 'gpt-4o';
                if (provider === 'xai') { baseUrl = 'https://api.x.ai/v1/chat/completions'; model = 'grok-beta'; }
                else if (provider === 'deepseek') { baseUrl = 'https://api.deepseek.com/chat/completions'; model = 'deepseek-chat'; }
                
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: [{ role: "user", content: prompt }] })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || `${provider} API Error`);
                return (await response.json()).choices?.[0]?.message?.content || "No response.";
            }
            throw new Error("Unknown provider selected.");
        }

        // ---------------------------------------------------------
        // Business Logic & Helpers
        // ---------------------------------------------------------
        
        const calculateItem = (item) => {
            const estimated = (item.quantity || 0) * (item.multiplier || 1) * (item.rate || 0);
            const variance = (item.actual || 0) - estimated;
            return { estimated, variance };
        };

        const formatCurrency = (amount) => new Intl.NumberFormat(displayCurrency === 'JMD' ? 'en-JM' : 'en-US', { style: 'currency', currency: displayCurrency }).format(amount);
        const convertCurrency = (amount, toCurrency) => (toCurrency === 'USD') ? amount / exchangeRate : amount * exchangeRate;
        const toDisp = val => displayCurrency === 'USD' ? convertCurrency(val, 'USD') : val;

        const formatAbbreviated = (num, currency) => {
            const sign = num < 0 ? "-" : "";
            const absNum = Math.abs(num);
            const prefix = currency === 'JMD' ? 'J$' : '$';
            if (absNum >= 1e9) return `${sign}${prefix}${(absNum / 1e9).toFixed(2)}B`;
            if (absNum >= 1e6) return `${sign}${prefix}${(absNum / 1e6).toFixed(2)}M`;
            if (absNum >= 1e3) return `${sign}${prefix}${(absNum / 1e3).toFixed(1)}K`;
            return formatCurrency(num);
        };

        const calculateTotals = (sections) => { 
            let subtotal = 0; 
            for (const sectionName in sections) { 
                subtotal += sections[sectionName]?.items.reduce((acc, item) => acc + calculateItem(item).estimated, 0) || 0; 
            } 
            return { subtotal }; 
        };

        const calculateActuals = (sections) => { 
            let actualTotal = 0; 
            for (const sectionName in sections) { 
                actualTotal += sections[sectionName]?.items.reduce((acc, item) => acc + parseFloat(item.actual || 0), 0) || 0; 
            } 
            return actualTotal; 
        };

        // ---------------------------------------------------------
        // Template Management (v19.38: Restored Full Default Templates)
        // ---------------------------------------------------------
        
        const DEFAULT_TEMPLATES = {
            'Commercial': { projectName: `Untitled Commercial Project`, discountPercentage: 0, contingencyPercentage: 15, salesTaxPercentage: 15.0, sections: { 'Key Creatives & Agency': { isOpen: true, items: [ { id: 'c1', description: 'Director', quantity: 3, unit: 'Day', multiplier: 1, rate: 80000, actual: 0 }, { id: 'c2', description: 'Producer', quantity: 5, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c3', description: 'Agency Fee / Creative Director', quantity: 1, unit: 'Flat', multiplier: 1, rate: 250000, actual: 0 }, { id: 'c4', description: 'Lead Talent / On-Screen Host', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Production Staff': { isOpen: true, items: [ { id: 'c5', description: 'Production Manager / Fixer', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c6', description: 'Production Coordinator (PC)', quantity: 5, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'c7', description: 'Production Assistant', quantity: 2, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 } ] }, 'Camera Department': { isOpen: true, items: [ { id: 'c8', description: 'Director of Photography (DP)', quantity: 3, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'c9', description: 'Camera Operator', quantity: 3, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c10', description: '1st Assistant Camera (AC)', quantity: 3, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'c11', description: 'Camera Package (Sony FX6)', quantity: 3, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'c12', description: 'Lens Package (Cine Primes)', quantity: 1, unit: 'Week', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c13', description: 'Teleprompter & Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 } ] }, 'Electric & Grip': { isOpen: true, items: [ { id: 'c14', description: 'Gaffer', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c15', description: 'Key Grip', quantity: 3, unit: 'Day', multiplier: 1, rate: 45000, actual: 0 }, { id: 'c16', description: 'Lighting & Grip Package (Van)', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 } ] }, 'Sound Department': { isOpen: true, items: [ { id: 'c17', description: 'Production Sound Mixer', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c18', description: 'Sound Package (Mixer, Mics, Boom)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Art Department & Wardrobe': { isOpen: true, items: [ { id: 'c19', description: 'Art Director / Stylist', quantity: 4, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c20', description: 'Props & Wardrobe Purchase/Rental', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c21', description: 'Key Hair & Makeup Artist', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Locations & Production Expenses': { isOpen: true, items: [ { id: 'c22', description: 'Location Fees (Office, etc)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c23', description: 'Catering (15 people, per day)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c24', description: 'Transportation (Van & Driver)', quantity: 3, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'c25', description: 'Editor', quantity: 8, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c26', description: 'Motion Graphics Artist', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c27', description: 'Colorist', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c28', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c29', description: 'Music Licensing (Stock)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'c30', description: 'Film Registration Fee (JAMPRO)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 14400, actual: 0 }, { id: 'c31', description: 'Legal Review', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c32', description: 'Production Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 144000, actual: 0 } ] } } },
            'Documentary': { projectName: `Untitled Documentary Project`, discountPercentage: 0, contingencyPercentage: 10, salesTaxPercentage: 15.0, sections: { 'Pre-Production | Research': { isOpen: true, items: [ { id: 'd1', description: 'Producer / Director (Development)', quantity: 20, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd2', description: 'Archival Researcher', quantity: 10, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'd3', description: 'Research & Travel', quantity: 1, unit: 'Flat', multiplier: 1, rate: 90000, actual: 0 } ] }, 'Production (2-Cam Setup)': { isOpen: true, items: [ { id: 'd4', description: 'Director', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd5', description: 'Director of Photography', quantity: 20, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'd6', description: 'Camera Operator (B-Cam)', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd7', description: 'Production Sound Mixer', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd8', description: 'Production Assistant', quantity: 20, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'd9', description: 'Camera Package (Sony FX6) - A Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd10', description: 'Camera Package (Sony FX6) - B Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd11', description: 'Sound Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'd12', description: 'Lighting & Grip Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd13', description: 'Travel & Accommodation', quantity: 1, unit: 'Flat', multiplier: 1, rate: 450000, actual: 0 }, { id: 'd14', description: 'Meals & Per Diems', quantity: 1, unit: 'Flat', multiplier: 1, rate: 240000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'd15', description: 'Editor', quantity: 60, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd16', description: 'Assistant Editor / Logger', quantity: 40, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'd17', description: 'Transcription Services', quantity: 20, unit: 'Hour', multiplier: 1, rate: 4500, actual: 0 }, { id: 'd18', description: 'Archival Footage Licensing', quantity: 1, unit: 'Flat', multiplier: 1, rate: 300000, actual: 0 }, { id: 'd19', description: 'Colorist', quantity: 8, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd20', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 200000, actual: 0 }, { id: 'd21', description: 'Composer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 225000, actual: 0 } ] }, 'Marketing & Distribution': { isOpen: true, items: [ { id: 'd22', description: 'Festival Submission Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 75000, actual: 0 }, { id: 'd23', description: 'Publicist Retainer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 150000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'd24', description: 'Legal Fees (Contracts, Clearances)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 180000, actual: 0 }, { id: 'd25', description: 'E&O Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 210000, actual: 0 }, { id: 'd26', description: 'Bookkeeping', quantity: 1, unit: 'Flat', multiplier: 1, rate: 60000, actual: 0 } ] } } },
            'LiveStream': { projectName: `Untitled Live Stream Project`, discountPercentage: 0, contingencyPercentage: 20, salesTaxPercentage: 15.0, sections: { 'Pre-Production': { isOpen: true, items: [ { id: 'l1', description: 'Technical Director (Planning)', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l2', description: 'Producer (Coordination)', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Live Production Crew': { isOpen: true, items: [ { id: 'l3', description: 'Technical Director (Switcher)', quantity: 1, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'l4', description: 'Stream Engineer', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l5', description: 'Graphics Operator (CG)', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l6', description: 'Camera Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l7', description: 'Audio Engineer (A1)', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l8', description: 'A/V Technician / Utility', quantity: 1, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Live Production Equipment': { isOpen: true, items: [ { id: 'l9', description: 'Manned Broadcast Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l10', description: 'Robotic PTZ Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l11', description: 'Video Switcher (ATEM Mini Extreme)', quantity: 1, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'l12', description: 'Audio Mixer & Mics Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'l13', description: 'Intercom System (Comms)', quantity: 1, unit: 'Day', multiplier: 1, rate: 10500, actual: 0 }, { id: 'l14', description: 'Lighting Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l15', description: 'Internet / Bonded Cellular', quantity: 1, unit: 'Day', multiplier: 1, rate: 36000, actual: 0 }, { id: 'l16', description: 'Live Streaming Platform Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'l17', description: 'Minor Edits & Re-uploads', quantity: 1, unit: 'Flat', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'l18', description: 'Production Insurance (Live Event)', quantity: 1, unit: 'Policy', multiplier: 1, rate: 180000, actual: 0 } ] } } }
        };

        const getAllTemplates = () => {
            const stored = localStorage.getItem(templatesKey);
            let templates;
            
            if (stored) {
                try {
                    templates = JSON.parse(stored);
                    templates['Commercial'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Commercial']));
                    templates['Documentary'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Documentary']));
                    templates['LiveStream'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['LiveStream']));
                } catch(e) {
                    templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
                }
            } else {
                templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
            }
            
            localStorage.setItem(templatesKey, JSON.stringify(templates));
            return templates;
        };

        const saveAllTemplates = (templates) => localStorage.setItem(templatesKey, JSON.stringify(templates));

        const getDefaultBudget = (name, type = 'Commercial') => {
            const allTemplates = getAllTemplates();
            let template = allTemplates[type] ? JSON.parse(JSON.stringify(allTemplates[type])) : JSON.parse(JSON.stringify(allTemplates['Commercial']));
            template.projectName = name;
            if(template.sections) {
                Object.values(template.sections).forEach(s => s.items.forEach(i => { i.id = crypto.randomUUID(); if(i.multiplier === undefined) i.multiplier = 1; }));
            }
            return template;
        };

        // ---------------------------------------------------------
        // UI Rendering
        // ---------------------------------------------------------
        
        function createModal(id, title, contentHtml, maxWidth = 'max-w-2xl') {
            const container = document.getElementById('global-modal-container');
            const modalId = `${id}Modal`;
            let modal = document.getElementById(modalId);
            const fullHtml = `<div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden"><div id="${modalId}Content" class="bg-white rounded-lg shadow-xl w-full ${maxWidth} mx-auto max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95"><div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"><h2 class="text-xl font-bold text-gray-800">${title}</h2><button onclick="closeModal('${modalId}')" aria-label="Close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div><div class="overflow-y-auto flex-grow" id="${modalId}Body">${contentHtml}</div></div></div>`;
            if (modal) modal.remove(); 
            container.insertAdjacentHTML('beforeend', fullHtml);
            modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); }, 10);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modalId); });
            return modal;
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('opacity-0');
            document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            if(modalId === 'settingsModal') { editingGlobalItemIndex = -1; tempTemplateData = null; }
        };

        function renderStatusBar() {
            const container = document.getElementById('statusBar');
            if (!container) return;
            const lastAction = historyStack[historyIndex];
            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < historyStack.length - 1;
            const message = lastAction?.description || 'No recent changes.';
            container.innerHTML = `<div id="statusMsgWrapper" class="scrolling-text-wrapper"><span id="statusBarMessage" class="font-medium px-1">${message}</span></div><div class="flex items-center flex-shrink-0 pl-2 border-l border-blue-200 ml-2"><button id="undoBtn" class="px-2 py-1 rounded-md text-sm font-semibold ${canUndo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canUndo ? 'disabled' : ''}>Undo</button><button id="redoBtn" class="ml-2 px-2 py-1 rounded-md text-sm font-semibold ${canRedo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canRedo ? 'disabled' : ''}>Redo</button></div>`;
        }

        function renderLineItem(item, sectionName) {
            const rateDisp = toDisp(item.rate);
            const actualDisp = toDisp(item.actual);
            const multiplierValue = item.multiplier !== 1 ? item.multiplier : '';
            
            // FIX: Removed draggable="true" from TR. Added drag-handle cell.
            return `<tr class="draggable-row border-b hover:bg-gray-100 group" data-item-id="${item.id}" data-section="${sectionName}">
                <td class="p-2 text-center text-gray-400 cursor-grab active:cursor-grabbing drag-handle touch-none select-none hover:text-blue-500" title="Drag to reorder">⠿</td>
                <td class="p-1 w-16"><input type="number" step="0.1" aria-label="Crewtiplier" data-field="multiplier" data-id="${item.id}" data-section="${sectionName}" value="${multiplierValue}" class="w-full bg-transparent p-0.5 rounded text-center" placeholder="1" /></td>
                <td class="p-2"><input type="text" aria-label="Description" data-field="description" data-id="${item.id}" data-section="${sectionName}" value="${item.description}" class="w-full bg-transparent p-1 rounded-md" /></td>
                <td class="p-2 text-center"><input type="number" aria-label="Quantity" data-field="quantity" data-id="${item.id}" data-section="${sectionName}" value="${item.quantity}" class="w-20 bg-transparent p-1 rounded-md text-center" /></td>
                <td class="p-2"><select aria-label="Unit" data-field="unit" data-id="${item.id}" data-section="${sectionName}" class="w-full bg-transparent p-1 rounded-md"><option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option></select></td>
                <td class="p-2 text-right"><input type="number" step="0.01" aria-label="Rate" data-field="rate" data-id="${item.id}" data-section="${sectionName}" value="${rateDisp.toFixed(2)}" class="w-28 bg-transparent p-1 rounded-md text-right" /></td>
                <td data-estimated-id="${item.id}" class="p-2 text-right font-medium"></td>
                <td class="p-2 text-right"><input type="number" step="0.01" aria-label="Actual Cost" data-field="actual" data-id="${item.id}" data-section="${sectionName}" value="${actualDisp.toFixed(2)}" class="w-28 bg-blue-50 p-1 rounded-md text-right" /></td>
                <td data-variance-id="${item.id}" class="p-2 text-right font-medium"></td>
                <td class="p-2 text-center"><button aria-label="Remove Item" data-remove-item="${item.id}" data-section="${sectionName}" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>
            </tr>`;
        }
        
        function renderBudgetSections() {
            // FIX: Added empty header cell for the drag handle column
            return Object.entries(budget.sections).map(([sectionName, section]) => `<div class="mb-6 bg-white rounded-lg shadow-md overflow-hidden"><div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer border-b" data-section-toggle="${sectionName}"><div class="flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 section-arrow">${section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>'}</svg><h2 class="text-xl font-semibold">${sectionName}</h2></div><span data-section-total="${sectionName}" class="text-lg font-bold pointer-events-none"></span></div><div class="section-content ${section.isOpen ? '' : 'hidden'}"><div class="p-2 table-container"><table class="w-full text-sm"><thead><tr>
                <th class="p-1 w-8"></th> 
                <th class="p-1 text-center w-16">Crew</th><th class="p-2 text-left min-w-[250px]">Description</th><th class="p-2 text-center">Qty</th><th class="p-2 text-left">Unit</th><th class="p-2 text-right">Rate</th><th class="p-2 text-right">Estimated</th><th class="p-2 text-right">Actual</th><th class="p-2 text-right">Variance</th><th class="p-2"></th></tr></thead><tbody data-section-body="${sectionName}">${section.items.map(item => renderLineItem(item, sectionName)).join('')}</tbody></table></div><div class="mt-2 p-2"><button data-add-item="${sectionName}" class="flex items-center text-blue-600 font-medium"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Add Line Item</button></div></div></div>`).join('');
        }

        function render() {
            const appContainer = document.getElementById('app');
            if (!budget || !appContainer) return;
            const activeElement = document.activeElement;
            const activeElementId = activeElement ? activeElement.id : null;
            const activeElementDataId = activeElement ? activeElement.dataset.id : null;
            const activeElementDataField = activeElement ? activeElement.dataset.field : null;
            
            appContainer.innerHTML = `<header class="mb-6 flex flex-wrap items-center justify-between gap-y-4"><div class="flex items-center gap-3 w-full md:w-auto flex-grow mr-4"><input type="text" id="projectName" aria-label="Project Name" value="${budget.projectName}" class="text-xl sm:text-3xl md:text-4xl font-bold text-gray-800 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-2 rounded-lg" /><button id="loginBtn" aria-label="Connection Status" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0" title="Check connection"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><circle cx="12" cy="7" r="4"/></svg></button></div><div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div></header><div class="mt-2 flex gap-2 overflow-hidden"><button id="openAiToolsBtn" aria-label="AI Assistant" class="p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0" title="AI Assistant">✨</button><div id="statusBar" class="flex-grow p-2 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 flex justify-between items-center overflow-hidden"></div></div><div id="summary" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-8 md:sticky-header mt-4"><h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Budget Summary</h1><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><p class="text-sm text-gray-500">Subtotal</p><p id="summarySubtotal" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><label for="contingencyPercentage" class="text-sm text-gray-500 block">Contingency</label><div class="flex items-baseline gap-2"><div class="flex-grow min-w-0"><p id="summaryContingency" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.1" id="contingencyPercentage" aria-label="Contingency Percentage" value="${budget.contingencyPercentage}" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><label for="salesTaxPercentage" class="text-sm text-gray-500 block">Sales Tax (GCT)</label><div class="flex items-baseline gap-2"><div class="flex-grow min-w-0"><p id="summaryTax" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.01" id="salesTaxPercentage" aria-label="Sales Tax Percentage" value="${budget.salesTaxPercentage}" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 border-t"><div class="bg-red-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full"><label for="discountPercentage" class="text-sm text-red-500 block">Discount</label><div class="flex flex-col-reverse items-end md:flex-row md:items-baseline md:gap-2"><div class="flex-grow min-w-0 w-full"><p id="summaryDiscount" class="text-xl sm:text-2xl md:text-3xl font-bold text-red-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.01" id="discountPercentage" aria-label="Discount Percentage" value="${budget.discountPercentage || 0}" min="0" max="100" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div><div class="bg-blue-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full relative"><p class="text-sm text-blue-500">Estimated Grand Total</p><p id="summaryGrandTotal" class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-700 whitespace-nowrap"></p></div><div class="bg-green-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full relative"><p class="text-sm text-green-500">Actual Total Cost</p><p id="summaryActualTotal" class="text-xl sm:text-2xl md:text-3xl font-bold text-green-700 whitespace-nowrap"></p></div></div></div><main id="budget-sections">${renderBudgetSections()}</main><div id="footnote" class="mt-8 p-3 bg-gray-50 border border-gray-300 rounded-lg text-xs text-gray-600"><span>Personnel rates based on 2025 Jamaican market data from Beverly Boy Productions ($355-605USD Cam Op avg ~75k JMD), SalaryExpert (Editor ~50k JMD/day), JAMPRO, EmergeFilm, Paylab (PA 15k min above wage; Makeup 30k incl. materials ~$200USD); reductions: skilled 50-70% below US, entry 60-80%. </span><button id="compareRatesBtn" class="ml-2 text-blue-600 hover:underline">Compare Rates</button></div>`;
            renderProjectManagement();
            renderStatusBar();
            updateCalculations();
            initializeInteractiveInputs();
            initializeDragAndDrop();
            updateOnlineStatus(); 
            if (activeElementId) {
                const toFocus = document.getElementById(activeElementId);
                if (toFocus) toFocus.focus();
            } else if (activeElementDataId && activeElementDataField) {
                const toFocus = document.querySelector(`[data-id="${activeElementDataId}"][data-field="${activeElementDataField}"]`);
                if (toFocus) toFocus.focus();
            }
        }

        // ---------------------------------------------------------
        // Modal Logic
        // ---------------------------------------------------------

        function showRateComparisonModal() {
             const rateComparisons = [
                { role: 'Camera Operator', local: '60,000 JMD', caricom: '65,000-80,000 JMD (T&T)', us: '$480 USD' },
                { role: 'Editor', local: '50,000 JMD', caricom: '45,000-55,000 JMD', us: '$400 USD' },
                { role: 'Production Assistant', local: '15,000 JMD', caricom: '12,000-18,000 JMD', us: '$150 USD' },
                { role: 'Hair & Makeup Artist', local: '30,000 JMD', caricom: '25,000-35,000 JMD', us: '$300 USD' },
                { role: 'Director of Photography', local: '70,000 JMD', caricom: '75,000-90,000 JMD', us: '$800 USD' },
                { role: 'Sound Mixer', local: '40,000 JMD', caricom: '35,000-45,000 JMD', us: '$350 USD' }
            ];

            const content = `
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">Role</th><th class="p-2 text-left">Local Jamaica (JMD/day)</th><th class="p-2 text-left">Caricom Avg (JMD/day)</th><th class="p-2 text-left">US Avg (USD/day)</th></tr></thead>
                    <tbody>${rateComparisons.map(row => `<tr class="border-b"><td class="p-2">${row.role}</td><td class="p-2">${row.local}</td><td class="p-2">${row.caricom}</td><td class="p-2">${row.us}</td></tr>`).join('')}</tbody>
                </table>
                <p class="text-xs text-gray-500 mt-4">Sources: Beverly Boy, SalaryExpert, JAMPRO. Rates approximate for mid-range productions.</p>
            `;
            createModal('rateComparison', 'Rate Comparisons (2025 Averages)', content, 'max-w-4xl');
        }

        function showAIToolsModal() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            
            const content = !key ? 
                `<div class="text-center py-10">
                    <div class="text-4xl mb-4">🔑</div>
                    <h3 class="text-lg font-bold text-gray-700">API Key Required</h3>
                    <p class="text-gray-500 text-sm mb-4">Please go to Settings > AI Assistant to configure your API key for ${provider.toUpperCase()}.</p>
                    <button onclick="closeModal('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Open Settings</button>
                </div>` 
                : 
                `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col">
                        <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-lg"><span class="text-2xl">🩺</span> Budget Doctor</h4>
                        <p class="text-sm text-gray-500 mb-4">Analyze your current budget for gaps, risks, and rate anomalies using ${provider}.</p>
                        <button id="analyzeBudgetBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex justify-center items-center gap-2 font-medium transition-colors">Analyze Current Budget</button>
                        <div id="aiAnalysisOutput" class="mt-4 text-sm text-gray-700 flex-grow overflow-y-auto border-t pt-4 min-h-[200px]"></div>
                    </div>
                    <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                        <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-lg"><span class="text-2xl">💬</span> Production Consultant</h4>
                        <div id="aiChatHistory" class="flex-grow overflow-y-auto bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200"><div class="text-sm text-gray-400 text-center mt-10">Ask about union rules, equipment packages, or local rates...</div></div>
                        <form id="aiChatForm" class="flex gap-2">
                            <input type="text" id="aiChatInput" placeholder="Ask a question..." aria-label="Ask AI" class="flex-grow text-sm p-3 border rounded-lg focus:outline-none focus:border-blue-500">
                            <button type="submit" class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                        </form>
                    </div>
                </div>`;

            createModal('aiTools', '✨ AI Assistant', content, 'max-w-4xl');
            
            // Re-bind listeners if key exists
            if (key) {
                document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
                document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
            }
        }

        function showSettingsModal(defaultTab = 'general') {
            const content = `
                <div class="flex border-b text-sm font-medium text-gray-600 overflow-x-auto">
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'general' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('general', this)">General</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'templates' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('templates', this)">Templates</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'database' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('database', this)">Database</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'ai' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('ai', this)">✨ AI Assistant</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'roadmap' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('roadmap', this)">Roadmap</button>
                </div>
                <div class="p-6" id="settingsContent">${renderSettingsContent(defaultTab)}</div>
            `;
            createModal('settings', 'Settings & Tools', content, 'max-w-4xl'); // Expanded width for templates
            bindSettingsEvents(defaultTab);
        }

        // v19.36: Updated showItemSelector to use centralized logic
        function showItemSelectorModal(sectionName) {
            const allItems = getAllItems();
            const uniqueMap = {};
            allItems.forEach(item => {
                if (!uniqueMap[item.description]) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: 0, isGlobal: item.isGlobal };
                else if (item.isGlobal) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: uniqueMap[item.description].count, isGlobal: true };
                if (!item.isGlobal) {
                     uniqueMap[item.description].count++;
                     if(!uniqueMap[item.description].isGlobal) uniqueMap[item.description].rate += item.rate;
                }
            });
            Object.keys(uniqueMap).forEach(desc => {
                const entry = uniqueMap[desc];
                if (!entry.isGlobal && entry.count > 1) entry.rate = entry.rate / entry.count;
            });
            const itemList = Object.keys(uniqueMap).filter(desc => desc !== 'New Item' && desc.trim())
                .map(desc => ({ description: desc, unit: uniqueMap[desc].unit, rate: uniqueMap[desc].rate, isGlobal: uniqueMap[desc].isGlobal }))
                .sort((a, b) => { if (a.isGlobal && !b.isGlobal) return -1; if (!a.isGlobal && b.isGlobal) return 1; return a.description.localeCompare(b.description); });

            const content = `
                <button id="newItemBtn" class="w-full mb-2 p-2 bg-blue-500 text-white rounded hover:bg-blue-600">New Unlisted Item</button>
                <div class="max-h-64 overflow-y-auto">
                    ${itemList.length > 0 ? itemList.map(item => `
                        <div class="p-2 border-b border-gray-200 cursor-pointer hover:bg-gray-50 flex justify-between items-center group" data-select-item='${JSON.stringify({ desc: item.description, unit: item.unit, rate: item.rate })}'>
                            <div class="flex items-center overflow-hidden">${item.isGlobal ? '<span class="mr-2 text-yellow-500" title="Saved to Database">★</span>' : ''}<span class="truncate ${item.isGlobal ? 'font-medium text-gray-900' : 'text-gray-700'}">${item.description}</span></div>
                            <span class="text-sm text-gray-500 whitespace-nowrap ml-2">${item.unit} : ${formatCurrency(item.rate)}</span>
                        </div>`).join('') : '<p class="text-center text-gray-500 py-8">No previous items found.</p>'}
                </div><div class="mt-2 text-xs text-center text-gray-400">Use Settings <span class="text-yellow-500">★</span> to manage saved items.</div>`;
            
            const modal = createModal('itemSelector', 'Add Line Item', content, 'max-w-md');
            
            document.getElementById('newItemBtn').addEventListener('click', () => { closeModal('itemSelectorModal'); handleAddBlank(sectionName); });
            modal.querySelectorAll('[data-select-item]').forEach(el => {
                el.addEventListener('click', (e) => {
                    const data = JSON.parse(e.currentTarget.dataset.selectItem);
                    closeModal('itemSelectorModal');
                    handleAddExisting(sectionName, data.desc, data.unit, data.rate);
                });
            });
        }

        function showRecoveryModal() {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            
            let content = trash.length > 0 ? 
                `<div class="max-h-[60vh] overflow-y-auto">` + 
                trash.map((p, index) => `
                <div class="flex justify-between items-center p-2 ${index < trash.length -1 ? 'border-b' : ''}">
                    <div><p class="font-semibold">${p.projectName}</p><p class="text-xs text-gray-500">Deleted: ${new Date(p.deletedTimestamp).toLocaleString()}</p></div>
                    <div>
                        <button onclick="handleRestore(${index})" class="text-sm bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Restore</button>
                        <button onclick="handlePermanentDelete(${index})" class="text-sm bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 ml-2">Delete Forever</button>
                    </div>
                </div>`).join('') + 
                `</div>`
                : `<p class="text-center text-gray-500 py-8">No recently deleted projects.</p>`;
            
            if (trash.length > 0) {
                content += `
                <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                    <span class="text-xs text-gray-500 font-medium">Bulk Actions</span>
                    <div class="flex gap-2">
                        <button onclick="handleRestoreAll()" class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700 shadow-sm transition-colors">Restore All</button>
                        <button onclick="handleDeleteAllTrash()" class="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow-sm transition-colors">Delete All</button>
                    </div>
                </div>`;
            }
            
            createModal('recovery', 'Recover Deleted Projects', content, 'max-w-lg');
        }

        // ---------------------------------------------------------
        // Event Handlers
        // ---------------------------------------------------------

        function bindAppEventListeners() {
            const appContainer = document.getElementById('app');
            const footer = document.querySelector('footer');

            if (!appContainer || appContainer.dataset.listenersBound) return;
            appContainer.dataset.listenersBound = 'true';

            appContainer.addEventListener('change', (e) => {
                const id = e.target.id;
                if (id === 'projectName') handleProjectNameChange(e);
                else if (id === 'contingencyPercentage') { budget.contingencyPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Contingency %'); updateCalculations(); }
                else if (id === 'salesTaxPercentage') { budget.salesTaxPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Sales Tax %'); updateCalculations(); }
                else if (id === 'discountPercentage') handleDiscountChange(e);
                else if (id === 'projectLoader') { loadBudget(e.target.value); render(); }
                else if (id === 'newProjectSelector') handleNewProjectSelection(e);
                else if (e.target.dataset.field === 'unit') handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Changed unit for ${e.target.closest('tr').querySelector('input[data-field=description]').value}`);
            });

            if(footer) {
                footer.addEventListener('click', (e) => { 
                    if (e.target.closest('#settingsBtn')) showSettingsModal(); 
                    if (e.target.closest('#footerCoffeeBtn')) {
                        const btn = document.querySelector('#bmc-wbtn');
                        if (btn) btn.click();
                        else window.open('https://buymeacoffee.com/jaysonmy', '_blank');
                    }
                });
            }

            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.id === 'undoBtn') handleUndo();
                else if (target.id === 'redoBtn') handleRedo();
                else if (target.id === 'loginBtn') handleLogin();
                else if (target.closest('#openAiToolsBtn')) showAIToolsModal();
                else if (target.closest('#deleteProjectBtn')) deleteProject(currentProjectName);
                else if (target.closest('#currencyToggleBtn')) handleCurrencyToggle();
                else if (target.closest('#exportPdfBtn')) exportToPdf();
                else if (target.closest('#exportXlsxBtn')) exportToXlsx();
                else if (target.closest('[data-section-toggle]')) handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
                else if (target.closest('[data-add-item]')) showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
                else if (target.closest('[data-remove-item]')) handleRemoveItem(target.closest('[data-remove-item]').dataset.section, target.closest('[data-remove-item]').dataset.removeItem);
                else if (target.id === 'compareRatesBtn') showRateComparisonModal();
            });

            appContainer.addEventListener('input', (e) => {
                const input = e.target;
                if (input.dataset.field) {
                    handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Updated ${input.dataset.field}`);
                } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    updateCalculations();
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        // ---------------------------------------------------------
        // Implementation Logic
        // ---------------------------------------------------------

        function getAllItems() {
            const allItems = [];
            getGlobalItems().forEach(item => allItems.push({ description: item.description, unit: item.unit, rate: item.rate, isGlobal: true }));
            getProjectList().forEach(projectName => {
                try {
                    const data = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName) || '{}');
                    if (data?.sections) Object.values(data.sections).forEach(section => {
                        section.items?.forEach(item => {
                            if (item.description?.trim()) allItems.push({ description: item.description.trim(), unit: item.unit || 'Day', rate: item.rate || 0, isGlobal: false });
                        });
                    });
                } catch (e) { console.error(e); }
            });
            return allItems;
        }

        function formatAndUpdateSummaryValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = formatCurrency(value);
            if (element.scrollWidth > element.parentElement.clientWidth) element.textContent = formatAbbreviated(value, displayCurrency);
        }

        function checkOverBudget() {
            const actualTotal = calculateActuals(budget.sections);
            const { subtotal } = calculateTotals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const grandTotal = (subtotal + contingencyAmount + taxAmount) - ((subtotal + contingencyAmount + taxAmount) * ((budget.discountPercentage || 0) / 100));

            const summaryActual = document.getElementById('summaryActualTotal');
            if (summaryActual) {
                const hasOverBudget = actualTotal > grandTotal;
                summaryActual.parentElement.classList.toggle('bg-red-50', hasOverBudget);
                if (hasOverBudget && !summaryActual.parentElement.querySelector('.alert-badge')) {
                     summaryActual.parentElement.innerHTML += '<div class="alert-badge">!</div>';
                } else if (!hasOverBudget) {
                     const badge = summaryActual.parentElement.querySelector('.alert-badge');
                     if (badge) badge.remove();
                }
            }

            for (const sectionName in budget.sections) {
                budget.sections[sectionName].items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    const row = document.querySelector(`[data-item-id="${item.id}"]`);
                    if (row) row.classList.toggle('bg-red-50', variance > 0);
                });
            }
        }

        function updateCalculations() {
            if (!document.getElementById('summarySubtotal')) return;
            const { subtotal } = calculateTotals(budget.sections);
            const actualTotal = calculateActuals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
            const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
            const grandTotal = totalBeforeDiscount - discountAmount;

            formatAndUpdateSummaryValue('summarySubtotal', toDisp(subtotal));
            formatAndUpdateSummaryValue('summaryContingency', toDisp(contingencyAmount));
            formatAndUpdateSummaryValue('summaryTax', toDisp(taxAmount));
            formatAndUpdateSummaryValue('summaryDiscount', toDisp(-discountAmount));
            formatAndUpdateSummaryValue('summaryGrandTotal', toDisp(grandTotal));
            formatAndUpdateSummaryValue('summaryActualTotal', toDisp(actualTotal));

            for (const sectionName in budget.sections) {
                const section = budget.sections[sectionName];
                let sectionTotal = 0;
                section.items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    sectionTotal += estimated;
                    const estimatedCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                    if (estimatedCell) estimatedCell.textContent = formatCurrency(toDisp(estimated));
                    const varianceCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                    if (varianceCell) {
                        varianceCell.textContent = formatCurrency(toDisp(variance));
                        varianceCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                    }
                });
                const sectionTotalEl = document.querySelector(`[data-section-total="${sectionName}"]`);
                if (sectionTotalEl) sectionTotalEl.textContent = formatCurrency(toDisp(sectionTotal));
            }
            checkOverBudget();
        }

        function handleUpdate(sectionName, itemId, field, value, description) {
            const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
            if (!item) return;
            let valueToSave = value;
            if (['rate', 'actual'].includes(field)) {
                const parsedValue = parseFloat(value) || 0;
                valueToSave = (displayCurrency === 'USD') ? convertCurrency(parsedValue, 'JMD') : parsedValue;
            } else if (field === 'quantity') valueToSave = parseFloat(value) || 0;
            else if (field === 'multiplier') { const parsed = parseFloat(value) || 1; valueToSave = parsed > 0 ? parsed : 1; }
            item[field] = valueToSave;
            pushToHistory(description);
            if (field !== 'description') updateCalculations();
        }

        function handleUndo() { if (historyIndex > 0) { historyIndex--; budget = JSON.parse(JSON.stringify(historyStack[historyIndex].budget)); saveBudget(); render(); } }
        function handleRedo() { if (historyIndex < historyStack.length - 1) { historyIndex++; budget = JSON.parse(JSON.stringify(historyStack[historyIndex].budget)); saveBudget(); render(); } }
        function handleCurrencyToggle() { displayCurrency = displayCurrency === 'JMD' ? 'USD' : 'JMD'; pushToHistory(`Switched currency to ${displayCurrency}`); render(); }
        
        function handleAddBlank(sectionName) {
            const newItem = { id: crypto.randomUUID(), ...initialLineItem };
            budget.sections[sectionName].items.push(newItem);
            pushToHistory(`Added 'New Item' to ${sectionName}`);
            const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
            if (tableBody) {
                tableBody.insertAdjacentHTML('beforeend', renderLineItem(newItem, sectionName));
                initializeDragAndDrop();
            }
            updateCalculations();
        }

        function handleAddExisting(sectionName, desc, unit, rate) {
            const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit: unit, multiplier: 1, rate: rate, actual: 0 };
            budget.sections[sectionName].items.push(newItem);
            pushToHistory(`Added '${desc}' to ${sectionName}`);
            const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
            if (tableBody) {
                tableBody.insertAdjacentHTML('beforeend', renderLineItem(newItem, sectionName));
                initializeDragAndDrop();
            }
            updateCalculations();
        }

        function handleRemoveItem(sectionName, itemId) {
            const itemIndex = budget.sections[sectionName].items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const itemName = budget.sections[sectionName].items[itemIndex].description;
                budget.sections[sectionName].items.splice(itemIndex, 1);
                pushToHistory(`Removed '${itemName}' from ${sectionName}`);
                const row = document.querySelector(`button[data-remove-item="${itemId}"]`).closest('tr');
                if (row) row.remove();
                updateCalculations();
            }
        }

        function handleToggleSection(sectionName) {
            const section = budget.sections[sectionName];
            section.isOpen = !section.isOpen;
            pushToHistory(`${section.isOpen ? 'Opened' : 'Closed'} section: ${sectionName}`);
            const content = document.querySelector(`[data-section-toggle="${sectionName}"]`).nextElementSibling;
            content.classList.toggle('hidden');
            const arrow = document.querySelector(`[data-section-toggle="${sectionName}"] .section-arrow`);
            arrow.innerHTML = section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>';
        }

        function handleDiscountChange(e) { 
            let value = parseFloat(e.target.value) || 0;
            if (value > 100) { value = 100; e.target.value = 100; } else if (value < 0) { value = 0; e.target.value = 0; }
            budget.discountPercentage = value; 
            pushToHistory('Updated Discount %'); updateCalculations(); 
        }
        
        function handleProjectNameChange(e) {
            const newName = e.target.value.trim();
            if (newName && newName !== currentProjectName) {
                if (getProjectList().includes(newName)) { alert(`A project named "${newName}" already exists.`); e.target.value = currentProjectName; return; }
                localStorage.removeItem(storageKeyPrefix + currentProjectName);
                const oldName = budget.projectName;
                budget.projectName = newName;
                pushToHistory(`Renamed project from '${oldName}' to '${newName}'`);
                render(); 
            }
        }
        
        function getFormattedDatePart() {
            const date = new Date();
            const dateFormat = getProjectDateFormat();
            const separator = getProjectNameSeparator();
            const pad = (num) => String(num).padStart(2, '0');
            
            let datePart;
            const M = pad(date.getMonth() + 1);
            const D = pad(date.getDate());
            const Y = date.getFullYear();

            if (dateFormat === 'MMDDYYYY') {
                datePart = `${M}${separator}${D}${separator}${Y}`;
            } else { // YYYYMMDD
                datePart = `${Y}${separator}${M}${separator}${D}`;
            }
            return datePart;
        }

        function handleNewProjectSelection(e) {
            const type = e.target.value;
            e.target.value = ""; 
            if (type === 'Duplicate') handleDuplicateProject();
            else if (type === 'Recover') showRecoveryModal();
            else if (type) handleNewProject(true, type); 
        }
        
        function handleDuplicateProject() {
            if (!budget) return;
            const newBudget = JSON.parse(JSON.stringify(budget));
            let baseName = newBudget.projectName.replace(/ \(Copy( \d+)?\)$/, "");
            let newName = `${baseName} (Copy)`;
            let i = 2;
            while(getProjectList().includes(newName)) { newName = `${baseName} (Copy ${i})`; i++; }
            newBudget.projectName = newName;
            Object.values(newBudget.sections).forEach(s => s.items.forEach(i => i.id = crypto.randomUUID()));
            budget = newBudget;
            pushToHistory(`Duplicated project to '${newName}'`);
            render();
        }
        
        function handleNewProject(doRender = true, type = 'Commercial') {
            const datePart = getFormattedDatePart();
            let newName = `Untitled ${type}`;
            let i = 1;
            let finalName = `${newName} ${datePart}`;
            while(getProjectList().includes(finalName)) { i++; finalName = `${newName} ${datePart} (${i})`; }
            budget = getDefaultBudget(finalName, type);
            pushToHistory(`Created new project '${finalName}'`);
            if(doRender) render();
        }

        // --- Drag & Drop (Logic) ---
        let draggedItem = null;
        function initializeDragAndDrop() {
            document.querySelectorAll('.draggable-row').forEach(row => {
                // 1. Disable dragging by default so inputs are editable
                row.draggable = false;

                // 2. Only enable drag if the user touches the "drag-handle"
                const handle = row.querySelector('.drag-handle');
                if(handle) {
                    const startDrag = () => { row.draggable = true; };
                    const endDrag = () => { row.draggable = false; };
                    
                    // Mouse events
                    handle.addEventListener('mousedown', startDrag);
                    handle.addEventListener('mouseup', endDrag);
                    handle.addEventListener('mouseleave', endDrag);
                    
                   // Touch events – THIS IS THE FIXED VERSION
				    handle.addEventListener('touchstart', (e) => {
			        	startDrag();
        				row.draggable = true;
        				row.classList.add('dragging');
					}, {passive: true});

				    handle.addEventListener('touchend', endDrag);
				    handle.addEventListener('touchcancel', endDrag);
		 }

                row.addEventListener('dragstart', (e) => { 
                    if(row.draggable) {
                        draggedItem = { id: e.target.dataset.itemId, section: e.target.dataset.section }; 
                        e.target.classList.add('dragging'); 
                        e.dataTransfer.effectAllowed = 'move'; 
                    } else {
                        // If draggable is false (clicked input), stop the drag immediately
                        e.preventDefault(); 
                    }
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault(); 
                    e.dataTransfer.dropEffect = 'move'; 
                    e.currentTarget.classList.add('drag-over');
                    const rect = e.currentTarget.getBoundingClientRect();
                    // Visual guide for where item will drop
                    if (e.clientY < rect.top + rect.height / 2) { 
                        e.currentTarget.style.borderTop = '3px solid #3b82f6'; 
                        e.currentTarget.style.borderBottom = 'none'; 
                    } else { 
                        e.currentTarget.style.borderTop = 'none'; 
                        e.currentTarget.style.borderBottom = '3px solid #3b82f6'; 
                    }
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const dropSection = e.currentTarget.closest('[data-section-body]').dataset.sectionBody;
                    const dropIndex = Array.from(e.currentTarget.parentNode.children).indexOf(e.currentTarget);
                    moveItem(draggedItem.id, draggedItem.section, dropSection, dropIndex);
                    resetDragStyles(e.currentTarget);
                });

                row.addEventListener('dragend', (e) => { 
                    e.target.classList.remove('dragging'); 
                    document.querySelectorAll('.drag-over').forEach(el => resetDragStyles(el)); 
                });
            });

            // Allow dropping into empty sections
            document.querySelectorAll('[data-section-body]').forEach(section => {
                section.addEventListener('dragover', (e) => { e.preventDefault(); });
                section.addEventListener('drop', (e) => { 
                    e.preventDefault(); 
                    if(draggedItem) {
                        moveItem(draggedItem.id, draggedItem.section, e.currentTarget.dataset.sectionBody, 0); 
                        resetDragStyles(e.currentTarget); 
                    }
                });
            });
        }
        function resetDragStyles(el) { el.classList.remove('drag-over'); el.style.borderTop = 'none'; el.style.borderBottom = 'none'; }
        function moveItem(itemId, fromSection, toSection, toIndex) {
            if (fromSection === toSection && toIndex === Array.from(document.querySelector(`[data-section-body="${fromSection}"]`).children).findIndex(row => row.dataset.itemId === itemId)) return;
            const fromItems = budget.sections[fromSection].items;
            const toItems = budget.sections[toSection].items;
            const item = fromItems.find(i => i.id === itemId);
            if (!item) return;
            fromItems.splice(fromItems.indexOf(item), 1);
            toItems.splice(toIndex, 0, item);
            pushToHistory(`Reordered item '${item.description}' from ${fromSection} to ${toSection}`);
            render();
        }

        // --- Settings & AI Handlers (Refactored) ---
        window.switchSettingsTab = function(tabName, btn) {
            editingGlobalItemIndex = -1;
            const buttons = btn.parentElement.children;
            for(let b of buttons) b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
            btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
            document.getElementById('settingsContent').innerHTML = renderSettingsContent(tabName);
            bindSettingsEvents(tabName);
        };

        function bindSettingsEvents(tabName) {
            if(tabName === 'general') { 
                document.getElementById('updateBtn')?.addEventListener('click', handleAppUpdate); 
                document.getElementById('dateFormatSelect')?.addEventListener('change', (e) => { setProjectDateFormat(e.target.value); });
                document.getElementById('separatorInput')?.addEventListener('input', (e) => { setProjectNameSeparator(e.target.value); });
            }
            else if (tabName === 'templates') { bindTemplateEvents(); }
            else if (tabName === 'database') { bindDatabaseEvents(); }
            else if (tabName === 'roadmap') { document.getElementById('toggleRoadmapDetailsBtn')?.addEventListener('click', (e) => { document.querySelectorAll('.roadmap-detail').forEach(el => el.classList.toggle('hidden')); e.target.textContent = e.target.textContent.includes('Expand') ? 'Collapse Details' : 'Expand Details'; }); }
            else if (tabName === 'ai') { bindAIEvents(); }
        }

        function bindAIEvents() {
            document.getElementById('aiProviderSelect')?.addEventListener('change', (e) => { setSelectedProvider(e.target.value); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
            document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => { saveStoredApiKey(getSelectedProvider(), document.getElementById('apiKeyInput').value.trim()); alert('API Key Saved'); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
        }

        function bindDatabaseEvents() {
            document.getElementById('addGlobalItemForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const desc = document.getElementById('dbDesc').value.trim();
                const unit = document.getElementById('dbUnit').value;
                const rate = parseFloat(document.getElementById('dbRate').value) || 0;
                if(desc) {
                    const items = getGlobalItems();
                    if (editingGlobalItemIndex > -1) { items[editingGlobalItemIndex] = { description: desc, unit, rate }; editingGlobalItemIndex = -1; } 
                    else { 
                        const existingIdx = items.findIndex(i => i.description.toLowerCase() === desc.toLowerCase());
                        if(existingIdx >= 0) items.splice(existingIdx, 1);
                        items.unshift({ description: desc, unit, rate }); 
                    }
                    saveGlobalItems(items);
                    window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
                }
            });
        }
        
        // --- v19.36: Template Logic ---
        function bindTemplateEvents() {
            // Dropdown selection
            document.getElementById('templateSelector')?.addEventListener('change', (e) => {
                editingTemplateId = e.target.value;
                tempTemplateData = null; // Clear unsaved changes
                window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
            });

            // Action Buttons
            document.getElementById('createTemplateBtn')?.addEventListener('click', () => {
                const isDefault = ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId);
                const suggestedName = isDefault ? `New ${editingTemplateId}` : '';
                const name = prompt("Enter new template name (e.g., 'Music Video'):", suggestedName);
                if (name) {
                    const allTemplates = getAllTemplates();
                    if(allTemplates[name]) return alert("Template name already exists.");
                    // Clone currently selected or default
                    const base = editingTemplateId ? allTemplates[editingTemplateId] : DEFAULT_TEMPLATES['Commercial'];
                    allTemplates[name] = JSON.parse(JSON.stringify(base));
                    allTemplates[name].projectName = `Untitled ${name} Project`;
                    saveAllTemplates(allTemplates);
                    editingTemplateId = name;
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            });

            document.getElementById('importTemplateBtn')?.addEventListener('click', () => {
                const jsonStr = prompt("Paste template JSON string here:");
                if(jsonStr) {
                    try {
                        const parsed = JSON.parse(jsonStr);
                        if(!parsed.sections) throw new Error("Invalid template format.");
                        const name = prompt("Name for this imported template:", "Imported Template");
                        if(name) {
                            const allTemplates = getAllTemplates();
                            allTemplates[name] = parsed;
                            saveAllTemplates(allTemplates);
                            editingTemplateId = name;
                            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                        }
                    } catch(e) { alert("Import Failed: " + e.message); }
                }
            });

            document.getElementById('exportTemplateBtn')?.addEventListener('click', () => {
                if(!editingTemplateId) return;
                const allTemplates = getAllTemplates();
                const data = JSON.stringify(allTemplates[editingTemplateId]);
                navigator.clipboard.writeText(data).then(() => alert("Template JSON copied to clipboard!")).catch(() => prompt("Copy this:", data));
            });

            document.getElementById('deleteTemplateBtn')?.addEventListener('click', () => {
                if(!editingTemplateId || ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId)) {
                    return alert("Cannot delete default templates.");
                }
                if(confirm(`Delete template "${editingTemplateId}"?`)) {
                    const allTemplates = getAllTemplates();
                    delete allTemplates[editingTemplateId];
                    saveAllTemplates(allTemplates);
                    editingTemplateId = 'Commercial';
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            });

            document.getElementById('saveTemplateChangesBtn')?.addEventListener('click', () => {
                if(isDefaultTemplate(editingTemplateId)) {
                    return alert("Cannot edit default templates directly. Please create a copy.");
                }
                if (tempTemplateData && editingTemplateId) {
                    const allTemplates = getAllTemplates();
                    allTemplates[editingTemplateId] = tempTemplateData;
                    saveAllTemplates(allTemplates);
                    alert("Template Saved!");
                    tempTemplateData = null;
                }
            });

            // Delegate events for the editor table
            const editorContainer = document.getElementById('templateEditorContainer');
            if(editorContainer) {
                // Initial render call v19.37 fix
                renderTemplateEditor(editorContainer);

                // Only allow edits if not default
                if(isDefaultTemplate(editingTemplateId)) return; 

                editorContainer.addEventListener('change', (e) => {
                    const target = e.target;
                    
                    // v19.44: Production Days Inputs
                    if (target.dataset.daysField) {
                         if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                         if(!tempTemplateData.days) tempTemplateData.days = { principal: 10, scouting: 5, preprod: 15 };
                         
                         const field = target.dataset.daysField;
                         tempTemplateData.days[field] = parseFloat(target.value) || 0;
                         
                         // Auto Calculate Quantities
                         recalculateTemplateQuantities(tempTemplateData);
                         
                         // Re-render to show updated quantities
                         renderTemplateEditor(editorContainer);
                         return;
                    }

                    if (target.dataset.templateField) {
                        if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                        
                        const field = target.dataset.templateField;
                        const val = target.value;
                        
                        if(target.dataset.templateId) { // Line Item
                            const section = tempTemplateData.sections[target.dataset.templateSection];
                            const item = section.items.find(i => i.id === target.dataset.templateId);
                            if(item) {
                                if(['quantity', 'rate', 'multiplier'].includes(field)) item[field] = parseFloat(val);
                                else item[field] = val;
                            }
                        } else { // Top Level
                            if(['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(field)) tempTemplateData[field] = parseFloat(val);
                        }
                    }
                });

                editorContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if(!btn) return;
                    if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));

                    if(btn.dataset.templateAddItem) {
                        const sectionName = btn.dataset.templateAddItem;
                        tempTemplateData.sections[sectionName].items.push({ id: crypto.randomUUID(), ...initialLineItem });
                        renderTemplateEditor(editorContainer);
                    } else if (btn.dataset.templateRemoveItem) {
                        const sectionName = btn.dataset.templateSection;
                        const itemId = btn.dataset.templateRemoveItem;
                        const idx = tempTemplateData.sections[sectionName].items.findIndex(i => i.id === itemId);
                        if(idx > -1) {
                            tempTemplateData.sections[sectionName].items.splice(idx, 1);
                            renderTemplateEditor(editorContainer);
                        }
                    } else if (btn.dataset.templateRemoveSection) {
                        const sectionName = btn.dataset.templateRemoveSection;
                        if(confirm("Delete section?")) {
                            delete tempTemplateData.sections[sectionName];
                            renderTemplateEditor(editorContainer);
                        }
                    } else if (btn.id === 'addTemplateSectionBtn') {
                        const name = prompt("New Section Name:");
                        if(name && !tempTemplateData.sections[name]) {
                            tempTemplateData.sections[name] = { isOpen: true, items: [] };
                            renderTemplateEditor(editorContainer);
                        }
                    }
                });
            }
        }
        
        // v19.44: Production Days Logic
        function recalculateTemplateQuantities(data) {
            if(!data.days) return;
            const { principal, scouting, preprod } = data.days;
            const totalRun = principal + scouting + preprod;
            const prepScout = scouting + preprod;
            
            // Regex for Full Run (Principal + Scout + Prep)
            const fullRunRegex = /(director|producer|camera|dp|operator|ac|gaffer|grip|mixer|sound|supervisor|manager|coordinator|pa|assistant)/i;
            // Regex for Prep + Scout
            const prepRegex = /(researcher|location|casting)/i;

            Object.values(data.sections).forEach(section => {
                section.items.forEach(item => {
                    // Only update if unit is 'Day'
                    if(item.unit !== 'Day') return;
                    
                    const desc = item.description.toLowerCase();
                    
                    if (fullRunRegex.test(desc)) {
                        item.quantity = totalRun;
                    } else if (prepRegex.test(desc)) {
                        item.quantity = prepScout;
                    }
                });
            });
        }

        function isDefaultTemplate(id) {
            return ['Commercial', 'Documentary', 'LiveStream'].includes(id);
        }

        // v19.36: Visual Template Editor Renderer
        function renderTemplateEditor(container) {
            if (!container) return; // v19.37 fix: Safety check
            const data = tempTemplateData || getAllTemplates()[editingTemplateId];
            if(!data) return;
            
            // v19.44: Init days if missing
            if (!data.days) data.days = { principal: 10, scouting: 5, preprod: 15 };

            const isReadOnly = isDefaultTemplate(editingTemplateId);
            const disabledAttr = isReadOnly ? 'disabled' : '';
            const readOnlyBanner = isReadOnly ? `<div class="mb-4 p-2 bg-yellow-50 text-yellow-800 text-xs border border-yellow-200 rounded flex items-center gap-2"><span class="font-bold">⚠ Default Template:</span> Read-only mode. Click "Clone / New" to create an editable copy.</div>` : '';

            let html = `
                ${readOnlyBanner}
                
                <!-- v19.44: Production Days Inputs -->
                <div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded">
                    <h3 class="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wide">Production Days Inputs</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-indigo-700 mb-1">Principal</label>
                            <input type="number" data-days-field="principal" value="${data.days.principal}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}">
                        </div>
                        <div>
                            <label class="block text-xs text-indigo-700 mb-1">Scouting</label>
                            <input type="number" data-days-field="scouting" value="${data.days.scouting}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}">
                        </div>
                        <div>
                            <label class="block text-xs text-indigo-700 mb-1">Pre-Prod</label>
                            <input type="number" data-days-field="preprod" value="${data.days.preprod}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}">
                        </div>
                    </div>
                    <p class="text-[10px] text-indigo-400 mt-2 italic">Updating these automatically adjusts quantities for standard roles (Director, Camera, etc).</p>
                </div>

                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded grid grid-cols-3 gap-4">
                    <div><label class="block text-xs font-bold text-gray-700">Contingency %</label><input type="number" aria-label="Template Contingency" step="0.1" value="${data.contingencyPercentage}" ${disabledAttr} data-template-field="contingencyPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100 text-gray-500' : ''}"></div>
                    <div><label class="block text-xs font-bold text-gray-700">Sales Tax %</label><input type="number" aria-label="Template Tax" step="0.1" value="${data.salesTaxPercentage}" ${disabledAttr} data-template-field="salesTaxPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100 text-gray-500' : ''}"></div>
                    <div><label class="block text-xs font-bold text-gray-700">Discount %</label><input type="number" aria-label="Template Discount" step="0.1" value="${data.discountPercentage}" ${disabledAttr} data-template-field="discountPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100 text-gray-500' : ''}"></div>
                </div>
            `;

            Object.entries(data.sections).forEach(([sectionName, section]) => {
                html += `
                <div class="mb-4 border rounded-lg overflow-hidden">
                    <div class="bg-gray-100 p-2 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-gray-700">${sectionName}</h3>
                        ${!isReadOnly ? `<button data-template-remove-section="${sectionName}" aria-label="Remove Section" class="text-red-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50 text-gray-500"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-center w-12">Qty</th><th class="p-2 text-left w-20">Unit</th><th class="p-2 text-right w-24">Rate</th><th class="w-8"></th></tr></thead>
                            <tbody>
                                ${section.items.map(item => `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="p-1"><input class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" value="${item.description}" ${disabledAttr} aria-label="Template Description" data-template-field="description" data-template-id="${item.id}" data-template-section="${sectionName}"></td>
                                    <td class="p-1"><input type="number" class="w-full bg-transparent text-center ${isReadOnly ? 'text-gray-500' : 'font-bold text-blue-600'}" value="${item.quantity}" ${disabledAttr} aria-label="Template Quantity" data-template-field="quantity" data-template-id="${item.id}" data-template-section="${sectionName}"></td>
                                    <td class="p-1">
                                        <select class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" ${disabledAttr} aria-label="Template Unit" data-template-field="unit" data-template-id="${item.id}" data-template-section="${sectionName}">
                                            <option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option>
                                        </select>
                                    </td>
                                    <td class="p-1"><input type="number" class="w-full bg-transparent text-right ${isReadOnly ? 'text-gray-500' : ''}" value="${item.rate}" ${disabledAttr} aria-label="Template Rate" data-template-field="rate" data-template-id="${item.id}" data-template-section="${sectionName}"></td>
                                    <td class="p-1 text-center">${!isReadOnly ? `<button data-template-remove-item="${item.id}" data-template-section="${sectionName}" aria-label="Remove Template Item" class="text-gray-400 hover:text-red-500">×</button>` : ''}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${!isReadOnly ? `<button data-template-add-item="${sectionName}" class="w-full p-2 text-center text-xs text-blue-500 hover:bg-blue-50">+ Add Line Item</button>` : ''}
                </div>`;
            });

            if (!isReadOnly) {
                html += `<button id="addTemplateSectionBtn" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 font-medium text-sm">Add New Section</button>`;
            }
            
            container.innerHTML = html;
        }
        
        window.editGlobalItem = function(index) { editingGlobalItemIndex = index; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
        window.cancelEditGlobalItem = function() { editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
        window.deleteGlobalItem = function(idx) { if (confirm("Remove item?")) { const items = getGlobalItems(); items.splice(idx, 1); saveGlobalItems(items); if(editingGlobalItemIndex === idx) editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); } };
        window.handleRestore = function(index) {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            const projectToRestore = trash.splice(index, 1)[0];
            if (projectToRestore) {
                delete projectToRestore.deletedTimestamp;
                localStorage.setItem(storageKeyPrefix + projectToRestore.projectName, JSON.stringify(projectToRestore));
                localStorage.setItem(trashKey, JSON.stringify(trash));
                loadBudget(projectToRestore.projectName);
                render();
            }
            closeModal('recoveryModal');
        };
        window.handlePermanentDelete = function(index) {
            if (confirm("Delete forever?")) { const trash = JSON.parse(localStorage.getItem(trashKey) || '[]'); trash.splice(index, 1); localStorage.setItem(trashKey, JSON.stringify(trash)); showRecoveryModal(); }
        }

        window.handleRestoreAll = function() {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            if (trash.length === 0) return;
            
            if (confirm(`Are you sure you want to restore all ${trash.length} projects?`)) {
                trash.forEach(project => {
                    delete project.deletedTimestamp;
                    localStorage.setItem(storageKeyPrefix + project.projectName, JSON.stringify(project));
                });
                localStorage.removeItem(trashKey);
                showRecoveryModal();
                render(); 
            }
        };

        window.handleDeleteAllTrash = function() {
            if (confirm("WARNING: This will permanently delete ALL projects in the trash.\n\nThis action cannot be undone. Are you sure?")) {
                localStorage.removeItem(trashKey);
                showRecoveryModal();
            }
        };

        async function handleAnalyzeBudget() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            const outputDiv = document.getElementById('aiAnalysisOutput');
            outputDiv.innerHTML = '<div class="text-blue-600 animate-pulse">Analyzing...</div>';
            const simplifiedBudget = { project: budget.projectName, totals: calculateTotals(budget.sections), sections: {} };
            for (const [name, sec] of Object.entries(budget.sections)) simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join(', ');
            const prompt = `You are a line producer. Analyze this budget JSON for a Jamaica/Intl project. 1. Missing roles/equip? 2. Rate anomalies (JMD)? 3. Risks? Budget Data: ${JSON.stringify(simplifiedBudget)}`;
            try { const response = await callUnifiedAI(provider, key, prompt); outputDiv.innerHTML = marked.parse(response); } catch (error) { outputDiv.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`; }
        }

        async function handleConsultantChat() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;
            const chatHistory = document.getElementById('aiChatHistory');
            chatHistory.innerHTML += `<div class="ai-message user">${message}</div>`;
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;
            const loadingMsg = document.createElement('div'); loadingMsg.className = 'ai-message assistant text-gray-400 italic'; loadingMsg.textContent = `Thinking (${provider})...`; chatHistory.appendChild(loadingMsg);
            try {
                const response = await callUnifiedAI(provider, key, `You are a film production consultant. Answer concisely: ${message}`);
                loadingMsg.innerHTML = marked.parse(response); loadingMsg.className = 'ai-message assistant';
            } catch (error) { loadingMsg.textContent = `Error: ${error.message}`; loadingMsg.classList.add('text-red-500'); }
        }

        function renderSettingsContent(tabName) {
            const currentDateFormat = getProjectDateFormat();
            const currentSeparator = getProjectNameSeparator();

            if (tabName === 'general') {
                return `<div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">Application Info</h3>
                        <p class="text-sm text-gray-700">Current Version: <strong>v${APP_VERSION}</strong></p>
                        <p class="text-sm text-gray-500 mt-1">Status: ${navigator.onLine ? '<span class="text-green-600 font-semibold">Online</span>' : '<span class="text-red-500 font-semibold">Offline</span>'}</p>
                    </div>
                    
                    <!-- New Project Naming Options -->
                    <div class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">Project Naming Preferences</h3>
                        <div>
                            <label for="dateFormatSelect" class="block text-xs font-semibold text-gray-600 mb-1">Date Format for New Projects</label>
                            <select id="dateFormatSelect" aria-label="Date Format" class="w-full text-sm p-2 border rounded">
                                <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD (Default)</option>
                                <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                            </select>
                        </div>
                         <div>
                            <label for="separatorInput" class="block text-xs font-semibold text-gray-600 mb-1">Date Separator Character</label>
                            <input type="text" id="separatorInput" aria-label="Date Separator" maxlength="1" value="${currentSeparator}" class="w-10 text-sm p-2 border rounded text-center">
                            <span class="text-xs text-gray-500 ml-2">Example: Untitled Project ${getFormattedDatePart()}</span>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-gray-800 mb-2">Updates</h3>
                        <p class="text-sm text-gray-600 mb-3">Check for the latest features.</p>
                        <div class="flex gap-4 items-center">
                            <button id="updateBtn" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900 text-sm font-medium transition-colors ${!navigator.onLine ? 'opacity-50 cursor-not-allowed' : ''}" ${!navigator.onLine ? 'disabled' : ''}>Check for Updates</button>
                            <button onclick="const btn=document.querySelector('#bmc-wbtn'); if(btn) btn.click(); else window.open('https://buymeacoffee.com/jaysonmy', '_blank');" class="bmc-btn text-sm">☕ Buy me a coffee</button>
                        </div>
                        <div id="updateStatusMsg" class="mt-2 text-xs font-semibold"></div>
                    </div>
                </div>`;
            } else if (tabName === 'templates') {
                const allTemplates = getAllTemplates();
                if(!editingTemplateId) editingTemplateId = 'Commercial';
                const options = Object.keys(allTemplates).map(k => `<option value="${k}" ${k === editingTemplateId ? 'selected' : ''}>${k}</option>`).join('');
                
                const isReadOnly = isDefaultTemplate(editingTemplateId);
                const disabledClass = isReadOnly ? 'opacity-50 cursor-not-allowed bg-gray-300' : 'bg-blue-600 hover:bg-blue-700';
                
                return `
                <div class="h-full flex flex-col">
                    <div class="mb-4 flex flex-wrap gap-2 items-center justify-between bg-gray-50 p-3 rounded-lg border">
                        <div class="flex items-center gap-2 flex-grow">
                            <label class="text-sm font-bold text-gray-700 whitespace-nowrap">Edit Template:</label>
                            <select id="templateSelector" aria-label="Select Template" class="p-2 border rounded text-sm bg-white shadow-sm flex-grow max-w-xs">${options}</select>
                        </div>
                        <div class="flex gap-2">
                            <button id="createTemplateBtn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center gap-1"><span class="text-base">+</span> Clone / New</button>
                            <button id="importTemplateBtn" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Import</button>
                            <button id="exportTemplateBtn" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Export</button>
                            <button id="deleteTemplateBtn" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 border border-red-200 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}" ${isReadOnly ? 'disabled' : ''}>Delete</button>
                        </div>
                    </div>
                    
                    <div id="templateEditorContainer" class="flex-grow overflow-y-auto border rounded-lg p-4 bg-white shadow-inner">
                        <!-- Content rendered by bindTemplateEvents -->
                    </div>
                    
                    <div class="mt-4 pt-3 border-t flex justify-end gap-3">
                        <p class="text-xs text-gray-400 self-center mr-auto">Changes are applied to NEW projects only.</p>
                        <button id="saveTemplateChangesBtn" class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${disabledClass}" ${isReadOnly ? 'disabled' : ''}>Save Changes</button>
                    </div>
                </div>
                `;
		} else if (tabName === 'ai') {
                const currentProvider = getSelectedProvider();
                let keyLink = '#';
                if(currentProvider === 'gemini') keyLink = 'https://aistudio.google.com/app/apikey';
                else if(currentProvider === 'openai') keyLink = 'https://platform.openai.com/api-keys';
                else if(currentProvider === 'xai') keyLink = 'https://console.x.ai/';
                else if(currentProvider === 'deepseek') keyLink = 'https://platform.deepseek.com/api_keys';
                
                // FIX: Sanitize key to prevent HTML breakage if key contains quotes
                const rawKey = getStoredApiKey(currentProvider) || '';
                const safeKey = rawKey.replace(/"/g, '&quot;');

                return `
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-bold text-indigo-800 mb-2">AI Configuration</h3>
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-indigo-600 mb-1">Active AI Provider</label>
                            <select id="aiProviderSelect" aria-label="AI Provider" class="w-full text-sm p-2 border rounded border-indigo-200">
                                <option value="gemini" ${currentProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                                <option value="openai" ${currentProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                                <option value="xai" ${currentProvider === 'xai' ? 'selected' : ''}>xAI</option>
                                <option value="deepseek" ${currentProvider === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                            </select>
                        </div>
                        <div class="mb-1">
                            <label class="block text-xs font-semibold text-indigo-600 mb-1">API Key</label>
                            <div class="flex gap-2 w-full">
                                <input type="password" id="apiKeyInput" aria-label="API Key" value="${safeKey}" placeholder="Enter API Key" class="flex-grow min-w-0 text-sm p-2 border rounded border-indigo-200 outline-none">
                                <button id="saveApiKeyBtn" class="flex-shrink-0 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-indigo-500 mt-1">Don't have a key? <a href="${keyLink}" target="_blank" class="underline font-bold">Get one here</a>.</p>
                    </div>
                </div>`;
            } else if (tabName === 'database') {
                const globalItems = getGlobalItems();
                const editItem = editingGlobalItemIndex > -1 ? globalItems[editingGlobalItemIndex] : null;
                return `<div class="space-y-4"><div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4"><p class="text-xs text-yellow-800">Saved items appear at the top of the "Add Item" list.</p></div><form id="addGlobalItemForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border ${editItem ? 'border-blue-300 bg-blue-50' : ''}"><div class="col-span-4 sm:col-span-5"><label class="block text-xs font-semibold text-gray-500 mb-1">Description</label><input type="text" id="dbDesc" aria-label="Description" class="w-full text-sm p-2 border rounded" required value="${editItem ? editItem.description : ''}"></div><div class="col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Unit</label><select id="dbUnit" aria-label="Unit" class="w-full text-sm p-2 border rounded"><option ${editItem?.unit === 'Day' ? 'selected' : ''}>Day</option><option ${editItem?.unit === 'Week' ? 'selected' : ''}>Week</option><option ${editItem?.unit === 'Flat' ? 'selected' : ''}>Flat</option></select></div><div class="col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Rate</label><input type="number" id="dbRate" aria-label="Rate" class="w-full text-sm p-2 border rounded" value="${editItem ? editItem.rate : ''}"></div><div class="col-span-2 sm:col-span-1 flex gap-1">${editItem ? `<button type="button" aria-label="Cancel" onclick="cancelEditGlobalItem()" class="w-full p-2 bg-gray-400 text-white rounded">x</button>` : ''}<button type="submit" aria-label="Save" class="w-full p-2 ${editItem ? 'bg-green-600' : 'bg-blue-600'} text-white rounded">${editItem ? '✓' : '+'}</button></div></form><div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-right">Rate</th><th class="p-2 text-center">Act</th></tr></thead><tbody>${globalItems.map((item, idx) => `<tr class="border-t hover:bg-gray-50 ${idx === editingGlobalItemIndex ? 'bg-blue-50' : ''}"><td class="p-2">${item.description}</td><td class="p-2 text-right">${formatCurrency(item.rate)}</td><td class="p-2 text-center"><button aria-label="Edit Item" class="text-blue-500 mr-2" onclick="editGlobalItem(${idx})">✎</button><button aria-label="Delete Item" class="text-red-400" onclick="deleteGlobalItem(${idx})">×</button></td></tr>`).join('')}</tbody></table></div></div>`;
          } else if (tabName === 'roadmap') {
                 // 1. Data Definition (Project 1 & 3 Combined)
                 const futureItems = [
                    "Full Firebase integration for real-time cloud syncing.",
                    "Enhance PDF export (include full breakdown table).",
                    "Verify icon scaling on iPad.",
                    "Add 'Dark Mode' toggle.",
                    "Refactor monolithic HTML into modular JS files.",
                    "Enhance AI with specific role-based agents."
                 ];

                 const recentItems = [
                    { v: "v19.46", t: "Current", d: "Fixed AI Settings UI (API Key quotes bug); Added input sanitization logic." },
                    { v: "v19.45", t: "Dec 8", d: "Renamed 'New' dropdown to 'File' (Desktop style menu)." },
                    { v: "v19.44", t: "Dec 8", d: "Fixed Offline 'Page Not Found'; Implemented Self-Contained Service Worker." }
                 ];

                 const archiveItems = [
                    { v: "v19.44", t: "Baseline", d: "Added 'Production Days' calculator; Bulk Restore; PWA Accessibility fixes." },
                    { v: "v19.40", t: "Stable PWA", d: "Restored missing logic (handleNewProject); Verified Netlify/GH Pages setup." },
                    { v: "v19.39", t: "Alpha", d: "Initial PWA Conversion (manifest.json, sw.js); Rewrite update logic." },
                    { v: "v19.38", t: "Templates", d: "Restored detailed default templates (Read-Only); Renamed to 'Clone / New'." },
                    { v: "v19.36", t: "Feature", d: "Template Manager (Create/Import/Export); LocalStorage templates." },
                    { v: "v19.32-35", t: "UI Polish", d: "Status bar scrolling; API Key layout fix; Mobile UI tweaks." }
                 ];

                 // 2. Helper function to generate list HTML
                 const renderList = (items) => items.map(i => 
                    `<li class="text-sm text-gray-700 mb-3">
                        <span class="font-bold text-blue-700">${i.v}</span> 
                        <span class="text-xs text-gray-500 font-mono">(${i.t})</span><br>
                        <span class="text-gray-600">${i.d}</span>
                    </li>`
                 ).join('');

                 // 3. Return the HTML structure
                 return `
                 <div class="space-y-6 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2 flex-shrink-0">
                        <h3 class="font-bold text-gray-800">Development Roadmap</h3>
                        <button id="toggleRoadmapDetailsBtn" class="text-xs text-blue-600 font-semibold hover:bg-blue-50 px-2 py-1 rounded border border-transparent hover:border-blue-100 transition-colors">Expand History</button>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto pr-2">
                        <div class="relative pl-6 border-l-2 border-gray-200 space-y-8 ml-2">
                            
                            <!-- Future Section -->
                            <div class="relative">
                                <div class="absolute -left-[31px] bg-white border-2 border-dashed border-purple-400 rounded-full w-4 h-4 mt-1.5 shadow-sm"></div>
                                <h4 class="text-md font-bold text-purple-800 mb-2">Upcoming Features</h4>
                                <ul class="space-y-2">
                                    ${futureItems.map(f => `<li class="flex items-start gap-2 text-sm text-gray-600"><span class="text-purple-400 mt-0.5">•</span> ${f}</li>`).join('')}
                                </ul>
                            </div>

                            <!-- Recent Updates -->
                            <div class="relative">
                                <div class="absolute -left-[33px] bg-blue-600 border-4 border-white shadow-md rounded-full w-6 h-6 mt-0"></div>
                                <h4 class="text-md font-bold text-blue-800 mb-2">Recent Updates (v19.44+)</h4>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 shadow-sm">
                                    <ul class="space-y-1">
                                        ${renderList(recentItems)}
                                    </ul>
                                </div>
                            </div>

                            <!-- Archive (Hidden by default) -->
                            <div class="relative roadmap-detail hidden transition-all duration-300">
                                <div class="absolute -left-[31px] bg-gray-400 border-2 border-white rounded-full w-4 h-4 mt-1.5"></div>
                                <h4 class="text-md font-bold text-gray-500 mb-2">Archive (v19.32 - v19.44)</h4>
                                <ul class="space-y-1 pl-1 opacity-75 border-t pt-2 mt-2">
                                    ${renderList(archiveItems)}
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                 </div>`;
            }
        }

        // --- Utils & Init ---
        function renderProjectManagement() {
            const container = document.getElementById('project-management-container');
            if(container) {
                // v19.36: Dynamic Template List in Dropdown
                const templates = getAllTemplates();
                const templateOptions = Object.keys(templates).map(k => `<option value="${k}">New ${k}</option>`).join('');
                
                // FIX: "File" button now uses 'appearance-none' to hide arrow and looks like a button
                container.innerHTML = `<div id="project-management" class="flex flex-wrap items-center justify-start gap-x-3 gap-y-2">
                <select id="projectLoader" aria-label="Load Project" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5">${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}</select>
                <div class="relative">
                    <select id="newProjectSelector" aria-label="File Menu" class="appearance-none px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold cursor-pointer text-center focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="" disabled selected>File</option>
                        ${templateOptions}
                        <option value="" disabled>---</option>
                        <option value="Duplicate">Duplicate Current</option>
                        <option value="Recover">Recover Deleted...</option>
                    </select>
                </div>
                <button id="deleteProjectBtn" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">Delete</button>
                <button id="currencyToggleBtn" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">To ${displayCurrency === 'JMD' ? 'USD' : 'JMD'}</button>
                
                <div class="flex flex-wrap items-center gap-x-3 gap-y-2 sm:border-l sm:border-gray-300 sm:pl-3">
                    <button id="exportXlsxBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Excel</button>
                    <button id="exportPdfBtn" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">PDF</button>
                    <div class="flex items-center"><input type="checkbox" id="pdfFitToPage" class="h-4 w-4 rounded"><label for="pdfFitToPage" class="ml-2 text-sm text-gray-600">Fit to Page</label></div>
                    <div class="flex items-center"><input type="checkbox" id="hideZeroQty" class="h-4 w-4 rounded"><label for="hideZeroQty" class="ml-2 text-sm text-gray-600">Hide Zero Qty</label></div>
                </div>
            </div>`;
            }
        }

        // --- Helper Functions (RESTORED) ---
        function makeInputDraggable(input) {
            if (!input || input.dataset.draggable === 'true') return;
            input.dataset.draggable = 'true';
            input.style.cursor = 'ew-resize';
            
            let startX, startVal;
            const onMove = (e) => { 
                const delta = e.clientX - startX; 
                input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
                input.dispatchEvent(new Event('input', {bubbles:true})); 
            };
            const onUp = () => { 
                document.removeEventListener('mousemove', onMove); 
                document.removeEventListener('mouseup', onUp); 
            };
            
            input.addEventListener('mousedown', (e) => { 
                if(input === document.activeElement) return; 
                startX = e.clientX; 
                startVal = parseFloat(input.value)||0; 
                document.addEventListener('mousemove', onMove); 
                document.addEventListener('mouseup', onUp); 
            });
        }

        function initializeInteractiveInputs() { 
            ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
                const el = document.getElementById(id);
                if(el) makeInputDraggable(el);
            });
        }
        
        function updateOnlineStatus() { 
            const isOnline = navigator.onLine;
            // Login Btn
            const btn = document.getElementById('loginBtn'); 
            if(btn) { 
                btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'status-online' : 'status-offline'}`; 
                btn.title = isOnline ? "Online" : "Offline"; 
            }
            // AI Btn
            const aiBtn = document.getElementById('openAiToolsBtn');
            if(aiBtn) {
                aiBtn.className = `p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200' : 'bg-red-100 border-red-200 text-red-800 cursor-not-allowed opacity-75'}`;
                if(!isOnline) aiBtn.title = "Offline - AI Unavailable";
            }
        }
        
        function handleLogin() { if (navigator.onLine && confirm("Simulate Login?")) alert("Logged in!"); }
        
        function exportToPdf() { 
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            doc.text(budget.projectName, 14, 22);
            doc.setFontSize(10);
            
            // Simple PDF Export
            let y = 30;
            Object.entries(budget.sections).forEach(([name, section]) => {
                if(y > 270) { doc.addPage(); y = 20; }
                doc.setFont(undefined, 'bold');
                doc.text(name, 14, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                section.items.forEach(item => {
                    if(document.getElementById('hideZeroQty').checked && (!item.quantity || item.quantity == 0)) return;
                    
                    const line = `${item.quantity} ${item.unit} - ${item.description}: $${item.rate}`;
                    doc.text(line, 14, y);
                    y += 5;
                    if(y > 280) { doc.addPage(); y = 20; }
                });
                y += 5;
            });
            doc.save(`${budget.projectName}.pdf`); 
        }
        
        function exportToXlsx() { 
            const wb = XLSX.utils.book_new(); 
            const ws = XLSX.utils.aoa_to_sheet([[budget.projectName]]); 
            XLSX.utils.book_append_sheet(wb, ws, "Budget"); 
            XLSX.writeFile(wb, `${budget.projectName}.xlsx`); 
        }

        async function handleAppUpdate() {
            if (!navigator.onLine) return alert("Offline");
            document.getElementById('updateStatusMsg').textContent = "Checking...";
            try {
                const html = await (await fetch(`${UPDATE_SOURCE_URL}?t=${Date.now()}`)).text();
                const ver = html.match(/const APP_VERSION = "([\d\.]+)";/)?.[1];
                if (ver && ver !== APP_VERSION && confirm(`Update to v${ver}?`)) {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], { type: 'text/html' })); a.download = `mooBudgetTool.html`; a.click();
                } else alert("Up to date.");
            } catch (e) { alert("Update failed."); }
        }

        function init() {
            displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
            let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
            if (!projectToLoad || !getProjectList().includes(projectToLoad)) projectToLoad = getProjectList()[0];
            projectToLoad ? loadBudget(projectToLoad) : handleNewProject(false);
            render();
            bindAppEventListeners();
        }

    
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
