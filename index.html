<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.52</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263/lucide.min.js">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
   <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // { updateViaCache: 'none' } forces the browser to check the server for a new sw.js
                // every time the page loads, ignoring the HTTP cache headers.
                navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                    .then(reg => {
                        console.log('SW registered:', reg.scope);
                        
                        // Check for updates immediately
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        console.log('New content is available; please refresh.');
                                        if(confirm("New Update Available (v19.53)! Reload now?")) {
                                            window.location.reload();
                                        }
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

    <style>
        /* --- Base & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
       body { 
    font-family: 'Inter', sans-serif; 
    padding-bottom: 50px; /* Space for sticky footer */
}

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- Layout & Responsiveness --- */
        @media (min-width: 768px) {
            .sticky-header { position: sticky; top: 1rem; z-index: 10; }
        }
        
        /* --- Form Elements --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }

        /* --- Modals & Transitions --- */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 0.2s ease-in-out; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #settingsModalContent, #aiToolsModalContent { transition: all 0.3s ease-in-out; }

/* --- v19.56 Editable Preview Styles --- */
.contenteditable-container {
    outline: none;
    min-height: 400px;
}
.contenteditable-container:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.contenteditable-container[contenteditable="true"] {
    cursor: text;
}

  /* --- Mobile Table Optimized (v19.52 Abbreviated) --- */
        @media (max-width: 768px) {
            .table-container { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
                padding-bottom: 20px;
            }
            
            table { min-width: 100%; width: auto; } /* Let it flow naturally */
            
            th, td { 
                white-space: nowrap; 
                padding: 8px 4px !important; /* Comfortable spacing */
                font-size: 12px; 
            }
            
            /* Input Reset */
            td input, td select { 
                width: 100% !important; 
                background: transparent; border: none; padding: 0; font-size: 12px;
            }

            /* Col 1: Avatar */
            th:nth-child(1), td:nth-child(1) { width: 40px; text-align: center; } 
            
            /* Col 2: Drag */
            th:nth-child(2), td:nth-child(2) { width: 30px; text-align: center; } 
            
            /* Col 3: Description */
            th:nth-child(3), td:nth-child(3) { 
                min-width: 100px; 
                max-width: 200px; /* Allow wrapping */
                white-space: normal; 
                line-height: 1.2;
            } 
            
            /* Col 4: Qty */
            th:nth-child(4), td:nth-child(4) { width: 35px; } 
            td:nth-child(4) input { text-align: center; }

            /* Col 5: Unit (Now Single Letter) */
            th:nth-child(5), td:nth-child(5) { width: 30px; text-align: center; } 
            /* The select is hidden (opacity 0) but clickable on top of the letter span */
            
            /* Col 6: Rate */
            th:nth-child(6), td:nth-child(6) { min-width: 60px; } 
            td:nth-child(6) input { text-align: right; }

            /* Financial Cols (Now Abbreviated!) */
            /* We can make these much smaller now */
            th:nth-child(7), td:nth-child(7), /* Est */
            th:nth-child(8), td:nth-child(8), /* Act */
            th:nth-child(9), td:nth-child(9)  /* Var */
            { width: 50px; text-align: right; font-size: 11px; } 
            
            /* Col 10: Actions */
            th:nth-child(10), td:nth-child(10) { width: 25px; } 
        }

        /* --- Drag Logic Fix --- */
        .drag-handle {
            touch-action: none !important; /* Critical: Stops page scrolling when dragging row */
            cursor: grab;
            padding: 8px 4px; /* Larger hit area */
            font-size: 16px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drag-handle:active { 
            cursor: grabbing; 
            color: #3b82f6; 
        }

/* --- SortableJS Visuals (Desktop & Mobile) --- */
        
        /* The Ghost: This is the empty space where the item will drop */
        .sortable-ghost {
            opacity: 1 !important;
        }
        .sortable-ghost td {
            background-color: #dbeafe !important; /* Light Blue Background */
            border-top: 2px dashed #2563eb !important; /* Blue Top Border */
            border-bottom: 2px dashed #2563eb !important; /* Blue Bottom Border */
            color: transparent !important; /* Hide text in the ghost */
        }
        .sortable-ghost td * {
            visibility: hidden; /* Hide contents in the ghost */
        }

        /* The Drag: This is the item floating under your finger/mouse */
        .sortable-drag {
            background: white !important;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2) !important;
            opacity: 0.95 !important;
            cursor: grabbing !important;
            display: table !important; /* Keep table row shape */
        }
        /* Ensure cells inside the floating drag item keep their width */
        .sortable-drag td {
            background: white !important;
        }
        /* --- SortableJS Visuals --- */
        .sortable-ghost {
            background-color: #dbeafe !important; /* Light Blue */
            border: 2px dashed #2563eb !important; /* Blue Dashed Border */
            opacity: 0.8 !important;
        }
        .sortable-drag {
            background-color: #ffffff !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            transform: scale(1.02);
            cursor: grabbing !important;
        }

        /* --- v19.50 Crew Styles v19.52 --- */
        .crew-wrapper {
            position: relative;
            display: inline-flex; 
            width: 28px;          
            height: 28px;         
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            z-index: 20;
        }

        .crew-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar.unassigned { background-color: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }
        .crew-avatar.assigned { background-color: #3b82f6; border: 2px solid #ffffff; }
        
       /* --- v19.50 Floating Popup v19.52 --- */
        .contact-popup {
            position: absolute;
            left: 10px; 
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: -1; 
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .group:hover .contact-popup {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @media (hover: hover) {
            .crew-wrapper:hover .contact-popup {
                opacity: 1 !important; 
                visibility: visible !important; 
                pointer-events: auto !important;
                left: 34px; 
                transform: translateY(-50%) scale(1);
                z-index: 50;
            }
        }

        .crew-wrapper.mobile-active .contact-popup { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important;
            left: 34px; 
            transform: translateY(-50%) scale(1);
            z-index: 50;
        }

        .contact-popup::before {
            content: '';
            position: absolute;
            left: -14px; 
            top: 0;
            bottom: 0;
            width: 14px;
            background: transparent;
            z-index: 0;
        }
        
        .contact-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease, filter 0.2s;
            text-decoration: none !important;
            border-bottom: none !important;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .contact-btn:hover { transform: scale(1.15); filter: brightness(1.1); }
        .contact-btn svg { width: 14px; height: 14px; fill: currentColor; }
        
        .btn-wa-call { background-color: #25D366; }
        .btn-wa-msg { background-color: #128C7E; }
        .btn-email { background-color: #3b82f6; }

        /* --- Status Bar Scrolling --- */
        .scrolling-text-wrapper {
            flex: 1; 
            min-width: 0; 
            overflow-x: auto; 
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .scrolling-text-wrapper::-webkit-scrollbar { 
            display: none; 
        }

        /* --- Drag and Drop --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

        /* --- UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }
        
        /* Roadmap Styles */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

        /* AI Chat Styles */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

        /* Coffee Button */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Print Hiding */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        
/* --- v19.32 Hide Floating BMC Widget on Mobile 19.52 ---  */
#bmac-btn-container, #bmc-wbtn {
            display: none !important; 
        }

/* --- v19.32 Hide Floating BMC Widget on Mobile 19.52 ---  */
#bmac-btn-container, #bmc-wbtn {
            display: none !important; 
        }

/* --- v19.53 Stages Feature CSS --- */
#stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
#stagesCarousel::-webkit-scrollbar { display: none; }
.stage-card { transition: transform 0.2s; }
.stage-drop-zone { min-height: 100px; }
.stage-draggable { transition: all 0.2s; touch-action: none; }
.stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
.nav-btn { user-select: none; }

/* --- v19.53 Mobile Description Fix & Search --- */
@media (max-width: 768px) {
    .mobile-desc-truncate {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        display: block;
    }
    /* Expand on focus so they can edit */
    .mobile-desc-truncate:focus {
        white-space: normal;
        overflow: visible;
        position: relative;
        z-index: 20;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-width: 150px;
    }
}

/* --- v19.56 Stages Document Cards Responsive --- */
@media (max-width: 640px) {
    .doc-card .absolute {
        opacity: 1 !important;
    }
}

/* --- v19.53 Mobile Description Fix --- */
@media (max-width: 768px) {
    /* Truncate text with ellipsis (...) */
    .mobile-desc-truncate {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        display: block;
    }
    
    /* Auto-expand when user taps to edit */
    .mobile-desc-truncate:focus {
        white-space: normal;
        overflow: visible;
        position: relative;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        min-width: 200px;
        border-radius: 4px;
        padding: 8px;
        margin: -4px; /* Offset padding */
        height: auto;
    }
}

/* --- v19.53 Sticky Headers & Summary Layout --- */
.sticky-th { position: sticky; top: 0; z-index: 20; background-color: #f9fafb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.sticky-section-header { position: sticky; top: 0; z-index: 30; background-color: #f3f4f6; border-bottom: 1px solid #e5e7eb; }
/* Adjustment for desktop where header is already sticky */
@media (min-width: 768px) { .sticky-section-header { top: 4rem; } .sticky-th { top: 7rem; } }
/* Summary Card Grids */
.summary-card { display: flex; flex-direction: column; justify-content: space-between; height: 100%; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid transparent; }

/* --- v19.53 Sticky Headers & Summary Layout --- */
/* 1. The Section Title Bar (Blue/Gray bar) */
.sticky-section-header { 
    position: sticky; 
    top: 0; 
    z-index: 30; 
    background-color: #f9fafb; 
    border-bottom: 1px solid #e5e7eb;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

/* 2. The Table Column Headers (Crew, Desc, etc.) */
.sticky-th { 
    position: sticky; 
    /* Mobile: Stick 45px down so it sits UNDER the Section Header */
    top: 43px; 
    z-index: 20; 
    background-color: #ffffff; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* Desktop Adjustments (If you have a sticky main nav) */
@media (min-width: 768px) { 
    .sticky-section-header { top: 0rem; } 
    .sticky-th { top: 43px; } 
}

/* --- v19.56 Edit Mode Focus --- */
#attachmentPreview[contenteditable="true"] {
    outline: none;
    cursor: text;
}

    </style>

</head>
<body class="bg-gray-100">

<div id="splash" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col gap-6">
    <img src="https://raw.githubusercontent.com/moollc/mooBudgetTool/main/assets/cow-192.png" alt="Moo" class="w-32 h-32 animate-pulse">
    <div class="text-3xl font-bold text-gray-800">Moo Budget Tool</div>
    <div class="text-sm text-gray-500">Loading production magicâ€¦</div>
</div>

<style>
    #splash { transition: opacity 0.6s ease-out; }
    #splash.fade-out { opacity: 0; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const splash = document.getElementById('splash');
        if (!splash) return;

        const minTime = 1200; 
        const start = performance.now();

        const tryRemove = () => {
            if (performance.now() - start >= minTime) {
                splash.classList.add('fade-out');
                setTimeout(() => splash.remove(), 600);
            } else {
                requestAnimationFrame(tryRemove);
            }
        };
        requestAnimationFrame(tryRemove);
    });
</script>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8"></div>
    <div id="global-modal-container"></div>
<footer class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm border-t border-gray-200 z-50 h-14 px-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
    <div class="max-w-7xl mx-auto h-full grid grid-cols-3 items-center">
        
        <div class="flex items-center gap-2 justify-start pl-2">
            <p class="font-regular text-gray-700 text-xs sm:text-sm">mBT <span class="font-normal text-gray-400 text-[10px] sm:text-xs">v19.53</span></p>
        </div>
        
        <div class="flex items-center justify-center gap-4">
            <button id="stagesFooterBtn" aria-label="Production Stages" class="w-10 h-10 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-full transition-colors flex items-center justify-center" title="Production Stages">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="7" x2="7" y1="3" y2="21"/><line x1="17" x2="17" y1="3" y2="21"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="7" y1="7" y2="7"/><line x1="3" x2="7" y1="17" y2="17"/><line x1="17" x2="21" y1="17" y2="17"/><line x1="17" x2="21" y1="7" y2="7"/></svg>
            </button>

            <button id="docsFooterBtn" aria-label="Production Documents" class="w-10 h-10 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors flex items-center justify-center relative" title="Call Sheets & Reports">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            </button>

            <button id="publishFooterBtn" aria-label="Publish" class="w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Publish">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>

            <button id="settingsBtn" aria-label="Settings" class="w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>

            <button id="footerCoffeeBtn" aria-label="Buy me a coffee" class="w-10 h-10 text-yellow-600 hover:text-yellow-700 hover:bg-yellow-50 rounded-full transition-colors flex items-center justify-center" title="Buy me a coffee">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
            </button>
        </div>

        <div class="hidden sm:block"></div>
    </div>
</footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="jaysonmy" data-description="Support me on Buy me a coffee!" data-message="Thanks for the coffee!" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18">
    </script>
	
    <script>
        /* --- v19.51 App Version v19.53 --- */
        const APP_VERSION = "19.53";
        
const ROADMAP_LOG = [
            "v19.53: Stages & UI Polish. Added 'Target Lock' balancing, 'Top Spenders' analysis, and 'Sync Days' automation. Implemented Sticky Headers for mobile and inverted the Summary Dashboard.",
            "v19.52: Cloud & Context. Added 'Publish' placeholder, 'Import File' menu, PDF/Excel landscape options, and AI context attachment.",
            "v19.50: Crew Profiles. Visual Avatars, Device Contact Import, WhatsApp integration."
        ];

        const UPDATE_SOURCE_URL = 'https://gist.githubusercontent.com/moollc/b31c0e4d1fb8b3f6de11beffb4b353a9/raw/gistfile1.txt';
        const storageKeyPrefix = 'prodBudget_v5_';
        const trashKey = `${storageKeyPrefix}trash`;
        const globalItemsKey = `${storageKeyPrefix}globalItems`; 
        const templatesKey = `${storageKeyPrefix}templates`;    

 let budget;
        let currentProjectName;
        /* --- v19.53 [Currency] - Dynamic Multi-Currency System --- */
        let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
        
        // Base Rates (Defaults if offline)
        let exchangeRates = {
            'USD': 1.0, 'JMD': 157.50, 'GBP': 0.79, 'CAD': 1.36, 'EUR': 0.92,
            'AUD': 1.52, 'NZD': 1.63, 'ZAR': 18.50, 'INR': 83.00, 'JPY': 150.00, 'CNY': 7.20
        };

        const FILM_CURRENCIES = [
            { code: 'JMD', label: 'ðŸ‡¯ðŸ‡² JMD' }, { code: 'USD', label: 'ðŸ‡ºðŸ‡¸ USD' },
            { code: 'GBP', label: 'ðŸ‡¬ðŸ‡§ GBP' }, { code: 'CAD', label: 'ðŸ‡¨ðŸ‡¦ CAD' },
            { code: 'EUR', label: 'ðŸ‡ªðŸ‡º EUR' }, { code: 'AUD', label: 'ðŸ‡¦ðŸ‡º AUD' },
            { code: 'NZD', label: 'ðŸ‡³ðŸ‡¿ NZD' }, { code: 'ZAR', label: 'ðŸ‡¿ðŸ‡¦ ZAR' },
            { code: 'INR', label: 'ðŸ‡®ðŸ‡³ INR' }, { code: 'CNY', label: 'ðŸ‡¨ðŸ‡³ CNY' },
            { code: 'JPY', label: 'ðŸ‡¯ðŸ‡µ JPY' }
        ];

        // Fetch Live Rates
        async function fetchExchangeRates() {
            if (!navigator.onLine) return;
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.rates) {
                        FILM_CURRENCIES.forEach(c => {
                            if (data.rates[c.code]) exchangeRates[c.code] = data.rates[c.code];
                        });
                        localStorage.setItem(`${storageKeyPrefix}rates`, JSON.stringify(exchangeRates));
                        if(typeof render === 'function') render(); 
                    }
                }
            } catch (e) {
                const cached = localStorage.getItem(`${storageKeyPrefix}rates`);
                if(cached) exchangeRates = JSON.parse(cached);
            }
        }

        /* --- v19.53 [Currency] - Logic --- */
        const getRate = (code) => exchangeRates[code] || 1;
        
        const convertFromBase = (amountInJMD, targetCurrency) => {
            const jmdRate = getRate('JMD');
            const targetRate = getRate(targetCurrency);
            return (amountInJMD / jmdRate) * targetRate;
        };

        const convertToBase = (amountInTarget, sourceCurrency) => {
            const jmdRate = getRate('JMD');
            const sourceRate = getRate(sourceCurrency);
            return (amountInTarget / sourceRate) * jmdRate;
        };

        const toDisp = (val) => convertFromBase(val, displayCurrency);

        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 7;
        let editingGlobalItemIndex = -1;
        
        let editingTemplateId = null; 
        let tempTemplateData = null;

        /* --- v19.52 v19.53 --- */
/* --- v19.53 [Rate Intelligence] - Added rateType default --- */
const initialLineItem = { 
    description: 'New Item', 
    quantity: 1, 
    unit: 'Day', 
    multiplier: 1, 
    rate: 0, 
    actual: 0,
    rateType: 'negotiable' 
};

/* v19.53 [Documents] - Default Data Structure --- */
const defaultCallSheet = {
    date: new Date().toISOString().split('T')[0],
    shootDay: "1",
    totalDays: "1",
    unitCall: "07:00",
    breakfast: "06:00",
    weather: "30Â°C, Sunny",
    hospital: "UHWI (876-927-1621)",
    nearestPolice: "Half Way Tree Station",
    locations: [
        { label: "Unit Base", name: "Base Camp", address: "123 Film Street" },
        { label: "Location 1", name: "Set A", address: "456 Action Ave" }
    ],
    schedule: [
        { scene: "1", set: "INT. OFFICE", desc: "Introduction", cast: "1, 2", pages: "2/8" }
    ],
    cast: [
        { id: 1, name: "Talent A", character: "HERO", pickup: "06:00", makeup: "06:30", set: "07:30" }
    ],
    notes: "No social media photos on set."
};

/* v19.53 [Documents] - Master Template Database (Fixed Icons) --- */
const DOCUMENT_TEMPLATES = [
    // Pre-Production
    { id: 'script', cat: 'Pre-Prod', label: 'Script', icon: 'ðŸ“', default: true },
    { id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: 'ðŸ“–', default: false },
    { id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: 'ðŸ”', default: true },
    { id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: 'ðŸŽ¬', default: true },
    { id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: 'ðŸŽ¨', default: false },
    { id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: 'âœ…', default: true },
    { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: 'ðŸ‘¤', default: false },
    { id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: 'ðŸŽ­', default: false },
    { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: 'ðŸ“…', default: false },
    { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: 'ðŸ—“ï¸', default: false },
    { id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: 'ðŸ“', default: false },
    { id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget/Cost Report', icon: 'ðŸ’°', default: true },
    { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: 'âš–ï¸', default: false },
    { id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: 'ðŸš€', default: false },

    // Production
    { id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: 'ðŸ“¢', default: true },
    { id: 'prodReport', cat: 'Production', label: 'Production Report', icon: 'ðŸ“Š', default: true },
    { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: 'ðŸŽ¬', default: false },
    { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: 'ðŸ’„', default: false },
    { id: 'propList', cat: 'Production', label: 'Prop List', icon: 'ðŸ”«', default: false },
    { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'ðŸ“ž', default: true },
    { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: 'ðŸš—', default: false },
    { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: 'ðŸ±', default: false },
    { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: 'ðŸ’µ', default: false },
    { id: 'po', cat: 'Production', label: 'Purchase Order', icon: 'ðŸ§¾', default: false },
    { id: 'timecard', cat: 'Production', label: 'Timecards', icon: 'â±ï¸', default: false },
    { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: 'ðŸ¤–', default: false },
    { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: 'ðŸŒ±', default: false },

    // Post-Production
    { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: 'ðŸ‘¾', default: false },
    { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: 'ðŸ“…', default: true },
    { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: 'ðŸ“¦', default: false },
    { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: 'ðŸ†', default: false },

    // Legal / Compliance
    { id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: 'ðŸ¤', default: true },
    { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: 'ðŸ ', default: true }, // Fixed Emoji
    { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: 'ðŸŽ¥', default: false },
    { id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: 'ðŸ“„', default: false },
    { id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: 'ðŸ›¡ï¸', default: false },
    { id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: 'âœï¸', default: false },
    { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: 'ðŸ˜·', default: false },
    { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: 'â­', default: false },
    { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'ðŸ“ž', default: true }
];

/* --- v19.54 Template System Foundation v19.55 --- */
// DO NOT initialize customTemplates here â€” budget is undefined at this point

// Helper: Get all available templates (built-in + custom)
// Safe to call anytime â€” handles missing budget gracefully
function getAllAvailableTemplates() {
    const builtIn = DOCUMENT_TEMPLATES.map(t => ({ ...t, isCustom: false }));
    const custom = (budget && Array.isArray(budget.customTemplates)) 
        ? budget.customTemplates.map(t => ({ ...t, isCustom: true }))
        : [];
    return [...builtIn, ...custom];
}

// Helper: Ensure customTemplates array exists on current budget
function ensureCustomTemplates() {
    if (!budget) return;
    if (!Array.isArray(budget.customTemplates)) {
        budget.customTemplates = [];
    }
}

// Helper: Save custom templates (call after modifications)
function saveCustomTemplates() {
    ensureCustomTemplates();
    saveBudget();
}

        /* --- v19.51 Helper Functions v19.52 --- */
        // Generate collision-resistant IDs for attachments
        function generateSafeId() {
            return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Abbreviate long filenames for UI display
        function getAbbreviatedName(name, maxLen = 25) {
            if (name.length <= maxLen) return name;
            const ext = name.split('.').pop();
            const base = name.substring(0, name.lastIndexOf('.'));
            const keep = maxLen - ext.length - 4; // "..." + ext
            return base.substring(0, keep) + '...' + ext;
        }

/* --- v19.56 File Size Formatter --- */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/* --- v19.56 Editable Attachment Support --- */
function isEditableAttachment(attachment) {
    if (!attachment || !attachment.previewContent) return false;
    const type = attachment.previewContent.type;
    return ['text', 'docx', 'xlsx', 'pdf'].includes(type);
}
        // ---------------------------------------------------------
        // State & Persistence
        // ---------------------------------------------------------

        const getGlobalItems = () => JSON.parse(localStorage.getItem(globalItemsKey) || '[]');
        const saveGlobalItems = (items) => localStorage.setItem(globalItemsKey, JSON.stringify(items));

        const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
        const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;

        const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
        const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
        
        const getProjectNameSeparator = () => {
            const val = localStorage.getItem(projectNameSeparatorKey);
            return val !== null ? val : '-'; 
        };
        const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

        function saveBudget() {
            try {
                if (!budget || !budget.projectName) return;
                localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(budget));
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                currentProjectName = budget.projectName;
            } catch (e) { console.error("Could not save budget", e); }
        }

/* --- v19.53 [Data] - Load Budget w/ AI Persistence --- */
function loadBudget(projectName) {
    try {
        const data = localStorage.getItem(storageKeyPrefix + projectName);
        if (data) { 
            budget = JSON.parse(data); 
            
            // v19.53: Ensure AI Context Structure
            if (!budget.aiContext) {
                budget.aiContext = {
                    saveHistory: true, // Auto-on by default
                    analysis: "",
                    chat: []
                };
            }

            // v19.53: Ensure Target Lock Structure
            if (!budget.targetLock) {
                budget.targetLock = {
                    enabled: false, totalCap: 0,
                    stages: {
                        'dev': { label: 'Development', ratio: 5, days: 0 },
                        'pre': { label: 'Pre-Production', ratio: 20, days: 0 },
                        'prod': { label: 'Production', ratio: 55, days: 0 },
                        'post': { label: 'Post-Production', ratio: 15, days: 0 },
                        'dist': { label: 'Distribution', ratio: 5, days: 0 }
                    }
                };
            }

            // Sanitize Data
            Object.values(budget.sections).forEach(section => {
                section.items.forEach(item => {
                    if (item.multiplier === undefined) item.multiplier = 1;
                });
            });

            historyStack = [{ budget: JSON.parse(JSON.stringify(budget)), description: 'Project Loaded', timestamp: new Date().toISOString()}];
            historyIndex = 0;
        } 
        else { handleNewProject(false); return; }
        currentProjectName = budget.projectName;
        localStorage.setItem(`${storageKeyPrefix}lastLoaded`, currentProjectName);
    } catch (e) { console.error("Could not load budget", e); handleNewProject(false); }
}

        const deleteProject = (projectName) => { 
            if (confirm(`Move project "${projectName}" to Recently Deleted?`)) {
                const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
                const projectData = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName));
                projectData.deletedTimestamp = new Date().toISOString();
                trash.push(projectData);
                localStorage.setItem(trashKey, JSON.stringify(trash));
                localStorage.removeItem(storageKeyPrefix + projectName); 
                init(); 
            } 
        };

        const getProjectList = () => Object.keys(localStorage)
            .filter(k => k.startsWith(storageKeyPrefix) && k !== `${storageKeyPrefix}lastLoaded` && k !== `${storageKeyPrefix}currency` && k !== trashKey && k !== globalItemsKey && k !== templatesKey && !k.includes('ApiKey') && !k.includes('selectedAiProvider') && !k.includes('projectDateFormat') && !k.includes('projectNameSeparator'))
            .map(k => k.substring(storageKeyPrefix.length))
            .sort();

        function pushToHistory(description) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            const snapshot = {
                budget: JSON.parse(JSON.stringify(budget)),
                description: description,
                timestamp: new Date().toISOString()
            };
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            saveBudget();
            renderStatusBar();
        }

        // ---------------------------------------------------------
        // AI Logic & Integration
        // ---------------------------------------------------------
        const geminiApiKeyStorage = `${storageKeyPrefix}geminiApiKey`;
        const openaiApiKeyStorage = `${storageKeyPrefix}openaiApiKey`;
        const xaiApiKeyStorage = `${storageKeyPrefix}xaiApiKey`;
        const deepseekApiKeyStorage = `${storageKeyPrefix}deepseekApiKey`;
        const aiProviderStorage = `${storageKeyPrefix}selectedAiProvider`;

        const getStoredApiKey = (provider) => {
            if (provider === 'gemini') return localStorage.getItem(geminiApiKeyStorage) || '';
            if (provider === 'openai') return localStorage.getItem(openaiApiKeyStorage) || '';
            if (provider === 'xai') return localStorage.getItem(xaiApiKeyStorage) || '';
            if (provider === 'deepseek') return localStorage.getItem(deepseekApiKeyStorage) || '';
            return '';
        };

        const saveStoredApiKey = (provider, key) => {
            if (provider === 'gemini') localStorage.setItem(geminiApiKeyStorage, key);
            if (provider === 'openai') localStorage.setItem(openaiApiKeyStorage, key);
            if (provider === 'xai') localStorage.setItem(xaiApiKeyStorage, key);
            if (provider === 'deepseek') localStorage.setItem(deepseekApiKeyStorage, key);
        };

        const getSelectedProvider = () => localStorage.getItem(aiProviderStorage) || 'gemini';
        const setSelectedProvider = (provider) => localStorage.setItem(aiProviderStorage, provider);

/* v19.53 [AI] - Robust API Call & Offline Check --- */
async function callUnifiedAI(provider, apiKey, prompt) {
    if (!navigator.onLine) throw new Error("You appear to be offline. Please check your connection.");
    
    // Inject Budget-First Persona
    const systemPrompt = "You are a Film Production Budgeting Expert. Prioritize analyzing the provided budget data. If asked about non-budget topics, answer briefly but pivot back to film production costs/logistics.";
    const finalPrompt = `${systemPrompt}\n\n${prompt}`;

    try {
        if (provider === 'gemini') {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
            });
            const json = await response.json(); // Safe parse
            if (!response.ok) throw new Error(json.error?.message || 'Gemini API Error');
            return json.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
        } 
        else if (['openai', 'xai', 'deepseek'].includes(provider)) {
            let baseUrl = 'https://api.openai.com/v1/chat/completions';
            let model = 'gpt-4o';
            if (provider === 'xai') { baseUrl = 'https://api.x.ai/v1/chat/completions'; model = 'grok-beta'; }
            else if (provider === 'deepseek') { baseUrl = 'https://api.deepseek.com/chat/completions'; model = 'deepseek-chat'; }
            
            const response = await fetch(baseUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: [{ role: "user", content: finalPrompt }] })
            });
            const json = await response.json(); // Safe parse
            if (!response.ok) throw new Error(json.error?.message || `${provider} API Error`);
            return json.choices?.[0]?.message?.content || "No response.";
        }
        throw new Error("Unknown provider selected.");
    } catch (e) {
        console.error("AI Call Failed:", e);
        throw new Error(e.message || "Network/API Error");
    }
}

        // ---------------------------------------------------------
        // Business Logic & Helpers
        // ---------------------------------------------------------
 
/* CHANGE */

       
const calculateItem = (item) => {
            const estimated = (item.quantity || 0) * (item.multiplier || 1) * (item.rate || 0);
            const variance = (item.actual || 0) - estimated;
            return { estimated, variance };
        };

        /* --- v19.53 [Currency] - Updated Formatting Logic --- */
        // Note: Old convertCurrency and toDisp removed here (moved to Step 1)
        
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: displayCurrency,
                maximumFractionDigits: 0 
            }).format(amount);
        };

        const formatAbbreviated = (num, currency) => {
            const val = Math.abs(num);
            // v19.53 Fix: Ensure symbol display matches selected currency
            const symbol = (0).toLocaleString('en-US', { style: 'currency', currency: currency }).replace(/0.00|0/g, '').trim();
            const sign = num < 0 ? "-" : "";
            
            if (val >= 1e9) return `${sign}${symbol}${(val / 1e9).toFixed(1)}B`;
            if (val >= 1e6) return `${sign}${symbol}${(val / 1e6).toFixed(1)}M`;
            if (val >= 1e3) return `${sign}${symbol}${(val / 1e3).toFixed(1)}K`;
            return formatCurrency(num);
        };

        const calculateTotals = (sections) => { 
            let subtotal = 0; 
            for (const sectionName in sections) { 
                subtotal += sections[sectionName]?.items.reduce((acc, item) => acc + calculateItem(item).estimated, 0) || 0; 
            } 
            return { subtotal }; 
        };

        const calculateActuals = (sections) => { 
            let actualTotal = 0; 
            for (const sectionName in sections) { 
                actualTotal += sections[sectionName]?.items.reduce((acc, item) => acc + parseFloat(item.actual || 0), 0) || 0; 
            } 
            return actualTotal; 
        };

        // ---------------------------------------------------------
        // Template Management
        // ---------------------------------------------------------
        
        const DEFAULT_TEMPLATES = {
            'Commercial': { projectName: `Untitled Commercial Project`, discountPercentage: 0, contingencyPercentage: 15, salesTaxPercentage: 15.0, sections: { 'Key Creatives & Agency': { isOpen: true, items: [ { id: 'c1', description: 'Director', quantity: 3, unit: 'Day', multiplier: 1, rate: 80000, actual: 0 }, { id: 'c2', description: 'Producer', quantity: 5, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c3', description: 'Agency Fee / Creative Director', quantity: 1, unit: 'Flat', multiplier: 1, rate: 250000, actual: 0 }, { id: 'c4', description: 'Lead Talent / On-Screen Host', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Production Staff': { isOpen: true, items: [ { id: 'c5', description: 'Production Manager / Fixer', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c6', description: 'Production Coordinator (PC)', quantity: 5, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'c7', description: 'Production Assistant', quantity: 2, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 } ] }, 'Camera Department': { isOpen: true, items: [ { id: 'c8', description: 'Director of Photography (DP)', quantity: 3, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'c9', description: 'Camera Operator', quantity: 3, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c10', description: '1st Assistant Camera (AC)', quantity: 3, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'c11', description: 'Camera Package (Sony FX6)', quantity: 3, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'c12', description: 'Lens Package (Cine Primes)', quantity: 1, unit: 'Week', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c13', description: 'Teleprompter & Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 } ] }, 'Electric & Grip': { isOpen: true, items: [ { id: 'c14', description: 'Gaffer', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c15', description: 'Key Grip', quantity: 3, unit: 'Day', multiplier: 1, rate: 45000, actual: 0 }, { id: 'c16', description: 'Lighting & Grip Package (Van)', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 } ] }, 'Sound Department': { isOpen: true, items: [ { id: 'c17', description: 'Production Sound Mixer', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c18', description: 'Sound Package (Mixer, Mics, Boom)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Art Department & Wardrobe': { isOpen: true, items: [ { id: 'c19', description: 'Art Director / Stylist', quantity: 4, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c20', description: 'Props & Wardrobe Purchase/Rental', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c21', description: 'Key Hair & Makeup Artist', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Locations & Production Expenses': { isOpen: true, items: [ { id: 'c22', description: 'Location Fees (Office, etc)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c23', description: 'Catering (15 people, per day)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c24', description: 'Transportation (Van & Driver)', quantity: 3, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'c25', description: 'Editor', quantity: 8, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c26', description: 'Motion Graphics Artist', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c27', description: 'Colorist', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c28', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c29', description: 'Music Licensing (Stock)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'c30', description: 'Film Registration Fee (JAMPRO)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 14400, actual: 0 }, { id: 'c31', description: 'Legal Review', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c32', description: 'Production Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 144000, actual: 0 } ] } } },
            'Documentary': { projectName: `Untitled Documentary Project`, discountPercentage: 0, contingencyPercentage: 10, salesTaxPercentage: 15.0, sections: { 'Pre-Production | Research': { isOpen: true, items: [ { id: 'd1', description: 'Producer / Director (Development)', quantity: 20, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd2', description: 'Archival Researcher', quantity: 10, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'd3', description: 'Research & Travel', quantity: 1, unit: 'Flat', multiplier: 1, rate: 90000, actual: 0 } ] }, 'Production (2-Cam Setup)': { isOpen: true, items: [ { id: 'd4', description: 'Director', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd5', description: 'Director of Photography', quantity: 20, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'd6', description: 'Camera Operator (B-Cam)', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd7', description: 'Production Sound Mixer', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd8', description: 'Production Assistant', quantity: 20, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'd9', description: 'Camera Package (Sony FX6) - A Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd10', description: 'Camera Package (Sony FX6) - B Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd11', description: 'Sound Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'd12', description: 'Lighting & Grip Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd13', description: 'Travel & Accommodation', quantity: 1, unit: 'Flat', multiplier: 1, rate: 450000, actual: 0 }, { id: 'd14', description: 'Meals & Per Diems', quantity: 1, unit: 'Flat', multiplier: 1, rate: 240000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'd15', description: 'Editor', quantity: 60, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd16', description: 'Assistant Editor / Logger', quantity: 40, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'd17', description: 'Transcription Services', quantity: 20, unit: 'Hour', multiplier: 1, rate: 4500, actual: 0 }, { id: 'd18', description: 'Archival Footage Licensing', quantity: 1, unit: 'Flat', multiplier: 1, rate: 300000, actual: 0 }, { id: 'd19', description: 'Colorist', quantity: 8, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd20', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 200000, actual: 0 }, { id: 'd21', description: 'Composer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 225000, actual: 0 } ] }, 'Marketing & Distribution': { isOpen: true, items: [ { id: 'd22', description: 'Festival Submission Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 75000, actual: 0 }, { id: 'd23', description: 'Publicist Retainer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 150000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'd24', description: 'Legal Fees (Contracts, Clearances)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 180000, actual: 0 }, { id: 'd25', description: 'E&O Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 210000, actual: 0 }, { id: 'd26', description: 'Bookkeeping', quantity: 1, unit: 'Flat', multiplier: 1, rate: 60000, actual: 0 } ] } } },
            'LiveStream': { projectName: `Untitled Live Stream Project`, discountPercentage: 0, contingencyPercentage: 20, salesTaxPercentage: 15.0, sections: { 'Pre-Production': { isOpen: true, items: [ { id: 'l1', description: 'Technical Director (Planning)', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l2', description: 'Producer (Coordination)', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Live Production Crew': { isOpen: true, items: [ { id: 'l3', description: 'Technical Director (Switcher)', quantity: 1, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'l4', description: 'Stream Engineer', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l5', description: 'Graphics Operator (CG)', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l6', description: 'Camera Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l7', description: 'Audio Engineer (A1)', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l8', description: 'A/V Technician / Utility', quantity: 1, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Live Production Equipment': { isOpen: true, items: [ { id: 'l9', description: 'Manned Broadcast Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l10', description: 'Robotic PTZ Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l11', description: 'Video Switcher (ATEM Mini Extreme)', quantity: 1, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'l12', description: 'Audio Mixer & Mics Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'l13', description: 'Intercom System (Comms)', quantity: 1, unit: 'Day', multiplier: 1, rate: 10500, actual: 0 }, { id: 'l14', description: 'Lighting Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l15', description: 'Internet / Bonded Cellular', quantity: 1, unit: 'Day', multiplier: 1, rate: 36000, actual: 0 }, { id: 'l16', description: 'Live Streaming Platform Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'l17', description: 'Minor Edits & Re-uploads', quantity: 1, unit: 'Flat', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'l18', description: 'Production Insurance (Live Event)', quantity: 1, unit: 'Policy', multiplier: 1, rate: 180000, actual: 0 } ] } } }
        };

        const getAllTemplates = () => {
            const stored = localStorage.getItem(templatesKey);
            let templates;
            
            if (stored) {
                try {
                    templates = JSON.parse(stored);
                    templates['Commercial'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Commercial']));
                    templates['Documentary'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Documentary']));
                    templates['LiveStream'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['LiveStream']));
                } catch(e) {
                    templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
                }
            } else {
                templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
            }
            
            localStorage.setItem(templatesKey, JSON.stringify(templates));
            return templates;
        };

        const saveAllTemplates = (templates) => localStorage.setItem(templatesKey, JSON.stringify(templates));

        /* --- Updated Data Structure (v19.53) --- */
const getDefaultBudget = (name, type = 'Commercial') => {
    const allTemplates = getAllTemplates();
    let template = allTemplates[type] ? JSON.parse(JSON.stringify(allTemplates[type])) : JSON.parse(JSON.stringify(allTemplates['Commercial']));
    
    template.projectName = name;
    
    // NEW: The Target Lock Engine Data
    template.targetLock = {
        enabled: false,
        totalCap: 0,
        currency: 'JMD',
        stages: {
            'development': { id: 'dev', label: 'Development', ratio: 5, locked: false, limit: 0 },
            'preProduction': { id: 'pre', label: 'Pre-Production', ratio: 20, locked: false, limit: 0 },
            'production': { id: 'prod', label: 'Production', ratio: 55, locked: false, limit: 0 },
            'postProduction': { id: 'post', label: 'Post-Production', ratio: 15, locked: false, limit: 0 },
            'distribution': { id: 'dist', label: 'Distribution', ratio: 5, locked: false, limit: 0 }
        }
    };

    if(template.sections) {
        Object.values(template.sections).forEach(s => s.items.forEach(i => { 
            i.id = crypto.randomUUID(); 
            if(i.multiplier === undefined) i.multiplier = 1; 
            // NEW: Prepare items to be assigned to a stage later
            i.assignedStage = 'production'; 
        }));
    }
    return template;
};

       // ---------------------------------------------------------
        // UI Rendering
        // ---------------------------------------------------------
        
        function createModal(id, title, contentHtml, maxWidth = 'max-w-2xl') {
            const container = document.getElementById('global-modal-container');
            const modalId = `${id}Modal`;
            let modal = document.getElementById(modalId);
            const fullHtml = `<div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden"><div id="${modalId}Content" class="bg-white rounded-lg shadow-xl w-full ${maxWidth} mx-auto max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95"><div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"><h2 class="text-xl font-bold text-gray-800">${title}</h2><button onclick="closeModal('${modalId}')" aria-label="Close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div><div class="overflow-y-auto flex-grow" id="${modalId}Body">${contentHtml}</div></div></div>`;
            if (modal) modal.remove(); 
            container.insertAdjacentHTML('beforeend', fullHtml);
            modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); }, 10);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modalId); });
            return modal;
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('opacity-0');
            document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            if(modalId === 'settingsModal') { editingGlobalItemIndex = -1; tempTemplateData = null; }
        };

        function renderStatusBar() {
            const container = document.getElementById('statusBar');
            if (!container) return;
            const lastAction = historyStack[historyIndex];
            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < historyStack.length - 1;
            const message = lastAction?.description || 'No recent changes.';
            container.innerHTML = `<div id="statusMsgWrapper" class="scrolling-text-wrapper"><span id="statusBarMessage" class="font-medium px-1">${message}</span></div><div class="flex items-center flex-shrink-0 pl-2 border-l border-blue-200 ml-2"><button id="undoBtn" class="px-2 py-1 rounded-md text-sm font-semibold ${canUndo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canUndo ? 'disabled' : ''}>Undo</button><button id="redoBtn" class="ml-2 px-2 py-1 rounded-md text-sm font-semibold ${canRedo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canRedo ? 'disabled' : ''}>Redo</button></div>`;
        }

/* --- P2 --- */

/* --- v19.52 v19.53 --- */
/* --- v19.53 Responsive Alignment & Mobile Truncation --- */
function renderLineItem(item, sectionName) {
    // 1. Detect Mobile
    const isMobile = window.innerWidth < 768;

    // 2. Formatting Helpers (Abbreviate on Mobile)
    const formatMoney = (val) => isMobile ? formatAbbreviated(val, displayCurrency) : formatCurrency(toDisp(val));
    const rateDisp = toDisp(item.rate);
    const actualDisp = toDisp(item.actual);
    const multiplierValue = item.multiplier !== 1 ? item.multiplier : 1;
    
    // 3. Crew & Role Logic
    const crew = item.crew || {};
    const hasAssignedCrew = !!crew.name;
    const isRoleMatch = ['director', 'dp', 'producer', 'manager', 'sound'].some(role => item.description.toLowerCase().includes(role));
    
    let initials = '?';
    let avatarClass = 'unassigned';
    let titleText = 'Unassigned';

    if (hasAssignedCrew) {
        initials = crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        avatarClass = 'assigned'; 
        titleText = crew.name;
    } else if (isRoleMatch) {
        initials = item.description.substring(0, 2).toUpperCase();
        avatarClass = 'assigned opacity-75'; 
        titleText = 'Role Detected';
    }

    // 4. Unit Logic (Color Coded)
    const unitLetter = item.unit.charAt(0).toUpperCase(); 
    const unitColors = {
        'Day': 'bg-blue-100 text-blue-700 border-blue-200',
        'Week': 'bg-indigo-100 text-indigo-700 border-indigo-200',
        'Flat': 'bg-emerald-100 text-emerald-700 border-emerald-200',
        'Hour': 'bg-purple-100 text-purple-700 border-purple-200',
        'Policy': 'bg-orange-100 text-orange-800 border-orange-200'
    };
    const unitClass = unitColors[item.unit] || 'bg-gray-100 text-gray-700 border-gray-200';

    // 5. Rate Identifier Logic
    const rType = item.rateType || 'negotiable'; 
    const isLocked = rType === 'fixed';
    const rateIcon = isLocked ? 'ðŸ”’' : 'ðŸ¤';
    const rateTitle = isLocked ? 'Fixed Rate (Hard Limit)' : 'Negotiable Rate (Soft Cost)';
    const rateBtnClass = isLocked ? 'text-red-500 bg-red-50 border-red-200' : 'text-green-600 bg-green-50 border-green-200';

    // 6. Contact Buttons
    const cleanPhone = crew.phone ? crew.phone.replace(/[^0-9]/g, '') : '';
    const waCallBtn = cleanPhone ? `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-call"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></a>` : '';
    const waMsgBtn = cleanPhone ? `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-msg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>` : '';
    const emailBtn = crew.email ? `<a href="mailto:${crew.email}" class="contact-btn btn-email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>` : '';

    return `<tr class="draggable-row border-b hover:bg-gray-100 group" data-item-id="${item.id}" data-section="${sectionName}">
        <td class="p-1 w-12 text-center relative">
            <div class="crew-wrapper">
                <div class="crew-avatar ${avatarClass}" onclick="toggleCrewPopup(this, event)" ondblclick="openCrewProfile(this, event, '${item.id}', '${sectionName}')" title="${titleText}">${initials}</div>
                <div class="contact-popup">
                    ${waCallBtn} ${waMsgBtn} ${emailBtn}
                    <button onclick="openCrewProfile(this, event, '${item.id}', '${sectionName}')" class="contact-btn bg-gray-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></button>
                </div>
            </div>
            <input type="hidden" data-field="multiplier" data-id="${item.id}" data-section="${sectionName}" value="${multiplierValue}" />
        </td>

        <td class="p-2 text-center text-gray-400 cursor-grab drag-handle touch-none select-none hover:text-blue-500 w-8">â ¿</td>

        <td class="p-2">
            <input type="text" aria-label="Description" data-field="description" data-id="${item.id}" data-section="${sectionName}" value="${item.description}" class="w-full bg-transparent p-1 rounded-md mobile-desc-truncate" />
        </td>
        
        <td class="p-2 text-center md:w-16"><input type="number" aria-label="Quantity" data-field="quantity" data-id="${item.id}" data-section="${sectionName}" value="${item.quantity}" class="w-full bg-transparent p-1 rounded-md text-center" /></td>
        
        <td class="p-2 relative md:w-20">
            <span class="md:hidden absolute inset-0 m-auto w-6 h-6 flex items-center justify-center rounded text-xs font-bold pointer-events-none ${unitClass}">${unitLetter}</span>
            <select aria-label="Unit" data-field="unit" data-id="${item.id}" data-section="${sectionName}" class="w-full text-center text-xs font-semibold rounded px-1 py-1 appearance-none cursor-pointer border ${isMobile ? 'opacity-0' : unitClass}">
                <option class="bg-blue-100 text-blue-700 font-semibold" ${item.unit === 'Day' ? 'selected' : ''}>Day</option>
                <option class="bg-indigo-100 text-indigo-700 font-semibold" ${item.unit === 'Week' ? 'selected' : ''}>Week</option>
                <option class="bg-emerald-100 text-emerald-700 font-semibold" ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option>
                <option class="bg-orange-100 text-orange-800 font-semibold" ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option>
                <option class="bg-purple-100 text-purple-700 font-semibold" ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option>
            </select>
        </td>
        
        <td class="p-2 text-left flex items-center justify-start gap-1 md:w-32">
            <button onclick="toggleRateType('${item.id}', '${sectionName}')" class="w-7 h-7 rounded flex items-center justify-center text-sm border ${rateBtnClass} hover:scale-110 transition-transform flex-shrink-0" title="${rateTitle}">${rateIcon}</button>
            <input type="number" step="0.01" aria-label="Rate" data-field="rate" data-id="${item.id}" data-section="${sectionName}" value="${rateDisp.toFixed(2)}" class="w-full bg-transparent p-1 rounded-md text-left font-mono" />
        </td>
        
        <td data-estimated-id="${item.id}" class="p-2 text-left font-medium text-gray-700 md:w-28 font-mono">${formatMoney(calculateItem(item).estimated)}</td>
        
        <td class="p-2 text-left md:w-28"><input type="number" step="0.01" aria-label="Actual Cost" data-field="actual" data-id="${item.id}" data-section="${sectionName}" value="${actualDisp.toFixed(2)}" class="w-full bg-blue-50 p-1 rounded-md text-left font-mono" /></td>
        
        <td data-variance-id="${item.id}" class="p-2 text-right font-medium text-xs md:w-28 font-mono">${formatMoney(calculateItem(item).variance)}</td>
        
        <td class="p-2 text-center w-10"><button aria-label="Remove Item" data-remove-item="${item.id}" data-section="${sectionName}" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>
    </tr>`;
}

/* --- v19.53 [Interaction] - Toggle Rate Type --- */
window.toggleRateType = function(itemId, sectionName) {
    const item = budget.sections[sectionName].items.find(i => i.id === itemId);
    if (!item) return;
    const current = item.rateType || 'negotiable';
    item.rateType = (current === 'negotiable') ? 'fixed' : 'negotiable';
    pushToHistory(`Changed ${item.description} to ${item.rateType}`);
    render(); 
};


       /* --- v19.52 v19.53 --- */
/* --- v19.53 Responsive Headers (Stable Size, Text Wrap) --- */
function renderBudgetSections() {
    return Object.entries(budget.sections).map(([sectionName, section]) => `
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="relative rounded-t-lg min-h-[44px] px-3 py-2 flex justify-between items-center cursor-pointer bg-gray-50 select-none" data-section-toggle="${sectionName}">
            <h2 class="text-sm font-bold text-gray-800 uppercase tracking-wide leading-tight mr-2">${sectionName}</h2>
            <span data-section-total="${sectionName}" class="text-sm font-bold text-blue-600 font-mono flex-shrink-0"></span>
        </div>
        
        <div class="section-content rounded-b-lg ${section.isOpen ? '' : 'hidden'}">
            <div class="p-0 table-container">
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-white text-gray-500 font-medium border-b border-gray-100">
                        <tr>
                            <th class="p-2 text-center w-12">Crew</th>
                            <th class="p-2 w-8"></th> 
                            <th class="p-2 text-left min-w-[200px]">Description</th>
                            <th class="p-2 text-center md:w-16">Qty</th>
                            <th class="p-2 text-center md:w-20">Unit</th>
                            <th class="p-2 text-left md:w-32">Rate</th>
                            <th class="p-2 text-left md:w-28">Est</th>
                            <th class="p-2 text-left md:w-28">Act</th>
                            <th class="p-2 text-right md:w-28">Var</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody data-section-body="${sectionName}">
                        ${section.items.map(item => renderLineItem(item, sectionName)).join('')}
                    </tbody>
                </table>
            </div>
            <div class="p-1 bg-gray-50 border-t border-gray-100 rounded-b-lg">
                <button data-add-item="${sectionName}" class="w-full py-1 text-center text-blue-500 font-bold text-xs hover:bg-blue-50 hover:text-blue-700 transition-colors uppercase tracking-wider">
                    + Add Line Item
                </button>
            </div>
        </div>
    </div>`).join('');
}

/* --- v19.53 Main Render (Summary Rework) --- */
function render() {
    const appContainer = document.getElementById('app');
    if (!budget || !appContainer) return;
    const activeElement = document.activeElement;
    const activeElementId = activeElement ? activeElement.id : null;
    const activeElementDataId = activeElement ? activeElement.dataset.id : null;
    const activeElementDataField = activeElement ? activeElement.dataset.field : null;
    
    appContainer.innerHTML = `
    <header class="mb-4 flex flex-wrap items-center justify-between gap-y-4">
        <div class="flex items-center gap-3 w-full md:w-auto flex-grow mr-4">
            <input type="text" id="projectName" aria-label="Project Name" value="${budget.projectName}" class="text-xl sm:text-3xl md:text-4xl font-bold text-gray-800 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-2 rounded-lg" />
            <button id="loginBtn" aria-label="Connection Status" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0" title="Check connection">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
        </div>
        <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
    </header>

    <div class="mt-2 flex gap-2 overflow-hidden mb-4">
        <button id="openAiToolsBtn" aria-label="AI Assistant" class="p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0" title="AI Assistant">âœ¨</button>
        <div id="statusBar" class="flex-grow p-2 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 flex justify-between items-center overflow-hidden"></div>
    </div>

    <div id="summary" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div class="bg-blue-600 text-white p-4 rounded-xl shadow-md flex flex-col justify-center items-center sm:items-start relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                    <svg width="150" height="150" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>
                </div>
                <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">Estimated Grand Total</p>
                <p id="summaryGrandTotal" class="text-3xl sm:text-4xl font-bold tracking-tight"></p>
            </div>
            <div class="bg-green-600 text-white p-4 rounded-xl shadow-md flex flex-col justify-center items-center sm:items-start relative overflow-hidden">
                <p class="text-green-100 text-xs font-bold uppercase tracking-wider mb-1">Actual Total Cost</p>
                <p id="summaryActualTotal" class="text-3xl sm:text-4xl font-bold tracking-tight"></p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <div class="summary-card bg-red-50 border-red-100">
                <div class="flex justify-between items-start mb-1">
                    <label for="discountPercentage" class="font-semibold text-red-800">Discount</label>
                    <div class="flex items-center bg-white px-1 rounded border border-red-200">
                        <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-xs font-bold text-red-600 outline-none" min="0" max="100">%
                    </div>
                </div>
                <p id="summaryDiscount" class="text-lg font-bold text-red-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-50 border-gray-200">
                <div class="flex justify-between items-start mb-1">
                    <label for="contingencyPercentage" class="font-semibold text-gray-600">Contingency</label>
                    <div class="flex items-center bg-white px-1 rounded border border-gray-200">
                        <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-xs font-bold text-gray-600 outline-none">%
                    </div>
                </div>
                <p id="summaryContingency" class="text-lg font-bold text-gray-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-50 border-gray-200">
                <div class="flex justify-between items-start mb-1">
                    <label for="salesTaxPercentage" class="font-semibold text-gray-600">Sales Tax</label>
                    <div class="flex items-center bg-white px-1 rounded border border-gray-200">
                        <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-xs font-bold text-gray-600 outline-none">%
                    </div>
                </div>
                <p id="summaryTax" class="text-lg font-bold text-gray-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-100 border-gray-200">
                <p class="font-semibold text-gray-500 mb-1">Subtotal</p>
                <p id="summarySubtotal" class="text-lg font-bold text-gray-800 text-right"></p>
            </div>
        </div>
    </div>

    <main id="budget-sections">${renderBudgetSections()}</main>
    <div id="footnote" class="mt-8 p-3 bg-gray-50 border border-gray-300 rounded-lg text-xs text-gray-600">
        <span>Personnel rates based on 2025 Jamaican market data (Beverly Boy, SalaryExpert, JAMPRO)($355-605USD Cam Op avg ~75k JMD), SalaryExpert (Editor ~50k JMD/day), JAMPRO, EmergeFilm, Paylab (PA 15k min above wage; Makeup 30k incl. materials ~$200USD); reductions: skilled 50-70% below US, entry 60-80%. . </span>
        <button id="compareRatesBtn" class="ml-2 text-blue-600 hover:underline">Compare Rates</button>
    </div>`;
    
    renderProjectManagement();
    renderStatusBar();
    updateCalculations();
    initializeInteractiveInputs();
    initializeDragAndDrop();
    updateOnlineStatus(); 
    if (activeElementId) {
        const toFocus = document.getElementById(activeElementId);
        if (toFocus) toFocus.focus();
    } else if (activeElementDataId && activeElementDataField) {
        const toFocus = document.querySelector(`[data-id="${activeElementDataId}"][data-field="${activeElementDataField}"]`);
        if (toFocus) toFocus.focus();
    }
}

// ---------------------------------------------------------
        // Modal Logic
        // ---------------------------------------------------------

        function showRateComparisonModal() {
             const rateComparisons = [
                { role: 'Camera Operator', local: '60,000 JMD', caricom: '65,000-80,000 JMD (T&T)', us: '$480 USD' },
                { role: 'Editor', local: '50,000 JMD', caricom: '45,000-55,000 JMD', us: '$400 USD' },
                { role: 'Production Assistant', local: '15,000 JMD', caricom: '12,000-18,000 JMD', us: '$150 USD' },
                { role: 'Hair & Makeup Artist', local: '30,000 JMD', caricom: '25,000-35,000 JMD', us: '$300 USD' },
                { role: 'Director of Photography', local: '70,000 JMD', caricom: '75,000-90,000 JMD', us: '$800 USD' },
                { role: 'Sound Mixer', local: '40,000 JMD', caricom: '35,000-45,000 JMD', us: '$350 USD' }
            ];

            const content = `
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">Role</th><th class="p-2 text-left">Local Jamaica (JMD/day)</th><th class="p-2 text-left">Caricom Avg (JMD/day)</th><th class="p-2 text-left">US Avg (USD/day)</th></tr></thead>
                    <tbody>${rateComparisons.map(row => `<tr class="border-b"><td class="p-2">${row.role}</td><td class="p-2">${row.local}</td><td class="p-2">${row.caricom}</td><td class="p-2">${row.us}</td></tr>`).join('')}</tbody>
                </table>
                <p class="text-xs text-gray-500 mt-4">Sources: Beverly Boy, SalaryExpert, JAMPRO. Rates approximate for mid-range productions.</p>
            `;
            createModal('rateComparison', 'Rate Comparisons (2025 Averages)', content, 'max-w-4xl');
        }

        /* --- v19.51 AI Modal with File Tray v19.52 Persistence & Offline Mode v19.53 --- */
function showAIToolsModal() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const attachments = budget.attachments || [];
    const isOnline = navigator.onLine;
    
    // v19.53: Check Context
    const aiContext = budget.aiContext || { saveHistory: true, analysis: "", chat: [] };
    
    // Render Attachment Tray
    const trayHTML = attachments.length > 0 ? 
        `<div class="mb-3 p-2 bg-gray-100 rounded-lg border border-gray-200">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 px-1">Attached Context</div>
            <div class="flex flex-col gap-1 max-h-32 overflow-y-auto">
                ${attachments.map(file => `
                    <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 shadow-sm group">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-6 h-6 flex-shrink-0 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-[9px] font-bold border border-blue-200">${file.name.split('.').pop().toUpperCase().substring(0,3)}</div>
                            <span class="text-xs text-gray-700 truncate font-medium" title="${file.name}">${getAbbreviatedName(file.name)}</span>
                        </div>
                        <button onclick="removeAttachment('${file.id}')" class="text-gray-400 hover:text-red-500 p-1 opacity-60 group-hover:opacity-100 transition-opacity">Ã—</button>
                    </div>`).join('')}
            </div>
        </div>` : 
        `<div class="mb-3 p-3 border-2 border-dashed border-gray-200 rounded-lg text-center text-gray-400 text-xs">No files attached. <button onclick="handleUniversalImport()" class="text-blue-500 hover:underline">Import Context</button></div>`;

    // v19.53: Saved History Rendering
    const savedAnalysis = aiContext.analysis || '';
    const savedChat = aiContext.chat.length > 0 ? 
        aiContext.chat.map(msg => `<div class="ai-message ${msg.role === 'user' ? 'user' : 'assistant'}">${msg.content}</div>`).join('') : 
        `<div class="text-sm text-gray-400 text-center mt-10">Ask about union rules, equipment packages, or local rates...</div>`;

    const offlineBanner = !isOnline ? `<div class="bg-yellow-100 text-yellow-800 p-2 text-xs text-center font-bold border-b border-yellow-200 mb-2 rounded">âš ï¸ Offline Mode - Showing Saved History</div>` : '';

    const content = !key ? 
        `<div class="text-center py-10"><div class="text-4xl mb-4">ðŸ”‘</div><h3 class="text-lg font-bold text-gray-700">API Key Required</h3><p class="text-gray-500 text-sm mb-4">Please go to Settings > AI Assistant to configure your API key.</p><button onclick="closeModal('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Open Settings</button></div>` 
        : 
        `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
            <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-lg"><span class="text-2xl">ðŸ©º</span> Budget Doctor</h4>
                <p class="text-sm text-gray-500 mb-4">Analyze your current budget for gaps, risks, and rate anomalies using ${provider}.</p>
                <button id="analyzeBudgetBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex justify-center items-center gap-2 font-medium transition-colors ${!isOnline ? 'opacity-50 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}>${isOnline ? 'Analyze Current Budget' : 'Analyze Unavailable (Offline)'}</button>
                <div id="aiAnalysisOutput" class="mt-4 text-sm text-gray-700 flex-grow overflow-y-auto border-t pt-4 min-h-[200px]">${savedAnalysis}</div>
            </div>
            
            <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><span class="text-2xl">ðŸ’¬</span> Production Consultant</h4>
                </div>
                ${offlineBanner}
                ${trayHTML}
                <div id="aiChatHistory" class="flex-grow overflow-y-auto bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200">${savedChat}</div>
                
                <form id="aiChatForm" class="flex gap-2 items-center">
                    <button type="button" onclick="handleUniversalImport()" class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg border border-transparent hover:border-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button>
                    <input type="text" id="aiChatInput" placeholder="Ask a question..." class="flex-grow text-sm p-3 border rounded-lg focus:outline-none focus:border-blue-500" ${!isOnline ? 'disabled' : ''}>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 ${!isOnline ? 'opacity-50 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                </form>
            </div>
        </div>`;

    createModal('aiTools', 'âœ¨ AI Assistant', content, 'max-w-4xl');
    
    if (key && isOnline) {
        document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
        document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
    }
}

/* --- v19.53 Settings Modal Wrapper --- */
function showSettingsModal(defaultTab = 'general') {
    const content = `
        <div class="flex border-b text-sm font-medium text-gray-600 overflow-x-auto">
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'general' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('general', this)">General</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'templates' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('templates', this)">Templates</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'database' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('database', this)">Line Items</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'ai' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('ai', this)">âœ¨ AI Assistant</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'roadmap' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('roadmap', this)">Roadmap</button>
			 <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'contacts' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('contacts', this)">Contacts</button>
        </div>
        <div class="p-6" id="settingsContent">${renderSettingsContent(defaultTab)}</div>
    `;
    createModal('settings', 'Settings & Tools', content, 'max-w-4xl');
    bindSettingsEvents(defaultTab);
}

/* --- v19.53 Film Industry Database --- */
/* --- v19.55 [Open Gate v1.0] - Industry Line Item Database --- */
/* Codename: Open Gate - Removing barriers to production knowledge. */
const FILM_INDUSTRY_ITEMS = [
    // --- Above the Line ---
    { description: 'Director', unit: 'Day', rate: 85000 },
    { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
    { description: 'Producer', unit: 'Day', rate: 75000 },
    { description: 'Line Producer', unit: 'Day', rate: 65000 },
    { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
    { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
    { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
    { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },

    // --- Production Dept ---
    { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
    { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
    { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
    { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
    { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
    { description: 'Key PA', unit: 'Day', rate: 20000 },
    { description: 'Set PA', unit: 'Day', rate: 15000 },
    { description: 'Office PA', unit: 'Day', rate: 15000 },
    { description: 'Truck PA', unit: 'Day', rate: 18000 },
    { description: 'Location Manager', unit: 'Day', rate: 50000 },
    { description: 'Location Scout', unit: 'Day', rate: 35000 },
    { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
    { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
    { description: 'Security Guard', unit: 'Day', rate: 12000 },
    { description: 'Craft Service', unit: 'Day', rate: 25000 },
    { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },

    // --- Camera Dept ---
    { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
    { description: 'Camera Operator', unit: 'Day', rate: 60000 },
    { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
    { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
    { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
    { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
    { description: 'Drone Operator', unit: 'Day', rate: 55000 },
    { description: 'Camera Utility', unit: 'Day', rate: 25000 },

    // --- Lighting & Grip ---
    { description: 'Gaffer', unit: 'Day', rate: 55000 },
    { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
    { description: 'Electrician', unit: 'Day', rate: 30000 },
    { description: 'Key Grip', unit: 'Day', rate: 50000 },
    { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
    { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
    { description: 'Grip', unit: 'Day', rate: 30000 },
    { description: 'Generator Operator', unit: 'Day', rate: 35000 },

    // --- Sound ---
    { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
    { description: 'Boom Operator', unit: 'Day', rate: 35000 },
    { description: 'Sound Utility', unit: 'Day', rate: 25000 },

    // --- Art & Wardrobe ---
    { description: 'Production Designer', unit: 'Day', rate: 65000 },
    { description: 'Art Director', unit: 'Day', rate: 50000 },
    { description: 'Set Decorator', unit: 'Day', rate: 45000 },
    { description: 'Set Dresser', unit: 'Day', rate: 30000 },
    { description: 'Props Master', unit: 'Day', rate: 45000 },
    { description: 'Assistant Props', unit: 'Day', rate: 30000 },
    { description: 'Costume Designer', unit: 'Day', rate: 55000 },
    { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
    { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
    { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
    { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
    { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },

    // --- Post-Production ---
    { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
    { description: 'Editor', unit: 'Day', rate: 50000 },
    { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
    { description: 'Colorist', unit: 'Hour', rate: 15000 },
    { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
    { description: 'VFX Artist', unit: 'Day', rate: 55000 },
    { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
    { description: 'Composer', unit: 'Flat', rate: 200000 },
    { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
];

function ensureDatabaseSeeded() {
    try {
        const current = getGlobalItems();
        if (current.length === 0) saveGlobalItems(FILM_INDUSTRY_ITEMS);
    } catch(e) { console.warn("DB Seed skipped"); }
}
// Run check immediately
ensureDatabaseSeeded();

/* --- v19.53 Add Item Modal with Search --- */
function showItemSelectorModal(sectionName) {
    const allItems = getAllItems();
    // Sort & De-dupe Logic
    const uniqueMap = {};
    allItems.forEach(item => {
        if (!uniqueMap[item.description]) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: 0, isGlobal: item.isGlobal };
        else if (item.isGlobal) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: uniqueMap[item.description].count, isGlobal: true };
        if (!item.isGlobal) {
             uniqueMap[item.description].count++;
             if(!uniqueMap[item.description].isGlobal) uniqueMap[item.description].rate += item.rate;
        }
    });
    
    Object.keys(uniqueMap).forEach(desc => {
        const entry = uniqueMap[desc];
        if (!entry.isGlobal && entry.count > 1) entry.rate = entry.rate / entry.count;
    });

    const itemList = Object.keys(uniqueMap).filter(desc => desc !== 'New Item' && desc.trim())
        .map(desc => ({ description: desc, unit: uniqueMap[desc].unit, rate: uniqueMap[desc].rate, isGlobal: uniqueMap[desc].isGlobal }))
        .sort((a, b) => { 
            if (a.isGlobal && !b.isGlobal) return -1; 
            if (!a.isGlobal && b.isGlobal) return 1; 
            return a.description.localeCompare(b.description); 
        });

    const content = `
        <div class="mb-3">
            <input type="text" id="addItemSearch" placeholder="ðŸ” Search roles..." class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" autocomplete="off">
        </div>
        <button id="newItemBtn" class="w-full mb-2 p-3 bg-blue-100 text-blue-700 font-bold rounded-lg hover:bg-blue-200 border border-blue-200 flex justify-center items-center gap-2">
            <span>+</span> Create Blank Item
        </button>
        <div class="max-h-[50vh] overflow-y-auto border-t border-gray-100" id="itemSelectorList">
            ${renderItemSelectorList(itemList)}
        </div>
        <div class="mt-2 text-xs text-center text-gray-400">Database items marked with <span class="text-yellow-500">â˜…</span></div>`;
    
    const modal = createModal('itemSelector', 'Add Line Item', content, 'max-w-md');
    
    const searchInput = document.getElementById('addItemSearch');
    if(searchInput) {
        searchInput.focus();
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = itemList.filter(i => i.description.toLowerCase().includes(term));
            document.getElementById('itemSelectorList').innerHTML = renderItemSelectorList(filtered);
            bindSelectorClicks(modal, sectionName);
        });
    }

    document.getElementById('newItemBtn').addEventListener('click', () => { 
        closeModal('itemSelectorModal'); 
        handleAddBlank(sectionName); 
    });
    
    bindSelectorClicks(modal, sectionName);
}

function renderItemSelectorList(items) {
    if(items.length === 0) return '<p class="text-center text-gray-400 py-8 text-sm">No matching roles found.</p>';
    return items.map(item => `
        <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-blue-50 transition-colors flex justify-between items-center group" data-select-item='${JSON.stringify({ desc: item.description, unit: item.unit, rate: item.rate })}'>
            <div class="flex items-center overflow-hidden min-w-0 mr-2">
                ${item.isGlobal ? '<span class="mr-2 text-yellow-500 text-xs flex-shrink-0" title="Database Item">â˜…</span>' : ''}
                <span class="truncate ${item.isGlobal ? 'font-semibold text-gray-800' : 'text-gray-600'} text-sm">${item.description}</span>
            </div>
            <span class="text-xs font-mono text-gray-500 whitespace-nowrap bg-gray-100 px-1.5 py-0.5 rounded">${item.unit}: ${formatCurrency(item.rate)}</span>
        </div>`).join('');
}

function bindSelectorClicks(modal, sectionName) {
    modal.querySelectorAll('[data-select-item]').forEach(el => {
        el.addEventListener('click', (e) => {
            const data = JSON.parse(e.currentTarget.dataset.selectItem);
            closeModal('itemSelectorModal');
            handleAddExisting(sectionName, data.desc, data.unit, data.rate);
        });
    });
}

function handleAddBlank(sectionName) {
    const newItem = { id: crypto.randomUUID(), ...initialLineItem };
    if(!newItem.assignedStage) newItem.assignedStage = ['prod'];
    budget.sections[sectionName].items.push(newItem);
    pushToHistory(`Added new item to ${sectionName}`);
    render(); 
}

function showRecoveryModal() {
    const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
    
    let content = trash.length > 0 ? 
        `<div class="max-h-[60vh] overflow-y-auto">` + 
        trash.map((p, index) => `
        <div class="flex justify-between items-center p-2 ${index < trash.length -1 ? 'border-b' : ''}">
            <div><p class="font-semibold">${p.projectName}</p><p class="text-xs text-gray-500">Deleted: ${new Date(p.deletedTimestamp).toLocaleString()}</p></div>
            <div>
                <button onclick="handleRestore(${index})" class="text-sm bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Restore</button>
                <button onclick="handlePermanentDelete(${index})" class="text-sm bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 ml-2">Delete Forever</button>
            </div>
        </div>`).join('') + 
        `</div>`
        : `<p class="text-center text-gray-500 py-8">No recently deleted projects.</p>`;
    
    if (trash.length > 0) {
        content += `
        <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between items-center bg-gray-50 p-2 rounded-lg">
            <span class="text-xs text-gray-500 font-medium">Bulk Actions</span>
            <div class="flex gap-2">
                <button onclick="handleRestoreAll()" class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700 shadow-sm transition-colors">Restore All</button>
                <button onclick="handleDeleteAllTrash()" class="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow-sm transition-colors">Delete All</button>
            </div>
        </div>`;
    }
    
    createModal('recovery', 'Recover Deleted Projects', content, 'max-w-lg');
}
        // ---------------------------------------------------------
        // Event Handlers
        // ---------------------------------------------------------

        function bindAppEventListeners() {
            const appContainer = document.getElementById('app');
            const footer = document.querySelector('footer');

            if (!appContainer || appContainer.dataset.listenersBound) return;
            appContainer.dataset.listenersBound = 'true';

            appContainer.addEventListener('change', (e) => {
                const id = e.target.id;
                if (id === 'projectName') handleProjectNameChange(e);
                else if (id === 'contingencyPercentage') { budget.contingencyPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Contingency %'); updateCalculations(); }
                else if (id === 'salesTaxPercentage') { budget.salesTaxPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Sales Tax %'); updateCalculations(); }
                else if (id === 'discountPercentage') handleDiscountChange(e);
                else if (id === 'projectLoader') { loadBudget(e.target.value); render(); }
                else if (id === 'newProjectSelector') handleNewProjectSelection(e);
                else if (e.target.dataset.field === 'unit') handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Changed unit for ${e.target.closest('tr').querySelector('input[data-field=description]').value}`);
            });

if(footer) {
                footer.addEventListener('click', (e) => { 
if (e.target.closest('#docsFooterBtn')) showDocumentsModal();
                    if (e.target.closest('#stagesFooterBtn')) showStagesModal();
                    if (e.target.closest('#publishFooterBtn')) document.getElementById('publishBtn')?.click();
// Trigger existing logic via ID or duplicate logic below
                    if (e.target.closest('#settingsBtn')) showSettingsModal(); 
                    if (e.target.closest('#footerCoffeeBtn')) {
                        const btn = document.querySelector('#bmc-wbtn');
                        if (btn) btn.click();
                        else window.open('https://buymeacoffee.com/jaysonmy', '_blank');
                    }
                });
            }

            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.id === 'undoBtn') handleUndo();
                else if (target.id === 'redoBtn') handleRedo();
                else if (target.id === 'loginBtn') handleLogin();
                else if (target.closest('#openAiToolsBtn')) showAIToolsModal();
                else if (target.closest('#deleteProjectBtn')) deleteProject(currentProjectName);
                else if (target.closest('#currencyToggleBtn')) handleCurrencyToggle();
                else if (target.closest('#exportPdfBtn')) exportToPdf();
                else if (target.closest('#exportXlsxBtn')) exportToXlsx();
                else if (target.closest('[data-section-toggle]')) handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
                else if (target.closest('[data-add-item]')) showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
                else if (target.closest('[data-remove-item]')) handleRemoveItem(target.closest('[data-remove-item]').dataset.section, target.closest('[data-remove-item]').dataset.removeItem);
                else if (target.id === 'compareRatesBtn') showRateComparisonModal();
            });

            appContainer.addEventListener('input', (e) => {
                const input = e.target;
                if (input.dataset.field) {
                    handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Updated ${input.dataset.field}`);
                } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    updateCalculations();
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        // ---------------------------------------------------------
        // Implementation Logic
        // ---------------------------------------------------------

        function getAllItems() {
            const allItems = [];
            getGlobalItems().forEach(item => allItems.push({ description: item.description, unit: item.unit, rate: item.rate, isGlobal: true }));
            getProjectList().forEach(projectName => {
                try {
                    const data = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName) || '{}');
                    if (data?.sections) Object.values(data.sections).forEach(section => {
                        section.items?.forEach(item => {
                            if (item.description?.trim()) allItems.push({ description: item.description.trim(), unit: item.unit || 'Day', rate: item.rate || 0, isGlobal: false });
                        });
                    });
                } catch (e) { console.error(e); }
            });
            return allItems;
        }

        function formatAndUpdateSummaryValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = formatCurrency(value);
            if (element.scrollWidth > element.parentElement.clientWidth) element.textContent = formatAbbreviated(value, displayCurrency);
        }

        function checkOverBudget() {
            const actualTotal = calculateActuals(budget.sections);
            const { subtotal } = calculateTotals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const grandTotal = (subtotal + contingencyAmount + taxAmount) - ((subtotal + contingencyAmount + taxAmount) * ((budget.discountPercentage || 0) / 100));

            const summaryActual = document.getElementById('summaryActualTotal');
            if (summaryActual) {
                const hasOverBudget = actualTotal > grandTotal;
                summaryActual.parentElement.classList.toggle('bg-red-50', hasOverBudget);
                if (hasOverBudget && !summaryActual.parentElement.querySelector('.alert-badge')) {
                     summaryActual.parentElement.innerHTML += '<div class="alert-badge">!</div>';
                } else if (!hasOverBudget) {
                     const badge = summaryActual.parentElement.querySelector('.alert-badge');
                     if (badge) badge.remove();
                }
            }

            for (const sectionName in budget.sections) {
                budget.sections[sectionName].items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    const row = document.querySelector(`[data-item-id="${item.id}"]`);
                    if (row) row.classList.toggle('bg-red-50', variance > 0);
                });
            }
        }

/* --- v19.52 Smart Calculation Update --- */
function updateCalculations() {
    if (!document.getElementById('summarySubtotal')) return;
    
    // Check mobile state dynamically
    const isMobile = window.innerWidth < 768;
    const formatMoney = (val) => isMobile ? formatAbbreviated(val, displayCurrency) : formatCurrency(toDisp(val));

    const { subtotal } = calculateTotals(budget.sections);
    const actualTotal = calculateActuals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;

    // Use formatMoney wrapper which now handles abbreviations automatically
    formatAndUpdateSummaryValue('summarySubtotal', toDisp(subtotal));
    formatAndUpdateSummaryValue('summaryContingency', toDisp(contingencyAmount));
    formatAndUpdateSummaryValue('summaryTax', toDisp(taxAmount));
    formatAndUpdateSummaryValue('summaryDiscount', toDisp(-discountAmount)); // Negative sign for clarity
    formatAndUpdateSummaryValue('summaryGrandTotal', toDisp(grandTotal));
    formatAndUpdateSummaryValue('summaryActualTotal', toDisp(actualTotal));

    // Update Lines
    for (const sectionName in budget.sections) {
        const section = budget.sections[sectionName];
        let sectionTotal = 0;
        section.items.forEach(item => {
            const { estimated, variance } = calculateItem(item);
            sectionTotal += estimated;
            
            const estimatedCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
            if (estimatedCell) estimatedCell.textContent = formatMoney(estimated);
            
            const varianceCell = document.querySelector(`[data-variance-id="${item.id}"]`);
            if (varianceCell) {
                varianceCell.textContent = formatMoney(variance);
                varianceCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
            }
        });
        const sectionTotalEl = document.querySelector(`[data-section-total="${sectionName}"]`);
        if (sectionTotalEl) sectionTotalEl.textContent = formatCurrency(toDisp(sectionTotal)); 
    }
    checkOverBudget();
}

/* --- v19.53 [Logic] - Auto-Flat Quantity & Color Refresh --- */
function handleUpdate(sectionName, itemId, field, value, description) {
    const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
    if (!item) return;
    
    let valueToSave = value;

    // 1. Standard Value Parsing
    if (['rate', 'actual'].includes(field)) {
        const parsedValue = parseFloat(value) || 0;
        valueToSave = (displayCurrency === 'USD') ? convertCurrency(parsedValue, 'JMD') : parsedValue;
    } else if (field === 'quantity') {
        valueToSave = parseFloat(value) || 0;
    } else if (field === 'multiplier') { 
        const parsed = parseFloat(value) || 1; 
        valueToSave = parsed > 0 ? parsed : 1; 
    }
    
    // 2. "Flat Rate" Smart Logic
    if (field === 'unit') {
        // Case A: Switching TO Flat (Save Qty, Set to 1)
        if (value === 'Flat' && item.unit !== 'Flat') {
            item._storedQuantity = item.quantity; // Remember the "Day" count
            item.quantity = 1; 
        } 
        // Case B: Switching FROM Flat (Restore Qty)
        else if (item.unit === 'Flat' && value !== 'Flat') {
            if (item._storedQuantity !== undefined) {
                item.quantity = item._storedQuantity; // Restore the "Day" count
            }
        }
    }

    // 3. Apply the value
    item[field] = valueToSave;
    pushToHistory(description);
    
    // 4. Render Updates
    if (field === 'unit') {
        render(); // Force re-render to update color pills and new Quantity input
    } else if (field !== 'description') {
        updateCalculations(); // Fast math update for numbers
    }
}


        function handleAddExisting(sectionName, desc, unit, rate) {
            const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit: unit, multiplier: 1, rate: rate, actual: 0 };
            budget.sections[sectionName].items.push(newItem);
            pushToHistory(`Added '${desc}' to ${sectionName}`);
            const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
            if (tableBody) {
                tableBody.insertAdjacentHTML('beforeend', renderLineItem(newItem, sectionName));
                initializeDragAndDrop();
            }
            updateCalculations();
        }

        function handleRemoveItem(sectionName, itemId) {
            const itemIndex = budget.sections[sectionName].items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const itemName = budget.sections[sectionName].items[itemIndex].description;
                budget.sections[sectionName].items.splice(itemIndex, 1);
                pushToHistory(`Removed '${itemName}' from ${sectionName}`);
                const row = document.querySelector(`button[data-remove-item="${itemId}"]`).closest('tr');
                if (row) row.remove();
                updateCalculations();
            }
        }

        function handleToggleSection(sectionName) {
            const section = budget.sections[sectionName];
            section.isOpen = !section.isOpen;
            pushToHistory(`${section.isOpen ? 'Opened' : 'Closed'} section: ${sectionName}`);
            const content = document.querySelector(`[data-section-toggle="${sectionName}"]`).nextElementSibling;
            content.classList.toggle('hidden');
            const arrow = document.querySelector(`[data-section-toggle="${sectionName}"] .section-arrow`);
            arrow.innerHTML = section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>';
        }

        function handleDiscountChange(e) { 
            let value = parseFloat(e.target.value) || 0;
            if (value > 100) { value = 100; e.target.value = 100; } else if (value < 0) { value = 0; e.target.value = 0; }
            budget.discountPercentage = value; 
            pushToHistory('Updated Discount %'); updateCalculations(); 
        }
        
        function handleProjectNameChange(e) {
            const newName = e.target.value.trim();
            if (newName && newName !== currentProjectName) {
                if (getProjectList().includes(newName)) { alert(`A project named "${newName}" already exists.`); e.target.value = currentProjectName; return; }
                localStorage.removeItem(storageKeyPrefix + currentProjectName);
                const oldName = budget.projectName;
                budget.projectName = newName;
                pushToHistory(`Renamed project from '${oldName}' to '${newName}'`);
                render(); 
            }
        }
        
        function getFormattedDatePart() {
            const date = new Date();
            const dateFormat = getProjectDateFormat();
            const separator = getProjectNameSeparator();
            const pad = (num) => String(num).padStart(2, '0');
            
            let datePart;
            const M = pad(date.getMonth() + 1);
            const D = pad(date.getDate());
            const Y = date.getFullYear();

            if (dateFormat === 'MMDDYYYY') {
                datePart = `${M}${separator}${D}${separator}${Y}`;
            } else { // YYYYMMDD
                datePart = `${Y}${separator}${M}${separator}${D}`;
            }
            return datePart;
        }

        /* --- v19.51 File Menu Handler v19.52 --- */
        function handleNewProjectSelection(e) {
            const type = e.target.value;
            
            if (type === 'Duplicate') {
                handleDuplicateProject();
                e.target.value = ""; 
            }
            else if (type === 'Recover') {
                showRecoveryModal();
                e.target.value = "";
            }
            else if (type === 'ImportFile' || type === 'ImportMoo') {
                handleUniversalImport(); 
                
                setTimeout(() => { 
                    const el = document.getElementById('newProjectSelector');
                    if(el) el.value = ""; 
                }, 500);
            }
            else if (type) {
                handleNewProject(true, type); 
            } 
        }
        
        function handleDuplicateProject() {
            if (!budget) return;
            const newBudget = JSON.parse(JSON.stringify(budget));
            let baseName = newBudget.projectName.replace(/ \(Copy( \d+)?\)$/, "");
            let newName = `${baseName} (Copy)`;
            let i = 2;
            while(getProjectList().includes(newName)) { newName = `${baseName} (Copy ${i})`; i++; }
            newBudget.projectName = newName;
            Object.values(newBudget.sections).forEach(s => s.items.forEach(i => i.id = crypto.randomUUID()));
            budget = newBudget;
            pushToHistory(`Duplicated project to '${newName}'`);
            render();
        }
        
        function handleNewProject(doRender = true, type = 'Commercial') {
            const datePart = getFormattedDatePart();
            let newName = `Untitled ${type}`;
            let i = 1;
            let finalName = `${newName} ${datePart}`;
            while(getProjectList().includes(finalName)) { i++; finalName = `${newName} ${datePart} (${i})`; }
            budget = getDefaultBudget(finalName, type);
            pushToHistory(`Created new project '${finalName}'`);
            if(doRender) render();
        }

   // --- Drag & Drop (Powered by SortableJS) ---
        function initializeDragAndDrop() {
            const containers = document.querySelectorAll('tbody[data-section-body]');
            
            containers.forEach(container => {
                // Prevent duplicate initialization
                if(container._sortable) return;

                container._sortable = new Sortable(container, {
                    group: 'budget-items', // Allows dragging between sections
                    handle: '.drag-handle', // Restricts drag to the handle icon
                    animation: 150, // Smooth swap animation
                    
                    // Visual Classes (Matches the CSS we just added)
                    ghostClass: 'sortable-ghost', 
                    dragClass: 'sortable-drag',
                    
                    // Critical for Desktop/Mobile consistency
                    forceFallback: true, 
                    fallbackOnBody: true,
                    swapThreshold: 0.65,
                    
                    // Delays prevent accidental drags while scrolling on mobile
                    delay: 100, 
                    delayOnTouchOnly: true,

                    onEnd: function (evt) {
                        const itemEl = evt.item;
                        const newIndex = evt.newIndex;
                        const toSection = evt.to.dataset.sectionBody;
                        const fromSection = evt.from.dataset.sectionBody;
                        const itemId = itemEl.dataset.itemId;

                        // Only process if position actually changed
                        if (toSection === fromSection && evt.oldIndex === newIndex) return;

                        // 1. Update Data Model
                        const fromList = budget.sections[fromSection].items;
                        
                        // Find item object
                        const itemObjIndex = fromList.findIndex(i => i.id === itemId);
                        if (itemObjIndex > -1) {
                            const [movedItem] = fromList.splice(itemObjIndex, 1);
                            
                            // Insert into new list at specific index
                            if (!budget.sections[toSection].items) budget.sections[toSection].items = [];
                            budget.sections[toSection].items.splice(newIndex, 0, movedItem);
                            
                            // 2. Update DOM Data Attributes (Critical for next move)
                            itemEl.dataset.section = toSection;
                            itemEl.querySelectorAll('[data-section]').forEach(el => el.dataset.section = toSection);
                            
                            // 3. Save & Recalculate
                            pushToHistory(`Moved item to ${toSection}`);
                            updateCalculations();
                        }
                    }
                });
            });
        }
        function resetDragStyles(el) { el.classList.remove('drag-over'); el.style.borderTop = 'none'; el.style.borderBottom = 'none'; }
        function moveItem(itemId, fromSection, toSection, toIndex) {
            if (fromSection === toSection && toIndex === Array.from(document.querySelector(`[data-section-body="${fromSection}"]`).children).findIndex(row => row.dataset.itemId === itemId)) return;
            const fromItems = budget.sections[fromSection].items;
            const toItems = budget.sections[toSection].items;
            const item = fromItems.find(i => i.id === itemId);
            if (!item) return;
            fromItems.splice(fromItems.indexOf(item), 1);
            toItems.splice(toIndex, 0, item);
            pushToHistory(`Reordered item '${item.description}' from ${fromSection} to ${toSection}`);
            render();
        }

/* --- P3 --- */

// --- Settings & AI Handlers ---
/* --- v19.53 Settings Logic (Search & Line Items) --- */
window.switchSettingsTab = function(tabName, btn) {
    editingGlobalItemIndex = -1;
    const buttons = btn.parentElement.children;
    for(let b of buttons) b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
    btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
    document.getElementById('settingsContent').innerHTML = renderSettingsContent(tabName);
    bindSettingsEvents(tabName);
};

function bindSettingsEvents(tabName) {
    if(tabName === 'general') { 
        document.getElementById('updateBtn')?.addEventListener('click', downloadOfflineHTML); 
        document.getElementById('dateFormatSelect')?.addEventListener('change', (e) => { setProjectDateFormat(e.target.value); });
        document.getElementById('separatorInput')?.addEventListener('input', (e) => { setProjectNameSeparator(e.target.value); });
    }
	else if (tabName === 'contacts') { bindContactsEvents(); }
    else if (tabName === 'templates') { bindTemplateEvents(); }
    else if (tabName === 'database') { bindDatabaseEvents(); }
    else if (tabName === 'roadmap') { document.getElementById('toggleRoadmapDetailsBtn')?.addEventListener('click', (e) => { document.querySelectorAll('.roadmap-detail').forEach(el => el.classList.toggle('hidden')); e.target.textContent = e.target.textContent.includes('Expand') ? 'Collapse Details' : 'Expand Details'; }); }
    else if (tabName === 'ai') { bindAIEvents(); }
}

function bindAIEvents() {
    document.getElementById('aiProviderSelect')?.addEventListener('change', (e) => { setSelectedProvider(e.target.value); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
    document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => { saveStoredApiKey(getSelectedProvider(), document.getElementById('apiKeyInput').value.trim()); alert('API Key Saved'); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
}

function bindDatabaseEvents() {
    document.getElementById('addGlobalItemForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = document.getElementById('dbDesc').value.trim();
        const unit = document.getElementById('dbUnit').value;
        const rate = parseFloat(document.getElementById('dbRate').value) || 0;
        if(desc) {
            const items = getGlobalItems();
            if (editingGlobalItemIndex > -1) { items[editingGlobalItemIndex] = { description: desc, unit, rate }; editingGlobalItemIndex = -1; } 
            else { 
                const existingIdx = items.findIndex(i => i.description.toLowerCase() === desc.toLowerCase());
                if(existingIdx >= 0) items.splice(existingIdx, 1);
                items.unshift({ description: desc, unit, rate }); 
            }
            saveGlobalItems(items);
            window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
        }
    });

    // New Search Listener
    document.getElementById('dbSearchInput')?.addEventListener('input', (e) => {
        filterDbList(e.target.value);
    });
}

// Helper: Filter Logic
function filterDbList(term) {
    const all = getGlobalItems();
    const lower = term.toLowerCase();
    const filtered = all.filter(i => i.description.toLowerCase().includes(lower));
    document.getElementById('dbListBody').innerHTML = renderDbListItems(filtered);
}

// Helper: Render Rows
function renderDbListItems(items) {
    if(items.length === 0) return '<tr><td colspan="3" class="p-4 text-center text-gray-400">No items found.</td></tr>';
    return items.map((item, idx) => `<tr class="border-t hover:bg-gray-50 ${idx === editingGlobalItemIndex ? 'bg-blue-50' : ''}"><td class="p-2">${item.description}</td><td class="p-2 text-right">${formatCurrency(item.rate)}</td><td class="p-2 text-center"><button aria-label="Edit Item" class="text-blue-500 mr-2" onclick="editGlobalItem(${idx})">âœŽ</button><button aria-label="Delete Item" class="text-red-400" onclick="deleteGlobalItem(${idx})">Ã—</button></td></tr>`).join('');
}

function renderSettingsContent(tabName) {
    const currentDateFormat = getProjectDateFormat();
    const currentSeparator = getProjectNameSeparator();

/* --- v19.53 [Settings] - General UI (Centered & Fitted Buttons) --- */
if (tabName === 'general') {
    return `<div class="space-y-6">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
            <h3 class="font-bold text-blue-800 mb-2">Application Info</h3>
            <p class="text-sm text-gray-700">Current Version: <strong>v${APP_VERSION}</strong></p>
            <p class="text-sm text-gray-500 mt-1">Status: ${navigator.onLine ? '<span class="text-green-600 font-semibold">Online</span>' : '<span class="text-red-500 font-semibold">Offline</span>'}</p>
        </div>
        
        <div class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-2">Project Naming Preferences</h3>
            <div>
                <label for="dateFormatSelect" class="block text-xs font-semibold text-gray-600 mb-1">Date Format</label>
                <select id="dateFormatSelect" aria-label="Date Format" class="w-full text-sm p-2 border rounded">
                    <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD (Default)</option>
                    <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                </select>
            </div>
             <div>
                <label for="separatorInput" class="block text-xs font-semibold text-gray-600 mb-1">Separator</label>
                <input type="text" id="separatorInput" aria-label="Date Separator" maxlength="1" value="${currentSeparator}" class="w-10 text-sm p-2 border rounded text-center">
            </div>
        </div>

        <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between">
             <div>
                <label class="font-bold text-gray-700 text-sm cursor-pointer" for="compactModeCheck">Compact Mode</label>
                <p class="text-xs text-gray-400">Use abbreviations and icons for a denser layout.</p>
             </div>
             <input type="checkbox" id="compactModeCheck" disabled class="w-5 h-5 rounded text-blue-600 cursor-not-allowed opacity-50" title="Coming Soon">
        </div>

        <div class="pt-2 border-t">
            <h3 class="font-bold text-gray-800 mb-3 text-sm text-center sm:text-left">Maintenance & Tools</h3>
            
            <div class="flex flex-wrap gap-3 justify-center">
                <button id="updateBtn" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                   Download Offline Beta
                </button>
                
                <button onclick="if(confirm('Reload app to fix display bugs? (Your data is safe)')) { navigator.serviceWorker.getRegistrations().then(regs => { regs.forEach(r => r.unregister()); window.location.reload(); }); }" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                    Fix Bugs / Reload
                </button>

                <button onclick="handleFactoryReset()" class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                    Factory Reset
                </button>
            </div>
            
            <p class="text-xs text-gray-400 mt-2 text-center">"Download Offline Beta" saves this exact version to your device.</p>
        </div>

        <div class="mt-4 flex justify-center border-t pt-4">
             <button onclick="const btn=document.querySelector('#bmc-wbtn'); if(btn) btn.click(); else window.open('https://buymeacoffee.com/jaysonmy', '_blank');" class="bmc-btn text-sm">â˜• Buy me a coffee</button>
        </div>
    </div>`;
}

else if (tabName === 'contacts') {
        const contacts = getGlobalContacts();
        return `
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                <div>
                    <h3 class="font-bold text-indigo-900">Crew Database</h3>
                    <p class="text-xs text-indigo-700">Manage roster for Open Gate Auto-Assign.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('csvImportInput').click()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700">Import CSV</button>
                    <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importContactsCSV(this)">
                    <button onclick="autoAssignRolesFromContacts()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700 shadow-sm flex items-center gap-1"><span>âš¡</span> Auto-Assign Budget</button>
                </div>
            </div>

            <form id="addContactForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border">
                <div class="col-span-12 sm:col-span-4">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Name</label>
                    <input type="text" id="cName" class="w-full p-2 border rounded text-sm" required placeholder="Jane Doe">
                </div>
                <div class="col-span-12 sm:col-span-4">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Default Role</label>
                    <input type="text" id="cRole" class="w-full p-2 border rounded text-sm" required placeholder="Director, Gaffer...">
                </div>
                <div class="col-span-12 sm:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Email/Phone</label>
                    <input type="text" id="cContact" class="w-full p-2 border rounded text-sm" placeholder="jane@film.com">
                </div>
                <div class="col-span-12 sm:col-span-1">
                    <button type="submit" class="w-full p-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">+</button>
                </div>
            </form>

            <div class="border rounded-lg overflow-hidden">
                <div class="bg-gray-100 p-2 text-xs font-bold text-gray-500 flex justify-between">
                    <span>${contacts.length} Contacts stored</span>
                    <input type="text" id="contactSearch" placeholder="Search..." class="bg-white border rounded px-2 py-0.5 text-xs font-normal w-32">
                </div>
                <div class="max-h-64 overflow-y-auto" id="contactsListBody">
                    ${renderContactsList(contacts)}
                </div>
            </div>
        </div>`;
    }

else if (tabName === 'templates') {
        const allTemplates = getAllTemplates();
        if(!editingTemplateId) editingTemplateId = 'Commercial';
        const options = Object.keys(allTemplates).map(k => `<option value="${k}" ${k === editingTemplateId ? 'selected' : ''}>${k}</option>`).join('');
        
        const isReadOnly = isDefaultTemplate(editingTemplateId);
        const disabledClass = isReadOnly ? 'opacity-50 cursor-not-allowed bg-gray-300' : 'bg-blue-600 hover:bg-blue-700';
        
        return `
        <div class="h-full flex flex-col">
            <div class="mb-4 flex flex-wrap gap-2 items-center justify-between bg-gray-50 p-3 rounded-lg border">
                <div class="flex items-center gap-2 flex-grow">
                    <label class="text-sm font-bold text-gray-700 whitespace-nowrap">Edit Template:</label>
                    <select id="templateSelector" aria-label="Select Template" class="p-2 border rounded text-sm bg-white shadow-sm flex-grow max-w-xs">${options}</select>
                </div>
                <div class="flex gap-2">
                    <button id="createTemplateBtn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center gap-1"><span class="text-base">+</span> Clone / New</button>
                    <button id="importTemplateBtn" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Import</button>
                    <button id="exportTemplateBtn" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Export</button>
                    <button id="deleteTemplateBtn" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 border border-red-200 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}" ${isReadOnly ? 'disabled' : ''}>Delete</button>
                </div>
            </div>
            
            <div id="templateEditorContainer" class="flex-grow overflow-y-auto border rounded-lg p-4 bg-white shadow-inner">
                </div>
            
            <div class="mt-4 pt-3 border-t flex justify-end gap-3">
                <p class="text-xs text-gray-400 self-center mr-auto">Changes are applied to NEW projects only.</p>
                <button id="saveTemplateChangesBtn" class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${disabledClass}" ${isReadOnly ? 'disabled' : ''}>Save Changes</button>
            </div>
        </div>
        `;
    } 

/* v19.53 [Settings] - AI Toggle Added --- */
else if (tabName === 'ai') {
    const currentProvider = getSelectedProvider();
    const saveHistory = budget.aiContext ? budget.aiContext.saveHistory : true;
    let keyLink = '#'; 
    // ... (Keep existing key link logic) ...
    if(currentProvider === 'gemini') keyLink = 'https://aistudio.google.com/app/apikey';
    else if(currentProvider === 'openai') keyLink = 'https://platform.openai.com/api-keys';
    else if(currentProvider === 'xai') keyLink = 'https://console.x.ai/';
    else if(currentProvider === 'deepseek') keyLink = 'https://platform.deepseek.com/api_keys';

    const rawKey = getStoredApiKey(currentProvider) || '';
    const safeKey = rawKey.replace(/"/g, '&quot;');

    return `
    <div class="space-y-6">
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
            <h3 class="font-bold text-indigo-800 mb-2">AI Configuration</h3>
            
            <div class="mb-4 bg-white p-3 rounded border border-indigo-100">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="aiSaveToggle" class="w-4 h-4 rounded text-indigo-600" ${saveHistory ? 'checked' : ''} onchange="budget.aiContext.saveHistory = this.checked; saveBudget();">
                    <div>
                        <span class="block text-sm font-bold text-gray-800">Save AI Context</span>
                        <span class="block text-xs text-gray-500">Save chat history and analysis to this specific budget file.</span>
                    </div>
                </label>
            </div>

            <div class="mb-3">
                <label class="block text-xs font-semibold text-indigo-600 mb-1">Active AI Provider</label>
                <select id="aiProviderSelect" class="w-full text-sm p-2 border rounded border-indigo-200">
                    <option value="gemini" ${currentProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                    <option value="openai" ${currentProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                    <option value="xai" ${currentProvider === 'xai' ? 'selected' : ''}>xAI</option>
                    <option value="deepseek" ${currentProvider === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                </select>
            </div>
            
            <div class="mb-1">
                <label class="block text-xs font-semibold text-indigo-600 mb-1">API Key</label>
                <div class="flex gap-2 w-full">
                    <input type="password" id="apiKeyInput" value="${safeKey}" class="flex-grow min-w-0 text-sm p-2 border rounded border-indigo-200 outline-none">
                    <button id="saveApiKeyBtn" class="flex-shrink-0 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                </div>
            </div>
            <p class="text-[10px] text-indigo-500 mt-1">Don't have a key? <a href="${keyLink}" target="_blank" class="underline font-bold">Get one here</a>.</p>
        </div>
    </div>`;
}

 else if (tabName === 'database') {
        const globalItems = getGlobalItems();
        const editItem = editingGlobalItemIndex > -1 ? globalItems[editingGlobalItemIndex] : null;
        return `
        <div class="space-y-4">
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4"><p class="text-xs text-yellow-800">These items appear first in the "Add Line Item" list.</p></div>
            
            <form id="addGlobalItemForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border ${editItem ? 'border-blue-300 bg-blue-50' : ''}">
                <div class="col-span-12 sm:col-span-5"><label class="block text-xs font-semibold text-gray-500 mb-1">Description</label><input type="text" id="dbDesc" aria-label="Description" class="w-full text-sm p-2 border rounded" required value="${editItem ? editItem.description : ''}"></div>
                <div class="col-span-6 sm:col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Unit</label><select id="dbUnit" aria-label="Unit" class="w-full text-sm p-2 border rounded"><option ${editItem?.unit === 'Day' ? 'selected' : ''}>Day</option><option ${editItem?.unit === 'Week' ? 'selected' : ''}>Week</option><option ${editItem?.unit === 'Flat' ? 'selected' : ''}>Flat</option></select></div>
                <div class="col-span-6 sm:col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Rate</label><input type="number" id="dbRate" aria-label="Rate" class="w-full text-sm p-2 border rounded" value="${editItem ? editItem.rate : ''}"></div>
                <div class="col-span-12 sm:col-span-1 flex gap-1 mt-2 sm:mt-0">${editItem ? `<button type="button" aria-label="Cancel" onclick="cancelEditGlobalItem()" class="w-full p-2 bg-gray-400 text-white rounded">x</button>` : ''}<button type="submit" aria-label="Save" class="w-full p-2 ${editItem ? 'bg-green-600' : 'bg-blue-600'} text-white rounded">${editItem ? 'âœ“' : '+'}</button></div>
            </form>

            <div class="relative">
                <input type="text" id="dbSearchInput" placeholder="Search line items..." class="w-full p-2 mb-2 border rounded text-sm focus:border-blue-500 focus:outline-none">
            </div>

            <div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto" id="dbListContainer">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-right">Rate</th><th class="p-2 text-center">Act</th></tr></thead>
                    <tbody id="dbListBody">
                        ${renderDbListItems(globalItems)}
                    </tbody>
                </table>
            </div>
        </div>`;
    } else if (tabName === 'roadmap') {
         // 1. Data Definition
         const futureItems = [
            "<b>Smart Discounts (v19.60):</b> Stage-specific rates (e.g., lower rate for Pre-Pro, higher for Shoot) with aggregate discount reporting.",
            "<b>Toast Notifications:</b> Replacing browser popups with sleek, non-intrusive status messages.",
            "<b>Cloud Integration:</b> Real Google Drive/Dropbox saving (replacing local storage).",
            "<b>AI 2.0:</b> Deep analysis of uploaded scripts/schedule PDFs to auto-suggest line items.",
            "<b>Open Gate Database:</b> Anonymous rate sharing to build a community cost averages database."
         ];

         const recentItems = [
            { v: "v19.53", t: "Stages & Polish", d: "<b>Stages:</b> 'Target Lock' budget balancing, 'Top Spenders' list, and 'Sync Days' to auto-update crew quantities.<br><b>UI:</b> Sticky Section Headers (Mobile), Inverted Summary Dashboard (EGT first).<br><b>Database:</b> Searchable line items & expanded default roles." },
            { v: "v19.52", t: "Cloud & Context", d: "<b>Files:</b> Import/Export .moo files, Attach context for AI.<br><b>Exports:</b> PDF/Excel landscape options." }
         ];

         const archiveItems = [
            { v: "v19.50", t: "Production Workflow", d: "<b>Crew:</b> Visual Avatars, Native Contact Import.<br><b>Actions:</b> WhatsApp/Email integration." },
            { v: "v19.49", t: "PWA Core", d: "Offline capability, 'Get Offline Tool' download." }
         ];

         // 2. Helper function
         const renderList = (items) => items.map(i => 
            `<li class="text-sm text-gray-700 mb-3">
                <span class="font-bold text-blue-700">${i.v}</span> 
                <span class="text-xs text-gray-500 font-mono">(${i.t})</span><br>
                <span class="text-gray-600">${i.d}</span>
            </li>`
         ).join('');

         // 3. Return the HTML structure
         return `
         <div class="space-y-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <h3 class="font-bold text-gray-800">Development Roadmap</h3>
                <button id="toggleRoadmapDetailsBtn" class="text-xs text-blue-600 font-semibold hover:bg-blue-50 px-2 py-1 rounded border border-transparent hover:border-blue-100 transition-colors">Expand History</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="relative pl-6 border-l-2 border-gray-200 space-y-8 ml-2">
                    
                    <div class="relative">
                        <div class="absolute -left-[31px] bg-white border-2 border-dashed border-purple-400 rounded-full w-4 h-4 mt-1.5 shadow-sm"></div>
                        <h4 class="text-md font-bold text-purple-800 mb-2">Up Next (v19.60 Logic Upgrade)</h4>
                        <ul class="space-y-2">
                            ${futureItems.map(f => `<li class="flex items-start gap-2 text-sm text-gray-600"><span class="text-purple-400 mt-0.5">â€¢</span> ${f}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="relative">
                        <div class="absolute -left-[33px] bg-blue-600 border-4 border-white shadow-md rounded-full w-6 h-6 mt-0"></div>
                        <h4 class="text-md font-bold text-blue-800 mb-2">Current Release (v19.53)</h4>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 shadow-sm">
                            <ul class="space-y-1">
                                ${renderList(recentItems)}
                            </ul>
                        </div>
                    </div>

                    <div class="relative roadmap-detail hidden transition-all duration-300">
                        <div class="absolute -left-[31px] bg-gray-400 border-2 border-white rounded-full w-4 h-4 mt-1.5"></div>
                        <h4 class="text-md font-bold text-gray-500 mb-2">Archive</h4>
                        <ul class="space-y-1 pl-1 opacity-75 border-t pt-2 mt-2">
                            ${renderList(archiveItems)}
                        </ul>
                    </div>
                    
                </div>
            </div>
         </div>`;
    }
}

        /* --- v19.50 Mobile Crew Toggle Helper v19.52 --- */
        window.toggleCrewPopup = function(el, event) {
            if(event) event.stopPropagation(); 
            const wrapper = el.parentElement;
            
            document.querySelectorAll('.crew-wrapper').forEach(div => {
                if (div !== wrapper) div.classList.remove('mobile-active');
            });
            
            wrapper.classList.toggle('mobile-active');
        };

        /* --- v19.50 Crew Profile Manager v19.52 --- */
   /* --- v19.54 [Crew] - Contact Card Actions (WA, Call, SMS, Email) --- */
window.openCrewProfile = function(el, event, itemId, sectionName) {
    if(event) event.stopPropagation();
    
    const section = budget.sections[sectionName];
    const item = section.items.find(i => i.id === itemId);
    if(!item) return;

    const crew = item.crew || { name: '', phone: '', email: '' };
    
    // 1. Prepare Action Links
    const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
    const hasPhone = cleanPhone.length > 6; // Basic validation
    const hasEmail = crew.email && crew.email.includes('@');
    
    const actionsBar = `
        <div class="flex justify-center gap-3 mb-6 mt-2">
            ${hasPhone ? `
                <a href="tel:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 border border-green-200 flex items-center justify-center shadow-sm group-hover:bg-green-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Call</span>
                </a>
                <a href="sms:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Text</span>
                </a>
                <a href="https://wa.me/${cleanPhone}" target="_blank" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200 flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">WhatsApp</span>
                </a>
            ` : ''}
            ${hasEmail ? `
                <a href="mailto:${crew.email}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-200 flex items-center justify-center shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Email</span>
                </a>
            ` : ''}
            ${!hasPhone && !hasEmail ? '<span class="text-xs text-gray-400 italic">Enter contact details to enable actions</span>' : ''}
        </div>
    `;

    const content = `
        <form id="crewProfileForm" class="space-y-4 p-1">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-3xl shadow-md border-4 border-white">
                    ${crew.name ? crew.name.substring(0,1).toUpperCase() : '?'}
                </div>
                <h3 class="text-lg font-bold text-gray-900 mt-2">${crew.name || 'New Crew Member'}</h3>
                <p class="text-sm text-blue-600 font-medium">${item.description}</p>
            </div>

            ${actionsBar}
            
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Contact Details</h4>
                    <button type="button" id="importContactBtn" class="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Import
                    </button>
                </div>
                
                <div>
                    <input type="text" id="crewName" value="${crew.name || ''}" placeholder="Full Name" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="tel" id="crewPhone" value="${crew.phone || ''}" placeholder="Phone" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="email" id="crewEmail" value="${crew.email || ''}" placeholder="Email" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="pt-2 flex justify-between items-center">
                <button type="button" class="text-red-500 text-xs font-bold hover:text-red-700 px-2" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Unassign</button>
                <button type="submit" class="bg-gray-900 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-black transition-transform active:scale-95">Save & Close</button>
            </div>
        </form>
    `;

    createModal('crewProfile', '', content, 'max-w-sm');

    // Attach Import Logic (Native)
    document.getElementById('importContactBtn').addEventListener('click', async () => {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                if (contacts.length) {
                    const c = contacts[0];
                    if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                    if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                    if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                }
            } catch (ex) { console.log(ex); }
        } else {
            alert("Contact import not supported on this device/browser.");
        }
    });

    // Attach Save Logic
    document.getElementById('crewProfileForm').addEventListener('submit', (e) => {
        e.preventDefault();
        item.crew = {
            name: document.getElementById('crewName').value.trim(),
            phone: document.getElementById('crewPhone').value.trim(),
            email: document.getElementById('crewEmail').value.trim()
        };
        pushToHistory(`Updated crew: ${item.crew.name}`);
        closeModal('crewProfileModal');
        
        // Refresh Screens
        render(); 
        if(document.getElementById('stagesViewModal')) showStagesModal(); 
    });
};

        window.clearCrewAssignment = function(itemId, sectionName) {
            if(confirm('Remove this person from the role?')) {
                const item = budget.sections[sectionName].items.find(i => i.id === itemId);
                if(item) {
                    delete item.crew;
                    pushToHistory(`Cleared crew from ${item.description}`);
                    closeModal('crewProfileModal');
                    render();
                }
            }
        };

/* --- v19.51 Export PDF with Options v19.52 --- */
function exportToPdf() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">PDF Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfFitToPageModal" class="w-4 h-4 rounded" checked>
                    <span class="text-sm font-medium text-gray-700">Fit to Page (Auto-scale)</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfLandscapeModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Landscape Orientation</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="closeModal('pdfExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmPdfExport" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Export PDF</button>
            </div>
        </div>
    `;
    
    createModal('pdfExport', 'Export Budget to PDF', content, 'max-w-md');
    
    document.getElementById('confirmPdfExport').addEventListener('click', () => {
        const fitToPage = document.getElementById('pdfFitToPageModal').checked;
        const hideZeroQty = document.getElementById('pdfHideZeroQtyModal').checked;
        const landscape = document.getElementById('pdfLandscapeModal').checked;
        const includeStages = document.getElementById('pdfStagesModal').checked;
        
        closeModal('pdfExportModal');
        generatePdfWithOptions(fitToPage, hideZeroQty, landscape, includeStages);
    });
}

function generatePdfWithOptions(fitToPage, hideZeroQty, landscape, includeStages) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: landscape ? 'landscape' : 'portrait' });
    
    doc.setFontSize(18);
    doc.text(budget.projectName || "Untitled Project", 14, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    const dateStr = new Date().toLocaleDateString();
    doc.text(`Generated: ${dateStr}`, 14, 26);
    
    const { subtotal } = calculateTotals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;
    
    const summaryData = [
        ['Subtotal', formatCurrency(toDisp(subtotal))],
        [`Contingency (${budget.contingencyPercentage}%)`, formatCurrency(toDisp(contingencyAmount))],
        [`Sales Tax (${budget.salesTaxPercentage}%)`, formatCurrency(toDisp(taxAmount))],
        [`Discount (${budget.discountPercentage}%)`, `-${formatCurrency(toDisp(discountAmount))}`],
        ['GRAND TOTAL', formatCurrency(toDisp(grandTotal))]
    ];

    doc.autoTable({
        startY: 32,
        head: [['Category', 'Amount']],
        body: summaryData,
        theme: 'striped',
        headStyles: { fillColor: [66, 66, 66] },
        columnStyles: { 
            0: { fontStyle: 'bold' },
            1: { halign: 'right' } 
        },
        margin: { left: 14, right: landscape ? 150 : 100 }
    });

    let finalY = doc.lastAutoTable.finalY + 10;
    const tableRows = [];
    
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        let sectionTotal = 0;
        const sectionItems = [];
        
        section.items.forEach(item => {
            if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;
            const { estimated } = calculateItem(item);
            sectionTotal += estimated;
            sectionItems.push([
                item.description,
                item.quantity,
                item.unit,
                formatCurrency(toDisp(item.rate)),
                formatCurrency(toDisp(estimated))
            ]);
        });
        
        if (sectionItems.length === 0) return;
        
        tableRows.push([{ 
            content: sectionName.toUpperCase(), 
            colSpan: 5, 
            styles: { fillColor: [220, 220, 220], fontStyle: 'bold', textColor: [0, 0, 0] } 
        }]);
        
        tableRows.push(...sectionItems);
        
        tableRows.push([{ 
            content: `Total ${sectionName}: ${formatCurrency(toDisp(sectionTotal))}`, 
            colSpan: 5, 
            styles: { halign: 'right', fontStyle: 'bold', fillColor: [245, 245, 245] } 
        }]);
    });

    const tableConfig = {
        startY: finalY,
        head: [['Description', 'Qty', 'Unit', 'Rate', 'Total']],
        body: tableRows,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
        styles: { fontSize: fitToPage ? 8 : 9, cellPadding: fitToPage ? 2 : 3 },
        pageBreak: 'auto',
    };
    
    if (fitToPage) {
        tableConfig.tableWidth = 'auto';
        tableConfig.columnStyles = {
            0: { cellWidth: 'auto' },
            1: { cellWidth: 15, halign: 'center' },
            2: { cellWidth: 15, halign: 'center' },
            3: { cellWidth: 25, halign: 'right' },
            4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
        };
    } else {
        tableConfig.columnStyles = {
            0: { cellWidth: 'auto' },
            1: { cellWidth: 20, halign: 'center' },
            2: { cellWidth: 20, halign: 'center' },
            3: { cellWidth: 30, halign: 'right' },
            4: { cellWidth: 35, halign: 'right', fontStyle: 'bold' }
        };
    }

    doc.autoTable(tableConfig);
    
    if (includeStages) {
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Production Stages Breakdown', 14, 20);
        doc.setFontSize(10);
        doc.text('(Feature coming in v19.52)', 14, 28);
    }

    doc.save(`${budget.projectName || 'Budget'}.pdf`);
}
        
 /* --- v19.51 Export Excel with Options v19.52 --- */
function exportToXlsx() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">Excel Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="closeModal('xlsxExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmXlsxExport" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">Export Excel</button>
            </div>
        </div>
    `;
    
    createModal('xlsxExport', 'Export Budget to Excel', content, 'max-w-md');
    
    document.getElementById('confirmXlsxExport').addEventListener('click', () => {
        const hideZeroQty = document.getElementById('xlsxHideZeroQtyModal').checked;
        const includeStages = document.getElementById('xlsxStagesModal').checked;
        
        closeModal('xlsxExportModal');
        generateXlsxWithOptions(hideZeroQty, includeStages);
    });
}

function generateXlsxWithOptions(hideZeroQty, includeStages) {
    const wb = XLSX.utils.book_new();
    const { subtotal } = calculateTotals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;
    const totalActual = calculateActuals(budget.sections);

    const data = [];
    
    data.push([budget.projectName || "Untitled Project"]);
    data.push([`Generated: ${new Date().toLocaleDateString()}`]);
    data.push([]);

    data.push(["BUDGET SUMMARY", ""]);
    data.push(["Subtotal", toDisp(subtotal)]);
    data.push([`Contingency (${budget.contingencyPercentage}%)`, toDisp(contingencyAmount)]);
    data.push([`Sales Tax (${budget.salesTaxPercentage}%)`, toDisp(taxAmount)]);
    data.push([`Discount (${budget.discountPercentage}%)`, -toDisp(discountAmount)]); 
    data.push(["GRAND TOTAL", toDisp(grandTotal)]);
    data.push(["TOTAL ACTUAL SPEND", toDisp(totalActual)]);
    data.push([]);

    data.push(["Description", "Qty", "Unit", "Rate", "Estimated", "Actual", "Variance"]);

    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        data.push([sectionName.toUpperCase(), "", "", "", "", "", ""]);
        let sectionEst = 0;
        let sectionAct = 0;

        section.items.forEach(item => {
            if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;

            const { estimated, variance } = calculateItem(item);
            sectionEst += estimated;
            sectionAct += (parseFloat(item.actual) || 0);

            data.push([
                item.description,
                item.quantity,
                item.unit,
                toDisp(item.rate),
                toDisp(estimated),
                toDisp(item.actual),
                toDisp(variance)
            ]);
        });

        data.push([
            `Total ${sectionName}`, 
            "", "", "", 
            toDisp(sectionEst), 
            toDisp(sectionAct), 
            toDisp(sectionAct - sectionEst)
        ]);
        data.push([]);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [
        { wch: 40 }, { wch: 8 }, { wch: 10 }, { wch: 15 },
        { wch: 15 }, { wch: 15 }, { wch: 15 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Budget Detail");
    
    if (includeStages) {
        const stagesData = [["Stages Breakdown"], ["Feature coming in v19.52"]];
        const stagesWs = XLSX.utils.aoa_to_sheet(stagesData);
        XLSX.utils.book_append_sheet(wb, stagesWs, "Stages");
    }
    
    XLSX.writeFile(wb, `${budget.projectName || 'Budget'}.xlsx`);
}

/* --- v19.51 .moo File Export/Import Logic v19.52 --- */
        function exportToMoo() {
    if (!budget) {
        alert("No active budget to export.");
        return;
    }
    const dataStr = JSON.stringify(budget, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeName = (budget.projectName || "untitled").replace(/[^a-z0-9]/gi, '_').toLowerCase();
    a.href = url;
    a.download = `${safeName}.moo`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.createObjectURL(url);
}

function handleUniversalImport() {
    if (budget && budget.projectName) saveBudget();

    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = '.moo,.json,.pdf,.doc,.docx,.txt,.rtf,.md,.csv,.xls,.xlsx,image/*';
    input.style.display = 'none';
    document.body.appendChild(input);

    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        let budgetImported = false;
        let attachedCount = 0;

        try {
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();

                if (ext === 'moo' || (ext === 'json' && file.name.includes('Budget'))) {
                    if (budgetImported) {
                        alert("Notice: Skipped extra budget file. Please import one project at a time.");
                        continue;
                    }

                    const textContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsText(file);
                    });

                    try {
                        const importedBudget = JSON.parse(textContent);
                        if (!importedBudget.sections || !importedBudget.projectName) throw new Error("Missing required budget data");

                        const existingProjects = getProjectList();
                        let newName = importedBudget.projectName;

                        while (existingProjects.includes(newName)) {
                            const userResponse = prompt(
                                `Project "${newName}" already exists.\n\nEnter a new name to open it as a separate project:`, 
                                `${newName} (Imported)`
                            );
                            if (userResponse === null) throw new Error("Import cancelled by user.");
                            newName = userResponse.trim();
                            if (!newName) throw new Error("Name cannot be empty.");
                        }

                        importedBudget.projectName = newName;
                        if (!importedBudget.attachments) importedBudget.attachments = []; 
                        
                        localStorage.setItem(storageKeyPrefix + newName, JSON.stringify(importedBudget));
                        loadBudget(newName); 
                        budgetImported = true;

                    } catch (parseErr) {
                        alert(`Failed to load project "${file.name}": ${parseErr.message}`);
                    }
                } 
                else {
                    if (!budget) { 
                        alert("Please open a project before attaching files."); 
                        continue; 
                    }
                    if (!budget.attachments) budget.attachments = [];

                    const attachment = {
                        id: generateSafeId(),
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        dateAdded: new Date().toISOString(),
                        content: null
                    };

                    try {
                        if (['txt','csv','rtf','md'].includes(ext)) {
                             const text = await file.text();
                             attachment.content = text.substring(0, 25000); 
                        }
                    } catch (err) { console.warn("Text extraction failed", err); }

                    budget.attachments.push(attachment);
                    attachedCount++;
                }
            }

            if (attachedCount > 0) saveBudget();

            render(); 

            let msg = "";
            if (budgetImported) msg += `âœ… Loaded Project: "${budget.projectName}"\n`;
            if (attachedCount > 0) msg += `ðŸ“Ž ${attachedCount} file(s) added to Production Consultant tray.`;
            
            if(msg) alert(msg.trim());

            if (document.getElementById('aiToolsModal') && !document.getElementById('aiToolsModal').classList.contains('hidden')) {
                showAIToolsModal();
            }

        } catch (globalErr) {
            console.error("Import Error:", globalErr);
        } finally {
            document.body.removeChild(input);
        }
    };

    input.click();
}

function removeAttachment(id) {
    if(!budget || !budget.attachments) return;
    budget.attachments = budget.attachments.filter(a => a.id !== id);
    saveBudget();
    showAIToolsModal();
}

        function downloadOfflineHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `mooBudgetTool_v${APP_VERSION}.html`;
            a.click();
        }

/* --- P4 --- */

/* --- v19.53 Project Management UI Consolidated, Minimal & Fitted --- */
function renderProjectManagement() {
    const container = document.getElementById('project-management-container');
    if (container) {
        const templates = getAllTemplates();
        const templateOptions = Object.keys(templates).map(k => `<option value="${k}">New ${k}</option>`).join('');

        const currencyOptions = (typeof FILM_CURRENCIES !== 'undefined' ? FILM_CURRENCIES : [{ code: 'JMD', label: 'JMD' }, { code: 'USD', label: 'USD' }])
            .map(c => `<option value="${c.code}" ${displayCurrency === c.code ? 'selected' : ''}>${c.code}</option>`)
            .join('');

        container.innerHTML = `
        <div id="project-management" class="flex flex-wrap items-center justify-between w-full gap-2">

            <div class="flex items-center gap-2 flex-grow max-w-full sm:max-w-lg">
                <div class="relative flex-grow min-w-0">
                    <select id="projectLoader" aria-label="Load Project" class="appearance-none w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 truncate font-semibold shadow-sm">
                        ${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>

                <div class="relative flex-shrink-0">
                    <select id="newProjectSelector" aria-label="File Menu" class="appearance-none w-20 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg cursor-pointer text-center focus:outline-none focus:ring-2 focus:ring-blue-400 shadow-sm transition-colors">
                        <option value="" disabled selected>File</option>
                        ${templateOptions}
                        <option value="" disabled>---</option>
                        <option value="Duplicate">Duplicate</option>
                        <option value="ImportFile">Import</option>
                        <option value="Recover">Recover</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-1.5 flex-shrink-0">
                
                <select id="currencySelector" class="appearance-none bg-purple-600 text-white text-sm font-bold rounded-lg px-3 py-2.5 hover:bg-purple-700 border border-purple-500 shadow-sm cursor-pointer outline-none transition-colors text-center">
                    ${currencyOptions}
                </select>

                <button id="exportMooBtn" class="p-2.5 bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-300 border border-yellow-500 shadow-sm transition-colors flex items-center justify-center" title="Export Project (.moo)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>

                <button id="deleteProjectBtn" class="p-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm transition-colors flex items-center justify-center" title="Delete Project">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>

                <div class="h-6 w-px bg-gray-300 mx-1 hidden sm:block"></div>

                <div class="flex gap-1">
                    <button id="exportXlsxBtn" class="px-3 py-2.5 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 shadow-sm transition-colors">XLS</button>
                    <button id="exportPdfBtn" class="px-3 py-2.5 bg-gray-600 text-white text-sm font-bold rounded-lg hover:bg-gray-700 shadow-sm transition-colors">PDF</button>
                </div>

                <button id="publishBtn" class="hidden"></button>
            </div>
        </div>`;

        // Re-attach listeners
        document.getElementById('exportMooBtn')?.addEventListener('click', exportToMoo);
        document.getElementById('currencySelector')?.addEventListener('change', (e) => {
            displayCurrency = e.target.value;
            localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
            render();
        });

        document.getElementById('publishBtn')?.addEventListener('click', () => {
            const content = `
                <div class="text-center p-6 space-y-4">
                    <div class="inline-block p-4 bg-blue-50 text-blue-600 rounded-full text-4xl mb-2">â˜ï¸</div>
                    <h3 class="text-xl font-bold text-gray-800">Cloud Integration Coming Soon</h3>
                    <p class="text-gray-600">Save directly to Google Drive, Dropbox, or OneDrive.</p>
                    <div class="flex justify-center gap-6 py-4">
                        <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Google Drive">
                            <svg class="w-10 h-10" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#0066da"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ff3333"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#00ac47"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ea4335"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/></svg>
                            <span class="text-[10px] font-bold text-gray-500 uppercase">Drive</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Dropbox">
                            <svg class="w-10 h-10" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.8 20L32 32L51.2 20L32 8L12.8 20Z" fill="#0061FF"/><path d="M12.8 44L32 56L51.2 44L32 32L12.8 44Z" fill="#0061FF"/><path d="M12.8 44L32 56V32L12.8 20V44Z" fill="#0061FF"/><path d="M51.2 44L32 56V32L51.2 20V44Z" fill="#0061FF"/></svg>
                            <span class="text-[10px] font-bold text-gray-500 uppercase">Dropbox</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="OneDrive">
                            <svg class="w-10 h-10" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M42.3 11C35.8 11 30.1 14.8 27.5 20.3 26.5 20 25.4 19.8 24.3 19.8 17.5 19.8 12 25.3 12 32c0 1.2.2 2.3.5 3.4C10.5 36.8 9.3 38.3 9.3 40c0 3.3 2.7 6 6 6h32.1c8.1 0 14.6-6.6 14.6-14.7 0-7.8-6.1-14.2-13.8-14.6C47.3 14.5 45 11 42.3 11z" fill="#0078D4"/></svg>
                            <span class="text-[10px] font-bold text-gray-500 uppercase">OneDrive</span>
                        </div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-lg text-left text-sm text-yellow-800 mt-4">
                        <strong>Need storage?</strong><br>
                        When this feature launches, users who need to create new cloud accounts will get exclusive discounts on storage plans via our partners.
                    </div>
                    <button onclick="closeModal('publishPlaceholderModal')" class="mt-4 px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Got it</button>
                </div>
            `;
            createModal('publishPlaceholder', 'Publish to Cloud', content, 'max-w-sm');
        });
    }
}

function makeInputDraggable(input) {
    if (!input || input.dataset.draggable === 'true') return;
    input.dataset.draggable = 'true';
    input.style.cursor = 'ew-resize';
    
    let startX, startVal;
    const onMove = (e) => { 
        const delta = e.clientX - startX; 
        input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
        input.dispatchEvent(new Event('input', {bubbles:true})); 
    };
    const onUp = () => { 
        document.removeEventListener('mousemove', onMove); 
        document.removeEventListener('mouseup', onUp); 
    };
    
    input.addEventListener('mousedown', (e) => { 
        if(input === document.activeElement) return; 
        startX = e.clientX; 
        startVal = parseFloat(input.value)||0; 
        document.addEventListener('mousemove', onMove); 
        document.addEventListener('mouseup', onUp); 
    });
}

function initializeInteractiveInputs() { 
    ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
        const el = document.getElementById(id);
        if(el) makeInputDraggable(el);
    });
}

function updateOnlineStatus() { 
    const isOnline = navigator.onLine;
    const btn = document.getElementById('loginBtn'); 
    if(btn) { 
        btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'status-online' : 'status-offline'}`; 
        btn.title = isOnline ? "Online" : "Offline"; 
    }
    const aiBtn = document.getElementById('openAiToolsBtn');
    if(aiBtn) {
        aiBtn.className = `p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200' : 'bg-red-100 border-red-200 text-red-800 cursor-not-allowed opacity-75'}`;
        if(!isOnline) aiBtn.title = "Offline - AI Unavailable";
    }
}

function handleLogin() { if (navigator.onLine && confirm("Simulate Login?")) alert("Logged in!"); }

// --- v19.36 Template Events & Logic ---
function bindTemplateEvents() {
    document.getElementById('templateSelector')?.addEventListener('change', (e) => {
        editingTemplateId = e.target.value;
        tempTemplateData = null; 
        window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
    });

    document.getElementById('createTemplateBtn')?.addEventListener('click', () => {
        const isDefault = ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId);
        const suggestedName = isDefault ? `New ${editingTemplateId}` : '';
        const name = prompt("Enter new template name (e.g., 'Music Video'):", suggestedName);
        if (name) {
            const allTemplates = getAllTemplates();
            if(allTemplates[name]) return alert("Template name already exists.");
            const base = editingTemplateId ? allTemplates[editingTemplateId] : DEFAULT_TEMPLATES['Commercial'];
            allTemplates[name] = JSON.parse(JSON.stringify(base));
            allTemplates[name].projectName = `Untitled ${name} Project`;
            saveAllTemplates(allTemplates);
            editingTemplateId = name;
            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
        }
    });

    document.getElementById('importTemplateBtn')?.addEventListener('click', () => {
        const jsonStr = prompt("Paste template JSON string here:");
        if(jsonStr) {
            try {
                const parsed = JSON.parse(jsonStr);
                if(!parsed.sections) throw new Error("Invalid template format.");
                const name = prompt("Name for this imported template:", "Imported Template");
                if(name) {
                    const allTemplates = getAllTemplates();
                    allTemplates[name] = parsed;
                    saveAllTemplates(allTemplates);
                    editingTemplateId = name;
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            } catch(e) { alert("Import Failed: " + e.message); }
        }
    });

    document.getElementById('exportTemplateBtn')?.addEventListener('click', () => {
        if(!editingTemplateId) return;
        const allTemplates = getAllTemplates();
        const data = JSON.stringify(allTemplates[editingTemplateId]);
        navigator.clipboard.writeText(data).then(() => alert("Template JSON copied to clipboard!")).catch(() => prompt("Copy this:", data));
    });

    document.getElementById('deleteTemplateBtn')?.addEventListener('click', () => {
        if(!editingTemplateId || ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId)) {
            return alert("Cannot delete default templates.");
        }
        if(confirm(`Delete template "${editingTemplateId}"?`)) {
            const allTemplates = getAllTemplates();
            delete allTemplates[editingTemplateId];
            saveAllTemplates(allTemplates);
            editingTemplateId = 'Commercial';
            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
        }
    });

    document.getElementById('saveTemplateChangesBtn')?.addEventListener('click', () => {
        if(isDefaultTemplate(editingTemplateId)) {
            return alert("Cannot edit default templates directly. Please create a copy.");
        }
        if (tempTemplateData && editingTemplateId) {
            const allTemplates = getAllTemplates();
            allTemplates[editingTemplateId] = tempTemplateData;
            saveAllTemplates(allTemplates);
            alert("Template Saved!");
            tempTemplateData = null;
        }
    });

    const editorContainer = document.getElementById('templateEditorContainer');
    if(editorContainer) {
        renderTemplateEditor(editorContainer);

        if(isDefaultTemplate(editingTemplateId)) return; 

        editorContainer.addEventListener('change', (e) => {
            const target = e.target;
            
            if (target.dataset.daysField) {
                 if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                 if(!tempTemplateData.days) tempTemplateData.days = { principal: 10, scouting: 5, preprod: 15 };
                 
                 const field = target.dataset.daysField;
                 tempTemplateData.days[field] = parseFloat(target.value) || 0;
                 recalculateTemplateQuantities(tempTemplateData);
                 renderTemplateEditor(editorContainer);
                 return;
            }

            if (target.dataset.templateField) {
                if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                
                const field = target.dataset.templateField;
                const val = target.value;
                
                if(target.dataset.templateId) { 
                    const section = tempTemplateData.sections[target.dataset.templateSection];
                    const item = section.items.find(i => i.id === target.dataset.templateId);
                    if(item) {
                        if(['quantity', 'rate', 'multiplier'].includes(field)) item[field] = parseFloat(val);
                        else item[field] = val;
                    }
                } else { 
                    if(['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(field)) tempTemplateData[field] = parseFloat(val);
                }
            }
        });

        editorContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));

            if(btn.dataset.templateAddItem) {
                const sectionName = btn.dataset.templateAddItem;
                tempTemplateData.sections[sectionName].items.push({ id: crypto.randomUUID(), ...initialLineItem });
                renderTemplateEditor(editorContainer);
            } else if (btn.dataset.templateRemoveItem) {
                const sectionName = btn.dataset.templateSection;
                const itemId = btn.dataset.templateRemoveItem;
                const idx = tempTemplateData.sections[sectionName].items.findIndex(i => i.id === itemId);
                if(idx > -1) {
                    tempTemplateData.sections[sectionName].items.splice(idx, 1);
                    renderTemplateEditor(editorContainer);
                }
            } else if (btn.dataset.templateRemoveSection) {
                const sectionName = btn.dataset.templateRemoveSection;
                if(confirm("Delete section?")) {
                    delete tempTemplateData.sections[sectionName];
                    renderTemplateEditor(editorContainer);
                }
            } else if (btn.id === 'addTemplateSectionBtn') {
                const name = prompt("New Section Name:");
                if(name && !tempTemplateData.sections[name]) {
                    tempTemplateData.sections[name] = { isOpen: true, items: [] };
                    renderTemplateEditor(editorContainer);
                }
            }
        });
    }
}

function recalculateTemplateQuantities(data) {
    if(!data.days) return;
    const { principal, scouting, preprod } = data.days;
    const totalRun = principal + scouting + preprod;
    const prepScout = scouting + preprod;
    
    const fullRunRegex = /(director|producer|camera|dp|operator|ac|gaffer|grip|mixer|sound|supervisor|manager|coordinator|pa|assistant)/i;
    const prepRegex = /(researcher|location|casting)/i;

    Object.values(data.sections).forEach(section => {
        section.items.forEach(item => {
            if(item.unit !== 'Day') return;
            const desc = item.description.toLowerCase();
            if (fullRunRegex.test(desc)) item.quantity = totalRun;
            else if (prepRegex.test(desc)) item.quantity = prepScout;
        });
    });
}

function isDefaultTemplate(id) {
    return ['Commercial', 'Documentary', 'LiveStream'].includes(id);
}

function renderTemplateEditor(container) {
    if (!container) return; 
    const data = tempTemplateData || getAllTemplates()[editingTemplateId];
    if(!data) return;
    
    if (!data.days) data.days = { principal: 10, scouting: 5, preprod: 15 };

    const isReadOnly = isDefaultTemplate(editingTemplateId);
    const disabledAttr = isReadOnly ? 'disabled' : '';
    const readOnlyBanner = isReadOnly ? `<div class="mb-4 p-2 bg-yellow-50 text-yellow-800 text-xs border border-yellow-200 rounded flex items-center gap-2"><span class="font-bold">âš  Default Template:</span> Read-only mode. Click "Clone / New" to create an editable copy.</div>` : '';

    let html = `
        ${readOnlyBanner}
        <div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded">
            <h3 class="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wide">Production Days Inputs</h3>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs text-indigo-700 mb-1">Principal</label><input type="number" data-days-field="principal" value="${data.days.principal}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                <div><label class="block text-xs text-indigo-700 mb-1">Scouting</label><input type="number" data-days-field="scouting" value="${data.days.scouting}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                <div><label class="block text-xs text-indigo-700 mb-1">Pre-Prod</label><input type="number" data-days-field="preprod" value="${data.days.preprod}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
            </div>
            <p class="text-[10px] text-indigo-400 mt-2 italic">Updating these automatically adjusts quantities for standard roles.</p>
        </div>
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded grid grid-cols-3 gap-4">
            <div><label class="block text-xs font-bold text-gray-700">Contingency %</label><input type="number" step="0.1" value="${data.contingencyPercentage}" ${disabledAttr} data-template-field="contingencyPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
            <div><label class="block text-xs font-bold text-gray-700">Sales Tax %</label><input type="number" step="0.1" value="${data.salesTaxPercentage}" ${disabledAttr} data-template-field="salesTaxPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
            <div><label class="block text-xs font-bold text-gray-700">Discount %</label><input type="number" step="0.1" value="${data.discountPercentage}" ${disabledAttr} data-template-field="discountPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
        </div>`;

    Object.entries(data.sections).forEach(([sectionName, section]) => {
        html += `
        <div class="mb-4 border rounded-lg overflow-hidden">
            <div class="bg-gray-100 p-2 flex justify-between items-center"><h3 class="font-bold text-sm text-gray-700">${sectionName}</h3>${!isReadOnly ? `<button data-template-remove-section="${sectionName}" class="text-red-400 hover:text-red-600">Ã—</button>` : ''}</div>
            <div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50 text-gray-500"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-center w-12">Qty</th><th class="p-2 text-left w-20">Unit</th><th class="p-2 text-right w-24">Rate</th><th class="w-8"></th></tr></thead><tbody>
            ${section.items.map(item => `<tr class="border-t hover:bg-gray-50"><td class="p-1"><input class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" value="${item.description}" ${disabledAttr} data-template-field="description" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><input type="number" class="w-full bg-transparent text-center ${isReadOnly ? 'text-gray-500' : 'font-bold text-blue-600'}" value="${item.quantity}" ${disabledAttr} data-template-field="quantity" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><select class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" ${disabledAttr} data-template-field="unit" data-template-id="${item.id}" data-template-section="${sectionName}"><option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option></select></td><td class="p-1"><input type="number" class="w-full bg-transparent text-right ${isReadOnly ? 'text-gray-500' : ''}" value="${item.rate}" ${disabledAttr} data-template-field="rate" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1 text-center">${!isReadOnly ? `<button data-template-remove-item="${item.id}" data-template-section="${sectionName}" class="text-gray-400 hover:text-red-500">Ã—</button>` : ''}</td></tr>`).join('')}
            </tbody></table></div>${!isReadOnly ? `<button data-template-add-item="${sectionName}" class="w-full p-2 text-center text-xs text-blue-500 hover:bg-blue-50">+ Add Line Item</button>` : ''}
        </div>`;
    });

    if (!isReadOnly) html += `<button id="addTemplateSectionBtn" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 font-medium text-sm">Add New Section</button>`;
    container.innerHTML = html;
}

window.editGlobalItem = function(index) { editingGlobalItemIndex = index; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
window.cancelEditGlobalItem = function() { editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
window.deleteGlobalItem = function(idx) { if (confirm("Remove item?")) { const items = getGlobalItems(); items.splice(idx, 1); saveGlobalItems(items); if(editingGlobalItemIndex === idx) editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); } };
window.handleRestore = function(index) {
    const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
    const projectToRestore = trash.splice(index, 1)[0];
    if (projectToRestore) {
        delete projectToRestore.deletedTimestamp;
        localStorage.setItem(storageKeyPrefix + projectToRestore.projectName, JSON.stringify(projectToRestore));
        localStorage.setItem(trashKey, JSON.stringify(trash));
        loadBudget(projectToRestore.projectName);
        render();
    }
    closeModal('recoveryModal');
};
window.handlePermanentDelete = function(index) {
    if (confirm("Delete forever?")) { const trash = JSON.parse(localStorage.getItem(trashKey) || '[]'); trash.splice(index, 1); localStorage.setItem(trashKey, JSON.stringify(trash)); showRecoveryModal(); }
}

window.handleRestoreAll = function() {
    const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
    if (trash.length === 0) return;
    if (confirm(`Restore all ${trash.length} projects?`)) {
        trash.forEach(project => {
            delete project.deletedTimestamp;
            localStorage.setItem(storageKeyPrefix + project.projectName, JSON.stringify(project));
        });
        localStorage.removeItem(trashKey);
        showRecoveryModal();
        render(); 
    }
};

window.handleDeleteAllTrash = function() {
    if (confirm("Permanently delete ALL projects in trash?")) {
        localStorage.removeItem(trashKey);
        showRecoveryModal();
    }
};

/* --- v19.53 AI Handlers with Persistence --- */
async function handleAnalyzeBudget() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const outputDiv = document.getElementById('aiAnalysisOutput');
    outputDiv.innerHTML = '<div class="text-blue-600 animate-pulse">Analyzing...</div>';
    
    const simplifiedBudget = { project: budget.projectName, totals: calculateTotals(budget.sections), sections: {} };
    for (const [name, sec] of Object.entries(budget.sections)) simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join(', ');
    
    // v19.53: Specific Prompt
    const prompt = `Analyze this budget JSON. 1. Missing roles/equip? 2. Rate anomalies? 3. Risks? Budget Data: ${JSON.stringify(simplifiedBudget)}`;
    
    try { 
        const response = await callUnifiedAI(provider, key, prompt); 
        const html = marked.parse(response);
        outputDiv.innerHTML = html;
        
        // Save if enabled
        if (budget.aiContext && budget.aiContext.saveHistory) {
            budget.aiContext.analysis = html;
            saveBudget();
        }
    } catch (error) { outputDiv.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`; }
}

/* --- v19.53 [AI] - Context-Aware Chat (Budget + Analysis + Files) --- */
async function handleConsultantChat() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    if (!message) return;

    // 1. UI Update (User Bubble)
    const chatHistory = document.getElementById('aiChatHistory');
    const userBubble = `<div class="ai-message user">${message}</div>`;
    chatHistory.innerHTML += userBubble;

    input.value = '';
    chatHistory.scrollTop = chatHistory.scrollHeight;

    // 2. UI Update (Loading Bubble)
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'ai-message assistant text-gray-400 italic';
    loadingMsg.textContent = `Thinking (${provider})...`;
    chatHistory.appendChild(loadingMsg);

    try {
        // 3. Gather Context Data
        
        // A. Budget Summary (Simplified for token efficiency)
        const simplifiedBudget = { project: budget.projectName, sections: {} };
        for (const [name, sec] of Object.entries(budget.sections)) {
            if(sec.items.length > 0) {
                simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join('; ');
            }
        }
        const budgetContext = `\nCURRENT BUDGET ITEMS:\n${JSON.stringify(simplifiedBudget)}`;

        // B. Previous Analysis (Strip HTML tags for clean text)
        const analysisText = (budget.aiContext && budget.aiContext.analysis) ? 
            budget.aiContext.analysis.replace(/<[^>]*>/g, '') : "None";
        const analysisContext = `\nPREVIOUS AI ANALYSIS:\n${analysisText}`;

        // C. Attached Files (Limit text length per file to prevent API errors)
        let fileContext = "";
        if (budget.attachments && budget.attachments.length > 0) {
            fileContext = "\nATTACHED FILE CONTEXT:\n" + budget.attachments.map(f => 
                `[File: ${f.name}]\n${f.content ? f.content.substring(0, 1500) + (f.content.length > 1500 ? "..." : "") : "(No readable text)"}`
            ).join("\n\n");
        }

        // 4. Construct Final Prompt
        const fullContext = `SYSTEM CONTEXT:${budgetContext}${analysisContext}${fileContext}`;
        const finalPrompt = `${fullContext}\n\nUSER QUESTION: ${message}\n\nINSTRUCTION: Answer the user's question referencing the specific budget items, file content, or analysis above where relevant. Keep answers concise.`;

        // 5. Call AI
        const response = await callUnifiedAI(provider, key, finalPrompt);
        
        // 6. Render Response & Save
        const html = marked.parse(response);
        loadingMsg.innerHTML = html;
        loadingMsg.className = 'ai-message assistant';

        if (budget.aiContext && budget.aiContext.saveHistory) {
            budget.aiContext.chat.push({ role: 'user', content: userBubble });
            budget.aiContext.chat.push({ role: 'assistant', content: loadingMsg.outerHTML });
            saveBudget();
        }

    } catch (error) {
        loadingMsg.textContent = `Error: ${error.message}`;
        loadingMsg.classList.add('text-red-500');
    }
}

/* --- v19.53 [Target Lock] - Modal Logic --- */
function showTargetLockModal() {
    if (!budget.targetLock) {
        budget.targetLock = {
            enabled: false, totalCap: 0,
            stages: {
                'dev': { label: 'Development', ratio: 5, days: 0 },
                'pre': { label: 'Pre-Production', ratio: 20, days: 0 },
                'prod': { label: 'Production', ratio: 55, days: 0 },
                'post': { label: 'Post-Production', ratio: 15, days: 0 },
                'dist': { label: 'Distribution', ratio: 5, days: 0 }
            }
        };
    }
    Object.values(budget.targetLock.stages).forEach(stage => { if (stage.days === undefined) stage.days = 0; });
    
    const tl = budget.targetLock;
    const calcLimit = (ratio) => (tl.totalCap * (ratio / 100));

    const content = `
        <div class="space-y-6">
            <div class="bg-gray-900 text-white p-5 rounded-xl shadow-lg flex flex-col items-center justify-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Total Funding Cap</label>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-bold text-gray-500">$</span>
                    <input type="number" id="tlTotalCap" value="${tl.totalCap}" class="bg-transparent text-4xl sm:text-5xl font-bold text-center w-full max-w-[250px] focus:outline-none focus:border-b-2 border-gray-600 focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">ðŸŽ¯ Stage Ratios</h3>
                <div id="stageSlidersContainer" class="space-y-5">
                    ${Object.entries(tl.stages).map(([key, stage]) => `
                        <div class="relative">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-gray-700">${stage.label}</span>
                                <span class="font-mono text-blue-600" id="disp_amt_${key}">${formatCurrency(calcLimit(stage.ratio))}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="range" min="0" max="100" value="${stage.ratio}" data-stage-key="${key}" class="stage-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                <div class="w-12 text-right"><span class="text-sm font-bold text-gray-800" id="disp_perc_${key}">${stage.ratio.toFixed(0)}%</span></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500 uppercase">Total Allocation</span>
                    <span id="ratioTotalDisplay" class="text-lg font-bold">100%</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('targetLockModal')" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Cancel</button>
                <button id="saveTargetLockBtn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">Engage Target Lock</button>
            </div>
        </div>
    `;

    createModal('targetLock', 'Target Lock Setup', content, 'max-w-md');

    const capInput = document.getElementById('tlTotalCap');
    const sliders = document.querySelectorAll('.stage-slider');
    const totalDisp = document.getElementById('ratioTotalDisplay');

    function updateCalculations() {
        const cap = parseFloat(capInput.value) || 0;
        let currentTotalPerc = 0;
        sliders.forEach(slider => {
            const key = slider.dataset.stageKey;
            const val = parseFloat(slider.value);
            currentTotalPerc += val;
            document.getElementById(`disp_perc_${key}`).textContent = val.toFixed(0) + '%';
            document.getElementById(`disp_amt_${key}`).textContent = formatCurrency(cap * (val / 100));
        });
        totalDisp.textContent = currentTotalPerc.toFixed(0) + '%';
        totalDisp.className = `text-lg font-bold ${Math.round(currentTotalPerc) === 100 ? 'text-green-600' : 'text-red-500'}`;
    }

    capInput.addEventListener('input', updateCalculations);
    sliders.forEach(s => s.addEventListener('input', updateCalculations));

    document.getElementById('saveTargetLockBtn').addEventListener('click', () => {
        budget.targetLock.enabled = true;
        budget.targetLock.totalCap = parseFloat(capInput.value) || 0;
        sliders.forEach(slider => {
            const key = slider.dataset.stageKey;
            budget.targetLock.stages[key].ratio = parseFloat(slider.value);
        });
        pushToHistory('Updated Target Lock');
        closeModal('targetLockModal');
        render(); 
    });
}

/* --- v19.54 [Stages] - Logic V3 (Presets, Sync, Proportional Locks) --- */

// 1. Presets for "Distribute" Button
const STAGE_PRESETS = {
    'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
    'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
    'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
    'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
};

// 2. Sync Logic (Weighted Average)
function syncStageToMain(item) {
    if (!item.stageData) return;
    let totalDays = 0, totalCost = 0;
    Object.values(item.stageData).forEach(d => {
        const days = parseFloat(d.days) || 0;
        const rate = parseFloat(d.rate) || 0;
        totalDays += days;
        totalCost += (days * rate);
    });
    if (totalDays > 0) {
        item.quantity = totalDays;
        item.rate = totalCost / totalDays;
        item.unit = 'Day'; 
    }
}

// 3. Remove Item Helper
window.removeStageItem = function(itemId, sectionName, stageKey) {
    const item = budget.sections[sectionName].items.find(i => i.id === itemId);
    if (item && item.stageData && item.stageData[stageKey]) {
        if(confirm("Remove item from this stage?")) {
            delete item.stageData[stageKey];
            syncStageToMain(item);
            pushToHistory(`Removed item from ${stageKey}`);
            const card = document.querySelector(`.stage-card-item[data-item-id="${itemId}"][data-stage="${stageKey}"]`);
            if(card) card.remove();
            updateAllHeaders(); // Recalc totals without full re-render
            render();
        }
    }
};

// 4. Proportional Slider Balancing
function balanceStageSliders(changedKey, newValue) {
    const stages = budget.targetLock.stages;
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    
    newValue = Math.max(0, Math.min(100, newValue));
    
    // Check locks
    const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
    const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
    
    const lockedTotal = lockedKeys.reduce((s, k) => s + stages[k].ratio, 0);
    const maxAvailable = 100 - lockedTotal;
    
    if (newValue > maxAvailable) newValue = maxAvailable;
    stages[changedKey].ratio = newValue;
    
    const remaining = 100 - newValue - lockedTotal;
    
    if (unlockedKeys.length > 0) {
        const currentUnlockedTotal = unlockedKeys.reduce((s, k) => s + stages[k].ratio, 0);
        unlockedKeys.forEach(k => {
            if (currentUnlockedTotal <= 0) stages[k].ratio = remaining / unlockedKeys.length;
            else stages[k].ratio = remaining * (stages[k].ratio / currentUnlockedTotal);
        });
    }
}

// 5. Apply Preset Handler
window.applyStagePreset = function(presetName) {
    const ratios = STAGE_PRESETS[presetName];
    if (!ratios) return;
    Object.keys(ratios).forEach(k => {
        if (budget.targetLock.stages[k]) {
            budget.targetLock.stages[k].ratio = ratios[k];
            budget.targetLock.stages[k].locked = false;
        }
    });
    updateAllHeaders(); 
    pushToHistory(`Applied ${presetName} preset`);
};

/* --- v19.54 [Stages] - UI V11 (Stable, Aligned, Live Calc) --- */
function showStagesModal() {
    try {
        // A. Init Data
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

        // B. Data Prep
        const stageData = {};
        validKeys.forEach(k => stageData[k] = { items: [], total: 0 });
        let grandTotal = 0;
        const allItemsFlat = [];

        Object.entries(budget.sections).forEach(([sectionName, section]) => {
            section.items.forEach(item => {
                // Ensure defaults
                if (!item.stageData) { 
                    item.stageData = {};
                    let target = 'prod';
                    const lower = item.description.toLowerCase();
                    if (/post|edit/.test(lower)) target = 'post';
                    else if (/pre|cast/.test(lower)) target = 'pre';
                    else if (/dev|write/.test(lower)) target = 'dev';
                    item.stageData[target] = { days: item.quantity, rate: item.rate };
                }
                
                Object.entries(item.stageData).forEach(([k, d]) => {
                    if (validKeys.includes(k)) {
                        const cost = (parseFloat(d.days)||0) * (parseFloat(d.rate)||0);
                        stageData[k].items.push({...item, _sDays:d.days, _sRate:d.rate, _sCost:cost, _sec:sectionName});
                        stageData[k].total += cost;
                        grandTotal += cost;
                        if (cost > 0) allItemsFlat.push({ desc: item.description, cost: cost, stage: tl.stages[k].label });
                    }
                });
            });
        });

        const topSpenders = allItemsFlat.sort((a, b) => b.cost - a.cost).slice(0, 5);

        // C. Render Helpers
        const renderSetupCard = () => `
            <div id="card-setup" class="stage-card min-w-[300px] flex-shrink-0 h-full bg-white border-r border-gray-200 flex flex-col snap-center">
                <div class="p-3 bg-gray-900 text-white flex-shrink-0"><h3 class="text-xs font-bold uppercase tracking-widest">Setup</h3></div>
                <div class="p-3 space-y-4 flex-grow overflow-y-auto">
                    <div><label class="text-[10px] text-gray-500 uppercase font-bold">Total Cap</label><div class="flex items-center gap-2 border-b border-gray-300 pb-1"><span class="text-xl text-gray-400">$</span><input id="tlTotalCapInput" type="number" value="${tl.totalCap}" class="bg-transparent text-xl font-bold w-full outline-none text-gray-800" onchange="budget.targetLock.totalCap=parseFloat(this.value); updateAllHeaders(); saveBudget();"></div></div>
                    <div class="bg-blue-50 p-2 rounded border border-blue-100"><label class="text-[10px] text-blue-500 uppercase font-bold mb-1 block">Auto-Distribute</label><div class="flex gap-1"><select id="distPresetSelect" class="text-xs border rounded p-1 flex-grow bg-white focus:ring-1 focus:ring-blue-500 outline-none"><option value="" disabled selected>Select Type...</option>${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}</select><button onclick="applyStagePreset(document.getElementById('distPresetSelect').value)" class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-700 shadow-sm">Apply</button></div></div>
                    <div class="space-y-3">${validKeys.map(k => `<div class="bg-gray-50 p-2 rounded border border-gray-100 relative"><div class="flex justify-between mb-1 text-[10px] font-bold items-center"><div class="flex items-center gap-1"><button onclick="toggleStageLock('${k}')" class="text-gray-400 hover:text-blue-600 w-4 focus:outline-none">${tl.stages[k].locked ? 'ðŸ”’' : 'ðŸ”“'}</button><span>${tl.stages[k].label}</span></div><span class="text-blue-600 font-mono" id="disp_amt_${k}"></span></div><div class="flex items-center gap-2"><input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" class="stage-slider flex-grow h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 ${tl.stages[k].locked ? 'opacity-50' : ''}" ${tl.stages[k].locked ? 'disabled' : ''}><div class="relative w-12 flex-shrink-0"><input type="number" id="setup_perc_${k}" value="${tl.stages[k].ratio.toFixed(1)}" data-stage-key="${k}" class="stage-number-input w-full text-right text-xs font-bold bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none pr-3" ${tl.stages[k].locked ? 'disabled' : ''}><span class="absolute right-0 top-0 text-xs text-gray-400">%</span></div></div></div>`).join('')}<div class="text-center text-[10px] text-gray-400 mt-2" id="totalRatioDisplay">Total: 100%</div></div>
                </div>
            </div>`;

        const renderOverviewCard = () => {
            const burnRate = tl.totalCap > 0 ? (grandTotal / tl.totalCap) * 100 : 0;
            const burnColor = burnRate > 100 ? 'text-red-600' : (burnRate > 85 ? 'text-yellow-600' : 'text-green-600');
            const ringColor = burnRate > 100 ? 'border-red-200' : (burnRate > 85 ? 'border-yellow-200' : 'border-green-200');
            return `<div id="card-overview" class="stage-card min-w-[300px] flex-shrink-0 h-full bg-gray-50 border-r border-gray-200 flex flex-col snap-center"><div class="p-6 flex flex-col items-center text-center border-b border-gray-200 bg-white"><div id="burnRateRing" class="w-32 h-32 rounded-full border-8 ${ringColor} flex items-center justify-center mb-2 relative transition-colors duration-500"><div id="burnRateText" class="text-3xl font-bold ${burnColor}">${Math.round(burnRate)}%</div><div class="absolute text-[9px] text-gray-400 bottom-6 uppercase tracking-wider">Burn Rate</div></div><h3 class="text-base font-bold text-gray-800">Budget Health</h3><p class="text-xs text-gray-500 mt-1">Est: <strong id="ovGrandTotal">${formatAbbreviated(grandTotal, displayCurrency)}</strong> / Cap: <strong id="ovTotalCap">${formatAbbreviated(tl.totalCap, displayCurrency)}</strong></p></div><div class="p-4 flex-grow overflow-y-auto"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Top Spenders</h4><div class="space-y-2">${topSpenders.map((item, idx) => `<div class="flex justify-between items-center text-xs p-2 bg-white rounded border border-gray-200 shadow-sm"><div class="flex items-center gap-2 overflow-hidden"><span class="font-bold text-gray-400 w-4">${idx + 1}.</span><div class="min-w-0"><div class="truncate font-medium text-gray-700">${item.desc}</div><div class="text-[9px] text-gray-400 uppercase">${item.stage}</div></div></div><span class="font-mono font-bold text-gray-800 flex-shrink-0">${formatAbbreviated(item.cost, displayCurrency)}</span></div>`).join('')}</div></div></div>`;
        };

        const renderStageColumn = (key) => {
            const config = tl.stages[key];
            const data = stageData[key];
            const cap = tl.totalCap * (config.ratio / 100);
            return `
            <div id="card-${key}" class="stage-card min-w-[300px] w-full sm:w-[320px] flex-shrink-0 flex flex-col h-full bg-white border-r border-gray-200 snap-center">
                <div class="p-2 bg-white border-b border-gray-100 flex-shrink-0 sticky top-0 z-20 shadow-sm">
                    <div class="flex justify-between items-center mb-2 h-7">
                        <div class="flex items-center gap-1.5 overflow-hidden"><button onclick="toggleStageLock('${key}')" class="text-gray-400 hover:text-blue-600 flex-shrink-0 focus:outline-none" title="Lock">${config.locked ? 'ðŸ”’' : 'ðŸ”“'}</button><span class="font-bold text-gray-800 text-xs truncate" title="${config.label}">${config.label}</span></div>
                        <div class="flex items-center gap-3">
                            <div class="relative w-12 h-6 flex items-center bg-gray-50 border border-gray-200 rounded px-1"><input type="number" id="header_perc_${key}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-transparent focus:outline-none no-spinner pr-2" data-stage-key="${key}" ${config.locked ? 'disabled style="opacity:0.5"' : ''} onfocus="this.select()"><span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-gray-400 select-none">%</span></div>
                            <div class="flex items-center h-6 bg-gray-50 border border-gray-200 rounded px-1.5"><span class="text-[8px] text-gray-400 uppercase mr-1 font-bold">Days:</span><input type="number" value="${config.days}" data-global-days="${key}" class="w-8 text-center text-[10px] bg-transparent font-bold text-blue-600 focus:outline-none no-spinner" onfocus="this.dataset.old=this.value; this.value=''" onblur="if(this.value===''){this.value=this.dataset.old; this.dispatchEvent(new Event('input'));} else { updateGlobalDays('${key}', this.value); }"></div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mb-1 overflow-hidden"><div id="bar-${key}" class="bg-blue-500 h-1 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                    <div class="flex justify-between text-[9px] text-gray-400 font-mono mb-1"><span id="total-${key}">${formatAbbreviated(data.total, displayCurrency)}</span><span id="limit-${key}">Cap: ${formatAbbreviated(cap, displayCurrency)}</span></div>
                    <button onclick="handleStageAddItem('${key}')" class="w-full py-1 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded text-[10px] font-bold border border-blue-100 transition-colors">+ Item</button>
                </div>
                <div class="stage-drop-zone flex-grow overflow-y-auto p-2 space-y-2 bg-gray-50 h-full" data-stage-key="${key}">
                    ${data.items.map(item => `
                        <div class="stage-card-item bg-white p-2 rounded-lg border border-gray-200 shadow-sm group hover:border-blue-400 transition-all relative" data-item-id="${item.id}" data-stage="${key}">
                            <button onclick="removeStageItem('${item.id}', '${item._sec}', '${key}')" class="absolute -top-1.5 -right-1.5 bg-white text-gray-300 hover:text-red-500 border border-gray-200 hover:border-red-200 w-5 h-5 rounded-full flex items-center justify-center text-xs shadow-sm opacity-0 group-hover:opacity-100 transition-opacity z-10">&times;</button>
                            <div class="flex items-center gap-2 mb-2 cursor-pointer" onclick="openCrewProfile(this, event, '${item.id}', '${item._sec}')"><div class="w-7 h-7 rounded-full bg-gray-100 flex-shrink-0 flex items-center justify-center text-[10px] text-gray-500 font-bold border border-gray-200 hover:bg-blue-500 hover:text-white transition-colors">${item.crew?.name?.charAt(0) || 'ðŸ‘¤'}</div><div class="min-w-0 flex-1"><div class="text-xs font-bold text-gray-700 truncate" title="${item.description}">${item.description}</div></div><div class="text-xs font-mono font-bold text-blue-600 flex-shrink-0" id="cost-${item.id}-${key}">${formatAbbreviated(item._sCost, displayCurrency)}</div></div>
                            <div class="flex gap-2 items-center h-7">
                                <div class="relative w-10 h-full"><span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-[8px] text-gray-400 font-bold select-none">D</span><input type="number" value="${item._sDays}" class="w-full h-full pl-3 pr-0.5 text-center text-xs font-bold bg-gray-50 border border-gray-200 rounded focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-200 outline-none transition-all" onfocus="this.dataset.old=this.value; this.value=''" onblur="if(this.value===''){this.value=this.dataset.old; this.dispatchEvent(new Event('input'));}" oninput="updateStageItem('${item.id}', '${item._sec}', '${key}', 'days', this.value)"></div>
                                <div class="relative flex-1 h-full"><span class="absolute left-2 top-1/2 -translate-y-1/2 text-[8px] text-gray-400 font-bold select-none">$</span><input type="number" value="${item._sRate}" class="w-full h-full pl-4 pr-2 text-right text-xs font-mono bg-gray-50 border border-gray-200 rounded focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-200 outline-none transition-all" onfocus="this.dataset.old=this.value; this.value=''" onblur="if(this.value===''){this.value=this.dataset.old; this.dispatchEvent(new Event('input'));}" oninput="updateStageItem('${item.id}', '${item._sec}', '${key}', 'rate', this.value)"></div>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`;
        };

        const content = `<div class="flex flex-col h-[80vh] sm:h-[600px] w-full max-w-[95vw] bg-white rounded-xl shadow-2xl overflow-hidden relative"><div class="flex items-center gap-2 overflow-x-auto h-8 px-2 bg-gray-50 border-b flex-shrink-0 no-scrollbar">${validKeys.map(k => `<button onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth'})" class="text-[10px] font-bold uppercase text-gray-500 hover:text-blue-600 px-2">${k}</button>`).join('')}</div><div id="stagesCarousel" class="flex flex-row overflow-x-auto h-full snap-x snap-mandatory scroll-smooth">${renderSetupCard()}${renderOverviewCard()}${validKeys.map(k => renderStageColumn(k)).join('')}</div></div>`;

        createModal('stagesView', '', content, 'max-w-none w-fit bg-transparent shadow-none');
        const header = document.querySelector('#stagesViewModal .bg-gray-50.border-b');
        if(header) header.style.display = 'none';
        const body = document.getElementById('stagesViewBody');
        if(body) body.style.padding = '0';

        // E. Bindings (No-Flash Logic)
        setTimeout(() => {
            const bindInput = (el, isInput) => {
                el.addEventListener(isInput ? 'change' : 'input', (e) => {
                    balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                    updateAllHeaders(); 
                });
            };
            document.querySelectorAll('.stage-slider').forEach(el => bindInput(el, false));
            document.querySelectorAll('.stage-number-input').forEach(el => bindInput(el, true));

            window.updateAllHeaders = () => {
                let totalPct = 0;
                let grandLiveTotal = 0;
                validKeys.forEach(key => {
                    const cfg = budget.targetLock.stages[key];
                    const cap = budget.targetLock.totalCap * (cfg.ratio / 100);
                    totalPct += cfg.ratio;
                    const sIn = document.querySelector(`.stage-slider[data-stage-key="${key}"]`);
                    const nIn = document.getElementById(`setup_perc_${key}`);
                    const hIn = document.getElementById(`header_perc_${key}`);
                    if(sIn) sIn.value = cfg.ratio;
                    if(nIn && document.activeElement !== nIn) nIn.value = cfg.ratio.toFixed(1);
                    if(hIn && document.activeElement !== hIn) hIn.value = cfg.ratio.toFixed(1);
                    document.getElementById(`disp_amt_${key}`).textContent = formatAbbreviated(cap, displayCurrency);
                    document.getElementById(`limit-${key}`).textContent = `Cap: ${formatAbbreviated(cap, displayCurrency)}`;
                    
                    let liveTotal = 0;
                    Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                        if(i.stageData && i.stageData[key]) liveTotal += (parseFloat(i.stageData[key].days)||0) * (parseFloat(i.stageData[key].rate)||0);
                    }));
                    grandLiveTotal += liveTotal;
                    
                    document.getElementById(`total-${key}`).textContent = formatAbbreviated(liveTotal, displayCurrency);
                    const bar = document.getElementById(`bar-${key}`);
                    if(bar) {
                        const w = cap > 0 ? (liveTotal/cap)*100 : 0;
                        bar.style.width = `${Math.min(w,100)}%`;
                        bar.className = `h-1 rounded-full transition-all duration-300 ${w>100?'bg-red-500':'bg-blue-500'}`;
                    }
                });
                const ovTotal = document.getElementById('ovGrandTotal');
                const ovCap = document.getElementById('ovTotalCap');
                const ringTxt = document.getElementById('burnRateText');
                const ring = document.getElementById('burnRateRing');
                if(ovTotal) ovTotal.textContent = formatAbbreviated(grandLiveTotal, displayCurrency);
                if(ovCap) ovCap.textContent = formatAbbreviated(budget.targetLock.totalCap, displayCurrency);
                if(ringTxt && ring) {
                    const br = budget.targetLock.totalCap > 0 ? (grandLiveTotal / budget.targetLock.totalCap) * 100 : 0;
                    ringTxt.textContent = Math.round(br) + '%';
                    const rc = br > 100 ? 'border-red-200' : (br > 85 ? 'border-yellow-200' : 'border-green-200');
                    const tc = br > 100 ? 'text-red-600' : (br > 85 ? 'text-yellow-600' : 'text-green-600');
                    ring.className = `w-32 h-32 rounded-full border-8 ${rc} flex items-center justify-center mb-2 relative transition-colors duration-500`;
                    ringTxt.className = `text-3xl font-bold ${tc}`;
                }
                const totDisp = document.getElementById('totalRatioDisplay');
                if(totDisp) {
                    totDisp.textContent = `Total: ${Math.round(totalPct)}%`;
                    totDisp.className = `text-center text-[10px] mt-2 font-bold ${Math.round(totalPct)===100?'text-green-600':'text-red-500'}`;
                }
            };

            window.updateStageItem = (itemId, sectionName, stageKey, field, val) => {
                const item = budget.sections[sectionName].items.find(i => i.id === itemId);
                if (item && item.stageData && item.stageData[stageKey]) {
                    item.stageData[stageKey][field] = parseFloat(val) || 0;
                    syncStageToMain(item);
                    saveBudget(); // <--- PERSIST DATA
                    const cost = item.stageData[stageKey].days * item.stageData[stageKey].rate;
                    const cEl = document.getElementById(`cost-${itemId}-${stageKey}`);
                    if(cEl) cEl.textContent = formatAbbreviated(cost, displayCurrency);
                    updateAllHeaders(); // Live Header Update
                    render(); // Live Main BG Update
                }
            };

            window.updateGlobalDays = (key, val) => { budget.targetLock.stages[key].days = parseFloat(val)||0; saveBudget(); updateAllHeaders(); };
            window.toggleStageLock = (key) => { budget.targetLock.stages[key].locked = !budget.targetLock.stages[key].locked; showStagesModal(); };
            
            updateAllHeaders(); 
            initializeStageDragAndDrop();
        }, 50);

    } catch(err) { console.error(err); }
}

/* -- P5 -- */

/* --- v19.53 [Stages] - Database Search & Smart Add --- */

// 1. Main Handler (Opens the Menu)
window.handleStageAddItem = function(stageKey) {
    // A. Detect Target Section
    const sectionNames = Object.keys(budget.sections);
    let targetSectionName = null;

    // Smart Mapping: Stage -> Section
    if (stageKey === 'post') targetSectionName = sectionNames.find(s => /post|edit/.test(s.toLowerCase()));
    else if (stageKey === 'dev') targetSectionName = sectionNames.find(s => /development|creative/.test(s.toLowerCase()));
    else if (stageKey === 'pre') targetSectionName = sectionNames.find(s => /pre|staff/.test(s.toLowerCase()));
    else if (stageKey === 'dist') targetSectionName = sectionNames.find(s => /distribution|market/.test(s.toLowerCase()));
    
    // Fallback: If no match, default to first section (or Production)
    if (!targetSectionName) {
         targetSectionName = sectionNames.find(s => s.toLowerCase().includes('production')) || sectionNames[0];
    }

    if (!targetSectionName) { alert("No budget sections found."); return; }

    // B. Render the Search Modal Content
    const content = `
        <div class="flex flex-col h-[400px]">
            <div class="mb-3">
                <input type="text" id="stageDbSearch" placeholder="Search Database..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm font-bold">
            </div>

            <div id="stageDbList" class="flex-grow overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 mb-3">
                ${renderStageDatabaseList(getGlobalItems(), stageKey, targetSectionName)}
            </div>

            <button id="toggleStageCustomForm" class="text-xs text-blue-600 font-bold hover:underline text-center mb-2">
                + Create Custom Item
            </button>

            <div id="stageCustomForm" class="hidden space-y-3 border-t pt-3 bg-white">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase">Description</label>
                    <input type="text" id="stageCustomDesc" class="w-full p-2 border rounded text-sm" placeholder="Item Name">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Rate</label>
                        <input type="number" id="stageCustomRate" class="w-full p-2 border rounded text-sm text-right" placeholder="0.00">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Unit</label>
                        <select id="stageCustomUnit" class="w-full p-2 border rounded text-sm bg-white">
                            <option>Day</option><option>Flat</option><option>Week</option>
                        </select>
                    </div>
                </div>
                <button id="stageAddCustomBtn" class="w-full py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">Add Item</button>
            </div>
        </div>
    `;

    createModal('stageAdd', `Add to ${budget.targetLock.stages[stageKey].label} <span class='text-gray-400 font-normal text-xs'>(${targetSectionName})</span>`, content, 'max-w-sm');

    // C. Attach Listeners
    
    // 1. Search Logic
    document.getElementById('stageDbSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const allItems = getGlobalItems();
        const filtered = allItems.filter(i => i.description.toLowerCase().includes(term));
        document.getElementById('stageDbList').innerHTML = renderStageDatabaseList(filtered, stageKey, targetSectionName);
    });

    // 2. Toggle Custom Form
    document.getElementById('toggleStageCustomForm').addEventListener('click', (e) => {
        const form = document.getElementById('stageCustomForm');
        const list = document.getElementById('stageDbList');
        const isHidden = form.classList.contains('hidden');
        
        if (isHidden) {
            form.classList.remove('hidden');
            list.classList.add('hidden');
            e.target.textContent = "â† Back to Search";
            document.getElementById('stageCustomDesc').focus();
        } else {
            form.classList.add('hidden');
            list.classList.remove('hidden');
            e.target.textContent = "+ Create Custom Item";
        }
    });

    // 3. Add Custom Item Logic
    document.getElementById('stageAddCustomBtn').addEventListener('click', () => {
        const desc = document.getElementById('stageCustomDesc').value.trim();
        const rate = parseFloat(document.getElementById('stageCustomRate').value) || 0;
        const unit = document.getElementById('stageCustomUnit').value;
        if(!desc) return;
        
        addStageItemToBudget(desc, rate, unit, stageKey, targetSectionName);
    });
};

// 2. Helper to Render the List (and handle clicks)
window.renderStageDatabaseList = function(items, stageKey, targetSectionName) {
    if (items.length === 0) return `<div class="p-4 text-center text-xs text-gray-400 italic">No matches found.</div>`;
    
    // We render the HTML string, but the click handler needs to be global or attached after.
    // Since we are returning a string, we use inline onclick that calls a global helper.
    return items.map((item, idx) => `
        <div onclick="addStageItemToBudget('${item.description.replace(/'/g, "\\'")}', ${item.rate}, '${item.unit}', '${stageKey}', '${targetSectionName}')" 
             class="p-3 border-b border-gray-100 bg-white hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors">
            <div>
                <div class="text-sm font-bold text-gray-700 group-hover:text-blue-700">${item.description}</div>
                <div class="text-[10px] text-gray-400">${item.unit}</div>
            </div>
            <div class="font-mono text-xs text-gray-500 font-bold group-hover:text-blue-600">
                ${formatCurrency(item.rate)}
            </div>
        </div>
    `).join('');
};

// 3. The Shared "Add to Budget" Action
window.addStageItemToBudget = function(desc, rate, unit, stageKey, targetSectionName) {
    const newItem = {
        id: crypto.randomUUID(),
        description: desc,
        quantity: 1,
        unit: unit,
        multiplier: 1,
        rate: rate,
        actual: 0,
        rateType: 'negotiable',
        assignedStage: [stageKey] // <--- The Magic: Auto-tags the stage
    };

    if(budget.sections[targetSectionName]) {
        budget.sections[targetSectionName].items.push(newItem);
        pushToHistory(`Added '${desc}' to ${targetSectionName}`);
        closeModal('stageAddModal');
        showStagesModal(); // Refresh Stages View
        render(); // Refresh Main Budget
    }
};

function initializeStageDragAndDrop() {
    const containers = document.querySelectorAll('.stage-drop-zone');
    containers.forEach(container => {
        if(container._sortableStage) return;

        container._sortableStage = new Sortable(container, {
            group: { name: 'stages-shared', pull: 'clone', put: true },
            animation: 0, 
            ghostClass: 'bg-blue-50',
            dragClass: 'opacity-90',
            delay: 150, 
            delayOnTouchOnly: true, 
            sort: false,
            
            onEnd: function(evt) {
                const itemEl = evt.item;
                const newStageKey = evt.to.dataset.stageKey;
                const oldStageKey = evt.from.dataset.stageKey;
                if (newStageKey === oldStageKey) return; 

                const itemId = itemEl.dataset.itemId;
                const sectionName = itemEl.dataset.originSection;
                const section = budget.sections[sectionName];

                if (section) {
                    const item = section.items.find(i => i.id === itemId);
                    if (item) {
                        let stages = Array.isArray(item.assignedStage) ? item.assignedStage : [item.assignedStage || 'prod'];
                        const isCtrlPressed = evt.originalEvent.ctrlKey || evt.originalEvent.metaKey;

                        if (!stages.includes(newStageKey)) stages.push(newStageKey);
                        if (!isCtrlPressed) stages = stages.filter(s => s !== oldStageKey);
                        
                        item.assignedStage = stages;
                        pushToHistory(isCtrlPressed ? `Cloned item to ${newStageKey.toUpperCase()}` : `Moved item to ${newStageKey.toUpperCase()}`);

                        itemEl.remove();
                        showStagesModal(); 
                    }
                }
            }
        });
    });
}

/* --- Navigation Helpers --- */
window.scrollToStageCard = (id) => { document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); updateActiveNav(id); };
window.scrollCarousel = (dir) => { const c = document.getElementById('stagesCarousel'); c.scrollBy({ left: dir === 'left' ? -300 : 300, behavior: 'smooth' }); };
const updateActiveNav = (activeId) => {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        const isActive = btn.dataset.target === activeId;
        btn.className = isActive ? "nav-btn px-3 py-0.5 text-[10px] font-bold uppercase tracking-wider bg-gray-800 text-white rounded-sm shadow-sm transition-colors whitespace-nowrap" : "nav-btn px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider text-gray-500 hover:bg-gray-200 rounded-sm transition-colors whitespace-nowrap";
    });
};

/* v19.53 [Documents] - Complete Module --- */

// 1. Data Helper
function ensureCallSheetData() {
    if (!budget.callSheet) budget.callSheet = JSON.parse(JSON.stringify(defaultCallSheet));
}

// 2. Smart Auto-Fill Logic
function autoFillCallSheetData() {
    if (!confirm("Overwrite current Call Sheet with crew from Budget?")) return;
    ensureCallSheetData();
    const cs = budget.callSheet;
    
    const keyRoles = ['Director', 'Producer', '1st AD', 'DOP', 'Gaffer', 'Key Grip', 'Sound Mixer', 'Makeup', 'Costume', 'Medic', 'Manager'];
    const foundCrew = [];

    Object.values(budget.sections).forEach(sec => {
        sec.items.forEach(item => {
            if (item.crew && item.crew.name) {
                const desc = item.description.toLowerCase();
                const matchedRole = keyRoles.find(r => desc.includes(r.toLowerCase()));
                if (matchedRole) {
                    foundCrew.push({ role: matchedRole, name: item.crew.name, phone: item.crew.phone || '' });
                }
            }
        });
    });
    
    if (foundCrew.length > 0) {
        cs.vipCrew = foundCrew; // Save specifically for PDF generation
        alert(`âœ… Imported ${foundCrew.length} key crew members.`);
    } else {
        alert("No assigned crew found in budget line items. Try assigning crew to roles first.");
    }
    showCallSheetEditor(); // Refresh view
}

// 3. PDF Generator (jsPDF + AutoTable)
function generateCallSheetPDF(shareMode = false) {
    ensureCallSheetData();
    const cs = budget.callSheet;
    const doc = new window.jspdf.jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    
    // -- HEADER --
    doc.setFillColor(30, 58, 138); // Blue 900
    doc.rect(0, 0, pageWidth, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text((budget.projectName || "PROJECT TITLE").toUpperCase(), 14, 18);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("PRODUCTION OFFICE: 10A WEST KINGS HOUSE ROAD", 14, 26);
    
    doc.setFontSize(26);
    doc.setFont("helvetica", "bold");
    const dateStr = new Date(cs.date).toLocaleDateString('en-GB', {weekday: 'short', day: 'numeric', month: 'short'}).toUpperCase();
    doc.text(dateStr, pageWidth - 14, 20, { align: 'right' });
    
    doc.setFontSize(12);
    doc.text(`DAY ${cs.shootDay} OF ${cs.totalDays}`, pageWidth - 14, 28, { align: 'right' });

    // -- INFO GRID --
    let yPos = 50;
    const drawBox = (x, title, value, color = [243, 244, 246]) => {
        doc.setFillColor(...color);
        doc.roundedRect(x, yPos, 60, 20, 2, 2, 'F');
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(title.toUpperCase(), x + 4, yPos + 6);
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.setFont("helvetica", "bold");
        doc.text(value || "-", x + 4, yPos + 15);
    };

    drawBox(14, "General Crew Call", cs.unitCall, [219, 234, 254]); // Blue 100
    drawBox(80, "Breakfast Ready", cs.breakfast, [254, 243, 199]); // Yellow 100
    drawBox(146, "Weather Forecast", cs.weather || "N/A");

    yPos += 28;

    // -- LOCATIONS --
    doc.setFontSize(10);
    doc.setTextColor(30, 58, 138); 
    doc.text("LOCATIONS", 14, yPos);
    doc.setDrawColor(200);
    doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
    yPos += 8;

    if(cs.locations) {
        cs.locations.forEach(loc => {
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text((loc.label || "LOC").toUpperCase(), 14, yPos);
            doc.setTextColor(0);
            doc.setFont("helvetica", "bold");
            doc.text(loc.name || "", 45, yPos);
            doc.setFont("helvetica", "normal");
            doc.text(loc.address || "", 45, yPos + 5);
            yPos += 12;
        });
    }
    yPos += 5;

    // -- SCHEDULE --
    doc.autoTable({
        startY: yPos,
        head: [['SCENE', 'SET / DESCRIPTION', 'CAST', 'PGS']],
        body: cs.schedule.map(s => [s.scene, `${s.set}\n${s.desc}`, s.cast, s.pages]),
        theme: 'grid',
        headStyles: { fillColor: [30, 58, 138] },
        columnStyles: { 0: { fontStyle: 'bold', width: 20 }, 3: { halign: 'center', width: 15 } }
    });

    // -- CAST --
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head: [['#', 'CAST MEMBER', 'CHARACTER', 'PICKUP', 'MAKEUP', 'ON SET']],
        body: cs.cast.map(c => [c.id, c.name, c.character, c.pickup, c.makeup, c.set]),
        theme: 'striped',
        headStyles: { fillColor: [75, 85, 99] },
        columnStyles: { 0: { fontStyle: 'bold', width: 10 }, 5: { fontStyle: 'bold', fillColor: [239, 246, 255] } }
    });

    // -- VIP CONTACTS (Auto-Filled) --
    if (cs.vipCrew && cs.vipCrew.length > 0) {
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['KEY CREW CONTACTS', 'PHONE']],
            body: cs.vipCrew.map(c => [`${c.role}: ${c.name}`, c.phone]),
            theme: 'plain',
            styles: { fontSize: 8, cellPadding: 1 }
        });
    }

    // -- FOOTER --
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFillColor(243, 244, 246);
    doc.rect(14, finalY, pageWidth - 28, 20, 'F');
    doc.setFontSize(8);
    doc.setTextColor(0);
    doc.text("NOTES: " + (cs.notes || ""), 18, finalY + 6, { maxWidth: pageWidth - 36 });

    // OUTPUT
    const filename = `${budget.projectName}_CallSheet.pdf`;
    if (shareMode) {
        const blob = doc.output('blob');
        const file = new File([blob], filename, { type: 'application/pdf' });
        if (navigator.share && navigator.canShare({ files: [file] })) {
            navigator.share({ title: 'Call Sheet', text: `Call Sheet for ${budget.projectName}`, files: [file] }).catch(console.error);
        } else {
            alert("System sharing not supported. Downloading file.");
            doc.save(filename);
        }
    } else {
        doc.save(filename);
    }
}

/* --- v19.58 [Documents] - Hub, Preview & Share Module v19.53 --- */

// 1. State Management
window.docHubState = {
    mode: 'normal', 
    selected: new Set(),
    activeTab: 'All',
    searchTerm: ''
};

// 2. Data Integrity
function ensureDocumentData() {
    if (!budget.documents) {
        const defaults = typeof DOCUMENT_TEMPLATES !== 'undefined' ? DOCUMENT_TEMPLATES : [];
        budget.documents = defaults.filter(t => t.default).map(t => ({ ...t, status: 'Draft', content: null }));
    }
    if (!budget.documentTrash) budget.documentTrash = [];
    if (!budget.callSheet) budget.callSheet = JSON.parse(JSON.stringify(defaultCallSheet));
}

// 3. Document Action Buttons
function renderDocActions(docId) {
    if (window.docHubState.mode === 'select') {
        const isChecked = window.docHubState.selected.has(docId);
        return `
            <div class="mr-3 w-5 h-5 rounded border flex items-center justify-center transition-colors ${isChecked ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-gray-300'}">
                ${isChecked ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
            </div>`;
    }
    // Normal Mode - Icons updated to match Footer
    return `
        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 bg-white pl-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
            <button onclick="event.stopPropagation(); handlePreviewDocument('${docId}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-colors border border-blue-100" title="Preview / Save Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button onclick="event.stopPropagation(); handlePublishMenu('${docId}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-700 hover:bg-green-600 hover:text-white transition-colors border border-gray-200" title="Publish / Share">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <button onclick="event.stopPropagation(); deleteSingleDoc('${docId}')" class="w-6 h-6 flex items-center justify-center rounded-full text-gray-300 hover:bg-red-50 hover:text-red-500 transition-colors ml-1 hidden group-hover:flex" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>`;
}

/* --- v19.53 Document Card Rendering v19.54 --- */
function renderDocCard(doc, context = 'hub') {
    const isSelectMode = window.docHubState.mode === 'select';
    const isSelected = window.docHubState.selected.has(doc.id);
    const clickHandler = isSelectMode 
        ? `onclick="toggleDocSelection('${doc.id}')"` 
        : `onclick="openDocumentViewer('${doc.id}', '${context}')"`; // Unified viewer

    // Mobile: always show buttons; Desktop: show on hover
    const actionButtons = `
        <div class="flex gap-1.5 absolute right-2 top-1/2 -translate-y-1/2 
                      ${context === 'stages' ? 'opacity-100' : 'opacity-0 sm:group-hover:opacity-100'} 
                      transition-opacity">
            <button onclick="event.stopPropagation(); openDocumentViewer('${doc.id}', '${context}')" 
                    class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white flex items-center justify-center border border-blue-100 shadow-sm" 
                    title="Preview / Edit">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button onclick="event.stopPropagation(); handlePublishMenu('${doc.id}')" 
                    class="w-8 h-8 rounded-full bg-gray-100 text-gray-700 hover:bg-green-600 hover:text-white flex items-center justify-center border border-gray-200 shadow-sm" 
                    title="Publish / Share">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>`;

    return `
        <div ${clickHandler} 
             class="doc-card group relative flex items-center p-3 bg-white border 
                    ${isSelected && isSelectMode ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-gray-200'} 
                    rounded-lg hover:shadow-md transition-all h-16 w-full select-none cursor-pointer" 
             data-label="${doc.label.toLowerCase()}">
            ${isSelectMode ? renderDocActions(doc.id) : `
                <div class="w-10 h-10 rounded-md bg-gray-50 flex-shrink-0 flex items-center justify-center text-lg mr-3 border border-gray-100 shadow-sm">
                    ${doc.icon || 'ðŸ“„'}
                </div>`}
            <div class="min-w-0 flex-1 flex flex-col justify-center">
                <span class="text-sm font-bold text-gray-800 truncate leading-tight block" title="${doc.label}">
                    ${doc.label}
                </span>
                <span class="text-[10px] text-gray-400 uppercase leading-tight mt-0.5 block">
                    ${doc.status || 'Draft'}
                </span>
            </div>
            ${!isSelectMode ? actionButtons : ''}
        </div>`;
}

// 5. Main Hub Modal
function showDocumentsModal(tab = null) {
    ensureDocumentData();
    if (tab) window.docHubState.activeTab = tab;
    const { activeTab, mode, selected } = window.docHubState;
    const docs = budget.documents;
    const visibleDocs = activeTab === 'All' ? docs : docs.filter(d => d.cat === activeTab);

    // Header Logic
    let headerButtons = '';
    if (mode === 'select') {
        const count = selected.size;
        headerButtons = `
            <button onclick="setDocMode('normal')" class="px-3 py-1.5 text-xs font-bold text-gray-600 hover:bg-gray-100 rounded transition-colors">Cancel</button>
            <button onclick="handleBulkTrash()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded text-xs font-bold shadow-sm flex items-center gap-1" ${count === 0 ? 'disabled opacity-50' : ''}><span>Delete (${count})</span></button>`;
    } else {
        headerButtons = `
            <button onclick="setDocMode('select')" class="px-3 py-1.5 text-xs font-bold text-gray-500 hover:text-red-500 hover:bg-red-50 rounded transition-colors border border-transparent hover:border-red-100">Select</button>
            <button onclick="showAddDocumentModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 shadow-sm whitespace-nowrap"><span>+</span> Add</button>`;
    }

    const renderTabs = () => ['All', 'Pre-Prod', 'Production', 'Post-Prod', 'Legal'].map(t => 
        `<button onclick="showDocumentsModal('${t}')" class="px-3 py-1.5 text-[10px] sm:text-xs font-bold uppercase tracking-wider rounded-lg transition-colors border flex-shrink-0 ${activeTab === t ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-100'}">${t}</button>`
    ).join('');

    const content = `
        <div class="flex flex-col h-[75vh] sm:h-[600px] w-full bg-gray-50 overflow-hidden">
            <div class="p-3 sm:p-4 bg-white border-b flex flex-col gap-3 shadow-sm z-10 flex-shrink-0">
                <div class="flex flex-wrap justify-between items-center gap-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span>ðŸ“‚</span> Documents</h2>
                        <button onclick="showBinModal()" class="relative p-1.5 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            ${budget.documentTrash && budget.documentTrash.length > 0 ? '<span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>' : ''}
                        </button>
                    </div>
                    ${mode === 'normal' ? `<div class="relative flex-grow w-full sm:w-auto sm:max-w-xs order-last sm:order-none mt-2 sm:mt-0"><input type="text" id="hubSearchInput" value="${window.docHubState.searchTerm}" placeholder="Search..." class="w-full pl-8 pr-3 py-1.5 text-xs bg-gray-100 border-transparent focus:bg-white focus:border-blue-500 border rounded-lg transition-all outline-none" autocomplete="off"><svg class="w-3.5 h-3.5 text-gray-400 absolute left-2.5 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>` : '<div class="flex-grow"></div>'}
                    <div class="flex items-center gap-2">${headerButtons}</div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 -mx-1 px-1">${renderTabs()}</div>
            </div>
            <div class="p-3 sm:p-4 overflow-y-auto flex-grow bg-gray-50 w-full">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 group/list">
                    ${visibleDocs.length > 0 ? visibleDocs.map(doc => renderDocCard(doc)).join('') : '<div class="col-span-full text-center py-12 text-xs text-gray-400 italic">No documents found.</div>'}
                </div>
            </div>
        </div>`;
    
    createModal('documentsHub', '', content, 'max-w-4xl w-full');
    const header = document.querySelector('#documentsHubModal .bg-gray-50.border-b');
    if(header) header.style.display = 'none';
    const body = document.getElementById('documentsHubBody');
    if(body) { body.classList.remove('p-4'); body.style.padding = '0'; }

    const searchInput = document.getElementById('hubSearchInput');
    if(searchInput) {
        searchInput.focus();
        const len = searchInput.value.length; 
        searchInput.setSelectionRange(len, len);
        searchInput.addEventListener('input', (e) => {
            window.docHubState.searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.doc-card').forEach(card => card.classList.toggle('hidden', !card.dataset.label.includes(window.docHubState.searchTerm)));
        });
    }
}

/* --- v19.54 [Publish] - Universal Share Module (Multi-Format Support) --- */

// 1. Helper: Generate the File Blob
async function generateDocumentFile(doc, format) {
    const isPdf = format === 'pdf';
    const filename = `${budget.projectName}_${doc.label.replace(/\s/g,'_')}.${format}`;
    const dateStr = new Date().toLocaleDateString();

    let paperHTML = '';

    if (doc.id === 'callSheet') {
        // High-Fidelity Call Sheet Layout
        const cs = budget.callSheet;
        paperHTML = `
            <div id="render-target" class="bg-white text-black p-8 mx-auto font-sans" style="width: 794px; min-height: 1123px;">
                <div class="flex justify-between items-end border-b-4 border-blue-900 pb-4 mb-6">
                    <div>
                        <h1 class="text-4xl font-bold uppercase text-blue-900 tracking-tight">${budget.projectName}</h1>
                        <div class="text-sm font-bold tracking-widest text-gray-500 mt-1 uppercase">Call Sheet</div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold text-gray-800">${new Date(cs.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}).toUpperCase()}</div>
                        <div class="text-sm font-bold text-gray-500 uppercase">Day ${cs.shootDay} of ${cs.totalDays}</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">General Call</div>
                        <div class="text-2xl font-bold text-blue-900">${cs.unitCall}</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <div class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider">Breakfast</div>
                        <div class="text-2xl font-bold text-yellow-900">${cs.breakfast}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Weather</div>
                        <div class="text-xl font-bold text-gray-800 truncate">${cs.weather}</div>
                    </div>
                </div>
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-gray-400 uppercase border-b-2 border-gray-100 pb-1 mb-3">Locations</h3>
                    <div class="space-y-3">
                        ${cs.locations.map(l => `<div><div class="flex items-baseline gap-2"><span class="font-bold text-sm text-blue-900 uppercase min-w-[80px]">${l.label}:</span><span class="font-bold text-base text-gray-900">${l.name}</span></div><div class="text-sm text-gray-600 pl-[88px]">${l.address}</div></div>`).join('')}
                    </div>
                </div>
                <div class="mb-8">
                    <table class="w-full text-xs text-left border-collapse">
                        <thead class="bg-blue-900 text-white uppercase tracking-wider"><tr><th class="p-2 w-16">Scene</th><th class="p-2">Set / Description</th><th class="p-2 w-20">Cast</th><th class="p-2 text-center w-12">Pgs</th></tr></thead>
                        <tbody class="divide-y divide-gray-200">${cs.schedule.map(s => `<tr class="bg-white"><td class="p-3 font-bold text-lg text-gray-800 align-top">${s.scene}</td><td class="p-3 align-top"><div class="font-bold text-sm text-gray-900 uppercase">${s.set}</div><div class="text-gray-500 mt-1">${s.desc}</div></td><td class="p-3 font-mono text-gray-600 align-top">${s.cast}</td><td class="p-3 text-center font-bold text-gray-800 align-top">${s.pages}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
                <div class="absolute bottom-8 left-8 right-8 border-t pt-2 text-[10px] text-gray-400 flex justify-between"><span>Generated by mooBudgetTool</span><span>Production Office: 10a West Kings House Rd</span></div>
            </div>`;
    } else {
        // Generic "White Paper" Layout
        paperHTML = `
            <div id="render-target" class="bg-white text-black p-8 shadow-lg mx-auto" style="width: 794px; height: 1123px;">
                <div class="border-b-4 border-gray-800 pb-4 mb-8 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold uppercase tracking-tight">${budget.projectName}</h1>
                        <div class="text-sm text-gray-500 uppercase tracking-widest">${doc.cat} / ${doc.label}</div>
                    </div>
                    <div class="text-right"><div class="text-xl font-bold text-gray-300">DRAFT</div><div class="text-xs text-gray-400">${dateStr}</div></div>
                </div>
                <div class="text-gray-400 text-sm italic p-10 text-center border-2 border-dashed border-gray-100 rounded-lg">
                    (Document Content Placeholder)<br>Items from ${doc.cat} would appear here.
                </div>
                <div class="absolute bottom-8 left-8 right-8 border-t pt-2 text-[10px] text-gray-400">Generated by mooBudgetTool</div>
            </div>`;
    }

    const container = document.createElement('div');
    container.style.position = 'absolute'; container.style.left = '-9999px'; container.style.top = '0';
    container.innerHTML = paperHTML;
    document.body.appendChild(container);

    try {
        const element = document.getElementById('render-target');
        const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
        let blob;
        
        if (isPdf) {
            const imgData = canvas.toDataURL('image/jpeg', 0.85);
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
            const pdfW = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfImgH = (imgProps.height * pdfW) / imgProps.width;
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfImgH);
            blob = pdf.output('blob');
        } else {
            blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
        }
        document.body.removeChild(container);
        return new File([blob], filename, { type: isPdf ? 'application/pdf' : 'image/jpeg' });
    } catch (e) {
        if(document.body.contains(container)) document.body.removeChild(container);
        throw e;
    }
}

// 2. Multi-File Share Handler
async function generateAndShare(docId, contact, method) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    const btnId = method === 'whatsapp' ? `${contact.id}-whatsapp` : `${contact.id}-email`;
    const btn = document.querySelector(`button[data-share-btn="${btnId}"]`);
    const originalContent = btn ? btn.innerHTML : '';
    if(btn) btn.innerHTML = `<span class="animate-spin">âŒ›</span>`;

    try {
        const files = [];
        if (document.getElementById('fmtPdf').checked) files.push(await generateDocumentFile(doc, 'pdf'));
        if (document.getElementById('fmtJpg').checked) files.push(await generateDocumentFile(doc, 'jpg'));

        if (files.length === 0) throw new Error("Please select PDF, JPG, or both.");

        const text = `Hi ${contact.name.split(' ')[0]}, please review the attached ${doc.label} for ${budget.projectName}.`;

        // A: Native Share (Mobile - Supports Arrays)
        if (navigator.canShare && navigator.canShare({ files: files })) {
            await navigator.share({ title: doc.label, text: text, files: files });
        } 
        // B: Desktop Fallback (Download Loop)
        else {
            for (const file of files) {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url; a.download = file.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                await new Promise(r => setTimeout(r, 500)); // Delay between downloads
            }
            
            if (method === 'whatsapp') {
                const cleanPhone = contact.phone.replace(/\D/g, ''); 
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(text + " (Files downloaded)")}`, '_blank');
            } else if (method === 'email') {
                window.open(`mailto:${contact.email}?subject=${encodeURIComponent(doc.label)}&body=${encodeURIComponent(text)}`, '_self');
            }
            alert(`Files downloaded.\n\nPlease drag them into the ${method === 'whatsapp' ? 'WhatsApp' : 'Email'} window.`);
        }
    } catch (err) {
        alert("Error: " + err.message);
    } finally {
        if(btn) btn.innerHTML = originalContent;
    }
}

// 3. Main UI Builder
function handlePublishMenu(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    const crewMap = new Map();
    Object.values(budget.sections).forEach(section => {
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                const key = item.crew.name.toLowerCase();
                if (!crewMap.has(key)) {
                    crewMap.set(key, { 
                        id: `c_${Date.now()}_${Math.floor(Math.random()*1000)}`,
                        name: item.crew.name, phone: item.crew.phone, email: item.crew.email || '', role: item.description 
                    });
                }
            }
        });
    });
    const contacts = Array.from(crewMap.values());

    const modalContent = `
        <div class="flex flex-col max-h-[80vh] h-full">
            <div class="p-4 bg-white border-b sticky top-0 z-10">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">Share Document</h3>
                        <p class="text-xs text-gray-500">Distribute <strong>${doc.label}</strong></p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="fmtPdf" class="w-3 h-3 text-blue-600" checked><span class="text-xs font-bold text-gray-700">PDF</span></label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="fmtJpg" class="w-3 h-3 text-blue-600"><span class="text-xs font-bold text-gray-700">JPG</span></label>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="selectAllCrew" class="w-4 h-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="text-xs font-bold text-gray-600">Select All</span>
                    </label>
                    <span class="text-[10px] text-gray-400" id="selectedCountDisplay">0 selected</span>
                </div>
            </div>
            <div class="overflow-y-auto flex-grow bg-white p-2 space-y-1">
                ${contacts.length > 0 ? contacts.map(c => `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded border border-transparent hover:border-gray-100 group transition-colors">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <input type="checkbox" class="crew-select-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded" value="${c.email}" data-name="${c.name}">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 flex-shrink-0">${c.name.charAt(0)}</div>
                            <div class="min-w-0">
                                <div class="text-xs font-bold text-gray-800 truncate">${c.name}</div>
                                <div class="text-[10px] text-gray-500 truncate">${c.role} ${!c.email ? '<span class="text-red-300">(No Email)</span>' : ''}</div>
                            </div>
                        </div>
                        <div class="flex gap-1 pl-2 border-l ml-2 border-gray-100">
                            ${c.phone ? `<button data-share-btn="${c.id}-whatsapp" onclick="generateAndShare('${docId}', {id:'${c.id}', name:'${c.name}', phone:'${c.phone}'}, 'whatsapp')" class="w-8 h-8 flex items-center justify-center rounded-full bg-green-50 text-green-600 hover:bg-green-600 hover:text-white transition-colors" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg></button>` : ''}
                            ${c.email ? `<button data-share-btn="${c.id}-email" onclick="generateAndShare('${docId}', {id:'${c.id}', name:'${c.name}', email:'${c.email}'}, 'email')" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-colors" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></button>` : ''}
                        </div>
                    </div>
                `).join('') : '<div class="p-6 text-center text-gray-400 text-xs">No crew found. Assign roles in budget first.</div>'}
            </div>
            <div class="p-3 bg-white border-t sticky bottom-0 z-10 flex gap-2">
                <button id="downloadFormatBtn" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-lg border border-gray-300 hover:bg-gray-200 transition-colors text-xs">Download File(s)</button>
                <button id="sendBulkEmailBtn" class="flex-[2] py-3 bg-gray-800 text-white font-bold rounded-lg shadow-md hover:bg-gray-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-xs" disabled>
                    Send Bulk Email (<span id="bulkCount">0</span>)
                </button>
            </div>
        </div>
    `;

    createModal('publishMenu', '', modalContent, 'max-w-md');
    const header = document.querySelector('#publishMenuModal .bg-gray-50.border-b');
    if(header) header.style.display = 'none';
    const body = document.getElementById('publishMenuBody');
    if(body) body.classList.remove('p-4');

    // 4. Listeners
    const selectAll = document.getElementById('selectAllCrew');
    const checkboxes = document.querySelectorAll('.crew-select-checkbox');
    const sendBtn = document.getElementById('sendBulkEmailBtn');
    const countSpan = document.getElementById('bulkCount');
    const labelSpan = document.getElementById('selectedCountDisplay');

    const updateState = () => {
        const selected = Array.from(checkboxes).filter(cb => cb.checked);
        const count = selected.length;
        sendBtn.disabled = count === 0;
        countSpan.textContent = count;
        labelSpan.textContent = `${count} selected`;

        if (count > 0) {
            const emails = selected.map(cb => cb.value).filter(e => e).join(',');
            const subject = encodeURIComponent(`${budget.projectName}: ${doc.label}`);
            const body = encodeURIComponent(`Hi Team,\n\nPlease find the attached ${doc.label}.\n\nRegards,`);
            sendBtn.onclick = () => {
                if(!emails) return alert("Selected crew have no emails.");
                alert("Opening Email Client...\n\nImportant: You must manually attach the downloaded file(s) in bulk mode.");
                window.location.href = `mailto:?bcc=${emails}&subject=${subject}&body=${body}`;
            };
        }
    };

    selectAll.addEventListener('change', (e) => {
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        updateState();
    });
    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            updateState();
            selectAll.checked = Array.from(checkboxes).every(c => c.checked);
        });
    });

    document.getElementById('downloadFormatBtn').addEventListener('click', async () => {
        const btn = document.getElementById('downloadFormatBtn');
        btn.innerHTML = "Generating...";
        try {
            const files = [];
            if (document.getElementById('fmtPdf').checked) files.push(await generateDocumentFile(doc, 'pdf'));
            if (document.getElementById('fmtJpg').checked) files.push(await generateDocumentFile(doc, 'jpg'));
            
            if (files.length === 0) throw new Error("Select PDF or JPG.");

            for (const file of files) {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url; a.download = file.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                await new Promise(r => setTimeout(r, 500));
            }
        } catch(e) { alert(e.message); }
        btn.innerHTML = "Download File(s)";
    });
}

/* --- Workflow Logic (Toggle, Delete, Restore) --- */
function setDocMode(newMode) {
    window.docHubState.mode = newMode;
    if (newMode === 'normal') window.docHubState.selected.clear();
    showDocumentsModal(); 
}

function toggleDocSelection(id) {
    if (window.docHubState.selected.has(id)) window.docHubState.selected.delete(id);
    else window.docHubState.selected.add(id);
    showDocumentsModal();
}

function deleteSingleDoc(id) {
    if(confirm("Move this document to the bin?")) {
        const docIndex = budget.documents.findIndex(d => d.id === id);
        if(docIndex > -1) {
            const doc = budget.documents.splice(docIndex, 1)[0];
            doc.deletedAt = new Date().toISOString();
            budget.documentTrash.push(doc);
            saveBudget();
            showDocumentsModal();
        }
    }
}

function handleBulkTrash() {
    const count = window.docHubState.selected.size;
    if(count === 0) return;
    if(confirm(`Move ${count} items to the bin?`)) {
        const toTrash = budget.documents.filter(d => window.docHubState.selected.has(d.id));
        toTrash.forEach(d => d.deletedAt = new Date().toISOString());
        budget.documentTrash.push(...toTrash);
        budget.documents = budget.documents.filter(d => !window.docHubState.selected.has(d.id));
        saveBudget();
        setDocMode('normal');
    }
}

function showAddDocumentModal() {
    const existingIds = (budget.documents || []).map(d => d.id);
    const available = DOCUMENT_TEMPLATES.filter(t => !existingIds.includes(t.id));
    
    const content = `
        <div class="p-2">
            <input type="text" id="docSearch" placeholder="Search templates..." class="w-full p-3 border rounded-lg mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="docTemplateList" class="h-64 overflow-y-auto space-y-2">
                ${renderTemplateList(available)}
            </div>
            <div class="mt-4 pt-4 border-t">
                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Or create custom</p>
                <form onsubmit="handleCustomDoc(event)" class="flex gap-2">
                    <input type="text" id="customDocName" placeholder="Custom Document Name" class="flex-1 p-2 border rounded text-sm" required>
                    <select id="customDocCat" class="p-2 border rounded text-sm bg-white"><option>Pre-Prod</option><option>Production</option><option>Post-Prod</option><option>Legal</option></select>
                    <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded text-xs font-bold">Add</button>
                </form>
            </div>
        </div>`;
    createModal('addDoc', 'Add Document', content, 'max-w-md');
    
    document.getElementById('docSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = available.filter(t => t.label.toLowerCase().includes(term));
        document.getElementById('docTemplateList').innerHTML = renderTemplateList(filtered);
    });
}

function renderTemplateList(list) {
    if(list.length === 0) return '<div class="text-center text-gray-400 text-xs py-4">No matching templates found.</div>';
    return list.map(t => `
        <div onclick="addDocument('${t.id}')" class="flex items-center gap-3 p-2 hover:bg-blue-50 rounded cursor-pointer border border-transparent hover:border-blue-100 transition-colors group">
            <div class="text-xl">${t.icon}</div>
            <div class="flex-1">
                <div class="text-sm font-bold text-gray-700 group-hover:text-blue-700">${t.label}</div>
                <div class="text-[10px] text-gray-400 uppercase">${t.cat}</div>
            </div>
            <div class="text-blue-500 font-bold text-lg opacity-0 group-hover:opacity-100">+</div>
        </div>`).join('');
}

function addDocument(templateId) {
    const template = DOCUMENT_TEMPLATES.find(t => t.id === templateId);
    if(template) {
        budget.documents.push({ ...template, status: 'Draft', content: null, dateCreated: new Date().toISOString() });
        saveBudget();
        closeModal('addDocModal');
        showDocumentsModal();
    }
}

function handleCustomDoc(e) {
    e.preventDefault();
    const name = document.getElementById('customDocName').value.trim();
    const cat = document.getElementById('customDocCat').value;
    if(name) {
        budget.documents.push({ id: `cust_${Date.now()}`, label: name, cat: cat, icon: 'ðŸ“„', status: 'Draft', content: null, dateCreated: new Date().toISOString() });
        saveBudget();
        closeModal('addDocModal');
        showDocumentsModal();
    }
}

function showBinModal() { 
    const trash = budget.documentTrash || [];
    const content = trash.length === 0 ? '<p class="text-center text-gray-400 p-4">Bin is empty.</p>' : 
        `<div class="space-y-2 p-2">${trash.map((d, i) => `
            <div class="flex justify-between items-center p-2 bg-red-50 border border-red-100 rounded">
                <span class="text-sm font-bold text-gray-700">${d.label}</span>
                <div class="flex gap-2">
                    <button onclick="restoreDoc(${i})" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded">Restore</button>
                    <button onclick="permDeleteDoc(${i})" class="text-xs bg-red-600 text-white px-2 py-1 rounded">Delete</button>
                </div>
            </div>`).join('')}</div>`;
    createModal('docBin', 'Recycle Bin', content, 'max-w-sm');
}

window.restoreDoc = (idx) => {
    const doc = budget.documentTrash.splice(idx, 1)[0];
    delete doc.deletedAt;
    budget.documents.push(doc);
    saveBudget();
    closeModal('docBinModal');
    showDocumentsModal();
};

window.permDeleteDoc = (idx) => {
    if(confirm("Delete forever?")) {
        budget.documentTrash.splice(idx, 1);
        saveBudget();
        showBinModal();
    }
};

window.permDeleteDoc = (idx) => {
    if(confirm("Delete forever?")) {
        budget.documentTrash.splice(idx, 1);
        saveBudget();
        showBinModal();
    }
};

/* --- v19.54 Document Viewer Modal --- */
function openDocumentViewer(docId, context = 'hub') {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // Determine current state
    const hasContent = !!doc.content;
    const hasAttachment = budget.attachments && budget.attachments.some(a => a.docId === docId);

    let viewerContent = '';

    if (!hasContent && !hasAttachment) {
        // Blank state â€“ offer two primary actions
                    viewerContent = `
                <div class="p-6 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">${doc.content.templateLabel || doc.label}</h3>
                        <div class="flex gap-3 items-center">
                            ${doc.content.templateId === 'crewList' ? `
                                <button onclick="autoFillCrewList('${docId}')" 
                                        class="inline-flex items-center gap-2 px-5 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md transition-all">
                                    <span class="text-xl">âœ¨</span>
                                    Fill
                                </button>` : ''}
                            <button onclick="downloadCrewList('${docId}')" 
                                    class="w-12 h-12 bg-gray-800 text-white rounded-lg hover:bg-gray-900 shadow-md flex items-center justify-center transition-all"
                                    title="Download as JPEG or PDF">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                           </button>
                        </div>
                    </div>
                    <div id="crewListTable" class="space-y-8">
                        ${doc.content.templateId === 'crewList' ? renderCrewListTable(doc) : 
                            `<div class="prose prose-sm max-w-none p-8 bg-gray-50 rounded-lg border border-gray-200 text-center">
                                <p class="text-gray-600 italic">Preview for "${doc.label}"</p>
                                <p class="text-xs text-gray-400 mt-4">Content rendering for this template is in development.</p>
                            </div>`
                        }
                    </div>
                </div>`;
    } else {
        // Document has content or attachment â€“ existing attachment handling (unchanged)
        const attachment = budget.attachments?.find(a => a.docId === docId);

 /* --- v19.54 Template Viewer Conditional v19.54 --- */
        if (doc.content && doc.content.type === 'template') {
            if (doc.content.templateId === 'crewList') {
/* --- v19.54 Crew List Fill & Download v19.54 --- */
                viewerContent = `
                <div class="p-6 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">${doc.content.templateLabel || doc.label}</h3>
                        <div class="flex gap-3 items-center">
                            <button onclick="autoFillCrewList('${docId}')" 
                                    class="inline-flex items-center gap-2 px-5 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md transition-all">
                                <span class="text-xl">âœ¨</span>
                                Fill
                            </button>
                            <button onclick="downloadCrewList('${docId}')" 
                                    class="w-12 h-12 bg-gray-800 text-white rounded-lg hover:bg-gray-900 shadow-md flex items-center justify-center transition-all"
                                    title="Download Crew List (JPEG / PDF)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="crewListTable" class="space-y-8">
                        ${renderCrewListTable(doc)}
                    </div>
                </div>`;
/* --- v19.54 Generic Template Full-Page Snapshot for Publish v19.54 --- */
            } else {
                // Generic template â€“ full-page white layout for reliable publish/share snapshot
                viewerContent = `
                <div class="p-12 bg-white" style="min-height: 100vh;">
                    <div class="max-w-4xl mx-auto">
                        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">${budget.projectName || 'Project'} - ${doc.label}</h1>
                        <p class="text-center text-gray-500 mb-12">Generated: ${new Date().toLocaleDateString()}</p>
                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-20 text-center">
                            <p class="text-3xl text-gray-700 mb-6">${doc.label}</p>
                            <p class="text-xl text-gray-500 italic">Document content in development</p>
                            <p class="text-sm text-gray-400 mt-12">This page is a snapshot for sharing and preview.</p>
                        </div>
                        <div class="mt-32 text-center text-xs text-gray-400">
                            Generated by mooBudgetTool
                        </div>
                    </div>
                </div>`;
            }
        }
                else if (attachment && attachment.previewContent) {
            const prev = attachment.previewContent;
            const editable = isEditableAttachment(attachment);
            let previewHTML = '';
            let editorMode = false; // Future: could track per-attachment

            if (prev.type === 'image') {
                previewHTML = `<img src="${prev.data}" alt="${attachment.name}" class="max-w-full h-auto rounded-lg shadow-lg mx-auto">`;
            }
            else if (prev.type === 'pdf') {
                previewHTML = `
                    <div class="text-center">
                        <img src="${prev.thumbnail}" alt="PDF Preview" class="max-w-full h-auto rounded-lg shadow-lg mx-auto mb-4">
                        <p class="text-sm text-gray-600">PDF â€¢ ${prev.pageCount} pages</p>
                        <p class="text-xs text-gray-400 mt-2">Full editable view coming soon</p>
                    </div>`;
            }
            else if (prev.type === 'docx') {
                previewHTML = prev.html;
            }
            else if (prev.type === 'xlsx') {
                previewHTML = prev.html;
            }
            else if (prev.type === 'text') {
                previewHTML = `<pre class="text-xs bg-gray-100 p-4 rounded-lg overflow-x-auto whitespace-pre-wrap">${prev.content}</pre>`;
            }
            else {
                previewHTML = `<p class="text-gray-500 text-center py-12">Preview not available for this file type.</p>`;
            }

            viewerContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${doc.label}</h3>
                            <p class="text-sm text-gray-600 mt-1">Attached: ${attachment.name}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            ${editable ? `
                                <button id="editAttachmentBtn" 
                                        onclick="enableAttachmentEditing('${attachment.id}', '${docId}')" 
                                        class="inline-flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <div id="saveControls" class="hidden flex items-center gap-2">
                                    <button onclick="saveAttachmentEdits('${attachment.id}', '${docId}')" 
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                        Save
                                    </button>
                                    <button onclick="cancelAttachmentEditing('${docId}')" 
                                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium">
                                        Cancel
                                    </button>
                                </div>` : ''}
                            <div class="text-right text-xs text-gray-500">
                                <div>Size: ${formatFileSize(attachment.size)}</div>
                                <div>Added: ${new Date(attachment.dateAdded).toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                                        <div id="attachmentEditor" class="border rounded-xl shadow-inner p-4 bg-white min-h-96 overflow-auto contenteditable-container" ${editable ? 'contenteditable="false"' : ''}>
                        ${previewHTML}
                    </div>
                    <div class="mt-6 flex justify-center gap-6">
                        <button onclick="attachFileToDocument('${docId}')" 
                                class="inline-flex items-center gap-1.5 text-sm text-blue-600 hover:text-blue-800 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Replace File
                        </button>
                        <button onclick="removeAttachmentFromDocument('${attachment.id}', '${docId}')" 
                                class="text-sm text-red-600 hover:text-red-800 font-medium">
                            Remove File
                        </button>
                    </div>
                </div>`;
        }
        else {
            viewerContent = `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4 opacity-30">ðŸ“Ž</div>
                    <p class="text-gray-500">No preview available</p>
                </div>`;
        }
    }

    createModal('documentViewer', doc.label, viewerContent, 'max-w-4xl');
    
    // Hide default header actions for cleaner look
    const header = document.querySelector('#documentViewerModal .bg-gray-50.border-b');
    if (header) header.style.display = 'none';
    
    const body = document.getElementById('documentViewerBody');
    if (body) body.classList.remove('p-4');
}

/* --- v19.54 Template Picker & Loader --- */
function startWithTemplate(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    const allTemplates = getAllAvailableTemplates();

    const content = `
        <div class="p-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Choose a Template</h3>
            <input type="text" id="templateSearch" placeholder="Search templates..." 
                   class="w-full p-3 border rounded-lg mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="templateGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                ${allTemplates.map(t => `
                    <div onclick="applyTemplate('${docId}', '${t.id}', ${t.isCustom})" 
                         class="p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 hover:shadow-md transition-all group">
                        <div class="text-3xl mb-2 text-center">${t.icon}</div>
                        <div class="font-bold text-gray-800 text-center">${t.label}</div>
                        <div class="text-xs text-gray-500 text-center uppercase mt-1">${t.cat}</div>
                        ${t.isCustom ? '<div class="mt-2 text-[10px] text-blue-600 text-center font-bold">CUSTOM</div>' : ''}
                    </div>
                `).join('')}
            </div>
            <div class="mt-6 pt-4 border-t text-center">
                <button onclick="importMtempFile('${docId}')" class="text-sm text-blue-600 hover:underline font-bold">
                    + Import .mtemp File
                </button>
            </div>
        </div>`;

    createModal('templatePicker', 'Select Template', content, 'max-w-2xl');

    // Search functionality
    document.getElementById('templateSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allTemplates.filter(t => 
            t.label.toLowerCase().includes(term) || t.cat.toLowerCase().includes(term)
        );
        document.getElementById('templateGrid').innerHTML = filtered.map(t => `
            <div onclick="applyTemplate('${docId}', '${t.id}', ${t.isCustom})" 
                 class="p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 hover:shadow-md transition-all group">
                <div class="text-3xl mb-2 text-center">${t.icon}</div>
                <div class="font-bold text-gray-800 text-center">${t.label}</div>
                <div class="text-xs text-gray-500 text-center uppercase mt-1">${t.cat}</div>
                ${t.isCustom ? '<div class="mt-2 text-[10px] text-blue-600 text-center font-bold">CUSTOM</div>' : ''}
            </div>
        `).join('');
    });
}

function applyTemplate(docId, templateId, isCustom) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    let template;
    if (isCustom) {
        template = budget.customTemplates.find(t => t.id === templateId);
    } else {
        template = DOCUMENT_TEMPLATES.find(t => t.id === templateId);
    }

    if (!template) {
        alert("Template not found.");
        return;
    }

    // Load template structure into document content
    doc.content = {
        type: 'template',
        templateId: template.id,
        templateLabel: template.label,
        fields: template.fields || {}, // Future: define per-template fields
        data: {} // User-filled values
    };

    // For now, initialize with placeholder fields
    if (!template.fields) {
        doc.content.fields = {
            projectName: { label: "Project Name", value: budget.projectName || "" },
            director: { label: "Director", value: "" },
            producer: { label: "Producer", value: "" },
            shootDates: { label: "Shoot Dates", value: "" },
            notes: { label: "Notes", value: "", multiline: true }
        };
        doc.content.data = {
            projectName: budget.projectName || "",
            director: "",
            producer: "",
            shootDates: "",
            notes: ""
        };
    }

    doc.status = 'In Progress';
    saveBudget();
    closeModal('templatePickerModal');
    openDocumentViewer(docId); // Refresh viewer with template editor
}

/* --- v19.54 .mtemp Import --- */
function importMtempFile(docId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.mtemp,application/json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imported = JSON.parse(ev.target.result);
                if (!imported.id || !imported.label) throw new Error("Invalid .mtemp file");

                // Add as custom template
                budget.customTemplates = budget.customTemplates || [];
                const exists = budget.customTemplates.find(t => t.id === imported.id);
                if (exists) {
                    if (!confirm(`Template "${imported.label}" already exists. Overwrite?`)) return;
                    Object.assign(exists, imported);
                } else {
                    budget.customTemplates.push(imported);
                }

                saveCustomTemplates();
                alert(`Imported template: ${imported.label}`);
                closeModal('templatePickerModal');
                startWithTemplate(docId); // Reopen picker to show new template
            } catch (err) {
                alert("Failed to import .mtemp: " + err.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

/* --- v19.54 Save Template Fields --- */
function saveDocumentContent(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc || !doc.content || doc.content.type !== 'template') return;

    const inputs = document.querySelectorAll('#documentViewerBody [data-field]');
    inputs.forEach(input => {
        const key = input.dataset.field;
        doc.content.data[key] = input.value;
    });

    doc.status = 'Completed';
    saveBudget();
    alert("Document saved!");
}

/* --- v19.54 Crew Contact List Auto-Fill v19.54 --- */
function renderCrewListTable(doc) {
    // Collect assigned crew + map department from section name
    const crewByDept = {};
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        const dept = sectionName; // Use section as department header
        if (!crewByDept[dept]) crewByDept[dept] = [];
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                crewByDept[dept].push({
                    role: item.description,
                    name: item.crew.name || '',
                    phone: item.crew.phone || '',
                    email: item.crew.email || '',
                    diet: item.crew.diet || '', // Future: add diet field to crew profile
                    notes: item.crew.notes || ''
                });
            }
        });
    });

    if (Object.keys(crewByDept).length === 0) {
        return `<p class="text-center text-gray-500 py-12">No crew assigned yet. Assign contacts to line items first.</p>`;
    }

    return Object.entries(crewByDept).map(([dept, members]) => `
        <div>
            <h4 class="font-bold text-lg text-gray-800 mb-3 border-b border-gray-200 pb-1">${dept}</h4>
            <table class="w-full text-sm border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 text-left font-bold">Name</th>
                        <th class="p-2 text-left font-bold">Role</th>
                        <th class="p-2 text-left font-bold">Phone</th>
                        <th class="p-2 text-left font-bold">Email</th>
                        <th class="p-2 text-left font-bold">Diet Notes</th>
                        <th class="p-2 text-left font-bold">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${members.map(m => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2 font-medium">${m.name}</td>
                            <td class="p-2">${m.role}</td>
                            <td class="p-2">${m.phone}</td>
                            <td class="p-2"><a href="mailto:${m.email}" class="text-blue-600 hover:underline">${m.email}</a></td>
                            <td class="p-2">${m.diet}</td>
                            <td class="p-2">${m.notes}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `).join('');
}

/* --- v19.54 Crew List Download v19.54 --- */
async function downloadCrewList(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc || doc.content.templateId !== 'crewList') return;

    const tableHTML = renderCrewListTable(doc);
    const fullHTML = `
        <div class="p-12 bg-white">
            <h1 class="text-3xl font-bold text-center mb-6">${budget.projectName || 'Project'} - Crew Contact List</h1>
            <p class="text-center text-sm text-gray-500 mb-8">Generated: ${new Date().toLocaleDateString()}</p>
            ${tableHTML}
        </div>`;

    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '-9999px';
    container.innerHTML = `<div id="crewDownloadRender" style="width: 800px;">${fullHTML}</div>`;
    document.body.appendChild(container);

    try {
        const canvas = await html2canvas(document.getElementById('crewDownloadRender'), { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // Prompt user
        const choice = prompt("Download Crew List as:\n1 = PDF\n2 = JPEG\nEnter 1, 2, or 1,2", "1,2");
        if (!choice) return;

        const wantPdf = choice.includes('1');
        const wantJpg = choice.includes('2');

        if (wantJpg) {
            const link = document.createElement('a');
            link.href = imgData;
            link.download = `${budget.projectName || 'CrewList'}_CrewList.jpg`;
            link.click();
        }
        if (wantPdf) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`${budget.projectName || 'CrewList'}_CrewList.pdf`);
        }
    } catch (e) {
        alert("Download failed: " + e.message);
    } finally {
        document.body.removeChild(container);
    }
}

function renderCrewListTable(doc) {
    const crewByDept = {};
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        const dept = sectionName;
        if (!crewByDept[dept]) crewByDept[dept] = [];
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                crewByDept[dept].push({
                    role: item.description,
                    name: item.crew.name || '',
                    phone: item.crew.phone || '',
                    email: item.crew.email || '',
                    diet: item.crew.diet || '-',     // Placeholder
                    notes: item.crew.notes || '-'
                });
            }
        });
    });

    if (Object.keys(crewByDept).length === 0) {
        return `<p class="text-center text-gray-500 py-12">No crew assigned. Assign contacts in budget â†’ Auto-Fill.</p>`;
    }

    return Object.entries(crewByDept).map(([dept, members]) => `
        <div class="mb-8">
            <h4 class="font-bold text-xl text-gray-800 mb-4 border-b-2 border-gray-300 pb-2">${dept}</h4>
            <table class="w-full text-sm border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                    <tr>
                        <th class="p-3 text-left">Name</th>
                        <th class="p-3 text-left">Role</th>
                        <th class="p-3 text-left">Phone</th>
                        <th class="p-3 text-left">Email</th>
                        <th class="p-3 text-left">Diet Notes</th>
                        <th class="p-3 text-left">Notes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${members.map(m => `
                        <tr class="hover:bg-gray-50">
                            <td class="p-3 font-medium">${m.name}</td>
                            <td class="p-3">${m.role}</td>
                            <td class="p-3">${m.phone}</td>
                            <td class="p-3"><a href="mailto:${m.email}" class="text-blue-600 hover:underline">${m.email || '-'}</a></td>
                            <td class="p-3 text-gray-600">${m.diet}</td>
                            <td class="p-3 text-gray-600">${m.notes}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `).join('');
}

function autoFillCrewList(docId) {
    if (!confirm("Auto-fill Crew Contact List from assigned crew in budget?")) return;
    const doc = budget.documents.find(d => d.id === docId);
    if (doc && doc.content && doc.content.type === 'template' && doc.content.templateId === 'crewList') {
        // Trigger re-render with fresh data
        alert("Crew list refreshed!");
        openDocumentViewer(docId);
    }
}

/* --- v19.56 Save Attachment Edits --- */
function saveAttachmentEdits(attachmentId, docId) {
    const attachment = budget.attachments.find(a => a.id === attachmentId);
    if (!attachment || !isEditableAttachment(attachment)) return;

    const editor = document.getElementById('attachmentEditor');
    if (!editor) return;

    const newContent = editor.innerHTML || editor.textContent;

    // Store raw content based on type
    if (attachment.previewContent.type === 'docx' || attachment.previewContent.type === 'xlsx') {
        attachment.previewContent.html = newContent;
    } else if (attachment.previewContent.type === 'text') {
        attachment.previewContent.content = editor.textContent;
    }

    // Optional: store raw text for search/indexing
    if (!attachment.rawText) attachment.rawText = '';
    attachment.rawText = editor.textContent || '';

    saveBudget();

    const saveBtn = document.getElementById('saveAttachmentBtn');
    if (saveBtn) {
        saveBtn.classList.add('opacity-50');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saved!';
        setTimeout(() => {
            if (saveBtn) saveBtn.textContent = 'Save';
        }, 2000);
    }

    alert('File edits saved!');
}

/* --- v19.53 Attachment Editing Controls v19.54 --- */
function enableAttachmentEditing(attachmentId, docId) {
    const editor = document.getElementById('attachmentEditor');
    const editBtn = document.getElementById('editAttachmentBtn');
    const saveControls = document.getElementById('saveControls');

    if (!editor || !editBtn || !saveControls) return;

    editor.contentEditable = true;
    editor.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');
    editor.focus();

    editBtn.classList.add('hidden');
    saveControls.classList.remove('hidden');

    // Live dirty-state Save button activation
    const activateSave = () => {
        const saveBtn = saveControls.querySelector('button');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-50');
        }
    };
    editor.addEventListener('input', activateSave, { once: false });
}

/* --- v19.53 Attach File to Document --- */
function attachFileToDocument(docId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = false;
    input.accept = '.pdf,.jpg,.jpeg,.png,.gif,.webp,.docx,.xlsx,.xls,.txt,.rtf,.md';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!budget.attachments) budget.attachments = [];

        const attachment = {
            id: generateSafeId(),
            docId: docId,                    // Link to document
            name: file.name,
            type: file.type || 'application/octet-stream',
            size: file.size,
            dateAdded: new Date().toISOString(),
            previewContent: null             // Will hold rendered preview
        };

        // Generate preview content based on type
        try {
            const ext = file.name.split('.').pop().toLowerCase();
            
            if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                // Image: base64 for immediate preview
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                attachment.previewContent = { type: 'image', data: base64 };
            }
            else if (ext === 'pdf') {
                // PDF: use pdf.js to render first page thumbnail + embed
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                attachment.previewContent = { 
                    type: 'pdf', 
                    thumbnail: canvas.toDataURL(),
                    pageCount: pdf.numPages
                };
            }
            else if (ext === 'docx') {
                // DOCX: Mammoth to HTML
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer });
                attachment.previewContent = { type: 'docx', html: result.value };
            }
            else if (['xlsx','xls'].includes(ext)) {
                // XLSX: SheetJS to simple table
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const html = XLSX.utils.sheet_to_html(firstSheet);
                attachment.previewContent = { type: 'xlsx', html };
            }
            else {
                // Fallback text
                const text = await file.text();
                attachment.previewContent = { 
                    type: 'text', 
                    content: text.substring(0, 10000) + (text.length > 10000 ? '\n\n... (truncated)' : '')
                };
            }
        } catch (err) {
            console.warn('Preview generation failed:', err);
            attachment.previewContent = { type: 'unknown', error: 'Preview unavailable' };
        }

        budget.attachments.push(attachment);
        saveBudget();
        closeModal('documentViewerModal');
        openDocumentViewer(docId); // Refresh with preview
    };
    
    input.click();
}

/* --- v19.53 Remove Attachment from Document v19.54 --- */
function removeAttachmentFromDocument(attachmentId, docId) {
    if (!confirm("Remove this file from the document?")) return;

    if (!budget.attachments) return;

    budget.attachments = budget.attachments.filter(a => a.id !== attachmentId);

    saveBudget();

    // Force full refresh to blank state
    openDocumentViewer(docId);
}

/* --- v19.61 Boot Sequence --- */
function init() {
    document.title = `mooBudgetTool v${APP_VERSION}`;
    displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
    fetchExchangeRates();

    let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
    if (!projectToLoad || !getProjectList().includes(projectToLoad)) projectToLoad = getProjectList()[0];
    
    // Safety check for first run
    if (!projectToLoad) handleNewProject(false);
    else loadBudget(projectToLoad);
    
    render();
    bindAppEventListeners();
    
    document.addEventListener('click', (e) => {
        if(!e.target.closest('.crew-wrapper')) {
            document.querySelectorAll('.crew-wrapper').forEach(div => div.classList.remove('mobile-active'));
        }
    });
}

/* --- v19.55 Contacts Manager (Open Gate Integration) --- */

const getGlobalContacts = () => JSON.parse(localStorage.getItem('moo_contacts') || '[]');
const saveGlobalContacts = (list) => localStorage.setItem('moo_contacts', JSON.stringify(list));

function renderContactsList(list) {
    if (list.length === 0) return '<div class="p-4 text-center text-gray-400 text-xs">No contacts yet. Add one or Import CSV.</div>';
    return list.map((c, i) => `
        <div class="flex justify-between items-center p-2 border-b hover:bg-gray-50 text-sm group">
            <div class="flex-1 min-w-0">
                <div class="font-bold text-gray-800 truncate">${c.name}</div>
                <div class="text-xs text-gray-500 truncate">${c.role} â€¢ ${c.contact || '-'}</div>
            </div>
            <button onclick="deleteContact(${i})" class="text-gray-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
        </div>
    `).join('');
}

function bindContactsEvents() {
    document.getElementById('addContactForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('cName').value.trim();
        const role = document.getElementById('cRole').value.trim();
        const contact = document.getElementById('cContact').value.trim();
        if (name && role) {
            const list = getGlobalContacts();
            list.unshift({ name, role, contact });
            saveGlobalContacts(list);
            window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
        }
    });

    document.getElementById('contactSearch')?.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const all = getGlobalContacts();
        const filtered = all.filter(c => c.name.toLowerCase().includes(term) || c.role.toLowerCase().includes(term));
        document.getElementById('contactsListBody').innerHTML = renderContactsList(filtered);
    });
}

window.deleteContact = function(idx) {
    if(confirm("Delete contact?")) {
        const list = getGlobalContacts();
        list.splice(idx, 1);
        saveGlobalContacts(list);
        window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
    }
};

window.importContactsCSV = function(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split('\n');
        const list = getGlobalContacts();
        let added = 0;
        lines.forEach(line => {
            const cols = line.split(','); 
            if (cols.length >= 2) {
                const name = cols[0].trim();
                const role = cols[1].trim();
                const contact = cols[2] ? cols[2].trim() : '';
                if (name && role && name.toLowerCase() !== 'name') { 
                    list.push({ name, role, contact });
                    added++;
                }
            }
        });
        saveGlobalContacts(list);
        alert(`Imported ${added} contacts.`);
        window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
    };
    reader.readAsText(file);
};

window.autoAssignRolesFromContacts = function() {
    if(!budget) return;
    const contacts = getGlobalContacts();
    if(contacts.length === 0) return alert("Contact database is empty.");
    
    let matched = 0;
    Object.values(budget.sections).forEach(section => {
        section.items.forEach(item => {
            if (!item.crew || !item.crew.name) {
                const desc = item.description.toLowerCase();
                const match = contacts.find(c => desc.includes(c.role.toLowerCase()));
                if (match) {
                    item.crew = { 
                        name: match.name, 
                        phone: match.contact.includes('@') ? '' : match.contact, 
                        email: match.contact.includes('@') ? match.contact : '' 
                    };
                    matched++;
                }
            }
        });
    });
    
    if (matched > 0) {
        pushToHistory(`Auto-assigned ${matched} roles from Open Gate`);
        render();
        alert(`Success! Assigned ${matched} crew members.`);
    } else {
        alert("No matching roles found in current budget.");
    }
};

/* --- v19.54 [Stages] - Drag & Drop V11 (Cloning Mode) --- */
function initializeStageDragAndDrop() {
    const containers = document.querySelectorAll('.stage-drop-zone');
    
    containers.forEach(container => {
        if (container._sortable) return;

        container._sortable = new Sortable(container, {
            group: {
                name: 'stages',
                pull: 'clone', // <--- THIS KEEPS THE ORIGINAL ITEM IN PLACE
                put: true
            },
            animation: 150,
            sort: false, // Disable sorting within list for performance
            delay: 100, 
            delayOnTouchOnly: true,
            ghostClass: 'bg-blue-100', // Visual feedback
            
            onEnd: function (evt) {
                const itemEl = evt.item;
                const newStageKey = evt.to.dataset.stageKey;
                const oldStageKey = evt.from.dataset.stageKey;
                const itemId = itemEl.dataset.itemId;

                // If dropped in same list, ignore
                if (newStageKey === oldStageKey) return;

                // Remove the temporary DOM element created by Sortable (we re-render properly below)
                itemEl.remove(); 

                // 1. Locate Item
                let foundItem = null;
                for (const section of Object.values(budget.sections)) {
                    const match = section.items.find(i => i.id === itemId);
                    if (match) { foundItem = match; break; }
                }

                if (foundItem) {
                    if (!foundItem.stageData) foundItem.stageData = {};

                    // 2. CLONE LOGIC: Add new stage data (Do NOT delete old)
                    // We copy the days/rate from the source stage to the new stage as a starting point
                    const sourceData = foundItem.stageData[oldStageKey] || { days: foundItem.quantity, rate: foundItem.rate };
                    
                    foundItem.stageData[newStageKey] = { 
                        days: sourceData.days, 
                        rate: sourceData.rate 
                    };

                    // 3. Sync & Save
                    syncStageToMain(foundItem);
                    saveBudget(); 
                    pushToHistory(`Cloned item to ${budget.targetLock.stages[newStageKey].label}`);

                    // 4. Refresh UI to show the new card and update totals
                    showStagesModal(); 
                    render(); 
                }
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
