<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.54-Beta</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263/lucide.min.js">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
   <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // { updateViaCache: 'none' } forces the browser to check the server for a new sw.js
                // every time the page loads, ignoring the HTTP cache headers.
                navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                    .then(reg => {
                        console.log('SW registered:', reg.scope);
                        
                        // Check for updates immediately
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        console.log('New content is available; please refresh.');
                                        if(confirm("New Update Available (v19.53)! Reload now?")) {
                                            window.location.reload();
                                        }
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

    <style>
/* --- Generic notes: Use flexboxes as much as possible, --- */
       /* --- Base & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            padding-bottom: 50px; /* Space for sticky footer */
            background-color: #f3f4f6;
            
            /* --- COMPATIBILITY FIXES START --- */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%; 
        }

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- Scrollbar & Selection Fixes --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { 
            -ms-overflow-style: none; 
            scrollbar-width: none; /* Firefox Support */
        }

        .noselect {
            -webkit-user-select: none; /* Safari Support */
            user-select: none;
        }
        /* --- COMPATIBILITY FIXES END --- */

        /* --- Layout & Responsiveness --- */
        @media (min-width: 768px) {
            .sticky-header { position: sticky; top: 1rem; z-index: 10; }
        }
        
        /* --- Form Elements --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }

        /* --- Modals & Transitions --- */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 0.2s ease-in-out; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #settingsModalContent, #aiToolsModalContent { transition: all 0.3s ease-in-out; }

        /* --- v19.56 Editable Preview Styles --- */
        .contenteditable-container {
            outline: none;
            min-height: 400px;
        }
        .contenteditable-container:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .contenteditable-container[contenteditable="true"] {
            cursor: text;
        }

        /* --- Mobile Table Optimized (v19.52 Abbreviated) --- */
        @media (max-width: 768px) {
            .table-container { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
                padding-bottom: 20px;
            }
            
            table { min-width: 100%; width: auto; } /* Let it flow naturally */
            
            th, td { 
                white-space: nowrap; 
                padding: 8px 4px !important; /* Comfortable spacing */
                font-size: 12px; 
            }
            
            /* Input Reset */
            td input, td select { 
                width: 100% !important; 
                background: transparent; border: none; padding: 0; font-size: 12px;
            }

            /* Col 1: Avatar */
            th:nth-child(1), td:nth-child(1) { width: 40px; text-align: center; } 
            
            /* Col 2: Drag */
            th:nth-child(2), td:nth-child(2) { width: 30px; text-align: center; } 
            
            /* Col 3: Description */
            th:nth-child(3), td:nth-child(3) { 
                min-width: 100px; 
                max-width: 200px; /* Allow wrapping */
                white-space: normal; 
                line-height: 1.2;
            } 
            
            /* Col 4: Qty */
            th:nth-child(4), td:nth-child(4) { width: 35px; } 
            td:nth-child(4) input { text-align: center; }

            /* Col 5: Unit (Now Single Letter) */
            th:nth-child(5), td:nth-child(5) { width: 30px; text-align: center; } 
            /* The select is hidden (opacity 0) but clickable on top of the letter span */
            
            /* Col 6: Rate */
            th:nth-child(6), td:nth-child(6) { min-width: 60px; } 
            td:nth-child(6) input { text-align: right; }

            /* Financial Cols (Now Abbreviated!) */
            /* We can make these much smaller now */
            th:nth-child(7), td:nth-child(7), /* Est */
            th:nth-child(8), td:nth-child(8), /* Act */
            th:nth-child(9), td:nth-child(9)  /* Var */
            { width: 50px; text-align: right; font-size: 11px; } 
            
            /* Col 10: Actions */
            th:nth-child(10), td:nth-child(10) { width: 25px; } 
        }

        /* --- Drag Logic Fix --- */
        .drag-handle {
            touch-action: none !important; /* Critical: Stops page scrolling when dragging row */
            cursor: grab;
            padding: 8px 4px; /* Larger hit area */
            font-size: 16px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drag-handle:active { 
            cursor: grabbing; 
            color: #3b82f6; 
        }

        /* --- SortableJS Visuals (Desktop & Mobile) --- */
        /* --- v19.52 SortableJS Visuals v19.54 --- */
        .sortable-ghost {
            opacity: 1 !important;
            background-color: #dbeafe !important; /* Light Blue */
            border: 2px dashed #2563eb !important; /* Blue Dashed Border */
        }
        .sortable-ghost td {
            background-color: #dbeafe !important; 
            border-top: 2px dashed #2563eb !important; 
            border-bottom: 2px dashed #2563eb !important; 
            color: transparent !important; /* Hide text in the ghost */
        }
        .sortable-ghost td * {
            visibility: hidden; /* Hide contents in the ghost */
        }

        .sortable-drag {
            background-color: #ffffff !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            transform: scale(1.02);
            cursor: grabbing !important;
            display: table !important; /* Keep table row shape */
            opacity: 0.95 !important;
        }
        .sortable-drag td {
            background: white !important;
        }

        /* --- v19.50 Crew Styles v19.52 --- */
        .crew-wrapper {
            position: relative;
            display: inline-flex; 
            width: 28px;          
            height: 28px;         
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            z-index: 20;
        }

        .crew-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar.unassigned { background-color: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }
        .crew-avatar.assigned { background-color: #3b82f6; border: 2px solid #ffffff; }
        
       /* --- v19.50 Floating Popup v19.52 --- */
        .contact-popup {
            position: absolute;
            left: 10px; 
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: -1; 
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .group:hover .contact-popup {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @media (hover: hover) {
            .crew-wrapper:hover .contact-popup {
                opacity: 1 !important; 
                visibility: visible !important; 
                pointer-events: auto !important;
                left: 34px; 
                transform: translateY(-50%) scale(1);
                z-index: 50;
            }
        }

        .crew-wrapper.mobile-active .contact-popup { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important;
            left: 34px; 
            transform: translateY(-50%) scale(1);
            z-index: 50;
        }

        .contact-popup::before {
            content: '';
            position: absolute;
            left: -14px; 
            top: 0;
            bottom: 0;
            width: 14px;
            background: transparent;
            z-index: 0;
        }
        
        .contact-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease, filter 0.2s;
            text-decoration: none !important;
            border-bottom: none !important;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .contact-btn:hover { transform: scale(1.15); filter: brightness(1.1); }
        .contact-btn svg { width: 14px; height: 14px; fill: currentColor; }
        
        .btn-wa-call { background-color: #25D366; }
        .btn-wa-msg { background-color: #128C7E; }
        .btn-email { background-color: #3b82f6; }

        /* --- Status Bar Scrolling --- */
        .scrolling-text-wrapper {
            flex: 1; 
            min-width: 0; 
            overflow-x: auto; 
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .scrolling-text-wrapper::-webkit-scrollbar { 
            display: none; 
        }


        /* --- Drag and Drop --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

        /* --- UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }
        
        /* Roadmap Styles */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

        /* AI Chat Styles */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

        /* Coffee Button */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Print Hiding */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        
        /* --- v19.32 Hide Floating BMC Widget on Mobile 19.52 ---  */
        #bmac-btn-container, #bmc-wbtn {
            display: none !important; 
        }

        /* --- v19.53 Stages Feature CSS --- */
        #stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
        #stagesCarousel::-webkit-scrollbar { display: none; }
        .stage-card { transition: transform 0.2s; }
        .stage-drop-zone { min-height: 100px; }
        .stage-draggable { transition: all 0.2s; touch-action: none; }
        .stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .nav-btn { user-select: none; }

        /* --- v19.53 Mobile Description Fix & Search --- */
        @media (max-width: 768px) {
            .mobile-desc-truncate {
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                width: 100%;
                display: block;
            }
            /* Expand on focus so they can edit */
            .mobile-desc-truncate:focus {
                white-space: normal;
                overflow: visible;
                position: relative;
                z-index: 50;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                min-width: 200px;
                border-radius: 4px;
                padding: 8px;
                margin: -4px; /* Offset padding */
                height: auto;
            }
        }

        /* --- v19.56 Stages Document Cards Responsive --- */
        @media (max-width: 640px) {
            .doc-card .absolute {
                opacity: 1 !important;
            }
        }

        /* --- v19.53 Sticky Headers & Summary Layout (Merged Logic) v19.54 --- */
        /* 1. The Section Title Bar (Blue/Gray bar) */
        .sticky-section-header { 
            position: sticky; 
            top: 0; 
            z-index: 30; 
            background-color: #f9fafb; 
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* 2. The Table Column Headers (Crew, Desc, etc.) */
        .sticky-th { 
            position: sticky; 
            /* Mobile: Stick 45px down so it sits UNDER the Section Header */
            top: 43px; 
            z-index: 20; 
            background-color: #ffffff; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* Desktop Adjustments (If you have a sticky main nav) */
        @media (min-width: 768px) { 
            .sticky-section-header { top: 0rem; } 
            .sticky-th { top: 43px; } 
        }

        /* --- v19.56 Edit Mode Focus --- */
        #attachmentPreview[contenteditable="true"] {
            outline: none;
            cursor: text;
        }

/* Fix for Stage Cards: Forces cursor to 'Move' and disables text selection */
.stage-card-item {
    cursor: move; /* Shows the hand icon */
    user-select: none; /* Prevents text highlighting */
    -webkit-user-select: none;
    touch-action: none; /* Improves touch dragging */
}

/* Allow text selection ONLY inside the inputs */
.stage-card-item input {
    user-select: text;
    cursor: text;
    pointer-events: auto; /* Ensures you can click into inputs */
}

/* --- mBTDB Gridstack Styles (Fluid Canvas) --- */
        /* The Canvas Background */
        .grid-stack {
            background-color: #f3f4f6; /* Gray-50 match */
            min-height: 80vh;
            padding: 10px !important;
        }

        /* The Draggable Widget Card */
        .grid-stack-item-content {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-sm */
            overflow: hidden !important; /* Contains inner content */
            display: flex;
            flex-direction: column;
            cursor: grab; /* Shows it's draggable */
        }

        /* Drag Handle (The Header Bar) */
        .grid-stack-item-content .widget-header {
            cursor: grab;
            touch-action: none; /* Critical for mobile drag */
        }
        .grid-stack-item-content .widget-header:active {
            cursor: grabbing;
        }

        /* Content Area inside the widget */
        .grid-stack-item-content .widget-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Placeholder (Where the item will drop) */
        .grid-stack-placeholder > .placeholder-content {
            background-color: #eff6ff !important; /* blue-50 */
            border: 2px dashed #3b82f6 !important; /* blue-500 */
            border-radius: 0.75rem;
            opacity: 0.5;
        }

        /* Mobile specific fixes */
        @media (max-width: 768px) {
            .grid-stack {
                padding: 5px !important;
            }
            /* Force standard height on mobile if auto-scaling fails */
            .grid-stack-item-content {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
        }

/* --- mBTDB v9.0 Styles (Stable & Print Ready) --- */

/* 1. Canvas */
.grid-stack { 
    background-color: #e2e8f0; 
    min-height: 100vh; 
    padding-bottom: 400px;
}

/* 2. Widgets (Clean Single Border) */
.grid-stack-item-content {
    background-color: white !important;
    border: 1px solid #cbd5e1 !important;
    border-radius: 4px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
    display: flex; 
    flex-direction: column;
    overflow: hidden !important;
    height: 100% !important; /* <--- THIS FIXES THE MID-WIDGET TRAIL */
}

/* 3. Edit Mode Overrides */
.editing-mode .grid-stack-item-content {
    border: 2px dashed #94a3b8 !important; 
    box-shadow: none !important;
    z-index: 10;
}

/* 4. Controls (Header & Buttons) */
.widget-header { 
    display: none !important; 
    background-color: #f8fafc; 
    border-bottom: 1px solid #e2e8f0;
    padding: 4px 8px;
    height: 30px;
    align-items: center; justify-content: space-between;
    cursor: move;
}
.editing-mode .widget-header { display: flex !important; }
.widget-controls { display: none !important; }
.editing-mode .widget-controls { display: flex !important; }

/* 5. Inputs (Clean & distinct) */
.mbt-input {
    width: 100%;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0; /* Subtle border */
    color: #0f172a;
    padding: 3px 5px;
    font-size: 11px;
    border-radius: 2px;
    outline: none;
    transition: all 0.2s;
}
.mbt-input:focus {
    background-color: white;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}
.mbt-input::placeholder { color: #cbd5e1; font-style: italic; }

/* 6. Tables */
.mbt-table th { 
    background-color: #f1f5f9; 
    color: #475569; 
    font-weight: 800; 
    text-transform: uppercase; 
    font-size: 10px; 
    padding: 6px; 
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
}
.mbt-table td { 
    border-bottom: 1px solid #f1f5f9; 
    padding: 2px; 
    vertical-align: middle;
}
.mbt-table tr:last-child td { border-bottom: none; }

/* 7. Resize Handles (Fix for "Can't Resize") */
.ui-resizable-handle { display: none !important; }
.editing-mode .ui-resizable-handle { display: block !important; }
.editing-mode .ui-resizable-se {
    width: 15px !important; height: 15px !important;
    right: 2px !important; bottom: 2px !important;
    background: radial-gradient(circle, #64748b 2px, transparent 2.5px);
    background-size: 4px 4px;
    cursor: se-resize;
    z-index: 999 !important; /* Force on top */
}

/* 8. STANDARD CALL SHEET PRINT MODE */
@media print {
    body { background: white; font-family: 'Helvetica', 'Arial', sans-serif; -webkit-print-color-adjust: exact; }
    
    /* Hide Everything Else */
    body > *:not(#documentViewerModal) { display: none !important; }
    
    /* Reset Canvas */
    #mBTDB_Container, #mBTDB_Workspace, .grid-stack {
        position: static !important;
        width: 100% !important;
        height: auto !important;
        overflow: visible !important;
        background: white !important;
        padding: 0 !important;
        margin: 0 !important;
        display: block !important;
    }
/* --- mBTDB Print Modes (Standard vs Graphic) --- */

/* Base Print Reset (Applies to both) */
.print-container {
    background: white;
    width: 100%;
    position: absolute; top: 0; left: 0; z-index: 9999;
    padding: 20px;
}
.print-container .widget-header, 
.print-container .widget-controls, 
.print-container .ui-resizable-handle,
.print-container .icon-btn { 
    display: none !important; 
}
.print-container textarea { resize: none !important; }

/* OPTION A: Standard Sheet View (Dense, High Contrast) */
.print-standard .grid-stack {
    display: block !important;
    height: auto !important;
}
.print-standard .grid-stack-item {
    position: relative !important;
    float: left !important; /* Allows side-by-side if width < 12 */
    top: auto !important; left: auto !important; /* Removes grid gaps */
    margin-bottom: 0 !important;
    box-shadow: none !important;
    border: 1px solid black !important;
    margin-right: -1px; /* Collapse borders */
    margin-bottom: -1px;
}
.print-standard .grid-stack-item-content {
    box-shadow: none !important;
    border: none !important;
    border-radius: 0 !important;
}
.print-standard .mbt-input {
    background: transparent !important;
    border: none !important;
    padding: 1px !important;
    font-size: 9px !important;
    font-weight: 600;
    color: black !important;
}
.print-standard .mbt-table th {
    background: #ddd !important;
    color: black !important;
    border-bottom: 1px solid black !important;
    padding: 2px !important;
    font-size: 9px !important;
}
.print-standard .mbt-table td {
    border-bottom: 1px solid #ccc !important;
    padding: 1px !important;
}

/* OPTION B: Graphic View (Preserves Screen Layout) */
.print-graphic .grid-stack-item {
    /* Keeps original absolute positioning */
    box-shadow: none !important;
    border: 1px solid #ddd !important;
}
.print-graphic .mbt-input {
    border: none !important;
    background: transparent !important;
}
    /* Tighten Layout */
    .grid-stack-item {
        position: relative !important;
        width: 100% !important;
        left: auto !important; top: auto !important;
        margin-bottom: 10px !important; /* Tight spacing */
        break-inside: avoid;
        page-break-inside: avoid;
        display: block !important;
    }

    /* Borders & Contrast */
    .grid-stack-item-content {
        border: 2px solid #000 !important; /* Solid Black Borders */
        box-shadow: none !important;
        border-radius: 0 !important; /* Sharp corners */
    }

    /* Hide UI */
    #mBTDB_Header, .widget-header, .widget-controls, .ui-resizable-handle, .icon-btn, .input-action-btn { 
        display: none !important; 
    }

    /* Dense Text */
    .mbt-input, textarea {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        color: black !important;
        font-weight: 600;
        font-size: 10px !important;
        resize: none;
    }
    
    /* Table Density */
    .mbt-table th { background-color: #ddd !important; color: black !important; border-bottom: 1px solid black !important; padding: 2px !important; }
    .mbt-table td { border-bottom: 1px solid #ccc !important; padding: 2px !important; }
}
    </style>

</head>
<body class="bg-gray-100">

<div id="splash" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col gap-6">
    <img src="https://raw.githubusercontent.com/moollc/mooBudgetTool/main/assets/cow-192.png" alt="Moo" class="w-32 h-32 animate-pulse">
    <div class="text-3xl font-bold text-gray-800">Moo Budget Tool</div>
    <div class="text-sm text-gray-500">Loading production magicâ€¦</div>
</div>

<style>
    #splash { transition: opacity 0.6s ease-out; }
    #splash.fade-out { opacity: 0; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const splash = document.getElementById('splash');
        if (!splash) return;

        const minTime = 1200; 
        const start = performance.now();

        const tryRemove = () => {
            if (performance.now() - start >= minTime) {
                splash.classList.add('fade-out');
                setTimeout(() => splash.remove(), 600);
            } else {
                requestAnimationFrame(tryRemove);
            }
        };
        requestAnimationFrame(tryRemove);
    });

</script>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8"></div>
    <div id="global-modal-container"></div>
<footer class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm border-t border-gray-200 z-50 h-14 px-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
    <div class="max-w-7xl mx-auto h-full grid grid-cols-3 items-center">
        
        <div class="flex items-center gap-2 justify-start pl-2">
            <p class="font-regular text-gray-700 text-xs sm:text-sm">mBT <span class="font-normal text-gray-400 text-[10px] sm:text-xs">v19.54</span></p>
        </div>
        
        <div class="flex items-center justify-center gap-4">
            <button id="stagesFooterBtn" aria-label="Production Stages" class="w-10 h-10 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-full transition-colors flex items-center justify-center" title="Production Stages">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="7" x2="7" y1="3" y2="21"/><line x1="17" x2="17" y1="3" y2="21"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="7" y1="7" y2="7"/><line x1="3" x2="7" y1="17" y2="17"/><line x1="17" x2="21" y1="17" y2="17"/><line x1="17" x2="21" y1="7" y2="7"/></svg>
            </button>

            <button id="docsFooterBtn" aria-label="Production Documents" class="w-10 h-10 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors flex items-center justify-center relative" title="Call Sheets & Reports">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            </button>

            <button id="publishFooterBtn" aria-label="Publish" class="w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Publish">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>

            <button id="settingsBtn" aria-label="Settings" class="w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>

            <button id="footerCoffeeBtn" aria-label="Buy me a coffee" class="w-10 h-10 text-yellow-600 hover:text-yellow-700 hover:bg-yellow-50 rounded-full transition-colors flex items-center justify-center" title="Buy me a coffee">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
            </button>
        </div>

        <div class="hidden sm:block"></div>
    </div>
</footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="jaysonmy" data-description="Support me on Buy me a coffee!" data-message="Let me know what you think with the Coffee button!" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18">
    </script>
	
    <script>
        /* --- v19.51 App Version v19.54 --- */
        const APP_VERSION = "19.54";
/* --- v19.54 mBTState: Expansion-Ready Governor --- */
const mBTState = {
    _timer: null,
    _isInitialLoad: true,
    _subscribers: [], // The "Expansion Port" for future tools

    // 1. Add a new tool to the watch-list (e.g., Carbon Calc, AI Auditor)
    subscribe: function(callback) {
        this._subscribers.push(callback);
    },

    handler: {
        set(target, prop, value) {
            if (target[prop] === value) return true; // Optimization: No change, no work
            target[prop] = value;
            if (!mBTState._isInitialLoad) mBTState.requestReconciliation();
            return true;
        }
    },

    requestReconciliation() {
        clearTimeout(this._timer);
        this._timer = setTimeout(() => {
            console.log("mBTState: Broadasting changes to subscribers...");
            
            // A. Run Core Calculations
            if (typeof updateCalculations === 'function') updateCalculations();
            
            // B. Run Expansion Tools (Subscribers)
            this._subscribers.forEach(cb => {
                try { cb(budget); } catch(e) { console.error("Subscriber Error:", e); }
            });

            // C. Final Save
            if (typeof saveBudget === 'function') saveBudget();
            
            const statusMsg = document.getElementById('statusBarMessage');
            if (statusMsg) statusMsg.textContent = "Budget synchronized and saved.";
        }, 150);
    },

    wrap: function(data) {
        this._isInitialLoad = true;
        const proxied = new Proxy(data, this.handler);
        this._isInitialLoad = false;
        return proxied;
    }
};
        const ROADMAP_LOG = [
            "v19.54: Optimization. Removed redundancies and unified systems.",
            "v19.53: Stages & UI Polish. Added 'Target Lock' balancing, 'Top Spenders' analysis, and 'Sync Days' automation.",
            "v19.52: Cloud & Context. Added 'Publish' placeholder, 'Import File' menu, PDF/Excel landscape options.",
            "v19.50: Crew Profiles. Visual Avatars, Device Contact Import, WhatsApp integration."
        ];

        const UPDATE_SOURCE_URL = 'https://gist.githubusercontent.com/moollc/b31c0e4d1fb8b3f6de11beffb4b353a9/raw/gistfile1.txt';
        const storageKeyPrefix = 'prodBudget_v5_';
        const trashKey = `${storageKeyPrefix}trash`;
        const globalItemsKey = `${storageKeyPrefix}globalItems`; 
        const templatesKey = `${storageKeyPrefix}templates`;    

        let budget;
        let currentProjectName;
        
        /* --- v19.53 [Currency] - Dynamic Multi-Currency System v19.54 --- */
        let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
        
        // Base Rates (Defaults if offline)
        let exchangeRates = {
            'USD': 1.0, 'JMD': 157.50, 'GBP': 0.79, 'CAD': 1.36, 'EUR': 0.92,
            'AUD': 1.52, 'NZD': 1.63, 'ZAR': 18.50, 'INR': 83.00, 'JPY': 150.00, 'CNY': 7.20
        };

        const FILM_CURRENCIES = [
            { code: 'JMD', label: 'ðŸ‡¯ðŸ‡² JMD' }, { code: 'USD', label: 'ðŸ‡ºðŸ‡¸ USD' },
            { code: 'GBP', label: 'ðŸ‡¬ðŸ‡§ GBP' }, { code: 'CAD', label: 'ðŸ‡¨ðŸ‡¦ CAD' },
            { code: 'EUR', label: 'ðŸ‡ªðŸ‡º EUR' }, { code: 'AUD', label: 'ðŸ‡¦ðŸ‡º AUD' },
            { code: 'NZD', label: 'ðŸ‡³ðŸ‡¿ NZD' }, { code: 'ZAR', label: 'ðŸ‡¿ðŸ‡¦ ZAR' },
            { code: 'INR', label: 'ðŸ‡®ðŸ‡³ INR' }, { code: 'CNY', label: 'ðŸ‡¨ðŸ‡³ CNY' },
            { code: 'JPY', label: 'ðŸ‡¯ðŸ‡µ JPY' }
        ];

        // Fetch Live Rates
        async function fetchExchangeRates() {
            if (!navigator.onLine) return;
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.rates) {
                        FILM_CURRENCIES.forEach(c => {
                            if (data.rates[c.code]) exchangeRates[c.code] = data.rates[c.code];
                        });
                        localStorage.setItem(`${storageKeyPrefix}rates`, JSON.stringify(exchangeRates));
                        if(typeof render === 'function') render(); 
                    }
                }
            } catch (e) {
                const cached = localStorage.getItem(`${storageKeyPrefix}rates`);
                if(cached) exchangeRates = JSON.parse(cached);
            }
        }

        const getRate = (code) => exchangeRates[code] || 1;
        
        const convertFromBase = (amountInJMD, targetCurrency) => {
            const jmdRate = getRate('JMD');
            const targetRate = getRate(targetCurrency);
            return (amountInJMD / jmdRate) * targetRate;
        };

        const convertToBase = (amountInTarget, sourceCurrency) => {
            const jmdRate = getRate('JMD');
            const sourceRate = getRate(sourceCurrency);
            return (amountInTarget / sourceRate) * jmdRate;
        };

        const toDisp = (val) => convertFromBase(val, displayCurrency);

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: displayCurrency,
                maximumFractionDigits: 0 
            }).format(amount);
        };

        const formatAbbreviated = (num, currency) => {
            const val = Math.abs(num);
            const symbol = (0).toLocaleString('en-US', { style: 'currency', currency: currency }).replace(/0.00|0/g, '').trim();
            const sign = num < 0 ? "-" : "";
            
            if (val >= 1e9) return `${sign}${symbol}${(val / 1e9).toFixed(1)}B`;
            if (val >= 1e6) return `${sign}${symbol}${(val / 1e6).toFixed(1)}M`;
            if (val >= 1e3) return `${sign}${symbol}${(val / 1e3).toFixed(1)}K`;
            return formatCurrency(num);
        };

        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 7;
        let editingGlobalItemIndex = -1;
        
        let editingTemplateId = null; 
        let tempTemplateData = null;

        /* --- v19.52 v19.53 --- */
        /* --- v19.53 [Rate Intelligence] - Added rateType default --- */
        const initialLineItem = { 
            description: 'New Item', 
            quantity: 1, 
            unit: 'Day', 
            multiplier: 1, 
            rate: 0, 
            actual: 0,
            rateType: 'negotiable' 
        };

        /* --- v19.53 [Documents] - Default Data Structure --- */
        const defaultCallSheet = {
            date: new Date().toISOString().split('T')[0],
            shootDay: "1",
            totalDays: "1",
            unitCall: "07:00",
            breakfast: "06:00",
            weather: "30Â°C, Sunny",
            hospital: "UHWI (876-927-1621)",
            nearestPolice: "Half Way Tree Station",
            locations: [
                { label: "Unit Base", name: "Base Camp", address: "123 Film Street" },
                { label: "Location 1", name: "Set A", address: "456 Action Ave" }
            ],
            schedule: [
                { scene: "1", set: "INT. OFFICE", desc: "Introduction", cast: "1, 2", pages: "2/8" }
            ],
            cast: [
                { id: 1, name: "Talent A", character: "HERO", pickup: "06:00", makeup: "06:30", set: "07:30" }
            ],
            notes: "No social media photos on set."
        };

        /* --- v19.51 Helper Functions v19.52 --- */
        // Generate collision-resistant IDs for attachments
        function generateSafeId() {
            return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Abbreviate long filenames for UI display
        function getAbbreviatedName(name, maxLen = 25) {
            if (name.length <= maxLen) return name;
            const ext = name.split('.').pop();
            const base = name.substring(0, name.lastIndexOf('.'));
            const keep = maxLen - ext.length - 4; // "..." + ext
            return base.substring(0, keep) + '...' + ext;
        }

        /* --- v19.56 File Size Formatter --- */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /* --- v19.56 Editable Attachment Support --- */
        function isEditableAttachment(attachment) {
            if (!attachment || !attachment.previewContent) return false;
            const type = attachment.previewContent.type;
            return ['text', 'docx', 'xlsx', 'pdf'].includes(type);
        }

// --------------- State & Persistence ------------------------------------------

        const getGlobalItems = () => JSON.parse(localStorage.getItem(globalItemsKey) || '[]');
        const saveGlobalItems = (items) => localStorage.setItem(globalItemsKey, JSON.stringify(items));
/* --- v19.54 mBTStorage: The Hybrid Persistence Engine (With Library Guard) --- */
const mBTStorage = {
    // REGISTRY: Add any key here to auto-move it to IndexedDB
    heavyKeys: ['attachments', 'previews', 'scripts', 'photos'],

    // 1. Split budget into "Light" and "Heavy" components
    dehydrate: async function(budgetData) {
        // Soft Guard: If library is missing, save everything to LocalStorage (old way)
        if (typeof window.localforage === 'undefined') {
            return { light: budgetData, heavy: {} };
        }

        const light = { ...budgetData };
        const heavy = {};

        this.heavyKeys.forEach(key => {
            if (light[key]) {
                heavy[key] = light[key]; // Move to heavy stream
                delete light[key];       // Remove from light stream
            }
        });

        return { light, heavy };
    },

    // 2. Combine streams back into one object for the app
    hydrate: async function(lightData) {
        const budgetObj = { ...lightData };
        
        // Soft Guard: If library is missing, skip hydration to prevent crash
        if (typeof window.localforage === 'undefined') {
            console.warn("mBTStorage: localforage not ready. Postponing hydration.");
            return budgetObj;
        }

        for (const key of this.heavyKeys) {
            try {
                const storageKey = `${budgetObj.projectName}_${key}`;
                const data = await window.localforage.getItem(storageKey);
                if (data) budgetObj[key] = data;
            } catch (e) { 
                console.warn(`mBTStorage: Could not hydrate ${key}`, e); 
            }
        }
        return budgetObj;
    }
};
        const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
        const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;

        const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
        const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
        
        const getProjectNameSeparator = () => {
            const val = localStorage.getItem(projectNameSeparatorKey);
            return val !== null ? val : '-'; 
        };
        const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

function saveBudget() {
            try {
                if (!budget || !budget.projectName) return;

                // 1. We call dehydrate to split light vs heavy
                mBTStorage.dehydrate(budget).then(({ light, heavy }) => {
                    // 2. Save the "Light" JSON instantly to LocalStorage
                    localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(light));
                    localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                    localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);

                    // 3. Save the "Heavy" Blobs to localForage (IndexedDB)
                    for (const [key, value] of Object.entries(heavy)) {
                        localforage.setItem(`${budget.projectName}_${key}`, value);
                    }
                    
                    currentProjectName = budget.projectName;
                    console.log("mBTStorage: Split-save successful.");
                }).catch(err => console.error("Dehydration failed", err));

            } catch (e) { console.error("Could not save budget", e); }
        }

        /* --- v19.53 [Data] - Load Budget w/ AI Persistence --- */
       function loadBudget(projectName) {
            try {
                const data = localStorage.getItem(storageKeyPrefix + projectName);
                if (!data) { handleNewProject(false); return; }

                const lightData = JSON.parse(data);
                currentProjectName = projectName;

                // 1. Start with Light Data immediately
                budget = mBTState.wrap(lightData);
                
                // 2. Lazy Load Heavy Data in background
                mBTStorage.hydrate(lightData).then(fullData => {
                    budget = mBTState.wrap(fullData);
                    
                    historyStack = [{ 
                        budget: JSON.parse(JSON.stringify(fullData)), 
                        description: 'Project Loaded', 
                        timestamp: new Date().toISOString()
                    }];
                    historyIndex = 0;

                    if (typeof render === 'function') render();
                });

                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, currentProjectName);
            } catch (e) { console.error("Could not load budget", e); handleNewProject(false); }
        }

        const deleteProject = (projectName) => { 
            if (confirm(`Move project "${projectName}" to Recently Deleted?`)) {
                const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
                const projectData = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName));
                projectData.deletedTimestamp = new Date().toISOString();
                trash.push(projectData);
                localStorage.setItem(trashKey, JSON.stringify(trash));
                localStorage.removeItem(storageKeyPrefix + projectName); 
                init(); 
            } 
        };

        const getProjectList = () => Object.keys(localStorage)
            .filter(k => k.startsWith(storageKeyPrefix) && k !== `${storageKeyPrefix}lastLoaded` && k !== `${storageKeyPrefix}currency` && k !== trashKey && k !== globalItemsKey && k !== templatesKey && !k.includes('ApiKey') && !k.includes('selectedAiProvider') && !k.includes('projectDateFormat') && !k.includes('projectNameSeparator'))
            .map(k => k.substring(storageKeyPrefix.length))
            .sort();

        function pushToHistory(description) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            const snapshot = {
                budget: JSON.parse(JSON.stringify(budget)),
                description: description,
                timestamp: new Date().toISOString()
            };
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            saveBudget();
            renderStatusBar();
        }

        // ---------------------------------------------------------
        // AI Logic & Integration
        // ---------------------------------------------------------
        const geminiApiKeyStorage = `${storageKeyPrefix}geminiApiKey`;
        const openaiApiKeyStorage = `${storageKeyPrefix}openaiApiKey`;
        const xaiApiKeyStorage = `${storageKeyPrefix}xaiApiKey`;
        const deepseekApiKeyStorage = `${storageKeyPrefix}deepseekApiKey`;
        const aiProviderStorage = `${storageKeyPrefix}selectedAiProvider`;

        const getStoredApiKey = (provider) => {
            if (provider === 'gemini') return localStorage.getItem(geminiApiKeyStorage) || '';
            if (provider === 'openai') return localStorage.getItem(openaiApiKeyStorage) || '';
            if (provider === 'xai') return localStorage.getItem(xaiApiKeyStorage) || '';
            if (provider === 'deepseek') return localStorage.getItem(deepseekApiKeyStorage) || '';
            return '';
        };

        const saveStoredApiKey = (provider, key) => {
            if (provider === 'gemini') localStorage.setItem(geminiApiKeyStorage, key);
            if (provider === 'openai') localStorage.setItem(openaiApiKeyStorage, key);
            if (provider === 'xai') localStorage.setItem(xaiApiKeyStorage, key);
            if (provider === 'deepseek') localStorage.setItem(deepseekApiKeyStorage, key);
        };

        const getSelectedProvider = () => localStorage.getItem(aiProviderStorage) || 'gemini';
        const setSelectedProvider = (provider) => localStorage.setItem(aiProviderStorage, provider);

        /* v19.53 [AI] - Robust API Call & Offline Check --- */
        async function callUnifiedAI(provider, apiKey, prompt) {
            if (!navigator.onLine) throw new Error("You appear to be offline. Please check your connection.");
            
            // Inject Budget-First Persona
            const systemPrompt = "You are a Film Production Budgeting Expert. Prioritize analyzing the provided budget data. If asked about non-budget topics, answer briefly but pivot back to film production costs/logistics.";
            const finalPrompt = `${systemPrompt}\n\n${prompt}`;

            try {
                if (provider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
                    });
                    const json = await response.json(); // Safe parse
                    if (!response.ok) throw new Error(json.error?.message || 'Gemini API Error');
                    return json.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                } 
                else if (['openai', 'xai', 'deepseek'].includes(provider)) {
                    let baseUrl = 'https://api.openai.com/v1/chat/completions';
                    let model = 'gpt-4o';
                    if (provider === 'xai') { baseUrl = 'https://api.x.ai/v1/chat/completions'; model = 'grok-beta'; }
                    else if (provider === 'deepseek') { baseUrl = 'https://api.deepseek.com/chat/completions'; model = 'deepseek-chat'; }
                    
                    const response = await fetch(baseUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: model, messages: [{ role: "user", content: finalPrompt }] })
                    });
                    const json = await response.json(); // Safe parse
                    if (!response.ok) throw new Error(json.error?.message || `${provider} API Error`);
                    return json.choices?.[0]?.message?.content || "No response.";
                }
                throw new Error("Unknown provider selected.");
            } catch (e) {
                console.error("AI Call Failed:", e);
                throw new Error(e.message || "Network/API Error");
            }
        }

        // ---------------------------------------------------------
        // Business Logic & Helpers
        // ---------------------------------------------------------
 
        const calculateItem = (item) => {
            const estimated = (item.quantity || 0) * (item.multiplier || 1) * (item.rate || 0);
            const variance = (item.actual || 0) - estimated;
            return { estimated, variance };
        };

        const calculateTotals = (sections) => { 
            let subtotal = 0; 
            for (const sectionName in sections) { 
                subtotal += sections[sectionName]?.items.reduce((acc, item) => acc + calculateItem(item).estimated, 0) || 0; 
            } 
            return { subtotal }; 
        };

        const calculateActuals = (sections) => { 
            let actualTotal = 0; 
            for (const sectionName in sections) { 
                actualTotal += sections[sectionName]?.items.reduce((acc, item) => acc + parseFloat(item.actual || 0), 0) || 0; 
            } 
            return actualTotal; 
        };

// ---------------------------------------------------------
        // Template Management
        // ---------------------------------------------------------
        
        const DEFAULT_TEMPLATES = {
            'Commercial': { projectName: `Untitled Commercial Project`, discountPercentage: 0, contingencyPercentage: 15, salesTaxPercentage: 15.0, sections: { 'Key Creatives & Agency': { isOpen: true, items: [ { id: 'c1', description: 'Director', quantity: 3, unit: 'Day', multiplier: 1, rate: 80000, actual: 0 }, { id: 'c2', description: 'Producer', quantity: 5, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c3', description: 'Agency Fee / Creative Director', quantity: 1, unit: 'Flat', multiplier: 1, rate: 250000, actual: 0 }, { id: 'c4', description: 'Lead Talent / On-Screen Host', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Production Staff': { isOpen: true, items: [ { id: 'c5', description: 'Production Manager / Fixer', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c6', description: 'Production Coordinator (PC)', quantity: 5, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'c7', description: 'Production Assistant', quantity: 2, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 } ] }, 'Camera Department': { isOpen: true, items: [ { id: 'c8', description: 'Director of Photography (DP)', quantity: 3, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'c9', description: 'Camera Operator', quantity: 3, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c10', description: '1st Assistant Camera (AC)', quantity: 3, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'c11', description: 'Camera Package (Sony FX6)', quantity: 3, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'c12', description: 'Lens Package (Cine Primes)', quantity: 1, unit: 'Week', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c13', description: 'Teleprompter & Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 } ] }, 'Electric & Grip': { isOpen: true, items: [ { id: 'c14', description: 'Gaffer', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c15', description: 'Key Grip', quantity: 3, unit: 'Day', multiplier: 1, rate: 45000, actual: 0 }, { id: 'c16', description: 'Lighting & Grip Package (Van)', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 } ] }, 'Sound Department': { isOpen: true, items: [ { id: 'c17', description: 'Production Sound Mixer', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c18', description: 'Sound Package (Mixer, Mics, Boom)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Art Department & Wardrobe': { isOpen: true, items: [ { id: 'c19', description: 'Art Director / Stylist', quantity: 4, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c20', description: 'Props & Wardrobe Purchase/Rental', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c21', description: 'Key Hair & Makeup Artist', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Locations & Production Expenses': { isOpen: true, items: [ { id: 'c22', description: 'Location Fees (Office, etc)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c23', description: 'Catering (15 people, per day)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c24', description: 'Transportation (Van & Driver)', quantity: 3, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'c25', description: 'Editor', quantity: 8, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c26', description: 'Motion Graphics Artist', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c27', description: 'Colorist', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c28', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c29', description: 'Music Licensing (Stock)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'c30', description: 'Film Registration Fee (JAMPRO)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 14400, actual: 0 }, { id: 'c31', description: 'Legal Review', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c32', description: 'Production Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 144000, actual: 0 } ] } } },
            'Documentary': { projectName: `Untitled Documentary Project`, discountPercentage: 0, contingencyPercentage: 10, salesTaxPercentage: 15.0, sections: { 'Pre-Production | Research': { isOpen: true, items: [ { id: 'd1', description: 'Producer / Director (Development)', quantity: 20, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd2', description: 'Archival Researcher', quantity: 10, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'd3', description: 'Research & Travel', quantity: 1, unit: 'Flat', multiplier: 1, rate: 90000, actual: 0 } ] }, 'Production (2-Cam Setup)': { isOpen: true, items: [ { id: 'd4', description: 'Director', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd5', description: 'Director of Photography', quantity: 20, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'd6', description: 'Camera Operator (B-Cam)', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd7', description: 'Production Sound Mixer', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd8', description: 'Production Assistant', quantity: 20, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'd9', description: 'Camera Package (Sony FX6) - A Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd10', description: 'Camera Package (Sony FX6) - B Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd11', description: 'Sound Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'd12', description: 'Lighting & Grip Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd13', description: 'Travel & Accommodation', quantity: 1, unit: 'Flat', multiplier: 1, rate: 450000, actual: 0 }, { id: 'd14', description: 'Meals & Per Diems', quantity: 1, unit: 'Flat', multiplier: 1, rate: 240000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'd15', description: 'Editor', quantity: 60, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd16', description: 'Assistant Editor / Logger', quantity: 40, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'd17', description: 'Transcription Services', quantity: 20, unit: 'Hour', multiplier: 1, rate: 4500, actual: 0 }, { id: 'd18', description: 'Archival Footage Licensing', quantity: 1, unit: 'Flat', multiplier: 1, rate: 300000, actual: 0 }, { id: 'd19', description: 'Colorist', quantity: 8, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd20', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 200000, actual: 0 }, { id: 'd21', description: 'Composer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 225000, actual: 0 } ] }, 'Marketing & Distribution': { isOpen: true, items: [ { id: 'd22', description: 'Festival Submission Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 75000, actual: 0 }, { id: 'd23', description: 'Publicist Retainer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 150000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'd24', description: 'Legal Fees (Contracts, Clearances)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 180000, actual: 0 }, { id: 'd25', description: 'E&O Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 210000, actual: 0 }, { id: 'd26', description: 'Bookkeeping', quantity: 1, unit: 'Flat', multiplier: 1, rate: 60000, actual: 0 } ] } } },
            'LiveStream': { projectName: `Untitled Live Stream Project`, discountPercentage: 0, contingencyPercentage: 20, salesTaxPercentage: 15.0, sections: { 'Pre-Production': { isOpen: true, items: [ { id: 'l1', description: 'Technical Director (Planning)', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l2', description: 'Producer (Coordination)', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Live Production Crew': { isOpen: true, items: [ { id: 'l3', description: 'Technical Director (Switcher)', quantity: 1, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'l4', description: 'Stream Engineer', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l5', description: 'Graphics Operator (CG)', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l6', description: 'Camera Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l7', description: 'Audio Engineer (A1)', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l8', description: 'A/V Technician / Utility', quantity: 1, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Live Production Equipment': { isOpen: true, items: [ { id: 'l9', description: 'Manned Broadcast Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l10', description: 'Robotic PTZ Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l11', description: 'Video Switcher (ATEM Mini Extreme)', quantity: 1, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'l12', description: 'Audio Mixer & Mics Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'l13', description: 'Intercom System (Comms)', quantity: 1, unit: 'Day', multiplier: 1, rate: 10500, actual: 0 }, { id: 'l14', description: 'Lighting Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l15', description: 'Internet / Bonded Cellular', quantity: 1, unit: 'Day', multiplier: 1, rate: 36000, actual: 0 }, { id: 'l16', description: 'Live Streaming Platform Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'l17', description: 'Minor Edits & Re-uploads', quantity: 1, unit: 'Flat', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'l18', description: 'Production Insurance (Live Event)', quantity: 1, unit: 'Policy', multiplier: 1, rate: 180000, actual: 0 } ] } } }
        };

        const getAllTemplates = () => {
            const stored = localStorage.getItem(templatesKey);
            let templates;
            
            if (stored) {
                try {
                    templates = JSON.parse(stored);
                    templates['Commercial'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Commercial']));
                    templates['Documentary'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Documentary']));
                    templates['LiveStream'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['LiveStream']));
                } catch(e) {
                    templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
                }
            } else {
                templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
            }
            
            localStorage.setItem(templatesKey, JSON.stringify(templates));
            return templates;
        };

        const saveAllTemplates = (templates) => localStorage.setItem(templatesKey, JSON.stringify(templates));

        /* --- Updated Data Structure (v19.53) --- */
const getDefaultBudget = (name, type = 'Commercial') => {
    const allTemplates = getAllTemplates();
    let template = allTemplates[type] ? JSON.parse(JSON.stringify(allTemplates[type])) : JSON.parse(JSON.stringify(allTemplates['Commercial']));
    
    template.projectName = name;
    
    // NEW: The Target Lock Engine Data
    template.targetLock = {
        enabled: false,
        totalCap: 0,
        currency: 'JMD',
        stages: {
            'development': { id: 'dev', label: 'Development', ratio: 5, locked: false, limit: 0 },
            'preProduction': { id: 'pre', label: 'Pre-Production', ratio: 20, locked: false, limit: 0 },
            'production': { id: 'prod', label: 'Production', ratio: 55, locked: false, limit: 0 },
            'postProduction': { id: 'post', label: 'Post-Production', ratio: 15, locked: false, limit: 0 },
            'distribution': { id: 'dist', label: 'Distribution', ratio: 5, locked: false, limit: 0 }
        }
    };

    if(template.sections) {
        Object.values(template.sections).forEach(s => s.items.forEach(i => { 
            i.id = crypto.randomUUID(); 
            if(i.multiplier === undefined) i.multiplier = 1; 
            // NEW: Prepare items to be assigned to a stage later
            i.assignedStage = 'production'; 
        }));
    }
    return template;
};

       // ---------------------------------------------------------
        // UI Rendering
        // ---------------------------------------------------------
        
        function createModal(id, title, contentHtml, maxWidth = 'max-w-2xl') {
            const container = document.getElementById('global-modal-container');
            const modalId = `${id}Modal`;
            let modal = document.getElementById(modalId);
            const fullHtml = `<div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden"><div id="${modalId}Content" class="bg-white rounded-lg shadow-xl w-full ${maxWidth} mx-auto max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95"><div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"><h2 class="text-xl font-bold text-gray-800">${title}</h2><button onclick="closeModal('${modalId}')" aria-label="Close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div><div class="overflow-y-auto flex-grow" id="${modalId}Body">${contentHtml}</div></div></div>`;
            if (modal) modal.remove(); 
            container.insertAdjacentHTML('beforeend', fullHtml);
            modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); }, 10);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modalId); });
            return modal;
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('opacity-0');
            document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            if(modalId === 'settingsModal') { editingGlobalItemIndex = -1; tempTemplateData = null; }
        };

        function renderStatusBar() {
            const container = document.getElementById('statusBar');
            if (!container) return;
            const lastAction = historyStack[historyIndex];
            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < historyStack.length - 1;
            const message = lastAction?.description || 'No recent changes.';
            container.innerHTML = `<div id="statusMsgWrapper" class="scrolling-text-wrapper"><span id="statusBarMessage" class="font-medium px-1">${message}</span></div><div class="flex items-center flex-shrink-0 pl-2 border-l border-blue-200 ml-2"><button id="undoBtn" class="px-2 py-1 rounded-md text-sm font-semibold ${canUndo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canUndo ? 'disabled' : ''}>Undo</button><button id="redoBtn" class="ml-2 px-2 py-1 rounded-md text-sm font-semibold ${canRedo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canRedo ? 'disabled' : ''}>Redo</button></div>`;
        }

/* --- v19.54 RenderEngine (Centralized UI Logic) --- */
const RenderEngine = {
    esc(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
    },

    placeholder(text = 'No items found.') {
        return `<div class="p-8 text-center text-xs text-gray-400 italic">${this.esc(text)}</div>`;
    },

    table({ head = [], body = [], headClasses = 'bg-gray-100 text-gray-600', rowClasses = '', cellClasses = '' }) {
        if (body.length === 0) return this.placeholder();
        return `<table class="w-full text-sm border-collapse">${head.length ? `<thead class="${headClasses}"><tr>${head.map(h => `<th class="p-2 text-left font-bold ${cellClasses}">${h}</th>`).join('')}</tr></thead>` : ''}<tbody class="${rowClasses}">${body.map(row => `<tr class="border-b hover:bg-gray-50 transition-colors">${row.map(cell => `<td class="p-2 ${cellClasses}">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
    },

    section({ name, total = '', isOpen = true, content = '' }) {
        const safeName = this.esc(name);
        return `<div class="mb-4 bg-white rounded-lg shadow-sm border border-gray-200"><div class="relative rounded-t-lg min-h-[44px] px-3 py-2 flex justify-between items-center cursor-pointer bg-gray-50 select-none hover:bg-gray-100 transition-colors" data-section-toggle="${safeName}"><div class="flex items-center gap-2"><span class="section-arrow text-gray-400 text-xs">${isOpen ? 'â–¼' : 'â–¶'}</span><h2 class="text-sm font-bold text-gray-800 uppercase tracking-wide leading-tight">${safeName}</h2></div><span data-section-total="${safeName}" class="text-sm font-bold text-blue-600 font-mono flex-shrink-0">${total}</span></div><div class="section-content rounded-b-lg ${isOpen ? '' : 'hidden'}">${content}</div></div>`;
    },

    // 5. Line Item Row (FIXED: Original SVG Icons Restored)
    lineItem(item, sectionName) {
        const safeId = this.esc(item.id);
        const safeSection = this.esc(sectionName || 'General');
        const isMobile = window.innerWidth < 768;
        const formatMoney = (val) => isMobile ? formatAbbreviated(val, displayCurrency) : formatCurrency(toDisp(val));
        const rateDisp = toDisp(item.rate);
        const actualDisp = toDisp(item.actual);
        const { estimated, variance } = calculateItem(item);
        const crew = item.crew || {};
        const hasCrew = !!crew.name;
        let initials = '?', avatarClass = 'unassigned', titleText = 'Unassigned';
        if (hasCrew) { initials = this.esc(crew.name).split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(); avatarClass = 'assigned'; titleText = this.esc(crew.name); }

        // Restored SVGs
        const cleanPhone = crew.phone ? crew.phone.replace(/[^0-9]/g, '') : '';
        const waCallBtn = cleanPhone ? `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-call" title="Call"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></a>` : '';
        const waMsgBtn = cleanPhone ? `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-msg" title="Message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>` : '';
        const emailBtn = crew.email ? `<a href="mailto:${this.esc(crew.email)}" class="contact-btn btn-email" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>` : '';

        const unitColors = { 'Day': 'blue', 'Week': 'indigo', 'Flat': 'emerald', 'Hour': 'purple', 'Policy': 'orange' };
        const unitClass = `bg-${unitColors[item.unit] || 'gray'}-100 text-${unitColors[item.unit] || 'gray'}-700 border-${unitColors[item.unit] || 'gray'}-200`;
        const isLocked = item.rateType === 'fixed';

        return `<tr class="draggable-row border-b hover:bg-gray-100 group" data-item-id="${safeId}" data-section="${safeSection}"><td class="p-1 w-12 text-center relative"><div class="crew-wrapper"><div class="crew-avatar ${avatarClass}" onclick="toggleCrewPopup(this, event)" ondblclick="openCrewProfile(this, event, '${safeId}', '${safeSection}')" title="${titleText}">${initials}</div><div class="contact-popup">${waCallBtn} ${waMsgBtn} ${emailBtn}<button onclick="openCrewProfile(this, event, '${safeId}', '${safeSection}')" class="contact-btn bg-gray-400">âœŽ</button></div></div></td><td class="p-2 text-center text-gray-400 cursor-grab drag-handle touch-none select-none hover:text-blue-500 w-8">â ¿</td><td class="p-2"><input type="text" data-field="description" data-id="${safeId}" data-section="${safeSection}" value="${this.esc(item.description)}" class="w-full bg-transparent p-1 rounded-md mobile-desc-truncate focus:bg-white focus:ring-1 focus:ring-blue-200" /></td><td class="p-2 text-center md:w-16"><input type="number" data-field="quantity" data-id="${safeId}" data-section="${safeSection}" value="${item.quantity}" class="w-full bg-transparent p-1 rounded-md text-center focus:bg-white" /></td><td class="p-2 relative md:w-20"><span class="md:hidden absolute inset-0 m-auto w-6 h-6 flex items-center justify-center rounded text-xs font-bold pointer-events-none ${unitClass}">${item.unit.charAt(0)}</span><select data-field="unit" data-id="${safeId}" data-section="${safeSection}" class="w-full text-center text-xs font-semibold rounded px-1 py-1 appearance-none cursor-pointer border ${isMobile ? 'opacity-0' : unitClass}">${['Day','Week','Flat','Policy','Hour'].map(u => `<option ${item.unit === u ? 'selected' : ''}>${u}</option>`).join('')}</select></td><td class="p-2 text-left flex items-center justify-start gap-1 md:w-32"><button onclick="toggleRateType('${safeId}', '${safeSection}')" class="w-7 h-7 rounded flex items-center justify-center text-sm border ${isLocked ? 'text-red-500 bg-red-50 border-red-200' : 'text-green-600 bg-green-50 border-green-200'} hover:scale-110 transition-transform flex-shrink-0" title="${isLocked ? 'Fixed' : 'Negotiable'}">${isLocked ? 'ðŸ”’' : 'ðŸ¤'}</button><input type="number" step="0.01" data-field="rate" data-id="${safeId}" data-section="${safeSection}" value="${rateDisp.toFixed(2)}" class="w-full bg-transparent p-1 rounded-md text-left font-mono focus:bg-white" /></td><td data-estimated-id="${safeId}" class="p-2 text-left font-medium text-gray-700 md:w-28 font-mono">${formatMoney(estimated)}</td><td class="p-2 text-left md:w-28"><input type="number" step="0.01" data-field="actual" data-id="${safeId}" data-section="${safeSection}" value="${actualDisp.toFixed(2)}" class="w-full bg-blue-50 p-1 rounded-md text-left font-mono focus:ring-1 focus:ring-blue-300" /></td><td data-variance-id="${safeId}" class="p-2 text-right font-medium text-xs md:w-28 font-mono ${variance > 0 ? 'text-red-500' : 'text-green-600'}">${formatMoney(variance)}</td><td class="p-2 text-center w-10"><button data-remove-item="${safeId}" data-section="${safeSection}" class="text-gray-400 hover:text-red-500 transition-colors">ðŸ—‘ï¸</button></td></tr>`;
    },

    // 6. Document Card (FIXED: Aeroplane Icon)
    docCard(doc, context = 'hub') {
        const isSelectMode = window.docHubState && window.docHubState.mode === 'select';
        const isSelected = window.docHubState && window.docHubState.selected.has(doc.id);
        const clickAction = isSelectMode ? `toggleDocSelection('${doc.id}')` : `openDocumentViewer('${doc.id}', '${context}')`;
        const safeLabel = this.esc(doc.label || 'Untitled');
        const status = doc.status || 'Draft';
        const lastExport = doc.lastExport ? new Date(doc.lastExport).toLocaleDateString() : 'Never';

        const statusColor = {
            'Draft': 'bg-gray-100 text-gray-600',
            'In Progress': 'bg-blue-100 text-blue-700',
            'Ready': 'bg-green-100 text-green-700',
            'Exported': 'bg-purple-100 text-purple-700'
        }[status] || 'bg-gray-100 text-gray-600';

        return `<div onclick="${clickAction}" class="doc-card group relative flex items-center p-3 bg-white border ${isSelected && isSelectMode ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-gray-200'} rounded-lg hover:shadow-md transition-all h-16 w-full select-none cursor-pointer" data-label="${safeLabel.toLowerCase()}">
            ${isSelectMode ? `<div class="mr-3 w-5 h-5 rounded border flex items-center justify-center ${isSelected ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-gray-300'}">${isSelected ? 'âœ“' : ''}</div>` : `<div class="w-10 h-10 rounded-md bg-gray-50 flex-shrink-0 flex items-center justify-center text-lg mr-3 border border-gray-100 shadow-sm">${doc.icon || 'ðŸ“„'}</div>`}
            <div class="min-w-0 flex-1 flex flex-col justify-center">
                <span class="text-sm font-bold text-gray-800 truncate leading-tight block" title="${safeLabel}">${safeLabel}</span>
                <div class="flex items-center gap-2 mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[9px] font-bold ${statusColor}">${status}</span>
                    <span class="text-[9px] text-gray-400">Exported: ${lastExport}</span>
                </div>
            </div>
            ${!isSelectMode ? RenderEngine.docActions(doc.id, context) : ''}
        </div>`;
    },

    // 7. Document Actions (Aeroplane Share + Delete)
    docActions(docId, context = 'hub') {
        return `<div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 bg-white pl-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
            <!-- Share: Paper-plane SVG â†’ Contact Selector with Validation -->
            <button onclick="event.stopPropagation(); if(typeof openDocumentShareSelector === 'function') { openDocumentShareSelector('${docId}'); } else { console.error('Share function missing'); alert('Share feature unavailable - check console'); }" 
                    class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white flex items-center justify-center border border-blue-100 transition-colors" 
                    title="Share with Contact">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
<!-- Delete: Trash SVG â†’ Move to Bin with Validation -->
		<button onclick="event.stopPropagation(); handleDocTrash('${docId}')"
        class="w-8 h-8 flex items-center justify-center rounded-full text-gray-300 hover:bg-red-50 hover:text-red-500 transition-colors border border-transparent hover:border-red-100"
        title="Move to Bin">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
    </svg>
	</button>
        </div>`;
    },

stageCard: (item, stageKey) => {
        // Data Logic
        const d = (item.stageData && item.stageData[stageKey]) ? item.stageData[stageKey] : { days: item.quantity, rate: item.rate };
        const days = parseFloat(d.days) || 0;
        const rate = parseFloat(d.rate) || 0;
        const cost = days * rate;
        
        // Safety Strings
        const safeId = item.id;
        // Escape quotes to prevent breaking the HTML string
        const safeSec = (item._sec || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        const safeDesc = (item.description || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");

        // --- THE FIX ---
        // We match your function signature: openCrewProfile(element, event, id, section)
        const dblClickAction = `openCrewProfile(this, event, '${safeId}', '${safeSec}')`;

        return `
        <div class="stage-card-item bg-white p-2 rounded border border-gray-200 shadow-sm text-xs relative group hover:border-blue-300 transition-colors cursor-pointer" 
             data-item-id="${safeId}" 
             data-stage="${stageKey}"
             data-stage-key="${stageKey}"
             title="Double-click for Contact Card"
             ondblclick="${dblClickAction}">
            
            <div class="flex justify-between items-center mb-1 pr-5">
                <span class="font-bold text-gray-700 truncate mr-2 pointer-events-none">${safeDesc}</span>
                
                <span class="font-mono font-bold text-blue-600 whitespace-nowrap pointer-events-none" id="cost-${safeId}-${stageKey}">
                    ${formatAbbreviated(cost, displayCurrency)}
                </span>
                
                <button onclick="event.stopPropagation(); removeStageItem('${safeId}', '${safeSec}', '${stageKey}')" 
                        class="text-gray-300 hover:text-red-500 absolute top-1 right-1 px-1">Ã—</button>
            </div>
            
            <div class="flex gap-2">
                <div class="w-14 flex-shrink-0">
                    <label class="block text-[8px] text-gray-400 uppercase pointer-events-none">Days</label>
                    <input type="number" value="${days}" 
                           onclick="event.stopPropagation()"
                           ondblclick="event.stopPropagation()"
                           onchange="updateStageItem('${safeId}', '${safeSec}', '${stageKey}', 'days', this.value)"
                           class="w-full bg-gray-50 border border-gray-200 rounded px-1 py-0.5 text-center font-bold focus:bg-white focus:ring-1 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex-1">
                    <label class="block text-[8px] text-gray-400 uppercase pointer-events-none">Rate</label>
                    <input type="number" value="${rate}" 
                           onclick="event.stopPropagation()" 
                           ondblclick="event.stopPropagation()"
                           onchange="updateStageItem('${safeId}', '${safeSec}', '${stageKey}', 'rate', this.value)"
                           class="w-full bg-gray-50 border border-gray-200 rounded px-1 py-0.5 text-right text-gray-600 focus:bg-white focus:ring-1 focus:ring-blue-500 outline-none">
                </div>
            </div>
        </div>`;
    },
};

/* --- v19.52 [Interaction] - Toggle Rate Type v19.53 --- */
window.toggleRateType = function(itemId, sectionName) {
    const item = budget.sections[sectionName].items.find(i => i.id === itemId);
    if (!item) return;
    const current = item.rateType || 'negotiable';
    item.rateType = (current === 'negotiable') ? 'fixed' : 'negotiable';
    pushToHistory(`Changed ${item.description} to ${item.rateType}`);
    render(); 
};


       /* --- v19.52 v19.53 --- */
/* --- v19.53 Responsive Headers (Stable Size, Text Wrap) --- */
function renderBudgetSections() {
    return Object.entries(budget.sections).map(([sectionName, section]) => {
        const bodyContent = `
            <div class="p-0 table-container">
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-white text-gray-500 font-medium border-b border-gray-100">
                        <tr>
                            <th class="p-2 text-center w-12">Crew</th>
                            <th class="p-2 w-8"></th> 
                            <th class="p-2 text-left min-w-[200px]">Description</th>
                            <th class="p-2 text-center md:w-16">Qty</th>
                            <th class="p-2 text-center md:w-20">Unit</th>
                            <th class="p-2 text-left md:w-32">Rate</th>
                            <th class="p-2 text-left md:w-28">Est</th>
                            <th class="p-2 text-left md:w-28">Act</th>
                            <th class="p-2 text-right md:w-28">Var</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody data-section-body="${sectionName}">
                        ${section.items.map(item => RenderEngine.lineItem(item, sectionName)).join('')}
                    </tbody>
                </table>
            </div>
            <div class="p-1 bg-gray-50 border-t border-gray-100 rounded-b-lg">
                <button data-add-item="${sectionName}" class="w-full py-1 text-center text-blue-500 font-bold text-xs hover:bg-blue-50 hover:text-blue-700 transition-colors uppercase tracking-wider">
                    + Add Line Item
                </button>
            </div>`;

        return RenderEngine.section({
            name: sectionName,
            total: '', // Calculated via DOM updates usually, but structure is here
            isOpen: section.isOpen,
            content: bodyContent
        });
    }).join('');
}

/* --- v19.53 Main Render (Summary Rework) --- */
function render() {
    const appContainer = document.getElementById('app');
    if (!budget || !appContainer) return;
    const activeElement = document.activeElement;
    const activeElementId = activeElement ? activeElement.id : null;
    const activeElementDataId = activeElement ? activeElement.dataset.id : null;
    const activeElementDataField = activeElement ? activeElement.dataset.field : null;
    
    appContainer.innerHTML = `
    <header class="mb-4 flex flex-wrap items-center justify-between gap-y-4">
        <div class="flex items-center gap-3 w-full md:w-auto flex-grow mr-4">
            <input type="text" id="projectName" aria-label="Project Name" value="${budget.projectName}" class="text-xl sm:text-3xl md:text-4xl font-bold text-gray-800 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-2 rounded-lg" />
            <button id="loginBtn" aria-label="Connection Status" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0" title="Check connection">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
        </div>
        <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
    </header>

    <div class="mt-2 flex gap-2 overflow-hidden mb-4">
        <button id="openAiToolsBtn" aria-label="AI Assistant" class="p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0" title="AI Assistant">âœ¨</button>
        <div id="statusBar" class="flex-grow p-2 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 flex justify-between items-center overflow-hidden"></div>
    </div>

    <div id="summary" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div class="bg-blue-600 text-white p-4 rounded-xl shadow-md flex flex-col justify-center items-center sm:items-start relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                    <svg width="150" height="150" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>
                </div>
                <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">Estimated Grand Total</p>
                <p id="summaryGrandTotal" class="text-3xl sm:text-4xl font-bold tracking-tight"></p>
            </div>
            <div class="bg-green-600 text-white p-4 rounded-xl shadow-md flex flex-col justify-center items-center sm:items-start relative overflow-hidden">
                <p class="text-green-100 text-xs font-bold uppercase tracking-wider mb-1">Actual Total Cost</p>
                <p id="summaryActualTotal" class="text-3xl sm:text-4xl font-bold tracking-tight"></p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <div class="summary-card bg-red-50 border-red-100">
                <div class="flex justify-between items-start mb-1">
                    <label for="discountPercentage" class="font-semibold text-red-800">Discount</label>
                    <div class="flex items-center bg-white px-1 rounded border border-red-200">
                        <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-xs font-bold text-red-600 outline-none" min="0" max="100">%
                    </div>
                </div>
                <p id="summaryDiscount" class="text-lg font-bold text-red-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-50 border-gray-200">
                <div class="flex justify-between items-start mb-1">
                    <label for="contingencyPercentage" class="font-semibold text-gray-600">Contingency</label>
                    <div class="flex items-center bg-white px-1 rounded border border-gray-200">
                        <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-xs font-bold text-gray-600 outline-none">%
                    </div>
                </div>
                <p id="summaryContingency" class="text-lg font-bold text-gray-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-50 border-gray-200">
                <div class="flex justify-between items-start mb-1">
                    <label for="salesTaxPercentage" class="font-semibold text-gray-600">Sales Tax</label>
                    <div class="flex items-center bg-white px-1 rounded border border-gray-200">
                        <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-xs font-bold text-gray-600 outline-none">%
                    </div>
                </div>
                <p id="summaryTax" class="text-lg font-bold text-gray-700 text-right"></p>
            </div>

            <div class="summary-card bg-gray-100 border-gray-200">
                <p class="font-semibold text-gray-500 mb-1">Subtotal</p>
                <p id="summarySubtotal" class="text-lg font-bold text-gray-800 text-right"></p>
            </div>
        </div>
    </div>

    <main id="budget-sections">${renderBudgetSections()}</main>
    <div id="footnote" class="mt-8 p-3 bg-gray-50 border border-gray-300 rounded-lg text-xs text-gray-600">
        <span>Personnel rates based on 2025 Jamaican market data (Beverly Boy, SalaryExpert, JAMPRO)($355-605USD Cam Op avg ~75k JMD), SalaryExpert (Editor ~50k JMD/day), JAMPRO, EmergeFilm, Paylab (PA 15k min above wage; Makeup 30k incl. materials ~$200USD); reductions: skilled 50-70% below US, entry 60-80%. . </span>
        <button id="compareRatesBtn" class="ml-2 text-blue-600 hover:underline">Compare Rates</button>
    </div>`;
    
    renderProjectManagement();
    renderStatusBar();
    updateCalculations();
    initializeInteractiveInputs();
    initializeDragAndDrop();
    updateOnlineStatus(); 
    if (activeElementId) {
        const toFocus = document.getElementById(activeElementId);
        if (toFocus) toFocus.focus();
    } else if (activeElementDataId && activeElementDataField) {
        const toFocus = document.querySelector(`[data-id="${activeElementDataId}"][data-field="${activeElementDataField}"]`);
        if (toFocus) toFocus.focus();
    }
}

// ---------------------------------------------------------
        // Modal Logic
        // ---------------------------------------------------------

        function showRateComparisonModal() {
             const rateComparisons = [
                { role: 'Camera Operator', local: '60,000 JMD', caricom: '65,000-80,000 JMD (T&T)', us: '$480 USD' },
                { role: 'Editor', local: '50,000 JMD', caricom: '45,000-55,000 JMD', us: '$400 USD' },
                { role: 'Production Assistant', local: '15,000 JMD', caricom: '12,000-18,000 JMD', us: '$150 USD' },
                { role: 'Hair & Makeup Artist', local: '30,000 JMD', caricom: '25,000-35,000 JMD', us: '$300 USD' },
                { role: 'Director of Photography', local: '70,000 JMD', caricom: '75,000-90,000 JMD', us: '$800 USD' },
                { role: 'Sound Mixer', local: '40,000 JMD', caricom: '35,000-45,000 JMD', us: '$350 USD' }
            ];

            const content = `
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">Role</th><th class="p-2 text-left">Local Jamaica (JMD/day)</th><th class="p-2 text-left">Caricom Avg (JMD/day)</th><th class="p-2 text-left">US Avg (USD/day)</th></tr></thead>
                    <tbody>${rateComparisons.map(row => `<tr class="border-b"><td class="p-2">${row.role}</td><td class="p-2">${row.local}</td><td class="p-2">${row.caricom}</td><td class="p-2">${row.us}</td></tr>`).join('')}</tbody>
                </table>
                <p class="text-xs text-gray-500 mt-4">Sources: Beverly Boy, SalaryExpert, JAMPRO. Rates approximate for mid-range productions.</p>
            `;
            createModal('rateComparison', 'Rate Comparisons (2025 Averages)', content, 'max-w-4xl');
        }

        /* --- v19.51 AI Modal with File Tray v19.52 Persistence & Offline Mode v19.53 --- */
function showAIToolsModal() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const attachments = budget.attachments || [];
    const isOnline = navigator.onLine;
    
    // v19.53: Check Context
    const aiContext = budget.aiContext || { saveHistory: true, analysis: "", chat: [] };
    
    // Render Attachment Tray
    const trayHTML = attachments.length > 0 ? 
        `<div class="mb-3 p-2 bg-gray-100 rounded-lg border border-gray-200">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 px-1">Attached Context</div>
            <div class="flex flex-col gap-1 max-h-32 overflow-y-auto">
                ${attachments.map(file => `
                    <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 shadow-sm group">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-6 h-6 flex-shrink-0 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-[9px] font-bold border border-blue-200">${file.name.split('.').pop().toUpperCase().substring(0,3)}</div>
                            <span class="text-xs text-gray-700 truncate font-medium" title="${file.name}">${getAbbreviatedName(file.name)}</span>
                        </div>
                        <button onclick="removeAttachment('${file.id}')" class="text-gray-400 hover:text-red-500 p-1 opacity-60 group-hover:opacity-100 transition-opacity">Ã—</button>
                    </div>`).join('')}
            </div>
        </div>` : 
        `<div class="mb-3 p-3 border-2 border-dashed border-gray-200 rounded-lg text-center text-gray-400 text-xs">No files attached. <button onclick="handleUniversalImport()" class="text-blue-500 hover:underline">Import Context</button></div>`;

    // v19.53: Saved History Rendering
    const savedAnalysis = aiContext.analysis || '';
    const savedChat = aiContext.chat.length > 0 ? 
        aiContext.chat.map(msg => `<div class="ai-message ${msg.role === 'user' ? 'user' : 'assistant'}">${msg.content}</div>`).join('') : 
        `<div class="text-sm text-gray-400 text-center mt-10">Ask about union rules, equipment packages, or local rates...</div>`;

    const offlineBanner = !isOnline ? `<div class="bg-yellow-100 text-yellow-800 p-2 text-xs text-center font-bold border-b border-yellow-200 mb-2 rounded">âš ï¸ Offline Mode - Showing Saved History</div>` : '';

    const content = !key ? 
        `<div class="text-center py-10"><div class="text-4xl mb-4">ðŸ”‘</div><h3 class="text-lg font-bold text-gray-700">API Key Required</h3><p class="text-gray-500 text-sm mb-4">Please go to Settings > AI Assistant to configure your API key.</p><button onclick="closeModal('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Open Settings</button></div>` 
        : 
        `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
            <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-lg"><span class="text-2xl">ðŸ©º</span> Budget Doctor</h4>
                <p class="text-sm text-gray-500 mb-4">Analyze your current budget for gaps, risks, and rate anomalies using ${provider}.</p>
                <button id="analyzeBudgetBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex justify-center items-center gap-2 font-medium transition-colors ${!isOnline ? 'opacity-50 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}>${isOnline ? 'Analyze Current Budget' : 'Analyze Unavailable (Offline)'}</button>
                <div id="aiAnalysisOutput" class="mt-4 text-sm text-gray-700 flex-grow overflow-y-auto border-t pt-4 min-h-[200px]">${savedAnalysis}</div>
            </div>
            
            <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><span class="text-2xl">ðŸ’¬</span> Production Consultant</h4>
                </div>
                ${offlineBanner}
                ${trayHTML}
                <div id="aiChatHistory" class="flex-grow overflow-y-auto bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200">${savedChat}</div>
                
                <form id="aiChatForm" class="flex gap-2 items-center">
                    <button type="button" onclick="handleUniversalImport()" class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg border border-transparent hover:border-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button>
                    <input type="text" id="aiChatInput" placeholder="Ask a question..." class="flex-grow text-sm p-3 border rounded-lg focus:outline-none focus:border-blue-500" ${!isOnline ? 'disabled' : ''}>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 ${!isOnline ? 'opacity-50 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                </form>
            </div>
        </div>`;

    createModal('aiTools', 'âœ¨ AI Assistant', content, 'max-w-4xl');
    
    if (key && isOnline) {
        document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
        document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
    }
}

/* --- v19.53 Settings Modal Wrapper --- */
function showSettingsModal(defaultTab = 'general') {
    const content = `
        <div class="flex border-b text-sm font-medium text-gray-600 overflow-x-auto">
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'general' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('general', this)">General</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'templates' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('templates', this)">Templates</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'database' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('database', this)">Line Items</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'ai' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('ai', this)">âœ¨ AI Assistant</button>
             <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'roadmap' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('roadmap', this)">Roadmap</button>
			 <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'contacts' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('contacts', this)">Contacts</button>
        </div>
        <div class="p-6" id="settingsContent">${renderSettingsContent(defaultTab)}</div>
    `;
    createModal('settings', 'Settings & Tools', content, 'max-w-4xl');
    bindSettingsEvents(defaultTab);
}

/* --- P2 --- */
/* --- v19.53 Film Industry Database, Open Gate v 1.1 Expanded Industry Database v19.54 --- */
/* ==========================================================================
   mBTOG (Open Gate Engine) v1.0
   The Knowledge Hub: Rates, Contacts, Telemetry, and External Data Ingestion.
   ========================================================================== */
/* --- v19.54 [Open Gate] - Industry Database Engine --- */
const mBTOG = {
    settings: {
        optInSharing: JSON.parse(localStorage.getItem('moo_og_share') || 'false'),
        location: localStorage.getItem('moo_og_loc') || 'Jamaica'
    },
    
    // In-Memory Stores
    rates: [],    
    contacts: [],
    templates: [], // New Home for Document Templates
    
    init() {
        this.loadRates();
        this.loadContacts();
        this.loadTemplates();
        console.log(`Open Gate Initialized: ${this.rates.length} rates, ${this.templates.length} templates.`);
    },

    // --- 1. Data Loading ---
    loadRates() {
        const stored = JSON.parse(localStorage.getItem('prodBudget_v5_globalItems') || '[]');
        if (stored.length === 0) {
            this.rates = this._getJamaicaDatabase(); 
            this.saveRates();
        } else {
            this.rates = stored;
        }
    },

    loadContacts() {
        this.contacts = JSON.parse(localStorage.getItem('moo_contacts') || '[]');
    },

    // NEW: Load Templates into Memory
    loadTemplates() {
        // In the future, this can pull from localStorage or Cloud
        this.templates = [
            // Pre-Production
            { id: 'script', cat: 'Pre-Prod', label: 'Script', icon: 'ðŸ“', default: true },
            { id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: 'ðŸ“–', default: false },
            { id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: 'ðŸ”', default: true },
            { id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: 'ðŸŽ¬', default: true },
            { id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: 'ðŸŽ¨', default: false },
            { id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: 'âœ…', default: true },
            { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: 'ðŸ‘¤', default: false },
            { id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: 'ðŸŽ­', default: false },
            { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: 'ðŸ“…', default: false },
            { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: 'ðŸ—“ï¸', default: false },
            { id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: 'ðŸ“', default: false },
            { id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget/Cost Report', icon: 'ðŸ’°', default: true },
            { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: 'âš–ï¸', default: false },
            { id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: 'ðŸš€', default: false },

            // Production
            { id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: 'ðŸ“¢', default: true },
            { id: 'prodReport', cat: 'Production', label: 'Production Report', icon: 'ðŸ“Š', default: true },
            { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: 'ðŸŽ¬', default: false },
            { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: 'ðŸ’„', default: false },
            { id: 'propList', cat: 'Production', label: 'Prop List', icon: 'ðŸ”«', default: false },
            { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'ðŸ“ž', default: true },
            { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: 'ðŸš—', default: false },
            { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: 'ðŸ±', default: false },
            { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: 'ðŸ’µ', default: false },
            { id: 'po', cat: 'Production', label: 'Purchase Order', icon: 'ðŸ§¾', default: false },
            { id: 'timecard', cat: 'Production', label: 'Timecards', icon: 'â±ï¸', default: false },
            { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: 'ðŸ¤–', default: false },
            { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: 'ðŸŒ±', default: false },

            // Post-Production
            { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: 'ðŸ‘¾', default: false },
            { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: 'ðŸ“…', default: true },
            { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: 'ðŸ“¦', default: false },
            { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: 'ðŸ†', default: false },

            // Legal / Compliance
            { id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: 'ðŸ¤', default: true },
            { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: 'ðŸ ', default: true },
            { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: 'ðŸŽ¥', default: false },
            { id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: 'ðŸ“„', default: false },
            { id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: 'ðŸ›¡ï¸', default: false },
            { id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: 'âœï¸', default: false },
            { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: 'ðŸ˜·', default: false },
            { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: 'â­', default: false }
        ];
    },

    saveRates() { localStorage.setItem('prodBudget_v5_globalItems', JSON.stringify(this.rates)); },
    saveContacts() { localStorage.setItem('moo_contacts', JSON.stringify(this.contacts)); },

    // --- 2. Database Options ---
    loadJamaicaDefaults() {
        if(confirm("Load 'Jamaica Database' (2025 Rates)?")) {
            const defaults = this._getJamaicaDatabase();
            this.ingest(defaults, 'rate');
            if(typeof window.switchSettingsTab === 'function') {
                window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
            }
        }
    },

    // --- 3. Ingestion & Telemetry ---
    async addExternalDatabase(url) {
        if(!url) return alert("Please enter a valid URL.");
        alert(`Open Gate Link: Architecture ready.\nTarget: ${url}`);
    },

    ingest(items, type = 'rate') {
        let added = 0;
        if (type === 'rate') {
            const existing = new Set(this.rates.map(i => i.description.toLowerCase()));
            items.forEach(i => {
                if (!existing.has(i.description.toLowerCase())) {
                    this.rates.push({ description: i.description, unit: i.unit || 'Day', rate: parseFloat(i.rate) || 0 });
                    added++;
                }
            });
            if (added > 0) this.saveRates();
        } 
        return added;
    },

    setPrivacy(optIn) {
        this.settings.optInSharing = optIn;
        localStorage.setItem('moo_og_share', optIn);
    },

    // Unified Search
    search(term, type = 'all') {
        term = term.toLowerCase();
        const results = { rates: [], contacts: [], templates: [] };
        if (type === 'all' || type === 'rate') results.rates = this.rates.filter(i => i.description.toLowerCase().includes(term));
        if (type === 'all' || type === 'contact') results.contacts = this.contacts.filter(c => c.name.toLowerCase().includes(term));
        if (type === 'all' || type === 'template') results.templates = this.templates.filter(t => t.label.toLowerCase().includes(term));
        return results;
    },

    // --- 4. The Jamaica Database (Default List) ---
    _getJamaicaDatabase() {
        return [
            // --- Development ---
            { description: 'Storyboard Artist', unit: 'Day', rate: 45000 },
            { description: 'Copywriter (Pitch/Treatment)', unit: 'Flat', rate: 75000 },
            { description: 'Script Consultant / Doctor', unit: 'Flat', rate: 150000 },
            { description: 'Pitch Deck Designer', unit: 'Flat', rate: 120000 },
            { description: 'Researcher', unit: 'Day', rate: 25000 },
            { description: 'Concept Artist', unit: 'Day', rate: 40000 },
            { description: 'Legal - Rights & Clearances', unit: 'Flat', rate: 250000 },

            // --- Above the Line ---
            { description: 'Director', unit: 'Day', rate: 85000 },
            { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
            { description: 'Producer', unit: 'Day', rate: 75000 },
            { description: 'Line Producer', unit: 'Day', rate: 65000 },
            { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
            { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
            { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
            { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },

            // --- Production Dept ---
            { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
            { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
            { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
            { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
            { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
            { description: 'Key PA', unit: 'Day', rate: 20000 },
            { description: 'Set PA', unit: 'Day', rate: 15000 },
            { description: 'Office PA', unit: 'Day', rate: 15000 },
            { description: 'Truck PA', unit: 'Day', rate: 18000 },
            { description: 'Location Manager', unit: 'Day', rate: 50000 },
            { description: 'Location Scout', unit: 'Day', rate: 35000 },
            { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
            { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
            { description: 'Security Guard', unit: 'Day', rate: 12000 },
            { description: 'Craft Service', unit: 'Day', rate: 25000 },
            { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },

            // --- Camera Dept ---
            { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
            { description: 'Camera Operator', unit: 'Day', rate: 60000 },
            { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
            { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
            { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
            { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
            { description: 'Drone Operator', unit: 'Day', rate: 55000 },
            { description: 'Camera Utility', unit: 'Day', rate: 25000 },

            // --- Lighting & Grip ---
            { description: 'Gaffer', unit: 'Day', rate: 55000 },
            { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
            { description: 'Electrician', unit: 'Day', rate: 30000 },
            { description: 'Key Grip', unit: 'Day', rate: 50000 },
            { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
            { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
            { description: 'Grip', unit: 'Day', rate: 30000 },
            { description: 'Generator Operator', unit: 'Day', rate: 35000 },

            // --- Sound ---
            { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
            { description: 'Boom Operator', unit: 'Day', rate: 35000 },
            { description: 'Sound Utility', unit: 'Day', rate: 25000 },

            // --- Art & Wardrobe ---
            { description: 'Production Designer', unit: 'Day', rate: 65000 },
            { description: 'Art Director', unit: 'Day', rate: 50000 },
            { description: 'Set Decorator', unit: 'Day', rate: 45000 },
            { description: 'Set Dresser', unit: 'Day', rate: 30000 },
            { description: 'Props Master', unit: 'Day', rate: 45000 },
            { description: 'Assistant Props', unit: 'Day', rate: 30000 },
            { description: 'Costume Designer', unit: 'Day', rate: 55000 },
            { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
            { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
            { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
            { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
            { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },

            // --- Post-Production ---
            { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
            { description: 'Editor', unit: 'Day', rate: 50000 },
            { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
            { description: 'Colorist', unit: 'Hour', rate: 15000 },
            { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
            { description: 'VFX Artist', unit: 'Day', rate: 55000 },
            { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
            { description: 'Composer', unit: 'Flat', rate: 200000 },
            { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
        ];
    }
};

// Initialize immediately
mBTOG.init();

/* --- v19.54 Template Helper Refactors (Using mBTOG) --- */

// Helper: Get all available templates (built-in from Open Gate + custom from Budget)
function getAllAvailableTemplates() {
    const builtIn = mBTOG.templates.map(t => ({ ...t, isCustom: false }));
    const custom = (budget && Array.isArray(budget.customTemplates)) 
        ? budget.customTemplates.map(t => ({ ...t, isCustom: true }))
        : [];
    return [...builtIn, ...custom];
}

function ensureDocumentData() {
    if (!budget.documents) {
        // Use mBTOG.templates instead of DOCUMENT_TEMPLATES
        budget.documents = mBTOG.templates.filter(t => t.default).map(t => ({ ...t, status: 'Draft', content: null }));
    }
    if (!budget.documentTrash) budget.documentTrash = [];
    if (!budget.callSheet) budget.callSheet = JSON.parse(JSON.stringify(defaultCallSheet));
}

function showAddDocumentModal() {
    const existingIds = (budget.documents || []).map(d => d.id);
    // Use mBTOG.templates instead of DOCUMENT_TEMPLATES
    const available = mBTOG.templates.filter(t => !existingIds.includes(t.id));
    
    const content = `
        <div class="p-2">
            <input type="text" id="docSearch" placeholder="Search templates..." class="w-full p-3 border rounded-lg mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="docTemplateList" class="h-64 overflow-y-auto space-y-2">
                ${renderTemplateList(available)}
            </div>
            <div class="mt-4 pt-4 border-t">
                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Or create custom</p>
                <form onsubmit="handleCustomDoc(event)" class="flex gap-2">
                    <input type="text" id="customDocName" placeholder="Custom Document Name" class="flex-1 p-2 border rounded text-sm" required>
                    <select id="customDocCat" class="p-2 border rounded text-sm bg-white"><option>Pre-Prod</option><option>Production</option><option>Post-Prod</option><option>Legal</option></select>
                    <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded text-xs font-bold">Add</button>
                </form>
            </div>
        </div>`;
    createModal('addDoc', 'Add Document', content, 'max-w-md');
    
    document.getElementById('docSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = available.filter(t => t.label.toLowerCase().includes(term));
        document.getElementById('docTemplateList').innerHTML = renderTemplateList(filtered);
    });
}

function addDocument(templateId) {
    // Use mBTOG.templates instead of DOCUMENT_TEMPLATES
    const template = mBTOG.templates.find(t => t.id === templateId);
    if(template) {
        budget.documents.push({ ...template, status: 'Draft', content: null, dateCreated: new Date().toISOString() });
        saveBudget();
        closeModal('addDocModal');
        showDocumentsModal();
    }
}

function applyTemplate(docId, templateId, isCustom) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    let template;
    if (isCustom) {
        template = budget.customTemplates.find(t => t.id === templateId);
    } else {
        // Use mBTOG.templates instead of DOCUMENT_TEMPLATES
        template = mBTOG.templates.find(t => t.id === templateId);
    }

    if (!template) {
        alert("Template not found.");
        return;
    }

    // Load template structure into document content
    doc.content = {
        type: 'template',
        templateId: template.id,
        templateLabel: template.label,
        fields: template.fields || {}, 
        data: {} 
    };

    if (!template.fields) {
        doc.content.fields = {
            projectName: { label: "Project Name", value: budget.projectName || "" },
            director: { label: "Director", value: "" },
            producer: { label: "Producer", value: "" },
            shootDates: { label: "Shoot Dates", value: "" },
            notes: { label: "Notes", value: "", multiline: true }
        };
        doc.content.data = {
            projectName: budget.projectName || "",
            director: "",
            producer: "",
            shootDates: "",
            notes: ""
        };
    }

    doc.status = 'In Progress';
    saveBudget();
    closeModal('templatePickerModal');
    openDocumentViewer(docId); 
}

/* --- v19.53 Add Item Modal with Search Engine Update v19.54 --- */
function showItemSelectorModal(sectionName) {
    // 1. Prepare Data
    const allItems = getAllItems();
    const uniqueMap = {};
    
    // Sort & De-dupe Logic
    allItems.forEach(item => {
        if (!uniqueMap[item.description]) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: 0, isGlobal: item.isGlobal };
        else if (item.isGlobal) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: uniqueMap[item.description].count, isGlobal: true };
        if (!item.isGlobal) {
             uniqueMap[item.description].count++;
             if(!uniqueMap[item.description].isGlobal) uniqueMap[item.description].rate += item.rate;
        }
    });
    
    Object.keys(uniqueMap).forEach(desc => {
        const entry = uniqueMap[desc];
        if (!entry.isGlobal && entry.count > 1) entry.rate = entry.rate / entry.count;
    });

    const itemList = Object.keys(uniqueMap)
        .filter(desc => desc !== 'New Item' && desc.trim())
        .map(desc => ({ description: desc, unit: uniqueMap[desc].unit, rate: uniqueMap[desc].rate, isGlobal: uniqueMap[desc].isGlobal }))
        .sort((a, b) => { 
            if (a.isGlobal && !b.isGlobal) return -1; 
            if (!a.isGlobal && b.isGlobal) return 1; 
            return a.description.localeCompare(b.description); 
        });

    // Helper: Row Renderer
    const rowRenderer = (item) => `
        <div class="flex justify-between items-center p-2 border-b hover:bg-blue-50 cursor-pointer transition-colors" 
             data-select-item='${JSON.stringify({desc: item.description.replace(/'/g, "&#39;"), unit: item.unit, rate: item.rate})}'>
            <div>
                <div class="font-bold text-sm text-gray-700">${item.description} ${item.isGlobal ? '<span class="text-yellow-500">â˜…</span>' : ''}</div>
                <div class="text-xs text-gray-400">${item.unit}</div>
            </div>
            <div class="font-mono text-xs font-bold text-blue-600">${formatCurrency(item.rate)}</div>
        </div>`;

    // 2. Render Initial Content
    const content = `
        <div class="mb-3">
            <input type="text" id="addItemSearch" placeholder="ðŸ” Search roles..." 
                   class="w-full p-3 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-bold shadow-sm" 
                   autocomplete="off">
        </div>
        <button id="newItemBtn" class="w-full mb-2 p-3 bg-blue-100 text-blue-700 font-bold rounded-lg hover:bg-blue-200 border border-blue-200 flex justify-center items-center gap-2 transition-colors">
            <span>+</span> Create Blank Item
        </button>
        <div class="max-h-[50vh] overflow-y-auto border-t border-gray-100" id="itemSelectorList">
            ${itemList.map(rowRenderer).join('')}
        </div>
        <div class="mt-2 text-xs text-center text-gray-400">Database items marked with <span class="text-yellow-500">â˜…</span></div>`;
    
    // 3. Open Modal via Engine
    if (typeof mBTME === 'undefined') {
        // Fallback if engine isn't ready
        alert("System loading... please try again in a moment.");
        return;
    }

    mBTME.open('itemSelector', 'Add Line Item', content, 'max-w-md', {
        onOpen: () => {
            // A. Auto-Focus
            const input = document.getElementById('addItemSearch');
            if (input) {
                input.focus();
                // B. Attach Search using Engine
                mBTME.attachSearch('addItemSearch', 'itemSelectorList', itemList, rowRenderer);
            }

            // C. Bind "Create Blank"
            document.getElementById('newItemBtn')?.addEventListener('click', () => { 
                mBTME.close('itemSelectorModal'); 
                handleAddBlank(sectionName); 
            });

            // D. Bind Click Selection
            const list = document.getElementById('itemSelectorList');
            if (list) {
                list.addEventListener('click', (e) => {
                    const row = e.target.closest('[data-select-item]');
                    if(row) {
                        const data = JSON.parse(row.dataset.selectItem);
                        mBTME.close('itemSelectorModal'); 
                        handleAddExisting(sectionName, data.desc, data.unit, data.rate); 
                    }
                });
            }
        }
    });
}

function handleAddBlank(sectionName) {
    const newItem = { id: crypto.randomUUID(), ...initialLineItem };
    if(!newItem.assignedStage) newItem.assignedStage = ['prod'];
    budget.sections[sectionName].items.push(newItem);
    pushToHistory(`Added new item to ${sectionName}`);
    render(); 
}

// Event Handlers
        function bindAppEventListeners() {
            const appContainer = document.getElementById('app');
            const footer = document.querySelector('footer');

            if (!appContainer || appContainer.dataset.listenersBound) return;
            appContainer.dataset.listenersBound = 'true';

            appContainer.addEventListener('change', (e) => {
                const id = e.target.id;
                if (id === 'projectName') handleProjectNameChange(e);
                else if (id === 'contingencyPercentage') { budget.contingencyPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Contingency %'); updateCalculations(); }
                else if (id === 'salesTaxPercentage') { budget.salesTaxPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Sales Tax %'); updateCalculations(); }
                else if (id === 'discountPercentage') handleDiscountChange(e);
                else if (id === 'projectLoader') { loadBudget(e.target.value); render(); }
                else if (id === 'newProjectSelector') handleNewProjectSelection(e);
                else if (e.target.dataset.field === 'unit') handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Changed unit for ${e.target.closest('tr').querySelector('input[data-field=description]').value}`);
            });

if(footer) {
                footer.addEventListener('click', (e) => { 
if (e.target.closest('#docsFooterBtn')) showDocumentsModal();
                    if (e.target.closest('#stagesFooterBtn')) showStagesModal();
                    if (e.target.closest('#publishFooterBtn')) document.getElementById('publishBtn')?.click();
// Trigger existing logic via ID or duplicate logic below
                    if (e.target.closest('#settingsBtn')) showSettingsModal(); 
                    if (e.target.closest('#footerCoffeeBtn')) {
                        const btn = document.querySelector('#bmc-wbtn');
                        if (btn) btn.click();
                        else window.open('https://buymeacoffee.com/jaysonmy', '_blank');
                    }
                });
            }

            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.id === 'undoBtn') handleUndo();
                else if (target.id === 'redoBtn') handleRedo();
                else if (target.id === 'loginBtn') handleLogin();
                else if (target.closest('#openAiToolsBtn')) showAIToolsModal();
                else if (target.closest('#deleteProjectBtn')) deleteProject(currentProjectName);
                else if (target.closest('#currencyToggleBtn')) handleCurrencyToggle();
                else if (target.closest('#exportPdfBtn')) exportToPdf();
                else if (target.closest('#exportXlsxBtn')) exportToXlsx();
                else if (target.closest('[data-section-toggle]')) handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
                else if (target.closest('[data-add-item]')) showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
                else if (target.closest('[data-remove-item]')) handleRemoveItem(target.closest('[data-remove-item]').dataset.section, target.closest('[data-remove-item]').dataset.removeItem);
                else if (target.id === 'compareRatesBtn') showRateComparisonModal();
            });

            appContainer.addEventListener('input', (e) => {
                const input = e.target;
                if (input.dataset.field) {
                    handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Updated ${input.dataset.field}`);
                } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    updateCalculations();
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        // ---------------------------------------------------------
        // Implementation Logic
        // ---------------------------------------------------------

        function getAllItems() {
            const allItems = [];
            getGlobalItems().forEach(item => allItems.push({ description: item.description, unit: item.unit, rate: item.rate, isGlobal: true }));
            getProjectList().forEach(projectName => {
                try {
                    const data = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName) || '{}');
                    if (data?.sections) Object.values(data.sections).forEach(section => {
                        section.items?.forEach(item => {
                            if (item.description?.trim()) allItems.push({ description: item.description.trim(), unit: item.unit || 'Day', rate: item.rate || 0, isGlobal: false });
                        });
                    });
                } catch (e) { console.error(e); }
            });
            return allItems;
        }

        function formatAndUpdateSummaryValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = formatCurrency(value);
            if (element.scrollWidth > element.parentElement.clientWidth) element.textContent = formatAbbreviated(value, displayCurrency);
        }

        function checkOverBudget() {
            const actualTotal = calculateActuals(budget.sections);
            const { subtotal } = calculateTotals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const grandTotal = (subtotal + contingencyAmount + taxAmount) - ((subtotal + contingencyAmount + taxAmount) * ((budget.discountPercentage || 0) / 100));

            const summaryActual = document.getElementById('summaryActualTotal');
            if (summaryActual) {
                const hasOverBudget = actualTotal > grandTotal;
                summaryActual.parentElement.classList.toggle('bg-red-50', hasOverBudget);
                if (hasOverBudget && !summaryActual.parentElement.querySelector('.alert-badge')) {
                     summaryActual.parentElement.innerHTML += '<div class="alert-badge">!</div>';
                } else if (!hasOverBudget) {
                     const badge = summaryActual.parentElement.querySelector('.alert-badge');
                     if (badge) badge.remove();
                }
            }

            for (const sectionName in budget.sections) {
                budget.sections[sectionName].items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    const row = document.querySelector(`[data-item-id="${item.id}"]`);
                    if (row) row.classList.toggle('bg-red-50', variance > 0);
                });
            }
        }

/* --- v19.52 Smart Calculation Update --- */
function updateCalculations() {
    if (!document.getElementById('summarySubtotal')) return;
    
    // Check mobile state dynamically
    const isMobile = window.innerWidth < 768;
    const formatMoney = (val) => isMobile ? formatAbbreviated(val, displayCurrency) : formatCurrency(toDisp(val));

    const { subtotal } = calculateTotals(budget.sections);
    const actualTotal = calculateActuals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;

    // Use formatMoney wrapper which now handles abbreviations automatically
    formatAndUpdateSummaryValue('summarySubtotal', toDisp(subtotal));
    formatAndUpdateSummaryValue('summaryContingency', toDisp(contingencyAmount));
    formatAndUpdateSummaryValue('summaryTax', toDisp(taxAmount));
    formatAndUpdateSummaryValue('summaryDiscount', toDisp(-discountAmount)); // Negative sign for clarity
    formatAndUpdateSummaryValue('summaryGrandTotal', toDisp(grandTotal));
    formatAndUpdateSummaryValue('summaryActualTotal', toDisp(actualTotal));

    // Update Lines
    for (const sectionName in budget.sections) {
        const section = budget.sections[sectionName];
        let sectionTotal = 0;
        section.items.forEach(item => {
            const { estimated, variance } = calculateItem(item);
            sectionTotal += estimated;
            
            const estimatedCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
            if (estimatedCell) estimatedCell.textContent = formatMoney(estimated);
            
            const varianceCell = document.querySelector(`[data-variance-id="${item.id}"]`);
            if (varianceCell) {
                varianceCell.textContent = formatMoney(variance);
                varianceCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
            }
        });
        const sectionTotalEl = document.querySelector(`[data-section-total="${sectionName}"]`);
        if (sectionTotalEl) sectionTotalEl.textContent = formatCurrency(toDisp(sectionTotal)); 
    }
    checkOverBudget();
}

/* --- v19.53 [Logic] - Auto-Flat Quantity & Color Refresh --- */
function handleUpdate(sectionName, itemId, field, value, description) {
    const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
    if (!item) return;
    
    let valueToSave = value;

    // 1. Standard Value Parsing
    if (['rate', 'actual'].includes(field)) {
        const parsedValue = parseFloat(value) || 0;
        valueToSave = (displayCurrency === 'USD') ? convertCurrency(parsedValue, 'JMD') : parsedValue;
    } else if (field === 'quantity') {
        valueToSave = parseFloat(value) || 0;
    } else if (field === 'multiplier') { 
        const parsed = parseFloat(value) || 1; 
        valueToSave = parsed > 0 ? parsed : 1; 
    }
    
    // 2. "Flat Rate" Smart Logic
    if (field === 'unit') {
        // Case A: Switching TO Flat (Save Qty, Set to 1)
        if (value === 'Flat' && item.unit !== 'Flat') {
            item._storedQuantity = item.quantity; // Remember the "Day" count
            item.quantity = 1; 
        } 
        // Case B: Switching FROM Flat (Restore Qty)
        else if (item.unit === 'Flat' && value !== 'Flat') {
            if (item._storedQuantity !== undefined) {
                item.quantity = item._storedQuantity; // Restore the "Day" count
            }
        }
    }

    // 3. Apply the value
    item[field] = valueToSave;
    pushToHistory(description);
    
    // 4. Render Updates
    if (field === 'unit') {
        render(); // Force re-render to update color pills and new Quantity input
    } else if (field !== 'description') {
        updateCalculations(); // Fast math update for numbers
    }
}


function handleAddExisting(sectionName, desc, unit, rate) {
    const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit: unit, multiplier: 1, rate: rate, actual: 0 };
    budget.sections[sectionName].items.push(newItem);
    pushToHistory(`Added '${desc}' to ${sectionName}`);
    const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
    if (tableBody) {
        // UPDATED: Using the centralized engine
        tableBody.insertAdjacentHTML('beforeend', RenderEngine.lineItem(newItem, sectionName));
        initializeDragAndDrop();
    }
    updateCalculations();
}

        function handleRemoveItem(sectionName, itemId) {
            const itemIndex = budget.sections[sectionName].items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const itemName = budget.sections[sectionName].items[itemIndex].description;
                budget.sections[sectionName].items.splice(itemIndex, 1);
                pushToHistory(`Removed '${itemName}' from ${sectionName}`);
                const row = document.querySelector(`button[data-remove-item="${itemId}"]`).closest('tr');
                if (row) row.remove();
                updateCalculations();
            }
        }

        function handleToggleSection(sectionName) {
            const section = budget.sections[sectionName];
            section.isOpen = !section.isOpen;
            pushToHistory(`${section.isOpen ? 'Opened' : 'Closed'} section: ${sectionName}`);
            const content = document.querySelector(`[data-section-toggle="${sectionName}"]`).nextElementSibling;
            content.classList.toggle('hidden');
            const arrow = document.querySelector(`[data-section-toggle="${sectionName}"] .section-arrow`);
            arrow.innerHTML = section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>';
        }

        function handleDiscountChange(e) { 
            let value = parseFloat(e.target.value) || 0;
            if (value > 100) { value = 100; e.target.value = 100; } else if (value < 0) { value = 0; e.target.value = 0; }
            budget.discountPercentage = value; 
            pushToHistory('Updated Discount %'); updateCalculations(); 
        }
        
        function handleProjectNameChange(e) {
            const newName = e.target.value.trim();
            if (newName && newName !== currentProjectName) {
                if (getProjectList().includes(newName)) { alert(`A project named "${newName}" already exists.`); e.target.value = currentProjectName; return; }
                localStorage.removeItem(storageKeyPrefix + currentProjectName);
                const oldName = budget.projectName;
                budget.projectName = newName;
                pushToHistory(`Renamed project from '${oldName}' to '${newName}'`);
                render(); 
            }
        }
        
        function getFormattedDatePart() {
            const date = new Date();
            const dateFormat = getProjectDateFormat();
            const separator = getProjectNameSeparator();
            const pad = (num) => String(num).padStart(2, '0');
            
            let datePart;
            const M = pad(date.getMonth() + 1);
            const D = pad(date.getDate());
            const Y = date.getFullYear();

            if (dateFormat === 'MMDDYYYY') {
                datePart = `${M}${separator}${D}${separator}${Y}`;
            } else { // YYYYMMDD
                datePart = `${Y}${separator}${M}${separator}${D}`;
            }
            return datePart;
        }

        /* --- v19.51 File Menu Handler v19.52 --- */
        function handleNewProjectSelection(e) {
            const type = e.target.value;
            
            if (type === 'Duplicate') {
                handleDuplicateProject();
                e.target.value = ""; 
            }
            else if (type === 'Recover') {
                showRecoveryModal();
                e.target.value = "";
            }
            else if (type === 'ImportFile' || type === 'ImportMoo') {
                handleUniversalImport(); 
                
                setTimeout(() => { 
                    const el = document.getElementById('newProjectSelector');
                    if(el) el.value = ""; 
                }, 500);
            }
            else if (type) {
                handleNewProject(true, type); 
            } 
        }
        
        function handleDuplicateProject() {
            if (!budget) return;
            const newBudget = JSON.parse(JSON.stringify(budget));
            let baseName = newBudget.projectName.replace(/ \(Copy( \d+)?\)$/, "");
            let newName = `${baseName} (Copy)`;
            let i = 2;
            while(getProjectList().includes(newName)) { newName = `${baseName} (Copy ${i})`; i++; }
            newBudget.projectName = newName;
            Object.values(newBudget.sections).forEach(s => s.items.forEach(i => i.id = crypto.randomUUID()));
            budget = newBudget;
            pushToHistory(`Duplicated project to '${newName}'`);
            render();
        }
        
        function handleNewProject(doRender = true, type = 'Commercial') {
            const datePart = getFormattedDatePart();
            let newName = `Untitled ${type}`;
            let i = 1;
            let finalName = `${newName} ${datePart}`;
            while(getProjectList().includes(finalName)) { i++; finalName = `${newName} ${datePart} (${i})`; }
            budget = getDefaultBudget(finalName, type);
            pushToHistory(`Created new project '${finalName}'`);
            if(doRender) render();
        }

   // --- Drag & Drop (Powered by SortableJS) ---
        function initializeDragAndDrop() {
            const containers = document.querySelectorAll('tbody[data-section-body]');
            
            containers.forEach(container => {
                // Prevent duplicate initialization
                if(container._sortable) return;

                container._sortable = new Sortable(container, {
                    group: 'budget-items', // Allows dragging between sections
                    handle: '.drag-handle', // Restricts drag to the handle icon
                    animation: 150, // Smooth swap animation
                    
                    // Visual Classes (Matches the CSS we just added)
                    ghostClass: 'sortable-ghost', 
                    dragClass: 'sortable-drag',
                    
                    // Critical for Desktop/Mobile consistency
                    forceFallback: true, 
                    fallbackOnBody: true,
                    swapThreshold: 0.65,
                    
                    // Delays prevent accidental drags while scrolling on mobile
                    delay: 100, 
                    delayOnTouchOnly: true,

                    onEnd: function (evt) {
                        const itemEl = evt.item;
                        const newIndex = evt.newIndex;
                        const toSection = evt.to.dataset.sectionBody;
                        const fromSection = evt.from.dataset.sectionBody;
                        const itemId = itemEl.dataset.itemId;

                        // Only process if position actually changed
                        if (toSection === fromSection && evt.oldIndex === newIndex) return;

                        // 1. Update Data Model
                        const fromList = budget.sections[fromSection].items;
                        
                        // Find item object
                        const itemObjIndex = fromList.findIndex(i => i.id === itemId);
                        if (itemObjIndex > -1) {
                            const [movedItem] = fromList.splice(itemObjIndex, 1);
                            
                            // Insert into new list at specific index
                            if (!budget.sections[toSection].items) budget.sections[toSection].items = [];
                            budget.sections[toSection].items.splice(newIndex, 0, movedItem);
                            
                            // 2. Update DOM Data Attributes (Critical for next move)
                            itemEl.dataset.section = toSection;
                            itemEl.querySelectorAll('[data-section]').forEach(el => el.dataset.section = toSection);
                            
                            // 3. Save & Recalculate
                            pushToHistory(`Moved item to ${toSection}`);
                            updateCalculations();
                        }
                    }
                });
            });
        }
        function resetDragStyles(el) { el.classList.remove('drag-over'); el.style.borderTop = 'none'; el.style.borderBottom = 'none'; }
        function moveItem(itemId, fromSection, toSection, toIndex) {
            if (fromSection === toSection && toIndex === Array.from(document.querySelector(`[data-section-body="${fromSection}"]`).children).findIndex(row => row.dataset.itemId === itemId)) return;
            const fromItems = budget.sections[fromSection].items;
            const toItems = budget.sections[toSection].items;
            const item = fromItems.find(i => i.id === itemId);
            if (!item) return;
            fromItems.splice(fromItems.indexOf(item), 1);
            toItems.splice(toIndex, 0, item);
            pushToHistory(`Reordered item '${item.description}' from ${fromSection} to ${toSection}`);
            render();
        }

// --- Settings & AI Handlers ---
/* --- v19.53 Settings Logic (Search & Line Items) --- */
window.switchSettingsTab = function(tabName, btn) {
    editingGlobalItemIndex = -1;
    const buttons = btn.parentElement.children;
    for(let b of buttons) b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
    btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
    document.getElementById('settingsContent').innerHTML = renderSettingsContent(tabName);
    bindSettingsEvents(tabName);
};

function bindSettingsEvents(tabName) {
    if(tabName === 'general') { 
        document.getElementById('updateBtn')?.addEventListener('click', downloadOfflineHTML); 
        document.getElementById('dateFormatSelect')?.addEventListener('change', (e) => { setProjectDateFormat(e.target.value); });
        document.getElementById('separatorInput')?.addEventListener('input', (e) => { setProjectNameSeparator(e.target.value); });
    }
	else if (tabName === 'contacts') { bindContactsEvents(); }
    else if (tabName === 'templates') { bindTemplateEvents(); }
    else if (tabName === 'database') { bindDatabaseEvents(); }
    else if (tabName === 'roadmap') { document.getElementById('toggleRoadmapDetailsBtn')?.addEventListener('click', (e) => { document.querySelectorAll('.roadmap-detail').forEach(el => el.classList.toggle('hidden')); e.target.textContent = e.target.textContent.includes('Expand') ? 'Collapse Details' : 'Expand Details'; }); }
    else if (tabName === 'ai') { bindAIEvents(); }
}

function bindAIEvents() {
    document.getElementById('aiProviderSelect')?.addEventListener('change', (e) => { setSelectedProvider(e.target.value); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
    document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => { saveStoredApiKey(getSelectedProvider(), document.getElementById('apiKeyInput').value.trim()); alert('API Key Saved'); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
}

function bindDatabaseEvents() {
    document.getElementById('addGlobalItemForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = document.getElementById('dbDesc').value.trim();
        const unit = document.getElementById('dbUnit').value;
        const rate = parseFloat(document.getElementById('dbRate').value) || 0;
        if(desc) {
            const items = getGlobalItems();
            if (editingGlobalItemIndex > -1) { items[editingGlobalItemIndex] = { description: desc, unit, rate }; editingGlobalItemIndex = -1; } 
            else { 
                const existingIdx = items.findIndex(i => i.description.toLowerCase() === desc.toLowerCase());
                if(existingIdx >= 0) items.splice(existingIdx, 1);
                items.unshift({ description: desc, unit, rate }); 
            }
            mBTOG.rates = items; mBTOG.saveRates();
            window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
        }
    });

    // New Search Listener
    document.getElementById('dbSearchInput')?.addEventListener('input', (e) => {
        filterDbList(e.target.value);
    });
}

// Helper: Filter Logic
function filterDbList(term) {
    const all = getGlobalItems();
    const lower = term.toLowerCase();
    const filtered = all.filter(i => i.description.toLowerCase().includes(lower));
    document.getElementById('dbListBody').innerHTML = renderDbListItems(filtered);
}

// Helper: Render Rows
function renderDbListItems(items) {
    if(items.length === 0) return '<tr><td colspan="3" class="p-4 text-center text-gray-400">No items found.</td></tr>';
    return items.map((item, idx) => `<tr class="border-t hover:bg-gray-50 ${idx === editingGlobalItemIndex ? 'bg-blue-50' : ''}"><td class="p-2">${item.description}</td><td class="p-2 text-right">${formatCurrency(item.rate)}</td><td class="p-2 text-center"><button aria-label="Edit Item" class="text-blue-500 mr-2" onclick="editGlobalItem(${idx})">âœŽ</button><button aria-label="Delete Item" class="text-red-400" onclick="deleteGlobalItem(${idx})">Ã—</button></td></tr>`).join('');
}

function renderSettingsContent(tabName) {
    const currentDateFormat = getProjectDateFormat();
    const currentSeparator = getProjectNameSeparator();

/* --- v19.53 [Settings] - General UI (Centered & Fitted Buttons) --- */
if (tabName === 'general') {
    return `<div class="space-y-6">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
            <h3 class="font-bold text-blue-800 mb-2">Application Info</h3>
            <p class="text-sm text-gray-700">Current Version: <strong>v${APP_VERSION}</strong></p>
            <p class="text-sm text-gray-500 mt-1">Status: ${navigator.onLine ? '<span class="text-green-600 font-semibold">Online</span>' : '<span class="text-red-500 font-semibold">Offline</span>'}</p>
        </div>
        
        <div class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-2">Project Naming Preferences</h3>
            <div>
                <label for="dateFormatSelect" class="block text-xs font-semibold text-gray-600 mb-1">Date Format</label>
                <select id="dateFormatSelect" aria-label="Date Format" class="w-full text-sm p-2 border rounded">
                    <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD (Default)</option>
                    <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                </select>
            </div>
             <div>
                <label for="separatorInput" class="block text-xs font-semibold text-gray-600 mb-1">Separator</label>
                <input type="text" id="separatorInput" aria-label="Date Separator" maxlength="1" value="${currentSeparator}" class="w-10 text-sm p-2 border rounded text-center">
            </div>
        </div>

        <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between">
             <div>
                <label class="font-bold text-gray-700 text-sm cursor-pointer" for="compactModeCheck">Compact Mode</label>
                <p class="text-xs text-gray-400">Use abbreviations and icons for a denser layout.</p>
             </div>
             <input type="checkbox" id="compactModeCheck" disabled class="w-5 h-5 rounded text-blue-600 cursor-not-allowed opacity-50" title="Coming Soon">
        </div>

        <div class="pt-2 border-t">
            <h3 class="font-bold text-gray-800 mb-3 text-sm text-center sm:text-left">Maintenance & Tools</h3>
            
            <div class="flex flex-wrap gap-3 justify-center">
                <button id="updateBtn" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                   Download Offline Beta
                </button>
                
                <button onclick="if(confirm('Reload app to fix display bugs? (Your data is safe)')) { navigator.serviceWorker.getRegistrations().then(regs => { regs.forEach(r => r.unregister()); window.location.reload(); }); }" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                    Fix Bugs / Reload
                </button>

                <button onclick="handleFactoryReset()" class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 text-sm font-bold shadow-sm transition-colors whitespace-nowrap">
                    Factory Reset
                </button>
            </div>
            
            <p class="text-xs text-gray-400 mt-2 text-center">"Download Offline Beta" saves this exact version to your device.</p>
        </div>

        <div class="mt-4 flex justify-center border-t pt-4">
             <button onclick="const btn=document.querySelector('#bmc-wbtn'); if(btn) btn.click(); else window.open('https://buymeacoffee.com/jaysonmy', '_blank');" class="bmc-btn text-sm">â˜• Buy me a coffee</button>
        </div>
    </div>`;
}

else if (tabName === 'contacts') {
        const contacts = getGlobalContacts();
        return `
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                <div>
                    <h3 class="font-bold text-indigo-900">Crew Database</h3>
                    <p class="text-xs text-indigo-700">Manage roster for Open Gate Auto-Assign.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('csvImportInput').click()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700">Import CSV</button>
                    <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importContactsCSV(this)">
                    <button onclick="autoAssignRolesFromContacts()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700 shadow-sm flex items-center gap-1"><span>âš¡</span> Auto-Assign Budget</button>
                </div>
            </div>

            <form id="addContactForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border">
                <div class="col-span-12 sm:col-span-4">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Name</label>
                    <input type="text" id="cName" class="w-full p-2 border rounded text-sm" required placeholder="Jane Doe">
                </div>
                <div class="col-span-12 sm:col-span-4">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Default Role</label>
                    <input type="text" id="cRole" class="w-full p-2 border rounded text-sm" required placeholder="Director, Gaffer...">
                </div>
                <div class="col-span-12 sm:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Email/Phone</label>
                    <input type="text" id="cContact" class="w-full p-2 border rounded text-sm" placeholder="jane@film.com">
                </div>
                <div class="col-span-12 sm:col-span-1">
                    <button type="submit" class="w-full p-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">+</button>
                </div>
            </form>

            <div class="border rounded-lg overflow-hidden">
                <div class="bg-gray-100 p-2 text-xs font-bold text-gray-500 flex justify-between">
                    <span>${contacts.length} Contacts stored</span>
                    <input type="text" id="contactSearch" placeholder="Search..." class="bg-white border rounded px-2 py-0.5 text-xs font-normal w-32">
                </div>
                <div class="max-h-64 overflow-y-auto" id="contactsListBody">
                    ${renderContactsList(contacts)}
                </div>
            </div>
        </div>`;
    }

else if (tabName === 'templates') {
        const allTemplates = getAllTemplates();
        if(!editingTemplateId) editingTemplateId = 'Commercial';
        const options = Object.keys(allTemplates).map(k => `<option value="${k}" ${k === editingTemplateId ? 'selected' : ''}>${k}</option>`).join('');
        
        const isReadOnly = isDefaultTemplate(editingTemplateId);
        const disabledClass = isReadOnly ? 'opacity-50 cursor-not-allowed bg-gray-300' : 'bg-blue-600 hover:bg-blue-700';
        
        return `
        <div class="h-full flex flex-col">
            <div class="mb-4 flex flex-wrap gap-2 items-center justify-between bg-gray-50 p-3 rounded-lg border">
                <div class="flex items-center gap-2 flex-grow">
                    <label class="text-sm font-bold text-gray-700 whitespace-nowrap">Edit Template:</label>
                    <select id="templateSelector" aria-label="Select Template" class="p-2 border rounded text-sm bg-white shadow-sm flex-grow max-w-xs">${options}</select>
                </div>
                <div class="flex gap-2">
                    <button id="createTemplateBtn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center gap-1"><span class="text-base">+</span> Clone / New</button>
                    <button id="importTemplateBtn" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Import</button>
                    <button id="exportTemplateBtn" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Export</button>
                    <button id="deleteTemplateBtn" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 border border-red-200 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}" ${isReadOnly ? 'disabled' : ''}>Delete</button>
                </div>
            </div>
            
            <div id="templateEditorContainer" class="flex-grow overflow-y-auto border rounded-lg p-4 bg-white shadow-inner">
                </div>
            
            <div class="mt-4 pt-3 border-t flex justify-end gap-3">
                <p class="text-xs text-gray-400 self-center mr-auto">Changes are applied to NEW projects only.</p>
                <button id="saveTemplateChangesBtn" class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${disabledClass}" ${isReadOnly ? 'disabled' : ''}>Save Changes</button>
            </div>
        </div>
        `;
    } 

/* v19.53 [Settings] - AI Toggle Added --- */
else if (tabName === 'ai') {
    const currentProvider = getSelectedProvider();
    const saveHistory = budget.aiContext ? budget.aiContext.saveHistory : true;
    let keyLink = '#'; 
    // ... (Keep existing key link logic) ...
    if(currentProvider === 'gemini') keyLink = 'https://aistudio.google.com/app/apikey';
    else if(currentProvider === 'openai') keyLink = 'https://platform.openai.com/api-keys';
    else if(currentProvider === 'xai') keyLink = 'https://console.x.ai/';
    else if(currentProvider === 'deepseek') keyLink = 'https://platform.deepseek.com/api_keys';

    const rawKey = getStoredApiKey(currentProvider) || '';
    const safeKey = rawKey.replace(/"/g, '&quot;');

    return `
    <div class="space-y-6">
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
            <h3 class="font-bold text-indigo-800 mb-2">AI Configuration</h3>
            
            <div class="mb-4 bg-white p-3 rounded border border-indigo-100">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="aiSaveToggle" class="w-4 h-4 rounded text-indigo-600" ${saveHistory ? 'checked' : ''} onchange="budget.aiContext.saveHistory = this.checked; saveBudget();">
                    <div>
                        <span class="block text-sm font-bold text-gray-800">Save AI Context</span>
                        <span class="block text-xs text-gray-500">Save chat history and analysis to this specific budget file.</span>
                    </div>
                </label>
            </div>

            <div class="mb-3">
                <label class="block text-xs font-semibold text-indigo-600 mb-1">Active AI Provider</label>
                <select id="aiProviderSelect" class="w-full text-sm p-2 border rounded border-indigo-200">
                    <option value="gemini" ${currentProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                    <option value="openai" ${currentProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                    <option value="xai" ${currentProvider === 'xai' ? 'selected' : ''}>xAI</option>
                    <option value="deepseek" ${currentProvider === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                </select>
            </div>
            
            <div class="mb-1">
                <label class="block text-xs font-semibold text-indigo-600 mb-1">API Key</label>
                <div class="flex gap-2 w-full">
                    <input type="password" id="apiKeyInput" value="${safeKey}" class="flex-grow min-w-0 text-sm p-2 border rounded border-indigo-200 outline-none">
                    <button id="saveApiKeyBtn" class="flex-shrink-0 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                </div>
            </div>
            <p class="text-[10px] text-indigo-500 mt-1">Don't have a key? <a href="${keyLink}" target="_blank" class="underline font-bold">Get one here</a>.</p>
        </div>
    </div>`;
}

 else if (tabName === 'database') {
        const globalItems = mBTOG.rates;;
        const editItem = editingGlobalItemIndex > -1 ? globalItems[editingGlobalItemIndex] : null;
        return `
        <div class="space-y-4">
<div class="bg-gray-100 p-3 rounded mb-4 border border-gray-200">
                <label class="text-[10px] font-bold text-gray-500 uppercase">ðŸ”— Connect External Database</label>
                <div class="flex gap-2 mt-1 mb-3">
                    <input type="text" id="ogExternalUrl" placeholder="https://example.com/rates.json" class="flex-1 text-xs p-2 border rounded">
                    <button onclick="mBTOG.addExternalDatabase(document.getElementById('ogExternalUrl').value)" class="bg-gray-800 text-white text-xs font-bold px-3 rounded">Connect</button>
                </div>

                <label class="text-[10px] font-bold text-gray-500 uppercase block border-t border-gray-200 pt-2 mt-2">ðŸ“š Local Presets</label>
                <button onclick="mBTOG.loadJamaicaDefaults()" class="mt-2 w-full text-left flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-green-50 hover:border-green-200 transition-colors shadow-sm group">
                    <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ‡¯ðŸ‡²</span>
                    <div>
                        <div class="text-xs font-bold text-gray-800 group-hover:text-green-700">Jamaica Database</div>
                        <div class="text-[9px] text-gray-400">Load 2025 Standard Industry Rates</div>
                    </div>
                </button>

                <div class="mt-3 pt-2 border-t border-gray-200 flex items-center gap-2">
                     <input type="checkbox" id="ogOptIn" ${typeof mBTOG !== 'undefined' && mBTOG.settings.optInSharing ? 'checked' : ''} onchange="mBTOG.setPrivacy(this.checked)">
                     <span class="text-[10px] text-gray-500">Contribute anonymized rates to Open Gate Global Stats</span>
                </div>
            </div>
            
            <form id="addGlobalItemForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border ${editItem ? 'border-blue-300 bg-blue-50' : ''}">
                <div class="col-span-12 sm:col-span-5"><label class="block text-xs font-semibold text-gray-500 mb-1">Description</label><input type="text" id="dbDesc" aria-label="Description" class="w-full text-sm p-2 border rounded" required value="${editItem ? editItem.description : ''}"></div>
                <div class="col-span-6 sm:col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Unit</label><select id="dbUnit" aria-label="Unit" class="w-full text-sm p-2 border rounded"><option ${editItem?.unit === 'Day' ? 'selected' : ''}>Day</option><option ${editItem?.unit === 'Week' ? 'selected' : ''}>Week</option><option ${editItem?.unit === 'Flat' ? 'selected' : ''}>Flat</option></select></div>
                <div class="col-span-6 sm:col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Rate</label><input type="number" id="dbRate" aria-label="Rate" class="w-full text-sm p-2 border rounded" value="${editItem ? editItem.rate : ''}"></div>
                <div class="col-span-12 sm:col-span-1 flex gap-1 mt-2 sm:mt-0">${editItem ? `<button type="button" aria-label="Cancel" onclick="cancelEditGlobalItem()" class="w-full p-2 bg-gray-400 text-white rounded">x</button>` : ''}<button type="submit" aria-label="Save" class="w-full p-2 ${editItem ? 'bg-green-600' : 'bg-blue-600'} text-white rounded">${editItem ? 'âœ“' : '+'}</button></div>
            </form>

            <div class="relative">
                <input type="text" id="dbSearchInput" placeholder="Search line items..." class="w-full p-2 mb-2 border rounded text-sm focus:border-blue-500 focus:outline-none">
            </div>

            <div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto" id="dbListContainer">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-right">Rate</th><th class="p-2 text-center">Act</th></tr></thead>
                    <tbody id="dbListBody">
                        ${renderDbListItems(globalItems)}
                    </tbody>
                </table>
            </div>
        </div>`;
    } else if (tabName === 'roadmap') {
         // 1. Data Definition
         const futureItems = [
            "<b>Smart Discounts (v19.60):</b> Stage-specific rates (e.g., lower rate for Pre-Pro, higher for Shoot) with aggregate discount reporting.",
            "<b>Toast Notifications:</b> Replacing browser popups with sleek, non-intrusive status messages.",
            "<b>Cloud Integration:</b> Real Google Drive/Dropbox saving (replacing local storage).",
            "<b>AI 2.0:</b> Deep analysis of uploaded scripts/schedule PDFs to auto-suggest line items.",
            "<b>Open Gate Database:</b> Anonymous rate sharing to build a community cost averages database."
         ];

         const recentItems = [
            { v: "v19.53", t: "Stages & Polish", d: "<b>Stages:</b> 'Target Lock' budget balancing, 'Top Spenders' list, and 'Sync Days' to auto-update crew quantities.<br><b>UI:</b> Sticky Section Headers (Mobile), Inverted Summary Dashboard (EGT first).<br><b>Database:</b> Searchable line items & expanded default roles." },
            { v: "v19.52", t: "Cloud & Context", d: "<b>Files:</b> Import/Export .moo files, Attach context for AI.<br><b>Exports:</b> PDF/Excel landscape options." }
         ];

         const archiveItems = [
            { v: "v19.50", t: "Production Workflow", d: "<b>Crew:</b> Visual Avatars, Native Contact Import.<br><b>Actions:</b> WhatsApp/Email integration." },
            { v: "v19.49", t: "PWA Core", d: "Offline capability, 'Get Offline Tool' download." }
         ];

         // 2. Helper function
         const renderList = (items) => items.map(i => 
            `<li class="text-sm text-gray-700 mb-3">
                <span class="font-bold text-blue-700">${i.v}</span> 
                <span class="text-xs text-gray-500 font-mono">(${i.t})</span><br>
                <span class="text-gray-600">${i.d}</span>
            </li>`
         ).join('');

         // 3. Return the HTML structure
         return `
         <div class="space-y-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <h3 class="font-bold text-gray-800">Development Roadmap</h3>
                <button id="toggleRoadmapDetailsBtn" class="text-xs text-blue-600 font-semibold hover:bg-blue-50 px-2 py-1 rounded border border-transparent hover:border-blue-100 transition-colors">Expand History</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="relative pl-6 border-l-2 border-gray-200 space-y-8 ml-2">
                    
                    <div class="relative">
                        <div class="absolute -left-[31px] bg-white border-2 border-dashed border-purple-400 rounded-full w-4 h-4 mt-1.5 shadow-sm"></div>
                        <h4 class="text-md font-bold text-purple-800 mb-2">Up Next (v19.60 Logic Upgrade)</h4>
                        <ul class="space-y-2">
                            ${futureItems.map(f => `<li class="flex items-start gap-2 text-sm text-gray-600"><span class="text-purple-400 mt-0.5">â€¢</span> ${f}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="relative">
                        <div class="absolute -left-[33px] bg-blue-600 border-4 border-white shadow-md rounded-full w-6 h-6 mt-0"></div>
                        <h4 class="text-md font-bold text-blue-800 mb-2">Current Release (v19.53)</h4>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 shadow-sm">
                            <ul class="space-y-1">
                                ${renderList(recentItems)}
                            </ul>
                        </div>
                    </div>

                    <div class="relative roadmap-detail hidden transition-all duration-300">
                        <div class="absolute -left-[31px] bg-gray-400 border-2 border-white rounded-full w-4 h-4 mt-1.5"></div>
                        <h4 class="text-md font-bold text-gray-500 mb-2">Archive</h4>
                        <ul class="space-y-1 pl-1 opacity-75 border-t pt-2 mt-2">
                            ${renderList(archiveItems)}
                        </ul>
                    </div>
                    
                </div>
            </div>
         </div>`;
    }
}

        /* --- v19.50 Mobile Crew Toggle Helper v19.52 --- */
        window.toggleCrewPopup = function(el, event) {
            if(event) event.stopPropagation(); 
            const wrapper = el.parentElement;
            
            document.querySelectorAll('.crew-wrapper').forEach(div => {
                if (div !== wrapper) div.classList.remove('mobile-active');
            });
            
            wrapper.classList.toggle('mobile-active');
        };

        /* --- v19.50 Crew Profile Manager v19.52 --- */
   /* --- v19.54 [Crew] - Contact Card Actions (WA, Call, SMS, Email) --- */
window.openCrewProfile = function(el, event, itemId, sectionName) {
    if(event) event.stopPropagation();
    
    const section = budget.sections[sectionName];
    const item = section.items.find(i => i.id === itemId);
    if(!item) return;

    const crew = item.crew || { name: '', phone: '', email: '' };
    
    // 1. Prepare Action Links
    const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
    const hasPhone = cleanPhone.length > 6; // Basic validation
    const hasEmail = crew.email && crew.email.includes('@');
    
    const actionsBar = `
        <div class="flex justify-center gap-3 mb-6 mt-2">
            ${hasPhone ? `
                <a href="tel:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 border border-green-200 flex items-center justify-center shadow-sm group-hover:bg-green-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Call</span>
                </a>
                <a href="sms:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Text</span>
                </a>
                <a href="https://wa.me/${cleanPhone}" target="_blank" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200 flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">WhatsApp</span>
                </a>
            ` : ''}
            ${hasEmail ? `
                <a href="mailto:${crew.email}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-200 flex items-center justify-center shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Email</span>
                </a>
            ` : ''}
            ${!hasPhone && !hasEmail ? '<span class="text-xs text-gray-400 italic">Enter contact details to enable actions</span>' : ''}
        </div>
    `;

    const content = `
        <form id="crewProfileForm" class="space-y-4 p-1">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-3xl shadow-md border-4 border-white">
                    ${crew.name ? crew.name.substring(0,1).toUpperCase() : '?'}
                </div>
                <h3 class="text-lg font-bold text-gray-900 mt-2">${crew.name || 'New Crew Member'}</h3>
                <p class="text-sm text-blue-600 font-medium">${item.description}</p>
            </div>

            ${actionsBar}
            
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Contact Details</h4>
                    <button type="button" id="importContactBtn" class="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Import
                    </button>
                </div>
                
                <div>
                    <input type="text" id="crewName" value="${crew.name || ''}" placeholder="Full Name" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="tel" id="crewPhone" value="${crew.phone || ''}" placeholder="Phone" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="email" id="crewEmail" value="${crew.email || ''}" placeholder="Email" class="w-full p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="pt-2 flex justify-between items-center">
                <button type="button" class="text-red-500 text-xs font-bold hover:text-red-700 px-2" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Unassign</button>
                <button type="submit" class="bg-gray-900 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-black transition-transform active:scale-95">Save & Close</button>
            </div>
        </form>
    `;

    createModal('crewProfile', '', content, 'max-w-sm');

    // Attach Import Logic (Native)
    document.getElementById('importContactBtn').addEventListener('click', async () => {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                if (contacts.length) {
                    const c = contacts[0];
                    if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                    if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                    if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                }
            } catch (ex) { console.log(ex); }
        } else {
            alert("Contact import not supported on this device/browser.");
        }
    });

    // Attach Save Logic
    document.getElementById('crewProfileForm').addEventListener('submit', (e) => {
        e.preventDefault();
        item.crew = {
            name: document.getElementById('crewName').value.trim(),
            phone: document.getElementById('crewPhone').value.trim(),
            email: document.getElementById('crewEmail').value.trim()
        };
        pushToHistory(`Updated crew: ${item.crew.name}`);
        closeModal('crewProfileModal');
        
        // Refresh Screens
        render(); 
        if(document.getElementById('stagesViewModal')) showStagesModal(); 
    });
};

        window.clearCrewAssignment = function(itemId, sectionName) {
            if(confirm('Remove this person from the role?')) {
                const item = budget.sections[sectionName].items.find(i => i.id === itemId);
                if(item) {
                    delete item.crew;
                    pushToHistory(`Cleared crew from ${item.description}`);
                    closeModal('crewProfileModal');
                    render();
                }
            }
        };

/* --- P3 --- */
/* --- v19.51 Export PDF with Options All exports now use mBTPublisher - v19.52, v19.53, v19.54 --- */

function exportToPdf() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">PDF Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfFitToPageModal" class="w-4 h-4 rounded" checked>
                    <span class="text-sm font-medium text-gray-700">Fit to Page (Auto-scale)</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfLandscapeModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Landscape Orientation</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="mBTME.close('pdfExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmPdfExport" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Export PDF</button>
            </div>
        </div>
    `;

    mBTME.open('pdfExport', 'Export Budget to PDF', content, 'max-w-md', {
        onOpen: () => {
            document.getElementById('confirmPdfExport').addEventListener('click', () => {
                const fitToPage = document.getElementById('pdfFitToPageModal').checked;
                const hideZeroQty = document.getElementById('pdfHideZeroQtyModal').checked;
                const landscape = document.getElementById('pdfLandscapeModal').checked;
                const includeStages = document.getElementById('pdfStagesModal').checked;

                mBTME.close('pdfExportModal');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: landscape ? 'landscape' : 'portrait' });

                doc.setFontSize(18);
                doc.text(budget.projectName || "Untitled Project", 14, 20);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 26);

                const { subtotal } = calculateTotals(budget.sections);
                const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
                const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
                const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
                const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
                const grandTotal = totalBeforeDiscount - discountAmount;

                const summaryData = [
                    ['Subtotal', formatCurrency(toDisp(subtotal))],
                    [`Contingency (${budget.contingencyPercentage}%)`, formatCurrency(toDisp(contingencyAmount))],
                    [`Sales Tax (${budget.salesTaxPercentage}%)`, formatCurrency(toDisp(taxAmount))],
                    [`Discount (${budget.discountPercentage}%)`, `-${formatCurrency(toDisp(discountAmount))}`],
                    ['GRAND TOTAL', formatCurrency(toDisp(grandTotal))]
                ];

                doc.autoTable({
                    startY: 32,
                    head: [['Category', 'Amount']],
                    body: summaryData,
                    theme: 'striped',
                    headStyles: { fillColor: [66, 66, 66] },
                    columnStyles: { 0: { fontStyle: 'bold' }, 1: { halign: 'right' } },
                    margin: { left: 14, right: landscape ? 150 : 100 }
                });

                let finalY = doc.lastAutoTable.finalY + 10;
                const tableRows = [];

                Object.entries(budget.sections).forEach(([sectionName, section]) => {
                    let sectionTotal = 0;
                    const sectionItems = [];

                    section.items.forEach(item => {
                        if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;
                        const { estimated } = calculateItem(item);
                        sectionTotal += estimated;
                        sectionItems.push([
                            item.description,
                            item.quantity,
                            item.unit,
                            formatCurrency(toDisp(item.rate)),
                            formatCurrency(toDisp(estimated))
                        ]);
                    });

                    if (sectionItems.length === 0) return;

                    tableRows.push([{ content: sectionName.toUpperCase(), colSpan: 5, styles: { fillColor: [220, 220, 220], fontStyle: 'bold', textColor: [0, 0, 0] } }]);
                    tableRows.push(...sectionItems);
                    tableRows.push([{ content: `Total ${sectionName}: ${formatCurrency(toDisp(sectionTotal))}`, colSpan: 5, styles: { halign: 'right', fontStyle: 'bold', fillColor: [245, 245, 245] } }]);
                });

                doc.autoTable({
                    startY: finalY,
                    head: [['Description', 'Qty', 'Unit', 'Rate', 'Total']],
                    body: tableRows,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: fitToPage ? 8 : 9, cellPadding: fitToPage ? 2 : 3 },
                    columnStyles: fitToPage ? {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 15, halign: 'center' },
                        2: { cellWidth: 15, halign: 'center' },
                        3: { cellWidth: 25, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                    } : {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 20, halign: 'center' },
                        3: { cellWidth: 30, halign: 'right' },
                        4: { cellWidth: 35, halign: 'right', fontStyle: 'bold' }
                    }
                });

                if (includeStages) {
                    doc.addPage();
                    doc.setFontSize(14);
                    doc.text('Production Stages Breakdown', 14, 20);
                    doc.setFontSize(10);
                    doc.text('(Coming soon)', 14, 28);
                }

                doc.save(`${budget.projectName || 'Budget'}.pdf`);
            });
        }
    });
}

function exportToXlsx() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">Excel Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="mBTME.close('xlsxExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmXlsxExport" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">Export Excel</button>
            </div>
        </div>
    `;

    mBTME.open('xlsxExport', 'Export Budget to Excel', content, 'max-w-md', {
        onOpen: () => {
            document.getElementById('confirmXlsxExport').addEventListener('click', () => {
                const hideZeroQty = document.getElementById('xlsxHideZeroQtyModal').checked;
                const includeStages = document.getElementById('xlsxStagesModal').checked;

                mBTME.close('xlsxExportModal');

                const data = [];
                data.push([budget.projectName || "Untitled Project"]);
                data.push([`Generated: ${new Date().toLocaleDateString()}`]);
                data.push([]);

                const { subtotal } = calculateTotals(budget.sections);
                const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
                const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
                const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
                const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
                const grandTotal = totalBeforeDiscount - discountAmount;
                const totalActual = calculateActuals(budget.sections);

                data.push(["BUDGET SUMMARY", ""]);
                data.push(["Subtotal", toDisp(subtotal)]);
                data.push([`Contingency (${budget.contingencyPercentage}%)`, toDisp(contingencyAmount)]);
                data.push([`Sales Tax (${budget.salesTaxPercentage}%)`, toDisp(taxAmount)]);
                data.push([`Discount (${budget.discountPercentage}%)`, -toDisp(discountAmount)]);
                data.push(["GRAND TOTAL", toDisp(grandTotal)]);
                data.push(["TOTAL ACTUAL SPEND", toDisp(totalActual)]);
                data.push([]);
                data.push(["Description", "Qty", "Unit", "Rate", "Estimated", "Actual", "Variance"]);

                Object.entries(budget.sections).forEach(([sectionName, section]) => {
                    data.push([sectionName.toUpperCase(), "", "", "", "", "", ""]);
                    let sectionEst = 0;
                    let sectionAct = 0;
                    section.items.forEach(item => {
                        if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;
                        const { estimated, variance } = calculateItem(item);
                        sectionEst += estimated;
                        sectionAct += (parseFloat(item.actual) || 0);
                        data.push([
                            item.description,
                            item.quantity,
                            item.unit,
                            toDisp(item.rate),
                            toDisp(estimated),
                            toDisp(item.actual),
                            toDisp(variance)
                        ]);
                    });
                    data.push([
                        `Total ${sectionName}`,
                        "", "", "",
                        toDisp(sectionEst),
                        toDisp(sectionAct),
                        toDisp(sectionAct - sectionEst)
                    ]);
                    data.push([]);
                });

                mBTPublisher.toXLSX(data, 'Budget Detail', budget.projectName || 'Budget');
            });
        }
    });
}

function exportToMoo() {
    mBTPublisher.toMoo();
}

/* JPG Combo Helpers (Ready for Document Viewer) */
window.generateMtempJPG = (docId) => {
    const doc = budget.documents.find(d => d.id === docId);
    mBTPublisher.toFileFromHTML('', `${budget.projectName}_${doc.label}`, ['jpg'], doc);
};

window.generateMtempBoth = (docId) => {
    const doc = budget.documents.find(d => d.id === docId);
    mBTPublisher.toFileFromHTML('', `${budget.projectName}_${doc.label}`, ['pdf','jpg'], doc);
};
function handleUniversalImport() {
    if (budget && budget.projectName) saveBudget();

    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = '.moo,.json,.pdf,.doc,.docx,.txt,.rtf,.md,.csv,.xls,.xlsx,image/*';
    input.style.display = 'none';
    document.body.appendChild(input);

    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        let budgetImported = false;
        let attachedCount = 0;

        try {
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();

                if (ext === 'moo' || (ext === 'json' && file.name.includes('Budget'))) {
                    if (budgetImported) {
                        alert("Notice: Skipped extra budget file. Please import one project at a time.");
                        continue;
                    }

                    const textContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsText(file);
                    });

                    try {
                        const importedBudget = JSON.parse(textContent);
                        if (!importedBudget.sections || !importedBudget.projectName) throw new Error("Missing required budget data");

                        const existingProjects = getProjectList();
                        let newName = importedBudget.projectName;

                        while (existingProjects.includes(newName)) {
                            const userResponse = prompt(
                                `Project "${newName}" already exists.\n\nEnter a new name to open it as a separate project:`, 
                                `${newName} (Imported)`
                            );
                            if (userResponse === null) throw new Error("Import cancelled by user.");
                            newName = userResponse.trim();
                            if (!newName) throw new Error("Name cannot be empty.");
                        }

                        importedBudget.projectName = newName;
                        if (!importedBudget.attachments) importedBudget.attachments = []; 
                        
                        localStorage.setItem(storageKeyPrefix + newName, JSON.stringify(importedBudget));
                        loadBudget(newName); 
                        budgetImported = true;

                    } catch (parseErr) {
                        alert(`Failed to load project "${file.name}": ${parseErr.message}`);
                    }
                } 
                else {
                    if (!budget) { 
                        alert("Please open a project before attaching files."); 
                        continue; 
                    }
                    if (!budget.attachments) budget.attachments = [];

                    const attachment = {
                        id: generateSafeId(),
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        dateAdded: new Date().toISOString(),
                        content: null
                    };

                    try {
                        if (['txt','csv','rtf','md'].includes(ext)) {
                             const text = await file.text();
                             attachment.content = text.substring(0, 25000); 
                        }
                    } catch (err) { console.warn("Text extraction failed", err); }

                    budget.attachments.push(attachment);
                    attachedCount++;
                }
            }

            if (attachedCount > 0) saveBudget();

            render(); 

            let msg = "";
            if (budgetImported) msg += `âœ… Loaded Project: "${budget.projectName}"\n`;
            if (attachedCount > 0) msg += `ðŸ“Ž ${attachedCount} file(s) added to Production Consultant tray.`;
            
            if(msg) alert(msg.trim());

            if (document.getElementById('aiToolsModal') && !document.getElementById('aiToolsModal').classList.contains('hidden')) {
                showAIToolsModal();
            }

        } catch (globalErr) {
            console.error("Import Error:", globalErr);
        } finally {
            document.body.removeChild(input);
        }
    };

    input.click();
}
/* --- v19.54 Auto-Assign Modal --- */
window.openAutoAssignModal = function() {
    const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || []);

    const content = `
        <div class="p-6 max-w-md mx-auto space-y-6">
            <h3 class="text-xl font-bold text-gray-800 text-center">Auto-Assign Crew</h3>
            <p class="text-sm text-gray-600 text-center">Match budget roles with your contact database</p>
            
            <div class="space-y-4">
                <button id="autoAssignPersonalBtn" class="w-full p-4 bg-teal-50 hover:bg-teal-100 rounded-xl border-2 border-teal-200 transition-all flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M15 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <div class="text-left">
                        <div class="font-bold text-teal-800">Auto-Assign from Personal Contacts</div>
                        <div class="text-xs text-teal-600">${contacts.length} contacts available</div>
                    </div>
                </button>
                
                <button disabled class="w-full p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 opacity-60 cursor-not-allowed flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <div class="text-left">
                        <div class="font-bold text-gray-600">Auto-Assign from AoD Database</div>
                        <div class="text-xs text-gray-500">Coming soon â€“ location & availability matching</div>
                    </div>
                </button>
            </div>
            
            <div class="pt-4 border-t text-center">
                <button onclick="mBTME.close('autoAssignModal')" class="text-sm text-gray-500 hover:text-gray-700 font-bold">Cancel</button>
            </div>
        </div>
    `;

    mBTME.open('autoAssignModal', 'Auto-Assign Crew', content, 'max-w-md', {
        onOpen: () => {
            document.getElementById('autoAssignPersonalBtn')?.addEventListener('click', () => {
                mBTME.close('autoAssignModal');
                const result = mBTAssign.assignFromContacts();
                alert(result.message + (result.skipped > 0 ? `\n${result.skipped} already assigned` : ''));
            });
        }
    });
};

function removeAttachment(id) {
    if(!budget || !budget.attachments) return;
    budget.attachments = budget.attachments.filter(a => a.id !== id);
    saveBudget();
    showAIToolsModal();
}

        function downloadOfflineHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `mooBudgetTool_v${APP_VERSION}.html`;
            a.click();
        }

/* --- v19.53 Project Management UI Consolidated v19.54 --- */
function renderProjectManagement() {
    const container = document.getElementById('project-management-container');
    if (container) {
        const templates = getAllTemplates();
        const templateOptions = Object.keys(templates).map(k => `<option value="${k}">New ${k}</option>`).join('');

        // v19.54: Uses FILM_CURRENCIES from Part 2
        const currencyOptions = (typeof FILM_CURRENCIES !== 'undefined' ? FILM_CURRENCIES : [{ code: 'JMD', label: 'JMD' }])
            .map(c => `<option value="${c.code}" ${displayCurrency === c.code ? 'selected' : ''}>${c.code}</option>`)
            .join('');

        container.innerHTML = `
        <div id="project-management" class="flex flex-wrap items-center justify-between w-full gap-2">

            <div class="flex items-center gap-2 flex-grow max-w-full sm:max-w-lg">
                <div class="relative flex-grow min-w-0">
                    <select id="projectLoader" aria-label="Load Project" class="appearance-none w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 truncate font-semibold shadow-sm">
                        ${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>

                <div class="relative flex-shrink-0">
                    <select id="newProjectSelector" aria-label="File Menu" class="appearance-none w-20 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg cursor-pointer text-center focus:outline-none focus:ring-2 focus:ring-blue-400 shadow-sm transition-colors">
                        <option value="" disabled selected>File</option>
                        ${templateOptions}
                        <option value="" disabled>---</option>
                        <option value="Duplicate">Duplicate</option>
                        <option value="ImportFile">Import</option>
                        <option value="Recover">Recover</option>
                    </select>
                </div>
            </div>

<!-- Crew-Vendor Button -->
                <button onclick="openCrewVendorsHub()"
                        class="p-2.5 bg-blue-400 text-white rounded-lg hover:bg-blue-300 border border-blue-500 shadow-sm transition-colors flex items-center justify-center"
                        title="Crew & Vendors â€“ Manage Assigned, Contacts, Auto-Assign">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M15 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </button>

            <div class="flex items-center gap-1.5 flex-shrink-0">
                
                <select id="currencySelector" class="appearance-none bg-purple-600 text-white text-sm font-bold rounded-lg px-3 py-2.5 hover:bg-purple-700 border border-purple-500 shadow-sm cursor-pointer outline-none transition-colors text-center">
                    ${currencyOptions}
                </select>

                <button id="exportMooBtn" class="p-2.5 bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-300 border border-yellow-500 shadow-sm transition-colors flex items-center justify-center" title="Export Project (.moo)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>

                <button id="deleteProjectBtn" class="p-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm transition-colors flex items-center justify-center" title="Delete Project">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>

                <div class="h-6 w-px bg-gray-300 mx-1 hidden sm:block"></div>

                <div class="flex gap-1">
                    <button id="exportXlsxBtn" class="px-3 py-2.5 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 shadow-sm transition-colors">XLS</button>
                    <button id="exportPdfBtn" class="px-3 py-2.5 bg-gray-600 text-white text-sm font-bold rounded-lg hover:bg-gray-700 shadow-sm transition-colors">PDF</button>
                </div>

                <button id="publishBtn" class="hidden" aria-hidden="true" aria-label="Publish Budget"></button>
            </div>
        </div>`;

        // Re-attach listeners
        document.getElementById('exportMooBtn')?.addEventListener('click', exportToMoo);
        document.getElementById('currencySelector')?.addEventListener('change', (e) => {
            displayCurrency = e.target.value;
            localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
            render();
        });

        document.getElementById('publishBtn')?.addEventListener('click', () => {
            const content = `
                <div class="text-center p-6 space-y-4">
                    <div class="inline-block p-4 bg-blue-50 text-blue-600 rounded-full text-4xl mb-2">â˜ï¸</div>
                    <h3 class="text-xl font-bold text-gray-800">Cloud Integration Coming Soon</h3>
                    <p class="text-gray-600">Save directly to Google Drive, Dropbox, or OneDrive.</p>
                    <button onclick="closeModal('publishPlaceholderModal')" class="mt-4 px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Got it</button>
                </div>
            `;
            createModal('publishPlaceholder', 'Publish to Cloud', content, 'max-w-sm');
        });
    }
}

function initializeInteractiveInputs() { 
    ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
        const el = document.getElementById(id);
        if(el) makeInputDraggable(el);
    });
}

function makeInputDraggable(input) {
    if (!input || input.dataset.draggable === 'true') return;
    input.dataset.draggable = 'true';
    input.style.cursor = 'ew-resize';
    
    let startX, startVal;
    const onMove = (e) => { 
        const delta = e.clientX - startX; 
        input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
        input.dispatchEvent(new Event('input', {bubbles:true})); 
    };
    const onUp = () => { 
        document.removeEventListener('mousemove', onMove); 
        document.removeEventListener('mouseup', onUp); 
    };
    
    input.addEventListener('mousedown', (e) => { 
        if(input === document.activeElement) return; 
        startX = e.clientX; 
        startVal = parseFloat(input.value)||0; 
        document.addEventListener('mousemove', onMove); 
        document.addEventListener('mouseup', onUp); 
    });
}

function updateOnlineStatus() { 
    const isOnline = navigator.onLine;
    const btn = document.getElementById('loginBtn'); 
    if(btn) { 
        btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'status-online' : 'status-offline'}`; 
        btn.title = isOnline ? "Online" : "Offline"; 
    }
    const aiBtn = document.getElementById('openAiToolsBtn');
    if(aiBtn) {
        aiBtn.className = `p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200' : 'bg-red-100 border-red-200 text-red-800 cursor-not-allowed opacity-75'}`;
        if(!isOnline) aiBtn.title = "Offline - AI Unavailable";
    }
}

function handleLogin() { if (navigator.onLine && confirm("Simulate Login?")) alert("Logged in!"); }

// --- v19.36 Template Events & Logic ---
function bindTemplateEvents() {
    document.getElementById('templateSelector')?.addEventListener('change', (e) => {
        editingTemplateId = e.target.value;
        tempTemplateData = null; 
        window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
    });

    document.getElementById('createTemplateBtn')?.addEventListener('click', () => {
        const name = prompt("Enter new template name (e.g., 'Music Video'):");
        if (name) {
            const allTemplates = getAllTemplates();
            if(allTemplates[name]) return alert("Template name already exists.");
            const base = editingTemplateId ? allTemplates[editingTemplateId] : DEFAULT_TEMPLATES['Commercial'];
            allTemplates[name] = JSON.parse(JSON.stringify(base));
            allTemplates[name].projectName = `Untitled ${name} Project`;
            saveAllTemplates(allTemplates);
            editingTemplateId = name;
            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
        }
    });

    document.getElementById('importTemplateBtn')?.addEventListener('click', () => {
        const jsonStr = prompt("Paste template JSON string here:");
        if(jsonStr) {
            try {
                const parsed = JSON.parse(jsonStr);
                if(!parsed.sections) throw new Error("Invalid template format.");
                const name = prompt("Name for this imported template:", "Imported Template");
                if(name) {
                    const allTemplates = getAllTemplates();
                    allTemplates[name] = parsed;
                    saveAllTemplates(allTemplates);
                    editingTemplateId = name;
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            } catch(e) { alert("Import Failed: " + e.message); }
        }
    });

    document.getElementById('exportTemplateBtn')?.addEventListener('click', () => {
        if(!editingTemplateId) return;
        const allTemplates = getAllTemplates();
        const data = JSON.stringify(allTemplates[editingTemplateId]);
        navigator.clipboard.writeText(data).then(() => alert("Template JSON copied to clipboard!")).catch(() => prompt("Copy this:", data));
    });

    document.getElementById('deleteTemplateBtn')?.addEventListener('click', () => {
        if(!editingTemplateId || ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId)) {
            return alert("Cannot delete default templates.");
        }
        if(confirm(`Delete template "${editingTemplateId}"?`)) {
            const allTemplates = getAllTemplates();
            delete allTemplates[editingTemplateId];
            saveAllTemplates(allTemplates);
            editingTemplateId = 'Commercial';
            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
        }
    });

    document.getElementById('saveTemplateChangesBtn')?.addEventListener('click', () => {
        if(isDefaultTemplate(editingTemplateId)) {
            return alert("Cannot edit default templates directly. Please create a copy.");
        }
        if (tempTemplateData && editingTemplateId) {
            const allTemplates = getAllTemplates();
            allTemplates[editingTemplateId] = tempTemplateData;
            saveAllTemplates(allTemplates);
            alert("Template Saved!");
            tempTemplateData = null;
        }
    });

    const editorContainer = document.getElementById('templateEditorContainer');
    if(editorContainer) {
        renderTemplateEditor(editorContainer);

        if(isDefaultTemplate(editingTemplateId)) return; 

        editorContainer.addEventListener('change', (e) => {
            const target = e.target;
            
            if (target.dataset.daysField) {
                 if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                 if(!tempTemplateData.days) tempTemplateData.days = { principal: 10, scouting: 5, preprod: 15 };
                 
                 const field = target.dataset.daysField;
                 tempTemplateData.days[field] = parseFloat(target.value) || 0;
                 recalculateTemplateQuantities(tempTemplateData);
                 renderTemplateEditor(editorContainer);
                 return;
            }

            if (target.dataset.templateField) {
                if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                
                const field = target.dataset.templateField;
                const val = target.value;
                
                if(target.dataset.templateId) { 
                    const section = tempTemplateData.sections[target.dataset.templateSection];
                    const item = section.items.find(i => i.id === target.dataset.templateId);
                    if(item) {
                        if(['quantity', 'rate', 'multiplier'].includes(field)) item[field] = parseFloat(val);
                        else item[field] = val;
                    }
                } else { 
                    if(['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(field)) tempTemplateData[field] = parseFloat(val);
                }
            }
        });

        editorContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));

            if(btn.dataset.templateAddItem) {
                const sectionName = btn.dataset.templateAddItem;
                tempTemplateData.sections[sectionName].items.push({ id: crypto.randomUUID(), ...initialLineItem });
                renderTemplateEditor(editorContainer);
            } else if (btn.dataset.templateRemoveItem) {
                const sectionName = btn.dataset.templateSection;
                const itemId = btn.dataset.templateRemoveItem;
                const idx = tempTemplateData.sections[sectionName].items.findIndex(i => i.id === itemId);
                if(idx > -1) {
                    tempTemplateData.sections[sectionName].items.splice(idx, 1);
                    renderTemplateEditor(editorContainer);
                }
            } else if (btn.dataset.templateRemoveSection) {
                const sectionName = btn.dataset.templateRemoveSection;
                if(confirm("Delete section?")) {
                    delete tempTemplateData.sections[sectionName];
                    renderTemplateEditor(editorContainer);
                }
            } else if (btn.id === 'addTemplateSectionBtn') {
                const name = prompt("New Section Name:");
                if(name && !tempTemplateData.sections[name]) {
                    tempTemplateData.sections[name] = { isOpen: true, items: [] };
                    renderTemplateEditor(editorContainer);
                }
            }
        });
    }
}

function recalculateTemplateQuantities(data) {
    if(!data.days) return;
    const { principal, scouting, preprod } = data.days;
    const totalRun = principal + scouting + preprod;
    const prepScout = scouting + preprod;
    
    const fullRunRegex = /(director|producer|camera|dp|operator|ac|gaffer|grip|mixer|sound|supervisor|manager|coordinator|pa|assistant)/i;
    const prepRegex = /(researcher|location|casting)/i;

    Object.values(data.sections).forEach(section => {
        section.items.forEach(item => {
            if(item.unit !== 'Day') return;
            const desc = item.description.toLowerCase();
            if (fullRunRegex.test(desc)) item.quantity = totalRun;
            else if (prepRegex.test(desc)) item.quantity = prepScout;
        });
    });
}

function isDefaultTemplate(id) {
    return ['Commercial', 'Documentary', 'LiveStream'].includes(id);
}

function renderTemplateEditor(container) {
    if (!container) return; 
    const data = tempTemplateData || getAllTemplates()[editingTemplateId];
    if(!data) return;
    
    if (!data.days) data.days = { principal: 10, scouting: 5, preprod: 15 };

    const isReadOnly = isDefaultTemplate(editingTemplateId);
    const disabledAttr = isReadOnly ? 'disabled' : '';
    const readOnlyBanner = isReadOnly ? `<div class="mb-4 p-2 bg-yellow-50 text-yellow-800 text-xs border border-yellow-200 rounded flex items-center gap-2"><span class="font-bold">âš  Default Template:</span> Read-only mode. Click "Clone / New" to create an editable copy.</div>` : '';

    let html = `
        ${readOnlyBanner}
        <div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded">
            <h3 class="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wide">Production Days Inputs</h3>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs text-indigo-700 mb-1">Principal</label><input type="number" data-days-field="principal" value="${data.days.principal}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                <div><label class="block text-xs text-indigo-700 mb-1">Scouting</label><input type="number" data-days-field="scouting" value="${data.days.scouting}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                <div><label class="block text-xs text-indigo-700 mb-1">Pre-Prod</label><input type="number" data-days-field="preprod" value="${data.days.preprod}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
            </div>
            <p class="text-[10px] text-indigo-400 mt-2 italic">Updating these automatically adjusts quantities for standard roles.</p>
        </div>
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded grid grid-cols-3 gap-4">
            <div><label class="block text-xs font-bold text-gray-700">Contingency %</label><input type="number" step="0.1" value="${data.contingencyPercentage}" ${disabledAttr} data-template-field="contingencyPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
            <div><label class="block text-xs font-bold text-gray-700">Sales Tax %</label><input type="number" step="0.1" value="${data.salesTaxPercentage}" ${disabledAttr} data-template-field="salesTaxPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
            <div><label class="block text-xs font-bold text-gray-700">Discount %</label><input type="number" step="0.1" value="${data.discountPercentage}" ${disabledAttr} data-template-field="discountPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
        </div>`;

    Object.entries(data.sections).forEach(([sectionName, section]) => {
        html += `
        <div class="mb-4 border rounded-lg overflow-hidden">
            <div class="bg-gray-100 p-2 flex justify-between items-center"><h3 class="font-bold text-sm text-gray-700">${sectionName}</h3>${!isReadOnly ? `<button data-template-remove-section="${sectionName}" class="text-red-400 hover:text-red-600">Ã—</button>` : ''}</div>
            <div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50 text-gray-500"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-center w-12">Qty</th><th class="p-2 text-left w-20">Unit</th><th class="p-2 text-right w-24">Rate</th><th class="w-8"></th></tr></thead><tbody>
            ${section.items.map(item => `<tr class="border-t hover:bg-gray-50"><td class="p-1"><input class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" value="${item.description}" ${disabledAttr} data-template-field="description" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><input type="number" class="w-full bg-transparent text-center ${isReadOnly ? 'text-gray-500' : 'font-bold text-blue-600'}" value="${item.quantity}" ${disabledAttr} data-template-field="quantity" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><select class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" ${disabledAttr} data-template-field="unit" data-template-id="${item.id}" data-template-section="${sectionName}"><option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option></select></td><td class="p-1"><input type="number" class="w-full bg-transparent text-right ${isReadOnly ? 'text-gray-500' : ''}" value="${item.rate}" ${disabledAttr} data-template-field="rate" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1 text-center">${!isReadOnly ? `<button data-template-remove-item="${item.id}" data-template-section="${sectionName}" class="text-gray-400 hover:text-red-500">Ã—</button>` : ''}</td></tr>`).join('')}
            </tbody></table></div>${!isReadOnly ? `<button data-template-add-item="${sectionName}" class="w-full p-2 text-center text-xs text-blue-500 hover:bg-blue-50">+ Add Line Item</button>` : ''}
        </div>`;
    });

    if (!isReadOnly) html += `<button id="addTemplateSectionBtn" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 font-medium text-sm">Add New Section</button>`;
    container.innerHTML = html;
}

window.editGlobalItem = function(index) { editingGlobalItemIndex = index; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
window.cancelEditGlobalItem = function() { editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
window.deleteGlobalItem = function(idx) { if (confirm("Remove item?")) { const items = getGlobalItems(); items.splice(idx, 1); mBTOG.rates = items; mBTOG.saveRates(); if(editingGlobalItemIndex === idx) editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); } };

/* --- v19.53 AI Handlers with Persistence --- */
async function handleAnalyzeBudget() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const outputDiv = document.getElementById('aiAnalysisOutput');
    outputDiv.innerHTML = '<div class="text-blue-600 animate-pulse">Analyzing...</div>';
    
    const simplifiedBudget = { project: budget.projectName, totals: calculateTotals(budget.sections), sections: {} };
    for (const [name, sec] of Object.entries(budget.sections)) simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join(', ');
    
    // v19.53: Specific Prompt
    const prompt = `Analyze this budget JSON. 1. Missing roles/equip? 2. Rate anomalies? 3. Risks? Budget Data: ${JSON.stringify(simplifiedBudget)}`;
    
    try { 
        const response = await callUnifiedAI(provider, key, prompt); 
        const html = marked.parse(response);
        outputDiv.innerHTML = html;
        
        // Save if enabled
        if (budget.aiContext && budget.aiContext.saveHistory) {
            budget.aiContext.analysis = html;
            saveBudget();
        }
    } catch (error) { outputDiv.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`; }
}

/* --- v19.53 [AI] - Context-Aware Chat (Budget + Analysis + Files) --- */
async function handleConsultantChat() {
    const provider = getSelectedProvider();
    const key = getStoredApiKey(provider);
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    if (!message) return;

    // 1. UI Update (User Bubble)
    const chatHistory = document.getElementById('aiChatHistory');
    const userBubble = `<div class="ai-message user">${message}</div>`;
    chatHistory.innerHTML += userBubble;

    input.value = '';
    chatHistory.scrollTop = chatHistory.scrollHeight;

    // 2. UI Update (Loading Bubble)
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'ai-message assistant text-gray-400 italic';
    loadingMsg.textContent = `Thinking (${provider})...`;
    chatHistory.appendChild(loadingMsg);

    try {
        // 3. Gather Context Data
        
        // A. Budget Summary (Simplified for token efficiency)
        const simplifiedBudget = { project: budget.projectName, sections: {} };
        for (const [name, sec] of Object.entries(budget.sections)) {
            if(sec.items.length > 0) {
                simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join('; ');
            }
        }
        const budgetContext = `\nCURRENT BUDGET ITEMS:\n${JSON.stringify(simplifiedBudget)}`;

        // B. Previous Analysis (Strip HTML tags for clean text)
        const analysisText = (budget.aiContext && budget.aiContext.analysis) ? 
            budget.aiContext.analysis.replace(/<[^>]*>/g, '') : "None";
        const analysisContext = `\nPREVIOUS AI ANALYSIS:\n${analysisText}`;

        // C. Attached Files (Limit text length per file to prevent API errors)
        let fileContext = "";
        if (budget.attachments && budget.attachments.length > 0) {
            fileContext = "\nATTACHED FILE CONTEXT:\n" + budget.attachments.map(f => 
                `[File: ${f.name}]\n${f.content ? f.content.substring(0, 1500) + (f.content.length > 1500 ? "..." : "") : "(No readable text)"}`
            ).join("\n\n");
        }

        // 4. Construct Final Prompt
        const fullContext = `SYSTEM CONTEXT:${budgetContext}${analysisContext}${fileContext}`;
        const finalPrompt = `${fullContext}\n\nUSER QUESTION: ${message}\n\nINSTRUCTION: Answer the user's question referencing the specific budget items, file content, or analysis above where relevant. Keep answers concise.`;

        // 5. Call AI
        const response = await callUnifiedAI(provider, key, finalPrompt);
        
        // 6. Render Response & Save
        const html = marked.parse(response);
        loadingMsg.innerHTML = html;
        loadingMsg.className = 'ai-message assistant';

        if (budget.aiContext && budget.aiContext.saveHistory) {
            budget.aiContext.chat.push({ role: 'user', content: userBubble });
            budget.aiContext.chat.push({ role: 'assistant', content: loadingMsg.outerHTML });
            saveBudget();
        }

    } catch (error) {
        loadingMsg.textContent = `Error: ${error.message}`;
        loadingMsg.classList.add('text-red-500');
    }
}

/* --- v19.53 [Target Lock] - Modal Logic --- */
function showTargetLockModal() {
    if (!budget.targetLock) {
        budget.targetLock = {
            enabled: false, totalCap: 0,
            stages: {
                'dev': { label: 'Development', ratio: 5, days: 0 },
                'pre': { label: 'Pre-Production', ratio: 20, days: 0 },
                'prod': { label: 'Production', ratio: 55, days: 0 },
                'post': { label: 'Post-Production', ratio: 15, days: 0 },
                'dist': { label: 'Distribution', ratio: 5, days: 0 }
            }
        };
    }
    Object.values(budget.targetLock.stages).forEach(stage => { if (stage.days === undefined) stage.days = 0; });
    
    const tl = budget.targetLock;
    const calcLimit = (ratio) => (tl.totalCap * (ratio / 100));

    const content = `
        <div class="space-y-6">
            <div class="bg-gray-900 text-white p-5 rounded-xl shadow-lg flex flex-col items-center justify-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Total Funding Cap</label>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-bold text-gray-500">$</span>
                    <input type="number" id="tlTotalCap" value="${tl.totalCap}" class="bg-transparent text-4xl sm:text-5xl font-bold text-center w-full max-w-[250px] focus:outline-none focus:border-b-2 border-gray-600 focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">ðŸŽ¯ Stage Ratios</h3>
                <div id="stageSlidersContainer" class="space-y-5">
                    ${Object.entries(tl.stages).map(([key, stage]) => `
                        <div class="relative">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-gray-700">${stage.label}</span>
                                <span class="font-mono text-blue-600" id="disp_amt_${key}">${formatCurrency(calcLimit(stage.ratio))}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="range" min="0" max="100" value="${stage.ratio}" data-stage-key="${key}" class="stage-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                <div class="w-12 text-right"><span class="text-sm font-bold text-gray-800" id="disp_perc_${key}">${stage.ratio.toFixed(0)}%</span></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500 uppercase">Total Allocation</span>
                    <span id="ratioTotalDisplay" class="text-lg font-bold">100%</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('targetLockModal')" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Cancel</button>
                <button id="saveTargetLockBtn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">Engage Target Lock</button>
            </div>
        </div>
    `;

    createModal('targetLock', 'Target Lock Setup', content, 'max-w-md');

    const capInput = document.getElementById('tlTotalCap');
    const sliders = document.querySelectorAll('.stage-slider');
    const totalDisp = document.getElementById('ratioTotalDisplay');

    function updateCalculations() {
        const cap = parseFloat(capInput.value) || 0;
        let currentTotalPerc = 0;
        sliders.forEach(slider => {
            const key = slider.dataset.stageKey;
            const val = parseFloat(slider.value);
            currentTotalPerc += val;
            document.getElementById(`disp_perc_${key}`).textContent = val.toFixed(0) + '%';
            document.getElementById(`disp_amt_${key}`).textContent = formatCurrency(cap * (val / 100));
        });
        totalDisp.textContent = currentTotalPerc.toFixed(0) + '%';
        totalDisp.className = `text-lg font-bold ${Math.round(currentTotalPerc) === 100 ? 'text-green-600' : 'text-red-500'}`;
    }

    capInput.addEventListener('input', updateCalculations);
    sliders.forEach(s => s.addEventListener('input', updateCalculations));

    document.getElementById('saveTargetLockBtn').addEventListener('click', () => {
        budget.targetLock.enabled = true;
        budget.targetLock.totalCap = parseFloat(capInput.value) || 0;
        sliders.forEach(slider => {
            const key = slider.dataset.stageKey;
            budget.targetLock.stages[key].ratio = parseFloat(slider.value);
        });
        pushToHistory('Updated Target Lock');
        closeModal('targetLockModal');
        render(); 
    });
}

/* --- v19.54 [Stages] - Logic V3 (Presets, Sync, Proportional Locks) --- */

// 1. Presets for "Distribute" Button
const STAGE_PRESETS = {
    'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
    'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
    'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
    'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
};


/* ==========================================================================
   mBTME (Moo Budget Tool Modal Engine) v1.0
   Centralized controller for UI Modals, Transitions, and Search binding.
   ========================================================================== */
const mBTME = {
    // Configuration
    containerId: 'global-modal-container',

    /**
     * CORE: Open a new modal
     * @param {string} id - Unique ID for the modal (e.g. 'settings')
     * @param {string} title - Header title
     * @param {string} contentHtml - The inner HTML body
     * @param {string} maxWidth - Tailwind class (default: 'max-w-2xl')
     * @param {object} options - { hideHeader: bool, noPadding: bool, onOpen: func }
     */
    open: function(id, title, contentHtml, maxWidth = 'max-w-2xl', options = {}) {
        const container = document.getElementById(this.containerId);
        if (!container) return console.error("mBTME: Container not found");

        const modalId = `${id}Modal`;
        
        // 1. Cleanup existing if overwriting
        this.close(modalId, true); 

        // 2. Construct HTML
        const headerHtml = options.hideHeader ? '' : `
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-xl font-bold text-gray-800">${title}</h2>
                <button onclick="mBTME.close('${modalId}')" aria-label="Close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>`;

        const fullHtml = `
            <div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden" tabindex="-1">
                <div id="${modalId}Content" class="bg-white rounded-lg shadow-xl w-full ${maxWidth} mx-auto max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95">
                    ${headerHtml}
                    <div class="overflow-y-auto flex-grow ${options.noPadding ? 'p-0' : 'p-4'}" id="${modalId}Body">
                        ${contentHtml}
                    </div>
                </div>
            </div>`;

        // 3. Inject
        container.insertAdjacentHTML('beforeend', fullHtml);
        const modal = document.getElementById(modalId);

        // 4. Animate In
        modal.classList.remove('hidden');
        setTimeout(() => { 
            modal.classList.remove('opacity-0'); 
            document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); 
        }, 10);

        // 5. Bind Closers (Click Outside + Escape Key)
        modal.addEventListener('click', (e) => { if (e.target === modal) this.close(modalId); });
        
        // One-time Escape key listener
        const escListener = (e) => {
            if (e.key === 'Escape') {
                this.close(modalId);
                document.removeEventListener('keydown', escListener);
            }
        };
        document.addEventListener('keydown', escListener);

        // 6. Run Post-Open Callbacks
        if (options.onOpen && typeof options.onOpen === 'function') {
            setTimeout(options.onOpen, 50);
        }

        return modal;
    },

    /**
     * CORE: Close a modal
     */
    close: function(modalId, instant = false) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        // Cleanup global state hooks if specific modals close
        if (modalId === 'settingsModal' && typeof editingGlobalItemIndex !== 'undefined') editingGlobalItemIndex = -1;
        if (modalId === 'settingsModal' && typeof tempTemplateData !== 'undefined') tempTemplateData = null;

        if (instant) {
            modal.remove();
        } else {
            modal.classList.add('opacity-0');
            document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
            setTimeout(() => modal.remove(), 300);
        }
    },

    /**
     * UTILITY: Attach Live Search to a list inside a modal
     * @param {string} inputId - ID of the search input field
     * @param {string} listContainerId - ID of the div/ul containing items
     * @param {Array} dataItems - Array of data objects to filter
     * @param {Function} renderRowFn - Function(item) returning HTML string for one row
     */
    attachSearch: function(inputId, listContainerId, dataItems, renderRowFn) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listContainerId);
        if (!input || !list) return;

        input.focus();
        input.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = dataItems.filter(item => {
                // Default check: looks for 'description', 'name', or 'label'
                const txt = (item.description || item.name || item.label || '').toLowerCase();
                return txt.includes(term);
            });
            list.innerHTML = filtered.length > 0 
                ? filtered.map(renderRowFn).join('') 
                : `<div class="p-4 text-center text-gray-400 text-xs">No matches found.</div>`;
        });
    }
};

/* ==========================================================================
   mBTPublisher (Centralized Document & Export Engine) v19.54
   ========================================================================== */
const mBTPublisher = {
    // --- Configuration ---
    defaultPdfOptions: {
        margin: 0.3,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    },/* --- BUNDLE 1: PUBLISHER LOGIC --- */
    // 1. Industry Standard Fragments
    fragments: {
        header: (meta) => `
            <div style="border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; font-family: Arial, sans-serif;">
                <div style="width: 65%;">
                    <h1 style="margin:0; font-size: 28px; text-transform: uppercase; font-weight: 900;">${meta.productionTitle || 'UNNAMED PROJECT'}</h1>
                    <div style="font-size: 14px; font-weight: bold;">${meta.productionCompany || ''}</div>
                </div>
                <div style="width: 30%; text-align: right; font-size: 12px;">
                    <div><strong>DATE:</strong> ${meta.shootDate || 'TBD'}</div>
                    <div style="background: #000; color: #fff; padding: 4px 8px; display: inline-block; margin-top: 5px; font-size: 14px;"><strong>CREW CALL:</strong> ${meta.crewCallTime || '00:00'}</div>
                </div>
            </div>`,
        table: (title, headers, rows) => `
            <div style="margin-bottom: 15px; font-family: Arial, sans-serif;">
                <div style="background: #333; color: white; padding: 4px 8px; font-size: 11px; font-weight: 900; text-transform: uppercase;">${title}</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; border: 1px solid black;">
                    <thead><tr style="background: #eee; border-bottom: 1px solid black;">${headers.map(h => `<th style="text-align: left; padding: 6px; border-right: 1px solid #ccc;">${h}</th>`).join('')}</tr></thead>
                    <tbody>${rows.map(row => `<tr style="border-bottom: 1px solid #eee;">${Object.values(row).filter(v => typeof v !== 'object').map(val => `<td style="padding: 4px 6px; border-right: 1px solid #eee;">${val || ''}</td>`).join('')}</tr>`).join('')}</tbody>
                </table>
            </div>`,
        note: (title, content) => `
            <div style="border: 2px solid black; margin-bottom: 15px; font-family: Arial, sans-serif;">
                <div style="background: #eee; padding: 4px 8px; font-size: 11px; font-weight: 900; border-bottom: 1px solid black; text-transform: uppercase;">${title}</div>
                <div style="padding: 10px; font-size: 12px; white-space: pre-wrap;">${content || 'N/A'}</div>
            </div>`
    },

    // 2. Generation & Conversion Engine
  async generateFastPreview(mode, data, callback) {
    const docId = mBTDB.state.currentDocId;
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return alert("Document not found for preview.");

    if (mode === 'graphic') {
        const element = document.getElementById('mBTDB_Workspace');
        const canvas = await html2canvas(element, this.defaultPdfOptions.html2canvas);
        callback(canvas.toDataURL('image/jpeg', 0.9));
        return;
    }

    // INDUSTRY STANDARD ASSEMBLY (Full-Length)
    // We sort by 'y' to ensure the preview matches the builder's vertical order
    const sortedWidgets = [...doc.content.widgets].sort((a, b) => a.y - b.y);
    
    let html = `<div id="standard-render-box" style="width: 760px; background: white; color: black; padding: 40px; margin: 0 auto; font-family: Arial, sans-serif; display: block; overflow: visible;">`;
    
    // Always start with Meta Header (Priority 1)
    html += this.fragments.header(data.meta);

    sortedWidgets.forEach(w => {
        const type = w.type;
        const label = w.label || type.toUpperCase();

        if (type === 'header') return; // Handled above

        if (type === 'contacts') {
            const c = data.contacts;
            const cStr = `Director: ${c.director || ''}\nProducer: ${c.producer || ''}\n1st AD: ${c.ad || ''}`;
            html += this.fragments.note(label, cStr);
        } 
        else if (type === 'logistics' || type === 'locations' || type === 'weather') {
            const locStr = (data.locations || []).map(l => `[${l.name.toUpperCase()}]\n${l.address}\nWeather: ${l.weather}`).join('\n\n');
            html += this.fragments.note(label, locStr || "No Location Data");
        } 
        else if (type === 'schedule') {
            const rows = data.schedule || [];
            if(rows.length) html += this.fragments.table(label, ["Time", "Scn", "Description", "Cast", "Loc"], rows);
        } 
        else if (type === 'cast') {
            const rows = data.cast || [];
            if(rows.length) html += this.fragments.table(label, ["Role", "Actor", "Stat", "Pick", "Call"], rows);
        } 
        else if (type === 'crew') {
            const rows = data.crew || [];
            if(rows.length) html += this.fragments.table(label, ["Dept", "Pos", "Name", "Call"], rows);
        } 
        // CATCH-ALL: For Notes, RichText, and anything else containing text
        else {
            const noteContent = data.additional?.[w.id] || data[w.id] || data[type] || "";
            if (noteContent || label) {
                html += this.fragments.note(label, noteContent || "...");
            }
        }
    });

    html += `</div>`;
    this.htmlToJPEG(html, callback);
},

    htmlToJPEG(htmlString, callback) {
    const iframe = document.createElement('iframe');
    iframe.style.visibility = 'hidden'; 
    iframe.style.position = 'absolute'; 
    iframe.style.width = '850px';
    iframe.style.height = '5000px'; // Over-large initial height to prevent cropping
    document.body.appendChild(iframe);
    
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(`<html><body style="margin:0; padding:0;">${htmlString}</body></html>`);
    doc.close();

    // Small delay to let fonts/tables settle
    setTimeout(async () => {
        const target = doc.getElementById('standard-render-box');
        
        // Use html2canvas to capture the EXACT height of the rendered box
        html2canvas(target, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            windowHeight: target.scrollHeight, // Force capture of full content
            height: target.scrollHeight        // Force capture of full content
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            document.body.removeChild(iframe);
            callback(imgData);
        });
    }, 600);
},

    convertToPDFBlob(jpegURL) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        pdf.addImage(jpegURL, 'JPEG', 0, 0, pdfWidth, 0); 
        return pdf.output('blob');
    },

    downloadJPEG(url, filename) {
        this.forceDownload(url, `${filename.replace(/[^a-z0-9]/gi, '_')}.jpg`);
    },

    // --- Core Export Methods ---
    async toPDF(elementOrId, filename = 'Document', options = {}) {
        const element = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
        if (!element) return alert('Export target not found');
        const safeName = filename.replace(/[^a-z0-9]/gi, '_') + '.pdf';
        
        // Hide interactive elements during capture
        const interactive = element.querySelectorAll('button, input, textarea, .no-print');
        const originalStyles = [];
        interactive.forEach(el => {
            originalStyles.push({ el, opacity: el.style.opacity, border: el.style.border });
            el.style.opacity = '0';
            el.style.border = 'none';
        });

        try {
            if (typeof html2pdf === 'undefined') throw new Error("html2pdf library not loaded");
            const opt = { ...this.defaultPdfOptions, filename: safeName, ...options };
            await html2pdf().set(opt).from(element).save();
        } catch (e) {
            console.error("mBTPublisher Error:", e);
            alert("PDF generation failed. " + e.message);
        } finally {
            // Restore UI
            interactive.forEach((item, i) => {
                item.el.style.opacity = originalStyles[i].opacity;
                item.el.style.border = originalStyles[i].border;
            });
        }
    },

// --- 1. Industry Standard Fragments (New) ---
  fragments: {
    header: (meta) => `
        <div style="border-bottom: 2px solid black; padding-bottom: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
            <div style="width: 70%;">
                <h1 style="margin:0; font-size: 22px; text-transform: uppercase; font-weight: 900; letter-spacing: -0.5px;">${meta.productionTitle || 'UNNAMED PROJECT'}</h1>
                <div style="font-size: 11px; font-weight: bold; color: #333; text-transform: uppercase;">${meta.productionCompany || ''}</div>
            </div>
            <div style="width: 28%; text-align: right; font-size: 10px; line-height: 1.2;">
                <div><strong>DATE:</strong> ${meta.shootDate || 'TBD'}</div>
                <div style="background: #000; color: #fff; padding: 3px 6px; display: inline-block; margin-top: 4px; font-size: 12px; font-weight: 900;"><strong>CREW CALL:</strong> ${meta.crewCallTime || '00:00'}</div>
            </div>
        </div>`,

    table: (title, headers, rows) => `
        <div style="margin-bottom: 10px; font-family: Arial, sans-serif;">
            <div style="background: #000; color: white; padding: 2px 6px; font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;">${title}</div>
            <table style="width: 100%; border-collapse: collapse; font-size: 9px; border: 1px solid black;">
                <thead>
                    <tr style="background: #e5e5e5; border-bottom: 1px solid black;">
                        ${headers.map(h => `<th style="text-align: left; padding: 3px 5px; border-right: 1px solid #999; text-transform: uppercase;">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(row => `
                        <tr style="border-bottom: 1px solid #eee;">
                            ${Object.values(row).filter(v => typeof v !== 'object').map(val => `
                                <td style="padding: 2px 5px; border-right: 1px solid #eee; line-height: 1.1;">${val || ''}</td>
                            `).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`,

    note: (title, content) => `
        <div style="border: 1px solid black; margin-bottom: 10px; font-family: Arial, sans-serif; page-break-inside: avoid;">
            <div style="background: #e5e5e5; padding: 2px 6px; font-size: 9px; font-weight: 900; border-bottom: 1px solid black; text-transform: uppercase;">${title}</div>
            <div style="padding: 6px; font-size: 10px; white-space: pre-wrap; line-height: 1.3;">${content || '...'}</div>
        </div>`
},

    async exportToPDF(elementOrId, filename, mode) { return this.toPDF(elementOrId, filename); },

    toXLSX(data, sheetName = 'Sheet1', filename = 'Budget') {
        if (typeof XLSX === 'undefined') return alert("Excel library not loaded.");
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `${filename.replace(/[^a-z0-9]/gi, '_')}.xlsx`);
    },

    toMoo() {
        if (!budget) return alert('No active budget');
        const dataStr = JSON.stringify(budget, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        this.forceDownload(blob, `${(budget.projectName || 'untitled').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.moo`);
    },

// --- 2. Call Sheet Specific Generation (New) ---
    async generateFastPreview(mode, data, callback) {
        if (mode === 'graphic') {
            // Use your existing html2canvas logic to snapshot the editor
            const element = document.getElementById('mBTDB_Workspace');
            const canvas = await html2canvas(element, this.defaultPdfOptions.html2canvas);
            callback(canvas.toDataURL('image/jpeg', 0.9));
            return;
        }

        // Standard Industry Assembly
        let html = `<div id="standard-render-box" style="width: 760px; background: white; color: black; padding: 40px; margin: 0 auto;">`;
        html += this.fragments.header(data.meta);
        if (data.locations?.length) html += this.fragments.note("LOCATIONS & WEATHER", data.locations.map(l => `${l.name.toUpperCase()}: ${l.address}\nWeather: ${l.weather}`).join('\n\n'));
        if (data.schedule?.length) html += this.fragments.table("SHOOTING SCHEDULE", ["Time", "Scn", "Description", "Cast", "Loc"], data.schedule);
        if (data.cast?.length) html += this.fragments.table("CAST & TALENT", ["Role", "Actor", "Status", "Pickup", "Call"], data.cast);
        html += `</div>`;

        this.htmlToJPEG(html, callback);
    },

    // --- Template Engine (The "What") ---
    
    // 1. Render Editor HTML (Inputs)
    renderEditor(doc) {
        if (!doc || !doc.content || !doc.content.data) return '<div class="p-8 text-center">Invalid Data</div>';
        const tpl = doc.content;
        const data = doc.content.data;
        const docId = doc.id;

        const renderInput = (section, key, fieldSpec) => {
            const val = RenderEngine.esc(data[section]?.[key] || fieldSpec.default || '');
            const label = fieldSpec.label;
            const commonClasses = "w-full p-2 border rounded text-sm bg-gray-50 focus:bg-white border-gray-300 transition-colors focus:ring-2 focus:ring-blue-100 outline-none";
            
            if (fieldSpec.type === 'textarea') {
                return `<div class="mb-3"><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">${label}</label><textarea class="${commonClasses}" rows="3" onchange="updateMtempField('${docId}', '${section}', '${key}', this.value)">${val}</textarea></div>`;
            } 
            return `<div class="mb-3"><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">${label}</label><input type="${fieldSpec.type}" value="${val}" class="${commonClasses}" onchange="updateMtempField('${docId}', '${section}', '${key}', this.value)"></div>`;
        };

        const renderTable = (key, tableSpec) => {
            const rows = data.tables?.[key] || tableSpec.rows || [];
            let html = `<div class="mb-6 overflow-hidden border rounded-lg"><div class="bg-gray-100 p-2 border-b flex justify-between items-center"><h4 class="font-bold text-xs text-gray-700 uppercase">${tableSpec.label}</h4></div><div class="overflow-x-auto"><table class="w-full text-xs border-collapse"><thead><tr class="bg-gray-50">`;
            tableSpec.columns.forEach(c => html += `<th class="p-2 border-b border-gray-200 text-left text-gray-500 font-semibold">${c}</th>`);
            html += `<th class="w-8 border-b border-gray-200"></th></tr></thead><tbody>`;
            
            rows.forEach((row, rIdx) => {
                html += `<tr class="group hover:bg-gray-50">`;
                row.forEach((cell, cIdx) => {
                    html += `<td class="p-0 border-b border-gray-100"><input value="${RenderEngine.esc(cell)}" class="w-full p-2 bg-transparent border-none focus:ring-inset focus:ring-1 focus:ring-blue-500 outline-none" onchange="updateMtempTable('${docId}', '${key}', ${rIdx}, ${cIdx}, this.value)"></td>`;
                });
                html += `<td class="text-center border-b border-gray-100"><button class="text-gray-300 hover:text-red-500 font-bold px-2" onclick="removeMtempRow('${docId}', '${key}', ${rIdx})">Ã—</button></td></tr>`;
            });
            html += `</tbody></table></div><div class="p-2 bg-gray-50 border-t"><button onclick="addMtempRow('${docId}', '${key}')" class="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1"><span>+</span> Add Row</button></div></div>`;
            return html;
        };

        let html = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6"><div>`; // Left Col
        if (tpl.fields) {
            Object.keys(tpl.fields).forEach(secKey => {
                if (secKey === 'tables') return;
                html += `<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6"><h3 class="font-bold text-gray-800 border-b pb-2 mb-3 uppercase text-xs tracking-wider flex items-center gap-2"><span class="w-2 h-2 bg-blue-500 rounded-full"></span> ${secKey.replace('_', ' ')}</h3>`;
                Object.keys(tpl.fields[secKey]).forEach(fKey => html += renderInput(secKey, fKey, tpl.fields[secKey][fKey]));
                html += `</div>`;
            });
        }
        html += `</div><div>`; // Right Col
        if (tpl.fields && tpl.fields.tables) {
            Object.keys(tpl.fields.tables).forEach(tKey => html += renderTable(tKey, tpl.fields.tables[tKey]));
        }
        html += `</div></div>`;
        return html;
    },

    // 2. Interpret Template for Output (HTML Generation)
    interpret(doc) {
        const tpl = doc.content;
        const data = doc.content.data || {};
        let html = `<style>${tpl.printCss || ''}</style><div id="render-target">${tpl.htmlTemplate || ''}</div>`;
        
        const regex = /{{([^}]+)}}/g;
        return html.replace(regex, (match, p1) => {
            const parts = p1.split('.');
            if (parts[0] === 'table') {
                const key = parts[1];
                const spec = tpl.fields.tables[key];
                const rows = data.tables?.[key] || spec.rows || [];
                let tblHtml = `<table><thead><tr>${spec.columns.map(c=>`<th>${RenderEngine.esc(c)}</th>`).join('')}</tr></thead><tbody>`;
                rows.forEach(r => { tblHtml += `<tr>${r.map(c=>`<td>${RenderEngine.esc(c)}</td>`).join('')}</tr>`; });
                tblHtml += `</tbody></table>`;
                return tblHtml;
            } else {
                return RenderEngine.esc(data[parts[0]]?.[parts[1]] || '');
            }
        });
    },

    // 3. Logic: Autofill Data
    processAutofill(doc, budgetData) {
        const fields = doc.content.fields;
        const data = doc.content.data;
        if (!data.tables) data.tables = {};

        // A. Fields
        Object.keys(fields).forEach(secKey => {
            if (secKey === 'tables') return;
            Object.keys(fields[secKey]).forEach(fieldKey => {
                const spec = fields[secKey][fieldKey];
                if (!data[secKey]) data[secKey] = {};

                if (spec.autofill === 'projectName') data[secKey][fieldKey] = budgetData.projectName || '';
                else if (spec.autofill?.startsWith('role:')) {
                    const target = spec.autofill.split(':')[1].toLowerCase();
                    for (const section of Object.values(budgetData.sections)) {
                        const match = section.items.find(i => i.description.toLowerCase().includes(target) && i.crew?.name);
                        if (match) {
                            data[secKey][fieldKey] = `${match.crew.name} ${match.crew.phone ? '| '+match.crew.phone : ''}`.trim();
                            break;
                        }
                    }
                }
            });
        });

        // B. Tables
        if (fields.tables?.crew?.autofillSource === 'budget_sections') {
            const rows = [];
            Object.entries(budgetData.sections).forEach(([sec, sObj]) => {
                sObj.items.forEach(i => { if (i.crew?.name) rows.push([sec, i.description, i.crew.name, "07:00", i.crew.phone || '-']); });
            });
            data.tables.crew = rows;
        }
        
        return doc;
    },

    // --- File Generation & Share ---
    async toFileFromHTML(containerHtml, filenameBase, formats = ['pdf'], docSource = null) {
        // Create invisible container
        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.width = '800px'; 
        
        let finalHtml = containerHtml;
        if (docSource && docSource.content && docSource.content.isDynamic) {
            finalHtml = this.interpret(docSource);
        }

        container.innerHTML = finalHtml;
        document.body.appendChild(container);
        const element = container.querySelector('#render-target') || container.firstElementChild;
        const files = [];

        try {
            if (formats.includes('pdf')) {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = (canvas.height * pdfW) / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                files.push(new File([pdf.output('blob')], `${filenameBase}.pdf`, { type: 'application/pdf' }));
            }
            if (formats.includes('jpg')) {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                files.push(new File([blob], `${filenameBase}.jpg`, { type: 'image/jpeg' }));
            }
        } catch(e) {
            console.error("Generation error:", e);
        } finally {
            document.body.removeChild(container);
        }
        return files.length === 1 ? files[0] : files;
    },

    async share(files, title = 'Document') {
        if (!Array.isArray(files)) files = [files];
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
        const canShare = isSecure && navigator.share && navigator.canShare && navigator.canShare({ files });
        if (canShare) {
            try { await navigator.share({ title, text: title, files }); return true; } 
            catch (err) { console.warn('Share skipped'); }
        }
        files.forEach((file, i) => setTimeout(() => this.forceDownload(file, file.name), i * 500));
        return false;
    },

    forceDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
    },
    
    // Direct link helpers
    shareWhatsApp(phone, text) { window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${encodeURIComponent(text)}`, '_blank'); },
    shareEmail(email, subject, body) { window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; }
};

/* --- v19.54 Crew & Vendors Hub --- */
window.openCrewVendorsHub = function() {
    // Extract assigned crew from budget
        const assignedCrew = [];
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                assignedCrew.push({
                    name: item.crew.name,
                    role: item.description,
                    section: sectionName,
                    phone: item.crew.phone || '',
                    email: item.crew.email || ''
                });
            }
        });
    });

    // Personal contacts from Open Gate
    const personalContacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || []);

    const content = `
        <div class="flex flex-col h-[80vh] max-h-[600px]">
            <!-- Tabs -->
            <div class="flex border-b bg-gray-50">
                <button id="tabAssigned" class="flex-1 px-4 py-3 text-sm font-bold text-gray-700 border-b-2 border-blue-500">Assigned in Budget (${assignedCrew.length})</button>
                <button id="tabPersonal" class="flex-1 px-4 py-3 text-sm font-bold text-gray-600 hover:text-gray-800">Personal Contacts (${personalContacts.length})</button>
                <button id="tabAutoAssign" class="flex-1 px-4 py-3 text-sm font-bold text-gray-600 hover:text-gray-800">Auto-Assign</button>
            </div>
            
            <!-- Tab Content -->
            <div class="flex-grow overflow-hidden">
                <!-- Assigned in Budget Tab -->
                <div id="contentAssigned" class="h-full flex flex-col">
                    <input type="text" id="searchAssigned" placeholder="Search assigned crew..." class="m-4 p-3 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="assignedList" class="flex-grow overflow-y-auto px-4 pb-4">
                        ${assignedCrew.length > 0 ? assignedCrew.map(c => `
                            <div class="flex items-center justify-between p-3 bg-white border rounded-lg mb-2">
                                <div>
                                    <div class="font-bold text-gray-800">${c.name}</div>
                                    <div class="text-xs text-gray-500">${c.role} â€¢ ${c.section}</div>
                                </div>
                                <div class="flex gap-2">
                                    ${c.phone ? `<a href="tel:${c.phone}" class="text-green-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></a>` : ''}
                                    ${c.email ? `<a href="mailto:${c.email}" class="text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>` : ''}
                                </div>
                            </div>
                        `).join('') : '<div class="p-8 text-center text-gray-400">No crew assigned yet</div>'}
                    </div>
                </div>
                
                <!-- Personal Contacts Tab -->
                <div id="contentPersonal" class="h-full hidden flex flex-col">
                    <input type="text" id="searchPersonal" placeholder="Search personal contacts..." class="m-4 p-3 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="personalList" class="flex-grow overflow-y-auto px-4 pb-4">
                        ${personalContacts.length > 0 ? personalContacts.map(c => `
                            <div class="flex items-center justify-between p-3 bg-white border rounded-lg mb-2">
                                <div>
                                    <div class="font-bold text-gray-800">${c.name || 'Unnamed'}</div>
                                    <div class="text-xs text-gray-500">${c.role || ''} â€¢ ${c.contact || 'No contact'}</div>
                                </div>
                                <button onclick="window.switchSettingsTab('contacts')" class="text-blue-600 hover:underline text-xs">Edit â†’</button>
                            </div>
                        `).join('') : '<div class="p-8 text-center text-gray-400">No personal contacts. Add in Settings â†’ Contacts</div>'}
                    </div>
                </div>
                
                <!-- Auto-Assign Tab -->
                <div id="contentAutoAssign" class="h-full hidden p-6">
                    <div class="space-y-4">
                        <button id="autoAssignPersonalBtn" class="w-full p-4 bg-teal-50 hover:bg-teal-100 rounded-xl border-2 border-teal-200 transition-all flex items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M15 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <div class="text-left">
                                <div class="font-bold text-teal-800">Auto-Assign from Personal Contacts</div>
                                <div class="text-xs text-teal-600">${personalContacts.length} contacts available</div>
                            </div>
                        </button>
                        
                        <button disabled class="w-full p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 opacity-60 cursor-not-allowed flex items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <div class="text-left">
                                <div class="font-bold text-gray-600">Auto-Assign from AoD Database</div>
                                <div class="text-xs text-gray-500">Coming soon â€“ location & availability matching</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    mBTME.open('crewVendorsHub', 'Crew & Vendors', content, 'max-w-2xl', {
        onOpen: () => {
            // Tab switching
            const tabs = {
                assigned: document.getElementById('tabAssigned'),
                personal: document.getElementById('tabPersonal'),
                autoAssign: document.getElementById('tabAutoAssign')
            };
            const contents = {
                assigned: document.getElementById('contentAssigned'),
                personal: document.getElementById('contentPersonal'),
                autoAssign: document.getElementById('contentAutoAssign')
            };
            const showTab = (tab) => {
                Object.values(tabs).forEach(t => t.classList.remove('border-blue-500', 'text-blue-600'));
                Object.values(contents).forEach(c => c.classList.add('hidden'));
                tabs[tab].classList.add('border-blue-500', 'text-blue-600');
                contents[tab].classList.remove('hidden');
            };
            tabs.assigned.onclick = () => showTab('assigned');
            tabs.personal.onclick = () => showTab('personal');
            tabs.autoAssign.onclick = () => showTab('autoAssign');

            // Search assigned
            document.getElementById('searchAssigned').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#assignedList > div').forEach(div => {
                    const text = div.textContent.toLowerCase();
                    div.style.display = text.includes(term) ? '' : 'none';
                });
            });

            // Auto-Assign button
            document.getElementById('autoAssignPersonalBtn')?.addEventListener('click', () => {
                mBTME.close('crewVendorsHub');
                const result = mBTAssign.assignFromContacts();
                alert(result.message + (result.skipped > 0 ? `\n${result.skipped} already assigned` : ''));
            });
        }
    });
};

/* --- v19.54 [Documents] - Hub & UI Logic (Views) --- */

function handleDocRestore(index) {
    const trash = budget.documentTrash || [];
    if (index < 0 || index >= trash.length) return;
    const doc = trash.splice(index, 1)[0];
    delete doc.deletedTimestamp;
    budget.documents.push(doc);
    saveBudget();
    mBTME.close('binModal');
    showDocumentsModal();
}

function handleDocPermanentDelete(index) {
    if (!confirm('Permanently delete this document? This cannot be undone.')) return;
    const trash = budget.documentTrash || [];
    if (index < 0 || index >= trash.length) return;
    trash.splice(index, 1);
    saveBudget();
    mBTME.close('binModal');
    showBinModal(); // Refresh bin view
}

function handleEmptyBin() {
    if (!confirm('Empty entire bin? All documents will be permanently deleted.')) return;
    budget.documentTrash = [];
    saveBudget();
    mBTME.close('binModal');
    alert('Bin emptied');
}

window.docHubState = { mode: 'normal', selected: new Set(), activeTab: 'All', searchTerm: '' };

function showDocumentsModal(tab = null) {
    ensureDocumentData();
    if (tab) window.docHubState.activeTab = tab;
    const { activeTab, mode, selected } = window.docHubState;
    const visibleDocs = activeTab === 'All' ? budget.documents : budget.documents.filter(d => d.cat === activeTab);

    // Header Actions
    let headerButtons = mode === 'select' ? `
        <button onclick="setDocMode('normal')" class="px-3 py-1.5 text-xs font-bold text-gray-600 hover:bg-gray-100 rounded transition-colors">Cancel</button>
        <button onclick="handleBulkTrash()" class="bg-red-600 text-white px-4 py-1.5 rounded text-xs font-bold shadow-sm flex items-center gap-1" ${selected.size === 0 ? 'disabled opacity-50' : ''}>Delete (${selected.size})</button>
    ` : `
        <button onclick="setDocMode('select')" class="px-3 py-1.5 text-xs font-bold text-gray-500 hover:text-red-500 rounded transition-colors">Select</button>
        <button onclick="showAddDocumentModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center gap-1"><span>+</span> Add</button>
    `;

    // Tabs
    const tabs = ['All', 'Pre-Prod', 'Production', 'Post-Prod', 'Legal'].map(t => 
        `<button onclick="showDocumentsModal('${t}')" class="px-3 py-1.5 text-[10px] sm:text-xs font-bold uppercase tracking-wider rounded-lg transition-colors border flex-shrink-0 ${activeTab === t ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-100'}">${t}</button>`
    ).join('');

    const content = `
        <div class="flex flex-col h-[75vh] sm:h-[600px] w-full bg-gray-50 overflow-hidden">
            <div class="p-4 bg-white border-b flex flex-col gap-3 shadow-sm z-10 flex-shrink-0">
                <div class="flex justify-between items-center gap-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span>ðŸ“‚</span> Documents</h2>
                        <button onclick="event.stopPropagation(); showBinModal()" class="relative p-1.5 text-gray-400 hover:text-red-500 transition-colors flex-shrink-0" title="Recycle Bin">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
    </svg>
    ${((budget.documentTrash || []).length > 0) ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>' : ''}
</button>
                    </div>
                    <div class="flex items-center gap-2">${headerButtons}</div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar">${tabs}</div>
                ${mode === 'normal' ? `<input type="text" id="hubSearchInput" value="${window.docHubState.searchTerm}" placeholder="Search documents..." class="w-full p-2 text-xs bg-gray-100 border rounded-lg focus:bg-white outline-none transition-all" autocomplete="off">` : ''}
            </div>
            <div class="p-4 overflow-y-auto flex-grow bg-gray-50">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                    ${visibleDocs.length > 0 ? visibleDocs.map(doc => RenderEngine.docCard(doc)).join('') : '<div class="col-span-full text-center py-12 text-xs text-gray-400 italic">No documents found.</div>'}
                </div>
            </div>
        </div>`;

    createModal('documentsHub', '', content, 'max-w-4xl w-full', { noPadding: true, hideHeader: true });
    
    // Search Bind
    const search = document.getElementById('hubSearchInput');
    if(search) search.addEventListener('input', (e) => {
        window.docHubState.searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.doc-card').forEach(card => card.classList.toggle('hidden', !card.dataset.label.includes(window.docHubState.searchTerm)));
    });

/* --- v19.54 Document Share Selector --- */
window.openDocumentShareSelector = function(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // Assigned crew from budget
    const assignedCrew = [];
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                assignedCrew.push({
                    name: item.crew.name,
                    role: item.description,
                    phone: item.crew.phone || '',
                    email: item.crew.email || '',
                    source: 'budget'
                });
            }
        });
    });

    // Personal contacts
    const personalContacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || []);

    // WhatsApp helper â€“ normalize & device-aware
    function getWhatsAppLink(phone) {
        if (!phone) return '';
        let clean = phone.replace(/\D/g, '');
        // Normalize Jamaican 876 â†’ +1
        if (clean.length === 10 && clean.startsWith('876')) clean = '1' + clean;
        if (clean.length < 10) return '';
        const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const base = isMobile ? 'https://wa.me/' : 'https://web.whatsapp.com/send?phone=';
        return `${base}${clean}`;
    }

    let selectedContacts = new Set();
    let selectedFormats = ['pdf']; // Default PDF

    const content = `
        <div class="flex flex-col h-[80vh] max-h-[600px]">
            <!-- Top Bar: Multi-select + Formats -->
            <div class="p-4 bg-gray-50 border-b flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="multiSelectToggle" class="w-5 h-5 rounded">
                        <span class="text-sm font-bold text-gray-700">Multi-Select</span>
                    </label>
                    <span id="selectedCount" class="text-sm text-gray-600 hidden">0 selected</span>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" value="pdf" checked class="formatCheckbox w-4 h-4 rounded">
                        <span class="text-sm">PDF</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" value="jpg" class="formatCheckbox w-4 h-4 rounded">
                        <span class="text-sm">JPG</span>
                    </label>
                    <button id="batchShareBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold hidden">Share Selected</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b bg-white">
                <button id="tabBudget" class="flex-1 px-4 py-3 text-sm font-bold text-gray-700 border-b-2 border-blue-500">From Budget (${assignedCrew.length})</button>
                <button id="tabPersonal" class="flex-1 px-4 py-3 text-sm font-bold text-gray-600 hover:text-gray-800">Personal (${personalContacts.length})</button>
                <button id="tabAoD" class="flex-1 px-4 py-3 text-sm font-bold text-gray-600 hover:text-gray-800 opacity-60">AoD</button>
            </div>
            
            <!-- Content -->
            <div class="flex-grow overflow-hidden flex flex-col">
                <!-- Budget Tab -->
                <div id="contentBudget" class="h-full flex flex-col">
                    <input type="text" id="searchBudget" placeholder="Search assigned crew..." class="m-4 p-3 border rounded-lg text-sm">
                    <div id="budgetList" class="flex-grow overflow-y-auto px-4 pb-4">
                        ${assignedCrew.map((c, i) => `
                            <div class="contactRow flex items-center justify-between p-3 bg-white border rounded-lg mb-2" data-index="${i}" data-source="budget">
                                <label class="flex items-center gap-3 flex-grow cursor-pointer">
                                    <input type="checkbox" class="contactCheckbox hidden w-5 h-5 rounded">
                                    <div>
                                        <div class="font-bold text-gray-800">${RenderEngine.esc(c.name)}</div>
                                        <div class="text-xs text-gray-500">${RenderEngine.esc(c.role)}</div>
                                    </div>
                                </label>
                                <div class="flex gap-2 opacity-100 directActions">
                                    ${c.phone ? `<a href="${getWhatsAppLink(c.phone)}" target="_blank" rel="noopener" class="text-green-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>` : ''}
                                    ${c.email ? `<a href="mailto:${RenderEngine.esc(c.email)}" class="text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Personal Tab -->
                <div id="contentPersonal" class="h-full hidden flex flex-col">
                    <div class="flex items-center justify-between m-4">
                        <input type="text" id="searchPersonal" placeholder="Search personal contacts..." class="flex-grow p-3 border rounded-lg text-sm">
                        <button onclick="addNewContactToPersonal('${docId}')" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold">+</button>
                    </div>
                    <div id="personalList" class="flex-grow overflow-y-auto px-4 pb-4">
                        ${personalContacts.map((c, i) => `
                            <div class="contactRow flex items-center justify-between p-3 bg-white border rounded-lg mb-2" data-index="${i}" data-source="personal">
                                <label class="flex items-center gap-3 flex-grow cursor-pointer">
                                    <input type="checkbox" class="contactCheckbox hidden w-5 h-5 rounded">
                                    <div>
                                        <div class="font-bold text-gray-800">${RenderEngine.esc(c.name || 'Unnamed')}</div>
                                        <div class="text-xs text-gray-500">${RenderEngine.esc(c.role || '')} â€¢ ${RenderEngine.esc(c.contact || 'No contact')}</div>
                                    </div>
                                </label>
                                <div class="flex gap-2 opacity-100 directActions">
                                    ${c.contact && !c.contact.includes('@') ? `<a href="${getWhatsAppLink(c.contact)}" target="_blank" rel="noopener" class="text-green-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>` : ''}
                                    ${c.contact && c.contact.includes('@') ? `<a href="mailto:${RenderEngine.esc(c.contact)}" class="text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- AoD Placeholder -->
                <div id="contentAoD" class="h-full hidden p-8 text-center text-gray-400">
                    <div class="text-4xl mb-4">ðŸŒ</div>
                    <p>AoD Database coming soon</p>
                </div>
            </div>
        </div>
    `;
 mBTME.open('docShareContacts', `Send ${doc.label}`, content, 'max-w-md', {
        onOpen: () => {
            const multiToggle = document.getElementById('multiSelectToggle');
            const checkboxes = document.querySelectorAll('.contactCheckbox');
            const directActions = document.querySelectorAll('.directActions');
            const selectedCount = document.getElementById('selectedCount');
            const batchBtn = document.getElementById('batchShareBtn');
            const formatCheckboxes = document.querySelectorAll('.formatCheckbox');

            // Multi-select mode
            multiToggle.addEventListener('change', () => {
                const enabled = multiToggle.checked;
                checkboxes.forEach(cb => cb.classList.toggle('hidden', !enabled));
                directActions.forEach(da => da.classList.toggle('opacity-100', !enabled));
                selectedCount.classList.toggle('hidden', !enabled);
                batchBtn.classList.toggle('hidden', !enabled);
                if (!enabled) selectedContacts.clear();
                updateSelectedCount();
            });

            // Checkbox handling
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const row = cb.closest('.contactRow');
                    const source = row.dataset.source;
                    const index = parseInt(row.dataset.index);
                    const key = `${source}-${index}`;
                    if (cb.checked) selectedContacts.add(key);
                    else selectedContacts.delete(key);
                    updateSelectedCount();
                });
            });

            // Format selection
            formatCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    selectedFormats = Array.from(formatCheckboxes)
                        .filter(c => c.checked)
                        .map(c => c.value);
                    if (selectedFormats.length === 0) selectedFormats = ['pdf'];
                });
            });

            function updateSelectedCount() {
                selectedCount.textContent = `${selectedContacts.size} selected`;
            }

            // Batch share
            batchBtn.addEventListener('click', () => batchShare(docId));

            // Direct share (single contact)
            directActions.forEach(actions => {
                actions.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        if (multiToggle.checked) return;
                        const row = link.closest('.contactRow');
                        const source = row.dataset.source;
                        const index = parseInt(row.dataset.index);
                        shareDocumentToContact(docId, source, index);
                    });
                });
            });

            // Tab switching
            const tabs = { budget: 'contentBudget', personal: 'contentPersonal', aod: 'contentAoD' };
            Object.keys(tabs).forEach(tab => {
                document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).onclick = () => {
                    Object.values(tabs).forEach(id => document.getElementById(id).classList.add('hidden'));
                    document.getElementById(tabs[tab]).classList.remove('hidden');
                };
            });

            // Search
            document.getElementById('searchBudget').addEventListener('input', e => filterList('budgetList', e.target.value));
            document.getElementById('searchPersonal').addEventListener('input', e => filterList('personalList', e.target.value));
        }
    });

    async function batchShare(docId) {
        if (selectedContacts.size === 0) return alert('No contacts selected');
        const formats = selectedFormats.length > 1 ? selectedFormats : selectedFormats[0];

        const files = await mBTPublisher.toFileFromHTML('', `${budget.projectName || 'Document'}_${doc.label}`, formats, doc);

        const recipients = [];
        selectedContacts.forEach(key => {
            const [source, idx] = key.split('-');
            const list = source === 'budget' ? assignedCrew : personalContacts;
            const contact = list[parseInt(idx)];
            if (contact) recipients.push(contact.name || 'Contact');
        });

        const shared = await mBTPublisher.share(Array.isArray(files) ? files : [files], `${budget.projectName} - ${doc.label}`);
        alert(shared ? `Sent to ${recipients.length} contacts!` : `Files downloaded for ${recipients.length} contacts`);
        mBTME.close('docShareContacts');
        showDocumentsModal();
    }
};

function filterList(listId, term) {
    term = term.toLowerCase();
    document.querySelectorAll(`#${listId} > .contactRow`).forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}

function addNewContactToPersonal(docId) {
    const name = prompt('Contact Name:');
    if (!name) return;
    const role = prompt('Role (optional):') || '';
    const contact = prompt('Phone or Email:') || '';

    const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || []);
    contacts.push({ name, role, contact });
    if (typeof saveGlobalContacts === 'function') saveGlobalContacts(contacts);
    else if (mBTOG) { mBTOG.contacts = contacts; mBTOG.saveContacts?.(); }

    mBTME.close('docShareContacts');
    openDocumentShareSelector(docId);
}

window.shareDocumentToContact = async function(docId, source, index) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    let contact;
    if (source === 'budget') {
        let i = 0;
        for (const [sectionName, section] of Object.entries(budget.sections)) {
            for (const item of section.items) {
                if (item.crew && item.crew.name && i === index) {
                    contact = { name: item.crew.name, contact: item.crew.phone || item.crew.email || '' };
                    break;
                }
                if (item.crew && item.crew.name) i++;
            }
            if (contact) break;
        }
    } else if (source === 'personal') {
        const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || []);
        contact = contacts[index];
    }

    if (!contact || !contact.name) return;

    mBTME.close('docShareContacts');

    const fileNameBase = `${budget.projectName || 'Document'}_${doc.label}`;
    
    try {
        const files = await mBTPublisher.toFileFromHTML('', fileNameBase, ['pdf', 'jpg'], doc);
        
        if (!doc.exportHistory) doc.exportHistory = [];
        doc.exportHistory.push({
            timestamp: new Date().toISOString(),
            format: 'PDF + JPG',
            method: 'Contact Share',
            recipient: contact.name
        });
        doc.lastExport = new Date().toISOString();
        doc.status = 'Exported';
        saveBudget();

        const shared = await mBTPublisher.share(files, `${budget.projectName} - ${doc.label}`);
        
        if (shared) {
            alert(`Sent to ${contact.name}!`);
        } else {
            alert(`Files downloaded â€” send manually to ${contact.name}`);
        }
        
        showDocumentsModal();
    } catch (err) {
        console.error("Share failed:", err);
        alert("Export failed â€” check console");
    }
};

/* --- v19.54 mBTAssign Engine --- */
const mBTAssign = {
    // Core reusable auto-assign from personal contacts
    assignFromContacts(constraints = {}) {
        const defaults = {
            source: 'personal',          // 'personal' or 'aod' (future)
            skipAssigned: true,          // Skip items already with crew
            matchStrength: 'contains'    // 'exact' or 'contains'
        };
        const opts = { ...defaults, ...constraints };

        const contacts = opts.source === 'personal' 
            ? (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG && mBTOG.contacts) || [])
            : []; // AoD placeholder

        if (contacts.length === 0) {
            return { assigned: 0, skipped: 0, message: 'No contacts available' };
        }

        let assigned = 0;
        let skipped = 0;

        Object.values(budget.sections).forEach(section => {
            section.items.forEach(item => {
                if (opts.skipAssigned && item.crew && item.crew.name) {
                    skipped++;
                    return;
                }

                const roleLower = item.description.toLowerCase();
                const match = contacts.find(c => {
                    if (!c.role) return false;
                    const contactRoleLower = c.role.toLowerCase();
                    return opts.matchStrength === 'exact' 
                        ? roleLower === contactRoleLower 
                        : roleLower.includes(contactRoleLower);
                });

                if (match) {
                    item.crew = {
                        name: match.name,
                        phone: match.contact && !match.contact.includes('@') ? match.contact : '',
                        email: match.contact && match.contact.includes('@') ? match.contact : ''
                    };
                    assigned++;
                }
            });
        });

        if (assigned > 0) {
            saveBudget();
            render();
        }

        return { 
            assigned, 
            skipped, 
            total: assigned + skipped,
            message: assigned > 0 ? `${assigned} crew assigned` : 'No matches found'
        };
    },

    // Future AoD integration placeholder
    assignFromAoD(filters = {}) {
        alert('AoD auto-assign coming soon â€“ location & availability matching');
        return { assigned: 0, skipped: 0 };
    }

};

}

/* --- P4 --- */
/* ==========================================================================
   mBTDB v9.0 - Stability & Standard Print
   ========================================================================== */
window.mBTDB = {
    state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1 },
    
    icons: {
        trash: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
        plus: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
        user: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
        cloud: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`,
        save: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path></svg>`,
        undo: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>`,
        redo: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>`,
        copy: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`,
        print: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
        close: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
        wand: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="M3 21l9-9"/><path d="M12.2 6.2 11 5"/></svg>`,
        grid: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>`,
        list: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`
    },

    templates: {
        'default': { label: "Blank Document", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] },
        'callSheet': {
            label: "Daily Call Sheet",
            widgets: [
                { id: 'contacts', x: 0, y: 0, w: 12, h: 4, type: 'contacts', label: "Key Contacts" }, 
                { id: 'logistics', x: 0, y: 4, w: 12, h: 6, type: 'logistics', label: "Logistics" },
                { id: 'schedule', x: 0, y: 10, w: 12, h: 8, type: 'schedule', label: "Schedule" },
                { id: 'cast', x: 0, y: 18, w: 6, h: 8, type: 'cast', label: "Cast List" },
                { id: 'crew', x: 6, y: 18, w: 6, h: 8, type: 'crew', label: "Crew List" },
                { id: 'notes', x: 0, y: 26, w: 12, h: 4, type: 'richText', label: "General Notes" }
            ]
        }
    },

    // --- 1. Core Logic ---
    open: function(docId) {
        this.state.currentDocId = docId;
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;

        if (!doc.content) doc.content = { data: {}, widgets: [] };
        // Initial Template Load
        if (!doc.content.widgets || doc.content.widgets.length === 0) {
            const tKey = this.templates[doc.type] ? doc.type : 'default';
            doc.content.widgets = JSON.parse(JSON.stringify(this.templates[tKey].widgets));
            if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
        }

        mBTME.open('documentViewerModal', 'Document Viewer', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
        this.renderFrame();
    },

    close: function() {
        mBTME.close('documentViewerModal');
        // Hard Close Fallback
        const el = document.getElementById('documentViewerModal');
        if(el) el.style.display = 'none';
        // Cleanup Print Mode
        document.body.classList.remove('print-mode');
    },

    toggleEditMode: function() {
        // 1. If we are currently editing, SAVE the layout before closing
        if (this.state.isEditing && this.state.grid) {
            this._saveLayoutState(); 
        }

        this.state.isEditing = !this.state.isEditing;
        const container = document.getElementById('mBTDB_Workspace');
        const grid = this.state.grid;

        if (this.state.isEditing) {
            container.classList.add('editing-mode');
            grid.setStatic(false);
            grid.enable();
        } else {
            container.classList.remove('editing-mode');
            grid.setStatic(true);
            grid.disable();
        }
        this._updateHeaderButtons();
        // We do NOT call renderFrame() here to avoid visual jumping. 
        // We just toggle the CSS class and Gridstack state.
    },

    // NEW HELPER: Force save of all widget positions
    _saveLayoutState: function() {
        if (!this.state.grid) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        
        this.state.grid.engine.nodes.forEach(node => {
            const widget = doc.content.widgets.find(w => w.id === node.id);
            if (widget) {
                widget.x = node.x;
                widget.y = node.y;
                widget.w = node.w;
                widget.h = node.h;
            }
        });
        
        this._triggerSave();
    },
/* --- BUNDLE 2: BUILDER ROUTING --- */
    previewDoc: function(mode) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        if (!doc) return;
        if(window.mBTME && mBTME.showLoader) mBTME.showLoader("Generating Industry Preview...");

        mBTPublisher.generateFastPreview(mode, doc.content.data, (jpegURL) => {
            if(window.mBTME && mBTME.hideLoader) mBTME.hideLoader();
            mBTME.open('previewModal', `Preview - ${mode.toUpperCase()}`, 
                `<div class="flex flex-col items-center bg-slate-900 h-full p-6 overflow-auto">
                    <img src="${jpegURL}" id="finalPreviewImage" class="shadow-2xl border border-black max-w-full h-auto mb-20 bg-white">
                </div>`, 'w-full h-full'
            );

            const footer = `
                <div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[10001]">
                    <button onclick="mBTPublisher.downloadJPEG('${jpegURL}', '${doc.label}')" class="flex items-center gap-2 bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-xl hover:bg-blue-500 transition-all active:scale-95">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Download JPEG
                    </button>
                    <button onclick="mBTDB.sendToDistribution('${jpegURL}')" class="flex items-center gap-2 bg-green-600 text-white px-8 py-3 rounded-full font-bold shadow-xl hover:bg-green-500 transition-all active:scale-95">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        Send to Crew (PDF)
                    </button>
                    <button onclick="mBTME.close('previewModal')" class="flex items-center gap-2 bg-white text-slate-900 px-8 py-3 rounded-full font-bold shadow-xl hover:bg-slate-100 transition-all">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Close
                    </button>
                </div>`;
            document.getElementById('previewModal').insertAdjacentHTML('beforeend', footer);
        });
    },

    sendToDistribution: function(jpegURL) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const pdfBlob = mBTPublisher.convertToPDFBlob(jpegURL);
        this.close(); 
        if(window.openDocumentShareSelector) openDocumentShareSelector(doc.id); 
    },
/* --- END BUNDLE 2 --- */
    // --- 2. Smart Features ---

    autoFillWidget: function(type, docId) {
        if(!confirm(`Auto-fill ${type}? This appends data.`)) return;
        if(type === 'contacts') {
            const roles = ['director', 'producer', '1st ad'];
            roles.forEach(r => {
                const c = mBTOG.contacts.find(x => x.role && x.role.toLowerCase().includes(r));
                if(c) this.updateData(docId, `contacts.${r === '1st ad' ? 'ad' : r}`, `${c.name} ${c.contact||''}`);
            });
        }
        else if(type === 'crew') {
            Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                if(i.crew && i.crew.name) this.addRow(docId, 'crew', 'person', { department: i.description, name: i.crew.name, contact: i.crew.phone });
            }));
        }
        this.renderFrame();
    },

    autoFillWeather: async function(docId, index, name) {
        const btn = document.getElementById(`w-btn-${index}`);
        if(btn) btn.innerHTML = "â³";
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
            const geo = await geoRes.json();
            if(!geo.results) throw new Error("Loc not found");
            const { latitude, longitude } = geo.results[0];
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,wind_speed_10m_max,precipitation_probability_max&timezone=auto`);
            const wData = await wRes.json();
            const today = wData.daily;
            
            const code = today.weather_code[0];
            let icon = "â˜€ï¸"; if(code > 3) icon = "â˜ï¸"; if(code > 50) icon = "ðŸŒ§ï¸"; if(code > 90) icon = "â›ˆï¸";
            const str = `${icon} ${today.temperature_2m_max[0]}Â°C / ${today.temperature_2m_min[0]}Â°C\nðŸ’¨ ${today.wind_speed_10m_max[0]}km/h  ðŸ’§ ${today.precipitation_probability_max[0]}%\nSun: ${today.sunrise[0].split('T')[1]} / ${today.sunset[0].split('T')[1]}`;
            
            this.updateRow(docId, 'locations', index, 'weather', str);
            this.renderFrame();
        } catch(e) { alert("Weather Failed"); if(btn) btn.innerHTML = "â˜ï¸"; }
    },

    // --- 3. Rendering ---

    renderFrame: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const container = document.getElementById('mBTDB_Container');
        
        const toolbarHTML = `
            <div id="mBTDB_Header" class="bg-slate-800 text-white p-2 flex justify-between items-center sticky top-0 z-50 shadow-md print:hidden">
                <div class="flex items-center gap-2">
                    <h2 class="font-black text-sm tracking-tight text-slate-200">ðŸ“„ ${RenderEngine.esc(doc.label)}</h2>
                    <div class="flex bg-slate-700 rounded overflow-hidden border border-slate-600">
                        <button onclick="mBTDB.syncFromBudget()" class="text-[10px] px-2 py-1 text-slate-200 hover:bg-slate-600 border-r border-slate-600" title="Pull Budget Data">Sync Budget</button>
                        <button onclick="mBTDB.syncFromPrevious()" class="text-[10px] px-2 py-1 text-slate-200 hover:bg-slate-600" title="Pull Previous Call Sheet">Sync Prev</button>
                    </div>
                </div>
                <div class="flex gap-2 items-center" id="mBTDB_Buttons"></div>
            </div>`;

        const workspaceHTML = `
            <div id="mBTDB_Workspace" class="bg-slate-200 min-h-screen p-4 overflow-y-auto ${this.state.isEditing ? 'editing-mode' : ''}">
                <div id="mBTDB_MetaArea" class="mb-4 bg-white p-4 shadow-sm rounded border border-slate-300"></div>
                <div class="grid-stack"></div>
            </div>`;

        container.innerHTML = toolbarHTML + workspaceHTML;
        this._renderMetaHeader(doc);

        setTimeout(() => {
            this.state.grid = GridStack.init({
                column: 12, cellHeight: 60, minRow: 1, margin: 4, animate: true, float: true,
                disableOneColumnMode: false, staticGrid: !this.state.isEditing 
            }, container.querySelector('.grid-stack'));
            
            this._loadWidgetsToGrid(doc);
            this._updateHeaderButtons();
            
            this.state.grid.on('change', (e, items) => { this._triggerSave(); });
        }, 50);
    },

    _loadWidgetsToGrid: function(doc) {
        const grid = this.state.grid;
        grid.removeAll();
        grid.batchUpdate();
        doc.content.widgets.forEach(w => {
            if(w.type === 'header') return; 
            const html = this._generateWidgetHTML(w, doc);
            grid.addWidget({ x: w.x, y: w.y, w: w.w, h: w.h, content: html, id: w.id });
        });
        grid.commit();
    },

    _generateWidgetHTML: function(widget, doc) {
        const data = doc.content.data;
        // Clean Title Fallback
        const cleanTitle = widget.label || (widget.type.charAt(0).toUpperCase() + widget.type.slice(1));
        
        // Header Controls
        let tools = '';
        if(widget.type === 'contacts') tools += `<button onclick="mBTDB.toggleVertical('${widget.id}')" class="icon-btn" title="Layout">${widget.vertical ? this.icons.grid : this.icons.list}</button>`;
        tools += `<button onclick="mBTDB.autoFillWidget('${widget.type}', '${doc.id}')" class="icon-btn text-purple-500" title="Auto Fill">${this.icons.wand}</button>`;
        
        const controls = `
            <div class="widget-header">
                <input value="${cleanTitle}" onchange="mBTDB.updateWidgetLabel('${doc.id}', '${widget.id}', this.value)" class="bg-transparent border-none font-black text-xs uppercase text-slate-600 w-32 outline-none">
                <div class="flex items-center gap-1">
                    ${tools}
                    <button onclick="mBTDB.deleteWidget('${widget.id}')" class="icon-btn hover:text-red-600">${this.icons.trash}</button>
                </div>
            </div>`;
        
        let content = '';
        if (widget.type === 'contacts') content = this._renderContacts(doc.id, data, widget);
        else if (widget.type === 'logistics' || widget.type === 'weather' || widget.type === 'locations') content = this._renderLogistics(doc.id, data);
        else if (widget.type === 'schedule') content = this._renderSchedule(doc.id, data);
        else if (widget.type === 'crew') content = this._renderCrew(doc.id, data);
        else if (widget.type === 'cast') content = this._renderTalent(doc.id, data);
        else if (widget.type === 'richText') content = this._renderRichText(doc.id, widget.id, data);

        return `
            <div class="grid-stack-item-content">
                ${controls}
                <div class="widget-body flex-grow overflow-y-auto relative text-slate-800 h-full">${content}</div>
            </div>`;
    },

    // --- 4. Renderers ---

    _renderMetaHeader: function(doc) {
        const d = doc.content.data;
        const html = `
             <div class="flex flex-wrap gap-4 items-end justify-between">
                <div class="w-full sm:w-auto flex-grow">
                    <input value="${d.meta.productionTitle || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-3xl font-black uppercase w-full outline-none text-slate-900 bg-transparent mb-1" placeholder="PRODUCTION TITLE">
                    <div class="flex gap-4">
                        <div class="flex items-center gap-1"><span class="text-[9px] font-black text-slate-400 uppercase">Date</span><input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="mbt-input w-auto font-bold"></div>
                        <div class="flex items-center gap-1"><span class="text-[9px] font-black text-slate-400 uppercase">Call</span><input type="text" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input w-16 bg-yellow-300 font-bold border-yellow-400 text-center" placeholder="00:00"></div>
                        <div class="flex items-center gap-1 bg-slate-50 border border-slate-200 px-2 rounded"><span class="text-[9px] font-black text-slate-400 uppercase">Day</span><span class="text-xs font-black text-slate-800">${this.calcShootDay(d.meta.shootDate)}</span></div>
                    </div>
                </div>
                <div class="w-48 text-right"><input value="${d.meta.productionCompany || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionCompany', this.value)" class="mbt-input text-right font-bold" placeholder="Company Name"></div>
            </div>`;
        document.getElementById('mBTDB_MetaArea').innerHTML = html;
    },

    _renderContacts: function(docId, d, widget) {
        const gridClass = widget.vertical ? "grid-cols-1" : "grid-cols-1 sm:grid-cols-3";
        const renderField = (path, val, label, role) => `
            <div class="relative">
                <div class="flex justify-between items-center mb-0.5"><div class="text-[9px] font-bold text-slate-500 uppercase">${label}</div><div class="icon-btn" onclick="mBTDB.pullFromOpenGate('${docId}', '${path}', '${role}')">${this.icons.user}</div></div>
                <input value="${val||''}" onchange="mBTDB.updateData('${docId}', '${path}', this.value)" class="mbt-input font-bold">
            </div>`;
        return `<div class="grid ${gridClass} gap-2 p-2 h-full overflow-y-auto">
            ${renderField('contacts.director', d.contacts.director, 'Director', 'director')}
            ${renderField('contacts.producer', d.contacts.producer, 'Producer', 'producer')}
            ${renderField('contacts.ad', d.contacts.ad, '1st AD', 'ad')}
        </div>`;
    },

    _renderLogistics: function(docId, d) {
        return `<div class="flex flex-col h-full">
            <div class="p-2 border-b border-slate-100 bg-slate-50 flex gap-2 items-center">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Sun:</span>
                <input value="${d.meta.sunriseSunset||''}" onchange="mBTDB.updateData('${docId}','meta.sunriseSunset',this.value)" class="mbt-input w-32" placeholder="06:00 / 18:00">
            </div>
            <div class="flex-grow overflow-y-auto p-2 space-y-2">
                ${(d.locations||[]).map((l,i) => `
                    <div class="flex flex-wrap gap-2 items-start border-b border-slate-100 pb-2 mb-2">
                        <div class="w-full sm:w-1/3 space-y-1">
                            <input value="${l.name}" onchange="mBTDB.updateRow('${docId}','locations',${i},'name',this.value)" class="mbt-input font-black uppercase" placeholder="LOC NAME">
                            <input type="text" value="${l.timeOnLocation||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'timeOnLocation',this.value)" class="mbt-input" placeholder="Time @ Loc">
                        </div>
                        <div class="w-full sm:w-1/3 space-y-1">
                            <textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'address',this.value)" class="mbt-input h-16 resize-none" placeholder="Address...">${l.address}</textarea>
                        </div>
                        <div class="w-full sm:w-1/4 space-y-1 flex-grow">
                            <div class="flex gap-1">
                                <textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'weather',this.value)" class="mbt-input h-16 resize-none" placeholder="Weather...">${l.weather}</textarea>
                                <button id="w-btn-${i}" onclick="mBTDB.autoFillWeather('${docId}', ${i}, '${l.name}')" class="bg-blue-50 text-blue-600 w-6 flex items-center justify-center rounded border border-blue-200">${this.icons.cloud}</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
                <button onclick="mBTDB.addRow('${docId}','locations','loc')" class="w-full py-1 bg-slate-50 text-[9px] font-bold text-slate-500 hover:bg-slate-100 rounded border border-slate-200">${this.icons.plus} Add Location</button>
            </div>
        </div>`;
    },

    _renderSchedule: function(docId, d) {
        return `<div class="h-full flex flex-col">
            <div class="flex-grow overflow-auto">
                <table class="w-full text-xs mbt-table border-collapse min-w-[600px]">
                    <thead><tr><th class="w-12">Time</th><th class="w-12">Scn</th><th>Description</th><th class="w-24">Cast</th><th class="w-8">I/E</th><th class="w-24">Loc</th><th class="w-24">Note</th><th class="w-6"></th></tr></thead>
                    <tbody>
                        ${d.schedule.map((row, i) => `
                            <tr class="${row.type==='meal'?'bg-amber-50':''}">
                                <td><input value="${row.time}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'time',this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input text-center font-bold bg-transparent border-0"></td>
                                ${row.type==='meal' 
                                ? `<td colspan="4"><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="mbt-input text-center font-black uppercase text-amber-900 bg-transparent border-0 tracking-widest"></td>`
                                : `<td><input value="${row.scene}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'scene',this.value)" class="mbt-input text-center font-bold bg-transparent border-0"></td>
                                   <td><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="mbt-input bg-transparent border-0"></td>
                                   <td><input value="${row.cast}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'cast',this.value)" class="mbt-input text-center bg-transparent border-0"></td>
                                   <td><input value="${row.ie}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'ie',this.value)" class="mbt-input text-center text-[9px] uppercase bg-transparent border-0"></td>`
                                }
                                <td><input value="${row.loc}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'loc',this.value)" class="mbt-input bg-transparent border-0"></td>
                                <td><input value="${row.note}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'note',this.value)" class="mbt-input italic text-slate-500 bg-transparent border-0"></td>
                                <td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','schedule',${i}, 'schedule')" class="text-slate-300 hover:text-red-500">${this.icons.trash}</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="flex gap-2 p-1 bg-slate-50 border-t border-slate-200 widget-controls">
                <button onclick="mBTDB.addRow('${docId}','schedule','shot')" class="flex-1 bg-white border border-emerald-300 text-emerald-700 text-[9px] font-bold py-1 rounded hover:bg-emerald-50">+ Shot</button>
                <button onclick="mBTDB.addRow('${docId}','schedule','meal')" class="flex-1 bg-white border border-amber-300 text-amber-700 text-[9px] font-bold py-1 rounded hover:bg-amber-50">+ Meal</button>
            </div>
        </div>`;
    },

    _renderCrew: function(docId, d) {
        return `<div class="h-full flex flex-col">
            <div class="flex-grow overflow-auto">
                <table class="w-full mbt-table border-collapse">
                    <thead><tr><th>Dept</th><th>Pos</th><th>Name</th><th>Contact</th><th class="w-12">Call</th><th class="w-6"></th></tr></thead>
                    <tbody>
                        ${(d.crew||[]).map((c,i) => `
                            <tr>
                                <td><input value="${c.department||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'department',this.value)" class="mbt-input font-bold uppercase text-[9px] text-slate-500 border-0 bg-transparent"></td>
                                <td><input value="${c.position||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'position',this.value)" class="mbt-input font-bold border-0 bg-transparent"></td>
                                <td><div class="relative"><input value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'name',this.value)" class="mbt-input border-0 bg-transparent"><div class="input-action-btn" onclick="mBTDB.pullFromOpenGate('${docId}','crew.${i}.name','${c.position||'crew'}')">${this.icons.user}</div></div></td>
                                <td><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'contact',this.value)" class="mbt-input text-[9px] border-0 bg-transparent"></td>
                                <td><input type="text" value="${c.callTime||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'callTime',this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input text-center border-0 bg-transparent"></td>
                                <td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','crew',${i}, 'crew')" class="text-slate-300 hover:text-red-500">${this.icons.trash}</button></td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>
             <div class="p-1 border-t border-slate-200 widget-controls">
                <button onclick="mBTDB.addRow('${docId}','crew','person')" class="w-full bg-slate-50 text-slate-600 text-[9px] font-bold py-1 rounded border border-slate-200">+ Add Crew</button>
            </div>
        </div>`;
    },

    _renderTalent: function(docId, d) {
        return `<div class="h-full flex flex-col">
            <div class="flex-grow overflow-auto">
                <table class="w-full mbt-table border-collapse min-w-[500px]">
                    <thead><tr><th>Role</th><th>Actor</th><th>Contact</th><th class="w-8">Stat</th><th class="w-12">Pick</th><th class="w-12">HMU</th><th class="w-12">Call</th><th class="w-6"></th></tr></thead>
                    <tbody>
                        ${(d.cast||[]).map((c,i) => `
                            <tr>
                                <td><input value="${c.character||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'character',this.value)" class="mbt-input font-bold text-slate-600 border-0 bg-transparent"></td>
                                <td><div class="relative"><input value="${c.actor||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'actor',this.value)" class="mbt-input font-black border-0 bg-transparent"><div class="input-action-btn" onclick="mBTDB.pullFromOpenGate('${docId}','cast.${i}.actor','actor')">${this.icons.user}</div></div></td>
                                <td><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'contact',this.value)" class="mbt-input text-[9px] border-0 bg-transparent"></td>
                                <td><input value="${c.status||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'status',this.value)" class="mbt-input text-center uppercase border-0 bg-transparent"></td>
                                <td><input type="text" value="${c.pickup||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'pickup',this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input text-center border-0 bg-transparent"></td>
                                <td><input type="text" value="${c.hmu||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'hmu',this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input text-center border-0 bg-transparent"></td>
                                <td><input type="text" value="${c.setCall||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'setCall',this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input text-center font-bold bg-yellow-50 border-0"></td>
                                <td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','cast',${i}, 'cast')" class="text-slate-300 hover:text-red-500">${this.icons.trash}</button></td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>
             <div class="p-1 border-t border-slate-200 widget-controls">
                <button onclick="mBTDB.addRow('${docId}','cast','talent')" class="w-full bg-slate-100 text-slate-600 text-[9px] font-bold py-1 rounded border border-slate-200">+ Add Talent</button>
            </div>
        </div>`;
    },

    _renderRichText: function(docId, widgetId, data) {
        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        return `<div class="h-full flex flex-col">
            <div class="flex-grow relative">
                <textarea onchange="mBTDB.updateData('${docId}', 'additional.${widgetId}', this.value)" class="w-full h-full p-2 text-xs text-slate-800 bg-transparent border-0 outline-none resize-none" placeholder="Type notes here...">${val||''}</textarea>
            </div>
        </div>`;
    },

    // --- 5. Helpers ---
    toggleVertical: function(wid) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const w = doc.content.widgets.find(x => x.id === wid);
        if(w) { w.vertical = !w.vertical; this.renderFrame(); }
    },
    updateWidgetLabel: function(docId, widgetId, newLabel) {
        const doc = budget.documents.find(d => d.id === docId);
        const w = doc.content.widgets.find(x => x.id === widgetId);
        if(w) { w.label = newLabel; this._triggerSave(); }
    },
    updateData: function(docId, path, value) {
        const doc = budget.documents.find(d => d.id === docId);
        const parts = path.split('.');
        let target = doc.content.data;
        for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; }
        target[parts[parts.length-1]] = value;
        this._triggerSave();
    },
    updateRow: function(docId, section, index, key, value) {
        const doc = budget.documents.find(d => d.id === docId);
        if(doc.content.data[section][index]) { 
            doc.content.data[section][index][key] = value; 
            this._triggerSave(); 
            
            // Auto-snap height when data changes
            // We map section names back to widget types to find the ID
            const type = (section === 'locations') ? 'logistics' : section;
            const widget = doc.content.widgets.find(w => w.type === type);
            if(widget) this._autoResizeWidget(widget.id);
        }
    },
    addRow: function(docId, section, type, presetData) {
        const doc = budget.documents.find(d => d.id === docId);
        if(!doc.content.data[section]) doc.content.data[section] = [];
        let newRow = presetData || { id: Date.now() };
        if(!presetData) {
            if(section==='schedule') newRow = { ...newRow, type, time:"", scene:"", description: type==='meal'?"LUNCH":"New Shot", cast:"", ie:"", loc:"", note:"" };
            else if(section==='cast') newRow = { ...newRow, character:"", actor:"", status:"W", pickup:"", hmu:"", setCall:"", contact:"" };
            else if(section==='crew') newRow = { ...newRow, department:"", position:"", name:"", contact:"", callTime:"" };
            else if(section==='locations') newRow = { ...newRow, name:"", address:"", weather:"", hospital:"", mapLink:"", timeOnLocation:"" };
        }
        doc.content.data[section].push(newRow);
        this._triggerSave();
        this.renderFrame();
        
        const widget = doc.content.widgets.find(w => w.type === (section === 'locations' ? 'logistics' : section));
        if(widget) this._autoResizeWidget(widget.id);
    },
    deleteRow: function(docId, section, index, widgetType) {
        const doc = budget.documents.find(d => d.id === docId);
        doc.content.data[section].splice(index, 1);
        this._triggerSave();
        this.renderFrame();
        
        const widget = doc.content.widgets.find(w => w.type === (widgetType || section));
        if(widget) this._autoResizeWidget(widget.id);
    },
    deleteWidget: function(id) {
        if(!confirm("Delete widget?")) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const el = document.querySelector(`.grid-stack-item[gs-id="${id}"]`);
        if(el) this.state.grid.removeWidget(el);
        doc.content.widgets = doc.content.widgets.filter(w => w.id !== id);
        this._triggerSave();
    },
    addWidget: function() {
        const type = document.getElementById('mBTDB_WidgetSelect').value;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        
        // CHANGE: Default w changed from 12 (Full) to 6 (Half)
        // This allows it to slot into empty spaces to the left/right.
        const w = { 
            id: type+'_'+Date.now(), 
            type, 
            w: 6, 
            h: 4, 
            autoPosition: true, 
            label: type.toUpperCase() 
        };

        const html = this._generateWidgetHTML(w, doc);
        
        // GridStack will now hunt for the first available 6x4 gap
        const node = this.state.grid.addWidget({ 
            w: 6, 
            h: 4, 
            content: html, 
            id: w.id, 
            autoPosition: true 
        });

        w.x = node.gridstackNode.x; 
        w.y = node.gridstackNode.y;
        doc.content.widgets.push(w);
        this._triggerSave();
    },
    _autoResizeWidget: function(widgetId) {
        const el = document.querySelector(`.grid-stack-item[gs-id="${widgetId}"]`);
        if(!el) return;
        
        const body = el.querySelector('.widget-body');
        if(!body) return;
        
        // Calculate exact pixel height of the content (inputs + rows)
        // We temporarily set height to 'auto' to get the true natural height
        const currentHeight = body.style.height;
        body.style.height = 'auto';
        const contentHeight = body.scrollHeight + 45; // +45px for header/padding
        body.style.height = currentHeight; // Restore for smooth animation

        // Convert pixels to Grid Units (approx 60px-70px per row depending on your CSS)
        // We use Math.ceil to ensure we don't cut off text
        let newH = Math.ceil(contentHeight / 60); 
        if(newH < 3) newH = 3; // Minimum height to prevent crushing

        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const w = doc.content.widgets.find(x => x.id === widgetId);
        
        // Only update if the size actually changed
        if(w && w.h !== newH) { 
            w.h = newH;
            // Force Gridstack to resize exactly to this height
            this.state.grid.update(el, { h: newH }); 
            this._triggerSave();
        }
    },
    formatTime: function(el) {
        let val = el.value.replace(/[^0-9]/g, '');
        if(val.length === 4) {
            el.value = val.substring(0,2) + ':' + val.substring(2,4);
            el.dispatchEvent(new Event('change'));
        }
    },
    saveTemplate: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const name = prompt("Name this template:", doc.label + " Template");
        if(!name) return;
        const tmpl = { id: 'tmpl_' + Date.now(), label: name, widgets: JSON.parse(JSON.stringify(doc.content.widgets)) };
        if(!budget.templates) budget.templates = [];
        budget.templates.push(tmpl);
        saveBudget();
        alert(`Template "${name}" saved!`);
    },
    calcShootDay: function(dateStr) {
        if(!budget.startDate) return "1 of 1";
        const start = new Date(budget.startDate);
        const current = new Date(dateStr);
        if(isNaN(start) || isNaN(current)) return "1 of 1";
        const diffTime = current - start;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        return `Day ${diffDays}`;
    },
    syncFromBudget: function() {
        if(!confirm("Overwrite empty fields with data from your Budget?")) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const defaults = this._generateDefaultData();
        if(!doc.content.data.crew || doc.content.data.crew.length === 0) doc.content.data.crew = defaults.crew;
        if(!doc.content.data.contacts.director) doc.content.data.contacts = defaults.contacts;
        this._triggerSave();
        this.renderFrame();
    },
    syncFromPrevious: function() {
        const others = budget.documents.filter(d => d.type === 'callSheet' && d.id !== this.state.currentDocId);
        if(others.length === 0) return alert("No previous Call Sheets found.");
        others.sort((a,b) => new Date(b.created) - new Date(a.created));
        const prev = others[0];
        if(!confirm(`Pull data from "${prev.label}"?`)) return;
        
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const currentMeta = JSON.parse(JSON.stringify(doc.content.data.meta));
        doc.content.data = JSON.parse(JSON.stringify(prev.content.data));
        doc.content.data.meta = currentMeta; 
        
        this._triggerSave();
        this.renderFrame();
    },
    _triggerSave: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        saveBudget();
        this._pushHistory(doc);
    },
    _pushHistory: function(doc) {
        if (this.state.historyPointer < this.state.history.length - 1) this.state.history = this.state.history.slice(0, this.state.historyPointer + 1);
        this.state.history.push(JSON.stringify(doc.content));
        this.state.historyPointer++;
        if(this.state.history.length > 50) { this.state.history.shift(); this.state.historyPointer--; }
        this._updateHeaderButtons();
    },
    undo: function() { if(this.state.historyPointer > 0) { this.state.historyPointer--; this._restoreHistory(); } },
    redo: function() { if(this.state.historyPointer < this.state.history.length - 1) { this.state.historyPointer++; this._restoreHistory(); } },
    _restoreHistory: function() { 
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        doc.content = JSON.parse(this.state.history[this.state.historyPointer]);
        saveBudget(); this.renderFrame(); 
    },
    snapshotDoc: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        if(!confirm(`Copy "${doc.label}"?`)) return;
        const newDoc = JSON.parse(JSON.stringify(doc));
        newDoc.id = 'doc_' + Date.now();
        newDoc.label = doc.label + " (Copy)";
        budget.documents.push(newDoc);
        saveBudget();
        if(document.getElementById('documentsHubModal')) showDocumentsModal(window.docHubState ? window.docHubState.activeTab : null);
        mBTDB.open(newDoc.id);
    },
    pullFromOpenGate: function(docId, path, roleQuery) {
        if (typeof mBTOG === 'undefined' || !mBTOG.contacts) return alert("Open Gate Database not loaded.");
        const matches = mBTOG.contacts.filter(c => c.role && c.role.toLowerCase().includes(roleQuery.toLowerCase()));
        if (matches.length === 0) return alert(`No contacts found for "${roleQuery}".`);
        const apply = (c) => {
            const parts = path.split('.');
            if(parts.length === 3 && (parts[0] === 'crew' || parts[0] === 'cast')) {
                this.updateRow(docId, parts[0], parseInt(parts[1]), parts[2], c.name);
                if(c.contact) this.updateRow(docId, parts[0], parseInt(parts[1]), 'contact', c.contact);
            } else {
                this.updateData(docId, path, `${c.name} ${c.contact ? '('+c.contact+')' : ''}`);
            }
            this.renderFrame(); 
        };
        if (matches.length === 1) apply(matches[0]);
        else {
            const choice = prompt(`Found ${matches.length} matches:\n${matches.map((c,i)=>`${i+1}. ${c.name}`).join('\n')}\nEnter #`);
            const idx = parseInt(choice)-1;
            if(matches[idx]) apply(matches[idx]);
        }
    },
    // --- 3. Printing (mBTPublisher Integration) ---

    printToPDF: function(mode) {
        // 1. Verify Publisher exists
        if (typeof mBTPublisher === 'undefined' || !mBTPublisher.exportToPDF) {
            return alert("mBTPublisher engine not found.");
        }

        // 2. Clone the workspace to avoid messing up the live view
        const original = document.getElementById('mBTDB_Workspace');
        const clone = original.cloneNode(true);
        
        // 3. Configure the Clone
        clone.id = "mBTDB_Print_Container";
        clone.classList.remove('editing-mode');
        clone.classList.add('print-container'); // Base reset
        clone.classList.add(mode === 'standard' ? 'print-standard' : 'print-graphic'); // Apply Mode
        
        // Force inputs to have their values (cloning doesn't always carry input values)
        const originalInputs = original.querySelectorAll('input, textarea');
        const cloneInputs = clone.querySelectorAll('input, textarea');
        originalInputs.forEach((input, i) => {
            if(cloneInputs[i]) cloneInputs[i].value = input.value;
        });

        // 4. Mount, Print, Destroy
        document.body.appendChild(clone);
        
        // Use the Publisher
        const filename = `${budget.projectName}_CallSheet_${mode}`;
        mBTPublisher.exportToPDF('mBTDB_Print_Container', filename);

        // Cleanup after delay to allow capture
        setTimeout(() => { document.body.removeChild(clone); }, 2000);
    },

    // --- Header Update ---

_updateHeaderButtons: function() {
    const btnContainer = document.getElementById('mBTDB_Buttons');
    if(!btnContainer) return;
    const isEd = this.state.isEditing;

    // 1. Define the Preview Menu (SVG Version - No Emojis)
const previewMenu = `
    <div class="relative inline-block">
        <button onclick="const m = this.nextElementSibling; m.classList.toggle('hidden');" 
            class="bg-slate-700 text-white px-3 py-1 rounded text-xs font-bold hover:bg-slate-600 flex items-center gap-1 transition-all outline-none">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            Preview
        </button>
        <div class="hidden absolute right-0 mt-2 w-44 bg-white rounded shadow-2xl border border-slate-200 z-[9999] overflow-hidden">
            <button onclick="mBTDB.previewDoc('standard'); this.parentElement.classList.add('hidden')" 
                class="flex items-center gap-2 w-full text-left px-4 py-3 text-[11px] text-slate-700 hover:bg-blue-50 hover:text-blue-700 font-bold border-b border-slate-100 transition-colors">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                Industry Standard
            </button>
            <button onclick="mBTDB.previewDoc('graphic'); this.parentElement.classList.add('hidden')" 
                class="flex items-center gap-2 w-full text-left px-4 py-3 text-[11px] text-slate-700 hover:bg-blue-50 hover:text-blue-700 font-medium transition-colors">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Graphic View
            </button>
        </div>
    </div>`;

    // 2. Inject into the DOM (Crucial: Using the new previewMenu variable here)
    btnContainer.innerHTML = `
        <div class="flex gap-1 mr-2 border-r border-slate-600 pr-2">
            <button onclick="mBTDB.undo()" class="p-1 hover:bg-slate-700 rounded text-slate-300" title="Undo">${this.icons.undo}</button>
            <button onclick="mBTDB.redo()" class="p-1 hover:bg-slate-700 rounded text-slate-300" title="Redo">${this.icons.redo}</button>
            <button onclick="mBTDB.snapshotDoc()" class="p-1 hover:bg-blue-900 rounded text-blue-300" title="Clone">${this.icons.copy}</button>
            <button onclick="mBTDB.saveTemplate()" class="p-1 hover:bg-blue-900 rounded text-green-300" title="Save Template">${this.icons.save}</button>
        </div>
        ${isEd ? `<select id="mBTDB_WidgetSelect" class="bg-slate-700 text-xs text-white h-6 rounded mr-1"><option value="richText">Note</option><option value="schedule">Schedule</option><option value="cast">Cast</option><option value="crew">Crew</option><option value="logistics">Logistics</option><option value="contacts">Contacts</option></select><button onclick="mBTDB.addWidget()" class="text-green-400 font-bold mr-2">${this.icons.plus}</button>` : ''}
        <button onclick="mBTDB.toggleEditMode()" class="${isEd ? 'bg-green-600' : 'bg-blue-600'} text-white px-3 py-1 rounded text-xs font-bold shadow">${isEd ? 'Done' : 'Edit'}</button>
        ${previewMenu} 
        <button onclick="mBTDB.close()" class="bg-red-900 text-red-200 px-2 py-1 rounded hover:text-white">${this.icons.close}</button>
    `;
},
    aiCleanup: async function(docId, path, text) {
        if(!text) return;
        if(!localStorage.getItem('mBT_API_KEY') && !window.API_KEY) return alert("AI functionality requires an API Key.");
        const btn = document.activeElement;
        const originalText = btn.innerHTML;
        btn.innerHTML = "âœ¨...";
        try {
            alert("AI Feature: In a full build, this sends prompt to API. (Simulated)");
            btn.innerHTML = originalText;
        } catch(e) { alert("AI Error"); btn.innerHTML = originalText; }
    },
    _generateDefaultData: function() {
        return {
            meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" },
            contacts: { director: "", producer: "", ad: "" },
            schedule: [], crew: [], cast: [],
            locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}],
            additional: {}
        };
    }
};
window.CallSheetBuilder = { render: function(docId) { mBTDB.open(docId); } };

// ------------------------ DOCUMENTS ------------------------- //
/* --- v19.55 [Documents] - Viewer Integration (Builder Support) --- */

function openDocumentViewer(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // 1. Determine State
    const isBuilder = doc.content && doc.content.isBuilder;
    const isStandardTemplate = doc.content && doc.content.isDynamic && !isBuilder;
    const hasAttachment = budget.attachments && budget.attachments.some(a => a.docId === docId);

    let viewerContent = '';
    const safeLabel = (doc.label || 'Document').replace(/[^a-z0-9]/gi, '_');

    // --- SCENARIO A: Special Builders (e.g. Call Sheet) ---
    if (isBuilder) {
        // We create a container, and the Builder Engine takes over the inner HTML
        viewerContent = `<div id="docViewerContent" class="h-full bg-gray-100 overflow-y-auto"></div>`;
        
        // Render Modal
        createModal('documentViewer', '', viewerContent, 'max-w-[90vw] w-full h-[90vh]', { noPadding: true, hideHeader: true });
        
        // Initialize Builder Logic (Immediate)
        setTimeout(() => {
            if(doc.content.templateId.includes('callSheet')) {
                // Ensure default data exists if empty
                if(!doc.content.data || Object.keys(doc.content.data).length === 0) {
                    doc.content.data = JSON.parse(JSON.stringify(CallSheetBuilder.defaultState));
                }
                
                // Add Auto-Fill Toolbar if data is fresh/empty
                const isNew = !doc.content.data.meta.productionTitle || doc.content.data.meta.productionTitle === "Untitled Production";
                if(isNew) {
                    if(confirm("New Call Sheet detected. Auto-fill from Budget details?")) {
                        CallSheetBuilder.autoFillFromBudget(docId);
                    }
                }
                
                CallSheetBuilder.render(docId);
            }
        }, 50);
        return; // Builder handles the rest
    }

    // --- SCENARIO B: Standard Templates (Forms) ---
    else if (isStandardTemplate) {
        if (!doc.content.data) doc.content.data = {};
        const editorHtml = mBTPublisher.renderEditor(doc);
        viewerContent = `
            <div class="flex flex-col h-full bg-gray-50 overflow-hidden">
                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10 flex-shrink-0">
                    <h2 class="font-bold text-lg text-gray-800 truncate">${doc.label}</h2>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="autofillMtemp('${docId}')" class="px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded font-bold text-xs hover:bg-green-100 transition-colors flex items-center gap-1"><span>âš¡</span> Autofill</button>
                        <button onclick="generateMtempPDF('${docId}')" class="px-3 py-1.5 bg-gray-800 text-white rounded font-bold text-xs hover:bg-black transition-colors flex items-center gap-1"><span>ðŸ–¨ï¸</span> PDF</button>
                        <button onclick="resetDocumentState('${docId}')" class="px-3 py-1.5 text-red-500 hover:bg-red-50 rounded text-xs font-bold" title="Reset to blank">Ã—</button>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">${editorHtml}</div>
            </div>`;
    }

    // --- SCENARIO C: File Attachment (Preview) ---
    else if (hasAttachment) {
        const attachment = budget.attachments.find(a => a.docId === docId);
        let previewHTML = '<div class="text-center p-10 text-gray-400">Preview Unavailable</div>';
        
        if (attachment.previewContent) {
            const p = attachment.previewContent;
            if (p.type === 'image') previewHTML = `<img src="${p.data}" class="max-w-full h-auto mx-auto rounded shadow-lg">`;
            else if (p.type === 'pdf') previewHTML = `<div class="text-center"><img src="${p.thumbnail}" class="max-w-full h-auto mx-auto border rounded shadow-sm mb-4"><p class="text-sm text-gray-500">PDF Document (${p.pageCount} pages)</p></div>`;
            else if (p.type === 'text') previewHTML = `<pre class="bg-gray-50 p-4 border rounded text-xs overflow-auto whitespace-pre-wrap font-mono text-gray-700">${p.content}</pre>`;
        }

        viewerContent = `
            <div class="flex flex-col h-full bg-gray-50">
                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800">${doc.label}</h2>
                        <p class="text-xs text-gray-500">Attached: ${attachment.name}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="mBTPublisher.forceDownload(new Blob([''], {type:'text/plain'}), '${attachment.name}')" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded font-bold text-xs hover:bg-gray-200">Download</button>
                        <button onclick="removeAttachmentFromDocument('${attachment.id}', '${docId}')" class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded font-bold text-xs hover:bg-red-100">Remove</button>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto p-6 flex items-center justify-center">
                    ${previewHTML}
                </div>
            </div>`;
    }

    // --- SCENARIO D: Empty State (Choice) ---
    else {
        viewerContent = `
            <div class="flex flex-col h-full items-center justify-center bg-gray-50 p-8 text-center">
                <div class="bg-white p-10 rounded-2xl shadow-xl border border-gray-100 max-w-lg w-full">
                    <div class="text-6xl mb-6 opacity-20">ðŸ“„</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Empty Document</h3>
                    <p class="text-gray-500 mb-8 text-sm">How would you like to start?</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="document.getElementById('viewerUpload_${docId}').click()" class="group p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-2">
                            <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ“¤</span>
                            <span class="font-bold text-gray-700 text-sm group-hover:text-blue-700">Upload File</span>
                        </button>
                        
                        <button onclick="startWithTemplate('${docId}')" class="group p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all flex flex-col items-center gap-2">
                            <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ“‹</span>
                            <span class="font-bold text-gray-700 text-sm group-hover:text-purple-700">Use Template</span>
                        </button>
                    </div>
                    <input type="file" id="viewerUpload_${docId}" class="hidden" onchange="handleDocUploadTrigger(this, '${docId}')">
                </div>
            </div>`;
    }

    createModal('documentViewer', '', viewerContent, 'max-w-6xl w-full', { noPadding: true, hideHeader: true });
}

// Ensure Legacy & New Logic Coexist
function resetDocumentState(docId) {
    if(!confirm("Reset document to empty? This removes all data.")) return;
    const doc = budget.documents.find(d => d.id === docId);
    if(doc) {
        doc.content = null;
        doc.status = "Draft";
        saveBudget();
        openDocumentViewer(docId);
    }
}

// --- Upload Logic ---
function handleDocUploadTrigger(inputElement, docId) {
    if (inputElement.files && inputElement.files[0]) {
        const file = inputElement.files[0];
        const reader = new FileReader();
        
        // Basic Preview Logic
        reader.onload = async (e) => {
            const attachment = {
                id: crypto.randomUUID(),
                docId: docId,
                name: file.name,
                type: file.type,
                dateAdded: new Date().toISOString(),
                previewContent: null
            };

            if (file.type.includes('image')) {
                attachment.previewContent = { type: 'image', data: e.target.result };
            } else if (file.type.includes('pdf')) {
                // Simple PDF Thumbnail (requires pdf.js, fallback to icon if missing)
                attachment.previewContent = { type: 'pdf', thumbnail: 'https://via.placeholder.com/150?text=PDF' }; 
                if(typeof pdfjsLib !== 'undefined') {
                    // Advanced Render (Async) - simplified here for stability
                    // In a real app, await the render. Here we place placeholder to ensure UI loads.
                }
            } else {
                attachment.previewContent = { type: 'text', content: "File uploaded." };
            }

            if(!budget.attachments) budget.attachments = [];
            budget.attachments.push(attachment);
            saveBudget();
            openDocumentViewer(docId); // Refresh View
        };
        reader.readAsDataURL(file);
    }
}

function removeAttachmentFromDocument(attachmentId, docId) {
    if(!confirm("Remove this attachment?")) return;
    budget.attachments = budget.attachments.filter(a => a.id !== attachmentId);
    saveBudget();
    openDocumentViewer(docId);
}

function resetDocumentState(docId) {
    if(!confirm("Reset document to empty? This removes all data.")) return;
    const doc = budget.documents.find(d => d.id === docId);
    if(doc) {
        doc.content = null;
        doc.status = "Draft";
        saveBudget();
        openDocumentViewer(docId);
    }
}

// --- Template Picker Logic ---
function startWithTemplate(docId) {
    const sourceTemplates = (typeof mBTOG !== 'undefined' && mBTOG.templates) ? mBTOG.templates : [];
    const custom = budget.customTemplates || [];
    const all = [...sourceTemplates, ...custom];

    const content = `
        <div class="p-4 bg-gray-50 h-[500px] flex flex-col">
            <h3 class="text-lg font-bold text-gray-800 mb-4 px-2">Select a Template</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 overflow-y-auto p-2">
                ${all.map(t => `
                    <button onclick="applyTemplate('${docId}', '${t.id}', ${!!custom.find(c=>c.id===t.id)})" 
                            class="flex flex-col items-center p-4 bg-white border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-md transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">${t.icon || 'ðŸ“„'}</div>
                        <div class="font-bold text-gray-700 text-sm">${t.label}</div>
                        <div class="text-[10px] text-gray-400 uppercase mt-1">${t.cat}</div>
                    </button>
                `).join('')}
                
                <button onclick="importMtempFile('${docId}')" class="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-xl hover:bg-blue-50 hover:border-blue-300 transition-all text-center">
                    <div class="text-2xl mb-2 text-blue-400">+</div>
                    <div class="font-bold text-blue-600 text-sm">Import .mtemp</div>
                </button>
            </div>
        </div>`;
    
    createModal('templatePicker', 'Select Template', content, 'max-w-4xl');
}

// --- Global Actions (Linked to mBTPublisher) ---
window.updateMtempField = (docId, section, key, val) => {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc.content.data[section]) doc.content.data[section] = {};
    doc.content.data[section][key] = val;
    saveBudget();
};

window.updateMtempTable = (docId, tableKey, rIdx, cIdx, val) => {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc.content.data.tables) doc.content.data.tables = {};
    if (!doc.content.data.tables[tableKey]) doc.content.data.tables[tableKey] = [];
    doc.content.data.tables[tableKey][rIdx][cIdx] = val;
    saveBudget();
};

window.addMtempRow = (docId, tableKey) => {
    const doc = budget.documents.find(d => d.id === docId);
    const cols = doc.content.fields.tables[tableKey].columns.length;
    if (!doc.content.data.tables) doc.content.data.tables = {};
    if (!doc.content.data.tables[tableKey]) doc.content.data.tables[tableKey] = [];
    doc.content.data.tables[tableKey].push(new Array(cols).fill(""));
    saveBudget();
    openDocumentViewer(docId);
};

window.removeMtempRow = (docId, tableKey, rIdx) => {
    const doc = budget.documents.find(d => d.id === docId);
    if (doc.content.data.tables?.[tableKey]) {
        doc.content.data.tables[tableKey].splice(rIdx, 1);
        saveBudget();
        openDocumentViewer(docId);
    }
};

window.autofillMtemp = (docId) => {
    if (!confirm("Overwrite fields with Budget data?")) return;
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;
    mBTPublisher.processAutofill(doc, budget);
    saveBudget();
    openDocumentViewer(docId);
};

window.generateMtempPDF = (docId) => {
    const doc = budget.documents.find(d => d.id === docId);
    mBTPublisher.toFileFromHTML('', `${budget.projectName}_${doc.label}`, ['pdf'], doc);
};


/* --- v19.54 Crew List Download (Proxied to mBTPublisher) --- */
window.downloadCrewList = async function(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc || doc.content.templateId !== 'crewList') return;

    // We keep renderCrewListTable logic here as it's specific to the old style Crew List, 
    // but we use mBTPublisher to actually generate the file.
    const tableHTML = renderCrewListTable(doc);
    const fullHTML = `
        <div id="render-target" class="p-12 bg-white text-black font-sans" style="width: 800px;">
            <h1 class="text-3xl font-bold text-center mb-6">${budget.projectName || 'Project'} - Crew Contact List</h1>
            <p class="text-center text-sm text-gray-500 mb-8">Generated: ${new Date().toLocaleDateString()}</p>
            ${tableHTML}
        </div>`;

    const choice = prompt("Download Crew List as:\n1 = PDF\n2 = JPEG\nEnter 1, 2, or 1,2", "1");
    if (!choice) return;
    const formats = [];
    if (choice.includes('1')) formats.push('pdf');
    if (choice.includes('2')) formats.push('jpg');

    await mBTPublisher.toFileFromHTML(fullHTML, `${budget.projectName}_CrewList`, formats);
};

// UI Helpers
function setDocMode(newMode) { window.docHubState.mode = newMode; if (newMode === 'normal') window.docHubState.selected.clear(); showDocumentsModal(); }
function toggleDocSelection(id) { if (window.docHubState.selected.has(id)) window.docHubState.selected.delete(id); else window.docHubState.selected.add(id); showDocumentsModal(); }
function handleBulkTrash() {
    if(confirm(`Move ${window.docHubState.selected.size} items to the bin?`)) {
        const toTrash = budget.documents.filter(d => window.docHubState.selected.has(d.id));
        toTrash.forEach(d => d.deletedAt = new Date().toISOString());
        budget.documentTrash = (budget.documentTrash || []).concat(toTrash);
        budget.documents = budget.documents.filter(d => !window.docHubState.selected.has(d.id));
        saveBudget();
        setDocMode('normal');
    }
}

// Helpers needed for legacy functions or specific UI needs
function renderCrewListTable(doc) {
    const crewByDept = {};
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        const dept = sectionName;
        if (!crewByDept[dept]) crewByDept[dept] = [];
        section.items.forEach(item => {
            if (item.crew && item.crew.name) {
                crewByDept[dept].push({
                    role: item.description,
                    name: item.crew.name || '',
                    phone: item.crew.phone || '',
                    email: item.crew.email || '',
                    diet: item.crew.diet || '-',
                    notes: item.crew.notes || '-'
                });
            }
        });
    });

    if (Object.keys(crewByDept).length === 0) return `<p class="text-center text-gray-500 py-12">No crew assigned.</p>`;

    return Object.entries(crewByDept).map(([dept, members]) => `
        <div class="mb-8">
            <h4 class="font-bold text-xl text-gray-800 mb-4 border-b-2 border-gray-300 pb-2">${dept}</h4>
            <table class="w-full text-sm border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                    <tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Role</th><th class="p-3 text-left">Phone</th><th class="p-3 text-left">Email</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${members.map(m => `<tr class="hover:bg-gray-50"><td class="p-3 font-medium">${m.name}</td><td class="p-3">${m.role}</td><td class="p-3">${m.phone}</td><td class="p-3">${m.email}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>
    `).join('');
}

function showAddDocumentModal() {
    const existingIds = (budget.documents || []).map(d => d.id);
    const sourceTemplates = (typeof mBTOG !== 'undefined' && mBTOG.templates) ? mBTOG.templates : [];
    const available = sourceTemplates.filter(t => !existingIds.includes(t.id));
    
    const content = `
        <div class="p-2">
            <input type="text" id="docSearch" placeholder="Search templates..." class="w-full p-3 border rounded-lg mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="docTemplateList" class="h-64 overflow-y-auto space-y-2">
                ${renderTemplateList(available)}
            </div>
            <div class="mt-4 pt-4 border-t">
                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Or create custom</p>
                <form onsubmit="handleCustomDoc(event)" class="flex gap-2">
                    <input type="text" id="customDocName" placeholder="Custom Document Name" class="flex-1 p-2 border rounded text-sm" required>
                    <select id="customDocCat" class="p-2 border rounded text-sm bg-white"><option>Pre-Prod</option><option>Production</option><option>Post-Prod</option><option>Legal</option></select>
                    <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded text-xs font-bold">Add</button>
                </form>
            </div>
        </div>`;
    createModal('addDoc', 'Add Document', content, 'max-w-md');
    
    document.getElementById('docSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = available.filter(t => t.label.toLowerCase().includes(term));
        document.getElementById('docTemplateList').innerHTML = renderTemplateList(filtered);
    });
}

function renderTemplateList(list) {
    if(list.length === 0) return '<div class="text-center text-gray-400 text-xs py-4">No matching templates found.</div>';
    return list.map(t => `
        <div onclick="addDocument('${t.id}')" class="flex items-center gap-3 p-2 hover:bg-blue-50 rounded cursor-pointer border border-transparent hover:border-blue-100 transition-colors group">
            <div class="text-xl">${t.icon}</div>
            <div class="flex-1">
                <div class="text-sm font-bold text-gray-700 group-hover:text-blue-700">${t.label}</div>
                <div class="text-[10px] text-gray-400 uppercase">${t.cat}</div>
            </div>
            <div class="text-blue-500 font-bold text-lg opacity-0 group-hover:opacity-100">+</div>
        </div>`).join('');
}

function addDocument(templateId) {
    const sourceTemplates = (typeof mBTOG !== 'undefined' && mBTOG.templates) ? mBTOG.templates : [];
    const template = sourceTemplates.find(t => t.id === templateId);
    if(template) {
        // v19.54 Fix: Ensure dynamic properties are copied when adding directly
        const newDoc = { 
            ...template, 
            status: 'Draft', 
            content: {
                type: 'template',
                templateId: template.id,
                templateLabel: template.label,
                isDynamic: template.isDynamic || false,
                htmlTemplate: template.htmlTemplate || '',
                printCss: template.printCss || '',
                fields: JSON.parse(JSON.stringify(template.fields || {})),
                data: {}
            },
            dateCreated: new Date().toISOString() 
        };
        budget.documents.push(newDoc);
        saveBudget();
        closeModal('addDocModal');
        showDocumentsModal();
    }
}

function handleCustomDoc(e) {
    e.preventDefault();
    const name = document.getElementById('customDocName').value.trim();
    const cat = document.getElementById('customDocCat').value;
    if(name) {
        budget.documents.push({ id: `cust_${Date.now()}`, label: name, cat: cat, icon: 'ðŸ“„', status: 'Draft', content: null, dateCreated: new Date().toISOString() });
        saveBudget();
        closeModal('addDocModal');
        showDocumentsModal();
    }
}

/* --- v19.54 [.mtemp Import] --- */
function importMtempFile(docId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.mtemp,application/json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imported = JSON.parse(ev.target.result);
                if (!imported.id || !imported.label) throw new Error("Invalid .mtemp file");
                budget.customTemplates = budget.customTemplates || [];
                const exists = budget.customTemplates.find(t => t.id === imported.id);
                if (exists) {
                    if (!confirm(`Template "${imported.label}" already exists. Overwrite?`)) return;
                    Object.assign(exists, imported);
                } else {
                    budget.customTemplates.push(imported);
                }
                saveCustomTemplates();
                alert(`Imported template: ${imported.label}`);
                closeModal('templatePickerModal');
                // Re-launch picker so user can select the new template
                startWithTemplate(docId); 
            } catch (err) { alert("Failed to import .mtemp: " + err.message); }
        };
        reader.readAsText(file);
    };
    input.click();
}

function startWithTemplate(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;
    const sourceTemplates = (typeof mBTOG !== 'undefined' && mBTOG.templates) ? mBTOG.templates : [];
    const builtIn = sourceTemplates.map(t => ({ ...t, isCustom: false }));
    const custom = (budget && Array.isArray(budget.customTemplates)) ? budget.customTemplates.map(t => ({ ...t, isCustom: true })) : [];
    const allTemplates = [...builtIn, ...custom];

    const content = `
        <div class="p-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Choose a Template</h3>
            <input type="text" id="templateSearch" placeholder="Search templates..." class="w-full p-3 border rounded-lg mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="templateGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                ${allTemplates.map(t => `
                    <div onclick="applyTemplate('${docId}', '${t.id}', ${t.isCustom})" class="p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 hover:shadow-md transition-all group">
                        <div class="text-3xl mb-2 text-center">${t.icon}</div>
                        <div class="font-bold text-gray-800 text-center">${t.label}</div>
                        <div class="text-xs text-gray-500 text-center uppercase mt-1">${t.cat}</div>
                        ${t.isCustom ? '<div class="mt-2 text-[10px] text-blue-600 text-center font-bold">CUSTOM</div>' : ''}
                    </div>`).join('')}
            </div>
            <div class="mt-6 pt-4 border-t text-center">
                <button onclick="importMtempFile('${docId}')" class="text-sm text-blue-600 hover:underline font-bold">+ Import .mtemp File</button>
            </div>
        </div>`;

    createModal('templatePicker', 'Select Template', content, 'max-w-2xl');

    document.getElementById('templateSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allTemplates.filter(t => t.label.toLowerCase().includes(term) || t.cat.toLowerCase().includes(term));
        document.getElementById('templateGrid').innerHTML = filtered.map(t => `
            <div onclick="applyTemplate('${docId}', '${t.id}', ${t.isCustom})" class="p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 hover:shadow-md transition-all group">
                <div class="text-3xl mb-2 text-center">${t.icon}</div>
                <div class="font-bold text-gray-800 text-center">${t.label}</div>
                <div class="text-xs text-gray-500 text-center uppercase mt-1">${t.cat}</div>
            </div>`).join('');
    });
}

window.applyTemplate = function(docId, templateId, isCustom) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;
    let source = isCustom ? (budget.customTemplates || []).find(t => t.id === templateId) : (typeof mBTOG !== 'undefined' ? mBTOG.templates : []).find(t => t.id === templateId);
    if (!source) return alert("Template not found.");

    doc.content = {
        type: 'template',
        templateId: source.id,
        templateLabel: source.label,
        isDynamic: source.isDynamic || false,
        htmlTemplate: source.htmlTemplate || '',
        printCss: source.printCss || '',
        fields: JSON.parse(JSON.stringify(source.fields || {})),
        data: {}
    };

    doc.status = 'In Progress';
    saveBudget();
    closeModal('templatePickerModal');
    setTimeout(() => openDocumentViewer(docId), 200);
};

// ------------ STAGES ------------------------------------------------------ //

/* --- v19.70 [Stages] - Math Engine (DRY Principle) --- */
const mBTStagesEngine = {
    // Returns { grandTotal, stageTotals: {dev: $, ...}, totalCap: $ }
    getMetrics: function() {
        const tl = budget.targetLock || { totalCap: 0, stages: {} };
        const result = {
            grandTotal: 0,
            stageTotals: { dev: 0, pre: 0, prod: 0, post: 0, dist: 0 },
            totalCap: tl.totalCap || 0
        };

        Object.values(budget.sections).forEach(sec => {
            sec.items.forEach(item => {
                if (item.stageData) {
                    Object.entries(item.stageData).forEach(([key, data]) => {
                        const k = key.toLowerCase();
                        if (result.stageTotals[k] !== undefined) {
                            const cost = (parseFloat(data.days) || 0) * (parseFloat(data.rate) || 0);
                            result.stageTotals[k] += cost;
                            result.grandTotal += cost;
                        }
                    });
                }
            });
        });
        return result;
    },

    // Returns Status Object for Ring/Bars
    getBurnStatus: function(current, cap) {
        const pct = cap > 0 ? (current / cap) * 100 : 0;
        if (pct > 100) return { color: 'text-red-600', bg: 'bg-red-500', ring: 'border-red-200', pct };
        if (pct > 85) return { color: 'text-yellow-600', bg: 'bg-blue-500', ring: 'border-yellow-200', pct }; // Blue for "Near Limit" visual
        return { color: 'text-green-600', bg: 'bg-green-500', ring: 'border-green-200', pct };
    }
};

/* --- v19.54 [Stages] - UI Helpers & Database Search --- */

// 1. Open the "Add Item" Modal for a specific stage
window.handleStageAddItem = function(stageKey) {
    // Detect Target Section
    const sectionNames = Object.keys(budget.sections);
    let targetSectionName = null;

    if (stageKey === 'post') targetSectionName = sectionNames.find(s => /post|edit/.test(s.toLowerCase()));
    else if (stageKey === 'dev') targetSectionName = sectionNames.find(s => /development|creative/.test(s.toLowerCase()));
    else if (stageKey === 'pre') targetSectionName = sectionNames.find(s => /pre|staff/.test(s.toLowerCase()));
    else if (stageKey === 'dist') targetSectionName = sectionNames.find(s => /distribution|market/.test(s.toLowerCase()));
    
    // Fallback
    if (!targetSectionName) {
         targetSectionName = sectionNames.find(s => s.toLowerCase().includes('production')) || sectionNames[0];
    }

    if (!targetSectionName) return alert("No budget sections found.");

    const content = `
        <div class="flex flex-col h-[400px]">
            <div class="mb-3">
                <input type="text" id="stageDbSearch" placeholder="Search Database..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm font-bold">
            </div>

            <div id="stageDbList" class="flex-grow overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 mb-3">
                ${renderStageDatabaseList(getGlobalItems(), stageKey, targetSectionName)}
            </div>

            <button id="toggleStageCustomForm" class="text-xs text-blue-600 font-bold hover:underline text-center mb-2">
                + Create Custom Item
            </button>

            <div id="stageCustomForm" class="hidden space-y-3 border-t pt-3 bg-white">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase">Description</label>
                    <input type="text" id="stageCustomDesc" class="w-full p-2 border rounded text-sm" placeholder="Item Name">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Rate</label>
                        <input type="number" id="stageCustomRate" class="w-full p-2 border rounded text-sm text-right" placeholder="0.00">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Unit</label>
                        <select id="stageCustomUnit" class="w-full p-2 border rounded text-sm bg-white">
                            <option>Day</option><option>Flat</option><option>Week</option>
                        </select>
                    </div>
                </div>
                <button id="stageAddCustomBtn" class="w-full py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">Add Item</button>
            </div>
        </div>
    `;

    createModal('stageAdd', `Add to ${budget.targetLock.stages[stageKey].label} <span class='text-gray-400 font-normal text-xs'>(${targetSectionName})</span>`, content, 'max-w-sm');

    // Attach Listeners
    const searchInput = document.getElementById('stageDbSearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const allItems = getGlobalItems();
            const filtered = allItems.filter(i => i.description.toLowerCase().includes(term));
            document.getElementById('stageDbList').innerHTML = renderStageDatabaseList(filtered, stageKey, targetSectionName);
        });
        setTimeout(() => searchInput.focus(), 50);
    }

    const toggleBtn = document.getElementById('toggleStageCustomForm');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', (e) => {
            const form = document.getElementById('stageCustomForm');
            const list = document.getElementById('stageDbList');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                list.classList.add('hidden');
                e.target.textContent = "â† Back to Search";
                document.getElementById('stageCustomDesc').focus();
            } else {
                form.classList.add('hidden');
                list.classList.remove('hidden');
                e.target.textContent = "+ Create Custom Item";
            }
        });
    }

    const addBtn = document.getElementById('stageAddCustomBtn');
    if (addBtn) {
        addBtn.addEventListener('click', () => {
            const desc = document.getElementById('stageCustomDesc').value.trim();
            const rate = parseFloat(document.getElementById('stageCustomRate').value) || 0;
            const unit = document.getElementById('stageCustomUnit').value;
            if(!desc) return;
            
            addStageItemToBudget(desc, rate, unit, stageKey, targetSectionName);
        });
    }
};

// 2. Render Search List
window.renderStageDatabaseList = function(items, stageKey, targetSectionName) {
    if (items.length === 0) return `<div class="p-4 text-center text-xs text-gray-400 italic">No matches found.</div>`;
    
    return items.map((item) => {
        const safeDesc = item.description.replace(/'/g, "\\'");
        return `
        <div onclick="addStageItemToBudget('${safeDesc}', ${item.rate}, '${item.unit}', '${stageKey}', '${targetSectionName}')" 
             class="p-3 border-b border-gray-100 bg-white hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors">
            <div>
                <div class="text-sm font-bold text-gray-700 group-hover:text-blue-700">${item.description}</div>
                <div class="text-[10px] text-gray-400">${item.unit}</div>
            </div>
            <div class="font-mono text-xs text-gray-500 font-bold group-hover:text-blue-600">
                ${formatCurrency(item.rate)}
            </div>
        </div>
    `}).join('');
};

// 3. Logic: Add Item to Budget & Stage
window.addStageItemToBudget = function(desc, rate, unit, stageKey, targetSectionName) {
    const newItem = {
        id: crypto.randomUUID(),
        description: desc,
        quantity: 1,
        unit: unit,
        multiplier: 1,
        rate: rate,
        actual: 0,
        rateType: 'negotiable',
        assignedStage: [stageKey],
        stageData: {} 
    };

    newItem.stageData[stageKey] = { days: 1, rate: rate };

    if(budget.sections[targetSectionName]) {
        budget.sections[targetSectionName].items.push(newItem);
        pushToHistory(`Added '${desc}' to ${targetSectionName}`);
        closeModal('stageAddModal');
        
        saveBudget();
        
        if(document.getElementById('stagesViewModal')) {
            if(typeof updateAllHeaders === 'function') updateAllHeaders(); 
            
            const col = document.querySelector(`.stage-drop-zone[data-stage-key="${stageKey}"]`);
            if(col) {
               const vizItem = { ...newItem, _sDays: 1, _sRate: rate, _sCost: rate, _sec: targetSectionName };
               const wrapper = document.createElement('div');
               wrapper.innerHTML = RenderEngine.stageCard(vizItem, stageKey);
               col.appendChild(wrapper.firstElementChild);
               
               col.scrollTop = col.scrollHeight;
            }
        }
        
        if(typeof render === 'function') render(); 
    }
};

// 4. Logic: Remove Item from Stage (With Math Sync)
window.removeStageItem = function(itemId, sectionName, stageKey) {
    if(!confirm("Remove this item from the stage?")) return;

    // Find the item
    const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
    
    if (item && item.stageData) {
        // 1. DELETE the data for this specific stage
        delete item.stageData[stageKey];

        // 2. SYNC (The Fix)
        // Recalculate the Main Budget immediately.
        // If this was the last stage, syncStageToMain will correctly set qty to 0.
        if (typeof syncStageToMain === 'function') {
            syncStageToMain(item);
        }

        saveBudget();

        // 3. Surgical DOM Removal (No Flicker)
        // We try both selectors to be safe (data-stage and data-stage-key)
        const card = document.querySelector(`.stage-card-item[data-item-id="${itemId}"][data-stage="${stageKey}"]`) 
                  || document.querySelector(`.stage-card-item[data-item-id="${itemId}"][data-stage-key="${stageKey}"]`);
        
        if (card) card.remove();

        // 4. Update Header Totals
        if(typeof window.updateAllHeaders === 'function') {
            window.updateAllHeaders();
        }

        // 5. Update Background Budget
        if(typeof render === 'function') render(); 
    }
};

// 5. Logic: Update Stage Item (Syncs Days & Rates to Main Budget)
window.updateStageItem = function(itemId, sectionName, stageKey, field, value) {
    const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
    
    if (item && item.stageData && item.stageData[stageKey]) {
        // 1. Update Data
        item.stageData[stageKey][field] = parseFloat(value) || 0;
        
        // 2. Sync to Main Budget (Run on BOTH days and rate changes)
        if (typeof syncStageToMain === 'function') syncStageToMain(item);

        // 3. Visuals (Card Cost)
        const d = item.stageData[stageKey];
        const cost = (parseFloat(d.days) || 0) * (parseFloat(d.rate) || 0);
        
        const costEl = document.getElementById(`cost-${itemId}-${stageKey}`);
        if(costEl) costEl.textContent = formatAbbreviated(cost, displayCurrency);

        // 4. Global Updates & Background Refresh
        if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
        saveBudget();
        
        // Triggers the Main Budget table to repaint with new totals immediately
        if(typeof render === 'function') render();
    }
};

/* --- v19.54 [Stages] - Logic V3 (Restored) --- */

// 1. Proportional Slider Balancing
function balanceStageSliders(changedKey, newValue) {
    const stages = budget.targetLock.stages;
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    
    newValue = parseFloat(newValue);
    if (isNaN(newValue)) newValue = 0;
    
    const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
    const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
    
    const lockedTotal = lockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
    const maxAvailable = 100 - lockedTotal;
    
    if (newValue > maxAvailable) newValue = maxAvailable;
    if (newValue < 0) newValue = 0;
    
    stages[changedKey].ratio = newValue;
    
    const remaining = Math.max(0, 100 - newValue - lockedTotal);
    
    if (unlockedKeys.length > 0) {
        const currentUnlockedTotal = unlockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
        unlockedKeys.forEach(k => {
            let newRatio;
            if (currentUnlockedTotal <= 0.01) {
                newRatio = remaining / unlockedKeys.length;
            } else {
                const share = stages[k].ratio / currentUnlockedTotal;
                newRatio = remaining * share;
            }
            stages[k].ratio = newRatio;
        });
    }
}

// 2. Preset Handler
window.applyStagePreset = function(presetName) {
    const ratios = STAGE_PRESETS[presetName];
    if (!ratios) return;
    Object.keys(ratios).forEach(k => {
        if (budget.targetLock.stages[k]) {
            budget.targetLock.stages[k].ratio = ratios[k];
            budget.targetLock.stages[k].locked = false;
        }
    });
    if(typeof updateAllHeaders === 'function') updateAllHeaders();
    pushToHistory(`Applied ${presetName} preset`);
};

/* --- v19.54 [Stages] - Main Dashboard UI (Enhanced Nav) --- */
function showStagesModal() {
    try {
        // 1. Initialize Data
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        
        const STAGE_LABELS = {
            dev: 'Development', pre: 'Pre-Production', prod: 'Production', post: 'Post-Production', dist: 'Distribution'
        };

        // Ensure defaults
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

        // 2. Aggregate Data
        const stageData = {};
        validKeys.forEach(k => stageData[k] = { items: [], total: 0 });
        let grandTotal = 0;
        const allItemsFlat = [];

        Object.entries(budget.sections).forEach(([sectionName, section]) => {
            section.items.forEach(item => {
                if (!item.stageData) { 
                    item.stageData = {};
                    if (item.assignedStage) {
                        const targets = Array.isArray(item.assignedStage) ? item.assignedStage : [item.assignedStage];
                        targets.forEach(t => { if(validKeys.includes(t)) item.stageData[t] = { days: item.quantity, rate: item.rate }; });
                    } 
                    if (Object.keys(item.stageData).length === 0) {
                        let target = 'prod';
                        const lower = item.description.toLowerCase();
                        if (/post|edit|vfx|sound|color/.test(lower)) target = 'post';
                        else if (/pre|cast|scout|recc/.test(lower)) target = 'pre';
                        else if (/dev|write|script|pitch|story/.test(lower)) target = 'dev';
                        else if (/dist|market|fest/.test(lower)) target = 'dist';
                        item.stageData[target] = { days: item.quantity, rate: item.rate };
                    }
                }
                Object.entries(item.stageData).forEach(([k, d]) => {
                    if (validKeys.includes(k)) {
                        const cost = (parseFloat(d.days)||0) * (parseFloat(d.rate)||0);
                        stageData[k].items.push({...item, _sDays:d.days, _sRate:d.rate, _sCost:cost, _sec:sectionName});
                        stageData[k].total += cost;
                        grandTotal += cost;
                        if (cost > 0) allItemsFlat.push({ desc: item.description, cost: cost, stage: STAGE_LABELS[k] });
                    }
                });
            });
        });

        const topSpenders = allItemsFlat.sort((a, b) => b.cost - a.cost).slice(0, 5);

   // 3. Render Helper: Setup Card (v19.71 - Better Spacing)
        const renderSetupCard = () => `
            <div id="card-setup" class="stage-card min-w-[300px] flex-shrink-0 h-full bg-white border-r border-gray-200 flex flex-col snap-center relative">
                <div class="px-3 py-2 bg-gray-900 text-white flex-shrink-0 flex justify-between items-center">
                    <h3 class="text-xs font-bold uppercase tracking-widest">Setup</h3>
                    <button onclick="toggleBulkActionsMenu()" class="text-gray-400 hover:text-white transition-colors">âš™ï¸</button>
                </div>
                
                <div id="bulkActionsMenu" class="hidden absolute top-8 right-2 w-48 bg-white border border-gray-200 shadow-xl rounded-lg z-50 overflow-hidden text-left">
                    <div class="p-2 border-b border-gray-100 text-[10px] font-bold text-gray-400 uppercase bg-gray-50">Bulk Actions</div>
                    <button onclick="handleStageBulkAction('syncDays')" class="w-full text-left px-4 py-2 text-xs font-bold text-gray-700 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-2"><span>ðŸ“…</span> Sync Days</button>
                    <button onclick="handleStageBulkAction('dedupe')" class="w-full text-left px-4 py-2 text-xs font-bold text-gray-700 hover:bg-red-50 hover:text-red-600 flex items-center gap-2"><span>ðŸ§¹</span> Remove Dupes</button>
                    <div class="border-t border-gray-100 my-1"></div>
                    <button onclick="handleStageBulkAction('lockAll')" class="w-full text-left px-4 py-2 text-xs font-bold text-gray-700 hover:bg-gray-50 flex items-center gap-2"><span>ðŸ”’</span> Lock All</button>
                    <button onclick="handleStageBulkAction('unlockAll')" class="w-full text-left px-4 py-2 text-xs font-bold text-gray-700 hover:bg-gray-50 flex items-center gap-2"><span>ðŸ”“</span> Unlock All</button>
                </div>
                
                <div class="px-3 py-2 space-y-3 flex-grow overflow-y-auto" onclick="document.getElementById('bulkActionsMenu').classList.add('hidden')">
                    
                    <div class="space-y-2 border-b border-gray-100 pb-2">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Total Cap</label>
                            <div class="flex items-center gap-1 w-32 border-b border-gray-300">
                                <span class="text-sm text-gray-400">$</span>
                                <input id="tlTotalCapInput" type="number" value="${tl.totalCap}" class="bg-transparent text-sm font-bold w-full outline-none text-gray-800 text-right" onchange="budget.targetLock.totalCap=parseFloat(this.value); updateAllHeaders(); saveBudget();">
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <select id="distPresetSelect" class="text-[10px] border rounded px-1 py-0.5 flex-grow bg-white focus:ring-1 focus:ring-blue-500 outline-none h-6">
                                <option value="" disabled selected>Auto-Distribute...</option>
                                ${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}
                            </select>
                            <button onclick="applyStagePreset(document.getElementById('distPresetSelect').value)" class="bg-blue-50 text-blue-600 border border-blue-100 px-2 h-6 rounded text-[10px] font-bold hover:bg-blue-100">Apply</button>
                        </div>
                    </div>

                    <div class="space-y-1">
                        ${validKeys.map(k => `
                        <div class="bg-gray-50 px-2 py-1.5 rounded border border-gray-100 relative stage-control-group hover:border-gray-300 transition-colors" data-key="${k}">
                            <div class="flex justify-between items-center mb-0.5">
                                <div class="flex items-center gap-3">
                                    <button onclick="toggleStageLock('${k}', this)" class="text-gray-400 hover:text-blue-600 w-3 focus:outline-none lock-btn transition-transform active:scale-90" title="Lock Stage">${tl.stages[k].locked ? 'ðŸ”’' : 'ðŸ”“'}</button>
                                    <span class="text-[10px] font-bold text-gray-700 uppercase tracking-tight">${STAGE_LABELS[k]}</span>
                                </div>
                                <span class="text-[9px] font-mono font-bold text-gray-500" id="disp_amt_${k}"></span>
                            </div>
                            
                            <div class="flex items-center gap-2 h-5">
                                <div class="relative flex-grow h-full flex items-center">
                                    <div class="absolute inset-x-0 h-1.5 bg-gray-200 rounded-full overflow-hidden z-0"></div>
                                    
                                    <div id="setup_bar_${k}" class="absolute left-0 h-1.5 rounded-full transition-all duration-300 z-0 bg-green-500" style="width: 0%"></div>

                                    <input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" 
                                           class="stage-slider absolute inset-0 w-full h-full appearance-none bg-transparent z-10 cursor-pointer focus:outline-none
                                                  [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-3.5 [&::-webkit-slider-thumb]:w-3.5 
                                                  [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white 
                                                  [&::-webkit-slider-thumb]:border-[1.5px] [&::-webkit-slider-thumb]:border-gray-400 
                                                  [&::-webkit-slider-thumb]:shadow-sm [&::-webkit-slider-thumb]:mt-[-1px]"
                                           ${tl.stages[k].locked ? 'disabled' : ''}>
                                </div>

                                <div class="relative w-9 flex-shrink-0">
                                    <input type="number" id="setup_perc_${k}" value="${tl.stages[k].ratio.toFixed(1)}" data-stage-key="${k}" 
                                           class="stage-number-input w-full text-right text-[10px] font-bold bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none p-0" 
                                           ${tl.stages[k].locked ? 'disabled' : ''}>
                                    <span class="absolute -right-1 top-0 text-[8px] text-gray-400 scale-75">%</span>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                    
                    <div class="text-center text-[9px] text-gray-400 pt-1 border-t border-gray-100" id="totalRatioDisplay">Total: 100%</div>
                </div>
            </div>`;

       // 4. Render Helper: Overview Card (Time Analysis)
        const renderOverviewCard = () => {
            const burnRate = tl.totalCap > 0 ? (grandTotal / tl.totalCap) * 100 : 0;
            const burnColor = burnRate > 100 ? 'text-red-600' : (burnRate > 85 ? 'text-yellow-600' : 'text-green-600');
            const ringColor = burnRate > 100 ? 'border-red-200' : (burnRate > 85 ? 'border-yellow-200' : 'border-green-200');
            
            // --- TIME ANALYSIS LOGIC ---
            const timeData = {};
            Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                if (!timeData[i.id]) timeData[i.id] = { name: i.description, days: 0, stages: [] };
                
                if (i.stageData) {
                    Object.entries(i.stageData).forEach(([k, d]) => {
                        if (parseFloat(d.days) > 0) {
                            timeData[i.id].days += parseFloat(d.days);
                            if (!timeData[i.id].stages.includes(k.toUpperCase())) timeData[i.id].stages.push(k.toUpperCase());
                        }
                    });
                } else {
                    timeData[i.id].days += parseFloat(i.quantity) || 0;
                }
            }));

            // Sort by Days (Descending)
            const topTimeConsumers = Object.values(timeData)
                .filter(x => x.days > 0)
                .sort((a, b) => b.days - a.days)
                .slice(0, 5);

            const maxDays = topTimeConsumers[0]?.days || 1;

            return `
            <div id="card-overview" class="stage-card min-w-[300px] flex-shrink-0 h-full bg-gray-50 border-r border-gray-200 flex flex-col snap-center">
                <div class="p-6 flex flex-col items-center text-center border-b border-gray-200 bg-white">
                    <div id="burnRateRing" class="w-32 h-32 rounded-full border-8 ${ringColor} flex items-center justify-center mb-2 relative transition-colors duration-500">
                        <div id="burnRateText" class="text-3xl font-bold ${burnColor}">${Math.round(burnRate)}%</div>
                        <div class="absolute text-[9px] text-gray-400 bottom-6 uppercase tracking-wider">Burn Rate</div>
                    </div>
                    <h3 class="text-base font-bold text-gray-800">Budget Health</h3>
                    <p class="text-xs text-gray-500 mt-1">Est: <strong id="ovGrandTotal">${formatAbbreviated(grandTotal, displayCurrency)}</strong> / Cap: <strong id="ovTotalCap">${formatAbbreviated(tl.totalCap, displayCurrency)}</strong></p>
                </div>
                
                <div class="p-4 flex-grow overflow-y-auto flex flex-col">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Longest Engagements (Days)</h4>
                    
                    <div class="space-y-3 bg-white p-3 rounded border border-gray-200 shadow-sm flex-grow mb-4">
                        ${topTimeConsumers.map((item, idx) => {
                            const w = (item.days / maxDays) * 100;
                            return `
                            <div>
                                <div class="flex justify-between items-center text-[10px] mb-1">
                                    <span class="font-bold text-gray-700 w-4">${idx+1}.</span>
                                    <span class="font-bold text-gray-600 truncate flex-grow">${item.name}</span>
                                    <span class="font-mono font-bold text-blue-600">${item.days}d</span>
                                </div>
                                <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${w}%"></div>
                                </div>
                                <div class="text-[8px] text-gray-400 text-right mt-0.5">${item.stages.join('/')}</div>
                            </div>`;
                        }).join('')}
                        ${topTimeConsumers.length === 0 ? '<div class="text-center text-xs text-gray-400 italic">No days scheduled</div>' : ''}
                    </div>

                    <button onclick="openAnalyticsHub()" 
                            class="w-full py-3 bg-white hover:bg-blue-50 text-blue-600 font-bold rounded-lg border border-gray-200 hover:border-blue-200 shadow-sm flex items-center justify-center gap-2 transition-all group mt-auto">
                        <span class="bg-blue-100 text-blue-600 p-1 rounded group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        </span>
                        <span class="text-xs">Open Analytics Hub</span>
                    </button>
                </div>
            </div>`;
        };

        // 5. Render Helper: Individual Stage Columns
        const renderStageColumn = (key) => {
            const config = tl.stages[key];
            const data = stageData[key];
            const cap = tl.totalCap * (config.ratio / 100);
            return `
            <div id="card-${key}" class="stage-card min-w-[300px] w-full sm:w-[320px] flex-shrink-0 flex flex-col h-full bg-white border-r border-gray-200 snap-center">
                <div class="p-2 bg-white border-b border-gray-100 flex-shrink-0 sticky top-0 z-20 shadow-sm stage-header-group" data-key="${key}">
                    <div class="flex justify-between items-center mb-2 h-7">
                        <div class="flex items-center gap-1.5 overflow-hidden">
                            <button onclick="toggleStageLock('${key}', this)" class="text-gray-400 hover:text-blue-600 flex-shrink-0 focus:outline-none lock-btn" title="Lock">${config.locked ? 'ðŸ”’' : 'ðŸ”“'}</button>
                            <span class="font-bold text-gray-800 text-xs truncate" title="${STAGE_LABELS[key]}">${STAGE_LABELS[key]}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative w-12 h-6 flex items-center bg-gray-50 border border-gray-200 rounded px-1">
                                <input type="number" id="header_perc_${key}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-transparent focus:outline-none no-spinner pr-2" data-stage-key="${key}" ${config.locked ? 'disabled style="opacity:0.5"' : ''} onfocus="this.select()">
                                <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-gray-400 select-none">%</span>
                            </div>
                            <div class="flex items-center h-6 bg-gray-50 border border-gray-200 rounded px-1.5">
                                <span class="text-[8px] text-gray-400 uppercase mr-1 font-bold">Days:</span>
                                <input type="number" value="${config.days}" data-global-days="${key}" class="w-8 text-center text-[10px] bg-transparent font-bold text-blue-600 focus:outline-none no-spinner" onfocus="this.dataset.old=this.value; this.value=''" onblur="if(this.value===''){this.value=this.dataset.old; this.dispatchEvent(new Event('input'));} else { updateGlobalDays('${key}', this.value); }">
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mb-1 overflow-hidden"><div id="bar-${key}" class="bg-blue-500 h-1 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                    <div class="flex justify-between text-[9px] text-gray-400 font-mono mb-1"><span id="total-${key}">${formatAbbreviated(data.total, displayCurrency)}</span><span id="limit-${key}">Cap: ${formatAbbreviated(cap, displayCurrency)}</span></div>
                    <button onclick="handleStageAddItem('${key}')" class="w-full py-1 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded text-[10px] font-bold border border-blue-100 transition-colors">+ Item</button>
                </div>
                <div class="stage-drop-zone flex-grow overflow-y-auto p-2 space-y-2 bg-gray-50 h-full" data-stage-key="${key}">
                    ${data.items.map(item => RenderEngine.stageCard(item, key)).join('')}
                </div>
            </div>`;
        };

    // 6. Main Modal Content
        const content = `
            <div class="flex flex-col h-[80vh] sm:h-[600px] w-full max-w-[95vw] bg-white rounded-xl shadow-2xl overflow-hidden relative">
                <div id="stageSearchOverlay" class="absolute inset-0 bg-black/50 z-[100] hidden flex items-start justify-center pt-10"></div>
                
                <div class="flex items-center gap-2 overflow-x-auto h-8 px-2 bg-gray-50 border-b flex-shrink-0 no-scrollbar relative z-30">
                    <button onclick="document.getElementById('card-setup').scrollIntoView({behavior:'smooth', inline:'center'})" 
                            class="text-[10px] font-bold uppercase text-gray-500 hover:text-blue-600 px-2 whitespace-nowrap">SETUP</button>
                    <button onclick="document.getElementById('card-overview').scrollIntoView({behavior:'smooth', inline:'center'})" 
                            class="text-[10px] font-bold uppercase text-gray-500 hover:text-blue-600 px-2 whitespace-nowrap">OVERVIEW</button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    ${validKeys.map(k => `
                        <button onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'})" 
                                class="text-[10px] font-bold uppercase text-gray-500 hover:text-blue-600 px-2 whitespace-nowrap">
                            ${k.toUpperCase()}
                        </button>
                    `).join('')}
                </div>

                <div class="flex-grow relative overflow-hidden">
                    <div id="stagesCarousel" class="flex flex-row overflow-x-auto h-full snap-x snap-mandatory scroll-smooth no-scrollbar">
                        ${renderSetupCard()}
                        ${renderOverviewCard()}
                        ${validKeys.map(k => renderStageColumn(k)).join('')}
                    </div>

                    </div>
            </div>`;

/* --- P5 --- */
// Analytics Hub
window.openAnalyticsHub = function() {
    // 1. Data Crunching
    let allItems = [];
    let deptTotals = {};
    let grandTotal = 0;

    // Calculate totals based on STAGE DATA (More accurate than main budget)
    Object.entries(budget.sections).forEach(([secName, section]) => {
        let secTotal = 0;
        section.items.forEach(item => {
            let itemTotal = 0;
            // Sum up active stages
            if (item.stageData) {
                Object.values(item.stageData).forEach(d => {
                    itemTotal += (parseFloat(d.days) || 0) * (parseFloat(d.rate) || 0);
                });
            } else {
                // Fallback for non-staged items
                itemTotal = (item.quantity * item.rate);
            }

            if (itemTotal > 0) {
                grandTotal += itemTotal;
                secTotal += itemTotal;
                allItems.push({ name: item.description, sec: secName, total: itemTotal });
            }
        });
        if (secTotal > 0) deptTotals[secName] = secTotal;
    });

    // Sort Drivers by TOTAL (Descending)
    allItems.sort((a, b) => b.total - a.total);
    const topDrivers = allItems.slice(0, 10); // Top 10 items

    // Sort Depts by TOTAL
    const topDepts = Object.entries(deptTotals)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 6); 

    // 2. Build Content
    const content = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-2 h-[500px] overflow-y-auto">
        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
            <h3 class="text-sm font-bold text-gray-800 uppercase mb-4 flex items-center gap-2">
                <span class="bg-red-100 text-red-600 p-1 rounded">âš ï¸</span> Primary Cost Drivers
            </h3>
            <div class="space-y-3">
                ${topDrivers.map((item, idx) => {
                    const percent = ((item.total / grandTotal) * 100).toFixed(1);
                    return `
                    <div class="relative text-xs">
                        <div class="flex justify-between items-end mb-1 relative z-10">
                            <span class="font-bold text-gray-700">${idx+1}. ${item.name}</span>
                            <div class="text-right">
                                <span class="font-bold block text-gray-900">${formatAbbreviated(item.total, displayCurrency)}</span>
                                <span class="text-[10px] text-gray-400">${percent}%</span>
                            </div>
                        </div>
                        <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-red-400" style="width: ${percent * 4}%"></div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
            <h3 class="text-sm font-bold text-gray-800 uppercase mb-4 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 p-1 rounded">ðŸ°</span> Dept. Breakdown
            </h3>
            <div class="space-y-4">
                ${topDepts.map(([name, total]) => {
                    const percent = ((total / grandTotal) * 100).toFixed(1);
                    return `
                    <div class="text-xs">
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-600">${name}</span>
                            <span class="font-bold text-gray-900">${percent}%</span>
                        </div>
                        <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden flex">
                            <div class="h-full bg-blue-600" style="width: ${percent}%"></div>
                        </div>
                        <div class="text-right text-[10px] text-gray-400 mt-0.5">${formatAbbreviated(total, displayCurrency)}</div>
                    </div>`;
                }).join('')}
            </div>
        </div>
    </div>`;

    // 3. Open Modal
    createModal('analyticsHub', 'Budget Intelligence', content, 'max-w-4xl');
};

        // 7. Launch Modal with Special Overrides
        createModal('stagesView', '', content, 'max-w-none w-fit bg-transparent shadow-none');
        
        // --- Modal Engine Override ---
        const header = document.querySelector('#stagesViewModal .bg-gray-50.border-b');
        if(header) header.style.display = 'none';
        const body = document.getElementById('stagesViewBody');
        if(body) body.style.padding = '0';

        // 8. Bind Interactions
        setTimeout(() => {
            const bindInput = (el, isInput) => {
                el.addEventListener(isInput ? 'change' : 'input', (e) => {
                    balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                    updateAllHeaders(); 
                });
            };
            document.querySelectorAll('.stage-slider').forEach(el => bindInput(el, false));
            document.querySelectorAll('.stage-number-input').forEach(el => bindInput(el, true));

           window.updateAllHeaders = () => {
                // 1. Get Fresh Math from Engine (DRY)
                const metrics = mBTStagesEngine.getMetrics();
                const activeEl = document.activeElement;
                let totalSliderPct = 0;
                
                validKeys.forEach(key => {
                    const cfg = budget.targetLock.stages[key];
                    // Calculate Cap based on TOTAL CAP * SLIDER %
                    const cap = metrics.totalCap * (cfg.ratio / 100);
                    const liveTotal = metrics.stageTotals[key]; // From Engine
                    totalSliderPct += cfg.ratio;
                    
                    // --- A. Sync Inputs (Prevent fighting the user while typing) ---
                    const sIn = document.querySelector(`.stage-slider[data-stage-key="${key}"]`);
                    const nIn = document.getElementById(`setup_perc_${key}`);
                    const hIn = document.getElementById(`header_perc_${key}`);
                    if(sIn && activeEl !== sIn) sIn.value = cfg.ratio;
                    if(nIn && activeEl !== nIn) nIn.value = cfg.ratio.toFixed(1);
                    if(hIn && activeEl !== hIn) hIn.value = cfg.ratio.toFixed(1);
                    
                    // --- B. Text Displays ---
                    const dispAmt = document.getElementById(`disp_amt_${key}`);
                    if(dispAmt) dispAmt.textContent = formatAbbreviated(cap, displayCurrency);
                    
                    const limitEl = document.getElementById(`limit-${key}`);
                    if(limitEl) limitEl.textContent = `Cap: ${formatAbbreviated(cap, displayCurrency)}`;
                    
                    const totalEl = document.getElementById(`total-${key}`);
                    if(totalEl) totalEl.textContent = formatAbbreviated(liveTotal, displayCurrency);
                    
                    // --- C. THERMOMETER LOGIC (SETUP CARD) ---
                    const setupBar = document.getElementById(`setup_bar_${key}`);
                    if (setupBar) {
                        // Calculate % of the TOTAL CAP used by this stage
                        const globalPct = metrics.totalCap > 0 ? (liveTotal / metrics.totalCap) * 100 : 0;
                        setupBar.style.width = `${Math.min(globalPct, 100)}%`;
                        
                        // Compare Usage vs Slider Limit
                        let colorClass = 'bg-green-500'; // Default: Safe (Green)
                        let shadowClass = '';

                        if (globalPct > cfg.ratio) {
                            // Over Limit -> Red
                            colorClass = 'bg-red-500'; 
                            shadowClass = 'shadow-[0_0_8px_rgba(239,68,68,0.6)]';
                        } else if (globalPct >= (cfg.ratio * 0.95)) {
                            // Within 95% of Limit -> Blue
                            colorClass = 'bg-blue-500';
                        }
                        
                        setupBar.className = `absolute left-0 h-2 rounded-full transition-all duration-300 z-0 ${colorClass} ${shadowClass}`;
                    }

                    // --- D. Header Bars (Mini) ---
                    const headerBar = document.getElementById(`bar-${key}`);
                    if(headerBar) {
                        const w = cap > 0 ? (liveTotal / cap) * 100 : 0;
                        headerBar.style.width = `${Math.min(w, 100)}%`;
                        headerBar.className = `h-1 rounded-full transition-all duration-300 ${w > 100 ? 'bg-red-500' : 'bg-blue-500'}`;
                    }
                });

                // --- E. Update Overview Ring ---
                const status = mBTStagesEngine.getBurnStatus(metrics.grandTotal, metrics.totalCap);
                
                const ovTotal = document.getElementById('ovGrandTotal');
                const ovCap = document.getElementById('ovTotalCap');
                if(ovTotal) ovTotal.textContent = formatAbbreviated(metrics.grandTotal, displayCurrency);
                if(ovCap) ovCap.textContent = formatAbbreviated(metrics.totalCap, displayCurrency);
                
                const ring = document.getElementById('burnRateRing');
                const ringTxt = document.getElementById('burnRateText');
                if(ringTxt && ring) {
                    ringTxt.textContent = Math.round(status.pct) + '%';
                    ringTxt.className = `text-3xl font-bold ${status.color}`;
                    ring.className = `w-32 h-32 rounded-full border-8 ${status.ring} flex items-center justify-center mb-2 relative transition-colors duration-500`;
                }

                // --- F. Total Ratio Warning ---
                const totDisp = document.getElementById('totalRatioDisplay');
                if(totDisp) {
                    const rounded = Math.round(totalSliderPct);
                    totDisp.textContent = `Total: ${rounded}%`;
                    totDisp.className = `text-center text-[10px] mt-2 font-bold ${rounded === 100 ? 'text-green-600' : 'text-red-500'}`;
                }
            };
            
            window.toggleBulkActionsMenu = () => document.getElementById('bulkActionsMenu').classList.toggle('hidden');
            window.toggleStageLock = (key) => {
                budget.targetLock.stages[key].locked = !budget.targetLock.stages[key].locked;
                saveBudget();
                showStagesModal(); // Full redraw
            };
            window.updateGlobalDays = (key, val) => { budget.targetLock.stages[key].days = parseFloat(val)||0; saveBudget(); updateAllHeaders(); };
            
            updateAllHeaders(); 
            initializeStageDragAndDrop();
        }, 50);

    } catch(err) { console.error(err); }
}

// Global Bulk Action Handler
window.handleStageBulkAction = function(action) {
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    let changed = false;
    
    if (action === 'lockAll' || action === 'unlockAll') {
        const isLocked = (action === 'lockAll');
        validKeys.forEach(k => budget.targetLock.stages[k].locked = isLocked);
        changed = true;
    }
    else if (action === 'syncDays') {
        if(confirm("Sync Days will overwrite individual item days with the Stage Days setting. Continue?")) {
            validKeys.forEach(k => {
                const targetDays = budget.targetLock.stages[k].days;
                if(targetDays > 0) {
                    Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                        if(i.stageData && i.stageData[k]) {
                            i.stageData[k].days = targetDays;
                        }
                    }));
                }
            });
            changed = true;
        }
    } 
    else if (action === 'dedupe') {
        if(confirm("Remove duplicates? This keeps only the first instance of an item in each stage.")) {
            validKeys.forEach(k => {
                const seen = new Set();
                Object.values(budget.sections).forEach(sec => {
                    sec.items.forEach(i => {
                        if(i.stageData && i.stageData[k]) {
                            const key = i.description.toLowerCase();
                            if(seen.has(key)) delete i.stageData[k]; 
                            else seen.add(key);
                        }
                    });
                });
            });
            changed = true;
        }
    }
    
    const menu = document.getElementById('bulkActionsMenu');
    if(menu) menu.classList.add('hidden');
    
    if (changed) {
        saveBudget();
        showStagesModal(); // Redraw UI
        render(); // Update main budget
    }
};



/* --- Navigation Helpers --- */
window.scrollToStageCard = (id) => { document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); updateActiveNav(id); };
window.scrollCarousel = (dir) => { const c = document.getElementById('stagesCarousel'); c.scrollBy({ left: dir === 'left' ? -300 : 300, behavior: 'smooth' }); };
const updateActiveNav = (activeId) => {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        const isActive = btn.dataset.target === activeId;
        btn.className = isActive ? "nav-btn px-3 py-0.5 text-[10px] font-bold uppercase tracking-wider bg-gray-800 text-white rounded-sm shadow-sm transition-colors whitespace-nowrap" : "nav-btn px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider text-gray-500 hover:bg-gray-200 rounded-sm transition-colors whitespace-nowrap";
    });
};


/* --- v19.61 Boot Sequence --- */
function init() {
    document.title = `mooBudgetTool v${APP_VERSION}`;
    displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
    fetchExchangeRates();

    let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
    if (!projectToLoad || !getProjectList().includes(projectToLoad)) projectToLoad = getProjectList()[0];
    
    // Safety check for first run
    if (!projectToLoad) handleNewProject(false);
    else loadBudget(projectToLoad);
    
    render();
    bindAppEventListeners();
    
    document.addEventListener('click', (e) => {
        if(!e.target.closest('.crew-wrapper')) {
            document.querySelectorAll('.crew-wrapper').forEach(div => div.classList.remove('mobile-active'));
        }
    });
}

/* --- v19.55 Contacts Manager (Open Gate Integration) --- */

const getGlobalContacts = () => JSON.parse(localStorage.getItem('moo_contacts') || '[]');
const saveGlobalContacts = (list) => localStorage.setItem('moo_contacts', JSON.stringify(list));

function renderContactsList(list) {
    if (list.length === 0) return '<div class="p-4 text-center text-gray-400 text-xs">No contacts yet. Add one or Import CSV.</div>';
    return list.map((c, i) => `
        <div class="flex justify-between items-center p-2 border-b hover:bg-gray-50 text-sm group">
            <div class="flex-1 min-w-0">
                <div class="font-bold text-gray-800 truncate">${c.name}</div>
                <div class="text-xs text-gray-500 truncate">${c.role} â€¢ ${c.contact || '-'}</div>
            </div>
            <button onclick="deleteContact(${i})" class="text-gray-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
        </div>
    `).join('');
}

function bindContactsEvents() {
    document.getElementById('addContactForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('cName').value.trim();
        const role = document.getElementById('cRole').value.trim();
        const contact = document.getElementById('cContact').value.trim();
        if (name && role) {
            const list = getGlobalContacts();
            list.unshift({ name, role, contact });
            saveGlobalContacts(list);
            window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
        }
    });

    document.getElementById('contactSearch')?.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const all = getGlobalContacts();
        const filtered = all.filter(c => c.name.toLowerCase().includes(term) || c.role.toLowerCase().includes(term));
        document.getElementById('contactsListBody').innerHTML = renderContactsList(filtered);
    });
}

window.deleteContact = function(idx) {
    if(confirm("Delete contact?")) {
        const list = getGlobalContacts();
        list.splice(idx, 1);
        saveGlobalContacts(list);
        window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
    }
};

window.importContactsCSV = function(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split('\n');
        const list = getGlobalContacts();
        let added = 0;
        lines.forEach(line => {
            const cols = line.split(','); 
            if (cols.length >= 2) {
                const name = cols[0].trim();
                const role = cols[1].trim();
                const contact = cols[2] ? cols[2].trim() : '';
                if (name && role && name.toLowerCase() !== 'name') { 
                    list.push({ name, role, contact });
                    added++;
                }
            }
        });
        saveGlobalContacts(list);
        alert(`Imported ${added} contacts.`);
        window.switchSettingsTab('contacts', document.querySelector('button[onclick*="contacts"]'));
    };
    reader.readAsText(file);
};

window.autoAssignRolesFromContacts = function() {
    if(!budget) return;
    const contacts = getGlobalContacts();
    if(contacts.length === 0) return alert("Contact database is empty.");
    
    let matched = 0;
    Object.values(budget.sections).forEach(section => {
        section.items.forEach(item => {
            if (!item.crew || !item.crew.name) {
                const desc = item.description.toLowerCase();
                const match = contacts.find(c => desc.includes(c.role.toLowerCase()));
                if (match) {
                    item.crew = { 
                        name: match.name, 
                        phone: match.contact.includes('@') ? '' : match.contact, 
                        email: match.contact.includes('@') ? match.contact : '' 
                    };
                    matched++;
                }
            }
        });
    });
    
    if (matched > 0) {
        pushToHistory(`Auto-assigned ${matched} roles from Open Gate`);
        render();
        alert(`Success! Assigned ${matched} crew members.`);
    } else {
        alert("No matching roles found in current budget.");
    }
};

/* --- v19.54 [Stages] - Drag & Drop V17 (Zero-Flicker + Safe Rewire) --- */
function initializeStageDragAndDrop() {
    const containers = document.querySelectorAll('.stage-drop-zone');
    
    containers.forEach(container => {
        if (container._sortableStage) return;

        container._sortableStage = new Sortable(container, {
            group: {
                name: 'stages-shared',
                pull: 'clone', 
                put: true
            },
            animation: 0, 
            ghostClass: 'bg-blue-50',
            dragClass: 'opacity-90',
            sort: false, 
            
            // --- HYBRID TOUCH SETTINGS (Restored) ---
            delay: 150,               // Prevents accidental drags on mobile
            delayOnTouchOnly: true,   // Keeps desktop dragging instant
            // ----------------------------------------

            // Prevent dragging when clicking inputs/buttons
            filter: 'input, button', 
            preventOnFilter: false,

            onEnd: function (evt) {
                const newStageKey = evt.to.dataset.stageKey;
                const oldStageKey = evt.from.dataset.stageKey;
                const itemId = evt.item.dataset.itemId;

                if (!newStageKey || newStageKey === oldStageKey) return; 

                // 1. Data Logic
                let foundItem = null;
                for (const section of Object.values(budget.sections)) {
                    foundItem = section.items.find(i => i.id === itemId);
                    if (foundItem) break;
                }

                if (foundItem) {
                    if (!foundItem.stageData) foundItem.stageData = {};
                    
                    // Deep Freeze: Copy values, break link
                    const source = foundItem.stageData[oldStageKey] || { days: foundItem.quantity, rate: foundItem.rate };
                    foundItem.stageData[newStageKey] = { 
                        days: parseFloat(source.days) || 0, 
                        rate: parseFloat(source.rate) || 0 
                    };

                    // Sync & Save
                    if(typeof syncStageToMain === 'function') syncStageToMain(foundItem);
                    saveBudget(); 

                    // --- 2. DOM REFRESH (With Timing Fix) ---
                    // We wait 10ms to let Sortable finish placing the clone.
                    setTimeout(() => {
                        const droppedCard = evt.to.querySelector(`.stage-card-item[data-item-id="${itemId}"]`);
                        if (droppedCard) {
                            // Generate Fresh HTML
                            const freshHtml = RenderEngine.stageCard(foundItem, newStageKey);
                            
                            // Swap
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = freshHtml;
                            droppedCard.replaceWith(tempDiv.firstElementChild);
                        }
                    }, 10);
                    
                    // 3. Global Updates
                    if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
                    if(typeof render === 'function') render(); 
                }
            }
        });
    });
}

/// Helper: Sync Stage Totals (Days & Cost) to Main Budget
// Handles "Blended Rates" correctly (Total Cost / Total Days)
function syncStageToMain(item) {
    if (!item || !item.stageData) return;
    
    const stageKeys = Object.keys(item.stageData);
    if (stageKeys.length === 0) return;

    // 1. Calculate Real Totals & Detect Rate Variance
    let totalDays = 0;
    let totalCost = 0;
    let uniqueRates = new Set(); 

    stageKeys.forEach(key => {
        const d = item.stageData[key];
        const days = parseFloat(d.days) || 0;
        const rate = parseFloat(d.rate) || 0;
        
        if (days > 0) {
            totalDays += days;
            totalCost += (days * rate);
            uniqueRates.add(rate); // Track unique rates (e.g., 25k and 50k)
        }
    });

    // 2. Update Master Quantity
    item.quantity = totalDays;

    // 3. Update Master Rate (The "Effective/Blended Rate")
    // Scenario: 200k cost / 6 days = 33.33k Rate
    if (totalDays > 0) {
        item.rate = totalCost / totalDays;
    } else {
        item.rate = 0;
    }

    // 4. Set Flag for UI Renderer
    // If uniqueRates has more than 1 entry (e.g. 25k AND 50k), it's a mixed rate.
    item.isMixedRate = (uniqueRates.size > 1);
}

/* --- v19.54 Document Builder Entry Point --- */
window.initializeDocumentBuilder = function(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // Mark as builder type
    if (!doc.content) doc.content = {};
    doc.content.isBuilder = true;
    doc.content.isDynamic = true;

    // Route to specific builder based on templateId or label
    if (doc.templateId === 'callSheet' || doc.label.toLowerCase().includes('call sheet')) {
        initializeCallSheetBuilder(docId);
        return;
    }

    // Future builders go here
    if (doc.templateId === 'crewList' || doc.label.toLowerCase().includes('crew list')) {
        // initializeCrewListBuilder(docId); // Coming soon
        alert("Crew List builder coming soon!");
        return;
    }

    // Default: Generic template form (fallback)
    doc.content.type = 'template';
    doc.content.data = {};
    doc.status = 'In Progress';
    saveBudget();
    openDocumentViewer(docId);
};

/* --- v19.55 [Documents] - Viewer Integration & Builder Launch --- */

// 1. New Helper: Initialize Builder from Empty State
window.initializeCallSheetBuilder = function(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // Transform doc into a Builder Document
    doc.content = {
        type: 'template',
        templateId: 'callSheet_v2', // Matches the ID in Part 1
        isBuilder: true,            // Trigger for the new viewer logic
        isDynamic: true,
        data: JSON.parse(JSON.stringify(CallSheetBuilder.defaultState))
    };
    
    // Auto-fill metadata immediately
    doc.content.data.meta.productionTitle = budget.projectName || "Untitled";
    doc.content.data.meta.productionCompany = budget.company || "";
    
    saveBudget();
    
    // Switch view
    openDocumentViewer(docId);
    
    // Prompt for deep integration
    setTimeout(() => {
        if(confirm("Populate with Crew & Sections from Budget?")) {
            CallSheetBuilder.autoFillFromBudget(docId);
        }
    }, 500);
};

// 2. Updated Viewer (Replaces existing openDocumentViewer)
function openDocumentViewer(docId) {
    const doc = budget.documents.find(d => d.id === docId);
    if (!doc) return;

    // Flags
    const isBuilder = doc.content && doc.content.isBuilder;
    const isStandardTemplate = doc.content && doc.content.isDynamic && !isBuilder;
    const hasAttachment = budget.attachments && budget.attachments.some(a => a.docId === docId);

    // --- A. BUILDER MODE (React-Style Editor) ---
    if (isBuilder) {
        // Create full-screen container
        const viewerContent = `<div id="docViewerContent" class="h-full bg-gray-100 overflow-y-auto"></div>`;
        createModal('documentViewer', '', viewerContent, 'max-w-[95vw] w-full h-[90vh]', { noPadding: true, hideHeader: true });
        
        // Render Engine
        setTimeout(() => CallSheetBuilder.render(docId), 50);
        return;
    }

    // --- B. STANDARD TEMPLATE (Forms) ---
    if (isStandardTemplate) {
        if (!doc.content.data) doc.content.data = {};
        const editorHtml = mBTPublisher.renderEditor(doc);
        const viewerContent = `
            <div class="flex flex-col h-full bg-gray-50 overflow-hidden">
                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                    <h2 class="font-bold text-lg text-gray-800 truncate">${doc.label}</h2>
                    <div class="flex gap-2">
                        <button onclick="autofillMtemp('${docId}')" class="px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded font-bold text-xs hover:bg-green-100 flex items-center gap-1"><span>âš¡</span> Autofill</button>
                        <button onclick="generateMtempPDF('${docId}')" class="px-3 py-1.5 bg-gray-800 text-white rounded font-bold text-xs hover:bg-black flex items-center gap-1"><span>ðŸ–¨ï¸</span> PDF</button>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">${editorHtml}</div>
            </div>`;
        createModal('documentViewer', '', viewerContent, 'max-w-6xl w-full', { noPadding: true, hideHeader: true });
        return;
    }

    // --- C. PREVIEW MODE (Files) ---
    if (hasAttachment) {
        const attachment = budget.attachments.find(a => a.docId === docId);
        let previewHTML = '<div class="text-center p-10 text-gray-400">Preview Unavailable</div>';
        if (attachment.previewContent) {
            const p = attachment.previewContent;
            if (p.type === 'image') previewHTML = `<img src="${p.data}" class="max-w-full h-auto mx-auto rounded shadow-lg">`;
            else if (p.type === 'pdf') previewHTML = `<div class="text-center"><img src="${p.thumbnail}" class="max-w-full h-auto mx-auto border rounded shadow-sm mb-4"><p class="text-sm text-gray-500">PDF (${p.pageCount} pages)</p></div>`;
            else if (p.type === 'text') previewHTML = `<pre class="bg-gray-50 p-4 border rounded text-xs overflow-auto whitespace-pre-wrap font-mono text-gray-700">${p.content}</pre>`;
        }
        const viewerContent = `
            <div class="flex flex-col h-full bg-gray-50">
                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                    <div><h2 class="font-bold text-lg text-gray-800">${doc.label}</h2><p class="text-xs text-gray-500">${attachment.name}</p></div>
                    <div class="flex gap-2">
                        <button onclick="mBTPublisher.forceDownload(new Blob([''], {type:'text/plain'}), '${attachment.name}')" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded font-bold text-xs hover:bg-gray-200">Download</button>
                        <button onclick="removeAttachmentFromDocument('${attachment.id}', '${docId}')" class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded font-bold text-xs hover:bg-red-100">Remove</button>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto p-6 flex items-center justify-center">${previewHTML}</div>
            </div>`;
        createModal('documentViewer', '', viewerContent, 'max-w-6xl w-full', { noPadding: true, hideHeader: true });
        return;
    }

        // --- D. EMPTY STATE â€“ Template-Aware Builder Button ---
    const docLabel = doc.label || 'Document';
    const builderLabel = docLabel.includes('Call Sheet') ? 'Build Call Sheet' : `Build ${docLabel}`;

    const viewerContent = `
        <div class="flex flex-col h-full items-center justify-center bg-gray-50 p-8 text-center">
            <div class="bg-white p-10 rounded-2xl shadow-xl border border-gray-100 max-w-lg w-full">
                <div class="text-6xl mb-6 opacity-20">ðŸ“„</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Empty ${docLabel}</h3>
                <p class="text-gray-500 mb-8 text-sm">Choose how to initialize this document:</p>
               
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button onclick="document.getElementById('viewerUpload_${docId}').click()" class="group p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-2">
                        <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ“¤</span>
                        <span class="font-bold text-gray-700 text-sm group-hover:text-blue-700">Upload File</span>
                    </button>
                   
                    <button onclick="initializeDocumentBuilder('${docId}')" class="group p-4 border-2 border-dashed border-green-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all flex flex-col items-center gap-2">
                        <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ—ï¸</span>
                        <span class="font-bold text-gray-700 text-sm group-hover:text-green-700">${builderLabel}</span>
                    </button>
                </div>
               
                <div class="mt-4 pt-4 border-t">
                    <button onclick="startWithTemplate('${docId}')" class="text-xs text-gray-400 hover:text-gray-600 font-bold uppercase tracking-wider">Browse Other Templates</button>
                </div>
               
                <input type="file" id="viewerUpload_${docId}" class="hidden" onchange="handleDocUploadTrigger(this, '${docId}')">
            </div>
        </div>`;
    
    createModal('documentViewer', '', viewerContent, 'max-w-6xl w-full', { noPadding: true, hideHeader: true });
}

document.addEventListener('DOMContentLoaded', init);

/* ==========================================================================
   MASTER FIX V2: Global Trash Engine (Safe Arrays & Auto-Refresh)
   ========================================================================== */

window.mBTTrash = {
    state: { activeTab: 'documents' }, 

    // --- 1. Open & Render ---
    open: function(defaultTab = 'documents') {
        this.state.activeTab = defaultTab;
        this.render();
    },

    render: function() {
        const type = this.state.activeTab;
        
        // SAFEGUARD: Ensure Trash Arrays Exist
        const projectTrash = this._getProjectTrash();
        if (!Array.isArray(budget.documentTrash)) budget.documentTrash = [];
        const docTrash = budget.documentTrash;

        let items = [];
        
        if (type === 'projects') {
            items = projectTrash.map(p => ({
                label: p.projectName,
                date: p.deletedTimestamp,
                icon: 'ðŸ“',
                original: p
            }));
        } else {
            items = docTrash.map(d => ({
                label: d.label,
                date: d.deletedTimestamp || d.deletedAt,
                icon: d.icon || 'ðŸ“„',
                original: d
            }));
        }

        const isEmpty = items.length === 0;

        const content = `
            <div class="flex flex-col h-[500px]">
                <div class="flex border-b border-gray-200 bg-gray-50 flex-shrink-0">
                    <button onclick="window.mBTTrash.open('documents')" class="flex-1 py-3 text-sm font-bold ${type === 'documents' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-gray-500 hover:text-gray-700'}">
                        Documents (${docTrash.length})
                    </button>
                    <button onclick="window.mBTTrash.open('projects')" class="flex-1 py-3 text-sm font-bold ${type === 'projects' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-gray-500 hover:text-gray-700'}">
                        Projects (${projectTrash.length})
                    </button>
                </div>

                <div class="flex-grow overflow-y-auto p-4 bg-gray-100">
                    ${isEmpty ? 
                        `<div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-50">
                            <div class="text-6xl mb-2">ðŸ—‘ï¸</div>
                            <div class="text-sm font-bold">Bin is Empty</div>
                        </div>` 
                        : 
                        `<div class="space-y-2">
                            ${items.map((item, i) => `
                                <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center group">
                                    <div class="flex items-center gap-3 overflow-hidden">
                                        <div class="w-10 h-10 rounded bg-gray-50 flex items-center justify-center text-lg">${item.icon}</div>
                                        <div class="min-w-0">
                                            <div class="font-bold text-gray-800 text-sm truncate">${item.label}</div>
                                            <div class="text-xs text-gray-400">Deleted: ${item.date ? new Date(item.date).toLocaleDateString() : 'Unknown'}</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                        <button onclick="window.mBTTrash.restore(${i})" class="px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded text-xs font-bold hover:bg-green-100">Restore</button>
                                        <button onclick="window.mBTTrash.deleteForever(${i})" class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-200 rounded text-xs font-bold hover:bg-red-100">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>

                <div class="p-4 bg-white border-t border-gray-200 flex justify-between items-center flex-shrink-0">
                    <button onclick="mBTME.close('trashModal')" class="text-gray-500 font-bold text-xs hover:text-gray-800">Close</button>
                    ${!isEmpty ? `<button onclick="window.mBTTrash.emptyBin()" class="text-red-500 font-bold text-xs hover:text-red-700 hover:underline">Empty ${type === 'projects' ? 'Projects' : 'Documents'} Bin</button>` : ''}
                </div>
            </div>
        `;

        if (typeof mBTME !== 'undefined') {
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        } else {
            console.error("mBTME Modal Engine not loaded.");
        }
    },

    // --- 2. Action Logic ---

    // Move Active Document to Trash (Called by Card Icon)
    trashDocument: function(docId) {
        if (!confirm('Move to Recycle Bin?')) return;

        // Ensure Trash Array
        if (!Array.isArray(budget.documentTrash)) budget.documentTrash = [];

        const index = budget.documents.findIndex(d => d.id === docId);
        if (index === -1) return alert('Document not found');
        
        const doc = budget.documents[index];
        doc.deletedTimestamp = new Date().toISOString();
        
        // Move
        budget.documentTrash.push(doc);
        budget.documents.splice(index, 1);
        saveBudget();
        
        // Refresh Hub if open
        if (document.getElementById('documentsHubModal')) {
            showDocumentsModal(window.docHubState ? window.docHubState.activeTab : null);
        }
    },

    restore: function(index) {
        const type = this.state.activeTab;
        
        if (type === 'projects') {
            const trash = this._getProjectTrash();
            const project = trash.splice(index, 1)[0];
            if (project) {
                delete project.deletedTimestamp;
                localStorage.setItem(storageKeyPrefix + project.projectName, JSON.stringify(project));
                this._saveProjectTrash(trash);
                // Reload logic
                loadBudget(project.projectName);
                if(typeof render === 'function') render();
                alert(`Restored project: ${project.projectName}`);
            }
        } else {
            // Documents
            if (!Array.isArray(budget.documentTrash)) return;
            const doc = budget.documentTrash.splice(index, 1)[0];
            if (doc) {
                delete doc.deletedTimestamp;
                if (!budget.documents) budget.documents = [];
                budget.documents.push(doc);
                saveBudget();
                
                // Instant Refresh of Background Hub
                if (document.getElementById('documentsHubModal')) {
                    showDocumentsModal(window.docHubState ? window.docHubState.activeTab : null);
                }
            }
        }
        this.render(); // Re-render self (Trash Bin)
    },

    deleteForever: function(index) {
        if (!confirm("Delete forever? This cannot be undone.")) return;
        
        const type = this.state.activeTab;
        if (type === 'projects') {
            const trash = this._getProjectTrash();
            trash.splice(index, 1);
            this._saveProjectTrash(trash);
        } else {
            if (Array.isArray(budget.documentTrash)) {
                budget.documentTrash.splice(index, 1);
                saveBudget();
            }
        }
        this.render();
    },

    emptyBin: function() {
        const type = this.state.activeTab;
        if (!confirm(`Permanently delete ALL ${type}?`)) return;

        if (type === 'projects') {
            localStorage.removeItem(trashKey);
        } else {
            budget.documentTrash = [];
            saveBudget();
        }
        this.render();
    },

    // Internal Helpers
    _getProjectTrash: () => {
        try {
            const t = JSON.parse(localStorage.getItem(trashKey) || '[]');
            return Array.isArray(t) ? t : [];
        } catch(e) { return []; }
    },
    _saveProjectTrash: (data) => localStorage.setItem(trashKey, JSON.stringify(data)),
};

/* --- 3. OVERWRITE EVENT HANDLERS (The Glue) --- */

// Fix File Menu "Recover" option
window.showRecoveryModal = function() {
    window.mBTTrash.open('projects');
};

// Fix Documents Hub Red Bin Icon
window.showBinModal = function() {
    window.mBTTrash.open('documents');
};

// Fix Document Card "Trash" Button
window.handleDocTrash = function(docId) {
    window.mBTTrash.trashDocument(docId);
};

    </script>
</body>
</html>
