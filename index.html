<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.52</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263/lucide.min.js">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

    <style>
        /* --- Base & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
       body { 
    font-family: 'Inter', sans-serif; 
    padding-bottom: 50px; /* Space for sticky footer */
}

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- Layout & Responsiveness --- */
        @media (min-width: 768px) {
            .sticky-header { position: sticky; top: 1rem; z-index: 10; }
        }
        
        /* --- Form Elements --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }

        /* --- Modals & Transitions --- */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 0.2s ease-in-out; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #settingsModalContent, #aiToolsModalContent { transition: all 0.3s ease-in-out; }

        /* --- Tables --- */
/* --- Mobile Table Optimized (v19.52) --- */
        /* --- Mobile Table Fixes (v19.52 Optimized) --- */
        @media (max-width: 768px) {
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 600px; } /* Slightly tighter min-width */
            th, td { white-space: nowrap; padding: 0.5rem 0.1rem; font-size: 0.75rem; } /* Reduced horizontal padding */
            
            /* Col 1: Crew Avatar */
            th:nth-child(1), td:nth-child(1) { width: 40px; text-align: center; } 
            
            /* Col 2: Drag Handle */
            th:nth-child(2), td:nth-child(2) { width: 30px; min-width: 30px; } 
            
            /* Col 3: Description */
            th:nth-child(3), td:nth-child(3) { min-width: 140px; max-width: 180px; white-space: normal; } 
            
            /* Col 4: Qty (Tightened) */
            th:nth-child(4), td:nth-child(4) { width: 32px; padding: 0; } 
            td:nth-child(4) input { text-align: center; padding: 0; }

            /* Col 5: Unit (Tightened & Fixed) */
            th:nth-child(5), td:nth-child(5) { width: 38px; padding: 0; } 
            /* Remove native arrow on mobile so text 'Day' fits */
            td:nth-child(5) select { 
                appearance: none; 
                -webkit-appearance: none; 
                padding: 0 !important; 
                text-align: center; 
                background-image: none !important;
                font-weight: 600;
                color: #2563eb; /* Blue text to indicate actionable */
            }

            /* Remaining Columns */
            th:nth-child(6), td:nth-child(6) { width: 65px; } /* Rate */
            th:nth-child(7), td:nth-child(7) { width: 65px; } /* Est */
            th:nth-child(8), td:nth-child(8) { width: 65px; } /* Act */
            th:nth-child(9), td:nth-child(9) { width: 65px; } /* Var */
            th:nth-child(10), td:nth-child(10) { width: 25px; } /* Actions */
        }

        /* Fix Drag Locking */
        .drag-handle {
            touch-action: none; 
            cursor: grab;
            padding: 10px !important;
        }
        .drag-handle:active { cursor: grabbing; }

        /* --- v19.50 Crew Styles v19.52 --- */
        .crew-wrapper {
            position: relative;
            display: inline-flex; 
            width: 28px;          
            height: 28px;         
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            z-index: 20;
        }

        .crew-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar.unassigned { background-color: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }
        .crew-avatar.assigned { background-color: #3b82f6; border: 2px solid #ffffff; }
        
       /* --- v19.50 Floating Popup v19.52 --- */
        .contact-popup {
            position: absolute;
            left: 10px; 
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: -1; 
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .group:hover .contact-popup {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @media (hover: hover) {
            .crew-wrapper:hover .contact-popup {
                opacity: 1 !important; 
                visibility: visible !important; 
                pointer-events: auto !important;
                left: 34px; 
                transform: translateY(-50%) scale(1);
                z-index: 50;
            }
        }

        .crew-wrapper.mobile-active .contact-popup { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important;
            left: 34px; 
            transform: translateY(-50%) scale(1);
            z-index: 50;
        }

        .contact-popup::before {
            content: '';
            position: absolute;
            left: -14px; 
            top: 0;
            bottom: 0;
            width: 14px;
            background: transparent;
            z-index: 0;
        }
        
        .contact-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease, filter 0.2s;
            text-decoration: none !important;
            border-bottom: none !important;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .contact-btn:hover { transform: scale(1.15); filter: brightness(1.1); }
        .contact-btn svg { width: 14px; height: 14px; fill: currentColor; }
        
        .btn-wa-call { background-color: #25D366; }
        .btn-wa-msg { background-color: #128C7E; }
        .btn-email { background-color: #3b82f6; }

        /* --- Status Bar Scrolling --- */
        .scrolling-text-wrapper {
            flex: 1; 
            min-width: 0; 
            overflow-x: auto; 
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .scrolling-text-wrapper::-webkit-scrollbar { 
            display: none; 
        }

        /* --- Drag and Drop --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

        /* --- UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }
        
        /* Roadmap Styles */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

        /* AI Chat Styles */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

        /* Coffee Button */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Print Hiding */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        
/* --- v19.32 Hide Floating BMC Widget on Mobile 19.52 ---  */
#bmac-btn-container, #bmc-wbtn {
            display: none !important; 
        }

    </style>
</head>
<body class="bg-gray-100">

<div id="splash" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col gap-6">
    <img src="https://raw.githubusercontent.com/moollc/mooBudgetTool/main/assets/cow-192.png" alt="Moo" class="w-32 h-32 animate-pulse">
    <div class="text-3xl font-bold text-gray-800">Moo Budget Tool</div>
    <div class="text-sm text-gray-500">Loading production magic…</div>
</div>

<style>
    #splash { transition: opacity 0.6s ease-out; }
    #splash.fade-out { opacity: 0; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const splash = document.getElementById('splash');
        if (!splash) return;

        const minTime = 1200; 
        const start = performance.now();

        const tryRemove = () => {
            if (performance.now() - start >= minTime) {
                splash.classList.add('fade-out');
                setTimeout(() => splash.remove(), 600);
            } else {
                requestAnimationFrame(tryRemove);
            }
        };
        requestAnimationFrame(tryRemove);
    });
</script>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8"></div>
    <div id="global-modal-container"></div>
<footer class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm border-t border-gray-200 z-50 h-14 px-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="max-w-7xl mx-auto h-full grid grid-cols-3 items-center">
            
            <div class="flex items-center gap-2 justify-start pl-2">
                <p class="font-regular text-gray-700 text-xs sm:text-sm">moo <span class="font-normal text-gray-400 text-[10px] sm:text-xs">v19.52</span></p>
                <a href="mailto:moo@moo.llc" class="hidden sm:block text-blue-500 hover:underline text-xs">moo@moo.llc</a>
            </div>
            
            <div class="flex items-center justify-center gap-4">
                <button id="settingsBtn" aria-label="Settings" class="w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>

                <button id="footerCoffeeBtn" aria-label="Buy me a coffee" class="w-10 h-10 text-yellow-600 hover:text-yellow-700 hover:bg-yellow-50 rounded-full transition-colors flex items-center justify-center" title="Buy me a coffee">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                </button>
            </div>

            <div class="hidden sm:block"></div>
        </div>
    </footer>

    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="jaysonmy" data-description="Support me on Buy me a coffee!" data-message="Thanks for the coffee!" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18">
    </script>
	
    <script>
        /* --- v19.51 App Version v19.52 --- */
        const APP_VERSION = "19.52";
        
        const ROADMAP_LOG = [
            "v19.52: UI Polish (Buttons fixed), Publish Placeholder, Manifest 'moo' update.",
            "v19.50: Crew Profiles, Device Contact Import, Pro Exports, WhatsApp Integration.",
            "v19.49: Offline/PWA fixes, 'Get Offline Tool' added."
        ];

        const UPDATE_SOURCE_URL = 'https://gist.githubusercontent.com/moollc/b31c0e4d1fb8b3f6de11beffb4b353a9/raw/gistfile1.txt';
        const storageKeyPrefix = 'prodBudget_v5_';
        const trashKey = `${storageKeyPrefix}trash`;
        const globalItemsKey = `${storageKeyPrefix}globalItems`; 
        const templatesKey = `${storageKeyPrefix}templates`; 
        
        let budget;
        let currentProjectName;
        let displayCurrency = 'JMD';
        let exchangeRate = 157.50;
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 7;
        let editingGlobalItemIndex = -1;
        
        let editingTemplateId = null; 
        let tempTemplateData = null;

        const initialLineItem = { description: 'New Item', quantity: 1, unit: 'Day', multiplier: 1, rate: 0, actual: 0 };

        /* --- v19.51 Helper Functions v19.52 --- */
        // Generate collision-resistant IDs for attachments
        function generateSafeId() {
            return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Abbreviate long filenames for UI display
        function getAbbreviatedName(name, maxLen = 25) {
            if (name.length <= maxLen) return name;
            const ext = name.split('.').pop();
            const base = name.substring(0, name.lastIndexOf('.'));
            const keep = maxLen - ext.length - 4; // "..." + ext
            return base.substring(0, keep) + '...' + ext;
        }

        // ---------------------------------------------------------
        // State & Persistence
        // ---------------------------------------------------------

        const getGlobalItems = () => JSON.parse(localStorage.getItem(globalItemsKey) || '[]');
        const saveGlobalItems = (items) => localStorage.setItem(globalItemsKey, JSON.stringify(items));

        const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
        const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;

        const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
        const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
        
        const getProjectNameSeparator = () => {
            const val = localStorage.getItem(projectNameSeparatorKey);
            return val !== null ? val : '-'; 
        };
        const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

        function saveBudget() {
            try {
                if (!budget || !budget.projectName) return;
                localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(budget));
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                currentProjectName = budget.projectName;
            } catch (e) { console.error("Could not save budget", e); }
        }

        function loadBudget(projectName) {
            try {
                const data = localStorage.getItem(storageKeyPrefix + projectName);
                if (data) { 
                    budget = JSON.parse(data); 
                    // Sanitize Data
                    Object.values(budget.sections).forEach(section => {
                        section.items.forEach(item => {
                            if (item.multiplier === undefined) item.multiplier = 1;
                        });
                    });
                    historyStack = [{ budget: JSON.parse(JSON.stringify(budget)), description: 'Project Loaded', timestamp: new Date().toISOString()}];
                    historyIndex = 0;
                } 
                else { handleNewProject(false); return; }
                currentProjectName = budget.projectName;
                 localStorage.setItem(`${storageKeyPrefix}lastLoaded`, currentProjectName);
            } catch (e) { console.error("Could not load budget", e); handleNewProject(false); }
        }

        const deleteProject = (projectName) => { 
            if (confirm(`Move project "${projectName}" to Recently Deleted?`)) {
                const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
                const projectData = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName));
                projectData.deletedTimestamp = new Date().toISOString();
                trash.push(projectData);
                localStorage.setItem(trashKey, JSON.stringify(trash));
                localStorage.removeItem(storageKeyPrefix + projectName); 
                init(); 
            } 
        };

        const getProjectList = () => Object.keys(localStorage)
            .filter(k => k.startsWith(storageKeyPrefix) && k !== `${storageKeyPrefix}lastLoaded` && k !== `${storageKeyPrefix}currency` && k !== trashKey && k !== globalItemsKey && k !== templatesKey && !k.includes('ApiKey') && !k.includes('selectedAiProvider') && !k.includes('projectDateFormat') && !k.includes('projectNameSeparator'))
            .map(k => k.substring(storageKeyPrefix.length))
            .sort();

        function pushToHistory(description) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            const snapshot = {
                budget: JSON.parse(JSON.stringify(budget)),
                description: description,
                timestamp: new Date().toISOString()
            };
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            saveBudget();
            renderStatusBar();
        }

        // ---------------------------------------------------------
        // AI Logic & Integration
        // ---------------------------------------------------------
        const geminiApiKeyStorage = `${storageKeyPrefix}geminiApiKey`;
        const openaiApiKeyStorage = `${storageKeyPrefix}openaiApiKey`;
        const xaiApiKeyStorage = `${storageKeyPrefix}xaiApiKey`;
        const deepseekApiKeyStorage = `${storageKeyPrefix}deepseekApiKey`;
        const aiProviderStorage = `${storageKeyPrefix}selectedAiProvider`;

        const getStoredApiKey = (provider) => {
            if (provider === 'gemini') return localStorage.getItem(geminiApiKeyStorage) || '';
            if (provider === 'openai') return localStorage.getItem(openaiApiKeyStorage) || '';
            if (provider === 'xai') return localStorage.getItem(xaiApiKeyStorage) || '';
            if (provider === 'deepseek') return localStorage.getItem(deepseekApiKeyStorage) || '';
            return '';
        };

        const saveStoredApiKey = (provider, key) => {
            if (provider === 'gemini') localStorage.setItem(geminiApiKeyStorage, key);
            if (provider === 'openai') localStorage.setItem(openaiApiKeyStorage, key);
            if (provider === 'xai') localStorage.setItem(xaiApiKeyStorage, key);
            if (provider === 'deepseek') localStorage.setItem(deepseekApiKeyStorage, key);
        };

        const getSelectedProvider = () => localStorage.getItem(aiProviderStorage) || 'gemini';
        const setSelectedProvider = (provider) => localStorage.setItem(aiProviderStorage, provider);
async function callUnifiedAI(provider, apiKey, prompt) {
            if (provider === 'gemini') {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || 'Gemini API Error');
                return (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } 
            else if (['openai', 'xai', 'deepseek'].includes(provider)) {
                let baseUrl = 'https://api.openai.com/v1/chat/completions';
                let model = 'gpt-4o';
                if (provider === 'xai') { baseUrl = 'https://api.x.ai/v1/chat/completions'; model = 'grok-beta'; }
                else if (provider === 'deepseek') { baseUrl = 'https://api.deepseek.com/chat/completions'; model = 'deepseek-chat'; }
                
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: [{ role: "user", content: prompt }] })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || `${provider} API Error`);
                return (await response.json()).choices?.[0]?.message?.content || "No response.";
            }
            throw new Error("Unknown provider selected.");
        }

        // ---------------------------------------------------------
        // Business Logic & Helpers
        // ---------------------------------------------------------
        
        const calculateItem = (item) => {
            const estimated = (item.quantity || 0) * (item.multiplier || 1) * (item.rate || 0);
            const variance = (item.actual || 0) - estimated;
            return { estimated, variance };
        };

        const formatCurrency = (amount) => new Intl.NumberFormat(displayCurrency === 'JMD' ? 'en-JM' : 'en-US', { style: 'currency', currency: displayCurrency }).format(amount);
        const convertCurrency = (amount, toCurrency) => (toCurrency === 'USD') ? amount / exchangeRate : amount * exchangeRate;
        const toDisp = val => displayCurrency === 'USD' ? convertCurrency(val, 'USD') : val;

        const formatAbbreviated = (num, currency) => {
            const sign = num < 0 ? "-" : "";
            const absNum = Math.abs(num);
            const prefix = currency === 'JMD' ? 'J$' : '$';
            if (absNum >= 1e9) return `${sign}${prefix}${(absNum / 1e9).toFixed(2)}B`;
            if (absNum >= 1e6) return `${sign}${prefix}${(absNum / 1e6).toFixed(2)}M`;
            if (absNum >= 1e3) return `${sign}${prefix}${(absNum / 1e3).toFixed(1)}K`;
            return formatCurrency(num);
        };

        const calculateTotals = (sections) => { 
            let subtotal = 0; 
            for (const sectionName in sections) { 
                subtotal += sections[sectionName]?.items.reduce((acc, item) => acc + calculateItem(item).estimated, 0) || 0; 
            } 
            return { subtotal }; 
        };

        const calculateActuals = (sections) => { 
            let actualTotal = 0; 
            for (const sectionName in sections) { 
                actualTotal += sections[sectionName]?.items.reduce((acc, item) => acc + parseFloat(item.actual || 0), 0) || 0; 
            } 
            return actualTotal; 
        };

        // ---------------------------------------------------------
        // Template Management
        // ---------------------------------------------------------
        
        const DEFAULT_TEMPLATES = {
            'Commercial': { projectName: `Untitled Commercial Project`, discountPercentage: 0, contingencyPercentage: 15, salesTaxPercentage: 15.0, sections: { 'Key Creatives & Agency': { isOpen: true, items: [ { id: 'c1', description: 'Director', quantity: 3, unit: 'Day', multiplier: 1, rate: 80000, actual: 0 }, { id: 'c2', description: 'Producer', quantity: 5, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c3', description: 'Agency Fee / Creative Director', quantity: 1, unit: 'Flat', multiplier: 1, rate: 250000, actual: 0 }, { id: 'c4', description: 'Lead Talent / On-Screen Host', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Production Staff': { isOpen: true, items: [ { id: 'c5', description: 'Production Manager / Fixer', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c6', description: 'Production Coordinator (PC)', quantity: 5, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'c7', description: 'Production Assistant', quantity: 2, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 } ] }, 'Camera Department': { isOpen: true, items: [ { id: 'c8', description: 'Director of Photography (DP)', quantity: 3, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'c9', description: 'Camera Operator', quantity: 3, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c10', description: '1st Assistant Camera (AC)', quantity: 3, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'c11', description: 'Camera Package (Sony FX6)', quantity: 3, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'c12', description: 'Lens Package (Cine Primes)', quantity: 1, unit: 'Week', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c13', description: 'Teleprompter & Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 } ] }, 'Electric & Grip': { isOpen: true, items: [ { id: 'c14', description: 'Gaffer', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c15', description: 'Key Grip', quantity: 3, unit: 'Day', multiplier: 1, rate: 45000, actual: 0 }, { id: 'c16', description: 'Lighting & Grip Package (Van)', quantity: 3, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 } ] }, 'Sound Department': { isOpen: true, items: [ { id: 'c17', description: 'Production Sound Mixer', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c18', description: 'Sound Package (Mixer, Mics, Boom)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Art Department & Wardrobe': { isOpen: true, items: [ { id: 'c19', description: 'Art Director / Stylist', quantity: 4, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c20', description: 'Props & Wardrobe Purchase/Rental', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c21', description: 'Key Hair & Makeup Artist', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Locations & Production Expenses': { isOpen: true, items: [ { id: 'c22', description: 'Location Fees (Office, etc)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c23', description: 'Catering (15 people, per day)', quantity: 3, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'c24', description: 'Transportation (Van & Driver)', quantity: 3, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'c25', description: 'Editor', quantity: 8, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'c26', description: 'Motion Graphics Artist', quantity: 5, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'c27', description: 'Colorist', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'c28', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 100000, actual: 0 }, { id: 'c29', description: 'Music Licensing (Stock)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'c30', description: 'Film Registration Fee (JAMPRO)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 14400, actual: 0 }, { id: 'c31', description: 'Legal Review', quantity: 1, unit: 'Flat', multiplier: 1, rate: 120000, actual: 0 }, { id: 'c32', description: 'Production Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 144000, actual: 0 } ] } } },
            'Documentary': { projectName: `Untitled Documentary Project`, discountPercentage: 0, contingencyPercentage: 10, salesTaxPercentage: 15.0, sections: { 'Pre-Production | Research': { isOpen: true, items: [ { id: 'd1', description: 'Producer / Director (Development)', quantity: 20, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd2', description: 'Archival Researcher', quantity: 10, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'd3', description: 'Research & Travel', quantity: 1, unit: 'Flat', multiplier: 1, rate: 90000, actual: 0 } ] }, 'Production (2-Cam Setup)': { isOpen: true, items: [ { id: 'd4', description: 'Director', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd5', description: 'Director of Photography', quantity: 20, unit: 'Day', multiplier: 1, rate: 70000, actual: 0 }, { id: 'd6', description: 'Camera Operator (B-Cam)', quantity: 20, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd7', description: 'Production Sound Mixer', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd8', description: 'Production Assistant', quantity: 20, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'd9', description: 'Camera Package (Sony FX6) - A Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd10', description: 'Camera Package (Sony FX6) - B Cam', quantity: 20, unit: 'Day', multiplier: 1, rate: 55000, actual: 0 }, { id: 'd11', description: 'Sound Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 25000, actual: 0 }, { id: 'd12', description: 'Lighting & Grip Package', quantity: 20, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'd13', description: 'Travel & Accommodation', quantity: 1, unit: 'Flat', multiplier: 1, rate: 450000, actual: 0 }, { id: 'd14', description: 'Meals & Per Diems', quantity: 1, unit: 'Flat', multiplier: 1, rate: 240000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'd15', description: 'Editor', quantity: 60, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'd16', description: 'Assistant Editor / Logger', quantity: 40, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'd17', description: 'Transcription Services', quantity: 20, unit: 'Hour', multiplier: 1, rate: 4500, actual: 0 }, { id: 'd18', description: 'Archival Footage Licensing', quantity: 1, unit: 'Flat', multiplier: 1, rate: 300000, actual: 0 }, { id: 'd19', description: 'Colorist', quantity: 8, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'd20', description: 'Sound Design & Mix', quantity: 1, unit: 'Flat', multiplier: 1, rate: 200000, actual: 0 }, { id: 'd21', description: 'Composer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 225000, actual: 0 } ] }, 'Marketing & Distribution': { isOpen: true, items: [ { id: 'd22', description: 'Festival Submission Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 75000, actual: 0 }, { id: 'd23', description: 'Publicist Retainer', quantity: 1, unit: 'Flat', multiplier: 1, rate: 150000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'd24', description: 'Legal Fees (Contracts, Clearances)', quantity: 1, unit: 'Flat', multiplier: 1, rate: 180000, actual: 0 }, { id: 'd25', description: 'E&O Insurance', quantity: 1, unit: 'Policy', multiplier: 1, rate: 210000, actual: 0 }, { id: 'd26', description: 'Bookkeeping', quantity: 1, unit: 'Flat', multiplier: 1, rate: 60000, actual: 0 } ] } } },
            'LiveStream': { projectName: `Untitled Live Stream Project`, discountPercentage: 0, contingencyPercentage: 20, salesTaxPercentage: 15.0, sections: { 'Pre-Production': { isOpen: true, items: [ { id: 'l1', description: 'Technical Director (Planning)', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l2', description: 'Producer (Coordination)', quantity: 3, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 } ] }, 'Live Production Crew': { isOpen: true, items: [ { id: 'l3', description: 'Technical Director (Switcher)', quantity: 1, unit: 'Day', multiplier: 1, rate: 50000, actual: 0 }, { id: 'l4', description: 'Stream Engineer', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l5', description: 'Graphics Operator (CG)', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l6', description: 'Camera Operator', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l7', description: 'Audio Engineer (A1)', quantity: 1, unit: 'Day', multiplier: 1, rate: 35000, actual: 0 }, { id: 'l8', description: 'A/V Technician / Utility', quantity: 1, unit: 'Day', multiplier: 1, rate: 20000, actual: 0 } ] }, 'Live Production Equipment': { isOpen: true, items: [ { id: 'l9', description: 'Manned Broadcast Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 60000, actual: 0 }, { id: 'l10', description: 'Robotic PTZ Camera Pkg', quantity: 2, unit: 'Day', multiplier: 1, rate: 40000, actual: 0 }, { id: 'l11', description: 'Video Switcher (ATEM Mini Extreme)', quantity: 1, unit: 'Day', multiplier: 1, rate: 15000, actual: 0 }, { id: 'l12', description: 'Audio Mixer & Mics Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 24000, actual: 0 }, { id: 'l13', description: 'Intercom System (Comms)', quantity: 1, unit: 'Day', multiplier: 1, rate: 10500, actual: 0 }, { id: 'l14', description: 'Lighting Package', quantity: 1, unit: 'Day', multiplier: 1, rate: 30000, actual: 0 }, { id: 'l15', description: 'Internet / Bonded Cellular', quantity: 1, unit: 'Day', multiplier: 1, rate: 36000, actual: 0 }, { id: 'l16', description: 'Live Streaming Platform Fees', quantity: 1, unit: 'Flat', multiplier: 1, rate: 24000, actual: 0 } ] }, 'Post-Production': { isOpen: true, items: [ { id: 'l17', description: 'Minor Edits & Re-uploads', quantity: 1, unit: 'Flat', multiplier: 1, rate: 30000, actual: 0 } ] }, 'Administration': { isOpen: true, items: [ { id: 'l18', description: 'Production Insurance (Live Event)', quantity: 1, unit: 'Policy', multiplier: 1, rate: 180000, actual: 0 } ] } } }
        };

        const getAllTemplates = () => {
            const stored = localStorage.getItem(templatesKey);
            let templates;
            
            if (stored) {
                try {
                    templates = JSON.parse(stored);
                    templates['Commercial'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Commercial']));
                    templates['Documentary'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['Documentary']));
                    templates['LiveStream'] = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES['LiveStream']));
                } catch(e) {
                    templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
                }
            } else {
                templates = JSON.parse(JSON.stringify(DEFAULT_TEMPLATES));
            }
            
            localStorage.setItem(templatesKey, JSON.stringify(templates));
            return templates;
        };

        const saveAllTemplates = (templates) => localStorage.setItem(templatesKey, JSON.stringify(templates));

        const getDefaultBudget = (name, type = 'Commercial') => {
            const allTemplates = getAllTemplates();
            let template = allTemplates[type] ? JSON.parse(JSON.stringify(allTemplates[type])) : JSON.parse(JSON.stringify(allTemplates['Commercial']));
            template.projectName = name;
            if(template.sections) {
                Object.values(template.sections).forEach(s => s.items.forEach(i => { i.id = crypto.randomUUID(); if(i.multiplier === undefined) i.multiplier = 1; }));
            }
            return template;
        };

       // ---------------------------------------------------------
        // UI Rendering
        // ---------------------------------------------------------
        
        function createModal(id, title, contentHtml, maxWidth = 'max-w-2xl') {
            const container = document.getElementById('global-modal-container');
            const modalId = `${id}Modal`;
            let modal = document.getElementById(modalId);
            const fullHtml = `<div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden"><div id="${modalId}Content" class="bg-white rounded-lg shadow-xl w-full ${maxWidth} mx-auto max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95"><div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"><h2 class="text-xl font-bold text-gray-800">${title}</h2><button onclick="closeModal('${modalId}')" aria-label="Close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div><div class="overflow-y-auto flex-grow" id="${modalId}Body">${contentHtml}</div></div></div>`;
            if (modal) modal.remove(); 
            container.insertAdjacentHTML('beforeend', fullHtml);
            modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); }, 10);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modalId); });
            return modal;
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('opacity-0');
            document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            if(modalId === 'settingsModal') { editingGlobalItemIndex = -1; tempTemplateData = null; }
        };

        function renderStatusBar() {
            const container = document.getElementById('statusBar');
            if (!container) return;
            const lastAction = historyStack[historyIndex];
            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < historyStack.length - 1;
            const message = lastAction?.description || 'No recent changes.';
            container.innerHTML = `<div id="statusMsgWrapper" class="scrolling-text-wrapper"><span id="statusBarMessage" class="font-medium px-1">${message}</span></div><div class="flex items-center flex-shrink-0 pl-2 border-l border-blue-200 ml-2"><button id="undoBtn" class="px-2 py-1 rounded-md text-sm font-semibold ${canUndo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canUndo ? 'disabled' : ''}>Undo</button><button id="redoBtn" class="ml-2 px-2 py-1 rounded-md text-sm font-semibold ${canRedo ? 'bg-blue-200 hover:bg-blue-300' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" ${!canRedo ? 'disabled' : ''}>Redo</button></div>`;
        }

 /* --- v19.50 Render Line Item (Smart Buttons) v19.52 --- */
   function renderLineItem(item, sectionName) {
            const rateDisp = toDisp(item.rate);
            const actualDisp = toDisp(item.actual);
            
            const multiplierValue = item.multiplier !== 1 ? item.multiplier : 1;
            
            const crew = item.crew || {};
            const hasAssignedCrew = !!crew.name;
            
            const isRoleMatch = ['director', 'dp', 'producer', 'manager', 'sound'].some(role => item.description.toLowerCase().includes(role));
            
            let initials = '?';
            let avatarClass = 'unassigned';
            let titleText = 'Unassigned (Double click to add)';

            if (hasAssignedCrew) {
                initials = crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                avatarClass = 'assigned'; 
                titleText = `${crew.name} (Double click to edit)`;
            } else if (isRoleMatch) {
                initials = item.description.substring(0, 2).toUpperCase();
                avatarClass = 'assigned opacity-75'; 
                titleText = 'Role Detected (Double click to assign person)';
            }

            // Conditional Button Generation
            const cleanPhone = crew.phone ? crew.phone.replace(/[^0-9]/g, '') : '';
            
            const waCallBtn = cleanPhone ? 
                `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-call" title="WhatsApp Call">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </a>` : '';

            const waMsgBtn = cleanPhone ? 
                `<a href="https://wa.me/${cleanPhone}" target="_blank" class="contact-btn btn-wa-msg" title="WhatsApp Message">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                </a>` : '';

            const emailBtn = crew.email ? 
                `<a href="mailto:${crew.email}" class="contact-btn btn-email" title="Email">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </a>` : '';

            return `<tr class="draggable-row border-b hover:bg-gray-100 group" data-item-id="${item.id}" data-section="${sectionName}">
                
                <td class="p-1 w-12 text-center relative">
                    <div class="crew-wrapper">
                        <div class="crew-avatar ${avatarClass}" 
                             onclick="toggleCrewPopup(this, event)" 
                             ondblclick="openCrewProfile(this, event, '${item.id}', '${sectionName}')"
                             title="${titleText}">
                            ${initials}
                        </div>
                        <div class="contact-popup">
                            ${waCallBtn}
                            ${waMsgBtn}
                            ${emailBtn}
                            <button onclick="openCrewProfile(this, event, '${item.id}', '${sectionName}')" class="contact-btn bg-gray-400" title="Edit Profile">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" data-field="multiplier" data-id="${item.id}" data-section="${sectionName}" value="${multiplierValue}" />
                </td>

                <td class="p-2 text-center text-gray-400 cursor-grab active:cursor-grabbing drag-handle touch-none select-none hover:text-blue-500 w-8" title="Drag to reorder">⠿</td>

                <td class="p-2"><input type="text" aria-label="Description" data-field="description" data-id="${item.id}" data-section="${sectionName}" value="${item.description}" class="w-full bg-transparent p-1 rounded-md" /></td>
                <td class="p-2 text-center"><input type="number" aria-label="Quantity" data-field="quantity" data-id="${item.id}" data-section="${sectionName}" value="${item.quantity}" class="w-20 bg-transparent p-1 rounded-md text-center" /></td>
                <td class="p-2"><select aria-label="Unit" data-field="unit" data-id="${item.id}" data-section="${sectionName}" class="w-full bg-transparent p-1 rounded-md"><option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option></select></td>
                <td class="p-2 text-right"><input type="number" step="0.01" aria-label="Rate" data-field="rate" data-id="${item.id}" data-section="${sectionName}" value="${rateDisp.toFixed(2)}" class="w-28 bg-transparent p-1 rounded-md text-right" /></td>
                <td data-estimated-id="${item.id}" class="p-2 text-right font-medium"></td>
                <td class="p-2 text-right"><input type="number" step="0.01" aria-label="Actual Cost" data-field="actual" data-id="${item.id}" data-section="${sectionName}" value="${actualDisp.toFixed(2)}" class="w-28 bg-blue-50 p-1 rounded-md text-right" /></td>
                <td data-variance-id="${item.id}" class="p-2 text-right font-medium"></td>
                <td class="p-2 text-center"><button aria-label="Remove Item" data-remove-item="${item.id}" data-section="${sectionName}" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>
            </tr>`;
        }

        function renderBudgetSections() {
            return Object.entries(budget.sections).map(([sectionName, section]) => `<div class="mb-6 bg-white rounded-lg shadow-md overflow-hidden"><div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer border-b" data-section-toggle="${sectionName}"><div class="flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 section-arrow">${section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>'}</svg><h2 class="text-xl font-semibold">${sectionName}</h2></div><span data-section-total="${sectionName}" class="text-lg font-bold pointer-events-none"></span></div><div class="section-content ${section.isOpen ? '' : 'hidden'}"><div class="p-2 table-container"><table class="w-full text-sm">
            <thead>
                <tr>
                    <th class="p-1 text-center w-12">Crew</th>
                    <th class="p-1 w-8"></th> 
                    <th class="p-2 text-left min-w-[250px]">Description</th>
                    <th class="p-2 text-center">Qty</th>
                    <th class="p-2 text-left">Unit</th>
                    <th class="p-2 text-right">Rate</th>
                    <th class="p-2 text-right">Estimated</th>
                    <th class="p-2 text-right">Actual</th>
                    <th class="p-2 text-right">Variance</th>
                    <th class="p-2"></th>
                </tr>
            </thead>
            <tbody data-section-body="${sectionName}">${section.items.map(item => renderLineItem(item, sectionName)).join('')}</tbody></table></div><div class="mt-2 p-2"><button data-add-item="${sectionName}" class="flex items-center text-blue-600 font-medium"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Add Line Item</button></div></div></div>`).join('');
        }

        function render() {
            const appContainer = document.getElementById('app');
            if (!budget || !appContainer) return;
            const activeElement = document.activeElement;
            const activeElementId = activeElement ? activeElement.id : null;
            const activeElementDataId = activeElement ? activeElement.dataset.id : null;
            const activeElementDataField = activeElement ? activeElement.dataset.field : null;
            
            appContainer.innerHTML = `<header class="mb-6 flex flex-wrap items-center justify-between gap-y-4"><div class="flex items-center gap-3 w-full md:w-auto flex-grow mr-4"><input type="text" id="projectName" aria-label="Project Name" value="${budget.projectName}" class="text-xl sm:text-3xl md:text-4xl font-bold text-gray-800 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-2 rounded-lg" /><button id="loginBtn" aria-label="Connection Status" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0" title="Check connection"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><circle cx="12" cy="7" r="4"/></svg></button></div><div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div></header><div class="mt-2 flex gap-2 overflow-hidden"><button id="openAiToolsBtn" aria-label="AI Assistant" class="p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0" title="AI Assistant">✨</button><div id="statusBar" class="flex-grow p-2 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 flex justify-between items-center overflow-hidden"></div></div><div id="summary" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-8 md:sticky-header mt-4"><h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Budget Summary</h1><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><p class="text-sm text-gray-500">Subtotal</p><p id="summarySubtotal" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><label for="contingencyPercentage" class="text-sm text-gray-500 block">Contingency</label><div class="flex items-baseline gap-2"><div class="flex-grow min-w-0"><p id="summaryContingency" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.1" id="contingencyPercentage" aria-label="Contingency Percentage" value="${budget.contingencyPercentage}" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div><div class="bg-gray-50 p-3 sm:p-4 rounded-lg"><label for="salesTaxPercentage" class="text-sm text-gray-500 block">Sales Tax (GCT)</label><div class="flex items-baseline gap-2"><div class="flex-grow min-w-0"><p id="summaryTax" class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.01" id="salesTaxPercentage" aria-label="Sales Tax Percentage" value="${budget.salesTaxPercentage}" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 border-t"><div class="bg-red-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full"><label for="discountPercentage" class="text-sm text-red-500 block">Discount</label><div class="flex flex-col-reverse items-end md:flex-row md:items-baseline md:gap-2"><div class="flex-grow min-w-0 w-full"><p id="summaryDiscount" class="text-xl sm:text-2xl md:text-3xl font-bold text-red-700 whitespace-nowrap"></p></div><div class="flex items-center flex-shrink-0"><input type="number" step="0.01" id="discountPercentage" aria-label="Discount Percentage" value="${budget.discountPercentage || 0}" min="0" max="100" class="w-14 sm:w-14 text-right bg-transparent text-base sm:text-lg font-semibold border-b-2" /><span class="text-base sm:text-lg font-semibold">%</span></div></div></div><div class="bg-blue-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full relative"><p class="text-sm text-blue-500">Estimated Grand Total</p><p id="summaryGrandTotal" class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-700 whitespace-nowrap"></p></div><div class="bg-green-50 p-3 sm:p-4 rounded-lg border flex flex-col justify-between h-full relative"><p class="text-sm text-green-500">Actual Total Cost</p><p id="summaryActualTotal" class="text-xl sm:text-2xl md:text-3xl font-bold text-green-700 whitespace-nowrap"></p></div></div></div><main id="budget-sections">${renderBudgetSections()}</main><div id="footnote" class="mt-8 p-3 bg-gray-50 border border-gray-300 rounded-lg text-xs text-gray-600"><span>Personnel rates based on 2025 Jamaican market data from Beverly Boy Productions ($355-605USD Cam Op avg ~75k JMD), SalaryExpert (Editor ~50k JMD/day), JAMPRO, EmergeFilm, Paylab (PA 15k min above wage; Makeup 30k incl. materials ~$200USD); reductions: skilled 50-70% below US, entry 60-80%. </span><button id="compareRatesBtn" class="ml-2 text-blue-600 hover:underline">Compare Rates</button></div>`;
            renderProjectManagement();
            renderStatusBar();
            updateCalculations();
            initializeInteractiveInputs();
            initializeDragAndDrop();
            updateOnlineStatus(); 
            if (activeElementId) {
                const toFocus = document.getElementById(activeElementId);
                if (toFocus) toFocus.focus();
            } else if (activeElementDataId && activeElementDataField) {
                const toFocus = document.querySelector(`[data-id="${activeElementDataId}"][data-field="${activeElementDataField}"]`);
                if (toFocus) toFocus.focus();
            }
        }
// ---------------------------------------------------------
        // Modal Logic
        // ---------------------------------------------------------

        function showRateComparisonModal() {
             const rateComparisons = [
                { role: 'Camera Operator', local: '60,000 JMD', caricom: '65,000-80,000 JMD (T&T)', us: '$480 USD' },
                { role: 'Editor', local: '50,000 JMD', caricom: '45,000-55,000 JMD', us: '$400 USD' },
                { role: 'Production Assistant', local: '15,000 JMD', caricom: '12,000-18,000 JMD', us: '$150 USD' },
                { role: 'Hair & Makeup Artist', local: '30,000 JMD', caricom: '25,000-35,000 JMD', us: '$300 USD' },
                { role: 'Director of Photography', local: '70,000 JMD', caricom: '75,000-90,000 JMD', us: '$800 USD' },
                { role: 'Sound Mixer', local: '40,000 JMD', caricom: '35,000-45,000 JMD', us: '$350 USD' }
            ];

            const content = `
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">Role</th><th class="p-2 text-left">Local Jamaica (JMD/day)</th><th class="p-2 text-left">Caricom Avg (JMD/day)</th><th class="p-2 text-left">US Avg (USD/day)</th></tr></thead>
                    <tbody>${rateComparisons.map(row => `<tr class="border-b"><td class="p-2">${row.role}</td><td class="p-2">${row.local}</td><td class="p-2">${row.caricom}</td><td class="p-2">${row.us}</td></tr>`).join('')}</tbody>
                </table>
                <p class="text-xs text-gray-500 mt-4">Sources: Beverly Boy, SalaryExpert, JAMPRO. Rates approximate for mid-range productions.</p>
            `;
            createModal('rateComparison', 'Rate Comparisons (2025 Averages)', content, 'max-w-4xl');
        }

        /* --- v19.51 AI Modal with File Tray v19.52 --- */
        function showAIToolsModal() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            const attachments = budget.attachments || [];
            
            // Render Attachment Tray HTML
            const trayHTML = attachments.length > 0 ? 
                `<div class="mb-3 p-2 bg-gray-100 rounded-lg border border-gray-200">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 px-1">Attached Context</div>
                    <div class="flex flex-col gap-1 max-h-32 overflow-y-auto">
                        ${attachments.map(file => `
                            <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 shadow-sm group">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <div class="w-6 h-6 flex-shrink-0 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-[9px] font-bold border border-blue-200">
                                        ${file.name.split('.').pop().toUpperCase().substring(0,3)}
                                    </div>
                                    <span class="text-xs text-gray-700 truncate font-medium" title="${file.name}">${getAbbreviatedName(file.name)}</span>
                                </div>
                                <button onclick="removeAttachment('${file.id}')" class="text-gray-400 hover:text-red-500 p-1 opacity-60 group-hover:opacity-100 transition-opacity" title="Remove File">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>` 
                : 
                `<div class="mb-3 p-3 border-2 border-dashed border-gray-200 rounded-lg text-center text-gray-400 text-xs">
                    No files attached. <button onclick="handleUniversalImport()" class="text-blue-500 hover:underline">Import Context</button>
                 </div>`;

            const content = !key ? 
                `<div class="text-center py-10">
                    <div class="text-4xl mb-4">🔑</div>
                    <h3 class="text-lg font-bold text-gray-700">API Key Required</h3>
                    <p class="text-gray-500 text-sm mb-4">Please go to Settings > AI Assistant to configure your API key for ${provider.toUpperCase()}.</p>
                    <button onclick="closeModal('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Open Settings</button>
                </div>` 
                : 
                `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                        <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-lg"><span class="text-2xl">🩺</span> Budget Doctor</h4>
                        <p class="text-sm text-gray-500 mb-4">Analyze your current budget for gaps, risks, and rate anomalies using ${provider}.</p>
                        <button id="analyzeBudgetBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex justify-center items-center gap-2 font-medium transition-colors">Analyze Current Budget</button>
                        <div id="aiAnalysisOutput" class="mt-4 text-sm text-gray-700 flex-grow overflow-y-auto border-t pt-4 min-h-[200px]"></div>
                    </div>
                    
                    <div class="border rounded-xl p-5 bg-white shadow-sm flex flex-col h-[500px] md:h-auto">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><span class="text-2xl">💬</span> Production Consultant</h4>
                        </div>
                        
                        ${trayHTML}

                        <div id="aiChatHistory" class="flex-grow overflow-y-auto bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200"><div class="text-sm text-gray-400 text-center mt-10">Ask about union rules, equipment packages, or local rates...</div></div>
                        
                        <form id="aiChatForm" class="flex gap-2 items-center">
                            <button type="button" onclick="handleUniversalImport()" class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg border border-transparent hover:border-gray-300 transition-colors" title="Attach File (PDF, Doc, Sheets)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            </button>
                            <input type="text" id="aiChatInput" placeholder="Ask a question..." aria-label="Ask AI" class="flex-grow text-sm p-3 border rounded-lg focus:outline-none focus:border-blue-500">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                        </form>
                    </div>
                </div>`;

            createModal('aiTools', '✨ AI Assistant', content, 'max-w-4xl');
            
            if (key) {
                document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
                document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
            }
        }

        function showSettingsModal(defaultTab = 'general') {
            const content = `
                <div class="flex border-b text-sm font-medium text-gray-600 overflow-x-auto">
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'general' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('general', this)">General</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'templates' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('templates', this)">Templates</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'database' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('database', this)">Database</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'ai' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('ai', this)">✨ AI Assistant</button>
                     <button class="flex-1 p-3 hover:bg-gray-50 focus:outline-none whitespace-nowrap ${defaultTab === 'roadmap' ? 'border-b-2 border-blue-500 text-blue-600' : ''}" onclick="switchSettingsTab('roadmap', this)">Roadmap</button>
                </div>
                <div class="p-6" id="settingsContent">${renderSettingsContent(defaultTab)}</div>
            `;
            createModal('settings', 'Settings & Tools', content, 'max-w-4xl');
            bindSettingsEvents(defaultTab);
        }

        function showItemSelectorModal(sectionName) {
            const allItems = getAllItems();
            const uniqueMap = {};
            allItems.forEach(item => {
                if (!uniqueMap[item.description]) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: 0, isGlobal: item.isGlobal };
                else if (item.isGlobal) uniqueMap[item.description] = { unit: item.unit, rate: item.rate, count: uniqueMap[item.description].count, isGlobal: true };
                if (!item.isGlobal) {
                     uniqueMap[item.description].count++;
                     if(!uniqueMap[item.description].isGlobal) uniqueMap[item.description].rate += item.rate;
                }
            });
            Object.keys(uniqueMap).forEach(desc => {
                const entry = uniqueMap[desc];
                if (!entry.isGlobal && entry.count > 1) entry.rate = entry.rate / entry.count;
            });
            const itemList = Object.keys(uniqueMap).filter(desc => desc !== 'New Item' && desc.trim())
                .map(desc => ({ description: desc, unit: uniqueMap[desc].unit, rate: uniqueMap[desc].rate, isGlobal: uniqueMap[desc].isGlobal }))
                .sort((a, b) => { if (a.isGlobal && !b.isGlobal) return -1; if (!a.isGlobal && b.isGlobal) return 1; return a.description.localeCompare(b.description); });

            const content = `
                <button id="newItemBtn" class="w-full mb-2 p-2 bg-blue-500 text-white rounded hover:bg-blue-600">New Unlisted Item</button>
                <div class="max-h-64 overflow-y-auto">
                    ${itemList.length > 0 ? itemList.map(item => `
                        <div class="p-2 border-b border-gray-200 cursor-pointer hover:bg-gray-50 flex justify-between items-center group" data-select-item='${JSON.stringify({ desc: item.description, unit: item.unit, rate: item.rate })}'>
                            <div class="flex items-center overflow-hidden">${item.isGlobal ? '<span class="mr-2 text-yellow-500" title="Saved to Database">★</span>' : ''}<span class="truncate ${item.isGlobal ? 'font-medium text-gray-900' : 'text-gray-700'}">${item.description}</span></div>
                            <span class="text-sm text-gray-500 whitespace-nowrap ml-2">${item.unit} : ${formatCurrency(item.rate)}</span>
                        </div>`).join('') : '<p class="text-center text-gray-500 py-8">No previous items found.</p>'}
                </div><div class="mt-2 text-xs text-center text-gray-400">Use Settings <span class="text-yellow-500">★</span> to manage saved items.</div>`;
            
            const modal = createModal('itemSelector', 'Add Line Item', content, 'max-w-md');
            
            document.getElementById('newItemBtn').addEventListener('click', () => { closeModal('itemSelectorModal'); handleAddBlank(sectionName); });
            modal.querySelectorAll('[data-select-item]').forEach(el => {
                el.addEventListener('click', (e) => {
                    const data = JSON.parse(e.currentTarget.dataset.selectItem);
                    closeModal('itemSelectorModal');
                    handleAddExisting(sectionName, data.desc, data.unit, data.rate);
                });
            });
        }

        function showRecoveryModal() {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            
            let content = trash.length > 0 ? 
                `<div class="max-h-[60vh] overflow-y-auto">` + 
                trash.map((p, index) => `
                <div class="flex justify-between items-center p-2 ${index < trash.length -1 ? 'border-b' : ''}">
                    <div><p class="font-semibold">${p.projectName}</p><p class="text-xs text-gray-500">Deleted: ${new Date(p.deletedTimestamp).toLocaleString()}</p></div>
                    <div>
                        <button onclick="handleRestore(${index})" class="text-sm bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Restore</button>
                        <button onclick="handlePermanentDelete(${index})" class="text-sm bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 ml-2">Delete Forever</button>
                    </div>
                </div>`).join('') + 
                `</div>`
                : `<p class="text-center text-gray-500 py-8">No recently deleted projects.</p>`;
            
            if (trash.length > 0) {
                content += `
                <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                    <span class="text-xs text-gray-500 font-medium">Bulk Actions</span>
                    <div class="flex gap-2">
                        <button onclick="handleRestoreAll()" class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700 shadow-sm transition-colors">Restore All</button>
                        <button onclick="handleDeleteAllTrash()" class="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow-sm transition-colors">Delete All</button>
                    </div>
                </div>`;
            }
            
            createModal('recovery', 'Recover Deleted Projects', content, 'max-w-lg');
        }

        // ---------------------------------------------------------
        // Event Handlers
        // ---------------------------------------------------------

        function bindAppEventListeners() {
            const appContainer = document.getElementById('app');
            const footer = document.querySelector('footer');

            if (!appContainer || appContainer.dataset.listenersBound) return;
            appContainer.dataset.listenersBound = 'true';

            appContainer.addEventListener('change', (e) => {
                const id = e.target.id;
                if (id === 'projectName') handleProjectNameChange(e);
                else if (id === 'contingencyPercentage') { budget.contingencyPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Contingency %'); updateCalculations(); }
                else if (id === 'salesTaxPercentage') { budget.salesTaxPercentage = parseFloat(e.target.value) || 0; pushToHistory('Updated Sales Tax %'); updateCalculations(); }
                else if (id === 'discountPercentage') handleDiscountChange(e);
                else if (id === 'projectLoader') { loadBudget(e.target.value); render(); }
                else if (id === 'newProjectSelector') handleNewProjectSelection(e);
                else if (e.target.dataset.field === 'unit') handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Changed unit for ${e.target.closest('tr').querySelector('input[data-field=description]').value}`);
            });

            if(footer) {
                footer.addEventListener('click', (e) => { 
                    if (e.target.closest('#settingsBtn')) showSettingsModal(); 
                    if (e.target.closest('#footerCoffeeBtn')) {
                        const btn = document.querySelector('#bmc-wbtn');
                        if (btn) btn.click();
                        else window.open('https://buymeacoffee.com/jaysonmy', '_blank');
                    }
                });
            }

            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.id === 'undoBtn') handleUndo();
                else if (target.id === 'redoBtn') handleRedo();
                else if (target.id === 'loginBtn') handleLogin();
                else if (target.closest('#openAiToolsBtn')) showAIToolsModal();
                else if (target.closest('#deleteProjectBtn')) deleteProject(currentProjectName);
                else if (target.closest('#currencyToggleBtn')) handleCurrencyToggle();
                else if (target.closest('#exportPdfBtn')) exportToPdf();
                else if (target.closest('#exportXlsxBtn')) exportToXlsx();
                else if (target.closest('[data-section-toggle]')) handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
                else if (target.closest('[data-add-item]')) showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
                else if (target.closest('[data-remove-item]')) handleRemoveItem(target.closest('[data-remove-item]').dataset.section, target.closest('[data-remove-item]').dataset.removeItem);
                else if (target.id === 'compareRatesBtn') showRateComparisonModal();
            });

            appContainer.addEventListener('input', (e) => {
                const input = e.target;
                if (input.dataset.field) {
                    handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Updated ${input.dataset.field}`);
                } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    updateCalculations();
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        // ---------------------------------------------------------
        // Implementation Logic
        // ---------------------------------------------------------

        function getAllItems() {
            const allItems = [];
            getGlobalItems().forEach(item => allItems.push({ description: item.description, unit: item.unit, rate: item.rate, isGlobal: true }));
            getProjectList().forEach(projectName => {
                try {
                    const data = JSON.parse(localStorage.getItem(storageKeyPrefix + projectName) || '{}');
                    if (data?.sections) Object.values(data.sections).forEach(section => {
                        section.items?.forEach(item => {
                            if (item.description?.trim()) allItems.push({ description: item.description.trim(), unit: item.unit || 'Day', rate: item.rate || 0, isGlobal: false });
                        });
                    });
                } catch (e) { console.error(e); }
            });
            return allItems;
        }

        function formatAndUpdateSummaryValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = formatCurrency(value);
            if (element.scrollWidth > element.parentElement.clientWidth) element.textContent = formatAbbreviated(value, displayCurrency);
        }

        function checkOverBudget() {
            const actualTotal = calculateActuals(budget.sections);
            const { subtotal } = calculateTotals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const grandTotal = (subtotal + contingencyAmount + taxAmount) - ((subtotal + contingencyAmount + taxAmount) * ((budget.discountPercentage || 0) / 100));

            const summaryActual = document.getElementById('summaryActualTotal');
            if (summaryActual) {
                const hasOverBudget = actualTotal > grandTotal;
                summaryActual.parentElement.classList.toggle('bg-red-50', hasOverBudget);
                if (hasOverBudget && !summaryActual.parentElement.querySelector('.alert-badge')) {
                     summaryActual.parentElement.innerHTML += '<div class="alert-badge">!</div>';
                } else if (!hasOverBudget) {
                     const badge = summaryActual.parentElement.querySelector('.alert-badge');
                     if (badge) badge.remove();
                }
            }

            for (const sectionName in budget.sections) {
                budget.sections[sectionName].items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    const row = document.querySelector(`[data-item-id="${item.id}"]`);
                    if (row) row.classList.toggle('bg-red-50', variance > 0);
                });
            }
        }

        function updateCalculations() {
            if (!document.getElementById('summarySubtotal')) return;
            const { subtotal } = calculateTotals(budget.sections);
            const actualTotal = calculateActuals(budget.sections);
            const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
            const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
            const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
            const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
            const grandTotal = totalBeforeDiscount - discountAmount;

            formatAndUpdateSummaryValue('summarySubtotal', toDisp(subtotal));
            formatAndUpdateSummaryValue('summaryContingency', toDisp(contingencyAmount));
            formatAndUpdateSummaryValue('summaryTax', toDisp(taxAmount));
            formatAndUpdateSummaryValue('summaryDiscount', toDisp(-discountAmount));
            formatAndUpdateSummaryValue('summaryGrandTotal', toDisp(grandTotal));
            formatAndUpdateSummaryValue('summaryActualTotal', toDisp(actualTotal));

            for (const sectionName in budget.sections) {
                const section = budget.sections[sectionName];
                let sectionTotal = 0;
                section.items.forEach(item => {
                    const { estimated, variance } = calculateItem(item);
                    sectionTotal += estimated;
                    const estimatedCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                    if (estimatedCell) estimatedCell.textContent = formatCurrency(toDisp(estimated));
                    const varianceCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                    if (varianceCell) {
                        varianceCell.textContent = formatCurrency(toDisp(variance));
                        varianceCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                    }
                });
                const sectionTotalEl = document.querySelector(`[data-section-total="${sectionName}"]`);
                if (sectionTotalEl) sectionTotalEl.textContent = formatCurrency(toDisp(sectionTotal));
            }
            checkOverBudget();
        }

        function handleUpdate(sectionName, itemId, field, value, description) {
            const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
            if (!item) return;
            let valueToSave = value;
            if (['rate', 'actual'].includes(field)) {
                const parsedValue = parseFloat(value) || 0;
                valueToSave = (displayCurrency === 'USD') ? convertCurrency(parsedValue, 'JMD') : parsedValue;
            } else if (field === 'quantity') valueToSave = parseFloat(value) || 0;
            else if (field === 'multiplier') { const parsed = parseFloat(value) || 1; valueToSave = parsed > 0 ? parsed : 1; }
            item[field] = valueToSave;
            pushToHistory(description);
            if (field !== 'description') updateCalculations();
        }

        function handleUndo() { if (historyIndex > 0) { historyIndex--; budget = JSON.parse(JSON.stringify(historyStack[historyIndex].budget)); saveBudget(); render(); } }
        function handleRedo() { if (historyIndex < historyStack.length - 1) { historyIndex++; budget = JSON.parse(JSON.stringify(historyStack[historyIndex].budget)); saveBudget(); render(); } }
        function handleCurrencyToggle() { displayCurrency = displayCurrency === 'JMD' ? 'USD' : 'JMD'; pushToHistory(`Switched currency to ${displayCurrency}`); render(); }
        
        function handleAddBlank(sectionName) {
            const newItem = { id: crypto.randomUUID(), ...initialLineItem };
            budget.sections[sectionName].items.push(newItem);
            pushToHistory(`Added 'New Item' to ${sectionName}`);
            const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
            if (tableBody) {
                tableBody.insertAdjacentHTML('beforeend', renderLineItem(newItem, sectionName));
                initializeDragAndDrop();
            }
            updateCalculations();
        }

        function handleAddExisting(sectionName, desc, unit, rate) {
            const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit: unit, multiplier: 1, rate: rate, actual: 0 };
            budget.sections[sectionName].items.push(newItem);
            pushToHistory(`Added '${desc}' to ${sectionName}`);
            const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
            if (tableBody) {
                tableBody.insertAdjacentHTML('beforeend', renderLineItem(newItem, sectionName));
                initializeDragAndDrop();
            }
            updateCalculations();
        }

        function handleRemoveItem(sectionName, itemId) {
            const itemIndex = budget.sections[sectionName].items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const itemName = budget.sections[sectionName].items[itemIndex].description;
                budget.sections[sectionName].items.splice(itemIndex, 1);
                pushToHistory(`Removed '${itemName}' from ${sectionName}`);
                const row = document.querySelector(`button[data-remove-item="${itemId}"]`).closest('tr');
                if (row) row.remove();
                updateCalculations();
            }
        }

        function handleToggleSection(sectionName) {
            const section = budget.sections[sectionName];
            section.isOpen = !section.isOpen;
            pushToHistory(`${section.isOpen ? 'Opened' : 'Closed'} section: ${sectionName}`);
            const content = document.querySelector(`[data-section-toggle="${sectionName}"]`).nextElementSibling;
            content.classList.toggle('hidden');
            const arrow = document.querySelector(`[data-section-toggle="${sectionName}"] .section-arrow`);
            arrow.innerHTML = section.isOpen ? '<polyline points="6 9 12 15 18 9"></polyline>' : '<polyline points="9 18 15 12 9 6"></polyline>';
        }

        function handleDiscountChange(e) { 
            let value = parseFloat(e.target.value) || 0;
            if (value > 100) { value = 100; e.target.value = 100; } else if (value < 0) { value = 0; e.target.value = 0; }
            budget.discountPercentage = value; 
            pushToHistory('Updated Discount %'); updateCalculations(); 
        }
        
        function handleProjectNameChange(e) {
            const newName = e.target.value.trim();
            if (newName && newName !== currentProjectName) {
                if (getProjectList().includes(newName)) { alert(`A project named "${newName}" already exists.`); e.target.value = currentProjectName; return; }
                localStorage.removeItem(storageKeyPrefix + currentProjectName);
                const oldName = budget.projectName;
                budget.projectName = newName;
                pushToHistory(`Renamed project from '${oldName}' to '${newName}'`);
                render(); 
            }
        }
        
        function getFormattedDatePart() {
            const date = new Date();
            const dateFormat = getProjectDateFormat();
            const separator = getProjectNameSeparator();
            const pad = (num) => String(num).padStart(2, '0');
            
            let datePart;
            const M = pad(date.getMonth() + 1);
            const D = pad(date.getDate());
            const Y = date.getFullYear();

            if (dateFormat === 'MMDDYYYY') {
                datePart = `${M}${separator}${D}${separator}${Y}`;
            } else { // YYYYMMDD
                datePart = `${Y}${separator}${M}${separator}${D}`;
            }
            return datePart;
        }

        /* --- v19.51 File Menu Handler v19.52 --- */
        function handleNewProjectSelection(e) {
            const type = e.target.value;
            
            if (type === 'Duplicate') {
                handleDuplicateProject();
                e.target.value = ""; 
            }
            else if (type === 'Recover') {
                showRecoveryModal();
                e.target.value = "";
            }
            else if (type === 'ImportFile' || type === 'ImportMoo') {
                handleUniversalImport(); 
                
                setTimeout(() => { 
                    const el = document.getElementById('newProjectSelector');
                    if(el) el.value = ""; 
                }, 500);
            }
            else if (type) {
                handleNewProject(true, type); 
            } 
        }
        
        function handleDuplicateProject() {
            if (!budget) return;
            const newBudget = JSON.parse(JSON.stringify(budget));
            let baseName = newBudget.projectName.replace(/ \(Copy( \d+)?\)$/, "");
            let newName = `${baseName} (Copy)`;
            let i = 2;
            while(getProjectList().includes(newName)) { newName = `${baseName} (Copy ${i})`; i++; }
            newBudget.projectName = newName;
            Object.values(newBudget.sections).forEach(s => s.items.forEach(i => i.id = crypto.randomUUID()));
            budget = newBudget;
            pushToHistory(`Duplicated project to '${newName}'`);
            render();
        }
        
        function handleNewProject(doRender = true, type = 'Commercial') {
            const datePart = getFormattedDatePart();
            let newName = `Untitled ${type}`;
            let i = 1;
            let finalName = `${newName} ${datePart}`;
            while(getProjectList().includes(finalName)) { i++; finalName = `${newName} ${datePart} (${i})`; }
            budget = getDefaultBudget(finalName, type);
            pushToHistory(`Created new project '${finalName}'`);
            if(doRender) render();
        }

        // --- Drag & Drop (Logic) ---
        let draggedItem = null;
        function // --- Drag & Drop (Robust Mobile & Desktop) ---
        let draggedItem = null;
        let touchDragItem = null;
        let touchDragClone = null; // Visual clone for dragging

        function initializeDragAndDrop() {
            // 1. Setup Row Handlers
            document.querySelectorAll('.draggable-row').forEach(row => {
                const handle = row.querySelector('.drag-handle');
                row.draggable = false; // Disable default to control manually

                if(handle) {
                    // --- Desktop Mouse Events ---
                    handle.onmousedown = () => { row.draggable = true; };
                    handle.onmouseup = () => { row.draggable = false; };
                    handle.onmouseleave = () => { row.draggable = false; };

                    // --- Mobile Touch Events ---
                    handle.addEventListener('touchstart', (e) => {
                        if (e.cancelable) e.preventDefault();
                        touchDragItem = row;
                        
                        // Create visual clone
                        touchDragClone = row.cloneNode(true);
                        touchDragClone.style.position = 'absolute';
                        touchDragClone.style.width = `${row.offsetWidth}px`;
                        touchDragClone.style.opacity = '0.8';
                        touchDragClone.style.pointerEvents = 'none'; // Let clicks pass through to targets
                        touchDragClone.style.zIndex = '9999';
                        touchDragClone.style.backgroundColor = '#dbeafe'; // Light blue
                        touchDragClone.classList.add('shadow-xl');
                        document.body.appendChild(touchDragClone);

                        // Position clone at finger
                        const touch = e.touches[0];
                        touchDragClone.style.left = `${touch.pageX}px`;
                        touchDragClone.style.top = `${touch.pageY}px`;

                        row.classList.add('opacity-40'); // Dim original
                    }, { passive: false });

                    handle.addEventListener('touchmove', (e) => {
                        if (!touchDragItem || !touchDragClone) return;
                        if (e.cancelable) e.preventDefault();

                        const touch = e.touches[0];
                        // Move clone
                        touchDragClone.style.left = `${touch.pageX + 10}px`; // Offset slightly so finger doesn't hide it
                        touchDragClone.style.top = `${touch.pageY + 10}px`;

                        // Identify Drop Target
                        // Temporarily hide clone to get element underneath
                        touchDragClone.style.display = 'none';
                        const target = document.elementFromPoint(touch.clientX, touch.clientY);
                        touchDragClone.style.display = 'block';

                        if(!target) return;

                        // Case A: Hovering over another row
                        const targetRow = target.closest('.draggable-row');
                        if (targetRow && targetRow !== touchDragItem) {
                            const parent = targetRow.parentNode;
                            const dragRect = touchDragItem.getBoundingClientRect();
                            const targetRect = targetRow.getBoundingClientRect();
                            
                            // Insert before or after based on direction
                            if (dragRect.top < targetRect.top) {
                                parent.insertBefore(touchDragItem, targetRow.nextSibling);
                            } else {
                                parent.insertBefore(touchDragItem, targetRow);
                            }
                        }
                        
                        // Case B: Hovering over an empty/different section
                        const targetSection = target.closest('[data-section-body]');
                        if(targetSection && targetSection !== touchDragItem.parentNode) {
                            targetSection.appendChild(touchDragItem);
                        }

                    }, { passive: false });

                    handle.addEventListener('touchend', (e) => {
                        if (!touchDragItem) return;

                        // Finalize Move
                        const newSectionEl = touchDragItem.closest('[data-section-body]');
                        if (newSectionEl) {
                            const newSectionName = newSectionEl.dataset.sectionBody;
                            const oldSectionName = touchDragItem.dataset.section;
                            
                            // 1. Update DOM Data attributes immediately
                            touchDragItem.dataset.section = newSectionName;
                            touchDragItem.querySelectorAll('[data-section]').forEach(el => el.dataset.section = newSectionName);

                            // 2. Sync underlying Data Model
                            // We use a robust sync that handles cross-section moves
                            syncBudgetModelAfterDrop(touchDragItem.dataset.itemId, oldSectionName, newSectionName);
                        } else {
                            // Dropped outside? Revert visualization (render will fix)
                            render();
                        }

                        // Cleanup
                        if (touchDragClone) touchDragClone.remove();
                        touchDragItem.classList.remove('opacity-40');
                        touchDragItem = null;
                        touchDragClone = null;
                    });
                }

                // --- Desktop Drag Events ---
                row.addEventListener('dragstart', (e) => { 
                    if(row.draggable) {
                        draggedItem = { id: e.target.dataset.itemId, section: e.target.dataset.section }; 
                        e.dataTransfer.effectAllowed = 'move';
                        setTimeout(() => row.classList.add('opacity-50'), 0);
                    } else { e.preventDefault(); }
                });
                
                row.addEventListener('dragend', () => { 
                    row.classList.remove('opacity-50'); 
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                });
                
                row.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
                row.addEventListener('dragleave', e => { e.currentTarget.classList.remove('drag-over'); });
                
                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if(!draggedItem) return;
                    const dropSection = e.currentTarget.closest('[data-section-body]').dataset.sectionBody;
                    // Find index of the row we dropped ON
                    const rows = Array.from(document.querySelectorAll(`tbody[data-section-body="${dropSection}"] .draggable-row`));
                    const dropIndex = rows.indexOf(e.currentTarget);
                    
                    moveItem(draggedItem.id, draggedItem.section, dropSection, dropIndex);
                });
            });

            // Section Droppable Areas (For empty sections or padding)
            document.querySelectorAll('[data-section-body]').forEach(section => {
                section.addEventListener('dragover', (e) => { e.preventDefault(); });
                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if(draggedItem && e.target === section) { // Only if dropped on container, not row
                        moveItem(draggedItem.id, draggedItem.section, section.dataset.sectionBody, section.children.length);
                    }
                });
            });
        }

        // Robust Sync Function for Touch Drops
        function syncBudgetModelAfterDrop(itemId, oldSectionName, newSectionName) {
            // 1. Remove from Old Section
            const oldList = budget.sections[oldSectionName].items;
            const itemIndex = oldList.findIndex(i => i.id === itemId);
            if (itemIndex === -1) { render(); return; } // Error safety
            
            const [item] = oldList.splice(itemIndex, 1);
            
            // 2. Find New Position
            // We look at the DOM *now* to see where the item ended up
            const newRows = Array.from(document.querySelectorAll(`tbody[data-section-body="${newSectionName}"] .draggable-row`));
            const newIndex = newRows.findIndex(row => row.dataset.itemId === itemId);
            
            // 3. Insert into New Section Data
            if (!budget.sections[newSectionName].items) budget.sections[newSectionName].items = [];
            
            if (newIndex >= 0) {
                budget.sections[newSectionName].items.splice(newIndex, 0, item);
            } else {
                budget.sections[newSectionName].items.push(item); // Append if something weird happened
            }

            pushToHistory(`Moved item to ${newSectionName}`);
            render(); // Full re-render to ensure clean state
        }
// --- Settings & AI Handlers ---
        window.switchSettingsTab = function(tabName, btn) {
            editingGlobalItemIndex = -1;
            const buttons = btn.parentElement.children;
            for(let b of buttons) b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
            btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
            document.getElementById('settingsContent').innerHTML = renderSettingsContent(tabName);
            bindSettingsEvents(tabName);
        };

        function bindSettingsEvents(tabName) {
            if(tabName === 'general') { 
                /* --- v19.50 Offline Download v19.52 --- */
                document.getElementById('updateBtn')?.addEventListener('click', downloadOfflineHTML); 
                document.getElementById('dateFormatSelect')?.addEventListener('change', (e) => { setProjectDateFormat(e.target.value); });
                document.getElementById('separatorInput')?.addEventListener('input', (e) => { setProjectNameSeparator(e.target.value); });
            }
            else if (tabName === 'templates') { bindTemplateEvents(); }
            else if (tabName === 'database') { bindDatabaseEvents(); }
            else if (tabName === 'roadmap') { document.getElementById('toggleRoadmapDetailsBtn')?.addEventListener('click', (e) => { document.querySelectorAll('.roadmap-detail').forEach(el => el.classList.toggle('hidden')); e.target.textContent = e.target.textContent.includes('Expand') ? 'Collapse Details' : 'Expand Details'; }); }
            else if (tabName === 'ai') { bindAIEvents(); }
        }

        function bindAIEvents() {
            document.getElementById('aiProviderSelect')?.addEventListener('change', (e) => { setSelectedProvider(e.target.value); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
            document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => { saveStoredApiKey(getSelectedProvider(), document.getElementById('apiKeyInput').value.trim()); alert('API Key Saved'); window.switchSettingsTab('ai', document.querySelector('button[onclick*="ai"]')); });
        }

        function bindDatabaseEvents() {
            document.getElementById('addGlobalItemForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const desc = document.getElementById('dbDesc').value.trim();
                const unit = document.getElementById('dbUnit').value;
                const rate = parseFloat(document.getElementById('dbRate').value) || 0;
                if(desc) {
                    const items = getGlobalItems();
                    if (editingGlobalItemIndex > -1) { items[editingGlobalItemIndex] = { description: desc, unit, rate }; editingGlobalItemIndex = -1; } 
                    else { 
                        const existingIdx = items.findIndex(i => i.description.toLowerCase() === desc.toLowerCase());
                        if(existingIdx >= 0) items.splice(existingIdx, 1);
                        items.unshift({ description: desc, unit, rate }); 
                    }
                    saveGlobalItems(items);
                    window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
                }
            });
        }
        
        function renderSettingsContent(tabName) {
            const currentDateFormat = getProjectDateFormat();
            const currentSeparator = getProjectNameSeparator();

            if (tabName === 'general') {
                return `<div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">Application Info</h3>
                        <p class="text-sm text-gray-700">Current Version: <strong>v${APP_VERSION}</strong></p>
                        <p class="text-sm text-gray-500 mt-1">Status: ${navigator.onLine ? '<span class="text-green-600 font-semibold">Online</span>' : '<span class="text-red-500 font-semibold">Offline</span>'}</p>
                    </div>
                    
                    <div class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">Project Naming Preferences</h3>
                        <div>
                            <label for="dateFormatSelect" class="block text-xs font-semibold text-gray-600 mb-1">Date Format for New Projects</label>
                            <select id="dateFormatSelect" aria-label="Date Format" class="w-full text-sm p-2 border rounded">
                                <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD (Default)</option>
                                <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                            </select>
                        </div>
                         <div>
                            <label for="separatorInput" class="block text-xs font-semibold text-gray-600 mb-1">Date Separator Character</label>
                            <input type="text" id="separatorInput" aria-label="Date Separator" maxlength="1" value="${currentSeparator}" class="w-10 text-sm p-2 border rounded text-center">
                            <span class="text-xs text-gray-500 ml-2">Example: Untitled Project ${getFormattedDatePart()}</span>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="updateBtn" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900 text-sm font-medium transition-colors">Get Offline HTML (Download)</button>
                        <p class="text-xs text-gray-500 mt-2">Downloads the current state of the tool as a single HTML file.</p>
                        <div class="mt-6 flex justify-center gap-4 border-t pt-4">
                             <button onclick="const btn=document.querySelector('#bmc-wbtn'); if(btn) btn.click(); else window.open('https://buymeacoffee.com/jaysonmy', '_blank');" class="bmc-btn text-sm">☕ Buy me a coffee</button>
                        </div>
                    </div>
                </div>`;
            } else if (tabName === 'templates') {
                const allTemplates = getAllTemplates();
                if(!editingTemplateId) editingTemplateId = 'Commercial';
                const options = Object.keys(allTemplates).map(k => `<option value="${k}" ${k === editingTemplateId ? 'selected' : ''}>${k}</option>`).join('');
                
                const isReadOnly = isDefaultTemplate(editingTemplateId);
                const disabledClass = isReadOnly ? 'opacity-50 cursor-not-allowed bg-gray-300' : 'bg-blue-600 hover:bg-blue-700';
                
                return `
                <div class="h-full flex flex-col">
                    <div class="mb-4 flex flex-wrap gap-2 items-center justify-between bg-gray-50 p-3 rounded-lg border">
                        <div class="flex items-center gap-2 flex-grow">
                            <label class="text-sm font-bold text-gray-700 whitespace-nowrap">Edit Template:</label>
                            <select id="templateSelector" aria-label="Select Template" class="p-2 border rounded text-sm bg-white shadow-sm flex-grow max-w-xs">${options}</select>
                        </div>
                        <div class="flex gap-2">
                            <button id="createTemplateBtn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center gap-1"><span class="text-base">+</span> Clone / New</button>
                            <button id="importTemplateBtn" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Import</button>
                            <button id="exportTemplateBtn" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Export</button>
                            <button id="deleteTemplateBtn" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 border border-red-200 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}" ${isReadOnly ? 'disabled' : ''}>Delete</button>
                        </div>
                    </div>
                    
                    <div id="templateEditorContainer" class="flex-grow overflow-y-auto border rounded-lg p-4 bg-white shadow-inner">
                        </div>
                    
                    <div class="mt-4 pt-3 border-t flex justify-end gap-3">
                        <p class="text-xs text-gray-400 self-center mr-auto">Changes are applied to NEW projects only.</p>
                        <button id="saveTemplateChangesBtn" class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${disabledClass}" ${isReadOnly ? 'disabled' : ''}>Save Changes</button>
                    </div>
                </div>
                `;
		} else if (tabName === 'ai') {
                const currentProvider = getSelectedProvider();
                let keyLink = '#';
                if(currentProvider === 'gemini') keyLink = 'https://aistudio.google.com/app/apikey';
                else if(currentProvider === 'openai') keyLink = 'https://platform.openai.com/api-keys';
                else if(currentProvider === 'xai') keyLink = 'https://console.x.ai/';
                else if(currentProvider === 'deepseek') keyLink = 'https://platform.deepseek.com/api_keys';
                
                const rawKey = getStoredApiKey(currentProvider) || '';
                const safeKey = rawKey.replace(/"/g, '&quot;');

                return `
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-bold text-indigo-800 mb-2">AI Configuration</h3>
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-indigo-600 mb-1">Active AI Provider</label>
                            <select id="aiProviderSelect" aria-label="AI Provider" class="w-full text-sm p-2 border rounded border-indigo-200">
                                <option value="gemini" ${currentProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                                <option value="openai" ${currentProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                                <option value="xai" ${currentProvider === 'xai' ? 'selected' : ''}>xAI</option>
                                <option value="deepseek" ${currentProvider === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                            </select>
                        </div>
                        <div class="mb-1">
                            <label class="block text-xs font-semibold text-indigo-600 mb-1">API Key</label>
                            <div class="flex gap-2 w-full">
                                <input type="password" id="apiKeyInput" aria-label="API Key" value="${safeKey}" placeholder="Enter API Key" class="flex-grow min-w-0 text-sm p-2 border rounded border-indigo-200 outline-none">
                                <button id="saveApiKeyBtn" class="flex-shrink-0 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-indigo-500 mt-1">Don't have a key? <a href="${keyLink}" target="_blank" class="underline font-bold">Get one here</a>.</p>
                    </div>
                </div>`;
            } else if (tabName === 'database') {
                const globalItems = getGlobalItems();
                const editItem = editingGlobalItemIndex > -1 ? globalItems[editingGlobalItemIndex] : null;
                return `<div class="space-y-4"><div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4"><p class="text-xs text-yellow-800">Saved items appear at the top of the "Add Item" list.</p></div><form id="addGlobalItemForm" class="grid grid-cols-12 gap-2 items-end bg-gray-50 p-3 rounded-lg border ${editItem ? 'border-blue-300 bg-blue-50' : ''}"><div class="col-span-4 sm:col-span-5"><label class="block text-xs font-semibold text-gray-500 mb-1">Description</label><input type="text" id="dbDesc" aria-label="Description" class="w-full text-sm p-2 border rounded" required value="${editItem ? editItem.description : ''}"></div><div class="col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Unit</label><select id="dbUnit" aria-label="Unit" class="w-full text-sm p-2 border rounded"><option ${editItem?.unit === 'Day' ? 'selected' : ''}>Day</option><option ${editItem?.unit === 'Week' ? 'selected' : ''}>Week</option><option ${editItem?.unit === 'Flat' ? 'selected' : ''}>Flat</option></select></div><div class="col-span-3"><label class="block text-xs font-semibold text-gray-500 mb-1">Rate</label><input type="number" id="dbRate" aria-label="Rate" class="w-full text-sm p-2 border rounded" value="${editItem ? editItem.rate : ''}"></div><div class="col-span-2 sm:col-span-1 flex gap-1">${editItem ? `<button type="button" aria-label="Cancel" onclick="cancelEditGlobalItem()" class="w-full p-2 bg-gray-400 text-white rounded">x</button>` : ''}<button type="submit" aria-label="Save" class="w-full p-2 ${editItem ? 'bg-green-600' : 'bg-blue-600'} text-white rounded">${editItem ? '✓' : '+'}</button></div></form><div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-right">Rate</th><th class="p-2 text-center">Act</th></tr></thead><tbody>${globalItems.map((item, idx) => `<tr class="border-t hover:bg-gray-50 ${idx === editingGlobalItemIndex ? 'bg-blue-50' : ''}"><td class="p-2">${item.description}</td><td class="p-2 text-right">${formatCurrency(item.rate)}</td><td class="p-2 text-center"><button aria-label="Edit Item" class="text-blue-500 mr-2" onclick="editGlobalItem(${idx})">✎</button><button aria-label="Delete Item" class="text-red-400" onclick="deleteGlobalItem(${idx})">×</button></td></tr>`).join('')}</tbody></table></div></div>`;
          } else if (tabName === 'roadmap') {
                 // 1. Data Definition
                 const futureItems = [
                    "<b>Open Gate Database:</b> Anonymous rate/cost sharing & 'Open Gate' publishing.",
                    "<b>Cloud & Funding:</b> Google/Dropbox integration; 1-Click 'Seek Funding' pitch generator.",
                    "<b>AI 2.0:</b> Attach files (scripts/treatments), save chat history, analysis tools.",
                    "<b>Smart Templates:</b> Stage-specific crew checklists (Pre/Shoot/Wrap) & logic for equipment days.",
                    "<b>Offline UI:</b> Further hardening of visual alignment when network is lost."
                 ];

                 const recentItems = [
                    { v: "v19.52", t: "Cloud & Context", d: "<b>Cloud & Files:</b> Added 'Publish' placeholder, 'Import File' menu, and .moo export (Yellow Folder).<br><b>Exports:</b> Added PDF/Excel options (Landscape, Fit to Page, Hide Zero).<br><b>AI Assistant:</b> Attach files (Scripts, PDFs) for context.<br><b>UI/UX:</b> Fixed mobile text sizing, removed button borders, updated floating contact popups." },
                    { v: "v19.50", t: "Production Workflow", d: "<b>Crew:</b> Visual Avatars, Native Contact Import, Profile Editor.<br><b>Actions:</b> WhatsApp Call/Msg & Email integration.<br><b>Exports:</b> Professional PDF/Excel with Budget Summaries.<br><b>UX:</b> Branded Splash Screen, Footer Location (🇯🇲), Table Restructure." },
                    { v: "v19.49", t: "PWA Core", d: "Offline fixes, 'Get Offline Tool' download, Bulk Restore." }
                 ];

                 const archiveItems = [
                    { v: "v19.44", t: "Logic", d: "Production Days calculator; Template 'Type' & 'Cap' fields." },
                    { v: "v19.40", t: "Stable", d: "Verified Netlify/GH Pages setup." },
                    { v: "v19.36", t: "Feature", d: "Template Manager (Create/Import/Export)." }
                 ];

                 // 2. Helper function
                 const renderList = (items) => items.map(i => 
                    `<li class="text-sm text-gray-700 mb-3">
                        <span class="font-bold text-blue-700">${i.v}</span> 
                        <span class="text-xs text-gray-500 font-mono">(${i.t})</span><br>
                        <span class="text-gray-600">${i.d}</span>
                    </li>`
                 ).join('');

                 // 3. Return the HTML structure
                 return `
                 <div class="space-y-6 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2 flex-shrink-0">
                        <h3 class="font-bold text-gray-800">Development Roadmap</h3>
                        <button id="toggleRoadmapDetailsBtn" class="text-xs text-blue-600 font-semibold hover:bg-blue-50 px-2 py-1 rounded border border-transparent hover:border-blue-100 transition-colors">Expand History</button>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto pr-2">
                        <div class="relative pl-6 border-l-2 border-gray-200 space-y-8 ml-2">
                            
                            <div class="relative">
                                <div class="absolute -left-[31px] bg-white border-2 border-dashed border-purple-400 rounded-full w-4 h-4 mt-1.5 shadow-sm"></div>
                                <h4 class="text-md font-bold text-purple-800 mb-2">Up Next (Google Sheet Integration)</h4>
                                <ul class="space-y-2">
                                    ${futureItems.map(f => `<li class="flex items-start gap-2 text-sm text-gray-600"><span class="text-purple-400 mt-0.5">•</span> ${f}</li>`).join('')}
                                </ul>
                            </div>

                            <div class="relative">
                                <div class="absolute -left-[33px] bg-blue-600 border-4 border-white shadow-md rounded-full w-6 h-6 mt-0"></div>
                                <h4 class="text-md font-bold text-blue-800 mb-2">Current Release (v19.52)</h4>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 shadow-sm">
                                    <ul class="space-y-1">
                                        ${renderList(recentItems)}
                                    </ul>
                                </div>
                            </div>

                            <div class="relative roadmap-detail hidden transition-all duration-300">
                                <div class="absolute -left-[31px] bg-gray-400 border-2 border-white rounded-full w-4 h-4 mt-1.5"></div>
                                <h4 class="text-md font-bold text-gray-500 mb-2">Archive</h4>
                                <ul class="space-y-1 pl-1 opacity-75 border-t pt-2 mt-2">
                                    ${renderList(archiveItems)}
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                 </div>`;
            }
        }

        /* --- v19.50 Mobile Crew Toggle Helper v19.52 --- */
        window.toggleCrewPopup = function(el, event) {
            if(event) event.stopPropagation(); 
            const wrapper = el.parentElement;
            
            document.querySelectorAll('.crew-wrapper').forEach(div => {
                if (div !== wrapper) div.classList.remove('mobile-active');
            });
            
            wrapper.classList.toggle('mobile-active');
        };

        /* --- v19.50 Crew Profile Manager v19.52 --- */
        window.openCrewProfile = function(el, event, itemId, sectionName) {
            if(event) event.stopPropagation();
            
            const section = budget.sections[sectionName];
            const item = section.items.find(i => i.id === itemId);
            if(!item) return;

            const crew = item.crew || { name: '', phone: '', email: '' };

            const content = `
                <form id="crewProfileForm" class="space-y-6 p-1">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-4">
                        <div class="w-14 h-14 flex-shrink-0 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-2xl shadow-sm">
                            ${crew.name ? crew.name.substring(0,1).toUpperCase() : '?'}
                        </div>
                        <div class="min-w-0 flex-grow">
                            <p class="text-xs text-blue-600 font-bold uppercase tracking-wider mb-0.5">Assigning Role</p>
                            <p class="font-bold text-gray-900 text-lg leading-tight truncate">${item.description}</p>
                        </div>
                        
                        <button type="button" id="importContactBtn" class="flex-shrink-0 p-2 bg-white text-blue-600 rounded-full border border-blue-200 shadow-sm hover:bg-blue-50 transition-colors" title="Import from Device Contacts">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Full Name</label>
                            <input type="text" id="crewName" value="${crew.name || ''}" placeholder="e.g. Jane Doe" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Phone / WhatsApp</label>
                                <input type="tel" id="crewPhone" value="${crew.phone || ''}" placeholder="+1 876..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all shadow-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Email Address</label>
                                <input type="email" id="crewEmail" value="${crew.email || ''}" placeholder="jane@set.com" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm">
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 flex flex-col-reverse sm:flex-row sm:justify-between items-center gap-3 border-t border-gray-100 mt-2">
                        <button type="button" class="w-full sm:w-auto text-red-500 text-sm hover:text-red-700 font-medium py-2 transition-colors" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Clear Assignment</button>
                        <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white px-8 py-2.5 rounded-lg font-bold shadow hover:bg-blue-700 active:transform active:scale-95 transition-all">Save Profile</button>
                    </div>
                </form>
            `;

            createModal('crewProfile', '', content, 'max-w-lg');

            /* --- v19.50 Device Contact Import Logic v19.52 --- */
            document.getElementById('importContactBtn').addEventListener('click', async () => {
                const supported = ('contacts' in navigator && 'ContactsManager' in window);
                
                if (supported) {
                    try {
                        const props = ['name', 'tel', 'email'];
                        const opts = { multiple: false };
                        const contacts = await navigator.contacts.select(props, opts);
                        
                        if (contacts.length) {
                            const contact = contacts[0];
                            if(contact.name && contact.name[0]) document.getElementById('crewName').value = contact.name[0];
                            if(contact.tel && contact.tel[0]) document.getElementById('crewPhone').value = contact.tel[0];
                            if(contact.email && contact.email[0]) document.getElementById('crewEmail').value = contact.email[0];
                        }
                    } catch (ex) {
                        console.log("Contact import cancelled", ex);
                    }
                } else {
                    const nameInput = document.getElementById('crewName');
                    nameInput.focus();
                    
                    const btn = document.getElementById('importContactBtn');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<span class="text-xs text-red-500 font-bold">N/A</span>';
                    setTimeout(() => btn.innerHTML = originalHTML, 2000);
                }
            });

            document.getElementById('crewProfileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                item.crew = {
                    name: document.getElementById('crewName').value.trim(),
                    phone: document.getElementById('crewPhone').value.trim(),
                    email: document.getElementById('crewEmail').value.trim()
                };
                pushToHistory(`Assigned ${item.crew.name || 'Crew'} to ${item.description}`);
                closeModal('crewProfileModal');
                render(); 
            });
        };

        window.clearCrewAssignment = function(itemId, sectionName) {
            if(confirm('Remove this person from the role?')) {
                const item = budget.sections[sectionName].items.find(i => i.id === itemId);
                if(item) {
                    delete item.crew;
                    pushToHistory(`Cleared crew from ${item.description}`);
                    closeModal('crewProfileModal');
                    render();
                }
            }
        };

/* --- v19.51 Export PDF with Options v19.52 --- */
function exportToPdf() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">PDF Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfFitToPageModal" class="w-4 h-4 rounded" checked>
                    <span class="text-sm font-medium text-gray-700">Fit to Page (Auto-scale)</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfLandscapeModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Landscape Orientation</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="pdfStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="closeModal('pdfExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmPdfExport" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Export PDF</button>
            </div>
        </div>
    `;
    
    createModal('pdfExport', 'Export Budget to PDF', content, 'max-w-md');
    
    document.getElementById('confirmPdfExport').addEventListener('click', () => {
        const fitToPage = document.getElementById('pdfFitToPageModal').checked;
        const hideZeroQty = document.getElementById('pdfHideZeroQtyModal').checked;
        const landscape = document.getElementById('pdfLandscapeModal').checked;
        const includeStages = document.getElementById('pdfStagesModal').checked;
        
        closeModal('pdfExportModal');
        generatePdfWithOptions(fitToPage, hideZeroQty, landscape, includeStages);
    });
}

function generatePdfWithOptions(fitToPage, hideZeroQty, landscape, includeStages) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: landscape ? 'landscape' : 'portrait' });
    
    doc.setFontSize(18);
    doc.text(budget.projectName || "Untitled Project", 14, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    const dateStr = new Date().toLocaleDateString();
    doc.text(`Generated: ${dateStr}`, 14, 26);
    
    const { subtotal } = calculateTotals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;
    
    const summaryData = [
        ['Subtotal', formatCurrency(toDisp(subtotal))],
        [`Contingency (${budget.contingencyPercentage}%)`, formatCurrency(toDisp(contingencyAmount))],
        [`Sales Tax (${budget.salesTaxPercentage}%)`, formatCurrency(toDisp(taxAmount))],
        [`Discount (${budget.discountPercentage}%)`, `-${formatCurrency(toDisp(discountAmount))}`],
        ['GRAND TOTAL', formatCurrency(toDisp(grandTotal))]
    ];

    doc.autoTable({
        startY: 32,
        head: [['Category', 'Amount']],
        body: summaryData,
        theme: 'striped',
        headStyles: { fillColor: [66, 66, 66] },
        columnStyles: { 
            0: { fontStyle: 'bold' },
            1: { halign: 'right' } 
        },
        margin: { left: 14, right: landscape ? 150 : 100 }
    });

    let finalY = doc.lastAutoTable.finalY + 10;
    const tableRows = [];
    
    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        let sectionTotal = 0;
        const sectionItems = [];
        
        section.items.forEach(item => {
            if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;
            const { estimated } = calculateItem(item);
            sectionTotal += estimated;
            sectionItems.push([
                item.description,
                item.quantity,
                item.unit,
                formatCurrency(toDisp(item.rate)),
                formatCurrency(toDisp(estimated))
            ]);
        });
        
        if (sectionItems.length === 0) return;
        
        tableRows.push([{ 
            content: sectionName.toUpperCase(), 
            colSpan: 5, 
            styles: { fillColor: [220, 220, 220], fontStyle: 'bold', textColor: [0, 0, 0] } 
        }]);
        
        tableRows.push(...sectionItems);
        
        tableRows.push([{ 
            content: `Total ${sectionName}: ${formatCurrency(toDisp(sectionTotal))}`, 
            colSpan: 5, 
            styles: { halign: 'right', fontStyle: 'bold', fillColor: [245, 245, 245] } 
        }]);
    });

    const tableConfig = {
        startY: finalY,
        head: [['Description', 'Qty', 'Unit', 'Rate', 'Total']],
        body: tableRows,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
        styles: { fontSize: fitToPage ? 8 : 9, cellPadding: fitToPage ? 2 : 3 },
        pageBreak: 'auto',
    };
    
    if (fitToPage) {
        tableConfig.tableWidth = 'auto';
        tableConfig.columnStyles = {
            0: { cellWidth: 'auto' },
            1: { cellWidth: 15, halign: 'center' },
            2: { cellWidth: 15, halign: 'center' },
            3: { cellWidth: 25, halign: 'right' },
            4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
        };
    } else {
        tableConfig.columnStyles = {
            0: { cellWidth: 'auto' },
            1: { cellWidth: 20, halign: 'center' },
            2: { cellWidth: 20, halign: 'center' },
            3: { cellWidth: 30, halign: 'right' },
            4: { cellWidth: 35, halign: 'right', fontStyle: 'bold' }
        };
    }

    doc.autoTable(tableConfig);
    
    if (includeStages) {
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Production Stages Breakdown', 14, 20);
        doc.setFontSize(10);
        doc.text('(Feature coming in v19.52)', 14, 28);
    }

    doc.save(`${budget.projectName || 'Budget'}.pdf`);
}
        
 /* --- v19.51 Export Excel with Options v19.52 --- */
function exportToXlsx() {
    const content = `
        <div class="space-y-4 p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">Excel Export Options</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxHideZeroQtyModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Hide Zero Quantity Items</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" id="xlsxStagesModal" class="w-4 h-4 rounded">
                    <span class="text-sm font-medium text-gray-700">Include Stages Breakdown</span>
                </label>
            </div>
            <div class="mt-6 flex gap-3 justify-end border-t pt-4">
                <button onclick="closeModal('xlsxExportModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmXlsxExport" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">Export Excel</button>
            </div>
        </div>
    `;
    
    createModal('xlsxExport', 'Export Budget to Excel', content, 'max-w-md');
    
    document.getElementById('confirmXlsxExport').addEventListener('click', () => {
        const hideZeroQty = document.getElementById('xlsxHideZeroQtyModal').checked;
        const includeStages = document.getElementById('xlsxStagesModal').checked;
        
        closeModal('xlsxExportModal');
        generateXlsxWithOptions(hideZeroQty, includeStages);
    });
}

function generateXlsxWithOptions(hideZeroQty, includeStages) {
    const wb = XLSX.utils.book_new();
    const { subtotal } = calculateTotals(budget.sections);
    const contingencyAmount = subtotal * (budget.contingencyPercentage / 100);
    const taxAmount = subtotal * (budget.salesTaxPercentage / 100);
    const totalBeforeDiscount = subtotal + contingencyAmount + taxAmount;
    const discountAmount = totalBeforeDiscount * ((budget.discountPercentage || 0) / 100);
    const grandTotal = totalBeforeDiscount - discountAmount;
    const totalActual = calculateActuals(budget.sections);

    const data = [];
    
    data.push([budget.projectName || "Untitled Project"]);
    data.push([`Generated: ${new Date().toLocaleDateString()}`]);
    data.push([]);

    data.push(["BUDGET SUMMARY", ""]);
    data.push(["Subtotal", toDisp(subtotal)]);
    data.push([`Contingency (${budget.contingencyPercentage}%)`, toDisp(contingencyAmount)]);
    data.push([`Sales Tax (${budget.salesTaxPercentage}%)`, toDisp(taxAmount)]);
    data.push([`Discount (${budget.discountPercentage}%)`, -toDisp(discountAmount)]); 
    data.push(["GRAND TOTAL", toDisp(grandTotal)]);
    data.push(["TOTAL ACTUAL SPEND", toDisp(totalActual)]);
    data.push([]);

    data.push(["Description", "Qty", "Unit", "Rate", "Estimated", "Actual", "Variance"]);

    Object.entries(budget.sections).forEach(([sectionName, section]) => {
        data.push([sectionName.toUpperCase(), "", "", "", "", "", ""]);
        let sectionEst = 0;
        let sectionAct = 0;

        section.items.forEach(item => {
            if (hideZeroQty && (!item.quantity || item.quantity == 0)) return;

            const { estimated, variance } = calculateItem(item);
            sectionEst += estimated;
            sectionAct += (parseFloat(item.actual) || 0);

            data.push([
                item.description,
                item.quantity,
                item.unit,
                toDisp(item.rate),
                toDisp(estimated),
                toDisp(item.actual),
                toDisp(variance)
            ]);
        });

        data.push([
            `Total ${sectionName}`, 
            "", "", "", 
            toDisp(sectionEst), 
            toDisp(sectionAct), 
            toDisp(sectionAct - sectionEst)
        ]);
        data.push([]);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [
        { wch: 40 }, { wch: 8 }, { wch: 10 }, { wch: 15 },
        { wch: 15 }, { wch: 15 }, { wch: 15 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Budget Detail");
    
    if (includeStages) {
        const stagesData = [["Stages Breakdown"], ["Feature coming in v19.52"]];
        const stagesWs = XLSX.utils.aoa_to_sheet(stagesData);
        XLSX.utils.book_append_sheet(wb, stagesWs, "Stages");
    }
    
    XLSX.writeFile(wb, `${budget.projectName || 'Budget'}.xlsx`);
}

/* --- v19.51 .moo File Export/Import Logic v19.52 --- */
        function exportToMoo() {
    if (!budget) {
        alert("No active budget to export.");
        return;
    }
    const dataStr = JSON.stringify(budget, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeName = (budget.projectName || "untitled").replace(/[^a-z0-9]/gi, '_').toLowerCase();
    a.href = url;
    a.download = `${safeName}.moo`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.createObjectURL(url);
}

function handleUniversalImport() {
    if (budget && budget.projectName) saveBudget();

    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = '.moo,.json,.pdf,.doc,.docx,.txt,.rtf,.md,.csv,.xls,.xlsx,image/*';
    input.style.display = 'none';
    document.body.appendChild(input);

    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        let budgetImported = false;
        let attachedCount = 0;

        try {
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();

                if (ext === 'moo' || (ext === 'json' && file.name.includes('Budget'))) {
                    if (budgetImported) {
                        alert("Notice: Skipped extra budget file. Please import one project at a time.");
                        continue;
                    }

                    const textContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsText(file);
                    });

                    try {
                        const importedBudget = JSON.parse(textContent);
                        if (!importedBudget.sections || !importedBudget.projectName) throw new Error("Missing required budget data");

                        const existingProjects = getProjectList();
                        let newName = importedBudget.projectName;

                        while (existingProjects.includes(newName)) {
                            const userResponse = prompt(
                                `Project "${newName}" already exists.\n\nEnter a new name to open it as a separate project:`, 
                                `${newName} (Imported)`
                            );
                            if (userResponse === null) throw new Error("Import cancelled by user.");
                            newName = userResponse.trim();
                            if (!newName) throw new Error("Name cannot be empty.");
                        }

                        importedBudget.projectName = newName;
                        if (!importedBudget.attachments) importedBudget.attachments = []; 
                        
                        localStorage.setItem(storageKeyPrefix + newName, JSON.stringify(importedBudget));
                        loadBudget(newName); 
                        budgetImported = true;

                    } catch (parseErr) {
                        alert(`Failed to load project "${file.name}": ${parseErr.message}`);
                    }
                } 
                else {
                    if (!budget) { 
                        alert("Please open a project before attaching files."); 
                        continue; 
                    }
                    if (!budget.attachments) budget.attachments = [];

                    const attachment = {
                        id: generateSafeId(),
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        dateAdded: new Date().toISOString(),
                        content: null
                    };

                    try {
                        if (['txt','csv','rtf','md'].includes(ext)) {
                             const text = await file.text();
                             attachment.content = text.substring(0, 25000); 
                        }
                    } catch (err) { console.warn("Text extraction failed", err); }

                    budget.attachments.push(attachment);
                    attachedCount++;
                }
            }

            if (attachedCount > 0) saveBudget();

            render(); 

            let msg = "";
            if (budgetImported) msg += `✅ Loaded Project: "${budget.projectName}"\n`;
            if (attachedCount > 0) msg += `📎 ${attachedCount} file(s) added to Production Consultant tray.`;
            
            if(msg) alert(msg.trim());

            if (document.getElementById('aiToolsModal') && !document.getElementById('aiToolsModal').classList.contains('hidden')) {
                showAIToolsModal();
            }

        } catch (globalErr) {
            console.error("Import Error:", globalErr);
        } finally {
            document.body.removeChild(input);
        }
    };

    input.click();
}

function removeAttachment(id) {
    if(!budget || !budget.attachments) return;
    budget.attachments = budget.attachments.filter(a => a.id !== id);
    saveBudget();
    showAIToolsModal();
}

        function downloadOfflineHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `mooBudgetTool_v${APP_VERSION}.html`;
            a.click();
        }
/* --- v19.51 Project Management UI (Icon-only Export) v19.52 --- */
        function renderProjectManagement() {
            const container = document.getElementById('project-management-container');
            if(container) {
                const templates = getAllTemplates();
                const templateOptions = Object.keys(templates).map(k => `<option value="${k}">New ${k}</option>`).join('');
                
                container.innerHTML = `<div id="project-management" class="flex flex-wrap items-center justify-start gap-x-3 gap-y-2">
                <select id="projectLoader" aria-label="Load Project" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5">${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}</select>
                
                <div class="relative">
                    <select id="newProjectSelector" aria-label="File Menu" class="appearance-none px-2 py-2 w-[4.5rem] bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold cursor-pointer text-center focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="" disabled selected>File</option>
                        ${templateOptions}
                        <option value="" disabled>---</option>
                        <option value="Duplicate">Duplicate Current</option>
                        <option value="ImportFile">Import File...</option>
                        <option value="Recover">Recover Deleted...</option>
                    </select>
                </div>

                <button id="exportMooBtn" class="p-2 bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-300 border border-yellow-500 shadow-sm transition-colors flex items-center justify-center" title="Export Project (.moo)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                
                <button id="publishBtn" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 shadow-sm text-sm font-semibold flex items-center gap-1">
                    <span>Publish</span>
                </button>

                <button id="autoAssignBtn" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 border border-indigo-200 transition-colors" title="Auto Assign Roles">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>

                <button id="deleteProjectBtn" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">Delete</button>
                <button id="currencyToggleBtn" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">To ${displayCurrency === 'JMD' ? 'USD' : 'JMD'}</button>
                
                <div class="flex flex-wrap items-center gap-x-3 gap-y-2 sm:border-l sm:border-gray-300 sm:pl-3">
            <button id="exportXlsxBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Excel</button>
            <button id="exportPdfBtn" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">PDF</button>
        </div>
                </div>`;
            
                document.getElementById('autoAssignBtn')?.addEventListener('click', () => {
                     alert("Auto Assign Feature:\n\nThis will eventually allow you to auto-fill crew spots from the 'Art of Documentary' database or your uploaded contacts based on tagged skillsets.");
                });
                document.getElementById('exportMooBtn')?.addEventListener('click', exportToMoo);
                
                // v19.52 Publish Placeholder Logic
                document.getElementById('publishBtn')?.addEventListener('click', () => {
                    const content = `
                        <div class="text-center p-6 space-y-4">
                            <div class="inline-block p-4 bg-blue-50 text-blue-600 rounded-full text-4xl mb-2">☁️</div>
                            <h3 class="text-xl font-bold text-gray-800">Cloud Integration Coming Soon</h3>
                            <p class="text-gray-600">We are building direct integration to save your budgets to:</p>
                            
                            <div class="flex justify-center gap-6 py-4">
                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Google Drive">
                                    <svg class="w-10 h-10" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#0066da"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ff3333"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#00ac47"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ea4335"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Drive</span>
                                </div>

                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Dropbox">
                                    <svg class="w-10 h-10" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.8 20L32 32L51.2 20L32 8L12.8 20Z" fill="#0061FF"/><path d="M12.8 44L32 56L51.2 44L32 32L12.8 44Z" fill="#0061FF"/><path d="M12.8 44L32 56V32L12.8 20V44Z" fill="#0061FF"/><path d="M51.2 44L32 56V32L51.2 20V44Z" fill="#0061FF"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Dropbox</span>
                                </div>

                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="OneDrive">
                                    <svg class="w-10 h-10" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M42.3 11C35.8 11 30.1 14.8 27.5 20.3 26.5 20 25.4 19.8 24.3 19.8 17.5 19.8 12 25.3 12 32c0 1.2.2 2.3.5 3.4C10.5 36.8 9.3 38.3 9.3 40c0 3.3 2.7 6 6 6h32.1c8.1 0 14.6-6.6 14.6-14.7 0-7.8-6.1-14.2-13.8-14.6C47.3 14.5 45 11 42.3 11z" fill="#0078D4"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">OneDrive</span>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-lg text-left text-sm text-yellow-800 mt-4">
                                <strong>Need storage?</strong><br>
                                When this feature launches, users who need to create new cloud accounts will get exclusive discounts on storage plans via our partners.
                            </div>
                            <button onclick="closeModal('publishPlaceholderModal')" class="mt-4 px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Got it</button>
                        </div>
                    `;
                    createModal('publishPlaceholder', 'Publish to Cloud', content, 'max-w-sm');
                });
            }
        }

        function makeInputDraggable(input) {
            if (!input || input.dataset.draggable === 'true') return;
            input.dataset.draggable = 'true';
            input.style.cursor = 'ew-resize';
            
            let startX, startVal;
            const onMove = (e) => { 
                const delta = e.clientX - startX; 
                input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
                input.dispatchEvent(new Event('input', {bubbles:true})); 
            };
            const onUp = () => { 
                document.removeEventListener('mousemove', onMove); 
                document.removeEventListener('mouseup', onUp); 
            };
            
            input.addEventListener('mousedown', (e) => { 
                if(input === document.activeElement) return; 
                startX = e.clientX; 
                startVal = parseFloat(input.value)||0; 
                document.addEventListener('mousemove', onMove); 
                document.addEventListener('mouseup', onUp); 
            });
        }

        function initializeInteractiveInputs() { 
            ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
                const el = document.getElementById(id);
                if(el) makeInputDraggable(el);
            });
        }
        
        function updateOnlineStatus() { 
            const isOnline = navigator.onLine;
            const btn = document.getElementById('loginBtn'); 
            if(btn) { 
                btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'status-online' : 'status-offline'}`; 
                btn.title = isOnline ? "Online" : "Offline"; 
            }
            const aiBtn = document.getElementById('openAiToolsBtn');
            if(aiBtn) {
                aiBtn.className = `p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200' : 'bg-red-100 border-red-200 text-red-800 cursor-not-allowed opacity-75'}`;
                if(!isOnline) aiBtn.title = "Offline - AI Unavailable";
            }
        }
        
        function handleLogin() { if (navigator.onLine && confirm("Simulate Login?")) alert("Logged in!"); }

// --- v19.36 Template Events & Logic v19.52 ---
        function bindTemplateEvents() {
            document.getElementById('templateSelector')?.addEventListener('change', (e) => {
                editingTemplateId = e.target.value;
                tempTemplateData = null; 
                window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
            });

            document.getElementById('createTemplateBtn')?.addEventListener('click', () => {
                const isDefault = ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId);
                const suggestedName = isDefault ? `New ${editingTemplateId}` : '';
                const name = prompt("Enter new template name (e.g., 'Music Video'):", suggestedName);
                if (name) {
                    const allTemplates = getAllTemplates();
                    if(allTemplates[name]) return alert("Template name already exists.");
                    const base = editingTemplateId ? allTemplates[editingTemplateId] : DEFAULT_TEMPLATES['Commercial'];
                    allTemplates[name] = JSON.parse(JSON.stringify(base));
                    allTemplates[name].projectName = `Untitled ${name} Project`;
                    saveAllTemplates(allTemplates);
                    editingTemplateId = name;
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            });

            document.getElementById('importTemplateBtn')?.addEventListener('click', () => {
                const jsonStr = prompt("Paste template JSON string here:");
                if(jsonStr) {
                    try {
                        const parsed = JSON.parse(jsonStr);
                        if(!parsed.sections) throw new Error("Invalid template format.");
                        const name = prompt("Name for this imported template:", "Imported Template");
                        if(name) {
                            const allTemplates = getAllTemplates();
                            allTemplates[name] = parsed;
                            saveAllTemplates(allTemplates);
                            editingTemplateId = name;
                            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                        }
                    } catch(e) { alert("Import Failed: " + e.message); }
                }
            });

            document.getElementById('exportTemplateBtn')?.addEventListener('click', () => {
                if(!editingTemplateId) return;
                const allTemplates = getAllTemplates();
                const data = JSON.stringify(allTemplates[editingTemplateId]);
                navigator.clipboard.writeText(data).then(() => alert("Template JSON copied to clipboard!")).catch(() => prompt("Copy this:", data));
            });

            document.getElementById('deleteTemplateBtn')?.addEventListener('click', () => {
                if(!editingTemplateId || ['Commercial', 'Documentary', 'LiveStream'].includes(editingTemplateId)) {
                    return alert("Cannot delete default templates.");
                }
                if(confirm(`Delete template "${editingTemplateId}"?`)) {
                    const allTemplates = getAllTemplates();
                    delete allTemplates[editingTemplateId];
                    saveAllTemplates(allTemplates);
                    editingTemplateId = 'Commercial';
                    window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
                }
            });

            document.getElementById('saveTemplateChangesBtn')?.addEventListener('click', () => {
                if(isDefaultTemplate(editingTemplateId)) {
                    return alert("Cannot edit default templates directly. Please create a copy.");
                }
                if (tempTemplateData && editingTemplateId) {
                    const allTemplates = getAllTemplates();
                    allTemplates[editingTemplateId] = tempTemplateData;
                    saveAllTemplates(allTemplates);
                    alert("Template Saved!");
                    tempTemplateData = null;
                }
            });

            const editorContainer = document.getElementById('templateEditorContainer');
            if(editorContainer) {
                renderTemplateEditor(editorContainer);

                if(isDefaultTemplate(editingTemplateId)) return; 

                editorContainer.addEventListener('change', (e) => {
                    const target = e.target;
                    
                    if (target.dataset.daysField) {
                         if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                         if(!tempTemplateData.days) tempTemplateData.days = { principal: 10, scouting: 5, preprod: 15 };
                         
                         const field = target.dataset.daysField;
                         tempTemplateData.days[field] = parseFloat(target.value) || 0;
                         recalculateTemplateQuantities(tempTemplateData);
                         renderTemplateEditor(editorContainer);
                         return;
                    }

                    if (target.dataset.templateField) {
                        if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                        
                        const field = target.dataset.templateField;
                        const val = target.value;
                        
                        if(target.dataset.templateId) { 
                            const section = tempTemplateData.sections[target.dataset.templateSection];
                            const item = section.items.find(i => i.id === target.dataset.templateId);
                            if(item) {
                                if(['quantity', 'rate', 'multiplier'].includes(field)) item[field] = parseFloat(val);
                                else item[field] = val;
                            }
                        } else { 
                            if(['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(field)) tempTemplateData[field] = parseFloat(val);
                        }
                    }
                });

                editorContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if(!btn) return;
                    if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));

                    if(btn.dataset.templateAddItem) {
                        const sectionName = btn.dataset.templateAddItem;
                        tempTemplateData.sections[sectionName].items.push({ id: crypto.randomUUID(), ...initialLineItem });
                        renderTemplateEditor(editorContainer);
                    } else if (btn.dataset.templateRemoveItem) {
                        const sectionName = btn.dataset.templateSection;
                        const itemId = btn.dataset.templateRemoveItem;
                        const idx = tempTemplateData.sections[sectionName].items.findIndex(i => i.id === itemId);
                        if(idx > -1) {
                            tempTemplateData.sections[sectionName].items.splice(idx, 1);
                            renderTemplateEditor(editorContainer);
                        }
                    } else if (btn.dataset.templateRemoveSection) {
                        const sectionName = btn.dataset.templateRemoveSection;
                        if(confirm("Delete section?")) {
                            delete tempTemplateData.sections[sectionName];
                            renderTemplateEditor(editorContainer);
                        }
                    } else if (btn.id === 'addTemplateSectionBtn') {
                        const name = prompt("New Section Name:");
                        if(name && !tempTemplateData.sections[name]) {
                            tempTemplateData.sections[name] = { isOpen: true, items: [] };
                            renderTemplateEditor(editorContainer);
                        }
                    }
                });
            }
        }
        
        function recalculateTemplateQuantities(data) {
            if(!data.days) return;
            const { principal, scouting, preprod } = data.days;
            const totalRun = principal + scouting + preprod;
            const prepScout = scouting + preprod;
            
            const fullRunRegex = /(director|producer|camera|dp|operator|ac|gaffer|grip|mixer|sound|supervisor|manager|coordinator|pa|assistant)/i;
            const prepRegex = /(researcher|location|casting)/i;

            Object.values(data.sections).forEach(section => {
                section.items.forEach(item => {
                    if(item.unit !== 'Day') return;
                    const desc = item.description.toLowerCase();
                    if (fullRunRegex.test(desc)) item.quantity = totalRun;
                    else if (prepRegex.test(desc)) item.quantity = prepScout;
                });
            });
        }

        function isDefaultTemplate(id) {
            return ['Commercial', 'Documentary', 'LiveStream'].includes(id);
        }

        function renderTemplateEditor(container) {
            if (!container) return; 
            const data = tempTemplateData || getAllTemplates()[editingTemplateId];
            if(!data) return;
            
            if (!data.days) data.days = { principal: 10, scouting: 5, preprod: 15 };

            const isReadOnly = isDefaultTemplate(editingTemplateId);
            const disabledAttr = isReadOnly ? 'disabled' : '';
            const readOnlyBanner = isReadOnly ? `<div class="mb-4 p-2 bg-yellow-50 text-yellow-800 text-xs border border-yellow-200 rounded flex items-center gap-2"><span class="font-bold">⚠ Default Template:</span> Read-only mode. Click "Clone / New" to create an editable copy.</div>` : '';

            let html = `
                ${readOnlyBanner}
                <div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded">
                    <h3 class="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wide">Production Days Inputs</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-indigo-700 mb-1">Principal</label><input type="number" data-days-field="principal" value="${data.days.principal}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                        <div><label class="block text-xs text-indigo-700 mb-1">Scouting</label><input type="number" data-days-field="scouting" value="${data.days.scouting}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                        <div><label class="block text-xs text-indigo-700 mb-1">Pre-Prod</label><input type="number" data-days-field="preprod" value="${data.days.preprod}" ${disabledAttr} class="w-full p-1.5 text-sm border border-indigo-200 rounded shadow-sm focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 text-gray-500' : 'bg-white'}"></div>
                    </div>
                    <p class="text-[10px] text-indigo-400 mt-2 italic">Updating these automatically adjusts quantities for standard roles.</p>
                </div>
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded grid grid-cols-3 gap-4">
                    <div><label class="block text-xs font-bold text-gray-700">Contingency %</label><input type="number" step="0.1" value="${data.contingencyPercentage}" ${disabledAttr} data-template-field="contingencyPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
                    <div><label class="block text-xs font-bold text-gray-700">Sales Tax %</label><input type="number" step="0.1" value="${data.salesTaxPercentage}" ${disabledAttr} data-template-field="salesTaxPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
                    <div><label class="block text-xs font-bold text-gray-700">Discount %</label><input type="number" step="0.1" value="${data.discountPercentage}" ${disabledAttr} data-template-field="discountPercentage" class="w-full p-1 border rounded ${isReadOnly ? 'bg-gray-100' : ''}"></div>
                </div>`;

            Object.entries(data.sections).forEach(([sectionName, section]) => {
                html += `
                <div class="mb-4 border rounded-lg overflow-hidden">
                    <div class="bg-gray-100 p-2 flex justify-between items-center"><h3 class="font-bold text-sm text-gray-700">${sectionName}</h3>${!isReadOnly ? `<button data-template-remove-section="${sectionName}" class="text-red-400 hover:text-red-600">×</button>` : ''}</div>
                    <div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50 text-gray-500"><tr><th class="p-2 text-left">Description</th><th class="p-2 text-center w-12">Qty</th><th class="p-2 text-left w-20">Unit</th><th class="p-2 text-right w-24">Rate</th><th class="w-8"></th></tr></thead><tbody>
                    ${section.items.map(item => `<tr class="border-t hover:bg-gray-50"><td class="p-1"><input class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" value="${item.description}" ${disabledAttr} data-template-field="description" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><input type="number" class="w-full bg-transparent text-center ${isReadOnly ? 'text-gray-500' : 'font-bold text-blue-600'}" value="${item.quantity}" ${disabledAttr} data-template-field="quantity" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1"><select class="w-full bg-transparent ${isReadOnly ? 'text-gray-500' : ''}" ${disabledAttr} data-template-field="unit" data-template-id="${item.id}" data-template-section="${sectionName}"><option ${item.unit === 'Day' ? 'selected' : ''}>Day</option><option ${item.unit === 'Week' ? 'selected' : ''}>Week</option><option ${item.unit === 'Flat' ? 'selected' : ''}>Flat</option><option ${item.unit === 'Policy' ? 'selected' : ''}>Policy</option><option ${item.unit === 'Hour' ? 'selected' : ''}>Hour</option></select></td><td class="p-1"><input type="number" class="w-full bg-transparent text-right ${isReadOnly ? 'text-gray-500' : ''}" value="${item.rate}" ${disabledAttr} data-template-field="rate" data-template-id="${item.id}" data-template-section="${sectionName}"></td><td class="p-1 text-center">${!isReadOnly ? `<button data-template-remove-item="${item.id}" data-template-section="${sectionName}" class="text-gray-400 hover:text-red-500">×</button>` : ''}</td></tr>`).join('')}
                    </tbody></table></div>${!isReadOnly ? `<button data-template-add-item="${sectionName}" class="w-full p-2 text-center text-xs text-blue-500 hover:bg-blue-50">+ Add Line Item</button>` : ''}
                </div>`;
            });

            if (!isReadOnly) html += `<button id="addTemplateSectionBtn" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 font-medium text-sm">Add New Section</button>`;
            container.innerHTML = html;
        }
        
        window.editGlobalItem = function(index) { editingGlobalItemIndex = index; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
        window.cancelEditGlobalItem = function() { editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); };
        window.deleteGlobalItem = function(idx) { if (confirm("Remove item?")) { const items = getGlobalItems(); items.splice(idx, 1); saveGlobalItems(items); if(editingGlobalItemIndex === idx) editingGlobalItemIndex = -1; window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]')); } };
        window.handleRestore = function(index) {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            const projectToRestore = trash.splice(index, 1)[0];
            if (projectToRestore) {
                delete projectToRestore.deletedTimestamp;
                localStorage.setItem(storageKeyPrefix + projectToRestore.projectName, JSON.stringify(projectToRestore));
                localStorage.setItem(trashKey, JSON.stringify(trash));
                loadBudget(projectToRestore.projectName);
                render();
            }
            closeModal('recoveryModal');
        };
        window.handlePermanentDelete = function(index) {
            if (confirm("Delete forever?")) { const trash = JSON.parse(localStorage.getItem(trashKey) || '[]'); trash.splice(index, 1); localStorage.setItem(trashKey, JSON.stringify(trash)); showRecoveryModal(); }
        }

        window.handleRestoreAll = function() {
            const trash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            if (trash.length === 0) return;
            if (confirm(`Restore all ${trash.length} projects?`)) {
                trash.forEach(project => {
                    delete project.deletedTimestamp;
                    localStorage.setItem(storageKeyPrefix + project.projectName, JSON.stringify(project));
                });
                localStorage.removeItem(trashKey);
                showRecoveryModal();
                render(); 
            }
        };

        window.handleDeleteAllTrash = function() {
            if (confirm("Permanently delete ALL projects in trash?")) {
                localStorage.removeItem(trashKey);
                showRecoveryModal();
            }
        };

        async function handleAnalyzeBudget() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            const outputDiv = document.getElementById('aiAnalysisOutput');
            outputDiv.innerHTML = '<div class="text-blue-600 animate-pulse">Analyzing...</div>';
            const simplifiedBudget = { project: budget.projectName, totals: calculateTotals(budget.sections), sections: {} };
            for (const [name, sec] of Object.entries(budget.sections)) simplifiedBudget.sections[name] = sec.items.map(i => `${i.quantity} ${i.unit} ${i.description} @ ${i.rate}`).join(', ');
            const prompt = `You are a line producer. Analyze this budget JSON for a Jamaica/Intl project. 1. Missing roles/equip? 2. Rate anomalies (JMD)? 3. Risks? Budget Data: ${JSON.stringify(simplifiedBudget)}`;
            try { const response = await callUnifiedAI(provider, key, prompt); outputDiv.innerHTML = marked.parse(response); } catch (error) { outputDiv.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`; }
        }

        async function handleConsultantChat() {
            const provider = getSelectedProvider();
            const key = getStoredApiKey(provider);
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;
            const chatHistory = document.getElementById('aiChatHistory');
            chatHistory.innerHTML += `<div class="ai-message user">${message}</div>`;
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;
            const loadingMsg = document.createElement('div'); loadingMsg.className = 'ai-message assistant text-gray-400 italic'; loadingMsg.textContent = `Thinking (${provider})...`; chatHistory.appendChild(loadingMsg);
            try {
                const response = await callUnifiedAI(provider, key, `You are a film production consultant. Answer concisely: ${message}`);
                loadingMsg.innerHTML = marked.parse(response); loadingMsg.className = 'ai-message assistant';
            } catch (error) { loadingMsg.textContent = `Error: ${error.message}`; loadingMsg.classList.add('text-red-500'); }
        }

        /* --- v19.51 Project Management UI v19.52 --- */
        function renderProjectManagement() {
            const container = document.getElementById('project-management-container');
            if(container) {
                const templates = getAllTemplates();
                const templateOptions = Object.keys(templates).map(k => `<option value="${k}">New ${k}</option>`).join('');
                
                container.innerHTML = `<div id="project-management" class="flex flex-wrap items-center justify-start gap-x-3 gap-y-2">
                <select id="projectLoader" aria-label="Load Project" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5">${getProjectList().map(p => `<option value="${p}" ${p === currentProjectName ? 'selected' : ''}>${p}</option>`).join('')}</select>
                
                <div class="relative">
                    <select id="newProjectSelector" aria-label="File Menu" class="appearance-none px-2 py-2 w-[4.5rem] bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold cursor-pointer text-center focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="" disabled selected>File</option>
                        ${templateOptions}
                        <option value="" disabled>---</option>
                        <option value="Duplicate">Duplicate Current</option>
                        <option value="ImportFile">Import File...</option>
                        <option value="Recover">Recover Deleted...</option>
                    </select>
                </div>

                <button id="exportMooBtn" class="p-2 bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-300 border border-yellow-500 shadow-sm transition-colors flex items-center justify-center" title="Export Project (.moo)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                
                <button id="publishBtn" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 shadow-sm text-sm font-semibold flex items-center gap-1">
                    <span>Publish</span>
                </button>

                <button id="autoAssignBtn" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 border border-indigo-200 transition-colors" title="Auto Assign Roles">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>

                <button id="deleteProjectBtn" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">Delete</button>
                <button id="currencyToggleBtn" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">To ${displayCurrency === 'JMD' ? 'USD' : 'JMD'}</button>
                
                <div class="flex flex-wrap items-center gap-x-3 gap-y-2 sm:border-l sm:border-gray-300 sm:pl-3">
            <button id="exportXlsxBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Excel</button>
            <button id="exportPdfBtn" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">PDF</button>
        </div>
                </div>`;
            
                document.getElementById('autoAssignBtn')?.addEventListener('click', () => {
                     alert("Auto Assign Feature:\n\nThis will eventually allow you to auto-fill crew spots from the 'Art of Documentary' database or your uploaded contacts based on tagged skillsets.");
                });
                document.getElementById('exportMooBtn')?.addEventListener('click', exportToMoo);
                
                document.getElementById('publishBtn')?.addEventListener('click', () => {
                    const content = `
                        <div class="text-center p-6 space-y-4">
                            <div class="inline-block p-4 bg-blue-50 text-blue-600 rounded-full text-4xl mb-2">☁️</div>
                            <h3 class="text-xl font-bold text-gray-800">Cloud Integration Coming Soon</h3>
                            <p class="text-gray-600">We are building direct integration to save your budgets to:</p>
                            
                            <div class="flex justify-center gap-6 py-4">
                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Google Drive">
                                    <svg class="w-10 h-10" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#0066da"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ff3333"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#00ac47"/><path d="m43.85 23.05 25.3-43.8h50.6l-25.3 43.8z" fill="#ea4335"/><path d="m106 66.85-25.3 43.8h-50.6l25.3-43.8z" fill="#ffba00" transform="translate(-32 -23)"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Drive</span>
                                </div>

                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="Dropbox">
                                    <svg class="w-10 h-10" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.8 20L32 32L51.2 20L32 8L12.8 20Z" fill="#0061FF"/><path d="M12.8 44L32 56L51.2 44L32 32L12.8 44Z" fill="#0061FF"/><path d="M12.8 44L32 56V32L12.8 20V44Z" fill="#0061FF"/><path d="M51.2 44L32 56V32L51.2 20V44Z" fill="#0061FF"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Dropbox</span>
                                </div>

                                <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity" title="OneDrive">
                                    <svg class="w-10 h-10" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M42.3 11C35.8 11 30.1 14.8 27.5 20.3 26.5 20 25.4 19.8 24.3 19.8 17.5 19.8 12 25.3 12 32c0 1.2.2 2.3.5 3.4C10.5 36.8 9.3 38.3 9.3 40c0 3.3 2.7 6 6 6h32.1c8.1 0 14.6-6.6 14.6-14.7 0-7.8-6.1-14.2-13.8-14.6C47.3 14.5 45 11 42.3 11z" fill="#0078D4"/></svg>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">OneDrive</span>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-lg text-left text-sm text-yellow-800 mt-4">
                                <strong>Need storage?</strong><br>
                                When this feature launches, users who need to create new cloud accounts will get exclusive discounts on storage plans via our partners.
                            </div>
                            <button onclick="closeModal('publishPlaceholderModal')" class="mt-4 px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Got it</button>
                        </div>
                    `;
                    createModal('publishPlaceholder', 'Publish to Cloud', content, 'max-w-sm');
                });
            }
        }

        function makeInputDraggable(input) {
            if (!input || input.dataset.draggable === 'true') return;
            input.dataset.draggable = 'true';
            input.style.cursor = 'ew-resize';
            
            let startX, startVal;
            const onMove = (e) => { 
                const delta = e.clientX - startX; 
                input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
                input.dispatchEvent(new Event('input', {bubbles:true})); 
            };
            const onUp = () => { 
                document.removeEventListener('mousemove', onMove); 
                document.removeEventListener('mouseup', onUp); 
            };
            
            input.addEventListener('mousedown', (e) => { 
                if(input === document.activeElement) return; 
                startX = e.clientX; 
                startVal = parseFloat(input.value)||0; 
                document.addEventListener('mousemove', onMove); 
                document.addEventListener('mouseup', onUp); 
            });
        }

        function initializeInteractiveInputs() { 
            ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
                const el = document.getElementById(id);
                if(el) makeInputDraggable(el);
            });
        }
        
        function updateOnlineStatus() { 
            const isOnline = navigator.onLine;
            const btn = document.getElementById('loginBtn'); 
            if(btn) { 
                btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'status-online' : 'status-offline'}`; 
                btn.title = isOnline ? "Online" : "Offline"; 
            }
            const aiBtn = document.getElementById('openAiToolsBtn');
            if(aiBtn) {
                aiBtn.className = `p-2 border rounded-lg text-sm transition-colors flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200' : 'bg-red-100 border-red-200 text-red-800 cursor-not-allowed opacity-75'}`;
                if(!isOnline) aiBtn.title = "Offline - AI Unavailable";
            }
        }
        
        function handleLogin() { if (navigator.onLine && confirm("Simulate Login?")) alert("Logged in!"); }

     function init() {
            document.title = `mooBudgetTool v${APP_VERSION}`;
            const footerText = document.querySelector('footer p');
            if(footerText) footerText.innerHTML = `Budget Tool by moo v${APP_VERSION}`;

            displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
            
            let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
            if (!projectToLoad || !getProjectList().includes(projectToLoad)) projectToLoad = getProjectList()[0];
            projectToLoad ? loadBudget(projectToLoad) : handleNewProject(false);
            
            render();
            bindAppEventListeners();
            
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.crew-wrapper')) {
                    document.querySelectorAll('.crew-wrapper').forEach(div => div.classList.remove('mobile-active'));
                }
            });
        }
    
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
